<link rel="import"href="../paper-progress/paper-progress.html"><link rel="import"href="../paper-dropdown-menu/paper-dropdown-menu.html"><link rel="import"href="../paper-item/paper-item.html"><link rel="import"href="../paper-input/paper-textarea.html"><link rel="import"href="../../x-componentes/x-comp-find-input-cliente/x-comp-find-input-cliente.html"><link rel="import"href="../../x-componentes/x-comp-find-comprobante/x-comp-find-comprobante.html"><link rel="import"href="../../x-componentes/x-comp-find-tipo-pago-option/x-comp-find-tipo-pago-option.html"><link rel="import"href="../../x-componentes/x-comp-table-forma-pago/x-comp-table-forma-pago.html"><dom-module id="x-pago"><template><div style="max-width:580px;min-width:480px"><div class="xEnca_pago"><h2 class="ptotal">{{total}}</h2><p class="pdif"id="pdif">{{diferencia}}</div><div class="ancho_ini"><br><div class="container-cliente-comprobante"hidden="[[!hidden_container_pago]]"><div id="container-cliente"><div><label class="xfont12 xColorRow_Plomo">Comprobante a imprimir:</label><x-comp-find-comprobante apply-class="xTextRow2 xfont16 xCursor"id="comp_sel_comprobante"hide-content-card-tpc="{{hideContentCardTpc}}"onchange="xSelectedTpComprobante(comprobantes)"></x-comp-find-comprobante></div><form action=""id="form_pago_cliente"is="iron-form"style="line-height:.2"><paper-icon-button style="float:right;bottom:-10px"src="../../../images/_add_cliente.png"alt="clienteadd"title="Agregar cliente"onclick="xThisPago.hidden_container_cliente=!1"></paper-icon-button><paper-input label="[[placeholder_clie]]"onkeyup="xValidarDNIRUC(this.value,event)"autofocus char-counter maxlength="11"pattern="[0-9]*"error-message="{{mensajeErrorDocumento}}"class="xPasarEnter2"id="sel_cliente"></paper-input><paper-icon-button icon="icons:search"title="Buscar DNI"onclick="xValidarDNIRUC(null,event,!1)"style="position:relative;right:10px;margin-top:-48px;float:right"></paper-icon-button><paper-icon-button hidden$="[[!isShowSearchSunat]]"icon="icons:refresh"title="Obtner datos actualizados"onclick="xValidarDNIRUC(null,event,!1,!0)"style="position:relative;right:50px;margin-top:-42px;float:right;background:#00ff7f;padding:2px;border-radius:5px"></paper-icon-button><div class="xInvisible"id="progress_cliente"><paper-progress indeterminate style="width:100%;float:left;margin-top:-19px"></paper-progress></div><div id="datos_cliente"><x-comp-find-input-cliente id="clie_nombres"label="Nombres | Razon Social | Buscar"required="[[ComprobanteRequiereCliente]]"class="xPasarEnter2"></x-comp-find-input-cliente><paper-textarea autofocus label="Direccion"max-rows="2"id="clie_direccion"onchange="conMayusculas(this)"class="xPasarEnter2 clie_direccion"></paper-textarea><div><paper-textarea autofocus label="Telefono WhatsApp"max-rows="1"id="clie_telefono"onchange="conMayusculas(this)"class="xPasarEnter2"></paper-textarea></div><div class="d-flexx align-items-center justify-content-between"><p style="line-height:18px;display:flex;align-items:center">Se enviara el comprobante<br>al WhatsApp de este n√∫mero. <img src="../../../images/whatsapp.png"width="16px"><div><div hidden="[[!isBtnPrinterCpe]]"class="btn btn-sm border btn-print-cpe"style="background:#d3d3d3"id="btn-print-no"onclick="xSetisPrinterCpe(!0)"><i class="fa fa-check fs-15 text-success fs-600 mr-1"></i>Si Imprimir</div><div hidden$="[[isBtnPrinterCpe]]"class="btn btn-sm btn-warning border btn-print-cpe"id="btn-print-si"onclick="xSetisPrinterCpe(!1)"><i class="fa fa-close fs-15 text-danger fs-600 mr-1"></i>No Imprimir</div></div></div></div></form></div><br></div><div id="container-pago"hidden="[[hidden_container_pago]]"><x-comp-table-forma-pago id="comp-table-fp"importetotal$="{{importe_total_cobrar}}"ispagoapp$="[[pedidoPagadoFromAPP]]"></x-comp-table-forma-pago><br></div><br></div></div><div><div class="xLinea"></div><br><div hidden="[[!hidden_container_pago]]"><button class="btn btn-sm btn-dark"onclick="xCancelarCerrar()"id="btn_regresar_cuenta">Regresar</button> <button class="btn btn-sm btn-primary"hidden="[[!modoSoloComprobante]]"onclick="xThisPago.setVisibleContainerPago()"id="btn_pago_next"disabled="[[!valid_form_cliente_pago]]"><div>[F10] Listo, imprimir comprobante</div></button> <button class="btn btn-sm btn-primary"hidden="[[modoSoloComprobante]]"onclick="xThisPago.setVisibleContainerPago()"id="btn_pago_next"disabled$="[[!valid_form_cliente_pago]]"><div>[F10] Siguente</div></button></div><div hidden="[[hidden_container_pago]]"><div hidden$="[[!tipoPagoRequiereCliente]]"><p class="xColorRow_Rojo">Este medio de pago requiere un cliente.<br>Por favor regrese y registre o seleccione un cliente.</p><br></div><div class="btn btn-sm btn-dark mr-1"onclick="xThisPago.setVisibleContainerPago()"id="btn_regresar_comprobante">Regresar</div><button class="btn btn-sm btn-primary"hidden$="[[tipoPagoRequiereCliente]]"disabled$="[[!change_monto_pago_valid]]"onclick="xListoRegistraPago()"id="btn_pagoX">[F10] Listo, registrar pago</button></div></div></template><style type="text/css">.xEnca_pago{background:#23369e;text-align:center;padding:10px;border-radius:5px 5px 0 0}.xEnca_pago .ptotal{color:#fff}.xEnca_pago .pdif{font-size:18px}.xsel_tp{float:left;margin-top:3px}.pdif_rojo{color:#ffea00}.pdif_verde{color:#76ff03}.container-cliente-comprobante{padding:5px;margin-top:-10px;background-color:#fdfcdc}.ancho_ini{width:100%}:root{--font-size:12px;--paper-input-container-input:{font-size:var(--font-size)};--paper-input-container-label:{font-size:13px};}@media screen and (max-width:720px){.ancho_ini{width:100%}}</style></dom-module><script>var xThisPago,xdialoag_pago,xtb_tp,xObjContent,_inputAutocomplete,_inputAutocompleteObj,objSelComprobante,xCompTableFP,xDiferencia=0,xtotal_recibido=0,xSel_tp=[],xSel_tp_comprobante=[],xdif_limite=0,xsuma_total=0,xsuma_diferencia=0,xIdCliente_pago="",xEnterTxtImporte=0,xDatosValidos=!1,tipoComprovanteSelecionado={},modoSoloComprobante=!1,modoSoloProveedor=!1,btnDisabledInitModoComprobante=!0,registrando=!1,xtipoP=[];function xIiniPago(){xtb_tp=$("#tb_tp"),xLoadTipoPago(),xEnterTxtImporte=0,xGetIsPrinterCpe(),_inputAutocomplete=document.getElementById("clie_nombres"),_inputAutocompleteObj=_inputAutocomplete.$.input_clie_nombres_auto,_inputAutocomplete.addEventListener("input-autocomplete-selected",e=>{e=e.detail;xThisPago.clienteModel=e,xThisPago.tipoPagoRequiereCliente=!1,xThisPago.mensajeErrorDocumento="",e.length<5?(xThisPago.$.clie_nombres.invalid=!0,xThisPago.valid_form_cliente_pago=!1):"01"===xThisPago.tipoComprovanteSelecionado.codsunat&&e.length<11?(xThisPago.$.sel_cliente.invalid=!0,xThisPago.mensajeErrorDocumento="Nro de RUC no valido"):(xIdCliente_pago=e.idcliente,$("#sel_cliente").val(e.ruc),$("#clie_direccion").val(e.direccion),$("#clie_telefono").val(e.telefono),EmitirValidacionFormCliente())}),(objSelComprobante=document.getElementById("comp_sel_comprobante")).addEventListener("_onchange",e=>{xSelectedTpComprobante(e.detail),e.stopPropagation(),e.stopImmediatePropagation()}),$("#form_pago_cliente #clie_nombres").on("keyup",function(e){e=e.which;13!=e&&186!=e||(xThisPago.$.clie_direccion.$.input.$.textarea.select(),xThisPago.$.clie_direccion.$.input.$.textarea.focus())}),$(".xPasarEnter2").on("keyup",function(e){var o,i,e=e.which;if(13==e||186==e)return o=(e=$("input")).index(document.activeElement),null!==e[o+1]&&(i=(i=e[o+1]).disabled?e[o+2]:i).focus(),!1}),$("#txt_pago_cliente").on("change",function(){xSumarTotales_row()}),$(window).on("keydown",function(e){if(121==e.keyCode){if(0===xThisPago.importe_total_cobrar)return;if(xThisPago.modoSoloComprobante)xVerContainerPago();else if(xThisPago.hidden_container_pago||xThisPago.tipoPagoRequiereCliente){if(!xThisPago.valid_form_cliente_pago)return;xThisPago.setVisibleContainerPago()}else{if(!xThisPago.valid_form_cliente_pago)return;xListoRegistraPago()}}e.stopPropagation(),e.stopImmediatePropagation()}),xtipoP=[];var i="",t=0;(xCompTableFP=document.getElementById("comp-table-fp")).addEventListener("xCompTableChange",function(e){var o=e.detail.evento,e=(xtipoP=e.detail.datos,e.target.valImporteRestante);e<=0?(i="Vuelto: "+xMoneda(-1*e),$("#pdif").removeClass("pdif_rojo"),$("#pdif").addClass("pdif_verde"),t=1,xThisPago.change_monto_pago_valid=!0):(i="Falta: "+xMoneda(e),$("#pdif").removeClass("pdif_verde"),$("#pdif").addClass("pdif_rojo"),(t=0)<e&&(xThisPago.change_monto_pago_valid=!1)),xThisPago.diferencia=i,xThisPago.tipoPagoRequiereCliente=0<xtipoP.filter(e=>"1"===e.reqcliente).length,xThisPago.clienteModel&&xThisPago.tipoPagoRequiereCliente&&(xThisPago.tipoPagoRequiereCliente=""===xThisPago.clienteModel.nombres),xFireSend(t),o&&13===o.keyCode&&xListoRegistraPago()}),xCompTableFP.addEventListener("xCompTableAddRemoveRow",()=>{xThisPago.fire("ChangeListPagoAddRemoveRow",xThisPago.tipoComprovanteSelecionado)})}async function xValidarDNIRUC(e,o,i=!0,t=!1){var a="ruc";if(e=e||sel_cliente.value,xThisPago.mensajeErrorDocumento="",xThisPago.$.sel_cliente.validate())if(xThisPago.ComprobanteRequiereCliente&&13!==o.keyCode&&!0===i)"01"===xThisPago.tipoComprovanteSelecionado.codsunat?(xThisPago.placeholder_clie="Cliente RUC",e.length<11&&(xThisPago.$.sel_cliente.invalid=!0,xThisPago.mensajeErrorDocumento="Nro de RUC no valido")):xThisPago.placeholder_clie="Cliente DNI o RUC",_inputAutocompleteObj.inputValue="",$("#clie_direccion").val(""),$("#clie_telefono").val(""),xIdCliente_pago="",EmitirValidacionFormCliente();else{if(e.length<=8)xThisPago.placeholder_clie="DNI",a="dni";else if(xThisPago.placeholder_clie="RUC",e.length<11)return xThisPago.$.sel_cliente.invalid=!0,void(xThisPago.mensajeErrorDocumento="Nro de RUC no valido");0===e.length?(xThisPago.placeholder_clie="Cliente DNI o RUC",_inputAutocompleteObj.inputValue="",$("#clie_direccion").val(""),$("#clie_telefono").val(""),xIdCliente_pago=""):(EmitirValidacionFormCliente(),13!==o.keyCode&&i||(xThisPago.$.sel_cliente.invalid=!1,"01"===xThisPago.tipoComprovanteSelecionado.codsunat&&e.length<11?(xThisPago.$.sel_cliente.invalid=!0,xThisPago.mensajeErrorDocumento="Nro de RUC no valido",o.stopPropagation(),o.stopImmediatePropagation()):e.length<8?(xThisPago.$.sel_cliente.invalid=!0,xThisPago.mensajeErrorDocumento="N de documento no valido.",_inputAutocompleteObj.inputValue="",$("#clie_direccion").val(""),$("#clie_telefono").val(""),xThisPago.hidden_container_cliente=!0,o.stopPropagation(),o.stopImmediatePropagation()):($("#progress_cliente").removeClass("xInvisible"),xGetFindCliente(e,a,t,e=>{e.success?(xThisPago.valid_form_cliente_pago=!0,xThisPago.hidden_container_cliente=!1,xThisPago.isShowSearchSunat=e.buscarSunat,setTimeout(()=>{xThisPago.mensajeErrorDocumento=""},100)):(xThisPago.$.sel_cliente.invalid=!0,xThisPago.mensajeErrorDocumento=e.msg,xThisPago.hidden_container_cliente=!0,xThisPago.valid_form_cliente_pago=!1),xIdCliente_pago=e.idcliente,_inputAutocompleteObj.inputValue=e.nombres,$("#clie_direccion").val(e.direccion),$("#clie_telefono").val(e.telefono),xThisPago.changeDatosClienteSave=e,$("#progress_cliente").addClass("xInvisible"),EmitirValidacionFormCliente()}))))}else xThisPago.$.sel_cliente.invalid=!0,xThisPago.mensajeErrorDocumento="Solo numeros"}function xSelectedTpComprobante(e){e=e||objSelComprobante.getValorSelecionado();xThisPago.ComprobanteRequiereCliente=0!==parseInt(e.requiere_cliente),700<parseFloat(xThisPago.total)&&("03"!==e.codsunat&&"01"!==e.codsunat||(xThisPago.ComprobanteRequiereCliente=!0)),"01"===e.codsunat?""===xThisPago.clienteModel.num_doc&&(xThisPago.$.sel_cliente.invalid=!0,xThisPago.mensajeErrorDocumento="Nro de RUC no valido"):""===xThisPago.clienteModel.num_doc&&(xThisPago.$.sel_cliente.invalid=!1,xThisPago.mensajeErrorDocumento=""),_inputAutocompleteObj.inputValue="",xThisPago.tipoComprovanteSelecionado=e,xThisPago.btnDisabledInitModoComprobante="0"!==e.idtipo_comprobante,xThisPago.hidden_container_cliente="0"===e.idtipo_comprobante||xThisPago.ComprobanteRequiereCliente,xThisPago.fire("xSelectTipoComprobante",xThisPago.tipoComprovanteSelecionado),EmitirValidacionFormCliente()}function xVerContainerPago(){xThisPago.modoSoloComprobante?(xFireSend(!0),xListoRegistraPago()):(xThisPago.tipoPagoRequiereCliente=!(""!=_inputAutocompleteObj.inputValue||!xThisPago.tipoPagoRequiereCliente),xThisPago.hidden_container_pago=!xThisPago.hidden_container_pago,xThisPago.hidden_container_pago||isSynOsWinOrMac()&&($("table#table_op_fp input.xmonto").last().focus(),$("table#table_op_fp input.xmonto").last().select()),xThisPago.fire("xContainerPagoVisible",xThisPago.hidden_container_pago),xFireSend(!0))}function EmitirValidacionFormCliente(){var e=!xThisPago.ComprobanteRequiereCliente;if(xThisPago.ComprobanteRequiereCliente){if(!xThisPago.tipoComprovanteSelecionado)return;"01"===xThisPago.tipoComprovanteSelecionado.codsunat?e=11===xThisPago.$.sel_cliente.value.length&&""!=clie_nombres.$.input_clie_nombres_auto.$.input.value&&4<clie_nombres.$.input_clie_nombres_auto.$.input.value.length:"03"===xThisPago.tipoComprovanteSelecionado.codsunat&&(e=""!=clie_nombres.$.input_clie_nombres_auto.$.input.value&&4<clie_nombres.$.input_clie_nombres_auto.$.input.value.length)}xThisPago.tipoComprovanteSelecionado&&!xThisPago.ComprobanteRequiereCliente&&"03"===xThisPago.tipoComprovanteSelecionado.codsunat&&(e=""===clie_nombres.$.input_clie_nombres_auto.$.input.value||4<clie_nombres.$.input_clie_nombres_auto.$.input.value.length),xThisPago.valid_form_cliente_pago=e,xThisPago.fire("xFormClienteValid",e)}function EmitirValidacionFormMontoPago(e){}function xCancelarCerrar(){xThisPago.fire("xCancelarCerrar",!0)}function xListoRegistraPago(){!xThisPago.change_monto_pago_valid||registrando||(registrando=!0,xSumarTotales_row(),xThisPago.fire("xListoRegistraPago",!0),xThisPago.fire("xListoRegistraPagoRpt",xtipoP),setTimeout(()=>{registrando=!1;try{_cpSocketVentaRegistrado()}catch(e){}},2e3))}function xSumarTotales_row(){}function xFireSend(e){var o=$("#sel_cliente").val(),i=[],t=(xThisPago.clienteModel={idcliente:xIdCliente_pago,num_doc:$("#sel_cliente").val(),nombres:_inputAutocompleteObj.inputValue,direccion:$("#clie_direccion").val(),telefono:$("#clie_telefono").val()},xThisPago.changeDatosClienteSave);let a=!0;t&&(a=t?.direccion!==xThisPago.clienteModel.direccion,a=t.telefono!==xThisPago.clienteModel.telefono);try{xThisPago.tipoComprovanteSelecionado?.codsunat||xSelectedTpComprobante()}catch(e){}i.push({ok:e,valid:xDatosValidos,cliente:xThisPago.clienteModel,comprobante:xThisPago.tipoComprovanteSelecionado,idcliente:xIdCliente_pago,nota_compra:o,nomcliente:o,xtipo_pagos:xtipoP,paseEnterTxt:xEnterTxtImporte,is_printer_cpe:xThisPago.isBtnPrinterCpe,is_update_cliente:a}),xThisPago.valid_monto_pago=0!=e,xThisPago.fire("xSend",{xRpts:i})}function xResetValuesInit(){xRpts=[],_inputAutocompleteObj.inputValue="",xThisPago.clienteModel={},xThisPago.importe_total_cobrar=0}function xLoadTipoPago(){$.ajax({type:"POST",url:"../../bdphp/log.php?op=6"}).done(function(e){e=(e=$.parseJSON(e)).datos,xThisPago.dt_tp=e,xSel_tp=[];for(var o=0;o<e.length;o++){var i=e[o].idtipo_pago;xSel_tp[i]={des:e[o].descripcion,limite:e[o].limite,reqcliente:e[o].requiere_cliente,visible:!0}}xAddTipoPago(),xThisPago.hidden_container_pago=!0,objSelComprobante.resetModoComprobanteSelected(),xThisPago.fire("xContainerPagoVisible",xThisPago.hidden_container_pago)})}function xResetOpSel(){for(i in xSel_tp)xSel_tp[i].visible=!0}function xArmarSelectTP(){var e="";for(i in xSel_tp)0!=xSel_tp[i].visible&&(e=String(e+'<option value="'+i+'" data-reqcliente="'+xSel_tp[i].reqcliente+'" data-limite="'+xSel_tp[i].limite+'">'+xSel_tp[i].des+"</option>"));return e=""!=e?'<select id="xsel_tpago" class="xTextRow2 xfont16 xCursor xsel_tp">'+e+"</select>":e}function xAddTipoPago(){""==xThisPago.total||(xSumarTotales_row(),0<xtb_tp.find(".row").length&&xsuma_total<=0)||(xThisPago.focus(),xtb_tp.find(".xmonto:last-child").focus(),xtb_tp.find(".xmonto:last-child").select())}function xValoresIniciales(){1==xThisPago._tipo?xThisPago.placeholder_clie="Cliente DNI o RUC":(xThisPago.placeholder_clie="Nota de compra",$("#pdif").addClass("xInvisible"),$("#sel_cliente").val("Compras del "+xDevolverFecha())),$("#sel_cliente").focus()}function xSetFocusInit(){setTimeout(()=>{xThisPago.$.sel_cliente.focus(),$("#form_pago_cliente #sel_cliente").focus()},500)}function _reloadDatalientes(){_inputAutocomplete.reloadllClientes()}function _reloadDataCompFindComprobante(){objSelComprobante.reloadAllComprobantes()}function xGetIsPrinterCpe(){var e=parseInt(localStorage.getItem("::app3_sys_print_cpe")),e=isNaN(e)?1:e;xThisPago.isBtnPrinterCpe=1===e}function xSetisPrinterCpe(e){localStorage.setItem("::app3_sys_print_cpe",e?0:1),xThisPago.isBtnPrinterCpe=!e}Polymer({is:"x-pago",properties:{total:{type:String,value:""},diferencia:String,mensajeErrorDocumento:{type:String,value:"Solo Numeros"},placeholder_clie:{type:String,value:"Cliente | Publico en General"},importe_total_cobrar:{type:Number,value:0},progres_busca_cliente:boolean=!1,hidden_container_pago:boolean=!0,hidden_container_cliente:boolean=!0,hidden_container_registro_pago:boolean=!1,valid_form_cliente_pago:boolean=!1,valid_monto_pago:boolean=!0,change_monto_pago_valid:boolean=!0,ComprobanteRequiereCliente:boolean=!1,tipoPagoRequiereCliente:boolean=!1,pedidoPagadoFromAPP:boolean=!1,_tipo:{type:Number,value:1,notify:!0},val:String,dt_tp:Object,dt_tp_comprobante:Object,clienteModel:Object,dataClientes:Object,isShowSearchSunat:Boolean,isBtnPrinterCpe:Boolean,changeDatosClienteSave:Object,hideContentCardTpc:{type:Boolean,value:!1}},attached:function(){this.modoSoloComprobante=!1,this.diferencia="--",this.isShowSearchSunat=!1,this.isBtnPrinterCpe=!1,this.changeDatosClienteSave=null,xThisPago=this,xIiniPago(),xValoresIniciales()},open:function(e){xdialoag_pago.open()},setIsPedidoPagadoFromAPP:function(e=!1){this.pedidoPagadoFromAPP=e,xCompTableFP.setRsetList()},setVal:function(e){xThisPago.ComprobanteRequiereCliente=700<parseFloat(e),xThisPago.hidden_container_cliente=xThisPago.ComprobanteRequiereCliente,xThisPago.tipoPagoRequiereCliente=!1,xCompTableFP.resetFormaPago(),xThisPago.total=e,xThisPago.importe_total_cobrar=e,xThisPago.$.form_pago_cliente.reset(),xThisPago.placeholder_clie="Cliente DNI o RUC",_inputAutocompleteObj.inputValue="",$("#clie_direccion").val(""),$("#clie_telefono").val(""),xIdCliente_pago="",xThisPago.$.sel_cliente.value="",xThisPago.$.sel_cliente.focus(),EmitirValidacionFormCliente(),xSelectedTpComprobante()},setVisibleContainerPago:function(){(this.modoSoloProveedor?xCancelarCerrar:xThisPago.$.form_pago_cliente.checkValidity()?xVerContainerPago:EmitirValidacionFormCliente)()},setVisiblePanel1:function(){xThisPago.$.form_pago_cliente.reset(),xSelectedTpComprobante(),xThisPago.hidden_container_pago=!0,objSelComprobante.resetModoComprobanteSelected()},setObjConntet:function(e){xObjContent=e},setFocusTxt:function(){$(".xmonto:first").focus(),xThisPago.$.sel_cliente.value=""},setFocusIinit:function(){setTimeout(()=>{xThisPago.$.sel_cliente.focus,$("#form_pago_cliente #sel_cliente").focus()},500)},setModoSoloComprobante:function(e=!0){this.modoSoloComprobante=e},setModoSoloProveedor:function(){this.modoSoloProveedor=!0,this.hidden_container_pago=!1},focus:function(){},xopen:function(){xdialoag_pago.open()},xclose:function(){xdialoag_pago.close()},reloadInputDatalientes(){_reloadDatalientes()},realoadCompFindComprobante(){_reloadDataCompFindComprobante()},setResetFormaPago:()=>{xCompTableFP.resetFormaPago(),xResetValuesInit()},setTelefonoCliente:e=>{$("#clie_telefono").val(e)}})</script>