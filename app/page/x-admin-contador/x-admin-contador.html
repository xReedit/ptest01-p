<script src="../../view/xApiConsultaSunat.js"></script><script src="../../view/httpFech.js"></script><dom-module id="x-admin-contador"><template is="dom"><paper-dialog id="dialog_reporte_formato"class="dialog_redondo"style="max-width:380px"entry-animation="scale-up-animation"exit-animation="fade-out-animation"><div class="p-3 text-center"><p class="fs-18">Selecciona el formato</p><br><div class="divBtnReporte"><button class="btn btn-sm btn-primary"onclick="downloadReporteCPE_f1()">Formato 1</button> <button class="btn btn-sm btn-success mt-2"onclick="downloadReporteCPE_f2()">Formato SIRE</button> <button class="btn btn-sm btn-success mt-2"onclick="downloadReporteCPE_f3()">Formato SIRE TXT</button></div></div></paper-dialog><paper-dialog id="dialog_match_sunat"class="dialog_redondo"modal style="min-width:330px;max-width:400px"modal entry-animation="scale-up-animation"exit-animation="fade-out-animation"><div class="p-2 text-center"><div><img src="../../../images/scan_docs_sunat.gif"alt="img_match"></div><div hidden$="[[ showProccessVerificationFinalize ]]"><paper-progress indeterminate></paper-progress></div><p class="fs-15 fw-600">Verificando el estado de los comprobantes con Sunat. <span class="text-success">{{numRowsVerificadoSuccess}}</span> de {{ numRowsList}}<div hidden$="[[ !showRowsNoResponse ]]"><br><div class="xLinea2"></div><br><p class="fs-15 fw-600">Sin respuesta: <span class="text-danger">{{numRowsVerificadoError}}</span><div class="d-flexx justify-content-center"hidden$="[[ !showProccessVerificationFinalize ]]"><button class="btn btn-sm btn-info mr-2"onclick="downloadReporteCPE()">Verificar Nuevamente ({{numRowsVerificadoError}})</button> <button class="btn btn-sm btn-success"onclick="setDataListReporte()">Descargar</button></div></div><div hidden$="[[ !showProccessVerificationError ]]"><br><div class="xLinea2"></div><br><p class="fw-600 text-danger">Ocurrio un error al procesar</p><button class="btn btn-sm btn-info mr-2"onclick="downloadReporteCPE()">Procesar Nuevamente</button></div></div></paper-dialog><br><div class="xMiCard xradius"style="width:calc(100% - 10%);height:calc(100vh - 120px)"><div class="xEncanezadoCard xFondoRowAmarillo4"><strong>Reportes de facturacion electronica</strong><br>Para leer los reportes descargados debe contar con Microsof Excel instalado, o cualquier otro programa de calculo que lea archivos ".xml"<br>Para asignar mas Establecimientos o para soporte tecnico, comuniquese con nosotros a <a href="https://papaya.com.pe/"target="_blank">papaya.com.pe</a></div><div class="xContent"><div class="x_div_linea"><div class="xitem1 xBordeDe"style="height:calc(100vh - 185px)"><br><h4>Estableciminetos Asignados</h4><div class="xLinea2"></div><br><table width="100%"><thead><th>#<th>Razon social<th>Ciudad<tbody><template is="dom-repeat"items="{{listAsignados}}"as="item"><tr id="{{index}}"class="animated fadeIn fast xCursor"onclick="selectEsablecimiento(this)"><td class="xfont11">{{displayIndex(index)}}<td class="xfont11">{{item.razonsocial}} | {{item.nomsede}}<td class="xfont11">{{item.ciudad}}</template></table></div><div class="xitem2 xBordeIzqHover"><br><h4>{{selEstablecimiento.nomsede}} | {{selEstablecimiento.ciudad}}</h4><div class="xLinea2"></div><br><div style="width:120px"><label for="selYear"class="xColorRow_Plomo">Seleccione Año:</label> <select id="selYear"class="xTextRow2 xCursor"onchange="selectOptionYear()"><template is="dom-repeat"items="{{listYears}}"as="item"><option value="[[index]]">[[item.y]]</template></select></div><br><table width="100%"><thead><th width="15px">#<th>Mes<th>Estado<th>Acción<tbody><template is="dom-repeat"items="{{listMonth}}"as="item"><tr id="{{index}}"class$="{{item.clase}}"onclick="selectedRowTR(this)"><td class="xfont11">{{displayIndex(index)}}<td class="xfont11">{{item.mes}}<td class="xfont11">{{item.desestado}}<td class="xfont11"><div hidden$="{{!item.activo}}"onclick="downloadReporteCPE_open_dialog(this)"><a class="xCursor">Descargar <img src="../../../images/x_down2.png"alt=""></a></div></template></table></div></div></div></div><div id="reporte"class="xInvisible"><table id="testTable"width="100%"><caption><h1>{{selEstablecimiento.nomsede}} | {{selEstablecimiento.ciudad}}</h1><h2>Reporte de comprobantes electronicos - {{selMes.mes}}</h2><thead><th width="45px">#<th width="15%">f. Emision<th>Tipo<th>Numero<th width="35%">Cliente<th width="15%">RUC/DNI<th align="right">Sub total<th align="right">I.G.V<th align="right">Total<th>Estado Sistema<th>Estado Sunat<tbody><template is="dom-repeat"items="{{ListReporte}}"as="row"><tr><td>{{displayIndex(index)}}<td style$="{{row.style_td}}">{{row.fecha}}<td style$="{{row.style_td}}">{{row.tipo_doc}}<td style$="{{row.style_td}}">{{row.num_doc}}<td style$="{{row.style_td}}">{{row.nom_cliente}}<td style='mso-number-format:"@"'>{{row.ruc}}<td style$="{{row.style_td}}">{{row.subtotal}}<td style$="{{row.style_td}}">{{row.igv}}<td style$="{{row.style_td}}">{{row.total}}<td style$="{{row.style_reporte}}">{{row.estado}}<td style$="{{row.style_estado_sunat}}">{{row.estadoCp}}</template></table></div><div id="reporte-sire"class="xInvisible"><table id="testTableSire"width="100%"><caption><h1>{{selEstablecimiento.nomsede}} | {{selEstablecimiento.ciudad}}</h1><h2>Registro de Ventas - {{selMes.mes}}</h2><thead><th width="45px">#<th>Ruc<th>Razon Social<th>Periodo<th>CAR SUNAT<th width="15%">Fecha de emisión<th width="15%">Fecha Vcto/Pago<th>Tipo CP/Doc.<th>Serie del CDP<th>Nro CP o Doc<th>Nro Final<th width="15%">Tipo Doc Identidad<th width="15%">Nro Doc Identidad<th width="35%">Apellidos Nombres/ Razón Social<th>Valor Facturado Exportación<th>BI Gravada<th>Dscto BI<th>IGV / IPM<th>Dscto IGV / IPM<th>Mto Exonerado<th>Mto Inafecto<th>ISC<th>BI Grav IVAP<th>IVAP<th>ICBPER<th>Otros Tributos<th>Total CP<th>Moneda<th>Tipo Cambio<th>Fecha Emisión Doc Modificado<th>Tipo CP Modificado<th>Serie CP Modificado<th>Nro CP Modificado<th>ID Proyecto Operadores<th>Atribución<th>Tipo de Nota<th>Est. Comp<th>Desc. Comp<th>Valor FOB Embarcado<th>Valor OP Gratuitas<th>Tipo Operación<th>DAM / CP<th>CLU<th>Estado Sistema<th>Estado Sunat<tbody><template is="dom-repeat"items="{{ListReporte}}"as="row"><tr><td>{{displayIndex(index)}}<td style$="{{row.style_td}}">{{selEstablecimiento.ruc}}<td style$="{{row.style_td}}">{{selEstablecimiento.razonsocial}}<td style$="{{row.style_td}}">{{periodoComprobantes}}<td style$="{{row.style_td}}">{{row.cart_sunat}}<td style='mso-number-format:"\@"'>{{row.fecha}}<td style='mso-number-format:"\@"'>{{row.fecha}}<td style='mso-number-format:"\@"'>{{row.tipo_doc_id}}<td style$="{{row.style_td}}">{{row.serie_doc}}<td style$="{{row.style_td}}">{{row.numero_doc}}<td style$="{{row.style_td}}"><td style='mso-number-format:"\@"'>{{row.tipo_doc_id_cliente}}<td style='mso-number-format:"\@"'>{{row.num_doc_cliente}}<td style$="{{row.style_td}}">{{row.nom_cliente}}<td style='mso-number-format:"0.00"'>{{row.total_exportacion}}<td style='mso-number-format:"0.00"'>{{row.total_gravado}}<td style='mso-number-format:"0.00"'>0.00<td style='mso-number-format:"0.00"'>{{row.igv}}<td style='mso-number-format:"0.00"'>0.00<td style='mso-number-format:"0.00"'>{{row.total_exonerado}}<td style='mso-number-format:"0.00"'>{{row.total_inafecto}}<td style='mso-number-format:"0.00"'>{{row.total_isc}}<td style='mso-number-format:"0.00"'>0.00<td style='mso-number-format:"0.00"'>0.00<td style='mso-number-format:"0.00"'>0.00<td style='mso-number-format:"0.00"'>0.00<td style='mso-number-format:"0.00"'>{{row.total}}<td style$="{{row.style_td}}">{{row.moneda_doc}}<td style$="{{row.style_td}}">1<td style$="{{row.style_td}}"><td style$="{{row.style_td}}"><td style$="{{row.style_td}}"><td style$="{{row.style_td}}"><td style$="{{row.style_td}}"><td style$="{{row.style_td}}"><td style$="{{row.style_td}}"><td style$="{{row.style_td}}">{{row.estado_cpe}}<td style$="{{row.style_td}}">{{row.estado_descricpion_cpe}}<td style$="{{row.style_td}}">0.00<td style$="{{row.style_td}}">{{row.total_gratuito}}<td style='mso-number-format:"\@"'>0101<td style$="{{row.style_td}}"><td style$="{{row.style_td}}"><td style$="{{row.style_reporte}}">{{row.estado}}<td style$="{{row.style_estado_sunat}}">{{row.estadoCp}}</template><template is="dom-if"if="{{index === (ListReporte.length - 1)}}"><tr><td colspan="13"><td>TOTAL<td style='mso-number-format:"0.00";font-weight:700'>{{arrSumatoria.total_exportacion}}<td style='mso-number-format:"0.00";font-weight:700'>{{arrSumatoria.total_gravado}}<td>0<td style='mso-number-format:"0.00";font-weight:700'>{{arrSumatoria.total_igv}}<td>0<td style='mso-number-format:"0.00";font-weight:700'>{{arrSumatoria.total_exonerado}}<td style='mso-number-format:"0.00";font-weight:700'>{{arrSumatoria.total_inafecto}}<td style='mso-number-format:"0.00";font-weight:700'>{{arrSumatoria.total_isc}}<td>0<td>0<td>0<td>0<td style='mso-number-format:"0.00";font-weight:700'>{{arrSumatoria.total}}</template></table></div><style>tr.selected,tr:hover{background-color:#e3f2fd}.divBtnReporte{display:flex;flex-direction:column;flex-wrap:nowrap;align-items:center}</style></template></dom-module><script src="../../view/export.excel.js"></script><script>var xThisAdmContador,xObjBorrar,_apiConsultaCpe,dataListReporte,objProcesar,listCpeSuccess=[];const dateNow=new Date,_m_now=dateNow.getMonth()+1,_y_now=dateNow.getFullYear();function xIniAdmContador(){xPopupLoad=document.getElementById("xLoad"),setTimeout(()=>{_apiConsultaCpe=new apiConsulaCpe},1500);var o=xm_log_get("app3_us");xThisAdmContador.xt_org=o.ido,xThisAdmContador.xt_idsede=o.idsede,xThisAdmContador.xt_idus=o.idus,xThisAdmContador.ListReporte=[],$("body").addClass("loaded"),$(".xPasarEnter2").on("keyup",function(o){o=o.which;if(13==o||186==o){var o=$("input"),t=o.index(document.activeElement);if(null!==o[t+1]){var a=o[t+1];if(void 0===a)return;if(null==(a=a.disabled?o[t+2]:a))return;a.focus(),a.select()}return!1}}),xLoadEstablecimientosAsignados()}function xLoadEstablecimientosAsignados(){$.ajax({type:"GET",url:"../../bdphp/log_007.php?op=1"}).done(o=>{o=JSON.parse(o);xThisAdmContador.listAsignados=o.datos})}function selectEsablecimiento(o){var t=o.id;xThisAdmContador.selEstablecimiento=xThisAdmContador.listAsignados[t],xThisAdmContador.showVerificacionSunat="1"==xThisAdmContador.selEstablecimiento.habilita_verificacion_cpe,listCpeSuccess=[],xDataYears(),selectedRowTR(o)}function selectedRowTR(o){$(o).addClass("selected").siblings().removeClass("selected")}function xDataYears(){for(var o=xThisAdmContador.selEstablecimiento.mes_inicio.split("/"),t=(o[0],o[1]),a=0,e=[];t<=_y_now;)e.push({y:t}),t++,a++;xThisAdmContador.listYears=e,setTimeout(()=>{xThisAdmContador.$.selYear.selectedIndex=a-1,xDataYearsMonth(_y_now)},100)}function selectOptionYear(){var o=xThisAdmContador.$.selYear.selectedIndex;xDataYearsMonth(parseInt(xThisAdmContador.listYears[o].y))}function xDataYearsMonth(o){for(var t=[],a=1,e=xThisAdmContador.selEstablecimiento.mes_inicio.split("/"),r=parseInt(e[1]),s=_y_now===r?parseInt(e[0])+r:1+_y_now,i=_y_now===o;a<=12;){var d=i?_m_now+_y_now:12+o,n=a+o,d=!(n<s||d<n),n=d?"animated fadeIn fast xCursor":"animated fadeIn fast xColorRow_Plomo2",c=d?"DISPONIBLE":"SIN DATOS";t.push({mes:xDesMes(a-1)+" "+o,m:a,y:o,activo:d,clase:n,desestado:c}),a++}xThisAdmContador.listMonth=t}async function downloadReporteCPE(o){xThisAdmContador.objProcesar=o||xThisAdmContador.objProcesar,o=xThisAdmContador.objProcesar;var m=0,p=0,o=o.parentElement.parentElement.id,o=xThisAdmContador.listMonth[o],t=(xThisAdmContador.selMes=o,xThisAdmContador.numRowsVerificadoSuccess=0,xThisAdmContador.showRowsNoResponse=!1,xThisAdmContador.showProccessVerificationFinalize=!1,xThisAdmContador.showProccessVerificationError=!1,xThisAdmContador.selEstablecimiento.ruc=xThisAdmContador.selEstablecimiento.ruc.trim(),{establecimiento:xThisAdmContador.selEstablecimiento,m:o.m,y:o.y});xPopupLoad.titulo="Descargando...",xPopupLoad.xopen(),xThisAdmContador.periodoComprobantes=o.y+""+xCeroIzq(o.m,2);let u=await _apiConsultaCpe.getToken(),C=0;const x=u.access_token;xThisAdmContador.arrSumatoria={total_exportacion:0,total_gravado:0,total_igv:0,total_exonerado:0,total_inafecto:0,total_isc:0,total:0},dataListReporte=[],xThisAdmContador.ListReporte=[],$.ajax({type:"POST",url:"../../bdphp/log_007.php?op=2",data:{item:t}}).done(async t=>{if(!(t=JSON.parse(t)).error){xPopupLoad.xclose(),dialog_match_sunat.open();var a=xThisAdmContador.selEstablecimiento.ruc,e=t.data.length;xThisAdmContador.numRowsList=e;for(let o=0;o<e;o++){var r=t.data[o];r.estado="FACTURA"===r.tipo_doc&&0===parseInt(r.ruc)?"ANULADO":r.estado,r.style_reporte="ANULADO"===r.estado?"color: red":"color: green",r.style_td="ANULADO"===r.estado?"color: red":"";try{var s=listCpeSuccess.find(o=>o.id===r.id),i=-1<r.series.indexOf("F")?"01":"03",d=parseInt(r.num_doc.split("-")[1]);if(s)r=s,m++;else{var n,c=r.total.replace(/,/g,""),l={header:{ruc_receptor:r.ruc,access_token:x},body:{numRuc:a,codComp:i,numeroSerie:r.series,numero:d,fechaEmision:r.fecha,monto:c}};"anulado"==r.estado.toLowerCase()&&(r.total="0",r.subtotal="0");let o;1==xThisAdmContador.selEstablecimiento.habilita_verificacion_cpe?"1"==r.rpt_sunat?(o=xEstadoCpeApi("1"),r.estado_cpe="1",r.estado_descricpion_cpe=o.titulo,r.success_sunat=1,r.estadoCp=o.titulo,r.style_estado_sunat="color: "+o.color,m++,listCpeSuccess.push(r)):(!0===(n=await _apiConsultaCpe.getConsulta(l))?.success&&n?.data?.estadoCp?(r.success_sunat=1,o=xEstadoCpeApi(n.data.estadoCp),r.estadoCp=o.titulo,r.style_estado_sunat="color: "+o.color,r.estado_cpe=n.data.estadoCp,r.estado_descricpion_cpe=r.estadoCp,"0"===n.data.estadoCp&&(r.estado=o.titulo,r.style_reporte="color: "+o.color,r.total="0",r.subtotal="0",r.total_exonerado="0"),m++,listCpeSuccess.push(r)):(p++,r.success_sunat=0,r.estadoCp="Sin Respuesta",r.style_estado_sunat="color: black",xThisAdmContador.showRowsNoResponse=!0),500<C&&(u=await _apiConsultaCpe.getToken(),C=0),C++):(m++,listCpeSuccess.push(r))}xThisAdmContador.numRowsVerificadoSuccess=m,xThisAdmContador.numRowsVerificadoError=p,r.cart_sunat=xThisAdmContador.selEstablecimiento.ruc+r.tipo_doc_id+r.serie_doc+xCeroIzq(r.numero_doc,10),"07"==r.tipo_doc_id&&(r.subtotal="-"+r.subtotal,r.igv="-"+r.igv,r.total="-"+r.total,r.total_exonerado="-"+r.total_exonerado,r.total_inafecto="-"+r.total_inafecto),xThisAdmContador.arrSumatoria.total_exportacion+=parseFloat(removeComas(r.total_exportacion)),xThisAdmContador.arrSumatoria.total_gravado+=parseFloat(removeComas(r.total_gravado)),xThisAdmContador.arrSumatoria.total_igv+=parseFloat(removeComas(r.igv)),xThisAdmContador.arrSumatoria.total_exonerado+=parseFloat(removeComas(r.total_exonerado)),xThisAdmContador.arrSumatoria.total_inafecto+=parseFloat(removeComas(r.total_inafecto)),xThisAdmContador.arrSumatoria.total_isc+=parseFloat(removeComas(r.total_isc)),xThisAdmContador.arrSumatoria.total+=parseFloat(removeComas(r.total)),dataListReporte.push(r)}catch(o){return xThisAdmContador.showProccessVerificationFinalize=!0,void(xThisAdmContador.showProccessVerificationError=!0)}}xThisAdmContador.showProccessVerificationFinalize=!0,xThisAdmContador.showRowsNoResponse||xThisAdmContador.showProccessVerificationError||(xThisAdmContador.arrSumatoria=JSON.parse(JSON.stringify(xThisAdmContador.arrSumatoria)),setDataListReporte(dataListReporte))}})}function xEstadoCpeApi(o){var t={titulo:"",color:""};switch(o.toString()){case"0":t.titulo="NO EXISTE",t.color="purple";break;case"1":t.titulo="ACEPTADO",t.color="green";break;case"2":t.titulo="ANULADO",t.color="red";break;case"3":t.titulo="AUTORIZADO",t.color="green";break;case"4":t.titulo="NO AUTORIZADO",t.color="red"}return t}function setDataListReporte(o){xThisAdmContador.ListReporte=o||dataListReporte,setTimeout(()=>{xExportarExcel()},500)}function xExportarExcel(){var o;xPopupLoad.titulo="Exportando...",xPopupLoad.xopen(),3==xThisAdmContador.format_download?xGenerarReporteTXT():(o=1==xThisAdmContador.format_download?"testTable":"testTableSire",tableToExcel(o,"Comprobantes")),setTimeout(()=>{xPopupLoad.xclose(),xPopupLoad.titulo="Cargando...",dialog_match_sunat.close()},500)}function downloadReporteCPE_f1(){xThisAdmContador.format_download=1,runDownloadReporteCPE()}function downloadReporteCPE_f2(){xThisAdmContador.format_download=2,runDownloadReporteCPE()}function downloadReporteCPE_f3(){xThisAdmContador.format_download=3,runDownloadReporteCPE()}function downloadReporteCPE_open_dialog(o){xThisAdmContador.objProcesar=o,dialog_reporte_formato.open()}function runDownloadReporteCPE(){downloadReporteCPE(),dialog_reporte_formato.close()}function xGenerarReporteTXT(){let t="Ruc|Razon Social|Periodo|CAR SUNAT|Fecha de emisión|Fecha Vcto/Pago|Tipo CP/Doc.|Serie del CDP|Nro CP o Doc. Nro Inicial (Rango)|Nro Final (Rango)|Tipo Doc Identidad|Nro Doc Identidad|Apellidos Nombres/ Razón Social|Valor Facturado Exportación|BI Gravada|Dscto BI|IGV / IPM|Dscto IGV / IPM|Mto Exonerado|Mto Inafecto|ISC|BI Grav IVAP|IVAP|ICBPER|Otros Tributos|Total CP|Moneda|Tipo Cambio|Fecha Emisión Doc Modificado|Tipo CP Modificado|Serie CP Modificado|Nro CP Modificado|ID Proyecto Operadores Atribución|Tipo de Nota|Est. Comp|Valor FOB Embarcado|Valor OP Gratuitas|Tipo Operación|DAM / CP|CLU\n";dataListReporte.forEach(o=>{t+=`${xThisAdmContador.selEstablecimiento.ruc}|${xThisAdmContador.selEstablecimiento.razonsocial}|${xThisAdmContador.periodoComprobantes}|${o.cart_sunat}|${o.fecha}|${o.fecha}|${o.tipo_doc_id}|${o.serie_doc}|${o.numero_doc}||${o.tipo_doc_id_cliente}|${o.num_doc_cliente}|${o.nom_cliente}|${parseFloat(removeComas(o.total_exportacion))}|${parseFloat(removeComas(o.total_gravado))}|0|${parseFloat(removeComas(o.igv))}|0|${parseFloat(removeComas(o.total_exonerado))}|${parseFloat(removeComas(o.total_inafecto))}|${parseFloat(removeComas(o.total_isc))}|0|0|0|0|${parseFloat(removeComas(o.total))}||||||||1|0|0|0|0101||\n`});var o=document.createElement("a");o.href="data:text/plain;charset=utf-8,"+encodeURIComponent(t),o.download="comprobantes.txt",document.body.appendChild(o),o.click(),document.body.removeChild(o)}Polymer({is:"x-admin-contador",properties:{xt_org:Number,xt_idsede:Number,xt_idus:Number,listYears:[],listMonth:[],listAsignados:[],ListReporte:[],selEstablecimiento:[],selMes:[],numRowsVerificadoSuccess:Number,numRowsVerificadoError:Number,numRowsList:Number,showRowsNoResponse:Boolean,showProccessVerificationFinalize:Boolean,showProccessVerificationError:Boolean,showVerificacionSunat:Boolean,periodoComprobantes:String,format_download:Number,objProcesar:Object,arrSumatoria:Object},attached:function(){this.selected=0,this.showRowsNoResponse=!1,this.showProccessVerificationFinalize=!1,this.showProccessVerificationError=!1,this.showVerificacionSunat=!1,this.arrSumatoria={total_exportacion:0,total_gravado:0,total_igv:0,total_exonerado:0,total_inafecto:0,total_isc:0,total:0},xThisAdmContador=this,xIniAdmContador()},displayIndex:function(o){return xCeroIzq(o+1,1)},sumatoriaTotal:function(o){return xThisAdmContador.arrSumatoria[o].toFixed(2)}})</script>