<script src="../../view/xApiConsultaSunat.js"></script><script src="../../view/httpFech.js"></script><dom-module id="x-admin-contador"><template is="dom"><paper-dialog id="dialog_match_sunat"class="dialog_redondo"modal style="min-width:330px;max-width:400px"modal entry-animation="scale-up-animation"exit-animation="fade-out-animation"><div class="p-2 text-center"><div><img src="../../../images/scan_docs_sunat.gif"alt="img_match"></div><div hidden$="[[ showProccessVerificationFinalize ]]"><paper-progress indeterminate></paper-progress></div><p class="fs-15 fw-600">Verificando el estado de los comprobantes con Sunat. <span class="text-success">{{numRowsVerificadoSuccess}}</span> de {{ numRowsList}}<div hidden$="[[ !showRowsNoResponse ]]"><br><div class="xLinea2"></div><br><p class="fs-15 fw-600">Sin respuesta: <span class="text-danger">{{numRowsVerificadoError}}</span><div class="d-flexx justify-content-center"hidden$="[[ !showProccessVerificationFinalize ]]"><button class="btn btn-sm btn-info mr-2"onclick="downloadReporteCPE()">Verificar Nuevamente ({{numRowsVerificadoError}})</button> <button class="btn btn-sm btn-success"onclick="setDataListReporte()">Descargar</button></div></div><div hidden$="[[ !showProccessVerificationError ]]"><br><div class="xLinea2"></div><br><p class="fw-600 text-danger">Ocurrio un error al procesar</p><button class="btn btn-sm btn-info mr-2"onclick="downloadReporteCPE()">Procesar Nuevamente</button></div></div></paper-dialog><br><div class="xMiCard xradius"style="width:calc(100% - 10%);height:calc(100vh - 120px)"><div class="xEncanezadoCard xFondoRowAmarillo4"><strong>Reportes de facturacion electronica</strong><br>Para leer los reportes descargados debe contar con Microsof Excel instalado, o cualquier otro programa de calculo que lea archivos ".xml"<br>Para asignar mas Establecimientos o para soporte tecnico, comuniquese con nosotros a <a href="https://papaya.com.pe/"target="_blank">papaya.com.pe</a></div><div class="xContent"><div class="x_div_linea"><div class="xitem1 xBordeDe"style="height:calc(100vh - 185px)"><br><h4>Estableciminetos Asignados</h4><div class="xLinea2"></div><br><table width="100%"><thead><th>#<th>Razon social<th>Ciudad<tbody><template is="dom-repeat"items="{{listAsignados}}"as="item"><tr id="{{index}}"class="animated fadeIn fast xCursor"onclick="selectEsablecimiento(this)"><td class="xfont11">{{displayIndex(index)}}<td class="xfont11">{{item.razonsocial}} | {{item.nomsede}}<td class="xfont11">{{item.ciudad}}</template></table></div><div class="xitem2 xBordeIzqHover"><br><h4>{{selEstablecimiento.nomsede}} | {{selEstablecimiento.ciudad}}</h4><div class="xLinea2"></div><br><div style="width:120px"><label for="selYear"class="xColorRow_Plomo">Seleccione AÃ±o:</label> <select id="selYear"class="xTextRow2 xCursor"onchange="selectOptionYear()"><template is="dom-repeat"items="{{listYears}}"as="item"><option value="[[index]]">[[item.y]]</template></select></div><br><table width="100%"><thead><th width="15px">#<th>Mes<th>Estado<th>Accion<tbody><template is="dom-repeat"items="{{listMonth}}"as="item"><tr id="{{index}}"class$="{{item.clase}}"onclick="selectedRowTR(this)"><td class="xfont11">{{displayIndex(index)}}<td class="xfont11">{{item.mes}}<td class="xfont11">{{item.desestado}}<td class="xfont11"><div hidden$="{{!item.activo}}"onclick="downloadReporteCPE(this)"><a>Descargar <img src="../../../images/x_down2.png"alt=""></a></div></template></table></div></div></div></div><div id="reporte"class="xInvisible"><table id="testTable"width="100%"><caption><h1>{{selEstablecimiento.nomsede}} | {{selEstablecimiento.ciudad}}</h1><h2>Reporte de comprobantes electronicos - {{selMes.mes}}</h2><thead><th width="45px">#<th width="15%">f. Emision<th>Tipo<th>Numero<th width="35%">Cliente<th width="15%">RUC/DNI<th align="right">Sub total<th align="right">I.G.V<th align="right">Total<th>Estado Sistema<th>Estado Sunat<tbody><template is="dom-repeat"items="{{ListReporte}}"as="row"><tr><td>{{displayIndex(index)}}<td style$="{{row.style_td}}">{{row.fecha}}<td style$="{{row.style_td}}">{{row.tipo_doc}}<td style$="{{row.style_td}}">{{row.num_doc}}<td style$="{{row.style_td}}">{{row.nom_cliente}}<td style='mso-number-format:"@"'>{{row.ruc}}<td style$="{{row.style_td}}">{{row.subtotal}}<td style$="{{row.style_td}}">{{row.igv}}<td style$="{{row.style_td}}">{{row.total}}<td style$="{{row.style_reporte}}">{{row.estado}}<td style$="{{row.style_estado_sunat}}">{{row.estadoCp}}</template></table></div><style>tr.selected,tr:hover{background-color:#e3f2fd}</style></template></dom-module><script src="../../view/export.excel.js"></script><script>var xThisAdmContador,xObjBorrar,_apiConsultaCpe,dataListReporte,objProcesar,listCpeSuccess=[];const dateNow=new Date,_m_now=dateNow.getMonth()+1,_y_now=dateNow.getFullYear();function xIniAdmContador(){xPopupLoad=document.getElementById("xLoad"),setTimeout(()=>{_apiConsultaCpe=new apiConsulaCpe},1500);var o=xm_log_get("app3_us");xThisAdmContador.xt_org=o.ido,xThisAdmContador.xt_idsede=o.idsede,xThisAdmContador.xt_idus=o.idus,xThisAdmContador.ListReporte=[],$("body").addClass("loaded"),$(".xPasarEnter2").on("keyup",function(o){o=o.which;if(13==o||186==o){var o=$("input"),e=o.index(document.activeElement);if(null!==o[e+1]){var s=o[e+1];if(void 0===s)return;if(null==(s=s.disabled?o[e+2]:s))return;s.focus(),s.select()}return!1}}),xLoadEstablecimientosAsignados()}function xLoadEstablecimientosAsignados(){$.ajax({type:"GET",url:"../../bdphp/log_007.php?op=1"}).done(o=>{o=JSON.parse(o);xThisAdmContador.listAsignados=o.datos})}function selectEsablecimiento(o){var e=o.id;xThisAdmContador.selEstablecimiento=xThisAdmContador.listAsignados[e],xThisAdmContador.showVerificacionSunat="1"==xThisAdmContador.selEstablecimiento.habilita_verificacion_cpe,listCpeSuccess=[],xDataYears(),selectedRowTR(o)}function selectedRowTR(o){$(o).addClass("selected").siblings().removeClass("selected")}function xDataYears(){for(var o=xThisAdmContador.selEstablecimiento.mes_inicio.split("/"),e=(o[0],o[1]),s=0,t=[];e<=_y_now;)t.push({y:e}),e++,s++;xThisAdmContador.listYears=t,setTimeout(()=>{xThisAdmContador.$.selYear.selectedIndex=s-1,xDataYearsMonth(_y_now)},100)}function selectOptionYear(){var o=xThisAdmContador.$.selYear.selectedIndex;xDataYearsMonth(parseInt(xThisAdmContador.listYears[o].y))}function xDataYearsMonth(o){for(var e=[],s=1,t=xThisAdmContador.selEstablecimiento.mes_inicio.split("/"),a=parseInt(t[1]),i=_y_now===a?parseInt(t[0])+a:1+_y_now,r=_y_now===o;s<=12;){var n=r?_m_now+_y_now:12+o,d=s+o,n=!(d<i||n<d),d=n?"animated fadeIn fast xCursor":"animated fadeIn fast xColorRow_Plomo2",c=n?"DISPONIBLE":"SIN DATOS";e.push({mes:xDesMes(s-1)+" "+o,m:s,y:o,activo:n,clase:d,desestado:c}),s++}xThisAdmContador.listMonth=e}async function downloadReporteCPE(o){var p=0,m=0,o=(o=objProcesar=o||objProcesar).parentElement.parentElement.id,o=xThisAdmContador.listMonth[o],o=(xThisAdmContador.selMes=o,xThisAdmContador.numRowsVerificadoSuccess=0,xThisAdmContador.showRowsNoResponse=!1,xThisAdmContador.showProccessVerificationFinalize=!1,xThisAdmContador.showProccessVerificationError=!1,xThisAdmContador.selEstablecimiento.ruc=xThisAdmContador.selEstablecimiento.ruc.trim(),{establecimiento:xThisAdmContador.selEstablecimiento,m:o.m,y:o.y});let h=await _apiConsultaCpe.getToken(),x=0;const C=h.access_token;xPopupLoad.titulo="Descargando...",xPopupLoad.xopen(),dataListReporte=[],xThisAdmContador.ListReporte=[],$.ajax({type:"POST",url:"../../bdphp/log_007.php?op=2",data:{item:o}}).done(async e=>{if((e=JSON.parse(e)).error)console.log(e.error);else{xPopupLoad.xclose(),dialog_match_sunat.open();var s=xThisAdmContador.selEstablecimiento.ruc,t=e.data.length;xThisAdmContador.numRowsList=t;for(let o=0;o<t;o++){var a=e.data[o];a.estado="FACTURA"===a.tipo_doc&&0===parseInt(a.ruc)?"ANULADO":a.estado,a.style_reporte="ANULADO"===a.estado?"color: red":"color: green",a.style_td="ANULADO"===a.estado?"color: red":"";try{var i,r,n,d,c,l,u=listCpeSuccess.find(o=>o.id===a.id);u?(a=u,p++):(i=-1<a.series.indexOf("F")?"01":"03",r=parseInt(a.num_doc.split("-")[1]),n=a.total.replace(/,/g,""),d={header:{ruc_receptor:a.ruc,access_token:C},body:{numRuc:s,codComp:i,numeroSerie:a.series,numero:r,fechaEmision:a.fecha,monto:n}},"anulado"==a.estado.toLowerCase()&&(a.total="0",a.subtotal="0"),1==xThisAdmContador.selEstablecimiento.habilita_verificacion_cpe?"1"==a.rpt_sunat?(a.success_sunat=1,estado_cpe=xEstadoCpeApi("1"),a.estadoCp=estado_cpe.titulo,a.style_estado_sunat="color: "+estado_cpe.color,p++,listCpeSuccess.push(a)):(!0===(c=await _apiConsultaCpe.getConsulta(d))?.success&&c?.data?.estadoCp?(a.success_sunat=1,l=xEstadoCpeApi(c.data.estadoCp),a.estadoCp=l.titulo,a.style_estado_sunat="color: "+l.color,"0"===c.data.estadoCp&&(a.estado=l.titulo,a.style_reporte="color: "+l.color,a.total="0",a.subtotal="0"),p++,listCpeSuccess.push(a)):(m++,a.success_sunat=0,a.estadoCp="Sin Respuesta",a.style_estado_sunat="color: black",xThisAdmContador.showRowsNoResponse=!0),500<x&&(h=await _apiConsultaCpe.getToken(),x=0),x++):(p++,listCpeSuccess.push(a))),xThisAdmContador.numRowsVerificadoSuccess=p,xThisAdmContador.numRowsVerificadoError=m,dataListReporte.push(a)}catch(o){return xThisAdmContador.showProccessVerificationFinalize=!0,void(xThisAdmContador.showProccessVerificationError=!0)}}xThisAdmContador.showProccessVerificationFinalize=!0,xThisAdmContador.showRowsNoResponse||xThisAdmContador.showProccessVerificationError||setDataListReporte(dataListReporte)}})}function xEstadoCpeApi(o){var e={titulo:"",color:""};switch(o.toString()){case"0":e.titulo="NO EXISTE",e.color="purple";break;case"1":e.titulo="ACEPTADO",e.color="green";break;case"2":e.titulo="ANULADO",e.color="red";break;case"3":e.titulo="AUTORIZADO",e.color="green";break;case"4":e.titulo="NO AUTORIZADO",e.color="red"}return e}function setDataListReporte(o){xThisAdmContador.ListReporte=o||dataListReporte,setTimeout(()=>{xExportarExcel()},500)}function xExportarExcel(){tableToExcel("testTable","Comprobantes"),setTimeout(()=>{dialog_match_sunat.close()},500)}Polymer({is:"x-admin-contador",properties:{xt_org:Number,xt_idsede:Number,xt_idus:Number,listYears:[],listMonth:[],listAsignados:[],ListReporte:[],selEstablecimiento:[],selMes:[],numRowsVerificadoSuccess:Number,numRowsVerificadoError:Number,numRowsList:Number,showRowsNoResponse:Boolean,showProccessVerificationFinalize:Boolean,showProccessVerificationError:Boolean,showVerificacionSunat:Boolean},attached:function(){this.selected=0,this.showRowsNoResponse=!1,this.showProccessVerificationFinalize=!1,this.showProccessVerificationError=!1,this.showVerificacionSunat=!1,xThisAdmContador=this,xIniAdmContador()},displayIndex:function(o){return xCeroIzq(o+1,1)}})</script>