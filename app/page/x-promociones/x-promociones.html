<dom-module id="x-promociones"><link rel="import"href="../../x-componentes/x-comp-find-item-producto/x-comp-find-item-producto.html"><link rel="import"href="../../x-componentes/x-comp-find-seccion/x-comp-find-seccion.html"><link rel="import"href="../../x-componentes/x-comp-img-upload/x-comp-img-upload-2.html"><script src="../../view/httpFech.js"></script><template><paper-dialog modal id="dialog_img_gif_promo"class="dialog_redondo"style="min-width:300px"entry-animation="scale-up-animation"exit-animation="fade-out-animation"><div class="xContent"><div class="div-content-img"><template is="dom-repeat"items="{{listIconGif}}"as="item"><img data-id="[[index]]"src$="[[item.path]]"alt$="[[item.titulo]]"class="xCursor"onclick="selectOptionIcoGif(this)"></template></div><hr><br><br><div class="xBoton2 xPlomo"dialog-dismiss>Cerrar</div></div></paper-dialog><br><div class="xMiCard xradius"style="width:94%;max-width:1300px"><div class="xEncanezadoCard"style="background:#fff0f5;color:#424242"><div class="d-flexx justify-content-between align-items-center"><p class="fs-18">Promociones. Descuentos</div></div><div class="xContentCard"style="padding:20px"><div class="w-100"hidden$="[[!isShowListaPromo]]"class="animate__animated animate__fadeIn"><div class="d-flexx justify-content-between align-items-center"><p class="fw-600 fs-18">Lista</p><button class="btn btn-sm btn-success"onclick="xNewPromocion()">+ Agregar</button></div><br><table class="w-100"><thead><th>Activo<th>Fecha<th width="30%">Titulo<th>Inicio<th>Fin<th aling="right"><tbody><template is="dom-repeat"items="{{dataPromociones}}"as="item"><tr data-id="[[item.idpromocion]]"><td><paper-toggle-button checked$="[[item.check_activo]]"onchange="xDisabledPromo(this)">Toggle</paper-toggle-button><td>{{ item.fecha_registro }}<td width="30%"><p class="fw-600">{{ item.parametros.header.titulo }}<p class="text-secondary fs-10">{{ item.parametros.header.descripcion }}<td><p class="fw-600">{{ item.parametros.body.f_inicio }}<p class="text-secondary fs-10">{{ item.parametros.body.h_inicio }}<td><p class="fw-600">{{ item.parametros.body.f_fin }}<p class="text-secondary fs-10">{{ item.parametros.body.h_fin }}<td aling="right"><button class="btn btn-sm btn-info"onclick="xModificarPromo(this)">Modificar</button></template></table><br><br><br></div><div hidden$="[[isShowListaPromo]]"class="animate__animated animate__fadeIn"><div class="w-100"><div class="d-flexx justify-content-between align-items-center"><p class="fs-18">Detalle Promoción</p><button class="btn btn-secondary ml-2"onclick="backListPromo()">Atras</button></div><hr><br><div class="conent-grid-two"><div class="div-child"><p class="fw-600">Tipo</p><select id="select_promo"class="selected-template-1 w-100"onchange="selectOptionPromo()"><template is="dom-repeat"items="{{listPromos}}"as="item"><option value="[[index]]">[[item.titulo]]</template></select><br><div><p class="text-secondary">{{ promoSeleted.descripcion }}</div><br><div class="xLinea2"></div><br><br><div><p class="fw-600">Titulo</p><input class="selected-template-1 w-100"placeholder="Titulo"onchange="conMayusculas(this)"id="titulo"onkeyup="xValidFormPromo()"required><br><br><p class="fw-600">Descripcion</p><textarea class="selected-template-1 w-100"maxlength="150"rows="4"id="descripcion"onkeyup="xValidFormPromo()"required></textarea></div><br><div><p class="fw-600">Imagen Promocional<p class="text-secondary">Esta imagen se mostrará en la aplicación de delivery "Papaya Expres". *Debe coincindir en el recuadro.</p><x-comp-img-upload-2 id="compImgPromo"medidasimg="[[medidaImg]]"></x-comp-img-upload-2></div><br></div><div class="div-child"><p class="fs-16">Parametros</p><br><div><div><p class="fw-600">Dias de la semana<div style="display:grid"><paper-checkbox class="mr-1 check_dia"data-id="0">Domingo</paper-checkbox><paper-checkbox class="mr-1 check_dia"data-id="1">Lunes</paper-checkbox><paper-checkbox class="mr-1 check_dia"data-id="2">Martes</paper-checkbox><paper-checkbox class="mr-1 check_dia"data-id="3">Miercoles</paper-checkbox><paper-checkbox class="mr-1 check_dia"data-id="4">Jueves</paper-checkbox><paper-checkbox class="mr-1 check_dia"data-id="5">Viernes</paper-checkbox><paper-checkbox class="mr-1 check_dia"data-id="6">Sabado</paper-checkbox></div></div><div class="pt-3"><p class="fw-600">Fecha de Vigencia<div class="d-flexx"><div class="mr-1"><p class="text-secondary">Fecha de Inicio</p><input type="date"id="f_ini"class="selected-template-1"onkeyup="xValidFormPromo()"required></div><div><p class="text-secondary">Fecha de Fin</p><input type="date"id="f_fin"class="selected-template-1"onkeyup="xValidFormPromo()"required></div></div></div><div class="pt-3"><p class="fw-600">Hora de Vigencia<div class="d-flexx"><div class="mr-1"><p class="text-secondary">Hora de Inicio</p><input type="time"class="selected-template-1"id="h_ini"onkeyup="xValidFormPromo()"required></div><div><p class="text-secondary">Hora de Fin</p><input type="time"class="selected-template-1"id="h_fin"onkeyup="xValidFormPromo()"required></div></div></div><div class="pt-3"id="div_num_primeros_pedidos"><p class="fw-600">Cantidad de pedidos<p class="text-secondary">Si se limita a los primeros x pedidos. Colocar cero (0) si es ílimitado.</p><input type="number"class="selected-template-1"placeholder="Titulo"onchange="conMayusculas(this)"value="0"id="num_primeros_pedidos"></div><div class="pt-3"id="div_importe_consumo_min"><p class="fw-600">Importe mínimo de consumo<p class="text-secondary">Ej: Si el importe total del pedido supera los S/100.00 entonces aplica a la promoción. Colocar cero (0) sino corresponde.</p><input type="number"class="selected-template-1"placeholder="Titulo"onchange="conMayusculas(this)"value="0"id="importe_consumo_min"></div><div class="pt-3"><p class="fw-600">Solo por la aplicación<p class="text-secondary">la promocion solo aplica para los pedidos realizados desde la aplicacion Papaya Expres (Delivery o Mozo Virtual).</p><paper-checkbox id="check_solo_app"class="mr-1"data-id="6">Solo App</paper-checkbox></div><div class="pt-3"><p class="fw-600">Icono de Seccion</p><button class="btn btn-sm btn-secondary"onclick="dialog_img_gif_promo.open()">Seleccionar</button><br><br><div><div><img src=""alt=""id="promo_img_ico_gif"></div></div></div></div></div></div></div><br><br><div class="xLinea2"></div><br><br><div class="w-100"><div><div><p class="fs-16">Lista<p class="text-secondary">Agregue las secciones o items de la carta, o productos de bodega que forman parte de la promoción.</div></div><br><h4 hidden$="[[ !isShowNxN ]]">2x1 o 3x2 solo aplica a productos o items.</h4><table width="100%"><thead><th>Tipo<th>Producto / Item / Seccion<th hidden$="[[ !isShowProductoItem ]]"><span hidden$="[[ isShowNxN ]]">Cantidad</span> <span hidden$="[[ !isShowNxN ]]">Lleva</span><th hidden$="[[ !isShowNxN ]]">Solo Paga x<th hidden$="[[ !isShowProductoItem ]]">Precio<th>% Desct<th hidden$="[[ !isShowProductoItem ]]">P. Final<th aling="right"><tbody><tr><td width="8%"><select class="selected-template-1"onchange="selectedTipo(this)"><option value="0">Item / Producto<option value="2"hidden$="[[ isShowNxN ]]">Sección</select><td width="45%"><div hidden$="[[ !isShowProductoItem ]]"><x-comp-find-item-producto clasecss="selected-template-1 w-100"id="compItemProducto"></x-comp-find-item-producto></div><div hidden$="[[ isShowProductoItem ]]"><x-comp-find-seccion clasecss="selected-template-1 w-100"id="compFindSeccion"></x-comp-find-seccion></div><td hidden$="[[ !isShowProductoItem ]]"><select id="sel_cant"class="selected-template-1"><option value="0"hidden$="[[ isShowNxN ]]">Todos<option value="1">1<option value="2">2<option value="3">3<option value="4">4<option value="5">5<option value="6">6<option value="7">7<option value="8">8<option value="9">9<option value="10">10</select><td hidden$="[[ !isShowNxN ]]"><select id="sel_cant_x"class="selected-template-1"><option value="1">1<option value="2">2<option value="3">3<option value="4">4<option value="5">5</select><td hidden$="[[ !isShowProductoItem || !isShowNxN]]"><p>{{ itemProductoSeleted.precio }}<td width="10%"><input type="number"class="selected-template-1"id="imp_desct"onkeyup="precioFinalProductoItem()"><td hidden$="[[ !isShowProductoItem ]]"><p>{{ precioFinal }}<td aling="right"><button class="btn btn-sm btn-info"onclick="addListDescuentoItem()">+</button></tr><template is="dom-repeat"items="{{listItemsDescuento}}"as="item"><tr data-id="[[index]]"><td>{{ item.tipo }}<td>{{ item.descripcion }}<td hidden$="[[ !isShowProductoItem ]]">{{ item.elementCantidadShow }}<td hidden$="[[ !isShowNxN ]]">{{ item.cantidad_x }}<td hidden$="[[ !isShowProductoItem ]]">{{ item.precio }}<td>{{ item.porc_descuento }}%<td hidden$="[[ !isShowProductoItem ]]">{{ item.precio_final }}<td><span class="xDeleteRow ml-2"title="Anular"onclick="removeItemListPromo(this)"></span></template></table><div hidden$="[[ !isShowError ]]"class="animate__animated animate__shakeX"><p class="fw-600 text-danger">{{ isShowMsjError }}</div></div><br><br><br><br><x-comp-button-succes id="btnSucces"disabled$="[[!isFormValid]]"loader="{{isShowLoaderSave}}"></x-comp-button-succes><button class="btn btn-secondary ml-2"onclick="backListPromo()">Atras</button><br><br><br><br></div></div></div><br><br></template></dom-module><style>.conent-grid-two{width:100%;display:grid;grid-gap:1rem;margin:0 auto;grid-template-columns:1fr 1fr}.div-child{max-width:360px}.div-content-img{display:flex;flex-wrap:wrap;max-width:560px;margin-bottom:20px}.div-content-img img{padding-right:10px;margin:auto}</style><script>var xThisProm,btnSucces,compItemProducto,compFindSeccion,compImgPromo,tipoElementId=0,tipoElementNom="Item",_listItemsDescuento=[],diasSemana="",idPromoSelected=0,firstIconGif="";function xIniPromociones(){xThisProm.medidaImg={width:350,height:180},xThisProm.isShowListaPromo=!0,xLoadListaPromocion(),xLoadDataPromociones(),xloadGifPromo(),(btnSucces=document.getElementById("btnSucces")).addEventListener("onclix",()=>{guardarPromo()}),(compItemProducto=document.getElementById("compItemProducto")).addEventListener("elementSeleted",o=>{xThisProm.itemProductoSeleted=o.detail||null,precioFinalProductoItem()}),compFindSeccion=document.getElementById("compFindSeccion"),compImgPromo=document.getElementById("compImgPromo"),$(".check_dia").on("change",()=>{diasSemana="",$(".check_dia").each((o,e)=>{diasSemana+=e.checked?o.toString()+",":""})}),_listItemsDescuento=[],xThisProm.isFormValid=!1}function xLoadListaPromocion(){$.ajax({type:"POST",url:"../../bdphp/log_009.php?op=5"}).done(o=>{o=JSON.parse(o).datos;xThisProm.listPromos=o,selectOptionPromoIni()})}function selectOptionPromoIni(){xThisProm.promoSeleted=xThisProm.listPromos[0]}function selectOptionPromo(){var o=xThisProm.$.select_promo.value;xThisProm.promoSeleted=xThisProm.listPromos[o],div_num_primeros_pedidos.hidden=!1,div_importe_consumo_min.hidden=!1,xThisProm.isShowNxN=!1,"1"===xThisProm.promoSeleted.nxn&&(div_num_primeros_pedidos.hidden=!0,div_importe_consumo_min.hidden=!0,xThisProm.isShowNxN=!0)}function selectedTipo(o){tipoElementId=o.value,tipoElementNom=o[o.selectedIndex].text,xThisProm.isShowProductoItem="2"!==o.value,newLista()}function precioFinalProductoItem(){var o,e=isNaN(parseFloat(imp_desct.value))?0:parseFloat(imp_desct.value);xThisProm.itemProductoSeleted&&xThisProm.isShowProductoItem?(o=parseFloat(xThisProm.itemProductoSeleted.precio),xThisProm.precioFinal=(o-o*(e/100)).toFixed(2)):(xThisProm.precioFinal=0,xThisProm.itemProductoSeleted=null)}function addListDescuentoItem(){var o=xThisProm.itemProductoSeleted,e=xThisProm.isShowProductoItem?null:compFindSeccion.getSeccion(),i=xThisProm.itemProductoSeleted?.label.split(" | ")||0;const t=e?e.descripcion:i[i.length-1];var i=e?0:xThisProm.itemProductoSeleted.precio,s="0"==o?.procede?o.iditem:null,m=s?o.iditem_subitem:null,r="1"==o?.procede?o.value:null,a=e?e.idseccion:null,n=sel_cant.value,d="1"===xThisProm.promoSeleted.nxn?sel_cant_x.value:null,c=(o||e).idimpresora;"1"===xThisProm.promoSeleted.nxn&&(xThisProm.isShowError=parseFloat(n)<parseFloat(d),xThisProm.isShowError)?xThisProm.isShowMsjError="La cantidad debe ser mayor a la cantidad x":(tipoElementNom=s?"Item":a?"Seccion":"Producto",_listItemsDescuento.filter(o=>o.elementDescripcion===t)[0]||(o={tipoId:tipoElementId,tipo:tipoElementNom,elementItem:o,elementSeccion:e,elementCantidadShow:"0"==n?"Todos":n,precio:i,precio_final:xThisProm.precioFinal,descripcion:t,cantidad_x:d,cantidad:n,porc_descuento:parseFloat(imp_desct.value),iditem:s,iditem_subitem:m,idproducto_stock:r,idseccion:a,idimpresora:c,is_nxn:!!d},_listItemsDescuento.push(o),xThisProm.listItemsDescuento=JSON.parse(JSON.stringify(_listItemsDescuento)),newRowItem(),xValidFormPromo()))}function newRowItem(){imp_desct.value=0,xThisProm.precioFinal=0}function newLista(){_listItemsDescuento=[],xThisProm.listItemsDescuento=JSON.parse(JSON.stringify(_listItemsDescuento))}function removeItemListPromo(o){o=o.parentNode.parentNode.dataId;const e=_listItemsDescuento[o];_listItemsDescuento=_listItemsDescuento.filter(o=>o.elementDescripcion!==e.elementDescripcion),xThisProm.listItemsDescuento=JSON.parse(JSON.stringify(_listItemsDescuento))}async function guardarPromo(){diasSemana="",$(".check_dia").each((o,e)=>{diasSemana+=e.checked?o.toString()+",":""});var o=f_ini.value,e=f_fin.value,i=h_ini.value,t=h_fin.value,s=num_primeros_pedidos.value,m=importe_consumo_min.value,r=compImgPromo.getIsEstablecioImg()?1:0,a="",e=(xThisProm.listItemsDescuento.map(o=>{o=(o.idimpresora||o.idimpresora)+",";a=-1<a.indexOf(o)?"":o}),{body:{f_fin:e,h_fin:t,f_inicio:o,h_inicio:i,solo_app:check_solo_app.checked?1:0,dias_semana:diasSemana,importe_consumo_min:0==m?null:m,num_primeros_pedidos:0==s?null:s},header:{titulo:titulo.value,descripcion:descripcion.value,establecio_img:r,icon:xThisProm.promoIcoGifSeleted}}),t={idpromocion:idPromoSelected,idpromocion_lista:xThisProm.promoSeleted.idpromocion_lista,idimpresoras:a,parametros:e,lista:xThisProm.listItemsDescuento,op:501};xValidFormPromo(),xThisProm.isFormValid&&(btnSucces.setLoader(!0),o=await(new httpFecht).postJson("../../bdphp/log_009.php",t),i="promo"+(idPromoSelected=o.respuesta),uploadImgPromo(compImgPromo.getImgBase64(),i),setTimeout(()=>{btnSucces.setSave(!0)},1e3))}function uploadImgPromo(o,e){$.ajax({type:"POST",url:"upload_base64.php?op=6",data:{nomfile:e,img:o}}).done(o=>{})}function xValidFormPromo(){xThisProm.isFormValid=""!==titulo.value,xThisProm.isFormValid&&(xThisProm.isFormValid=""!==descripcion.value,xThisProm.isFormValid)&&(xThisProm.isFormValid=""!==diasSemana,xThisProm.isFormValid)&&(xThisProm.isFormValid=""!==f_ini.value,xThisProm.isFormValid)&&(xThisProm.isFormValid=""!==f_fin.value,xThisProm.isFormValid)&&(xThisProm.isFormValid=""!==h_ini.value,xThisProm.isFormValid)&&(xThisProm.isFormValid=""!==h_fin.value,xThisProm.isFormValid)&&("1"===xThisProm.promoSeleted.nxn&&(xThisProm.isShowError=parseFloat(sel_cant.value)<parseFloat(sel_cant_x.value),xThisProm.isFormValid=xThisProm.isShowError),xThisProm.isFormValid=0<xThisProm.listItemsDescuento.length)}function xLoadDataPromociones(){$.ajax({type:"POST",url:"../../bdphp/log_009.php?op=502"}).done(o=>{o=JSON.parse(o).datos;o.map(o=>{o.parametros=JSON.parse(o.parametros),o.check_activo="1"===o.activo}),xThisProm.dataPromociones=o})}function xDisabledPromo(o){var e=xGetIdPromo(o),o=o.checked?"1":"0";$.ajax({type:"POST",url:"../../bdphp/log_009.php?op=503",data:{id:e,estado:o}})}function xModificarPromo(o){xPopupLoad.xopen();const e=xGetIdPromo(o);var o=xThisProm.dataPromociones.find(o=>o.idpromocion===e);const i=o.parametros;xThisProm.medidaImg={width:350,height:180},idPromoSelected=e,titulo.value=i.header.titulo,descripcion.value=i.header.descripcion,xThisProm.promoIcoGifSeleted=i.header.icon||firstIconGif,setIcoGifPromo(),f_ini.value=i.body.f_inicio,f_fin.value=i.body.f_fin,h_ini.value=i.body.h_inicio,h_fin.value=i.body.h_fin,diasSemana="",$(".check_dia").each((o,e)=>{e.checked=-1<i.body.dias_semana.indexOf(o),diasSemana+=e.checked?o.toString()+",":""}),num_primeros_pedidos.value=i.body.num_primeros_pedidos||0,importe_consumo_min.value=i.body.importe_consumo_min||0,check_solo_app.checked=1===i.body.solo_app,1===i.header.establecio_img?(o=URL_IMG_PROMO+o.img,compImgPromo.setImgPathFile(o)):compImgPromo.resetControl(),$.ajax({type:"POST",url:"../../bdphp/log_009.php?op=504",data:{id:e}}).done(o=>{(_listItemsDescuento=JSON.parse(o).datos).map(o=>{o.elementCantidadShow="0"===o.cantidad?"Todos":o.cantidad}),xThisProm.listItemsDescuento=JSON.parse(JSON.stringify(_listItemsDescuento)),xThisProm.isFormValid=!0,xThisProm.isShowListaPromo=!1,xPopupLoad.xclose()})}function xGetIdPromo(o){return o.parentNode.parentNode.dataId}function xNewPromocion(){idPromoSelected=0,titulo.value="",descripcion.value="",f_ini.value="",f_fin.value="",h_ini.value="",h_fin.value="",$(".check_dia").each((o,e)=>{e.checked=!1}),_listItemsDescuento=[],xThisProm.listItemsDescuento=JSON.parse(JSON.stringify(_listItemsDescuento)),xThisProm.isFormValid=!1,num_primeros_pedidos.value=0,importe_consumo_min.value=0,check_solo_app.checked=!1,compImgPromo.resetControl(),xThisProm.isShowListaPromo=!1,xThisProm.medidaImg={width:350,height:180}}function backListPromo(){xThisProm.isShowListaPromo=!0,xLoadDataPromociones()}function xloadGifPromo(){$.ajax({type:"POST",url:"../../bdphp/log_009.php?op=505"}).done(o=>{xThisProm.listIconGif=JSON.parse(o).datos,xThisProm.listIconGif.map(o=>{o.path="../../images/"+o.img}),firstIconGif=xThisProm.listIconGif[0].img,xThisProm.promoIcoGifSeleted=firstIconGif,setIcoGifPromo()})}function selectOptionIcoGif(o){o=o.dataId;xThisProm.promoIcoGifSeleted=xThisProm.listIconGif[o].img,setIcoGifPromo(),dialog_img_gif_promo.close()}function setIcoGifPromo(){promo_img_ico_gif.src="../../images/"+xThisProm.promoIcoGifSeleted}Polymer({is:"x-promociones",properties:{listPromos:[],promoSeleted:[],promoIcoGifSeleted:String,itemProductoSeleted:[],seccionSeleted:[],listItemsDescuento:[],listIconGif:[],precioFinal:Number,isShowProductoItem:Boolean,isFormValid:Boolean,medidaImg:[],medidaContent:[],dataPromociones:[],isShowListaPromo:Boolean,isShowLoaderSave:Boolean,isShowNxN:Boolean,isShowError:Boolean,isShowMsjError:String},attached:function(){this.isShowProductoItem=!0,this.isFormValid=!1,this.listItemsDescuento=[],this.isShowListaPromo=!0,this.isShowLoaderSave=!1,this.isShowNxN=!1,this.isShowError=!1,xThisProm=this,xIniPromociones()}})</script>