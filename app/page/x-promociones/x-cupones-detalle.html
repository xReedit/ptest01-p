<dom-module id="x-cupones-detalle"><link rel="import"href="../../x-componentes/x-comp-find-item-producto/x-comp-find-item-producto.html"><link rel="import"href="../../x-componentes/x-comp-find-seccion/x-comp-find-seccion.html"><script src="../../view/httpFech.js"></script><template><style>.conent-grid-two{width:100%;display:grid;grid-gap:1rem;margin:0 auto;grid-template-columns:1fr 1fr}.div-child{max-width:360px}.div-content-img{display:flex;flex-wrap:wrap;max-width:560px;margin-bottom:20px}.div-content-img img{padding-right:10px;margin:auto}</style><br><div class="xMiCard xradius"style="width:94%;max-width:1300px"><div class="xEncanezadoCard"style="background:#fff0f5;color:#424242"><div class="d-flexx justify-content-between"><div><p class="fs-18 fw-600">Detalle del Cupon<p>Una vez que se registre la venta, los cupones se imprimirán automáticamente. Además, si proporcionas el número de teléfono del cliente, el cupón también se enviará de forma virtual al WhatsApp del cliente. De esta manera, el cliente puede recibir su cupón tanto en formato físico como digital.</div><div class="pl-4"><button class="btn btn-sm btn-secondary"on-click="close">Atras</button></div></div></div><div class="xLinea2"></div><br><div class="xContentCard"style="padding:20px"><div class="conent-grid-two"><div class="div-child"><p class="fw-600">Titulo</p><input class="selected-template-1 w-100"placeholder="Titulo"onchange="conMayusculas(this)"id="titulo"on-input="computeFormValid"required><br><br><p class="fw-600">Descripcion</p><textarea class="selected-template-1 w-100"maxlength="250"rows="4"id="descripcion"on-input="computeFormValid"required></textarea><br><br><div><label class="d-flexx align-items-start xCursor"><input type="radio"name="grupoOption"value="opcion1"checked$="[[isGeneracionAutomatica]]"on-change="handleOptionGeneracionChange"><div><p class="fw-600">Generación Automatica<p class="fw-100 text-secondary">Tras cada transacción de venta completada, el sistema generará automáticamente un código de cupón único.</div></label></div><div><label class="d-flexx align-items-start xCursor"><input type="radio"name="grupoOption"value="opcion2"on-change="handleOptionGeneracionChange"checked$="[[!isGeneracionAutomatica]]"><div><p class="fw-600">Generación Manual<p class="fw-100 text-secondary">El código de cupón se genera de forma manual.</div></label></div><br><br><div hidden$="[[isGeneracionAutomatica]]"><p class="fw-600">Ingresa el código del cupón<p class="fw-100 text-secondary">Por ejemplo: <strong>DIAPADRE</strong> o <strong>FIESTA-BLANCA</strong>. El código debe tener un minimo de 5 caracteres.</p><input onchange="conMayusculas(this)"on-input="computeFormValid"class="selected-template-1"id="codigo_cupon"placeholder="CÓDIGO DEL CUPÓN"maxlength="10"minlength="5"required></div></div><div class="div-child"><p class="fw-600">Fecha de Inicio</p><input type="date"on-input="computeFormValid"class="selected-template-1"id="fecha_inicio"required><br><br><p class="fw-600">Fecha de Fin</p><input type="date"on-input="computeFormValid"class="selected-template-1"id="fecha_fin"required><br><br><p class="fw-600">Fecha de lanzamiento<p class="text-secondary">Fecha a partir de la cual se empezarán a generar los cupones.</p><input type="date"on-input="computeFormValid"class="selected-template-1"id="fecha_inicio_emitir"required><br><br><p class="fw-600">Cantidad máxima de cupones a canjear<p class="fw-100 text-secondary">Establece el límite de cuántos cupones se pueden canjear. Si se establece en 0, todos los cupones generados pueden ser canjeados.</p><input type="number"on-input="computeFormValid"class="selected-template-1"id="cantidad_maxima"value="0"required><br><br><p class="fw-600">Importe mínimo<p class="fw-100 text-secondary">Importe mínimo de compra para emitir el cupon.</p><input type="number"on-input="computeFormValid"class="selected-template-1"id="importe_minimo"value="0"required><br><br><div><div class="form-check"><paper-checkbox id="chkSoloClientes"on-input="computeFormValid"class="form-check-input"><p class="fw-600">Solo para clientes</p></paper-checkbox><p class="fw-100 text-secondary">Si marcas esta casilla, el cupón solo se generará para los clientes que hayan proporcionado su número de DNI o RUC al momento de emitir la boleta o factura.</div></div><br><div><paper-checkbox id="chkNoImprimir"on-input="computeFormValid"class="form-check-input"><p class="fw-600">No Imprimir</p></paper-checkbox><p class="fw-100 text-secondary">Si marcas esta casilla, el cupon no se imprimirá.</div></div></div><br><br><div class="xLinea2"></div><br><br><div class="w-100"><div><div><p class="fs-16">Lista<p class="text-secondary">Agregue las secciones o items de la carta, o productos de bodega que forman parte de la promoción.</div></div><br><div><table class="w-100"><thead><th width="8%">Tipo<th width="45%">Producto / Item / Seccion<th width="8%">Tipo descuento<th width="8%">Descuento<th width="8%">Precio<th width="8%">Precio Decuento<th aling="right"><tbody><tr><td width="8%"><select class="selected-template-1"id="selTipoProducto"on-change="selTipo"><option value="0">Item / Producto<option value="2">Sección</select><td width="45%"><div hidden$="[[ !isShowProductoItem ]]"><x-comp-find-item-producto onlynomproducto=""on-selected="selCompProductoItem"clasecss="selected-template-1 w-100"id="compItemProductoCupon"></x-comp-find-item-producto></div><div hidden$="[[ isShowProductoItem ]]"><x-comp-find-seccion on-selected="selCompSeccion"clasecss="selected-template-1 w-100"id="compFindSeccionCupon"></x-comp-find-seccion></div><td><select class="selected-template-1"id="selTipoDescuento"on-change="selChangeTipoDescuento"><option value="0">PORCENTUAL<option value="1">FIJO</select><td width="8%"><input style="width:50px"type="number"class="selected-template-1"id="descuento"on-keyup="calcPrecioDescuento"on-change="calcPrecioDescuento"required><td width="8%"><input style="width:50px"type="number"disabled="disabled"class="selected-template-1"id="precio"required><td width="8%"><input style="width:50px"type="number"disabled="disabled"class="selected-template-1"id="precio_final"required><td aling="right"><button class="btn btn-sm btn-info"on-click="addDetalle">+</button></tr><template is="dom-repeat"items="{{listDetalle}}"><tr><td>{{item.descripcion_tipo}}<td>{{item.descripcion_producto}}<td>{{item.descripcion_tipo_descuento}}<td>{{item.descuento}}<td>{{item.precio}}<td>{{item.precio_final}}<td><button class="btn btn-sm btn-danger"on-click="removeItem">-</button></template></table></div></div><br><br><div class="xLinea2"></div><br><br><div><button class="btn btn-primary mr-2"on-click="saveCupon"disabled$="[[!isFormValid]]">Listo Guardar</button> <button class="btn btn-dark"on-click="close">Cancelar</button></div></div><br><br></div></template><script>Polymer({is:"x-cupones-detalle",properties:{listDetalle:{type:Object,notify:!0},showPrecio:{type:Boolean,value:!1},isShowProductoItem:{type:Boolean,value:!0},isFormValid:{type:Boolean,value:!1},idCuponModicar:{type:Number,value:0},isGeneracionAutomatica:{type:Boolean,value:!0}},computeFormValid:function(){let i=!0;return this.$.titulo.value||this.$.descripcion.value||this.$.importe_minimo.value||(i=!1),0==this.listDetalle.length&&(i=!1),this.$.fecha_inicio.value&&this.$.fecha_fin.value&&this.$.fecha_inicio_emitir.value||(i=!1),this.isGeneracionAutomatica||this.$.codigo_cupon.value||(i=!1),this.isFormValid=i,this.isFormValid},ready:function(){this.listDetalle=[],this.showPrecio=!1,this.isFormValid=!1,this.isGeneracionAutomatica=!0},selTipo:function(i){0==i.target.value?(this.showPrecio=!0,this.isShowProductoItem=!0):(this.showPrecio=!1,this.isShowProductoItem=!1),this.$.precio.value="",this.$.precio_final.value="",this.calcPrecioDescuento()},selChangeTipoDescuento:function(i){this.calcPrecioDescuento()},addDetalle:function(){var i={},e=this.$.selTipoProducto.value,t=this.$.compItemProductoCupon.getelementSeletedAlmacen(),o=this.$.compFindSeccionCupon.getSeccion(),c=this.$.descuento.value,a=this.$.precio.value,s=this.$.precio_final.value,l=this.$.selTipoDescuento.value;let n=null,u=null,h=null,p="SECCION",d="";"2"!==e?(n="0"==t.procede?t.iditem:null,h="1"==t.procede?t.iditem:null,p=n?"ITEM":"PRODUCTO",e=t.label.split("|"),d=e[e.length-1]):(d=o.descripcion,u=o.idseccion),i.descuento=c,i.precio=a,i.precio_final=s,i.tipo_descuento=l,i.descripcion_tipo_descuento=0==l?"PORCENTUAL":"FIJO",i.iditem=n,i.idproducto_stock=h,i.idseccion=u,i.descripcion_tipo=p,i.descripcion_producto=d.trim(),i.is_automatico=this.isGeneracionAutomatica?1:0,i.cantidad_maxima=this.$.cantidad_maxima.value,i.cupon_manual=this.$.codigo_cupon.value||"",this.listDetalle.push(i),this.listDetalle=[...this.listDetalle],this.computeFormValid()},removeItem:function(i){i=i.model.index;this.listDetalle.splice(i,1),this.listDetalle=[...this.listDetalle],this.computeFormValid()},selCompProductoItem:function(i){this.$.precio.value=i.detail.precio},selCompSeccion:function(i){this.$.precio.value=i.detail.precio,this.calcPrecioDescuento()},calcPrecioDescuento:function(){let i=this.$.descuento.value,e=this.$.precio.value,t=(i&&!isNaN(i)||(i=0),e&&!isNaN(e)||(e=0),i=Number(i),e=Number(e),0);(t=0==this.$.selTipoDescuento.value?(100<i&&(i=100,this.$.descuento.value=100),t=e-e*i/100,Math.round(100*t)/100):e-i)<0&&(t=0),this.$.precio_final.value=t},saveCupon:async function(){var i={titulo:this.$.titulo.value,descripcion:this.$.descripcion.value,fecha_inicio:this.$.fecha_inicio.value,fecha_fin:this.$.fecha_fin.value,fecha_inicio_emitir:this.$.fecha_inicio_emitir.value,cantidad_maxima:this.$.cantidad_maxima.value,importe_minimo:this.$.importe_minimo.value||0,is_automatico:this.isGeneracionAutomatica?1:0,cupon_manual:this.$.codigo_cupon.value,solo_clientes:this.$.chkSoloClientes.checked?1:0,no_imprimir:this.$.chkNoImprimir.checked?1:0,idcupon:this.idCuponModicar,listDetalle:this.listDetalle};await(new httpFecht).axiosExecuteJSON({url:"../../bdphp/log_009.php?op=60",method:"POST",data:i});this.fire("close")},close:function(){this.fire("close")},cuponModificar(i){this.idCuponModicar=i,this.loadDataCupon()},loadDataCupon:async function(){var i=await(new httpFecht).axiosExecuteJSON({url:"../../bdphp/log_009.php?op=6002",method:"POST",data:{idcupon:this.idCuponModicar}}),e=i.cupon[0],i=i.list;this.$.titulo.value=e.titulo,this.$.descripcion.value=e.descripcion,this.$.fecha_inicio.value=e.fecha_inicio,this.$.fecha_fin.value=e.fecha_termina,this.$.fecha_inicio_emitir.value=e.fecha_inicio_emitir,this.$.cantidad_maxima.value=e.cantidad_maxima,this.$.importe_minimo.value=e.importe_minimo,this.isGeneracionAutomatica="1"==e.is_automatico,this.$.codigo_cupon.value=e.cupon_manual,this.$.chkSoloClientes.checked="1"==e.solo_clientes,this.$.chkNoImprimir.checked="1"==e.no_imprimir,this.listDetalle=[],i.map(i=>{i={idcupon_detalle:i.idcupon_detalle,descuento:i.dsct,precio:i.precio,precio_final:i.precio_final,tipo_descuento:i.tipo_dsct,descripcion_tipo_descuento:"0"==i.tipo_dsct?"PORCENTUAL":"FIJO",iditem:i.iditem,idproducto_stock:i.idproducto_stock,idseccion:i.idseccion,descripcion_tipo:i.tipo,descripcion_producto:i.descripcion,cantidad_maxima:i.cantidad_maxima,is_automatico:i.is_automatico,cupon_manual:i.cupon_manual,no_imprimir:i.no_imprimir};this.listDetalle.push(i)}),this.listDetalle=[...this.listDetalle]},nuevoCupon(){this.idCuponModicar=0,this.$.titulo.value="",this.$.descripcion.value="",this.$.fecha_inicio.value="",this.$.fecha_fin.value="",this.$.fecha_inicio_emitir.value="",this.$.cantidad_maxima.value=0,this.$.importe_minimo.value=0,this.isGeneracionAutomatica=!0,this.$.codigo_cupon.value="",this.$.chkSoloClientes.checked=!1,this.$.chkNoImprimir.checked=!1,this.listDetalle=[],this.computeFormValid()},handleOptionGeneracionChange:function(i){this.isGeneracionAutomatica="opcion1"===i.target.value}})</script></dom-module>