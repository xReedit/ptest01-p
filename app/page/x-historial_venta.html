<link rel="import"href="../x-componentes/pagination-input/pagination-input.html"><link rel="import"href="../x-componentes/x-comp-meta-venta/x-comp-meta-venta.html"><link rel="import"href="../x-componentes/x-comp-dialog-send-cpe/x-comp-dialog-send-cpe.html"><dom-module id="x-historial_venta"><link rel="import"href="../x-componentes/x-comp-btn-permiso/x-comp-btn-permiso.html"><link rel="import"href="../x-componentes/x-comp-btn-permiso/x-comp-dialog-permiso.html"><link rel="import"href="../x-componentes/x-comp-anular-comprobante/x-comp-anular-comprobante.html"><link rel="import"href="../x-componentes/x-comp-handler-pinpad/x-comp-remove-operation-pinpad.html"><script async src="../services/pinpad.services.js"></script><script src="../view/socket.master.service.js"></script><script src="../view/socket.service.p.js"></script><script src="../view/export.excel.js"></script><link rel="stylesheet"href="../../css/searchableOptionList.css"><script src="../../js/searchableOptionList.js"></script><script async src="../view/httpFech.js"></script><script src="../view/notifica.js"></script><script src="../../js/PNotify.js"></script><script src="../../js/PNotifyConfirm.js"></script><script src="../../js/PNotifyHistory.js"></script><script async src="../../js/picket.js"></script><script async src="../../js/picket.date.js"></script><link rel="stylesheet"href="../../css/PNotifyBrightTheme.css"><script src="../../js/sweetalert2.js"></script><script src="../../js/mi.sweet.alert.js"></script><template><div class="xInvisible"><audio id="notificaLlamadoCliente"autobuffer preload="auto"><source src="../../sound/notifica-llamado.mp3"type="audio/mpeg"></audio></div><x-comp-anular-comprobante id="compAnularComprobante"></x-comp-anular-comprobante><x-comp-dialog-permiso></x-comp-dialog-permiso><x-comp-remove-operation-pinpad id="compRemoveOperationPinPad"></x-comp-remove-operation-pinpad><x-pass id="pass_us"titulo="Usuario autorizado"valor="Pe1"permisoremoto="false"></x-pass><paper-dialog id="dialog_motivo_anular_historial"class="dialog_redondo"style="min-width:320px"entry-animation="scale-up-animation"exit-animation="fade-out-animation"with-backdrop><div class="xContent"><h4>ANULAR</h4><h4 class="txt_anular_cambiar_mesa"></h4><br><h4>Indique el motivo de anulacion</h4><div><input class="xMiInput"placeholder="Motivo..."id="txt_motivo_anular"autofocus></div><br><br><button class="btn btn-primary"onclick="xOpenDialogAnularPedido()">Listo</button> <button class="btn btn-secondary"dialog-dismiss>Cancelar</button><br></div></paper-dialog><paper-dialog id="dialog_comprobante"style="min-width:320px"entry-animation="scale-up-animation"exit-animation="fade-out-animation"with-backdrop><div class="xContent"><x-pago id="component_pago"></x-pago></div></paper-dialog><paper-dialog id="dialog_registro_detalle"class="dialog_redondo"style="overflow:auto;overscroll-behavior:auto;min-width:50%;max-width:700px"entry-animation="scale-up-animation"exit-animation="fade-out-animation"with-backdrop><div class="mb-2"><div><div class="d-flexx justify-content-between align-items-center header-registro-venta"><div style="zoom:.9"><paper-button><div class="xMiBoton_icon_lateral2"style="margin-top:-15px;width:90px"onclick="xOpenAnularPedidoHistorial(this)"id="btn_anular_pedido_rp"><i class="fa fa-unlock text-success mr-1 punto-flotante-verde xInvisible"style="position:absolute"></i> <img src="../../images/_delete_pedido.png"><p>Anular Registro</div></paper-button><paper-button><div class="xMiBoton_icon_lateral2"style="margin-top:-15px;width:100px"onclick="xImprimirPrecuentaHistorial()"><img src="../../images/_pre_cuenta.png"><p>Imprimir pre-cuenta</div></paper-button><paper-button><div class="xMiBoton_icon_lateral2"style="margin-top:-15px;width:50px"onclick="xAbrirDialogComprobante()"><img src="../../images/_comprobante.png"><p>Emitir Comprobante</div></paper-button><paper-button hidden$="[[!xIsPuedeReimprimirCPE]]"><div class="xMiBoton_icon_lateral2"style="margin-top:-15px;width:50px"onclick="reImprimirComprobante()"><img src="../../images/_print_vr.png"><p>Reimprimir Comprobante</div></paper-button></div><button class="btn btn-sm btn-secondary ml-2"dialog-dismiss>X</button></div><br><label for="txt_comprobante"class="xfont10">Comprobante Emitido:</label><p><span id="txt_comprobante"class="xfont20">- </span><span id="txt_ref"class="xfont16 xColorRow_Morado xpadingLateralIz"></span><div class="xLinea2"></div><label for="txt_cliente"class="xfont10">Cliente:</label><p><span id="txt_cliente"class="xfont20">- </span><span id="txt_ref"class="xfont16 xColorRow_Morado xpadingLateralIz"></span><div class="xLinea2"></div><br><div class="x_div_linea"><div><label for="txt_mesa"class="xfont10">Mesa:</label><p id="txt_mesa"class="xfont20">00</div><div><label for="txt_mozo"class="xfont10">Atendido por:</label><p id="txt_mozo"class="xfont20"></div><div><label for="txt_tpc"class="xfont10">Tiempo de atencion:</label><p id="txt_tpc"class="xfont20"></div><div><label for="txt_cat"class="xfont10"></label><p id="txt_cat"class="xfont20">-</div></div><div class="xLinea2"></div><br><br><div id="xBody"></div><div style="float:right;text-align:right"hidden$="[[isHiddenOptionsPinPad]]"><h4>Opciones del pinpad</h4><div class="mb-3"><button hidden$="[[isHiddenOptionsPinPadBtnRemove]]"class="btn btn-sm btn-danger"onclick="xOpenDialogAnularOperacionPinPad()"><i class="fa fa-trash"></i> <span class="fs-12">Anular Operación</span></button> <button id="btnRePrintPinPad"class="btn btn-sm btn-warning"onclick="reemprimirPinpad()"><i class="fa fa-print"></i> <span class="fs-12">Reimprimir Voucher</span></button></div></div></div></div></paper-dialog><x-comp-dialog-send-cpe id="compDialogSendCPE_RP"></x-comp-dialog-send-cpe><div class="p-5"style="max-width:1200px!important;min-width:750px!important;margin:0 auto"><div class="d-flexx w-100 justify-content-between flex-wrap"><div><h3>Registro de Pagos</h3><p>Hora de cierre: <span id="info-hours-close"class="fw-600 text-primary">{{ horaCierre }}</span> <i class="xCursor fa fa-pencil"title="Modificar"onclick="showMsjChangeHoraClose()"></i></div><div class="div-info mb-1"><div class="div-border text-center p-2 mr-1 div-indicador"><p class="fs-12 fw-600 text-secondary">Meta Diaria</p><x-comp-meta-venta fontsize="fs-25"></x-comp-meta-venta></div><div class="div-border text-center p-2 mr-1 div-indicador"style="max-width:150px"><p class="fs-12 fw-600 text-secondary">Metodos de Pago<div class="d-flexx justify-content-center flex-wrap"><template is="dom-repeat"items="{{listCantidadPagos}}"as="item"><div><p class="fs-11 pr-2 m-0 fw-600">{{item.id}}: <span class="fw-900 text-primary">{{item.cantidad}}</span></div></template></div></div><div class="div-border text-center p-2 mr-1 div-indicador"style="max-width:80px"><p class="fs-12 fw-600 text-secondary">Comprobantes Emitidos<p class="fw-600 fs-15">{{ numComprobantesEmitidos }}</div><div class="div-border text-center p-2 div-indicador"><p class="fs-12 fw-600 text-secondary">Importe Total<p class="fw-600 fs-25 text-primary">S/. {{ importeTotalRegistrado }}</div></div></div><div class="div-border div-filter"><div><p class="fw-900">Ver Desde</p><input style="height:20px"class="selected-template-1 xCursor"id="txt_fecha"placeholder="Elige fecha"></div><div style="width:95%"><p class="fw-900">Filtro<div class="content-div-filtro"><select class="js-select2-rp selected-template-1"id="seletecFilter"multiple="multiple"><optgroup label="Cobrado Por"><template is="dom-repeat"items="{{listCobradoPorFilter}}"as="item"><option value$="[[item]]">{{item.us_caja}}</template><optgroup label="Canal de Consumo"><template is="dom-repeat"items="{{listCanalConsumoFilter}}"as="item"><option value$="[[item]]">{{item.descripcion}}</template><optgroup label="Tipo de Comprobante"><template is="dom-repeat"items="{{listTipoComprobanteFilter}}"as="item"><option value$="[[item]]">{{item.descripcion}}</template><optgroup label="Tipo de Pago"><template is="dom-repeat"items="{{listMetodoPagoFilter}}"as="item"><option value$="[[item]]">{{item.descripcion}}</template></select></div></div><div><p class="fw-900">Buscar</p><input style="height:20px"placeholder="Indique criterio a buscar..."class="selected-template-1 w-100"onkeyup="buscarEnListaRegistroPagos(this.value)"></div></div><table class="w-100 content-table-delivery"><thead><th align="left"colspan="8"><span class="text-primary fw-600 fs-15">[[cantRegistroPagos]]</span> Registros encontrados<th align="right"><div class="dropdown"><button class="btn btn-sm btn-success"><i class="fa fa-file-excel-o"></i> Exportar <i class="fa fa-angle-down"></i></button><div class="dropdown-content"><a href="#"onclick="xGenerarReporteExcelRegistroPago()">Resumen</a> <a href="#"onclick="xGenerarReporteExcelRegistroPagoDetallado()">Detallado</a></div></div></thead><thead style="height:50px"><th>#<th align="left">Fecha<th align="center">Cobrado Por<th align="left">Canal<th align="left">Atendido Por<th align="left">Cliente<th width="85px"><th align="right"width="50px"><th align="center"style="min-width:130px">Importe<tbody><template is="dom-repeat"items="[[listRegistroPagoFilter]]"as="item"><tr class$="[[ item.row_calss ]]"><td><span class="fw-600 mr-1">{{item.num}} </span><i class="fa fa-lock"hidden$="[[!item.isCierre]]"></i><td><p class="fs-11">{{ item.fecha_des }}<p class="fs-11">{{ item.hora }}<td align="center"><p class="fs-11 fw-900"style$="[[item.us_caja_class_color]]">{{ item.us_caja }}<td><p class$="[[item.class_tpc]]">{{ item.des_consumo }}<p class="badge badge-secondary fs-12"hidden$="[[ item.isDelivery ]]">{{ item.mesa }}<div class="d-flexx"style="max-width:120px"><p class="badge badge-success mr-2"hidden$="[[ !item.isScanCodigo ]]">App<p class="fs-10 fw-600">{{ item.correlativo_dia }}</div><td><div style="max-width:130px"><p class="fs-11">{{ item.nom_usuario_show }}</div><td><div style="max-width:125px"><p class="fs-10 fw-600">{{ item.nom_cliente }}<p class="fs-10 fw-600">{{ item.referencia_pedido }}</div><td align="center"><div hidden$="[[!item.isShowComprobante]]"><p class="fs-10 fw-600 m-0">{{ item.des_comprobante }} {{ item.num_comprobante }}</p><button class="btn btn-sm fs-10 btn-flat sky mt-1 d-flexx"data-id="[[item.idregistro_pago]]"onclick="xRegistroPagoReenviarComprobante(this)"><i class="fa fa-whatsapp"></i> Reenviar</button></div><td align="right"><div class="d-flexx justify-content-end"><template is="dom-repeat"items="[[item.listIconsPago]]"as="icon"><img width="18px"class="mr-1"src$="{{ icon.icon }}"alt=""></template></div><td align="right"><div class="d-flexx justify-content-end"><p class="fw-600 text-info fs-15">S/. {{ item.total }}</p><button class="xBoton_flat_2 xCursor ml-2"onclick="xloadDetallePago(this)"data-id="{{index}}">Ver</button></div></template></table></div><br><div class="xInvisible"><table width="100%"id="tbRegistroPago"><thead><th>#<th>Fecha<th>Hora<th>Cobrado Por<th>Canal<th>Atendido Por<th>Cliente<th>Comprobante<th>Productos<th>T. Pago<th align="right"style="min-width:100px">importe<th>Estado<tbody><template is="dom-repeat"items="[[listRegistroPagoFilter]]"as="item"><tr><td>{{item.num}}<td>{{item.fecha_des}}<td>{{item.hora}}<td>{{item.us_caja}}<td>{{item.des_consumo}}<td>{{item.nom_usuario_show}}<td>{{item.nom_cliente}}<td>{{item.des_comprobante}}<td><table><template is="dom-repeat"items="[[item.list_productos]]"as="prod"><tr><td>{{prod.cantidad}}<td>{{prod.item}}<td>{{prod.total}}<td>{{prod.impresora}}</template></table><td><div class="d-flexx"><table><template is="dom-repeat"items="[[item.listDesPago]]"as="tpc"><tr><td>{{tpc.descripcion}}<td>{{ tpc.importe }}</template></table></div><td>S/. {{ item.total }}<td><p>{{item.des_estado}}</template></table></div><div class="xInvisible"><table width="100%"id="tbRegistroPagoDetalle"><thead><th>#<th>Fecha<th>Hora<th>Caja<th>Canal<th>Mesa<th>Atendido Por<th>Cliente<th>Referencia<th>Tipo Doc<th>Serie<th>Num Doc<th>Producto<th>Producto Referencia<th>Cantidad<th>Precio Und<th>Total<th>Seccion<th>Area<th>Estado<tbody id="tbodyRegistroPagoDetalle"><template is="dom-repeat"items="[[listRegistroPagoExportDetallado]]"as="item"><tr><td>{{item.num}}<td>{{item.fecha_des}}<td>{{item.hora}}<td>{{item.us_caja}}<td>{{item.des_consumo}}<td>{{item.nummesa}}<td>{{item.nom_usuario_show}}<td>{{item.nom_cliente}}<td>{{item.referencia_pedido}}<td>{{item.des_comprobante}}<td>{{item.comprobante_serie}}<td>{{item.comprobante_num}}<td>{{item.producto_descripcion}}<td>{{item.producto_referencia}}<td>{{item.producto_cant}}<td>{{item.producto_punitario}}<td>{{item.producto_total_r}}<td>{{item.producto_seccion}}<td>{{item.producto_impresora}}<td>{{item.des_estado}}</td><template is="dom-repeat"items="{{item.dynamicColumn}}"as="subitem"><td>{{ subitem }}</template></template></table></div><br><br></template><style>.div-dato-registro{border-radius:8px;background:#fff;padding:5px 15px 5px 15px;text-align:center;border:1px solid #bdbdbd;margin-left:10px}.row-anulado{background:#ffe8f0;text-decoration:line-through;color:red}.div-correlativo{inline-size:230px;overflow-wrap:break-word}.header-registro-venta{background:#d4d4d4;padding:20px 25px 10px;margin-top:-32px;margin-right:-32px;margin-left:-32px}.bg-delivery{background-color:#f8f6c2}.bg-llevar{background-color:#81fad3}.bg-mesa{background-color:#46d9f2}.div-indicador{display:flex;flex-direction:column;justify-content:center}</style><script src="../view/xJsonSunat.js"></script><script src="../view/deNumALetras.js"></script><script src="../view/item_pedido_estructura.js"></script><script src="../view/item_pedido_print_comprobante.js"></script><script src="../view/cpe_interno.js"></script><script src="../view/item_pedido_subtotales.js"></script><style>.verIconFacturado img{visibility:hidden}.btn-row-delivery{border:0;border-radius:5px;color:#fff;cursor:pointer;font-size:11px}.bg-papaya{background:#571c86;color:#fff}.btn-flat{opacity:.8}.btn-flat.blue{background:#d0e6f0;border:solid 1px #81d4fa}.btn-flat.green{background:#bfefc1;border:solid 1px #81fa8a}.btn-flat.sky{background:#b1eef8;border:solid 1px #46d9f2}.btn-flat.red{background:#f8c2c2;border:solid 1px #e66060}.btn-flat:hover{opacity:1}.content-table-delivery{padding:15px 0;background:#fff;border-radius:8px;border:1px solid #e0e0e0}.content-table-delivery tr>td{border-bottom:8px solid #e5e5e7}.container-list{border:2px solid #ccc;width:300px;height:auto;overflow-y:scroll;background:#fff}.sol-container{display:flex!important}.div-border{background:#fff;border-radius:8px;border:1px solid #e0e0e0}.div-filter{display:grid;grid-template-columns:1fr 3fr 3fr;column-gap:30px;padding:20px;margin-bottom:10px;align-items:center}.div-info{display:flex;justify-content:flex-end}</style><script>var xThisHistVenta,xTotalItemSel,xidregistro_pago_sel,xDtPrint,xPSupervisor,index_historial,x_icon_facturado,xdt_pdE,listRegistroMaster,xfecha_historial="",xArrayTpC=[],xArraySeccion_r=[],xArrayDtOrdenFiltro=[],xEstado_registro_pago=0,xhtml_anulado="",xdt_h=[],arrSumSubtTotales=[],xRpt_pago=[],data_pagination={},p_rows=0,p_fecha="";function xIniHistVenta(){xPopupLoad=document.getElementById("xLoad"),x_icon_facturado='<img src="../../images/_comprobante.png" title="se emitio comprobante" width="16px">',xm_LogChequea(function(){xm_log_get("ini_us"),$("#Titulo_page").text("Registro de pagos"),$("body").addClass("loaded"),xDtPrint=xm_log_get("sede_generales"),xloadHistorial()}),$("#txt_fecha").pickadate({format:"dd mmmm, yyyy",today:"Hoy",clear:"Borrar",close:"Cerrar",onSet:function(e){xfecha_historial=e.select?xDevolverFechaDada2(e.select):"",p_fecha=xfecha_historial,xloadHistorial()}}),$(".js-select2-rp").select2({placeholder:"Aplicar Filtro",allowHtml:!0,allowClear:!0,tags:!0,width:"100%"}),$(".js-select2-rp").on("change",e=>{xRegistroPagoListFilter([...e.target.selectedOptions].map(e=>JSON.parse(e.value)))}),$("#dialog_motivo_anular_historial").on("iron-overlay-closed",function(){$("#txt_motivo_anular").focus()}),$("#dialog_motivo_anular_historial #txt_motivo_anular").keyup(function(e){13==e.keyCode&&(dialog_motivo_anular_historial.close(),xOpenDialogAnularPedido())}),(xPSupervisor=document.getElementById("pass_us")).setVal("Pe1"),xPSupervisor.addEventListener("xSend",function(e){if(1===e.detail.xRpts[0].p)switch(xPermisoSupervisor=e.detail.xRpts[0].us,xThisHistVenta.opPermisoPass){case 0:xAnularPedidoHistorial();break;case 1:xShowChangeMetodoPagoRegistro();break;case 2:xShowAnularOperacionPinPad()}}),(xValPago=document.getElementById("component_pago")).addEventListener("xSend",function(e){xRpt_pago=e.detail.xRpts,0!=e.detail.xRpts[0].ok&&1==e.detail.xRpts[0].paseEnterTxt&&xRegistrarClientePagoCP()}),xValPago.addEventListener("xCancelarCerrar",function(e){xThisHistVenta.$.dialog_comprobante.close()}),xValPago.addEventListener("xListoRegistraPago",function(e){xMandarCocinarImpresionComprobante_historial()}),xValPago.addEventListener("xSelectTipoComprobante",function(e){dialog_comprobante.center()}),xValPago.addEventListener("xFormClienteValid",function(e){dialog_comprobante.center()}),$(document).on("getValorIncial",".tpf_option_change_rgister",function(e){xThisHistVenta.idTpSelected=e.detail.values}),document.getElementById("compAnularComprobante").addEventListener("onAnularComprobante",function(e){xThisHistVenta.$.dialog_comprobante.open(),xm_all_xToastOpen("Se anulo el comprobante correctamente")})}function openAnularComp(){document.getElementById("compAnularComprobante").open(xdt_pdE.idce)}function xOpenDialogAnularPedido(){xThisHistVenta.opPermisoPass=0,xPSupervisor.solicitarPermisoRemoto(!0),pass_us.open()}function xOpenDialogAnularOperacionPinPad(){xThisHistVenta.opPermisoPass=2,xPSupervisor.solicitarPermisoRemoto(!1),pass_us.open()}async function xAbrirDialogComprobante(){var e;!1!==xThisHistVenta.xYaTieneComprobante?((e=paramsSwalAlert).title='<p class="fw-600 fs-18">Atención!</p>',e.html=`<div class="pb-2" style="display: inline-flex;">                    
                                    <p class="mt-1 fs-18">Ya existe un comprobante emitido por esta venta. ¿Que desea hacer?</p>
                                </div>`,e.confirmButtonText="Emitir Nuevo",e.denyButtonText="Emitir y Eliminar Anterior",e.showDenyButton=!0,e.showCancelButton=!0,(e=await showAlertSwalHtmlDecision(e)).isConfirmed&&xThisHistVenta.$.dialog_comprobante.open(),e.isDenied&&openAnularComp()):xThisHistVenta.$.dialog_comprobante.open()}async function xOpenAnularPedidoHistorial(){var e;xThisHistVenta.listRegistroPagoFilter.find(e=>e.idregistro_pago===xidregistro_pago_sel).showRemove?(e=await getFindRowStorageSolicudPermisoRemota(5,"idregistro_pago",xidregistro_pago_sel),xPermisoSupervisor=e.data.idusuario_admin,xAnularPedidoHistorial()):(xGetArraySolicitudRemotoAnularPedido(),dialog_motivo_anular_historial.open())}function xGetArraySolicitudRemotoAnularPedido(){var{idpedidos:e,numPedidosRegistro:o}=getIdPedidosRegistroPago();xCompArraySolitaPermiso={tipo_permiso:5,obj:{idregistro_pago:xidregistro_pago_sel,motivo:$("#txt_motivo_anular").val(),importe:xTotalItemSel,idpedidos:e,numpedidos:o,tipoconsumo:xdt_h[0].des_consumo},motivo:$("#txt_motivo_anular").val(),importe:xTotalItemSel,idpedidos:e,numpedidos:o,tipoconsumo:xdt_h[0].des_consumo}}function getIdPedidosRegistroPago(){let t=new Set;$("#tb_det_pedidos .row").each(function(e,o){t.add($(o).attr("data-idpedido"))});var e=t.size;t=Array.from(t).join(",");let o=[];try{o=listRegistroMaster.filter(e=>e.idregistro_pago===xidregistro_pago_sel).flatMap(e=>e.list_productos.map(e=>e.idpedido_detalle))}catch(e){}var i=o.join(",");return{idpedidos:t,numPedidosRegistro:e,idpedidosDetalles:i}}async function xAnularPedidoHistorial(){var{idpedidos:e,numPedidosRegistro:o,idpedidosDetalles:t}=getIdPedidosRegistroPago(),e=xGetItemFromPedidosAnular("#tb_det_pedidos",e);let i=0;var a=await showMsjRecuperarStock();a.isDismissed||(a.isConfirmed&&(i=1),xPopupLoad.xopen(),$.ajax({type:"POST",url:"../../bdphp/log.php?op=5011",data:{ArrayPeAnular:e,numpedidos:o,xMotivo:$("#txt_motivo_anular").val(),u:xPermisoSupervisor,viene_historial:xidregistro_pago_sel,xisRecuperarStock:i,idregistro_pago:xidregistro_pago_sel,idpedidosDetalles:t}}).done(function(e){xPopupLoad.xclose(),$(".xMiBoton_icon_lateral").attr("disabled",!0),xloadHistorial(),dialog_registro_detalle.close()}))}function xloadHistorial(){xPopupLoad.titulo="Cargando...",xPopupLoad.xopen();(new httpFecht).axiosExecuteJSON({type:"GET",url:"../../bdphp/api.php?route=get-hours-clouse"}).then(e=>{if(e.success)try{xThisHistVenta.horaCierre=e.data[0].hora_cierre_dia}catch(e){xThisHistVenta.horaCierre="00:00"}}),data_pagination.pageFecha=""!==p_fecha?p_fecha:xDevolverFecha();$.ajax({type:"POST",url:"../../bdphp/log.php?op=20001",data:{pagination:data_pagination}}).done(function(e){e=JSON.parse(e);var s=(xdt_h=e.datos).length+1||0,r=[],n=0,d=0;xThisHistVenta.listCobradoPorFilter=[],xThisHistVenta.listCanalConsumoFilter=[],xThisHistVenta.listAtendidoPorFilter=[],xThisHistVenta.listTipoComprobanteFilter=[],xThisHistVenta.listMetodoPagoFilter=[],xdt_h.map((o,e)=>{var t=o.fecha.split(" ");let i=[],a=[];o.isFacturaEmitido=null!==o.idce,o.isPedidoApp=1===parseInt(o.app),o.isScanCodigo=0!==parseInt(o.scan_qr),o.isCierre=0!==parseInt(o.cierre),o.icon_pago.split(",").map(e=>{i.push({icon:"../../images/"+e,id:e})}),o.des_pago.split(",").map(e=>{e=e.split("-");a.push({descripcion:e[0],importe:e[1]})}),o.listIconsPago=i,o.listDesPago=a,o.referencia_pedido=o.referencia_pedido===o.nom_cliente?"":o.referencia_pedido,o.fecha_des=t[0],o.hora=t[1],o.des_comprobante=""===o.comprobante?"":"B"===o.comprobante?"Boleta":"Factura",o.isShowComprobante=""!==o.des_comprobante,o.num_comprobante="",o.isShowComprobante&&(o.num_comprobante=o.numero.split("-"),o.num_comprobante=o.num_comprobante[0]+"-"+o.num_comprobante[1].replace(/^0+/,"")),o.mesa="0"===o.nummesa?"":"Mesa "+o.nummesa,o.list_productos=o.list_productos?JSON.parse(o.list_productos):[],o.des_pago.split(",").map(e=>{const o=e.split("-")[0];var e=0===r.length?null:r.filter(e=>e.id.toLowerCase()===o.toLowerCase())[0];e?e.cantidad++:(e={id:primeraConMayusculas(o.toLowerCase()),cantidad:1},r.push(e))}),o.anulado="1"===o.estado,o.des_estado=o.anulado?"Anulado":"Cobrado",o.row_calss=o.anulado?"row-anulado":"",o.charbusqueda+=o.anulado?"anulado, borrado, eliminado":"",o.isDelivery="DELIVERY"===o.des_consumo,o.des_consumo="CONSUMIR EN EL LOCAL"===o.des_consumo?"EN LOCAL":o.des_consumo,o.class_tpc="DELIVERY"===o.des_consumo?"bg-delivery":"PARA LLEVAR"===o.des_consumo?"bg-llevar":"bg-mesa",o.class_tpc="badge fs-12 "+o.class_tpc,o.showRemove="1"==o.permission_delete;t=o.anulado?0:parseFloat(o.total);n+=t,d+=""!==o.comprobante?1:0,o.us_caja=o.us_caja.split(" ")[0],o.correlativo_dia=o.correlativo_dia.split(","),o.correlativo_dia=o.correlativo_dia.join(" - ");var t=(t=o.nom_usuario.split(",")).map(e=>e.split(" ")[0]),t=(o.nom_usuario=t.join(","),o.nom_usuario_show=o.nom_usuario.split(","),o.nom_usuario_show=o.nom_usuario_show.join(" - "),xColorAleatorioRegistroPagos(o.us_caja)),t=(o.us_caja_class_color=`color: ${t};`,xThisHistVenta.listCobradoPorFilter.find(e=>e.id_us_caja===o.id_us_caja)),t=(t||(t={id_us_caja:o.id_us_caja,us_caja:o.us_caja,key:"id_us_caja",value:o.id_us_caja},xThisHistVenta.listCobradoPorFilter.push(t)),xThisHistVenta.listCanalConsumoFilter.find(e=>e.idtipo_consumo===o.idtipo_consumo));t||(t={idtipo_consumo:o.idtipo_consumo,descripcion:o.des_consumo,key:"idtipo_consumo",value:o.idtipo_consumo},xThisHistVenta.listCanalConsumoFilter.push(t)),o.isShowComprobante&&!xThisHistVenta.listTipoComprobanteFilter.find(e=>e.descripcion.toUpperCase()===o.des_comprobante.toUpperCase())&&(t={descripcion:o.des_comprobante.toUpperCase(),key:"des_comprobante",value:o.des_comprobante},xThisHistVenta.listTipoComprobanteFilter.push(t)),o.listDesPago.map(o=>{var e;xThisHistVenta.listMetodoPagoFilter.find(e=>e.descripcion.toUpperCase()===o.descripcion.toUpperCase())||(e={descripcion:o.descripcion.toUpperCase(),key:"des_pago",value:o.descripcion},xThisHistVenta.listMetodoPagoFilter.push(e))}),xThisHistVenta.listAtendidoPorFilter.find(e=>e.nom_usuario===o.nom_usuario);s--,o.num=xCeroIzq(s),o.charbusqueda=`${o.nom_usuario} ${o.correlativo_dia} ${o.des_pago} ${o.des_consumo} ${o.nom_cliente} ${o.referencia_pedido} ${o.total} ${o.des_comprobante} ${o.num_comprobante} ${o.repartidor} `+o.mesa,o.charbusqueda=o.charbusqueda.toLowerCase()}),xThisHistVenta.listRegistroPagoMaster=JSON.parse(JSON.stringify(xdt_h)),xThisHistVenta.listRegistroPagoFilter=xThisHistVenta.listRegistroPagoMaster,xThisHistVenta.listRegistroPagoFilterTmp=xThisHistVenta.listRegistroPagoFilter,xThisHistVenta.listCobradoPorFilter=JSON.parse(JSON.stringify(xThisHistVenta.listCobradoPorFilter)),xThisHistVenta.listCanalConsumoFilter=JSON.parse(JSON.stringify(xThisHistVenta.listCanalConsumoFilter)),xThisHistVenta.listTipoComprobanteFilter=JSON.parse(JSON.stringify(xThisHistVenta.listTipoComprobanteFilter)),xThisHistVenta.listMetodoPagoFilter=JSON.parse(JSON.stringify(xThisHistVenta.listMetodoPagoFilter)),listRegistroMaster=xdt_h,xThisHistVenta.listCantidadPagos=r,xThisHistVenta.importeTotalRegistrado=numeroConComas(n.toFixed(2)),xThisHistVenta.numComprobantesEmitidos=xCeroIzq(d,2),xThisHistVenta.cantRegistroPagos=xThisHistVenta.listRegistroPagoFilter.length,xPopupLoad.xclose()})}function xRegistroPagoListFilter(e){var o=xThisHistVenta.listRegistroPagoMaster;e.map(e=>{o=xRegistroPagoFilterByCodes(o,e.key,e.value)}),xThisHistVenta.listRegistroPagoFilter=JSON.parse(JSON.stringify(o)),xThisHistVenta.listRegistroPagoFilterTmp=xThisHistVenta.listRegistroPagoFilter,xResumenRegistroPagoTotales()}function xRegistroPagoFilterByCodes(e,o,t){return e.filter(e=>e[o].includes(t))}function xResumenRegistroPagoTotales(){var t=xThisHistVenta.listRegistroPagoFilter.length+1||0,i=0,a=0,s=[];xThisHistVenta.listRegistroPagoFilter.map(e=>{t--,e.num=xCeroIzq(t),e.des_pago.split(",").map(e=>{const o=e.split("-")[0];var e=0===s.length?null:s.filter(e=>e.id.toLowerCase()===o.toLowerCase())[0];e?e.cantidad++:(e={id:primeraConMayusculas(o.toLowerCase()),cantidad:1},s.push(e))});var o=e.anulado?0:parseFloat(e.total);i+=o,a+=""!==e.comprobante?1:0}),xThisHistVenta.listCantidadPagos=s,xThisHistVenta.importeTotalRegistrado=numeroConComas(i.toFixed(2)),xThisHistVenta.numComprobantesEmitidos=xCeroIzq(a,2),xThisHistVenta.cantRegistroPagos=xThisHistVenta.listRegistroPagoFilter.length}function xColorAleatorioRegistroPagos(e){e=e.split(" ");return["#f44336","#e91e63","#9c27b0","#673ab7","#3f51b5","#2196f3","#03a9f4","#00bcd4","#009688","#4caf50","#8bc34a","#cddc39","#ffeb3b","#ffc107","#ff9800","#ff5722","#795548","#9e9e9e","#607d8b"][(e[0].charAt(0).toUpperCase()+(e[1]?e[1].charAt(0).toUpperCase():"")).charCodeAt(0)-65]}function xloadDetallePago(e){xPopupLoad.xopen(),$("#tb_historial tr").removeClass("xitem_seleccionado_li");e=e.dataId;const o=xThisHistVenta.listRegistroPagoFilter[e];index_historial=e,xidregistro_pago_sel=o.idregistro_pago,xEstado_registro_pago=o.estado,xTotalItemSel=o.total,xThisHistVenta.$.component_pago.setVal(xMoneda(xTotalItemSel)),xValPago.setModoSoloComprobante(),xhtml_anulado="",$(".xMiBoton_icon_lateral").attr("disabled",!1),1===xEstado_registro_pago&&(xhtml_anulado='<h3 class="xColorRow_Rojo xBold">ANULADO</h3><div class="xLinea"></div><br><h4><strong>'+xmotio_anular.toUpperCase()+"</strong></h4>",$(".xMiBoton_icon_lateral").attr("disabled",!0)),$.ajax({type:"POST",url:"../../bdphp/log.php?op=20002",data:{i:xidregistro_pago_sel}}).done(function(e){(xdt_pdE=$.parseJSON(e)).success?(e=(xdt_pdE=xdt_pdE.datos[0]).num_comprobante,$("#txt_comprobante").text(e),xThisHistVenta.xYaTieneComprobante=null!==xdt_pdE.idce,xThisHistVenta.xYaPedidoCerrado="1"===xdt_pdE.cerrado,xThisHistVenta.xIsPuedeReimprimirCPE=!xThisHistVenta.xYaPedidoCerrado&&xThisHistVenta.xYaTieneComprobante,$("#txt_cliente").text(xdt_pdE.cliente),$("#txt_mesa").text(xdt_pdE.nummesa),$("#txt_mozo").text(xdt_pdE.usuario),$("#txt_correlativo").text(xdt_pdE.correlativo_dia),$("#xBody div").remove(),$("#xBody").append('<div><paper-spinner active class="xCentradoVerticalHorizontal"></paper-spinner></div>').trigger("create"),$.ajax({type:"POST",url:"../../bdphp/log.php?op=2003",data:{i:xidregistro_pago_sel}}).done(function(e){e=$.parseJSON(e);xArrayDtOrdenFiltro=e.datos,xLoadMipedidoBDHistorial(xThisHistVenta.xdtPedDet=xArrayDtOrdenFiltro)}),setTimeout(()=>{xPopupLoad.xclose(),dialog_registro_detalle.open(),setTimeout(()=>{o.showRemove?$("#btn_anular_pedido_rp .punto-flotante-verde").removeClass("xInvisible"):$("#btn_anular_pedido_rp .punto-flotante-verde").addClass("xInvisible")},500)},800)):(xPopupLoad.xclose(),alert(xdt_pdE.error))})}function xLoadMipedidoBDHistorial(e){var o,t,s="",r=(xArrayTpC=new Array,xArraySeccion_r=new Array,""),n=e;for(a in n)null==xArrayTpC[n[a].idtipo_consumo]&&(xArrayTpC[n[a].idtipo_consumo]={id:n[a].idtipo_consumo,des:n[a].des_tp});for(b in xArrayTpC){for(i in s="",xArraySeccion_r=new Array,n)xArrayTpC[b].id==n[i].idtipo_consumo&&(t=n[i].des_seccion,null==xArraySeccion_r[n[i].idseccion_index]&&(xArraySeccion_r[n[i].idseccion_index]='<tr><td colspan="5" class="xBold">'+t+"</td></tr>"),t=`
						<tr class="row" 
							data-i="${i}" 
							data-idpedidodetalle="${n[i].idpedido_detalle}" 
							data-idpedido="${n[i].idpedido}" 
							data-idtipoconsumo="${n[i].idtipo_consumo}" 
							data-idseccion="${n[i].idseccion}"
							data-idimpresora_seccion="${n[i].idimpresora_seccion}"
							data-descripcion="${n[i].descripcion}"
							data-des_tp="${n[i].des_tp}"
							data-iddescontar="${n[i].iddescontar}"
							data-cant_item="${n[i].cantidad}"
							data-is_cantidad_nd=${n[i].is_cantidad_nd}
							data-cant_descontar="${n[i].cant_descontar}"
							data-descontar="${n[i].descontar_en}"
							">
							<td width="7px" class="click_row_dt_p" id="td_cant">${xCeroIzq(n[i].cantidad,2)}</td>
							<td class="click_row_dt_p" width="50%">${n[i].descripcion}</td>
							<td class="click_row_dt_p" align="right" id="td_importe">${xMoneda(n[i].ptotal)}</td>
						</tr>
					`,xArraySeccion_r[n[i].idseccion_index]=xArraySeccion_r[n[i].idseccion_index]+t);for(a in o='<tr><td colspan="5" class="xFondoRowBlanco xBold">'+xArrayTpC[b].des+"</td></tr>",xArraySeccion_r)s=String(s+xArraySeccion_r[a]);r=String(r+o+s)}r='<div><table width="100%" id="tb_det_pedidos" class="xRowPading4">'+r+"</table></div>",$("#xBody div").remove(),$("#xBody").html(r).trigger("create"),xSumarTotalesHis()}function xSumarTotalesHis(){var s="";$.ajax({type:"POST",url:"../../bdphp/log.php?op=2005",data:{i:xidregistro_pago_sel}}).done(function(e){var o=$.parseJSON(e);if(o.success){const a="1"===(o=o.datos)[0].cierre;arrSumSubtTotales=o;for(var t=0;t<o.length;t++){var i=1===parseInt(o[t].tachado)?"xTachar":"";s=String(s+'<tr class="'+i+'"><td>'+o[t].descripcion.toUpperCase()+'</td><td align="right">'+o[t].importe+"</td></tr>")}s=String(s+'<tr><td colspan="2" align="left"><h4>FORMA DE PAGO</h4></td></tr>'),$.ajax({type:"POST",url:"../../bdphp/log.php?op=2004",data:{i:xidregistro_pago_sel}}).done(function(e){if((o=$.parseJSON(e)).success){for(var o=o.datos,t=0;t<o.length;t++){var i="1"==o[t].permission_change?"":"xInvisible",i=a?"":'<span data-id="'+o[t].idregistro_pago_detalle+'" data-idregistro_pago="'+o[t].idregistro_pago+'" data-idtp="'+o[t].idtipo_pago+'" data-importe="'+o[t].importe+'" data-destp="'+o[t].tipo_pago+'" onclick="xPermisoChangeTP(this)"><i class="fa fa-unlock text-success mr-1 punto-flotante-verde '+i+'"></i><i class="fa fa-refresh text-primary mr-1 xCursor" title="Cambiar metodo de pago"></i></span>';s=String(s+'<tr><td><div id="row_tp_pago_detalle" data-id="'+o[t].idregistro_pago_detalle+'">'+i+o[t].tipo_pago+'</div></td><td align="right">'+o[t].importe+"</td></tr>")}s='<div class="d-flexx justify-content-end mb-2"><table width="50%" id="tb_totales" class="xRowPading4">'+s+"</table></div><br>"+xhtml_anulado,$("#xBody").append(s).trigger("create");e=!!o.find(e=>12==e.idtipo_pago);xThisHistVenta.isHiddenOptionsPinPad=!e,e&&getDataPagoPinPad(xThisHistVenta.isHiddenOptionsPinPad=a)}else xPopupLoad.xclose(),alert(o.error)})}else xPopupLoad.xclose(),alert(o.error)}),dialog_registro_detalle.center()}function getDataPagoPinPad(e){xThisHistVenta.isHiddenOptionsPinPadBtnRemove=e;e={idregistro_pago:xidregistro_pago_sel};$.ajax({type:"POST",url:"../../bdphp/log_010.php?op=get-data-pago-pinpad",data:JSON.stringify(e)}).done(function(e){var o;(e=JSON.parse(e)).success&&(o=JSON.parse(e.datos[0].data_response),xThisHistVenta.registro_pago_pinpad=o,xThisHistVenta.isHiddenOptionsPinPad="1"===e.datos[0].estado)})}async function reemprimirPinpad(){btnRePrintPinPad.disabled=!0,xPopupLoad.xopen();var e=xThisHistVenta.registro_pago_pinpad.data.print_data,e=extractRefFromPrintData(e),e=await reemprimirVoucherPinPad(e);xPopupLoad.xclose(),btnRePrintPinPad.disabled=!1,e.success?showToastSwal("success","Reimpresion exitosa","Se reimpresion el voucher correctamente"):showToastSwal("error","Error al reimpresion","No se pudo reimpresion el voucher")}function xMandarCocinarImpresionComprobante_historial(){var o=xRpt_pago[0].cliente,t=xRpt_pago[0].comprobante;const i=xCargarDatosAEstructuraImpresion(xThisHistVenta.xdtPedDet);xPopupLoad.xopen(),$.ajax({type:"POST",url:"../../bdphp/log_001.php",data:{p_from:"fe",p_comprobante:t,idregistro_pago:xidregistro_pago_sel}}).done(function(e){e=xm_all_SetResponseLog_001(e);t.correlativo=xCeroIzqNumComprobante(e.correlativo_comprobante),xCocinarImprimirComprobante(i,arrSumSubtTotales,t,o,xidregistro_pago_sel,-2),xThisHistVenta.xYaTieneComprobante=!0,xdt_h[index_historial].idtipo_comprobante=t.idtipo_comprobante,$("#row_historial"+index_historial).append(x_icon_facturado),xThisHistVenta.$.dialog_comprobante.close(),xPopupLoad.xclose()})}function xImprimirPrecuentaHistorial(){var e=[],o=xArrayDtOrdenFiltro,e=xArrayTpC.slice();for(b in e=JSON.parse(JSON.stringify(e)),xArrayTpC)for(var t in o)xArrayTpC[b].id==o[t].idtipo_consumo&&1!=o[t].visible&&null!=xArrayTpC[b]&&(o[t].precio_print=o[t].ptotal,o[t].des=o[t].descripcion,e[xArrayTpC[b].id][t]=o[t]);var i=$("#txt_mesa").text(),a=$("#txt_correlativo").text();a=(a=a.split("-"))[1],xArrayPrintEncaLi_pre_cuenta={m:i,r:"",num_pedido:a,reservar:0,solo_llevar:0,correlativo_dia:a,precuenta:!0},xMandarImprimirOtroDoc(xArrayPrintEncaLi_pre_cuenta,xDtPrint,e,arrSumSubtTotales,-1)}function reImprimirCierre(){xPopupLoad.xopen(),fecha=xDevolverFechaFormatInputDate(txt_fecha.value),$.ajax({type:"POST",url:"../../bdphp/log_005.php?op=17",data:{f:fecha}}).done(function(e){setTimeout(()=>{xPopupLoad.xclose()},1500)})}function reImprimirComprobante(){reimpresionDocumento(xdt_pdE.idregistro_pago)}function buscarEnListaRegistroPagos(o){o=o.toLowerCase(),xThisHistVenta.listRegistroPagoFilter=xThisHistVenta.listRegistroPagoFilterTmp;var e=xThisHistVenta.listRegistroPagoFilter.filter(e=>e.charbusqueda.includes(o));xThisHistVenta.listRegistroPagoFilter=JSON.parse(JSON.stringify(e)),xResumenRegistroPagoTotales()}function buscarEnLista(o){o=o.toLowerCase();var e=listRegistroMaster.filter(e=>-1<e.charbusqueda.indexOf(o)),t=e.length+1||0,i=0,a=0,s=[];e.map(e=>{t--,e.num=xCeroIzq(t),e.des_pago.split(",").map(e=>{const o=e.split("-")[0];var e=0===s.length?null:s.filter(e=>e.id.toLowerCase()===o.toLowerCase())[0];e?e.cantidad++:(e={id:primeraConMayusculas(o.toLowerCase()),cantidad:1},s.push(e))});var o=e.anulado?0:parseFloat(e.total);i+=o,a+=""!==e.comprobante?1:0}),xThisHistVenta.listCantidadPagos=s,xThisHistVenta.importeTotalRegistrado=numeroConComas(i.toFixed(2)),xThisHistVenta.numComprobantesEmitidos=xCeroIzq(a,2)}function xGenerarReporteExcelRegistroPago(){tableToExcel("tbRegistroPago","Registro de Pago")}function xGenerarReporteExcelRegistroPagoDetallado(){data_pagination.pageFecha=""!==p_fecha?p_fecha:xDevolverFecha(),xPopupLoad.xopen();try{$.ajax({type:"POST",url:"../../bdphp/log.php?op=2000101",data:{pagination:data_pagination}}).done(function(e){e=JSON.parse(e);if(e.success){e=e.datos;let t=null;var i=e.length+1||0,o=($("#tbRegistroPagoDetalle thead tr th.th_dynamic").remove(),Object.keys(e[0]).filter(e=>e.startsWith("_")));const a=document.querySelector("#tbRegistroPagoDetalle thead tr");o.forEach(e=>{var o=document.createElement("th");o.textContent=e,o.classList.add("th_dynamic"),a.appendChild(o)});e.map(o=>{i--,o.num=xCeroIzq(i);var e=o.fecha.split(" ");o.fecha_des=e[0],o.hora=e[1],o.us_caja=o.us_caja.split(" ")[0],o.correlativo_dia=o.correlativo_dia.split(","),o.correlativo_dia=o.correlativo_dia.join(" - ");var e=(e=o.nom_usuario.split(",")).map(e=>e.split(" ")[0]),e=(o.nom_usuario=e.join(","),o.nom_usuario_show=o.nom_usuario.split(","),o.nom_usuario_show=o.nom_usuario_show.join(" - "),o.referencia_pedido=o.referencia_pedido===o.nom_cliente?"":o.referencia_pedido,o.anulado="1"===o.estado,o.des_estado=o.anulado?"Anulado":"Cobrado",o.des_consumo="CONSUMIR EN EL LOCAL"===o.des_consumo?"EN LOCAL":o.des_consumo,o.des_comprobante=""===o.comprobante?"":"B"===o.comprobante?"BOLETA":"FACTURA",o.comprobante_serie="",o.comprobante_num="",o.isShowComprobante=""!==o.des_comprobante,o.isShowComprobante&&(e=o.num_comprobante.split("-"),o.comprobante_serie=e[0],o.comprobante_num=e[1]),Object.keys(o).filter(e=>e.startsWith("_")));null===t||t!==o.idregistro_pago?t=o.idregistro_pago:e.forEach(e=>{o[e]=" "}),o.dynamicColumn=[],e.forEach(e=>{o.dynamicColumn.push(o[e])})}),xThisHistVenta.listRegistroPagoExportDetallado=JSON.parse(JSON.stringify(e)),setTimeout(()=>{tableToExcel("tbRegistroPagoDetalle","Registro de Pago Detallado"),xPopupLoad.xclose()},1500)}else xPopupLoad.xclose()})}catch(e){xPopupLoad.xclose()}}function xRegistroPagoReenviarComprobante(e){const o=e.dataId;e=xThisHistVenta.listRegistroPagoFilter.find(e=>e.idregistro_pago===o),e={numero:e.num_comprobante,external_id:e.cpe_external_id};document.getElementById("compDialogSendCPE_RP").open(e)}async function xPermisoChangeTP(e){xThisHistVenta.objChangeTp.idregistro_pago_detalle=e.dataset.id,xThisHistVenta.objChangeTp.idregistro_pago=e.dataset.idregistro_pago,xThisHistVenta.objChangeTp.idtipo_pago_before=e.dataset.idtp,xThisHistVenta.objChangeTp.importe=e.dataset.importe,xThisHistVenta.objChangeTp.descripcion_before=e.dataset.destp,xThisHistVenta.opPermisoPass=1;e=await findStorageSolicudPermisoRemota(xThisHistVenta.objChangeTp.idregistro_pago_detalle,3);e?(xPermisoSupervisor=e.idusuario_admin,xThisHistVenta.objChangeTp.idusuario_admin=e.idusuario_admin,xThisHistVenta.objChangeTp.idpermiso_remoto=e.idpermiso_remoto,xShowChangeMetodoPagoRegistro()):(xCompArraySolitaPermiso={tipo_permiso:3,obj:xThisHistVenta.objChangeTp},pass_us.open())}async function xShowAnularOperacionPinPad(){xThisHistVenta.openDlgRemovePinPad()}async function xShowChangeMetodoPagoRegistro(){var e=paramsSwalAlert;return e.title='<p class="fw-600 fs-18">Elige el metodo de pago</p>',e.html=`<div class="pb-2" style="display: inline-flex;">                    
                                    <x-comp-find-tipo-pago-option class="tpf_option_change_rgister"></x-comp-find-tipo-pago-option>
                                </div>`,e.confirmButtonText="Listo, registrar",e.showCancelButton=!0,showAlertSwalHtmlDecision(e,0).then(e=>{e.isConfirmed&&(xThisHistVenta.objChangeTp.idusuario_admin=xPermisoSupervisor,xThisHistVenta.objChangeTp.idtipo_pago_after=xThisHistVenta.idTpSelected.idtipo_pago,(new httpFecht).axiosExecute({type:"POST",url:"../../bdphp/log_010.php?op=change-tipo-pago-registro-pago",data:xThisHistVenta.objChangeTp},!0,!1).then(e=>{e.success&&((e=xThisHistVenta.listRegistroPagoFilter.find(e=>e.idregistro_pago===xidregistro_pago_sel)).listDesPago.descripcion=xThisHistVenta.idTpSelected.descripcion,e.listIconsPago[0].icon=xThisHistVenta.idTpSelected.logo,e.listIconsPago[0].id=xThisHistVenta.idTpSelected.img,xThisHistVenta.listRegistroPagoFilter=JSON.parse(JSON.stringify(xThisHistVenta.listRegistroPagoFilter)),removeStorageSolicitudPermisoRemota(xThisHistVenta.objChangeTp.idpermiso_remoto))}))})}function xRPRemoverPuntoFlotanteVerde(e){e=document.querySelector('#row_tp_pago_detalle[data-id="'+e+'"] .punto-flotante-verde');e&&e.classList.remove("xInvisible")}function xRPAnularRegistroPago(o){var e=xThisHistVenta.listRegistroPagoFilter.find(e=>e.idregistro_pago===o);e.showRemove=!0,xidregistro_pago_sel===o&&(xPermisoSupervisor=e.idusuario_admin,xThisHistVenta.$.dialog_registro_detalle.opened)&&(xThisHistVenta.isHiddenOptionsPinPadBtnRemove=!1,$("#btn_anular_pedido_rp .punto-flotante-verde").removeClass("xInvisible"))}function showMsjChangeHoraClose(){var e=paramsSwalAlert;e.title='<p class="fw-600 fs-18 text-warning">Hora de cierre</p>',e.html='<p class="fs-16">Para cambiar la hora de cierre vaya a las opciones principales "Datos del sistema / Sede / Variables."</p>',e.confirmButtonText="Entendido",e.showCancelButton=!1,e.showDenyButton=!1,showAlertSwalHtml(e)}async function showMsjRecuperarStock(){var e=paramsSwalAlert;return e.title='<p class="fw-600 fs-18">Atención!</p>',e.html=`<div class="pb-2" style="display: inline-flex;">                    
								<p class="mt-1 fs-18
								">¿Desea recuperar el stock de los productos del registro a anular?</p>
							</div>`,e.confirmButtonText="Si",e.denyButtonText="No",e.showDenyButton=!0,e.showCancelButton=!0,showAlertSwalHtmlDecision(e)}Polymer({is:"x-historial_venta",properties:{xdtPedDet:Object,isCierreCaja:Boolean,horaCierre:String,xYaTieneComprobante:boolean=!0,xYaPedidoCerrado:boolean=!0,xIsPuedeReimprimirCPE:boolean=!1,listRegistro:[],importeTotalRegistrado:Number,numComprobantesEmitidos:Number,cantRegistroPagos:Number,listCantidadPagos:[],listCobradoPorFilter:[],listCanalConsumoFilter:[],listAtendidoPorFilter:[],listMetodoPagoFilter:[],listTipoComprobanteFilter:[],listRegistroPagoMaster:[],listRegistroPagoFilter:[],listRegistroPagoFilterTmp:[],listRegistroPagoExportDetallado:[],listRegistroPagoExportDetalladoRowsDynamic:String,opPermisoPass:Number,idTpSelected:{},objChangeTp:{type:Object,value:{idregistro_pago_detalle:"",idregistro_pago:"",descripcion_before:"",descripcion_after:"",idtipo_pago_before:"",idtipo_pago_after:"",importe:"",idusuario_admin:""}},isHiddenOptionsPinPad:Boolean,isHiddenOptionsPinPadBtnRemove:Boolean,registro_pago_pinpad:Number},attached:function(){this.opPermisoPass=0,this.xIsPuedeReimprimirCPE=!1,this.xYaTieneComprobante=!0,this.xYaPedidoCerrado=!0,this.isCierreCaja=!1,this.horaCierre="00:00",this.isHiddenOptionsPinPad=!0,this.isHiddenOptionsPinPadBtnRemove=!0,xThisHistVenta=this,xIniHistVenta(),setTimeout(()=>{_cpSocketOpen()},1e3)},detached:function(){_cpSocketClose()},displayIndex:function(e){return xCeroIzq(e+1,1)},getDataPinPad:function(){},openDlgRemovePinPad:function(){var e=xThisHistVenta.listRegistroPagoFilter.find(e=>e.idregistro_pago===xidregistro_pago_sel);this.$.compRemoveOperationPinPad.setRowRegistroPago(e),this.$.compRemoveOperationPinPad.open()}})</script></dom-module>