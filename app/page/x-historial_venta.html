<link rel="import"href="../x-componentes/pagination-input/pagination-input.html"><link rel="import"href="../x-componentes/x-comp-meta-venta/x-comp-meta-venta.html"><link rel="import"href="../x-componentes/x-comp-dialog-send-cpe/x-comp-dialog-send-cpe.html"><dom-module id="x-historial_venta"><link rel="import"href="../x-componentes/x-comp-btn-permiso/x-comp-btn-permiso.html"><link rel="import"href="../x-componentes/x-comp-btn-permiso/x-comp-dialog-permiso.html"><link rel="import"href="../x-componentes/x-comp-anular-comprobante/x-comp-anular-comprobante.html"><script src="../view/socket.master.service.js"></script><script src="../view/socket.service.p.js"></script><script src="../view/export.excel.js"></script><link rel="stylesheet"href="../../css/searchableOptionList.css"><script src="../../js/searchableOptionList.js"></script><script async src="../view/httpFech.js"></script><script src="../view/notifica.js"></script><script src="../../js/PNotify.js"></script><script src="../../js/PNotifyConfirm.js"></script><script src="../../js/PNotifyHistory.js"></script><script async src="../../js/picket.js"></script><script async src="../../js/picket.date.js"></script><link rel="stylesheet"href="../../css/PNotifyBrightTheme.css"><script src="../../js/sweetalert2.js"></script><script src="../../js/mi.sweet.alert.js"></script><template><div class="xInvisible"><audio id="notificaLlamadoCliente"autobuffer preload="auto"><source src="../../sound/notifica-llamado.mp3"type="audio/mpeg"></audio></div><x-comp-anular-comprobante id="compAnularComprobante"></x-comp-anular-comprobante><x-comp-dialog-permiso></x-comp-dialog-permiso><x-pass id="pass_us"titulo="Usuario autorizado"valor="Pe1"></x-pass><paper-dialog id="dialog_motivo_anular_historial"style="min-width:320px"entry-animation="scale-up-animation"exit-animation="fade-out-animation"with-backdrop><div class="xContent"><h4>ANULAR</h4><h4 class="txt_anular_cambiar_mesa"></h4><br><h4>Indique el motivo de anulacion</h4><div><input class="xMiInput"placeholder="Motivo..."id="txt_motivo_anular"autofocus></div><br><br><br><div class="xBoton2 xVerde"dialog-dismiss onclick="xOpenDialogAnularPedido()">Listo</div><div class="xBoton2 xRojo"dialog-dismiss>Cancelar</div><br><br></div></paper-dialog><paper-dialog id="dialog_comprobante"style="min-width:320px"entry-animation="scale-up-animation"exit-animation="fade-out-animation"with-backdrop><div class="xContent"><x-pago id="component_pago"></x-pago></div></paper-dialog><paper-dialog id="dialog_registro_detalle"class="dialog_redondo"style="overflow:auto;overscroll-behavior:auto;min-width:50%;max-width:700px"entry-animation="scale-up-animation"exit-animation="fade-out-animation"with-backdrop><div class="mb-2"><div><div class="d-flexx justify-content-between align-items-center header-registro-venta"><div style="zoom:.9"><paper-button><div class="xMiBoton_icon_lateral2"style="margin-top:-15px;width:90px"onclick="xOpenAnularPedidoHistorial()"id="btn_anular_pedido"><img src="../../images/_delete_pedido.png"><p>Anular pedido</div></paper-button><paper-button><div class="xMiBoton_icon_lateral2"style="margin-top:-15px;width:100px"onclick="xImprimirPrecuentaHistorial()"><img src="../../images/_pre_cuenta.png"><p>Imprimir pre-cuenta</div></paper-button><paper-button><div class="xMiBoton_icon_lateral2"style="margin-top:-15px;width:50px"onclick="xAbrirDialogComprobante()"><img src="../../images/_comprobante.png"><p>Emitir Comprobante</div></paper-button><paper-button hidden$="[[!xIsPuedeReimprimirCPE]]"><div class="xMiBoton_icon_lateral2"style="margin-top:-15px;width:50px"onclick="reImprimirComprobante()"><img src="../../images/_print_vr.png"><p>Reimprimir Comprobante</div></paper-button></div><button class="btn btn-sm btn-secondary ml-2"dialog-dismiss>X</button></div><br><label for="txt_comprobante"class="xfont10">Comprobante Emitido:</label><p><span id="txt_comprobante"class="xfont20">- </span><span id="txt_ref"class="xfont16 xColorRow_Morado xpadingLateralIz"></span><div class="xLinea2"></div><label for="txt_cliente"class="xfont10">Cliente:</label><p><span id="txt_cliente"class="xfont20">- </span><span id="txt_ref"class="xfont16 xColorRow_Morado xpadingLateralIz"></span><div class="xLinea2"></div><br><div class="x_div_linea"><div><label for="txt_mesa"class="xfont10">Mesa:</label><p id="txt_mesa"class="xfont20">00</div><div><label for="txt_mozo"class="xfont10">Atendido por:</label><p id="txt_mozo"class="xfont20"></div><div><label for="txt_tpc"class="xfont10">Tiempo de atencion:</label><p id="txt_tpc"class="xfont20"></div><div><label for="txt_cat"class="xfont10"></label><p id="txt_cat"class="xfont20">-</div></div><div class="xLinea2"></div><br><br><div id="xBody"></div></div></div></paper-dialog><x-comp-dialog-send-cpe id="compDialogSendCPE_RP"></x-comp-dialog-send-cpe><div class="p-5"style="max-width:1200px!important;min-width:750px!important;margin:0 auto"><div class="d-flexx w-100 justify-content-between flex-wrap"><div><h3>Registro de Pagos</h3><p>Hora de cierre: <span id="info-hours-close"class="fw-600 text-primary">{{ horaCierre }}</span> <i class="xCursor fa fa-pencil"title="Modificar"onclick="showMsjChangeHoraClose()"></i></div><div class="div-info mb-1"><div class="div-border text-center p-2 mr-1 div-indicador"><p class="fs-12 fw-600 text-secondary">Meta Diaria</p><x-comp-meta-venta fontsize="fs-25"></x-comp-meta-venta></div><div class="div-border text-center p-2 mr-1 div-indicador"style="max-width:150px"><p class="fs-12 fw-600 text-secondary">Metodos de Pago<div class="d-flexx justify-content-center flex-wrap"><template is="dom-repeat"items="{{listCantidadPagos}}"as="item"><div><p class="fs-11 pr-2 m-0 fw-600">{{item.id}}: <span class="fw-900 text-primary">{{item.cantidad}}</span></div></template></div></div><div class="div-border text-center p-2 mr-1 div-indicador"style="max-width:80px"><p class="fs-12 fw-600 text-secondary">Comprobantes Emitidos<p class="fw-600 fs-15">{{ numComprobantesEmitidos }}</div><div class="div-border text-center p-2 div-indicador"><p class="fs-12 fw-600 text-secondary">Importe Total<p class="fw-600 fs-25 text-primary">S/. {{ importeTotalRegistrado }}</div></div></div><div class="div-border div-filter"><div><p class="fw-900">Ver Desde</p><input style="height:20px"class="selected-template-1 xCursor"id="txt_fecha"placeholder="Elige fecha"></div><div style="width:95%"><p class="fw-900">Filtro<div class="content-div-filtro"><select class="js-select2-rp selected-template-1"id="seletecFilter"multiple="multiple"><optgroup label="Cobrado Por"><template is="dom-repeat"items="{{listCobradoPorFilter}}"as="item"><option value$="[[item]]">{{item.us_caja}}</template><optgroup label="Canal de Consumo"><template is="dom-repeat"items="{{listCanalConsumoFilter}}"as="item"><option value$="[[item]]">{{item.descripcion}}</template><optgroup label="Tipo de Comprobante"><template is="dom-repeat"items="{{listTipoComprobanteFilter}}"as="item"><option value$="[[item]]">{{item.descripcion}}</template><optgroup label="Tipo de Pago"><template is="dom-repeat"items="{{listMetodoPagoFilter}}"as="item"><option value$="[[item]]">{{item.descripcion}}</template></select></div></div><div><p class="fw-900">Buscar</p><input style="height:20px"placeholder="Indique criterio a buscar..."class="selected-template-1 w-100"onkeyup="buscarEnListaRegistroPagos(this.value)"></div></div><table class="w-100 content-table-delivery"><thead><th align="left"colspan="8"><span class="text-primary fw-600 fs-15">[[cantRegistroPagos]]</span> Registros encontrados<th align="right"><div class="dropdown"><button class="btn btn-sm btn-success"><i class="fa fa-file-excel-o"></i> Exportar <i class="fa fa-angle-down"></i></button><div class="dropdown-content"><a href="#"onclick="xGenerarReporteExcelRegistroPago()">Resumen</a> <a href="#"onclick="xGenerarReporteExcelRegistroPagoDetallado()">Detallado</a></div></div></thead><thead style="height:50px"><th>#<th align="left">Fecha<th align="center">Cobrado Por<th align="left">Canal<th align="left">Atendido Por<th align="left">Cliente<th width="85px"><th align="right"width="50px"><th align="center"style="min-width:130px">Importe<tbody><template is="dom-repeat"items="[[listRegistroPagoFilter]]"as="item"><tr class$="[[ item.row_calss ]]"><td><span class="fw-600 mr-1">{{item.num}} </span><i class="fa fa-lock"hidden$="[[!item.isCierre]]"></i><td><p class="fs-11">{{ item.fecha_des }}<p class="fs-11">{{ item.hora }}<td align="center"><p class="fs-11 fw-900"style$="[[item.us_caja_class_color]]">{{ item.us_caja }}<td><p class$="[[item.class_tpc]]">{{ item.des_consumo }}<p class="badge badge-secondary fs-12"hidden$="[[ item.isDelivery ]]">{{ item.mesa }}<div class="d-flexx"style="max-width:120px"><p class="badge badge-success mr-2"hidden$="[[ !item.isScanCodigo ]]">App<p class="fs-10 fw-600">{{ item.correlativo_dia }}</div><td><div style="max-width:130px"><p class="fs-11">{{ item.nom_usuario_show }}</div><td><div style="max-width:125px"><p class="fs-10 fw-600">{{ item.nom_cliente }}<p class="fs-10 fw-600">{{ item.referencia_pedido }}</div><td align="center"><div hidden$="[[!item.isShowComprobante]]"><p class="fs-10 fw-600 m-0">{{ item.des_comprobante }} {{ item.num_comprobante }}</p><button class="btn btn-sm fs-10 btn-flat sky mt-1 d-flexx"data-id="[[item.idregistro_pago]]"onclick="xRegistroPagoReenviarComprobante(this)"><i class="fa fa-whatsapp"></i> Reenviar</button></div><td align="right"><div class="d-flexx justify-content-end"><template is="dom-repeat"items="[[item.listIconsPago]]"as="icon"><img width="18px"class="mr-1"src$="{{ icon.icon }}"alt=""></template></div><td align="right"><div class="d-flexx justify-content-end"><p class="fw-600 text-info fs-15">S/. {{ item.total }}</p><button class="xBoton_flat_2 xCursor ml-2"onclick="xloadDetallePago(this)"data-id="{{index}}">Ver</button></div></template></table></div><br><div class="xInvisible"><table width="100%"id="tbRegistroPago"><thead><th>#<th>Fecha<th>Hora<th>Cobrado Por<th>Canal<th>Atendido Por<th>Cliente<th>Comprobante<th>Productos<th>T. Pago<th align="right"style="min-width:100px">importe<th>Estado<tbody><template is="dom-repeat"items="[[listRegistroPagoFilter]]"as="item"><tr><td>{{item.num}}<td>{{item.fecha_des}}<td>{{item.hora}}<td>{{item.us_caja}}<td>{{item.des_consumo}}<td>{{item.nom_usuario_show}}<td>{{item.nom_cliente}}<td>{{item.des_comprobante}}<td><table><template is="dom-repeat"items="[[item.list_productos]]"as="prod"><tr><td>{{prod.cantidad}}<td>{{prod.item}}<td>{{prod.total}}<td>{{prod.impresora}}</template></table><td><div class="d-flexx"><table><template is="dom-repeat"items="[[item.listDesPago]]"as="tpc"><tr><td>{{tpc.descripcion}}<td>{{ tpc.importe }}</template></table></div><td>S/. {{ item.total }}<td><p>{{item.des_estado}}</template></table></div><div class="xInvisible"><table width="100%"id="tbRegistroPagoDetalle"><thead><th>#<th>Fecha<th>Hora<th>Caja<th>Canal<th>Mesa<th>Atendido Por<th>Cliente<th>Referencia<th>Tipo Doc<th>Serie<th>Num Doc<th>Producto<th>Producto Referencia<th>Cantidad<th>Precio Und<th>Total<th>Seccion<th>Area<th>Estado<tbody id="tbodyRegistroPagoDetalle"><template is="dom-repeat"items="[[listRegistroPagoExportDetallado]]"as="item"><tr><td>{{item.num}}<td>{{item.fecha_des}}<td>{{item.hora}}<td>{{item.us_caja}}<td>{{item.des_consumo}}<td>{{item.nummesa}}<td>{{item.nom_usuario_show}}<td>{{item.nom_cliente}}<td>{{item.referencia_pedido}}<td>{{item.des_comprobante}}<td>{{item.comprobante_serie}}<td>{{item.comprobante_num}}<td>{{item.producto_descripcion}}<td>{{item.producto_referencia}}<td>{{item.producto_cant}}<td>{{item.producto_punitario}}<td>{{item.producto_total_r}}<td>{{item.producto_seccion}}<td>{{item.producto_impresora}}<td>{{item.des_estado}}</td><template is="dom-repeat"items="{{item.dynamicColumn}}"as="subitem"><td>{{ subitem }}</template></template></table></div><br><br></template><style>.div-dato-registro{border-radius:8px;background:#fff;padding:5px 15px 5px 15px;text-align:center;border:1px solid #bdbdbd;margin-left:10px}.row-anulado{background:#ffe8f0;text-decoration:line-through;color:red}.div-correlativo{inline-size:230px;overflow-wrap:break-word}.header-registro-venta{background:#d4d4d4;padding:20px 25px 10px;margin-top:-32px;margin-right:-32px;margin-left:-32px}.bg-delivery{background-color:#f8f6c2}.bg-llevar{background-color:#81fad3}.bg-mesa{background-color:#46d9f2}.div-indicador{display:flex;flex-direction:column;justify-content:center}</style><script src="../view/xJsonSunat.js"></script><script src="../view/deNumALetras.js"></script><script src="../view/item_pedido_estructura.js"></script><script src="../view/item_pedido_print_comprobante.js"></script><script src="../view/cpe_interno.js"></script><script src="../view/item_pedido_subtotales.js"></script><style>.verIconFacturado img{visibility:hidden}.btn-row-delivery{border:0;border-radius:5px;color:#fff;cursor:pointer;font-size:11px}.bg-papaya{background:#571c86;color:#fff}.btn-flat{opacity:.8}.btn-flat.blue{background:#d0e6f0;border:solid 1px #81d4fa}.btn-flat.green{background:#bfefc1;border:solid 1px #81fa8a}.btn-flat.sky{background:#b1eef8;border:solid 1px #46d9f2}.btn-flat.red{background:#f8c2c2;border:solid 1px #e66060}.btn-flat:hover{opacity:1}.content-table-delivery{padding:15px 0;background:#fff;border-radius:8px;border:1px solid #e0e0e0}.content-table-delivery tr>td{border-bottom:8px solid #e5e5e7}.container-list{border:2px solid #ccc;width:300px;height:auto;overflow-y:scroll;background:#fff}.sol-container{display:flex!important}.div-border{background:#fff;border-radius:8px;border:1px solid #e0e0e0}.div-filter{display:grid;grid-template-columns:1fr 3fr 3fr;column-gap:30px;padding:20px;margin-bottom:10px;align-items:center}.div-info{display:flex;justify-content:flex-end}</style><script>var xThisHistVenta,xTotalItemSel,xidregistro_pago_sel,xDtPrint,xPSupervisor,index_historial,x_icon_facturado,xdt_pdE,listRegistroMaster,xfecha_historial="",xArrayTpC=[],xArraySeccion_r=[],xArrayDtOrdenFiltro=[],xEstado_registro_pago=0,xhtml_anulado="",xdt_h=[],arrSumSubtTotales=[],xRpt_pago=[],data_pagination={},p_rows=0,p_fecha="";function xIniHistVenta(){xPopupLoad=document.getElementById("xLoad"),x_icon_facturado='<img src="../../images/_comprobante.png" title="se emitio comprobante" width="16px">',xm_LogChequea(function(){xm_log_get("ini_us"),$("#Titulo_page").text("Registro de pagos"),$("body").addClass("loaded"),xDtPrint=xm_log_get("sede_generales"),xloadHistorial()}),$("#txt_fecha").pickadate({format:"dd mmmm, yyyy",today:"Hoy",clear:"Borrar",close:"Cerrar",onSet:function(o){xfecha_historial=o.select?xDevolverFechaDada2(o.select):"",p_fecha=xfecha_historial,xloadHistorial()}}),$(".js-select2-rp").select2({placeholder:"Aplicar Filtro",allowHtml:!0,allowClear:!0,tags:!0,width:"100%"}),$(".js-select2-rp").on("change",o=>{xRegistroPagoListFilter([...o.target.selectedOptions].map(o=>JSON.parse(o.value)))}),$("#dialog_motivo_anular_historial").on("iron-overlay-closed",function(){$("#txt_motivo_anular").focus()}),$("#dialog_motivo_anular_historial #txt_motivo_anular").keyup(function(o){13==o.keyCode&&(dialog_motivo_anular_historial.close(),xOpenDialogAnularPedido())}),(xPSupervisor=document.getElementById("pass_us")).setVal("Pe1"),xPSupervisor.addEventListener("xSend",function(o){1===o.detail.xRpts[0].p&&(xPermisoSupervisor=o.detail.xRpts[0].us,(0==xThisHistVenta.opPermisoPass?xAnularPedidoHistorial:xShowChangeMetodoPagoRegistro)())}),(xValPago=document.getElementById("component_pago")).addEventListener("xSend",function(o){xRpt_pago=o.detail.xRpts,0!=o.detail.xRpts[0].ok&&1==o.detail.xRpts[0].paseEnterTxt&&xRegistrarClientePagoCP()}),xValPago.addEventListener("xCancelarCerrar",function(o){xThisHistVenta.$.dialog_comprobante.close()}),xValPago.addEventListener("xListoRegistraPago",function(o){xMandarCocinarImpresionComprobante_historial()}),xValPago.addEventListener("xSelectTipoComprobante",function(o){dialog_comprobante.center()}),xValPago.addEventListener("xFormClienteValid",function(o){dialog_comprobante.center()}),$(document).on("getValorIncial",".tpf_option_change_rgister",function(o){xThisHistVenta.idTpSelected=o.detail.values}),document.getElementById("compAnularComprobante").addEventListener("onAnularComprobante",function(o){xThisHistVenta.$.dialog_comprobante.open(),xm_all_xToastOpen("Se anulo el comprobante correctamente")})}function openAnularComp(){document.getElementById("compAnularComprobante").open(xdt_pdE.idce)}function xOpenDialogAnularPedido(){xThisHistVenta.opPermisoPass=0,pass_us.open()}async function xAbrirDialogComprobante(){var o;!1!==xThisHistVenta.xYaTieneComprobante?((o=paramsSwalAlert).title='<p class="fw-600 fs-18">Atención!</p>',o.html=`<div class="pb-2" style="display: inline-flex;">                    
                                    <p class="mt-1 fs-18">Ya existe un comprobante emitido por esta venta. ¿Que desea hacer?</p>
                                </div>`,o.confirmButtonText="Emitir Nuevo",o.denyButtonText="Emitir y Eliminar Anterior",o.showDenyButton=!0,o.showCancelButton=!0,(o=await showAlertSwalHtmlDecision(o)).isConfirmed&&xThisHistVenta.$.dialog_comprobante.open(),o.isDenied&&openAnularComp()):xThisHistVenta.$.dialog_comprobante.open()}function xOpenAnularPedidoHistorial(){dialog_motivo_anular_historial.open()}function xAnularPedidoHistorial(){var t="";$("#tb_det_pedidos .row").each(function(o,e){t=t+","+$(e).attr("data-idpedido")}),t=t.slice(1),xPopupLoad.xopen(),$.ajax({type:"POST",url:"../../bdphp/log.php?op=5011",data:{ArrayPeAnular:"",xPedidos:t,xMotivo:$("#txt_motivo_anular").val(),u:xPermisoSupervisor,viene_historial:xidregistro_pago_sel}}).done(function(o){xPopupLoad.xclose(),$(".xMiBoton_icon_lateral").attr("disabled",!0),xloadHistorial(),dialog_registro_detalle.close()})}function xloadHistorial(){xPopupLoad.titulo="Cargando...",xPopupLoad.xopen();(new httpFecht).axiosExecuteJSON({type:"GET",url:"../../bdphp/api.php?route=get-hours-clouse"}).then(o=>{if(o.success)try{xThisHistVenta.horaCierre=o.data[0].hora_cierre_dia}catch(o){xThisHistVenta.horaCierre="00:00"}}),data_pagination.pageFecha=""!==p_fecha?p_fecha:xDevolverFecha();$.ajax({type:"POST",url:"../../bdphp/log.php?op=20001",data:{pagination:data_pagination}}).done(function(o){o=JSON.parse(o);var r=(xdt_h=o.datos).length+1||0,s=[],n=0,d=0;xThisHistVenta.listCobradoPorFilter=[],xThisHistVenta.listCanalConsumoFilter=[],xThisHistVenta.listAtendidoPorFilter=[],xThisHistVenta.listTipoComprobanteFilter=[],xThisHistVenta.listMetodoPagoFilter=[],xdt_h.map((e,o)=>{var t=e.fecha.split(" ");let a=[],i=[];e.isFacturaEmitido=null!==e.idce,e.isPedidoApp=1===parseInt(e.app),e.isScanCodigo=0!==parseInt(e.scan_qr),e.isCierre=0!==parseInt(e.cierre),e.icon_pago.split(",").map(o=>{a.push({icon:"../../images/"+o,id:o})}),e.des_pago.split(",").map(o=>{o=o.split("-");i.push({descripcion:o[0],importe:o[1]})}),e.listIconsPago=a,e.listDesPago=i,e.referencia_pedido=e.referencia_pedido===e.nom_cliente?"":e.referencia_pedido,e.fecha_des=t[0],e.hora=t[1],e.des_comprobante=""===e.comprobante?"":"B"===e.comprobante?"Boleta":"Factura",e.isShowComprobante=""!==e.des_comprobante,e.num_comprobante="",e.isShowComprobante&&(e.num_comprobante=e.numero.split("-"),e.num_comprobante=e.num_comprobante[0]+"-"+e.num_comprobante[1].replace(/^0+/,"")),e.mesa="0"===e.nummesa?"":"Mesa "+e.nummesa,e.list_productos=e.list_productos?JSON.parse(e.list_productos):[],e.des_pago.split(",").map(o=>{const e=o.split("-")[0];var o=0===s.length?null:s.filter(o=>o.id.toLowerCase()===e.toLowerCase())[0];o?o.cantidad++:(o={id:primeraConMayusculas(e.toLowerCase()),cantidad:1},s.push(o))}),e.anulado="1"===e.estado,e.des_estado=e.anulado?"Anulado":"Cobrado",e.row_calss=e.anulado?"row-anulado":"",e.charbusqueda+=e.anulado?"anulado, borrado, eliminado":"",e.isDelivery="DELIVERY"===e.des_consumo,e.des_consumo="CONSUMIR EN EL LOCAL"===e.des_consumo?"EN LOCAL":e.des_consumo,e.class_tpc="DELIVERY"===e.des_consumo?"bg-delivery":"PARA LLEVAR"===e.des_consumo?"bg-llevar":"bg-mesa",e.class_tpc="badge fs-12 "+e.class_tpc;t=e.anulado?0:parseFloat(e.total);n+=t,d+=""!==e.comprobante?1:0,e.us_caja=e.us_caja.split(" ")[0],e.correlativo_dia=e.correlativo_dia.split(","),e.correlativo_dia=e.correlativo_dia.join(" - ");var t=(t=e.nom_usuario.split(",")).map(o=>o.split(" ")[0]),t=(e.nom_usuario=t.join(","),e.nom_usuario_show=e.nom_usuario.split(","),e.nom_usuario_show=e.nom_usuario_show.join(" - "),xColorAleatorioRegistroPagos(e.us_caja)),t=(e.us_caja_class_color=`color: ${t};`,xThisHistVenta.listCobradoPorFilter.find(o=>o.id_us_caja===e.id_us_caja)),t=(t||(t={id_us_caja:e.id_us_caja,us_caja:e.us_caja,key:"id_us_caja",value:e.id_us_caja},xThisHistVenta.listCobradoPorFilter.push(t)),xThisHistVenta.listCanalConsumoFilter.find(o=>o.idtipo_consumo===e.idtipo_consumo));t||(t={idtipo_consumo:e.idtipo_consumo,descripcion:e.des_consumo,key:"idtipo_consumo",value:e.idtipo_consumo},xThisHistVenta.listCanalConsumoFilter.push(t)),e.isShowComprobante&&!xThisHistVenta.listTipoComprobanteFilter.find(o=>o.descripcion.toUpperCase()===e.des_comprobante.toUpperCase())&&(t={descripcion:e.des_comprobante.toUpperCase(),key:"des_comprobante",value:e.des_comprobante},xThisHistVenta.listTipoComprobanteFilter.push(t)),e.listDesPago.map(e=>{var o;xThisHistVenta.listMetodoPagoFilter.find(o=>o.descripcion.toUpperCase()===e.descripcion.toUpperCase())||(o={descripcion:e.descripcion.toUpperCase(),key:"des_pago",value:e.descripcion},xThisHistVenta.listMetodoPagoFilter.push(o))}),xThisHistVenta.listAtendidoPorFilter.find(o=>o.nom_usuario===e.nom_usuario);r--,e.num=xCeroIzq(r),e.charbusqueda=`${e.nom_usuario} ${e.correlativo_dia} ${e.des_pago} ${e.des_consumo} ${e.nom_cliente} ${e.referencia_pedido} ${e.total} ${e.des_comprobante} ${e.num_comprobante} ${e.repartidor} `+e.mesa,e.charbusqueda=e.charbusqueda.toLowerCase()}),xThisHistVenta.listRegistroPagoMaster=JSON.parse(JSON.stringify(xdt_h)),xThisHistVenta.listRegistroPagoFilter=xThisHistVenta.listRegistroPagoMaster,xThisHistVenta.listRegistroPagoFilterTmp=xThisHistVenta.listRegistroPagoFilter,xThisHistVenta.listCobradoPorFilter=JSON.parse(JSON.stringify(xThisHistVenta.listCobradoPorFilter)),xThisHistVenta.listCanalConsumoFilter=JSON.parse(JSON.stringify(xThisHistVenta.listCanalConsumoFilter)),xThisHistVenta.listTipoComprobanteFilter=JSON.parse(JSON.stringify(xThisHistVenta.listTipoComprobanteFilter)),xThisHistVenta.listMetodoPagoFilter=JSON.parse(JSON.stringify(xThisHistVenta.listMetodoPagoFilter)),listRegistroMaster=xdt_h,xThisHistVenta.listCantidadPagos=s,xThisHistVenta.importeTotalRegistrado=numeroConComas(n.toFixed(2)),xThisHistVenta.numComprobantesEmitidos=xCeroIzq(d,2),xThisHistVenta.cantRegistroPagos=xThisHistVenta.listRegistroPagoFilter.length,xPopupLoad.xclose()})}function xRegistroPagoListFilter(o){var e=xThisHistVenta.listRegistroPagoMaster;o.map(o=>{e=xRegistroPagoFilterByCodes(e,o.key,o.value)}),xThisHistVenta.listRegistroPagoFilter=JSON.parse(JSON.stringify(e)),xThisHistVenta.listRegistroPagoFilterTmp=xThisHistVenta.listRegistroPagoFilter,xResumenRegistroPagoTotales()}function xRegistroPagoFilterByCodes(o,e,t){return o.filter(o=>o[e].includes(t))}function xResumenRegistroPagoTotales(){var t=xThisHistVenta.listRegistroPagoFilter.length+1||0,a=0,i=0,r=[];xThisHistVenta.listRegistroPagoFilter.map(o=>{t--,o.num=xCeroIzq(t),o.des_pago.split(",").map(o=>{const e=o.split("-")[0];var o=0===r.length?null:r.filter(o=>o.id.toLowerCase()===e.toLowerCase())[0];o?o.cantidad++:(o={id:primeraConMayusculas(e.toLowerCase()),cantidad:1},r.push(o))});var e=o.anulado?0:parseFloat(o.total);a+=e,i+=""!==o.comprobante?1:0}),xThisHistVenta.listCantidadPagos=r,xThisHistVenta.importeTotalRegistrado=numeroConComas(a.toFixed(2)),xThisHistVenta.numComprobantesEmitidos=xCeroIzq(i,2),xThisHistVenta.cantRegistroPagos=xThisHistVenta.listRegistroPagoFilter.length}function xColorAleatorioRegistroPagos(o){o=o.split(" ");return["#f44336","#e91e63","#9c27b0","#673ab7","#3f51b5","#2196f3","#03a9f4","#00bcd4","#009688","#4caf50","#8bc34a","#cddc39","#ffeb3b","#ffc107","#ff9800","#ff5722","#795548","#9e9e9e","#607d8b"][(o[0].charAt(0).toUpperCase()+(o[1]?o[1].charAt(0).toUpperCase():"")).charCodeAt(0)-65]}function xloadDetallePago(o){xPopupLoad.xopen(),$("#tb_historial tr").removeClass("xitem_seleccionado_li");var o=o.dataId,e=xThisHistVenta.listRegistroPagoFilter[o];index_historial=o,xidregistro_pago_sel=e.idregistro_pago,xEstado_registro_pago=e.estado,xTotalItemSel=e.total,xThisHistVenta.$.component_pago.setVal(xMoneda(xTotalItemSel)),xValPago.setModoSoloComprobante(),xhtml_anulado="",$(".xMiBoton_icon_lateral").attr("disabled",!1),1===xEstado_registro_pago&&(xhtml_anulado='<h3 class="xColorRow_Rojo xBold">ANULADO</h3><div class="xLinea"></div><br><h4><strong>'+xmotio_anular.toUpperCase()+"</strong></h4>",$(".xMiBoton_icon_lateral").attr("disabled",!0)),$.ajax({type:"POST",url:"../../bdphp/log.php?op=20002",data:{i:xidregistro_pago_sel}}).done(function(o){(xdt_pdE=$.parseJSON(o)).success?(o=(xdt_pdE=xdt_pdE.datos[0]).num_comprobante,$("#txt_comprobante").text(o),xThisHistVenta.xYaTieneComprobante=null!==xdt_pdE.idce,xThisHistVenta.xYaPedidoCerrado="1"===xdt_pdE.cerrado,xThisHistVenta.xIsPuedeReimprimirCPE=!xThisHistVenta.xYaPedidoCerrado&&xThisHistVenta.xYaTieneComprobante,$("#txt_cliente").text(xdt_pdE.cliente),$("#txt_mesa").text(xdt_pdE.nummesa),$("#txt_mozo").text(xdt_pdE.usuario),$("#txt_correlativo").text(xdt_pdE.correlativo_dia),$("#xBody div").remove(),$("#xBody").append('<div><paper-spinner active class="xCentradoVerticalHorizontal"></paper-spinner></div>').trigger("create"),$.ajax({type:"POST",url:"../../bdphp/log.php?op=2003",data:{i:xidregistro_pago_sel}}).done(function(o){o=$.parseJSON(o);xArrayDtOrdenFiltro=o.datos,xLoadMipedidoBDHistorial(xThisHistVenta.xdtPedDet=xArrayDtOrdenFiltro)}),setTimeout(()=>{xPopupLoad.xclose(),dialog_registro_detalle.open()},800)):(xPopupLoad.xclose(),alert(xdt_pdE.error))})}function xLoadMipedidoBDHistorial(o){var e,t,r="",s=(xArrayTpC=new Array,xArraySeccion_r=new Array,""),n=o;for(a in n)null==xArrayTpC[n[a].idtipo_consumo]&&(xArrayTpC[n[a].idtipo_consumo]={id:n[a].idtipo_consumo,des:n[a].des_tp});for(b in xArrayTpC){for(i in r="",xArraySeccion_r=new Array,n)xArrayTpC[b].id==n[i].idtipo_consumo&&(t=n[i].des_seccion,null==xArraySeccion_r[n[i].idseccion_index]&&(xArraySeccion_r[n[i].idseccion_index]='<tr><td colspan="5" class="xBold">'+t+"</td></tr>"),t=String('<tr class="row" data-i="'+i+'" data-idpedidodetalle="'+n[i].idpedido_detalle+'" data-idpedido="'+n[i].idpedido+'" data-idtipoconsumo="'+n[i].idtipo_consumo+'"><td width="7px" class="click_row_dt_p" id="td_cant">'+xCeroIzq(n[i].cantidad,2)+'</td><td class="click_row_dt_p" width="50%">'+n[i].descripcion+'</td><td class="click_row_dt_p" align="right" id="td_importe">'+xMoneda(n[i].ptotal)+"</td></tr>"),xArraySeccion_r[n[i].idseccion_index]=xArraySeccion_r[n[i].idseccion_index]+t);for(a in e='<tr><td colspan="5" class="xFondoRowBlanco xBold">'+xArrayTpC[b].des+"</td></tr>",xArraySeccion_r)r=String(r+xArraySeccion_r[a]);s=String(s+e+r)}s='<div><table width="100%" id="tb_det_pedidos" class="xRowPading4">'+s+"</table></div>",$("#xBody div").remove(),$("#xBody").html(s).trigger("create"),xSumarTotalesHis()}function xSumarTotalesHis(){var r="";$.ajax({type:"POST",url:"../../bdphp/log.php?op=2005",data:{i:xidregistro_pago_sel}}).done(function(o){var e=$.parseJSON(o);if(e.success){const i="1"===(e=e.datos)[0].cierre;arrSumSubtTotales=e;for(var t=0;t<e.length;t++){var a=1===parseInt(e[t].tachado)?"xTachar":"";r=String(r+'<tr class="'+a+'"><td>'+e[t].descripcion.toUpperCase()+'</td><td align="right">'+e[t].importe+"</td></tr>")}r=String(r+'<tr><td colspan="2" align="left"><h4>FORMA DE PAGO</h4></td></tr>'),$.ajax({type:"POST",url:"../../bdphp/log.php?op=2004",data:{i:xidregistro_pago_sel}}).done(function(o){if((e=$.parseJSON(o)).success){for(var e=e.datos,t=0;t<e.length;t++){var a="1"==e[t].permission_change?"":"xInvisible",a=i?"":'<span data-id="'+e[t].idregistro_pago_detalle+'" data-idregistro_pago="'+e[t].idregistro_pago+'" data-idtp="'+e[t].idtipo_pago+'" data-importe="'+e[t].importe+'" data-destp="'+e[t].tipo_pago+'" onclick="xPermisoChangeTP(this)"><i class="fa fa-unlock text-success mr-1 punto-flotante-verde '+a+'"></i><i class="fa fa-refresh text-primary mr-1 xCursor" title="Cambiar metodo de pago"></i></span>';r=String(r+'<tr><td><div id="row_tp_pago_detalle" data-id="'+e[t].idregistro_pago_detalle+'">'+a+e[t].tipo_pago+'</div></td><td align="right">'+e[t].importe+"</td></tr>")}r='<div class="d-flexx justify-content-end mb-2"><table width="50%" id="tb_totales" class="xRowPading4">'+r+"</table></div><br>"+xhtml_anulado,$("#xBody").append(r).trigger("create")}else xPopupLoad.xclose(),alert(e.error)})}else xPopupLoad.xclose(),alert(e.error)}),dialog_registro_detalle.center()}function xMandarCocinarImpresionComprobante_historial(){var e=xRpt_pago[0].cliente,t=xRpt_pago[0].comprobante;const a=xCargarDatosAEstructuraImpresion(xThisHistVenta.xdtPedDet);xPopupLoad.xopen(),$.ajax({type:"POST",url:"../../bdphp/log_001.php",data:{p_from:"fe",p_comprobante:t,idregistro_pago:xidregistro_pago_sel}}).done(function(o){o=xm_all_SetResponseLog_001(o);t.correlativo=xCeroIzqNumComprobante(o.correlativo_comprobante),xCocinarImprimirComprobante(a,arrSumSubtTotales,t,e,xidregistro_pago_sel,-2),xThisHistVenta.xYaTieneComprobante=!0,xdt_h[index_historial].idtipo_comprobante=t.idtipo_comprobante,$("#row_historial"+index_historial).append(x_icon_facturado),xThisHistVenta.$.dialog_comprobante.close(),xPopupLoad.xclose()})}function xImprimirPrecuentaHistorial(){var o=[],e=xArrayDtOrdenFiltro,o=xArrayTpC.slice();for(b in o=JSON.parse(JSON.stringify(o)),xArrayTpC)for(var t in e)xArrayTpC[b].id==e[t].idtipo_consumo&&1!=e[t].visible&&null!=xArrayTpC[b]&&(e[t].precio_print=e[t].ptotal,e[t].des=e[t].descripcion,o[xArrayTpC[b].id][t]=e[t]);var a=$("#txt_mesa").text(),i=$("#txt_correlativo").text();i=(i=i.split("-"))[1],xArrayPrintEncaLi_pre_cuenta={m:a,r:"",num_pedido:i,reservar:0,solo_llevar:0,correlativo_dia:i,precuenta:!0},xMandarImprimirOtroDoc(xArrayPrintEncaLi_pre_cuenta,xDtPrint,o,arrSumSubtTotales,-1)}function reImprimirCierre(){xPopupLoad.xopen(),fecha=xDevolverFechaFormatInputDate(txt_fecha.value),$.ajax({type:"POST",url:"../../bdphp/log_005.php?op=17",data:{f:fecha}}).done(function(o){setTimeout(()=>{xPopupLoad.xclose()},1500)})}function reImprimirComprobante(){reimpresionDocumento(xdt_pdE.idregistro_pago)}function buscarEnListaRegistroPagos(e){e=e.toLowerCase(),xThisHistVenta.listRegistroPagoFilter=xThisHistVenta.listRegistroPagoFilterTmp;var o=xThisHistVenta.listRegistroPagoFilter.filter(o=>o.charbusqueda.includes(e));xThisHistVenta.listRegistroPagoFilter=JSON.parse(JSON.stringify(o)),xResumenRegistroPagoTotales()}function buscarEnLista(e){e=e.toLowerCase();var o=listRegistroMaster.filter(o=>-1<o.charbusqueda.indexOf(e)),t=o.length+1||0,a=0,i=0,r=[];o.map(o=>{t--,o.num=xCeroIzq(t),o.des_pago.split(",").map(o=>{const e=o.split("-")[0];var o=0===r.length?null:r.filter(o=>o.id.toLowerCase()===e.toLowerCase())[0];o?o.cantidad++:(o={id:primeraConMayusculas(e.toLowerCase()),cantidad:1},r.push(o))});var e=o.anulado?0:parseFloat(o.total);a+=e,i+=""!==o.comprobante?1:0}),xThisHistVenta.listCantidadPagos=r,xThisHistVenta.importeTotalRegistrado=numeroConComas(a.toFixed(2)),xThisHistVenta.numComprobantesEmitidos=xCeroIzq(i,2)}function xGenerarReporteExcelRegistroPago(){tableToExcel("tbRegistroPago","Registro de Pago")}function xGenerarReporteExcelRegistroPagoDetallado(){data_pagination.pageFecha=""!==p_fecha?p_fecha:xDevolverFecha(),xPopupLoad.xopen();try{$.ajax({type:"POST",url:"../../bdphp/log.php?op=2000101",data:{pagination:data_pagination}}).done(function(o){o=JSON.parse(o);if(o.success){o=o.datos;let t=null;var a=o.length+1||0,e=($("#tbRegistroPagoDetalle thead tr th.th_dynamic").remove(),Object.keys(o[0]).filter(o=>o.startsWith("_")));const i=document.querySelector("#tbRegistroPagoDetalle thead tr");e.forEach(o=>{var e=document.createElement("th");e.textContent=o,e.classList.add("th_dynamic"),i.appendChild(e)});o.map(e=>{a--,e.num=xCeroIzq(a);var o=e.fecha.split(" ");e.fecha_des=o[0],e.hora=o[1],e.us_caja=e.us_caja.split(" ")[0],e.correlativo_dia=e.correlativo_dia.split(","),e.correlativo_dia=e.correlativo_dia.join(" - ");var o=(o=e.nom_usuario.split(",")).map(o=>o.split(" ")[0]),o=(e.nom_usuario=o.join(","),e.nom_usuario_show=e.nom_usuario.split(","),e.nom_usuario_show=e.nom_usuario_show.join(" - "),e.referencia_pedido=e.referencia_pedido===e.nom_cliente?"":e.referencia_pedido,e.anulado="1"===e.estado,e.des_estado=e.anulado?"Anulado":"Cobrado",e.des_consumo="CONSUMIR EN EL LOCAL"===e.des_consumo?"EN LOCAL":e.des_consumo,e.des_comprobante=""===e.comprobante?"":"B"===e.comprobante?"BOLETA":"FACTURA",e.comprobante_serie="",e.comprobante_num="",e.isShowComprobante=""!==e.des_comprobante,e.isShowComprobante&&(o=e.num_comprobante.split("-"),e.comprobante_serie=o[0],e.comprobante_num=o[1]),Object.keys(e).filter(o=>o.startsWith("_")));null===t||t!==e.idregistro_pago?t=e.idregistro_pago:o.forEach(o=>{e[o]=" "}),e.dynamicColumn=[],o.forEach(o=>{e.dynamicColumn.push(e[o])})}),xThisHistVenta.listRegistroPagoExportDetallado=JSON.parse(JSON.stringify(o)),setTimeout(()=>{tableToExcel("tbRegistroPagoDetalle","Registro de Pago Detallado"),xPopupLoad.xclose()},1500)}else xPopupLoad.xclose()})}catch(o){xPopupLoad.xclose()}}function xRegistroPagoReenviarComprobante(o){const e=o.dataId;o=xThisHistVenta.listRegistroPagoFilter.find(o=>o.idregistro_pago===e),o={numero:o.num_comprobante,external_id:o.cpe_external_id};document.getElementById("compDialogSendCPE_RP").open(o)}async function xPermisoChangeTP(o){xThisHistVenta.objChangeTp.idregistro_pago_detalle=o.dataset.id,xThisHistVenta.objChangeTp.idregistro_pago=o.dataset.idregistro_pago,xThisHistVenta.objChangeTp.idtipo_pago_before=o.dataset.idtp,xThisHistVenta.objChangeTp.importe=o.dataset.importe,xThisHistVenta.objChangeTp.descripcion_before=o.dataset.destp,xThisHistVenta.opPermisoPass=1;o=await findStorageSolicudPermisoRemota(xThisHistVenta.objChangeTp.idregistro_pago_detalle,3);o?(xPermisoSupervisor=o.idusuario_admin,xThisHistVenta.objChangeTp.idusuario_admin=o.idusuario_admin,xThisHistVenta.objChangeTp.idpermiso_remoto=o.idpermiso_remoto,xShowChangeMetodoPagoRegistro()):(xCompArraySolitaPermiso={tipo_permiso:3,obj:xThisHistVenta.objChangeTp},pass_us.open())}async function xShowChangeMetodoPagoRegistro(){var o=paramsSwalAlert;return o.title='<p class="fw-600 fs-18">Elige el metodo de pago</p>',o.html=`<div class="pb-2" style="display: inline-flex;">                    
                                    <x-comp-find-tipo-pago-option class="tpf_option_change_rgister"></x-comp-find-tipo-pago-option>
                                </div>`,o.confirmButtonText="Listo, registrar",o.showCancelButton=!0,showAlertSwalHtmlDecision(o,0).then(o=>{o.isConfirmed&&(xThisHistVenta.objChangeTp.idusuario_admin=xPermisoSupervisor,xThisHistVenta.objChangeTp.idtipo_pago_after=xThisHistVenta.idTpSelected.idtipo_pago,(new httpFecht).axiosExecute({type:"POST",url:"../../bdphp/log_010.php?op=change-tipo-pago-registro-pago",data:xThisHistVenta.objChangeTp},!0,!1).then(o=>{o.success&&((o=xThisHistVenta.listRegistroPagoFilter.find(o=>o.idregistro_pago===xidregistro_pago_sel)).listDesPago.descripcion=xThisHistVenta.idTpSelected.descripcion,o.listIconsPago[0].icon=xThisHistVenta.idTpSelected.logo,o.listIconsPago[0].id=xThisHistVenta.idTpSelected.img,xThisHistVenta.listRegistroPagoFilter=JSON.parse(JSON.stringify(xThisHistVenta.listRegistroPagoFilter)),removeStorageSolicitudPermisoRemota(xThisHistVenta.objChangeTp.idpermiso_remoto))}))})}function xRPRemoverPuntoFlotanteVerde(o){o=document.querySelector('#row_tp_pago_detalle[data-id="'+o+'"] .punto-flotante-verde');o&&o.classList.remove("xInvisible")}function showMsjChangeHoraClose(){var o=paramsSwalAlert;o.title='<p class="fw-600 fs-18 text-warning">Hora de cierre</p>',o.html='<p class="fs-16">Para cambiar la hora de cierre vaya a las opciones principales "Datos del sistema / Sede / Variables."</p>',o.confirmButtonText="Entendido",o.showCancelButton=!1,showAlertSwalHtml(o)}Polymer({is:"x-historial_venta",properties:{xdtPedDet:Object,isCierreCaja:Boolean,horaCierre:String,xYaTieneComprobante:boolean=!0,xYaPedidoCerrado:boolean=!0,xIsPuedeReimprimirCPE:boolean=!1,listRegistro:[],importeTotalRegistrado:Number,numComprobantesEmitidos:Number,cantRegistroPagos:Number,listCantidadPagos:[],listCobradoPorFilter:[],listCanalConsumoFilter:[],listAtendidoPorFilter:[],listMetodoPagoFilter:[],listTipoComprobanteFilter:[],listRegistroPagoMaster:[],listRegistroPagoFilter:[],listRegistroPagoFilterTmp:[],listRegistroPagoExportDetallado:[],listRegistroPagoExportDetalladoRowsDynamic:String,opPermisoPass:Number,idTpSelected:{},objChangeTp:{type:Object,value:{idregistro_pago_detalle:"",idregistro_pago:"",descripcion_before:"",descripcion_after:"",idtipo_pago_before:"",idtipo_pago_after:"",importe:"",idusuario_admin:""}}},attached:function(){this.opPermisoPass=0,this.xIsPuedeReimprimirCPE=!1,this.xYaTieneComprobante=!0,this.xYaPedidoCerrado=!0,this.isCierreCaja=!1,this.horaCierre="00:00",xThisHistVenta=this,xIniHistVenta(),setTimeout(()=>{_cpSocketOpen()},1e3)},detached:function(){_cpSocketClose()},displayIndex:function(o){return xCeroIzq(o+1,1)}})</script></dom-module>