<link rel="import" href="../x-componentes/pagination-input/pagination-input.html">
<dom-module id="x-historial_venta">
<script type="text/javascript" src="../view/socket.master.service.js"></script>
<script type="text/javascript" src="../view/socket.service.p.js"></script>
<template>
<x-pass id="pass_us" titulo="Usuario autorizado" valor="Pe1"></x-pass>
<paper-dialog id="dialog_motivo_anular_historial" style="min-width:320px" entry-animation="scale-up-animation" exit-animation="fade-out-animation" with-backdrop>
<div class="xContent">
<h4>ANULAR</h4>
<h4 class="txt_anular_cambiar_mesa"></h4>
<br>
<h4>Indique el motivo de anulacion</h4>
<div>
<input type="text" class="xMiInput" placeholder="Motivo..." id="txt_motivo_anular" autofocus>
</div>
<br><br><br>
<div class="xBoton2 xVerde" dialog-dismiss onclick="pass_us.open()">Listo</div>
<div class="xBoton2 xRojo" dialog-dismiss>Cancelar</div>
<br><br>
</div>
</paper-dialog>
<paper-dialog id="dialog_comprobante" style="min-width:320px" entry-animation="scale-up-animation" exit-animation="fade-out-animation" with-backdrop>
<div class="xContent">
<x-pago id="component_pago"></x-pago>
</div>
</paper-dialog>
<paper-dialog id="dialog_registro_detalle" class="dialog_redondo" style="overflow:auto;overscroll-behavior:auto;min-width:50%;max-width:700px" entry-animation="scale-up-animation" exit-animation="fade-out-animation" with-backdrop>
<div class="mb-2">
<div>
<div class="d-flexx justify-content-between" style="align-items:end">
<div style="zoom:.9">
<paper-button><div class="xMiBoton_icon_lateral2" style="margin-top:-15px;width:90px" onclick="xOpenAnularPedidoHistorial()" id="btn_anular_pedido"><img src="../../images/_delete_pedido.png"><p>Anular pedido</p></div></paper-button>
<paper-button><div class="xMiBoton_icon_lateral2" style="margin-top:-15px;width:100px" onclick="xImprimirPrecuentaHistorial()"><img src="../../images/_pre_cuenta.png"><p>Imprimir pre-cuenta</p></div></paper-button>
<paper-button disabled="[[xYaTieneComprobante]]"><div class="xMiBoton_icon_lateral2" style="margin-top:-15px;width:50px" onclick="xAbrirDialogComprobante()"><img src="../../images/_comprobante.png"><p>Emitir Comprobante</p></div></paper-button>
<paper-button hidden$="[[!xIsPuedeReimprimirCPE]]"><div class="xMiBoton_icon_lateral2" style="margin-top:-15px;width:50px" onclick="reImprimirComprobante()"><img src="../../images/_print_vr.png"><p>Reimprimir Comprobante</p></div></paper-button>
</div>
<button class="btn btn-sm btn-secondary ml-2" dialog-dismiss>X</button>
</div>
<hr>
<label for="txt_comprobante" class="xfont10">Comprobante Emitido:</label>
<p><span id="txt_comprobante" class="xfont20">- </span><span id="txt_ref" class="xfont16 xColorRow_Morado xpadingLateralIz"></span></p>
<div class="xLinea2"></div>
<label for="txt_cliente" class="xfont10">Cliente:</label>
<p><span id="txt_cliente" class="xfont20">- </span><span id="txt_ref" class="xfont16 xColorRow_Morado xpadingLateralIz"></span></p>
<div class="xLinea2"></div><br>
<div class="x_div_linea">
<div>
<label for="txt_mesa" class="xfont10">Mesa:</label>
<p id="txt_mesa" class="xfont20">00</p>
</div>
<div>
<label for="txt_mozo" class="xfont10">Atendido por:</label>
<p id="txt_mozo" class="xfont20"></p>
</div>
<div>
<label for="txt_correlativo" class="xfont10">Correlativo:</label>
<p id="txt_correlativo" class="xfont20" style="white-space:pre-wrap;width:50px">CO-0000</p>
</div>
<div>
<label for="txt_tpc" class="xfont10">Tiempo de atencion:</label>
<p id="txt_tpc" class="xfont20"></p>
</div>
<div>
<label for="txt_cat" class="xfont10"></label>
<p id="txt_cat" class="xfont20">-</p>
</div>
</div>
<div class="xLinea2"></div><br><br>
<div id="xBody"></div>
</div>
</div>
</paper-dialog>
<br>
<div class="xMiCard xradius" style="width:90%;max-width:1450px">
<div class="xEncanezadoCard" style="background:lavenderblush;color:#424242">
<div class="div-content-head-op d-flexx justify-content-between">
<div>
<p class="fs-12 text-secondary">Fecha</p>
<div class="d-flexx">
<input type="date" class="xMiInput" style="width:200px" id="txt_fecha">
</div>
</div>
<div class="d-flexx">
<div class="div-dato-registro">
<p class="fw-600 text-secondary fs-12">Metodos de Pago</p>
<div class="d-flexx justify-content-center">
<template is="dom-repeat" items="{{listCantidadPagos}}" as="item">
<div>
<p class="fs-11 pr-2 m-0">{{item.id}}: <span class="fw-600">{{item.cantidad}} </span></p>
</div>
</template>
</div>
</div>
<div class="div-dato-registro">
<p class="fw-600 text-secondary fs-12">Comprobantes Emitos</p>
<p class="fw-600 text-secondary fs-20">{{ numComprobantesEmitidos }}</p>
</div>
<div class="div-dato-registro">
<p class="fw-600 text-secondary fs-12">Importe Total</p>
<p class="fw-600 text-secondary fs-20"> S/. {{ importeTotalRegistrado }}</p>
</div>
</div>
</div>
</div>
<div class="xContentCard border-bottom" style="padding:20px">
<div class="div-content-grid">
<div>
<div>
<input type="text" class="xMiInput" width="100%" placeholder="Buscar ..." onkeyup="buscarEnLista(this.value)">
</div>
</div>
<br>
<table width="100%">
<thead>
<th>#</th>
<th>Fecha</th>
<th>U. Caja</th>
<th>Canal</th>
<th>Correlativo</th>
<th>Cliente</th>
<th width="15px"></th>
<th>T. Pago</th>
<th align="right" style="min-width:100px">importe</th>
<th></th>
</thead>
<tbody>
<template is="dom-repeat" items="[[listRegistro]]" as="item">
<tr>
<td>
<span class="fw-600 mr-1">
{{item.num}}
</span>
<i class="fa fa-lock" hidden$="[[!item.isCierre]]"></i>
</td>
<td>
<p>{{ item.fecha_des }}</p>
<p>{{ item.hora }}</p>
</td>
<td>
<p class="fs-12">{{ item.us_caja }}</p>
</td>
<td>
<p class="fs-12">{{ item.des_consumo }}</p>
<p class="badge badge-success" hidden$="[[ !item.isScanCodigo ]]">App</p>
</td>
<td>
<p>{{ item.correlativo_dia }}</p>
</td>
<td>
<p class="fs-11">{{ item.nom_cliente }}</p>
<p class="fs-10 text-secondary">{{ item.referencia_pedido }}</p>
</td>
<td>
<span class="badge badge-today">{{ item.des_comprobante }}</span>
</td>
<td>
<div class="d-flexx">
<template is="dom-repeat" items="[[item.listIconsPago]]" as="icon">
<img width="18px" class="mr-1" src$="{{ icon.icon }}" alt="">
</template>
</div>
</td>
<td align="right">
<p class="fw-600 text-info fs-15">S/. {{ item.total }}</p>
</td>
<td>
<button class="xBoton_flat_2 xCursor" onclick="xloadDetallePago(this)" data-id="{{index}}">Ver</button>
</td>
</tr>
</template>
</tbody>
</table>
</div>
</div>
</div>
<br><br>
</template>
<style>.div-dato-registro{border-radius:8px;background:white;padding:5px 15px 5px 15px;text-align:center;border:1px solid #bdbdbd;margin-left:10px}</style>
<script type="text/javascript" src="../view/xJsonSunat.js"></script>
<script type="text/javascript" src="../view/deNumALetras.js"></script>
<script type="text/javascript" src="../view/item_pedido_estructura.js"></script>
<script type="text/javascript" src="../view/item_pedido_print_comprobante.js"></script>
<script type="text/javascript" src="../view/cpe_interno.js"></script>
<script type="text/javascript" src="../view/item_pedido_subtotales.js"></script>
<style>.verIconFacturado img{visibility:hidden}</style>
<script>/*<![CDATA[*/var xThisHistVenta;var xfecha_historial='';var xArrayTpC=[];var xArraySeccion_r=[];var xArrayDtOrdenFiltro=[];var xTotalItemSel;var xidregistro_pago_sel;var xDtPrint,xPSupervisor,xEstado_registro_pago=0,xhtml_anulado='',xdt_h=[],arrSumSubtTotales=[],xRpt_pago=[],index_historial,x_icon_facturado,xdt_pdE,listRegistroMaster;var data_pagination={},p_rows=0,p_fecha='';function xIniHistVenta(){xPopupLoad=document.getElementById('xLoad');x_icon_facturado='<img src="../../images/_comprobante.png" title="se emitio comprobante" width="16px">';xm_LogChequea(function(){xm_log_get('ini_us');$("#Titulo_page").text("Registro de pagos");$('body').addClass('loaded');xDtPrint=xm_log_get('sede_generales');xloadHistorial();})
$("#txt_fecha").on('change',function(){var d=$(this).val().split('-');xfecha_historial=d[2]+'/'+d[1]+'/'+d[0];p_fecha=xfecha_historial;xloadHistorial();})
$("#dialog_motivo_anular_historial").on('iron-overlay-closed',function(){$("#txt_motivo_anular").focus();})
$("#dialog_motivo_anular_historial #txt_motivo_anular").keyup(function(e){if(e.keyCode==13){dialog_motivo_anular_historial.close();pass_us.open();}})
xPSupervisor=document.getElementById('pass_us');xPSupervisor.setVal('Pe1');xPSupervisor.addEventListener('xSend',function(e){var p=e.detail.xRpts[0].p;if(p===1){xPermisoSupervisor=e.detail.xRpts[0].us;xCronometro_us=30;xRefreshPermiso=setInterval(function(){xcronometro_permiso()},1000);xAnularPedidoHistorial();}});xValPago=document.getElementById('component_pago');xValPago.addEventListener('xSend',function(e){xRpt_pago=e.detail.xRpts;var p=e.detail.xRpts[0].ok;if(p!=0){if(e.detail.xRpts[0].paseEnterTxt==1){xRegistrarClientePagoCP();}}});xValPago.addEventListener('xCancelarCerrar',function(e){xThisHistVenta.$.dialog_comprobante.close()});xValPago.addEventListener('xListoRegistraPago',function(e){xMandarCocinarImpresionComprobante_historial();});}
function xAbrirDialogComprobante(){xThisHistVenta.$.dialog_comprobante.open();}
function xOpenAnularPedidoHistorial(){dialog_motivo_anular_historial.open();}
function xAnularPedidoHistorial(){var xArrayAnularItems=[];$("#tb_det_pedidos .row").each(function(index,element){xidpedid_txt_change=xidpedid_txt_change+','+$(element).attr('data-idpedido');;})
xidpedid_txt_change=xidpedid_txt_change.slice(1);xPopupLoad.xopen();$.ajax({type:'POST',url:'../../bdphp/log.php?op=5011',data:{ArrayPeAnular:'',xPedidos:xidpedid_txt_change,xMotivo:$("#txt_motivo_anular").val(),'u':xPermisoSupervisor,'viene_historial':xidregistro_pago_sel}}).done(function(dt_xx){xPopupLoad.xclose();$(".xMiBoton_icon_lateral").attr('disabled',true);xloadHistorial();})}
function xloadHistorial(){xPopupLoad.titulo='Cargando...';xPopupLoad.xopen();data_pagination.pageFecha=p_fecha!==''?p_fecha:xDevolverFecha();let xDataRes=[];$.ajax({type:'POST',url:'../../bdphp/log.php?op=20001',data:{pagination:data_pagination}}).done(function(res){res=JSON.parse(res);xdt_h=res.datos;var xNumRegistro=xdt_h.length+1||0;var listTipoPago=[],importeTotalRegistrado=0,numTotalComprobantes=0;xdt_h.map((x,index)=>{const _fecha=x.fecha.split(' ');var _listIconsPago=[];x.isFacturaEmitido=x.idce!==null;x.isPedidoApp=parseInt(x.app)===1;x.isScanCodigo=parseInt(x.scan_qr)!==0;x.isCierre=parseInt(x.cierre)!==0;x.icon_pago.split(',').map(i=>{_listIconsPago.push({icon:`../../images/${i}`})});x.listIconsPago=_listIconsPago;x.referencia_pedido=x.referencia_pedido===x.nom_cliente?'':x.referencia_pedido;x.fecha_des=_fecha[0];x.hora=_fecha[1];x.des_comprobante=x.comprobante===''?'':x.comprobante==='B'?'Boleta':'Factura';x.charbusqueda=`${x.us_caja}${x.correlativo_dia}${x.des_pago}${x.des_consumo}${x.nom_usuario}${x.nom_cliente}${x.referencia_pedido}${x.total}${x.des_comprobante}`;x.charbusqueda=x.charbusqueda.toLowerCase();x.des_pago.split(',').map(t=>{const ishayTP=listTipoPago.length===0?null:listTipoPago.filter(x=>x.id.toLowerCase()===t.toLowerCase())[0];if(ishayTP){ishayTP.cantidad++;}else{const _rowTPC={id:primeraConMayusculas(t.toLowerCase()),cantidad:1};listTipoPago.push(_rowTPC);}});importeTotalRegistrado=importeTotalRegistrado+parseFloat(x.total);numTotalComprobantes+=x.comprobante!==''?1:0;xNumRegistro--;x.num=xCeroIzq(xNumRegistro);});listRegistroMaster=xdt_h;xThisHistVenta.listRegistro=listRegistroMaster;xThisHistVenta.listCantidadPagos=listTipoPago;xThisHistVenta.importeTotalRegistrado=numeroConComas(importeTotalRegistrado.toFixed(2));xThisHistVenta.numComprobantesEmitidos=xCeroIzq(numTotalComprobantes,5);xPopupLoad.xclose();});}
function xloadDetallePago(obj){xPopupLoad.xopen();$("#tb_historial tr").removeClass('xitem_seleccionado_li');const _indexRow=obj.dataId;const rowItem=xThisHistVenta.listRegistro[_indexRow];index_historial=_indexRow;xidregistro_pago_sel=rowItem.idregistro_pago;xEstado_registro_pago=rowItem.estado;xTotalItemSel=rowItem.total;xThisHistVenta.$.component_pago.setVal(xMoneda(xTotalItemSel));xValPago.setModoSoloComprobante();xhtml_anulado='';$(".xMiBoton_icon_lateral").attr('disabled',false);if(xEstado_registro_pago===1){xhtml_anulado='<h3 class="xColorRow_Rojo xBold">ANULADO</h3><div class="xLinea"></div><br><h4><strong>'+xmotio_anular.toUpperCase()+'</strong></h4>';$(".xMiBoton_icon_lateral").attr('disabled',true);}
$.ajax({type:'POST',url:'../../bdphp/log.php?op=20002',data:{i:xidregistro_pago_sel}}).done(function(dt_pdE){xdt_pdE=$.parseJSON(dt_pdE);if(!xdt_pdE.success){xPopupLoad.xclose();alert(xdt_pdE.error);return;}
xdt_pdE=xdt_pdE.datos[0];var comprobanteEmitido=xdt_pdE.num_comprobante;$("#txt_comprobante").text(comprobanteEmitido);xThisHistVenta.xYaTieneComprobante=xdt_pdE.idce===null?false:true;xThisHistVenta.xYaPedidoCerrado=xdt_pdE.cerrado==='1';xThisHistVenta.xIsPuedeReimprimirCPE=!xThisHistVenta.xYaPedidoCerrado&&xThisHistVenta.xYaTieneComprobante;$("#txt_cliente").text(xdt_pdE.cliente);$("#txt_mesa").text(xdt_pdE.nummesa);$("#txt_mozo").text(xdt_pdE.usuario);$("#txt_correlativo").text(xdt_pdE.correlativo_dia);$("#xBody div").remove();$("#xBody").append('<div><paper-spinner active class="xCentradoVerticalHorizontal"></paper-spinner></div>').trigger('create');$.ajax({type:'POST',url:'../../bdphp/log.php?op=2003',data:{i:xidregistro_pago_sel}}).done(function(dtPbdet){var xdtPbdet=$.parseJSON(dtPbdet);xArrayDtOrdenFiltro=xdtPbdet.datos;xThisHistVenta.xdtPedDet=xArrayDtOrdenFiltro;xLoadMipedidoBDHistorial(xArrayDtOrdenFiltro)})
setTimeout(()=>{xPopupLoad.xclose();dialog_registro_detalle.open();},800);})}
function xLoadMipedidoBDHistorial(dt){var xTpConsumo='';var xCadenaItemArray_h='';var xEncabezadoCollapse='';var xCadenaCollapse='';xArrayTpC=new Array();xArraySeccion_r=new Array();var xIdColapse='';var xCadenaGrupo_r='';var xIndicacionItem='';var xNom_seccion;var xDtBd=dt;var xdisabled_btn_cambiar='';var xdisabled_procede='';for(a in xDtBd){if(xArrayTpC[xDtBd[a].idtipo_consumo]==null){xArrayTpC[xDtBd[a].idtipo_consumo]={'id':xDtBd[a].idtipo_consumo,'des':xDtBd[a].des_tp}}}
var xNom_seccion_b='';for(b in xArrayTpC){xCadenaItemArray_h='';xEncabezadoCollapse='';xCadenaCollapse='';xIndicacionItem='';xArraySeccion_r=new Array();for(i in xDtBd){if(xArrayTpC[b].id==xDtBd[i].idtipo_consumo){xNom_seccion=xDtBd[i].des_seccion;if(xArraySeccion_r[xDtBd[i].idseccion_index]==null){xArraySeccion_r[xDtBd[i].idseccion_index]='<tr><td colspan="5" class="xBold">'+xNom_seccion+'</td></tr>';}
xCadenaItemArray_h=String('<tr class="row" data-i="'+i+'" data-idpedidodetalle="'+xDtBd[i].idpedido_detalle+'" data-idpedido="'+xDtBd[i].idpedido+'" data-idtipoconsumo="'+xDtBd[i].idtipo_consumo+'">'+'<td width="7px" class="click_row_dt_p" id="td_cant">'+xCeroIzq(xDtBd[i].cantidad,2)+'</td>'+'<td class="click_row_dt_p" width="50%">'+xDtBd[i].descripcion+'</td>'+'<td class="click_row_dt_p" align="right" id="td_importe">'+xMoneda(xDtBd[i].ptotal)+'</td>'+'</tr>');xArraySeccion_r[xDtBd[i].idseccion_index]=xArraySeccion_r[xDtBd[i].idseccion_index]+xCadenaItemArray_h;}}
xEncabezadoCollapse='<tr><td colspan="5" class="xFondoRowBlanco xBold">'+xArrayTpC[b].des+'</td></tr>';for(a in xArraySeccion_r){xCadenaCollapse=String(xCadenaCollapse+xArraySeccion_r[a]);};xCadenaGrupo_r=String(xCadenaGrupo_r+xEncabezadoCollapse+xCadenaCollapse);}
xCadenaGrupo_r='<div><table width="100%" id="tb_det_pedidos" class="xRowPading4">'+xCadenaGrupo_r+'</table></div>';$("#xBody div").remove();$("#xBody").html(xCadenaGrupo_r).trigger('create');xSumarTotalesHis();}
function xSumarTotalesHis(){var xcadena_total='';$.ajax({type:'POST',url:'../../bdphp/log.php?op=2005',data:{i:xidregistro_pago_sel}}).done(function(dt_subt){var xdt_subt=$.parseJSON(dt_subt);if(!xdt_subt.success){xPopupLoad.xclose();alert(xdt_subt.error);return;}
xdt_subt=xdt_subt.datos
arrSumSubtTotales=xdt_subt;for(var i=0;i<xdt_subt.length;i++){const classTachado=parseInt(xdt_subt[i].tachado)===1?'xTachar':'';xcadena_total=String(xcadena_total+'<tr class="'+classTachado+'"><td>'+xdt_subt[i].descripcion.toUpperCase()+'</td><td align="right">'+xdt_subt[i].importe+'</td></tr>');}
xcadena_total=String(xcadena_total+'<tr><td colspan="2" align="left"><h4>FORMA DE PAGO</h4></td></tr>');$.ajax({type:'POST',url:'../../bdphp/log.php?op=2004',data:{i:xidregistro_pago_sel}}).done(function(dt_tpp){var xdt_tpp=$.parseJSON(dt_tpp);if(!xdt_tpp.success){xPopupLoad.xclose();alert(xdt_tpp.error);return;}
xdt_tpp=xdt_tpp.datos;for(var i=0;i<xdt_tpp.length;i++){xcadena_total=String(xcadena_total+'<tr><td>'+xdt_tpp[i].tipo_pago+'</td><td align="right">'+xdt_tpp[i].importe+'</td></tr>');};xcadena_total='<div class="d-flexx justify-content-end mb-2"><table width="30%" id="tb_totales" class="xRowPading4">'+xcadena_total+'</table></div><br>'+xhtml_anulado;$("#xBody").append(xcadena_total).trigger('create');})})}
function xMandarCocinarImpresionComprobante_historial(){var arr_cliente=xRpt_pago[0].cliente;var arr_comprobante=xRpt_pago[0].comprobante;const arrayItems=xCargarDatosAEstructuraImpresion(xThisHistVenta.xdtPedDet);xPopupLoad.xopen();$.ajax({type:'POST',url:'../../bdphp/log_001.php',data:{p_from:'fe',p_comprobante:arr_comprobante,idregistro_pago:xidregistro_pago_sel}}).done(function(xrpt_correlativo){const _arrRpt=xm_all_SetResponseLog_001(xrpt_correlativo);arr_comprobante.correlativo=xCeroIzqNumComprobante(_arrRpt.correlativo_comprobante);xCocinarImprimirComprobante(arrayItems,arrSumSubtTotales,arr_comprobante,arr_cliente,xidregistro_pago_sel,-2);xThisHistVenta.xYaTieneComprobante=true;xdt_h[index_historial].idtipo_comprobante=arr_comprobante.idtipo_comprobante;$("#row_historial"+index_historial).append(x_icon_facturado);xThisHistVenta.$.dialog_comprobante.close();xPopupLoad.xclose();})}
function xImprimirPrecuentaHistorial(){var xArrayItemPreCuenta=[];var xDtBd=xArrayDtOrdenFiltro;xArrayItemPreCuenta=xArrayTpC.slice();xArrayItemPreCuenta=JSON.parse(JSON.stringify(xArrayItemPreCuenta));for(b in xArrayTpC){for(var i in xDtBd){if(xArrayTpC[b].id==xDtBd[i].idtipo_consumo){if(xDtBd[i].visible==1){continue;}
if(xArrayTpC[b]==null){continue}
xDtBd[i].precio_print=xDtBd[i].ptotal;xDtBd[i].des=xDtBd[i].descripcion;xArrayItemPreCuenta[xArrayTpC[b].id][i]=xDtBd[i];}}};var xmesa_pc=$("#txt_mesa").text();var xmunp_pc=$("#txt_correlativo").text();xmunp_pc=xmunp_pc.split('-');xmunp_pc=xmunp_pc[1];xArrayPrintEncaLi_pre_cuenta={'m':xmesa_pc,'r':'','num_pedido':xmunp_pc,'reservar':0,'solo_llevar':0,'correlativo_dia':xmunp_pc,'precuenta':true};xMandarImprimirOtroDoc(xArrayPrintEncaLi_pre_cuenta,xDtPrint,xArrayItemPreCuenta,arrSumSubtTotales,-1);}
function reImprimirCierre(){xPopupLoad.xopen()
fecha=xDevolverFechaFormatInputDate(txt_fecha.value);$.ajax({type:'POST',url:'../../bdphp/log_005.php?op=17',data:{f:fecha}}).done(function(res){setTimeout(()=>{xPopupLoad.xclose()},1500);});}
function reImprimirComprobante(){xPopupLoad.xopen()
const _cpe=xdt_pdE.num_comprobante;$.ajax({type:'POST',url:'../../bdphp/log_005.php?op=1702',data:{comprobante:_cpe}}).done(function(res){var _detalle_json=JSON.parse(res).datos;_detalle_json=_detalle_json.length>0?_detalle_json[0]:_detalle_json;const rowItem=xThisHistVenta.listRegistro[index_historial];const _dataPrint={detalle_json:_detalle_json.detalle_json,idprint_server_detalle:_detalle_json.idprint_server_detalle+new Date().getMilliseconds(),hora:xDevolverHora(),nomUs:rowItem.nom_usuario,nom_documento:"comprobante"}
_cpSocketprinterOnly(_dataPrint);setTimeout(()=>{xPopupLoad.xclose()},1500);});}
function buscarEnLista(val){val=val.toLowerCase();const _listBusqueda=listRegistroMaster.filter(x=>x.charbusqueda.indexOf(val)>-1)
var _numRegisterBusqueda=_listBusqueda.length+1||0;var importeTotalRegistrado=0,numTotalComprobantes=0,listTipoPago=[];_listBusqueda.map(x=>{_numRegisterBusqueda--;x.num=xCeroIzq(_numRegisterBusqueda);x.des_pago.split(',').map(t=>{const ishayTP=listTipoPago.length===0?null:listTipoPago.filter(x=>x.id.toLowerCase()===t.toLowerCase())[0];if(ishayTP){ishayTP.cantidad++;}else{const _rowTPC={id:primeraConMayusculas(t.toLowerCase()),cantidad:1};listTipoPago.push(_rowTPC);}});importeTotalRegistrado=importeTotalRegistrado+parseFloat(x.total);numTotalComprobantes+=x.comprobante!==''?1:0;})
xThisHistVenta.listRegistro=_listBusqueda;xThisHistVenta.listCantidadPagos=listTipoPago;xThisHistVenta.importeTotalRegistrado=numeroConComas(importeTotalRegistrado.toFixed(2));xThisHistVenta.numComprobantesEmitidos=xCeroIzq(numTotalComprobantes,5);}
Polymer({is:'x-historial_venta',properties:{xdtPedDet:Object,isCierreCaja:Boolean,xYaTieneComprobante:boolean=true,xYaPedidoCerrado:boolean=true,xIsPuedeReimprimirCPE:boolean=false,listRegistro:[],importeTotalRegistrado:Number,numComprobantesEmitidos:Number,listCantidadPagos:[]},attached:function(){this.xIsPuedeReimprimirCPE=false;this.xYaTieneComprobante=true;this.xYaPedidoCerrado=true;this.isCierreCaja=false;xThisHistVenta=this;xIniHistVenta();setTimeout(()=>{_cpSocketOpen();},1000);},detached:function(){_cpSocketClose();},displayIndex:function(index){return xCeroIzq(index+1,1);}})/*]]>*/</script>
</dom-module>