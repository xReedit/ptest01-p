<dom-module id="x-subrecetas"><link rel="import"href="../../x-componentes/x-comp-find-producto-almacen/x-comp-find-producto-almacen.html"><template><paper-dialog id="dialog_detalle_subreceta"class="dialog_redondo"style="max-width:900px"entry-animation="scale-up-animation"exit-animation="fade-out-animation"with-backdrop><div class="xContent"><p class="xfont11"><strong>Subrecetas</strong> son componentes reutilizables que pueden incluirse en varias recetas. Ejemplo: "Cuarto de pollo" puede usarse en "Combo familiar" y "Promo 2x1".<div class="xLinea2"></div><br><div class="x_div_linea"><div class="xitem1 xBordeDe"><h3 id="xdes_subreceta_titulo"class="xInvisible">Nueva subreceta</h3><table class="xtable4"id="tb_subreceta"><tr id="tr_des_subreceta"><td>Descripción<td colspan="2"><input class="xMiInput xPasarEnter2 xfont18"style="width:100%"onchange="conMayusculas(this)"placeholder="Nombre de la subreceta"id="txt_descripcion_sub"espaciar><tr><td>Costo fijo<td colspan="2"><input class="xMiInput xPasarEnter2 xfont18"style="width:50%"placeholder="Costo"id="txt_costo_sub"onblur="xRetornaMoneda(this)"espaciar><tr><td>Costo calculado<td colspan="2"><input class="xMiInput xPasarEnter2 xfont18"style="width:50%"placeholder="Costo calculado"id="txt_costo_calculado"espaciar disabled="disabled"></table><div class="xInvisible"><form id="frm_subreceta"method="post"action="#"><input id="idsubreceta"name="idsubreceta"> <input id="idorg"name="idorg"> <input id="idsede"name="idsede"> <input id="descripcion"name="descripcion"> <input id="costo"name="costo"></form></div></div><div class="xitem3"style="width:100%!important"><p class="fs-17 fw-600">Ingredientes de la subreceta<p style="font-size:11px;line-height:1.4;font-weight:600">Activa el check para indicar que el ingrediente es necesario. Si este ingrediente se queda sin stock, los platos que usen esta subreceta quedarán sin stock.</p><br><div><p class="text-secondary fs-10">Desde:</p><select class="selected-template-1"id="select_tipo_ingrediente"onchange="xoptionTipoSeletedSubreceta(this)"><option value="1">Porcion<option value="2">Producto</select></div><table class="xtable4 w-100"id="tb_ingredientes_sub"data-tablaname="subreceta_ingrediente"><thead><td class="xSinBorde"width="5px"><th class="xSinBorde"width="50%"><th class="xSinBorde"width="20px"><th class="xSinBorde"width="10px"><th class="xSinBorde"width="10px"></thead><tr class="xSinBorde"data-id=""><td colspan="2"><input hidden$="[[isFromProducto]]"class="xMiInput xPasarEnter2 xDesItem"placeholder="Buscar porción"onchange="conMayusculas(this)"required id="des_porcion_sub"><x-comp-find-producto-almacen id="compProductoAlmacenSubreceta"hidden$="[[!isFromProducto]]"placeholder="Producto"onlynomalmacen=""appendtocmp="#dialog_detalle_subreceta"></x-comp-find-producto-almacen><td><div><p style="margin-top:-28px;text-align:center;line-height:1.2em"class="fs-10"hidden="[[!isProductoConversion]]">Cantidad en: <span class="text-success w-50"><strong>{{undConvercion.unidad}}</strong></span><p></p><input type="number"class="xMiInput xPasarEnter2 text-center"placeholder="Cant"on-keyup="calcCostoConversionSub"id="cant_item_sub"required></div><td><input type="number"class="xMiInput text-center"placeholder="Costo"id="costo_item_sub"readonly$="[[isProductoConversion]]"required><td><paper-fab icon="add"onclick="xAddIngredienteSubreceta()"title="Agregar ingrediente"class="xmini"></paper-fab></table></div></div></div><br><div class="xLinea2"></div><br><br><div class="xContent"><div class="xBoton2 xAzul"onclick="xGuardarSubreceta()">Listo, guardar</div><div class="xBoton2 xPlomo"dialog-dismiss>Cancelar</div></div><br></paper-dialog><br><div class="xMiCard xradius"style="width:80%"><div class="xEncanezadoCard xFondoRowAmarillo4"><p>Define <strong>subrecetas reutilizables</strong> que pueden incluirse en varias recetas.<p>Ejemplo: "Cuarto de pollo" puede usarse en "Combo familiar", "Promo 2x1", etc.</div><div class="xContentCard"><div class="d-flexx justify-content-between"><h3>Listado de subrecetas</h3><div class="xBoton2 xVerde xDerecha"onclick="xNuevaSubreceta()">Nueva subreceta</div></div><br><input class="xMiInput"placeholder="Buscar..."style="width:100%"id="txt_bus_sub"onkeyup="xBuscarSubreceta()"><br><br><br><table class="sortable"width="100%"id="tb_subrecetas"><thead><tr><th width="70%"class="xCursor">Descripción<th width="15%"align="right"class="xCursor">Costo<th width="15%"align="center">Acciones<tbody id="tbody_subrecetas"></table></div><br><br></div></template><style>.ui-autocomplete{z-index:9999!important;max-height:200px;overflow-y:auto;overflow-x:hidden}</style></dom-module><script>var xThisSub,xidporcion_sub=0,xtt_ingredientes_sub=0,xes_nueva_subreceta=0,xid_subreceta="";function xIniSubrecetas(){xPopupLoad=document.getElementById("xLoad"),xm_LogChequea(function(){xm_log_get("ini_us"),$("body").addClass("loaded"),$("#Titulo_page").text("Subrecetas"),$("#tb_subrecetas tbody").append('<tr class="row"><td colspan="3"><paper-spinner active></paper-spinner></td></tr>').trigger("create"),xListaDeSubrecetas(),xloadDataSubrecetas()}),$(".xPasarEnter2").on("keyup",function(e){var t=e.which;if(13==t||186==t){var t=$("input"),a=t.index(document.activeElement);if(null!==t[a+1]){var i=t[a+1];if(void 0===i)return;if(null==(i=i.disabled?t[a+2]:i))return;i.focus(),i.select()}return event.stopPropagation(),e.stopPropagation(),e.stopImmediatePropagation(),!1}}),$("#costo_item_sub").on("keyup",function(e){e=e.which;13!=e&&186!=e||xAddIngredienteSubreceta()}),$("#txt_bus_sub").on("keyup",function(){xBuscarTbData($("#tb_subrecetas"),$(this).val())}),$("#cant_item_sub").on("keyup",function(){var e,t;xThisSub.isFromProducto||(t=$("#costo_item_sub").val(),e=$("#cant_item_sub").val(),t=parseFloat(t)*parseFloat(e),isNaN(t)&&(t=0),t=parseFloat(t).toFixed(2),$("#costo_item_sub").val(t))}),document.getElementById("compProductoAlmacenSubreceta").addEventListener("productoSeleted",function(e){e=e.detail;xThisSub.isProductoConversion="1"===e.para_receta,xThisSub.isProductoConversion&&$.ajax({type:"POST",url:"../../../bdphp/log_010.php?op=get-und-conversion-by-id",contentType:"application/json",data:JSON.stringify({id:e.idunidad_conversion})}).done(function(e){e=JSON.parse(e);xThisSub.undConvercion=e.datos[0]}),xThisSub.productoSeleted=e})}function xNuevaSubreceta(){xes_nueva_subreceta=1,xLimpiarFormSubreceta(),$("#tr_des_subreceta").removeClass("xInvisible"),$("#xdes_subreceta_titulo").addClass("xInvisible"),dialog_detalle_subreceta.open()}function xLimpiarFormSubreceta(){$("#tb_ingredientes_sub .row").remove(),$("#tb_ingredientes_sub .row_tt").remove(),$("#frm_subreceta")[0].reset(),$("#txt_descripcion_sub").val(""),$("#txt_costo_sub").val(""),$("#txt_costo_calculado").val(""),$("#des_porcion_sub").val(""),$("#cant_item_sub").val(""),$("#costo_item_sub").val(""),xtt_ingredientes_sub=0,xid_subreceta="",xThisSub.listIngredientes=[],dialog_detalle_subreceta.close()}function xAbrirDetalleSubreceta(e){xLimpiarFormSubreceta(),xid_subreceta=$(e).attr("data-id"),xes_nueva_subreceta=0;var t=$(e).find("#xtr_des").text().trim();$("#tr_des_subreceta").addClass("xInvisible"),$("#xdes_subreceta_titulo").removeClass("xInvisible"),$("#xdes_subreceta_titulo").text(t),$("#txt_descripcion_sub").val(t),$("#txt_costo_sub").val($(e).find("#xtr_costo").text()),$("#tb_ingredientes_sub").append('<tr class="row"><td colspan="4"><paper-spinner active></paper-spinner></td></tr>').trigger("create"),$.ajax({type:"POST",url:"../../bdphp/log_subrecetas.php?op=get_ingredientes",data:{id:xid_subreceta}}).done(function(e){var t="",a=e.datos;xThisSub.listIngredientes=[];for(var i=0;i<a.length;i++)var o=a[i].idsubreceta_ingrediente,r={idsubreceta_ingrediente:a[i].idsubreceta_ingrediente,idsubreceta:a[i].idsubreceta,descripcion:a[i].descripcion,cantidad:a[i].cantidad_show,costo:a[i].costo,idporcion:a[i].idporcion,idproducto_stock:a[i].idproducto_stock,viene_de:a[i].viene_de,necesario:a[i].necesario,und_medida:a[i].und_medida,idrow:o,new:0,borrado:0,modificado:0},r=(xThisSub.listIngredientes.push(r),"1"==a[i].necesario?"checked":""),t=String(t+'<tr class="row" data-id="'+o+'"><td colspan="2" data-ColumName="descripcion"><paper-checkbox class="m-0" '+r+' onchange="xIngredienteNecesarioSub(this)"></paper-checkbox>'+a[i].descripcion+'</td><td align="center" data-ColumName="cantidad">'+a[i].cantidad_show+a[i].und_medida+'</td><td align="right" data-ColumName="costo" class="row_costo">'+a[i].costo+'</td><td><span class="xDeleteRowNeutro" title="Borrar" onclick="xBorrarIngredienteSub(this);"></span></td><td data-ColumName="idporcion" class="xInvisible">'+a[i].idporcion+'</td><td data-ColumName="idproducto_stock" class="xInvisible">'+a[i].idproducto_stock+'</td><td data-ColumName="viene_de" class="xInvisible">'+a[i].viene_de+'</td><td class="xInvisible" data-ColumName="necesario" id="td_necesario">'+a[i].necesario+"</td></tr>");$("#tb_ingredientes_sub .row").remove(),$("#tb_ingredientes_sub").append(t).trigger("create"),xSumarIngredientesSub()}),dialog_detalle_subreceta.open()}function xloadDataSubrecetas(){$.ajax({type:"POST",url:"../../bdphp/log.php?op=1701"}).done(function(e){e=$.parseJSON(e);xThisSub.dtPorciones=e.datos,xCargarPorcionesTxtSub()}).fail(function(e){})}function xGuardarSubreceta(){xPopupLoad.xopen();var e=1==xes_nueva_subreceta?$("#txt_descripcion_sub").val():$("#xdes_subreceta_titulo").text(),t=$("#txt_costo_sub").val()||"0.00";""===e.trim()?(xPopupLoad.xclose(),alert("Ingrese una descripción para la subreceta")):(e={idsubreceta:xid_subreceta,descripcion:e,costo:t,idorg:xIdOrg,idsede:xIdSede,ingredientes:xThisSub.listIngredientes},$.ajax({type:"POST",url:"../../bdphp/log_subrecetas.php?op=guardar",data:{data:JSON.stringify(e)}}).done(function(e){xPopupLoad.xclose(),xLimpiarFormSubreceta(),xListaDeSubrecetas()}))}function xAddIngredienteSubreceta(){var e,t=$("#des_porcion_sub").val(),a=$("#costo_item_sub").val(),i=$("#cant_item_sub").val(),o=xThisSub.isFromProducto&&xThisSub.undConvercion?xThisSub.undConvercion.abreviatura:"",r=document.getElementById("compProductoAlmacenSubreceta").getProductoSeletedAlmacen(),s=xThisSub.isFromProducto?"2":"1",n=xThisSub.isFromProducto?r.value:0,t=xThisSub.isFromProducto?r.label:t;let d=i;xThisSub.isFromProducto&&xThisSub.undConvercion&&(r=calcularCantidadDescuentoSub(i,xThisSub.undConvercion,r),d=r.cantidadDescontar),!isNaN(d)&&isFinite(d)||(d=i),xidporcion_sub=xThisSub.isFromProducto?0:xidporcion_sub,""!=t&&""!=a&&(a=parseFloat($("#costo_item_sub").val()).toFixed(2),r=Date.now(),e={idsubreceta_ingrediente:0,idsubreceta:xid_subreceta,descripcion:t,cantidad:d,cantidad_show:i,costo:a,idporcion:xidporcion_sub,idproducto_stock:n,viene_de:s,necesario:1,idrow:r,new:1,borrado:0,modificado:0,und_medida:o},xThisSub.listIngredientes.push(e),e='<tr class="row" data-id="'+r+'"><td colspan="2" data-ColumName="descripcion"><paper-checkbox checked onchange="xIngredienteNecesarioSub(this)"></paper-checkbox>'+t+'</td><td align="right" data-ColumName="cantidad">'+i+o+'</td><td align="right" data-ColumName="costo" class="row_costo">'+a+'</td><td><span class="xDeleteRowNeutro" title="Borrar" onclick="xBorrarIngredienteSub(this);"></span></td><td data-ColumName="idporcion" class="xInvisible">'+xidporcion_sub+'</td><td data-ColumName="idproducto_stock" class="xInvisible">'+n+'</td><td data-ColumName="viene_de" class="xInvisible">'+s+'</td><td class="xInvisible" data-ColumName="necesario" id="td_necesario">1</td></tr>',$("#tb_ingredientes_sub").append(e).trigger("create"),xSumarIngredientesSub(),$("#des_porcion_sub").val(""),$("#costo_item_sub").val(""),$("#cant_item_sub").val(""),$("#des_porcion_sub").focus())}function calcularCantidadDescuentoSub(e,t,a){var i;return isNaN(e)||e<=0?{error:!0,cantidadDescontar:0}:!t||!(a=parseFloat(a.factor_conversion)||0)||a<=0||(i=e/a,isNaN(i))||!isFinite(i)?{error:!0,cantidadDescontar:e}:{error:!1,cantidadDescontar:parseFloat(i.toFixed(4)),unidadReceta:t.abreviatura,factorConversion:a}}function xBorrarIngredienteSub(e){var e=$(e).parent().parent(),t=e.attr("data-id"),a=xThisSub.listIngredientes.find(e=>e.idrow==t);a&&(a.borrado=1),e.fadeTo(550,0,function(){$(this).remove(),xSumarIngredientesSub()})}function xIngredienteNecesarioSub(e){var t=e.checked?1:0,a=$(e).parent().parent().attr("data-id"),i=xThisSub.listIngredientes.find(e=>e.idrow==a);i&&(i.necesario=t,i.modificado=1),$(e).parents("tr").find("#td_necesario").text(t)}function xSumarIngredientesSub(){xtt_ingredientes_sub=parseFloat(xSumaCantRow($("#tb_ingredientes_sub"),".row_costo")).toFixed(2),$("#tb_ingredientes_sub .row_tt").remove(),$("#tb_ingredientes_sub").append('<tr class="row_tt"><td align="right" colspan="4"><strong>'+xtt_ingredientes_sub+"</strong></td><td></td></tr>").trigger("create"),$("#txt_costo_calculado").val(xtt_ingredientes_sub)}function xCargarPorcionesTxtSub(){var a=$("#des_porcion_sub");a.hasClass("ui-autocomplete-input")&&a.autocomplete("destroy"),a.autocomplete({autoFocus:!0,source:xThisSub.dtPorciones,appendTo:"#dialog_detalle_subreceta",minLength:0,select:function(e,t){return a.val(t.item.label),a.attr("data-id",t.item.value),xidporcion_sub=t.item.value,$("#costo_item_sub").val(t.item.precio_unitario),$("#cant_item_sub").val(1),!1},focus:function(e,t){return!1},change:function(e,t){return null===t.item&&(a.attr("data-value",""),a.attr("data-id",""),xidporcion_sub=0,$("#costo_item_sub").val(""),$("#cant_item_sub").val(1)),!1}})}function xListaDeSubrecetas(){$.ajax({type:"POST",url:"../../bdphp/log_subrecetas.php?op=listar"}).done(function(e){for(var t="",a=e.datos,i=0;i<a.length;i++)t=String(t+'<tr class="row xCursor" data-id="'+a[i].idsubreceta+'" onclick="xAbrirDetalleSubreceta(this)"><td id="xtr_des">'+a[i].descripcion+'</td><td align="right" id="xtr_costo">'+a[i].costo+'</td><td align="center"><span class="xDeleteRow" title="Eliminar" onclick="event.stopPropagation(); xEliminarSubreceta('+a[i].idsubreceta+');"></span></td></tr>');$("#tb_subrecetas .row").remove(),$("#tb_subrecetas tbody").append(t).trigger("create")})}function xEliminarSubreceta(e){confirm("¿Está seguro de eliminar esta subreceta?")&&$.ajax({type:"POST",url:"../../bdphp/log_subrecetas.php?op=eliminar",data:{id:e}}).done(function(e){xListaDeSubrecetas()})}function xBuscarSubreceta(){xBuscarTbData($("#tb_subrecetas"),$("#txt_bus_sub").val())}function xoptionTipoSeletedSubreceta(e){e=e.value;xThisSub.isFromProducto="2"==e,xThisSub.isProductoConversion=!1}Polymer({is:"x-subrecetas",properties:{dtPorciones:Object,isFromProducto:{type:Boolean,value:!1},listIngredientes:{type:Array,value:function(){return[]}},isProductoConversion:{type:Boolean,value:!1},undConvercion:{},productoSeleted:{type:Object,value:function(){return{}}}},attached:function(){this.isFromProducto=!1,xThisSub=this,xIniSubrecetas()},calcCostoConversionSub:function(e){this.isFromProducto&&(e=parseFloat(e.target.value),e=this.productoSeleted.costo_conversion*e,costo_item_sub.value=e)}})</script>