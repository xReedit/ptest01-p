<link rel="import"href="../x-componentes/x-comp-find-almacen/x-comp-find-almacen.html"><link rel="import"href="../x-componentes/x-comp-find-sede/x-comp-find-sede.html"><link rel="import"href="../x-componentes/x-comp-find-producto-almacen/x-comp-find-producto-almacen.html"><script src="../view/httpFech.js"></script><script src="../view/item_pedido_print_comprobante.js"></script><script rel="prefetch"src="../view/socket.service.p.js"></script><dom-module id="x-distribuicion"><template><paper-dialog modal id="dialog_detalle_distribuicion"style="min-width:400px"class="dialog_redondo"modal entry-animation="scale-up-animation"exit-animation="fade-out-animation"with-backdrop><div class="d-flexx justify-content-between"><p class="fw-600 fs-18">Detalles de Distribuicion</p><button class="btn btn-sm btn-secondary"dialog-dismiss><span class="pl-1 pr-1 fw-600">x</span></button></div><div><p><span class="fw-600">De: </span>{{ desdeDistribuicion }} <span class="fw-600">A:</span> {{ hastaDistribuicion }}<p><span class="fw-600">Fecha: </span>{{ fechaDistribuicion }}<p><span class="fw-600">Obersvaciones: </span>{{ observacionesDistribuicion }}</div><div style="overflow:auto;background:#f0f8ff;border-radius:5px"><table width="100% fs-12"><thead><th align="left">Producto<th align="center">Cantidad<th align="center">Costo<tbody><template is="dom-repeat"items="{{listItemAddDistribuicionD}}"as="item"><tr><td align="left">{{ item.descripcion }}<td align="center">{{ item.cantidad }}<td align="center">{{ item.costo }}</template><tr><td align="right"><p class="fw-600 fs-15">Total<td align="center"><p class="fw-600 fs-15">{{ arrTotalesProductosDistribuicion.cantidad }}<td align="center"><p class="fw-600 fs-15">{{ arrTotalesProductosDistribuicion.costo }}</table></div><br><br></paper-dialog><br><br><div class="xMiCard xradius"style="width:90%;max-width:1250px"><div class="xEncanezadoCard"style="background:#fff0f5;color:#424242"><div class="div-content-head-op"><p class="fw-600 fs-18">Distribuici√≥n<p class="text-secondary">Distribuir productos de un almacen a otro, o de un local a otro local.</div></div><div class="p-3 mb-5"><div hidden$="[[ showDetalleDistribuicion ]]"><div class="d-flexx justify-content-between align-items-center"><p class="fs-15 fw-600">Listado de Distribuicion</p><button class="btn btn-sm btn-primary"onclick="goDetalleDistribuicion()">+ Nuevo</button></div><br><table width="100%"><thead><th>#<th>Fecha<th>Usuario<th>De<th>A<th>Observaciones<th><tbody><template is="dom-repeat"items="{{listDistribuicion}}"as="item"><tr data-id="[[index]]"><td data-id="{{index}}"><span>{{ item.iddistribuicion }}</span><td>{{ item.fecha }}<td>{{ item.usuario }}<td>{{ item.desde }}<td>{{ item.hasta }}<td>{{ item.detalle }}<td align="right"><button class="btn btn-sm btn-xsm xBoton_flat_2"data-id="{{item.iddistribuicion}}"onclick="xloadDetalleDistribuicion(this)">Ver</button></template></table></div><div hidden$="[[ !showDetalleDistribuicion ]]"><br><div class="d-flexx"><div><p class="fw-600">Distribuir De:</p><select id="sel_alamcenDE"inline class="selected-template-1"></select></div><div class="pl-3"><p class="fw-600">A:<div class="d-flexx"><select id="selectA"class="selected-template-1"onchange="setIsToAlmacen()"><option value="0">Almacen<option value="1">Local</select><div hidden$="[[!isToAlmacen]]"class="pl-1"><select id="sel_alamcenA"inline class="selected-template-1"></select></div><div hidden$="[[isToAlmacen]]"class="pl-1"><x-comp-find-sede id="sedeComp"clasecss="selected-template-1"></x-comp-find-sede></div></div></div></div><br><br><table width="100%"><thead><td width="50%">Producto<td>Stock<td>Cant. Distribuir<td>Costo<td><tbody><tr><td><x-comp-find-producto-almacen id="compProductoAlmacenDistribuicion"onlynomfamilia=""idalmacenfiltro$="[[idAlmacenDistribuicionFiltro]]"></x-comp-find-producto-almacen><td><input type="number"readonly="true"class="xMiInput xPasarEnter2 fs-12"id="text_stock_producto"placeholder="Stock Actual"><td><input type="number"class="xMiInput xPasarEnter2 fs-12"id="text_cantidad_producto"placeholder="Cantidad"onchange="xCalcPrecioCompraDistribuicion(this)"onkeyup="xCalcPrecioCompraDistribuicion(this)"><td><input readonly="true"class="xMiInput xPasarEnter2 fs-12"id="text_costo_producto_distribuicion"placeholder="P. Compra"onkeypress="addProductoListDistribuicion()"><td><button class="btn btn-sm btn-success"onclick="addProductoListDistribuicion()">+</button></tr><template is="dom-repeat"items="{{listItemAddDistribuicion}}"as="item"><tr data-id="[[item.idproducto_stock]]"><td>{{ item.descripcion }}<td align="right"colspan="2">{{ item.cantidad }}<td align="right">{{ item.costo }}<td><span class="xDeleteRow ml-2"title="Anular"onclick="removeItemListDistribuicion(this)"></span></template><tr><td colspan="2"align="right"><p class="fw-600 fs-15">Total<td align="right"><p class="fw-600 fs-15">{{ arrTotalesProductosDistribuicion.cantidad }}<td align="right"><p class="fw-600 fs-15">{{ arrTotalesProductosDistribuicion.costo }}<td></table><br><br><br><div><textarea name=""id="txt_detalle"cols="30"maxlength="150"rows="2"placeholder="Observaciones"></textarea><br><hr><br><div class="d-flexx"><button class="btn btn-primary"disabled$="[[isDisabledGuardar]]"onclick="guardarDistribuicionNew()">Guardar Distribuicion</button> <button class="btn btn-success ml-2"hidden$="[[!isGuardadoDistribuicion]]"onclick="cocinarImpresionDistribuicion()">Imprimir</button> <button class="btn btn-secondary ml-3"onclick="goDetalleDistribuicion()">Atras</button></div></div></div></div></div><br><br></template></dom-module><script>var xThisDisttribucion,xlo_idorg,xlo_idsede,xDtAlam,xIdProducto_sel,xIdAlmacen_item_pro_sel,xnom_producto_sel,_compAlmacenDe,compProductoAlmacen,lastIdDistribuicion,xidAlmacen=0,listItemDistribuicion=[],rowItemAdd={};function xIniDistribuicion(){compProductoAlmacen=document.getElementById("compProductoAlmacenDistribuicion"),xPopupLoad=document.getElementById("xLoad"),xm_LogChequea(function(){xm_log_get("ini_us"),xloadAlamcen(),xlistaDistribuicion(),$("body").addClass("loaded")}),$("#Titulo_page").text("Distribuicion"),$(".xPasarEnter2").on("keyup",function(i){var t=i.which;if(13==t||186==t){var t=$("input"),o=t.index(document.activeElement);if(null!==t[o+1]){var e=t[o+1];if(void 0===e)return;if(null==(e=e.disabled?t[o+2]:e))return;e.focus(),e.select()}return event.stopPropagation(),i.stopPropagation(),i.stopImmediatePropagation(),!1}}),$("._xcant").on("keyup",function(i){i=i.which;13!=i&&186!=i||xAddItemRow()}),$("#sel_alamcenDE").on("change",function(){xThisDisttribucion.idAlmacenDistribuicionFiltro=$("#sel_alamcenDE option:selected").val()}),document.getElementById("compProductoAlmacenDistribuicion").addEventListener("productoSeleted",i=>{text_stock_producto.value=i.detail.stock||0}),$("#text_cantidad_producto").on("keyup",function(i){i=i.which;13!=i&&186!=i||addProductoListDistribuicion()})}function xGuardarDistribuicion(){var o=new Array;xPopupLoad.xopen(),$("#tb_almacen_items .row").each(function(i,t){o.push({idproducto_stock:$(t).find("#td_idupdate").text(),idalmacen_de:$(t).find("#td_almacen_de").text(),idalmacen_a:$(t).find("#td_almacen_a").text(),idproducto:$(t).find("#td_dproducto").text(),cantidad:$(t).find("#td_cantidad").text()})}),$.ajax({type:"POST",url:"../../bdphp/log.php?op=16006",data:{array_db:o}}).done(function(i){xPopupLoad.xclose(),xNuevaDisrtribuicion(),xloadProductoItem()})}function xNuevaDisrtribuicion(){$("#tb_input tr.row").remove(),$("#tb_almacen_items tr").remove()}function xAddItemRow(){xCan_item=$("#cant_item").val(),xDes_item=$("#des_item").val(),""!=xCan_item&&(xAddItemLista(),xResetInputPro())}function xAddItemLista(){var i,t,o,e,a=$("#sel_alamcenA option:selected").val(),s=$("#sel_alamcenDE option:selected").val();a==s?alert("Los almacenes de distribuicion son los mismos."):(e=(i=$("#tb_input")).find(".row").length,o=$("#txt_stock").val(),e+=xIdProducto_sel,0==(t=xBuscarAttrTbData(i,"data-id",xIdProducto_sel))?parseInt(xCan_item)>parseInt(o)||(o='<tr class="row" id="'+e+'" data-id="'+xIdProducto_sel+'" data-stock="'+o+'" data-update="'+xIdAlmacen_item_pro_sel+'"><td colspan="2">'+xnom_producto_sel+'</td><td data-ColumName="stock" id="row_stock" data-operacion="resta">'+xCan_item+'</td><td><span class="xDeleteRowNeutro" title="Borrar" onclick="xBorrarItemLocalPro(this);"></span></td></tr>',e='<tr class="row" id="'+e+'" data-update="'+xIdAlmacen_item_pro_sel+'" data-id="'+xIdProducto_sel+'"><td id="td_idupdate">'+xIdAlmacen_item_pro_sel+'</td><td id="td_almacen_de">'+s+'</td><td id="td_almacen_a">'+a+'</td><td id="td_dproducto">'+xIdProducto_sel+'</td><td id="td_cantidad">'+xCan_item+"</td></tr>",$("#tb_almacen_items").append(e).trigger("create"),(0==i.find(".row").length?i.append(o):$("#tb_input tr.row:first").before(o)).trigger("create")):(s=$(t).find("#row_stock").text(),(a=parseFloat($(t).attr("data-stock")))<(s=parseFloat(s)+parseFloat(xCan_item))&&(s=a),$(t).find("#row_stock").text(s),$(t).css("font-weight","bold"),t=xBuscarAttrTbData($("#tb_almacen_items"),"data-id",xIdProducto_sel),$(t).find("#td_cantidad").text(s)))}function xCargarProductoItem(){var o=$("#des_item");o.autocomplete({autoFocus:!0,source:xThisDisttribucion.dtProItem,select:function(i,t){return o.val(t.item.label),o.attr("data-id",t.item.value),o.attr("data-des-familia",t.item.familia),$("#txt_stock").val(t.item.stock),xnom_producto_sel=t.item.label,xIdProducto_sel=t.item.value,xIdAlmacen_item_pro_sel=t.item.idproducto_stock,!1},focus:function(i,t){return!1},change:function(i,t){return null===t.item?(o.attr("data-value",""),o.attr("data-id",""),xIdProducto_sel=xIdAlmacen_item_pro_sel=xnom_producto_sel="",$("#txt_stock").val(""),xNewItemPro=!0):(xNewItemPro=!1,$("#frm_item_pro #idproducto").val(t.item.value)),!1}})}function xloadProductoItem(){xPopupLoad.xopen(),$.ajax({type:"POST",url:"../../bdphp/log.php?op=16001",data:{i:xidAlmacen}}).done(function(i){i=$.parseJSON(i);xThisDisttribucion.dtProItem=i.datos,xCargarProductoItem(),xPopupLoad.xclose()})}function xloadAlamcen(){$.ajax({type:"POST",url:"../../bdphp/log.php?op=1604"}).done(function(i){var t="";xDtAlam=(xDtAlam=$.parseJSON(i)).datos;for(var o=0;o<xDtAlam.length;o++)0==o&&(xThisDisttribucion.idAlmacenDistribuicionFiltro=xDtAlam[o].idalmacen),t=String(t+'<option value="'+xDtAlam[o].idalmacen+'">'+xDtAlam[o].descripcion+"</option>");$("#sel_alamcenDE").html(t).trigger("create"),$("#sel_alamcenA").html(t).trigger("create"),xidAlmacen=$("#sel_alamcenDE option:selected").val(),xloadProductoItem()})}function xBorrarItemLocalPro(i){var i=$(i).parent().parent(),t=(i.parents("table"),i.attr("id"));i.fadeTo(550,0,function(){$(this).remove(),$("#tb_input #"+t).remove()})}function xResetInputPro(){$("#des_item").val(""),$("#des_item").attr("data-id",""),$("#cant_item").val(""),$("#txt_stock").val(""),$("#des_item").focus()}function setIsToAlmacen(){xThisDisttribucion.isToAlmacen=!xThisDisttribucion.isToAlmacen}function addProductoListDistribuicion(){var i=compProductoAlmacen.getProductoSeletedAlmacen();i&&(rowItemAdd.cantidad=text_cantidad_producto.value,parseFloat(rowItemAdd.cantidad)>parseFloat(i.stock)?alert("Cantidad mayor al disponible"):(rowItemAdd.descripcion=i.label,rowItemAdd.idproducto_stock=i.value,rowItemAdd.idproducto=i.idproducto,rowItemAdd.costo=text_costo_producto_distribuicion.value,setItemListDistribuicion()))}function removeItemListDistribuicion(i){const t=i.parentNode.parentNode.dataId;listItemDistribuicion=listItemDistribuicion.filter(i=>i.idproducto_stock!==t),setListListDistribuicion()}function setItemListDistribuicion(){(listItemDistribuicion=xThisDisttribucion.listItemAddDistribuicion||[]).push(rowItemAdd),setListListDistribuicion(),compProductoAlmacen.resetText(),text_cantidad_producto.value="",text_stock_producto.value="",text_costo_producto_distribuicion.value="",compProductoAlmacen.focusText(),getArrTotalesProductosDistribuicion(xThisDisttribucion.listItemAddDistribuicion)}function getArrTotalesProductosDistribuicion(i){i=i.reduce((i,t)=>(i.cantidad+=parseFloat(t.cantidad),i.costo+=parseFloat(t.costo),i),{cantidad:0,costo:0});i.costo=i.costo.toFixed(2),i.costo=isNaN(i.costo)?0:i.costo,xThisDisttribucion.arrTotalesProductosDistribuicion=i}function setListListDistribuicion(){xThisDisttribucion.isDisabledGuardar=0===listItemDistribuicion.length,xThisDisttribucion.listItemAddDistribuicion=JSON.parse(JSON.stringify(listItemDistribuicion))}async function guardarDistribuicionNew(){var i,t;xPopupLoad.xopen(),0!==xThisDisttribucion.listItemAddDistribuicion.length&&(t=document.getElementById("sedeComp").getSede(),i=$("#sel_alamcenA option:selected").val(),xThisDisttribucion.idAlmacenDistribuicionFiltro=$("#sel_alamcenDE option:selected").val(),i={op:4,list:xThisDisttribucion.listItemAddDistribuicion,detalle:txt_detalle.value,idalmacen_de:xThisDisttribucion.idAlmacenDistribuicionFiltro,is_to_sede:xThisDisttribucion.isToAlmacen?0:1,idalmacen_a:i,idsede_a:t.idsede},t=await(new httpFecht).postJson("../../bdphp/log_009.php",i),xThisDisttribucion.isDisabledGuardar=!0,lastIdDistribuicion=t.respuesta,xPopupLoad.xclose(),xThisDisttribucion.isGuardadoDistribuicion=!0,xlistaDistribuicion())}function cocinarImpresionDistribuicion(){var i=xgetImpresora(-5),t=document.getElementById("sedeComp").getSede(),t=xThisDisttribucion.isToAlmacen?sel_alamcenA.selectedOptions[0].text:"LOCAL "+t.nombre,i={lista:xThisDisttribucion.listItemAddDistribuicion,impresora:i,subtotales:[],encabezado:{tipo:"DISTRIBUICION",titulo:"DISTRIBUICION",correlativo_lista:lastIdDistribuicion,otro:`De: ${sel_alamcenDE.selectedOptions[0].text} -> A: `+t,observaciones:txt_detalle.value}};xImprimirCualquierLista(i)}function xlistaDistribuicion(){$.ajax({type:"POST",url:"../../bdphp/log_009.php?op=401"}).done(function(i){i=JSON.parse(i);xThisDisttribucion.listDistribuicion=i.datos})}function xloadDetalleDistribuicion(i){i=i.parentNode.parentNode;const t=xThisDisttribucion.listDistribuicion[i.dataId];$.ajax({type:"POST",url:"../../bdphp/log_009.php?op=402",data:{id:t.iddistribuicion}}).done(function(i){i=JSON.parse(i);xThisDisttribucion.listItemAddDistribuicionD=i.datos,xThisDisttribucion.observacionesDistribuicion=t.detalle,xThisDisttribucion.fechaDistribuicion=t.fecha,xThisDisttribucion.desdeDistribuicion=t.desde,xThisDisttribucion.hastaDistribuicion=t.hasta,getArrTotalesProductosDistribuicion(xThisDisttribucion.listItemAddDistribuicionD),dialog_detalle_distribuicion.open()})}function goDetalleDistribuicion(){xThisDisttribucion.showDetalleDistribuicion=!xThisDisttribucion.showDetalleDistribuicion,xThisDisttribucion.showDetalleDistribuicion||(xThisDisttribucion.listItemAddDistribuicion=[],listItemDistribuicion=[],xThisDisttribucion.isGuardadoDistribuicion=!1)}function xCalcPrecioCompraDistribuicion(i){var i=i.value,t=compProductoAlmacen.getProductoSeletedAlmacen();t&&(t=t.precio_unitario,t=parseFloat(t)*parseFloat(i),text_costo_producto_distribuicion.value=isNaN(t)?0:t.toFixed(2))}Polymer({is:"x-distribuicion",properties:{xt_org:Number,xt_idsede:Number,xt_idus:Number,dtProItem:Object,idAlmacenDistribuicionFiltro:Number,listDistribuicion:[],listItemAddDistribuicion:[],listItemAddDistribuicionD:[],showDetalleDistribuicion:Boolean,isToAlmacen:Boolean,isDisabledGuardar:Boolean,fechaDistribuicion:String,observacionesDistribuicion:String,desdeDistribuicion:String,hastaDistribuicion:String,isGuardadoDistribuicion:Boolean,arrTotalesProductosDistribuicion:{}},attached:function(){this.isDisabledGuardar=!0,this.showDetalleDistribuicion=!1,this.isToAlmacen=!0,this.isGuardadoDistribuicion=!1,xThisDisttribucion=this,xIniDistribuicion(),_cpSocketOpen()},displayIndex:function(i){return xCeroIzq(i+1,1)}})</script>