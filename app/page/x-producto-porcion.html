<dom-module id="x-producto-porcion">
<template>
<paper-dialog modal id="dialog_msj_confirma" class="dialog_redondo" style="min-width:300px" entry-animation="scale-up-animation" exit-animation="fade-out-animation">
<div class="xContent">
<h4 id="titulo_msj">Esta seguro de elimar este producto del almacen?. puede afectar registros relacionado.</h4>
<br>
<div class="xLinea2"></div><br>
<div class="xBoton2 xVerde" dialog-confirm onclick="xOkPopupConfirm()" id="btn_dlg_confirm">Confirmar</div>
<div class="xBoton2 xPlomo" dialog-dismiss>Cancelar</div>
</div>
</paper-dialog>
<paper-dialog modal id="dialog_additem_pro" class="dialog_redondo" modal entry-animation="scale-up-animation" exit-animation="fade-out-animation" with-backdrop>
<div class="xContent">
<h3>Agregar Producto</h3>
<form id="frm_item_pro" method="post">
<label for="sel_almacen_pro">Almacen donde ingresa:</label><br>
<select id="sel_almacen_pro" name="no_post" class="xMiInput"></select>
<input type="text" id="descripcion" name="descripcion" placeholder="Descripcion" class="xMiInput xPasarEnter2" onChange="conMayusculas(this)" autofocus required espaciar><br>
<input type="text" id="sel_familia" name="no_post" class="xMiInput xPasarEnter2" placeholder="Familia" onChange="conMayusculas(this)" required espaciar><br>
<input type="text" id="codigo_barra" name="codigo_barra" placeholder="Codigo de barras" class="xMiInput xPasarEnter2" onChange="conMayusculas(this)" espaciar><br>
<input type="text" id="stock" name="no_post" placeholder="Stock" class="xMiInput xPasarEnter2" onChange="conMayusculas(this)" espaciar required><br>
<input type="text" id="stock_minimo" name="stock_minimo" placeholder="Stock minimo" class="xMiInput xPasarEnter2" onChange="conMayusculas(this)" espaciar><br>
<input type="text" id="precio" name="precio" placeholder="Precio de compra" onblur="xRetornaMoneda(this)" class="xMiInput xPasarEnter2" onChange="conMayusculas(this)" required espaciar><br>
<input type="text" id="precio_venta" name="precio_venta" placeholder="Precio de venta x unidad" onblur="xRetornaMoneda(this)" class="xMiInput xPasarEnter2 xPrecioAddPro" onChange="conMayusculas(this)" onkeyup="xEnterInInputDlgPP(event)" required espaciar><br>
<div class="xInvisible">
<input type="text" id="idproducto" name="idproducto">
<input type="text" id="idorg" name="idorg">
<input type="text" id="idsede" name="idsede">
<input type="text" id="idproducto_familia" name="idproducto_familia">
<input type="text" id="precio_unitario" name="precio_unitario">
</div>
</form>
<br><br>
<div class="xBoton2 xAzul" onclick="xGuardarItemProPP()">Listo, guardar</div>
<div class="xBoton2 xPlomo" dialog-dismiss>Cancelar</div>
<br><br><br>
</div>
</paper-dialog>
<paper-dialog modal id="dialog_additem_porcion" class="dialog_redondo" modal entry-animation="scale-up-animation" exit-animation="fade-out-animation" with-backdrop>
<div class="xContent">
<h3>Agregar Porcion</h3><br>
<p><strong>Elaborar porciones para las recetas.</strong><br>
Por ejemplo: de 1000gr de bistec salen 10 porciones de 100gr cada una para el preparar bistec a lo pobre.<br>
Utilize la misma unidad de medida que esta en el producto a porcionar. Es decir si el producto a porcionar esta en gramos la misma unidad de medida debe ser para las prociones.</p>
<br>
<form id="frm_add_porcion" method="post">
<input type="text" id="descripcion" name="descripcion" placeholder="Descripcion de la porcion" class="xMiInput xPasarEnter2" onChange="conMayusculas(this)" autofocus required espaciar><br>
<input type="text" id="peso" name="peso" placeholder="Peso" class="xMiInput xPasarEnter2" onChange="conMayusculas(this)" autofocus required espaciar><br>
<input type="text" id="stock" name="stock" placeholder="Cantidad" class="xMiInput xPasarEnter2" onChange="conMayusculas(this)" autofocus required espaciar><br>
<div class="xInvisible">
<input type="text" id="idporcion" name="idporcion">
<input type="text" id="idorg" name="idorg">
<input type="text" id="idsede" name="idsede">
</div>
</form>
<br><br>
<div class="xBoton2 xAzul" onclick="xGuardarItemPorcion()">Listo, guardar</div>
<div class="xBoton2 xPlomo" dialog-dismiss>Cancelar</div>
<br><br><br>
</div>
</paper-dialog>
<paper-dialog id="dialog_detalle" class="dialog_redondo" style="width:90%;max-width:550px;height:auto!important;overflow:auto" modal entry-animation="scale-up-animation" exit-animation="fade-out-animation" with-backdrop>
<div class="xContent">
<div id="dlg_foto_vista_previa-div">
<a class="xDerecha xInvisible xCursor" onclick="xItemQuitarFoto()" id="dlg_btn_quitar_foto">Quitar Foto</a>
<br>
<input type="file" class="xInvisible xobj_subir_foto" id="ctrl_open_file" accept="image/*"/>
<div id="dlg_foto_vista_previa" class="div_foto" onclick="xSeleccionarFoto()">
<div class="xCentradoHijo" id="dlg_label_foto">Clic aqui para seleccionar</div>
</div>
<br><br>
<div class="xBoton2 xAzul" dialog-confirm onclick="xItemGuardarFoto()">Listo, guardar</div>
<div class="xBoton2 xPlomo" dialog-dismiss>Cerrar</div>
</div>
</div>
</paper-dialog>
<br>
<div class="xContent">
<paper-tabs selected="{{selected}}" id="tab_pro_por">
<paper-tab>PRODUCTOS</paper-tab>
<paper-tab>PORCIONES</paper-tab>
</paper-tabs>
<div class="xLinea2"></div>
<br>
<iron-pages selected="{{selected}}">
<div id="cont_productos">
<div class="xFondoRowAmarillo3 xMargin5">
<br>
<h4 class="xpadingLateralIz">Productos por almacen. Solo usuarios autorizados puedes modificar el stock, precio y/o eliminar los productos.</h4>
<p class="xpadingLateralIz"><img src="../../images/tr_alert_min.png"> Esta opción nos muestra los productos que se encuentran por debajo del stock mínimo.</p>
<br>
</div>
<p>Buscar en:</p>
<div class="xLinea2"></div>
<br>
<div>
<select id="sel_almacen_pp" inline></select>
<input type="text" class="xMiInput" placeholder="Buscar" inline id="txt_buscar">
<paper-checkbox id="chec_min" class="xpadingLateralIz">Ver solo stock minimo <img src="../../images/tr_alert_min.png"></paper-checkbox>
<div class="xBoton2 xAzul xDerecha" onclick="dialog_additem_pro.open()">+ Agregar Producto</div>
<div class="xBoton2 xVerde xDerecha" onclick="xGuardarCambiosTbProductos(1)">Guardar Cambios</div>
</div>
<br><br>
<div class="xLinea2"></div>
<br>
<table id="tb_productos" width="100%" class="xtable2">
<thead>
<th align="left" width="20%">Almacen</th>
<th align="left" width="20%">Familia</th>
<th align="left">Producto</th>
<th align="left" width="80px">Stock</th>
<th align="left" width="80px">P. Venta</th>
<th align="left" width="80px">Imagen</th>
<th width="5px"></th>
</thead>
</table>
<br><br><br>
</div>
<div id="cont_porciones">
<br>
<input type="text" class="xMiInput" placeholder="Buscar" inline id="txt_buscar_porcion">
<div class="xBoton2 xAzul xDerecha" onclick="dialog_additem_porcion.open()">+ Agregar Porcion</div>
<div class="xBoton2 xVerde xDerecha" onclick="xGuardarCambiosTbProductos(2)">Guardar Cambios</div>
<br><br><br>
<div class="xLinea2"></div>
<br>
<table id="tb_porcion" width="100%" class="xtable2">
<thead>
<th align="left" width="20%">Familia</th>
<th align="left">Porcion</th>
<th align="left" width="90px">Stock</th>
<th width="5px"></th>
</thead>
</table>
<br><br><br>
</div>
</iron-pages>
</div>
</template>
<style>.div_foto{width:100%;height:260px;background:#e0e0e0;cursor:pointer;display:inline-block}.div_foto #dlg_label_foto{opacity:.8;text-align:center;z-index:0}.div_foto img{width:100%}</style>
<script>/*<![CDATA[*/var xThisProPor,xidAlmacenbUS,xObjRowSel,xPrecio_item,xObjImgDet,xIdObjImgDet,filtroStokMin="no";function xIniProPor(){xPopupLoad=document.getElementById("xLoad");xm_LogChequea(function(){xm_log_get("ini_us");$("body").addClass("loaded");$("#Titulo_page").text("Productos y porciones");xLoadAlmacenes();var a=getUrlParameter("stock_minimo","?");filtroStokMin=a?a:"no"});$("#ctrl_open_file").change(function(f){for(var d=0;d<f.originalEvent.srcElement.files.length;d++){var c=f.originalEvent.srcElement.files[d];var b=document.createElement("img");var a=new FileReader();a.onloadend=function(){b.src=a.result};a.readAsDataURL(c);$("#dlg_foto_vista_previa img").remove();$("#dlg_foto_vista_previa").append(b).trigger("create")}});$(".xPasarEnter2").on("keyup",function(g){var f=g.which;if(f==13||f==186){var c=$("input");var b=c.index(document.activeElement);if(c[b+1]!==null){var d=c[b+1];if(d===undefined){return}if(d.disabled){d=c[b+2]}if(d==undefined){return}d.focus();d.select()}event.stopPropagation();g.stopPropagation();g.stopImmediatePropagation();return false}});$("#txt_buscar").on("keyup",function(){xBuscarXTxt(this.value)});$("#txt_buscar_porcion").on("keyup",function(){xBuscarTbData($("#tb_porcion"),this.value);xSumarTotalesPorcion()});$("#sel_almacen_pp").on("change",function(){xLoadProductos(sel_almacen_pp.value)});$("#chec_min").on("change",function(){var a="";if(this.checked){a="stock minimo"}xBuscarXTxt(a)});$("#tab_pro_por").on("iron-select",function(){switch(xThisProPor.selected){case 0:xLoadAlmacenes();break;case 1:xLoadPorciones();break}})}function xEnterInInputDlgPP(b){var a=b.which;if(a==13||a==186){xGuardarItemProPP()}}function xGuardarItemPorcion(){xvalidateFormInput("frm_add_porcion",function(b){if(b===false){return}xPopupLoad.xopen();$("#frm_add_porcion #idorg").val(xIdOrg);$("#frm_add_porcion #idsede").val(xIdSede);$.post("../../bdphp/ManejoBD_IUD.php?tb=porcion",$("#frm_add_porcion").serialize(),function(a){xLoadPorciones();xPopupLoad.xclose();dialog_additem_porcion.close()})})}function xGuardarItemProPP(){xvalidateFormInput("frm_item_pro",function(b){if(b===false){return}xPopupLoad.xopen();xnom_familia=$("#sel_familia").val();xPrecio_item=xMoneda($("#frm_item_pro #precio").val());if(xNewFamilia==true){$.ajax({type:"POST",url:"../../bdphp/log.php?op=1602",data:{f:xnom_familia}}).done(function(a){$("#frm_item_pro #idproducto_familia").val(a);xGuardarItemProDtPP();xLoadFamilias()})}else{xGuardarItemProDtPP()}})}function xGuardarItemProDtPP(){xCan_item=$("#frm_item_pro #stock").val();var a=parseFloat(xPrecio_item)/parseFloat(xCan_item);$("#frm_item_pro #idorg").val(xIdOrg);$("#frm_item_pro #idsede").val(xIdSede);$("#frm_item_pro #precio_unitario").val(a);$.post("../../bdphp/ManejoBD_IUD.php?tb=producto",$("#frm_item_pro").serialize(),function(b){xIdProducto_sel=b;$.ajax({type:"POST",url:"../../bdphp/log.php?op=1807",data:{p:xIdProducto_sel,a:sel_almacen_pro.value,c:$("#frm_item_pro #stock").val()}}).done(function(c){dialog_additem_pro.close();$("#frm_item_pro").reset();xPopupLoad.xclose();xLoadProductos_dt()})})}function xCargarFamiliaInput(){var a=$("#sel_familia");a.autocomplete({autoFocus:true,source:xThisProPor.dtProFam,appendTo:$("#dialog_additem_pro"),select:function(b,c){a.val(c.item.label);a.attr("data-id",c.item.value);$("#frm_item_pro #idproducto_familia").val(c.item.value);return false},focus:function(b,c){return false},change:function(b,c){if(c.item===null){a.attr("data-value","");a.attr("data-id","");$("#frm_item_pro #idproducto_familia").val("");xNewFamilia=true}else{xNewFamilia=false;$("#frm_item_pro #idproducto_familia").val(c.item.value)}return false}})}function xLoadFamilias(){$.ajax({type:"POST",url:"../../bdphp/log.php?op=1601"}).done(function(a){var b=$.parseJSON(a);xThisProPor.dtProFam=b.datos;xCargarFamiliaInput()})}function xLoadPorciones(){$.ajax({type:"POST",url:"../../bdphp/log.php?op=1803"}).done(function(d){var e=$.parseJSON(d);var b="";var c="";e=e.datos;for(var a=0;a<e.length;a++){c=e[a].stock;b=String(b+'<tr class="row" data-idp="'+e[a].idporcion+'"><td>'+e[a].familia+'</td><td class="xCursor"><span onclick="xModRow(this,3);" id="td_des" data-valorginal="'+e[a].porcion+'">'+e[a].porcion+'</span></td><td class="sumar_stock xCursor" onclick="xModRow(this,2);" id="td_stock" data-valorginal="'+c+'" data-mod-stock="'+c+'" data-colummn="stock">'+c+'</td><td><span class="xDeleteRowNeutro" title="Borrar" onclick="xBorrarProcion(this);"></span></td></tr>')}$("#tb_porcion .row").remove();$("#tb_porcion").append(b).trigger("create");xSumarTotalesPorcion()})}function xBuscarXTxt(a){xBuscarTbData($("#tb_productos"),a);xSumarTotales()}function xLoadAlmacenes(){xPopupLoad.xopen();$.ajax({type:"POST",url:"../../bdphp/log.php?op=1604"}).done(function(c){xDtAlam=$.parseJSON(c);var b="";xDtAlam=xDtAlam.datos;for(var a=0;a<xDtAlam.length;a++){b=String(b+'<option value="'+xDtAlam[a].idalmacen+'">'+xDtAlam[a].descripcion+"</option>")}b=String(b+"<option value=0>TODOS</option>");$("#sel_almacen_pp").html(b).trigger("create");$("#sel_almacen_pro").html(b).trigger("create");xLoadProductos_dt();xLoadFamilias()})}function xLoadProductos_dt(a){$.ajax({type:"POST",url:"../../bdphp/log.php?op=18"}).done(function(b){var c=$.parseJSON(b);c=c.datos;xThisProPor.xdt_prodcutos=c;xLoadProductos(0)})}function xLoadProductos(a){$("#tb_productos .row").remove();var f=xThisProPor.xdt_prodcutos;var b="";var d="";var e="",h="Subir Imagen";for(var c=0;c<f.length;c++){if(a!=0){if(a!=f[c].idalmacen){continue}}d="";e="";var j=parseInt(f[c].stock_minimo);var g=parseInt(f[c].stock);h=f[c].img!=""?"Cambiar Imagen":"Subir Imagen";if(g<=j&&j!=0){e="stock minimo";d='<image title="stock minimo '+j+'" src="../../images/tr_alert_min.png">'}b=String(b+'<tr class="row" data-idal="'+f[c].idproducto_stock+'" data-idp="'+f[c].idproducto+'" data-idalmacen="'+f[c].idalmacen+'"><td>'+f[c].almacen+"</td><td>"+f[c].familia+'</td><td class="xCursor"><div><span onclick="xModRow(this,3);" id="td_des" data-valorginal="'+f[c].producto+'">'+f[c].producto+'<span><span class="xDerecha">'+d+'</span><span class="xInvisible">'+e+'</span></div></td><td class="sumar_stock xCursor" onclick="xModRow(this,2);" id="td_stock" data-valorginal="'+g+'" data-mod-stock="'+g+'" data-mod-precio="" data-colummn="stock">'+g+'</td><td class="xCursor" onclick="xModRow(this,1);" id="td_pventa" data-valorginal="'+f[c].precio_venta+'" data-mod-stock="" data-mod-precio="'+f[c].precio_venta+'" data-colummn="precio_venta">'+f[c].precio_venta+'</td><td class="xCursor" onclick="openDialogImg(this);"><span class="xfont11">'+h+'</span></td><td><span class="xDeleteRowNeutro" title="Borrar" onclick="xBorrarProducto(this);"></span></td><td class="xInvisible" id="td_img">'+f[c].img+"</td>"+ +"</tr>")}$("#tb_productos .row").remove();$("#tb_productos").append(b).trigger("create");xSumarTotales();if(filtroStokMin==="si"){xBuscarXTxt("stock minimo")}xPopupLoad.xclose()}function xSumarTotales(){var c=xContarCantRowVisible($("#tb_productos"),".sumar_stock");var a=xSumaCantRowVisible($("#tb_productos"),".sumar_stock");var b='<tr class="tr_total xBold xfont18"><td>Totales</td><td>'+c+"</td><td>-</td><td>"+a+"</td><td>-</td><td>-</td><td>-</td></tr>";$("#tb_productos .tr_total").remove();$("#tb_productos").append(b).trigger("create")}function xSumarTotalesPorcion(){var c=xContarCantRowVisible($("#tb_porcion"),".sumar_stock");var a=xSumaCantRowVisible($("#tb_porcion"),".sumar_stock");var b='<tr class="tr_total xBold xfont18"><td>Totales</td><td>'+c+"</td><td>"+a+"</td></tr>";$("#tb_porcion .tr_total").remove();$("#tb_porcion").append(b).trigger("create")}function xModRow(c,b){var a=$(c).text();if($(c).find("input").length>0){$(c).find("input").select();return}$(c).html('<input type="text" class="xMiInput xPasarEnter2 xAlinearIzquierda" onblur="xModBlur(this,'+b+')" value="'+a+'" select>').trigger("create");$(c).find("input").select()}function xModBlur(e,c){var b=$(e).val();var d=$(e).parents("table");var a=$(e).parent();switch(c){case 1:b=xMoneda(b);a.attr("data-mod-precio",b);a.addClass("modificado");break;case 2:b=xCeroIzq(b,2);a.attr("data-mod-stock",b);a.addClass("modificado");break;case 3:b=b;a.parents("td").attr("data-mod-descripcion",b);a.parents("td").addClass("modificado");break}$(e).parent().text(b);$(e).remove()}function xGuardarCambiosTbProductos(c){var b=new Array();var a;if(c==1){a=$("#tb_productos")}else{a=$("#tb_porcion")}$(a).find(".row>td.modificado").each(function(e,f){var j=$(f).attr("data-mod-stock");var k=$(f).attr("data-mod-precio");var i=$(f).attr("data-mod-descripcion");var g=$(f).attr("data-valorginal");var d=$(f).parent().attr("data-idp");var h=$(f).parent().attr("data-idal");if(g==j){j=""}if(g==k){k=""}if(g==i||i==undefined){i=""}b.push({idproducto:d,idproducto_stock:h,val_stock:j,val_precio:k,val_descripcion:i})});if(b.length>0){xPopupLoad.xopen();$.ajax({type:"POST",url:"../../bdphp/log.php?op=1801",data:{array_rows:b,op:c}}).done(function(d){var e=$.parseJSON(d);if(e.success!=true){alert(e.error)}xPopupLoad.xclose()})}}function xBorrarProducto(a){$("#dialog_msj_confirma #titulo_msj").text("Esta seguro de elimar este producto del almacen?. puede afectar registros relacionado.");xObjRowSel=$(a).parent().parent();dialog_msj_confirma.open()}function xBorrarProcion(a){$("#dialog_msj_confirma #titulo_msj").text("Esta seguro de elimar esta PORCION del almacen?. puede afectar registros relacionado.");xObjRowSel=$(a).parent().parent();dialog_msj_confirma.open()}function xOkPopupConfirm(){var a=$("#dialog_msj_confirma #titulo_msj").text();if(a.indexOf("producto")>-1){xConfirmBorrarProducto()}else{xConfirmBorrarPorcion()}}function xConfirmBorrarProducto(){var b=xObjRowSel.attr("data-idalmacen");var a=xObjRowSel.attr("data-idal");$.ajax({type:"POST",url:"../../bdphp/log.php?op=1802",data:{idp:a,ida:b}}).done(function(c){xObjRowSel.fadeTo(550,0,function(){$(this).remove()});dialog_msj_confirma.close()})}function xConfirmBorrarPorcion(){var a=xObjRowSel.attr("data-idp");$.ajax({type:"POST",url:"../../bdphp/log.php?op=1804",data:{idp:a}}).done(function(b){xObjRowSel.fadeTo(550,0,function(){$(this).remove()});dialog_msj_confirma.close()})}function xSeleccionarFoto(){$("#ctrl_open_file").click()}function xItemFoto(d,c){xObjImgDet=d;xIdObjImgDet=$(d).parents("tr").attr("data-id");var a=$(d).parent().text();var b=$(d).parents("tr").find("#td_img").text();$("#dlg_foto_vista_previa img").remove();$("#dlg_btn_quitar_foto").addClass("xInvisible");if(b!==""){b="<img src=../img/"+b+">";$("#dlg_foto_vista_previa").append(b).trigger("create");$("#dlg_btn_quitar_foto").removeClass("xInvisible")}$("#dialog_foto #dlg_des_item").text(a);$("#ctrl_open_file").val("");c.stopImmediatePropagation();c.stopPropagation()}function xItemQuitarFoto(){xPopupLoad.xopen();$(".div_foto img").remove();$(xObjImgDet).parents("tr").find("#td_img").text("");$.ajax({type:"POST",url:"../../bdphp/log.php?op=20701",data:{i:xIdObjImgDet,d:""}}).done(function(b){xPopupLoad.xclose()})}function xItemGuardarFoto(){$(".xobj_subir_foto").each(function(a,b){if($(this).val()==""){return}file=this.files[0];name=file.name;size=file.size;type=file.type;xhr=new XMLHttpRequest();xhr.upload.addEventListener("load",transferenciaCompleta(name),false);xhr.open("POST","upload.php?op=1",true);xhr.setRequestHeader("Cache-Control","no-cache");xhr.setRequestHeader("X-Requested-With","XMLHttpRequest");xhr.setRequestHeader("X-File-Name",file.name);xhr.send(file)})}function transferenciaCompleta(a){a=xIdOrg+xIdSede+a;$.ajax({type:"POST",url:"../../bdphp/log.php?op=20701",data:{i:xIdObjImgDet,d:a}}).done(function(b){$(xObjImgDet).parents("tr").find("#td_img").text(a);xPopupLoad.xclose()})}function openDialogImg(c){xObjImgDet=c;xObjRowSel=c.parentElement;xIdObjImgDet=c.parentElement.dataset.idp;var a=$(c).parent().text();var b=$(c).parents("tr").find("#td_img").text();b=b===""?"":URL_IMG_CARTA+b;$("#dlg_foto_vista_previa img").remove();$("#dlg_btn_quitar_foto").addClass("xInvisible");if(b!==""){b='<img src="'+b+'">';$("#dlg_foto_vista_previa").append(b).trigger("create");$("#dlg_btn_quitar_foto").removeClass("xInvisible")}$("#ctrl_open_file").val("");dialog_detalle.open()}Polymer({is:"x-producto-porcion",properties:{xt_org:Number,xt_idsede:Number,xt_idus:Number,xdt_prodcutos:Object,dtProFam:Object},attached:function(){this.selected=0;xThisProPor=this;xIniProPor()}});/*]]>*/</script>
</dom-module>