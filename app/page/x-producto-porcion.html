<link rel="import"href="../x-componentes/x-comp-img-upload/x-comp-img-upload.html"><link rel="import"href="./x-porcion/x-porcion-main.html"><dom-module id="x-producto-porcion"><script src="../view/export.excel.js"></script><template><paper-dialog modal id="dialog_msj_confirma"class="dialog_redondo"style="min-width:300px"entry-animation="scale-up-animation"exit-animation="fade-out-animation"><div class="xContent"><h4 id="titulo_msj">Esta seguro de elimar este producto del almacen?. puede afectar registros relacionado.</h4><br><div class="xLinea2"></div><br><div class="xBoton2 xVerde"dialog-confirm onclick="xOkPopupConfirm()"id="btn_dlg_confirm">Confirmar</div><div class="xBoton2 xPlomo"dialog-dismiss>Cancelar</div></div></paper-dialog><paper-dialog modal id="dialog_additem_pro"class="dialog_redondo"modal entry-animation="scale-up-animation"exit-animation="fade-out-animation"with-backdrop><div class="xContent"><h3>Agregar Producto</h3><form id="frm_item_pro"><label for="sel_almacen_pro">Almacen donde ingresa:</label><br><select id="sel_almacen_pro"name="no_post"class="xMiInput"></select> <input id="descripcion"name="descripcion"placeholder="Descripcion"class="xMiInput xPasarEnter2"onchange="conMayusculas(this)"autofocus required espaciar><br><input id="sel_familia"name="no_post"class="xMiInput xPasarEnter2"placeholder="Familia"onchange="conMayusculas(this)"required espaciar><br><input id="codigo_barra"name="codigo_barra"placeholder="Codigo de barras"class="xMiInput xPasarEnter2"onchange="conMayusculas(this)"espaciar><br><input id="stock"name="no_post"placeholder="Stock"class="xMiInput xPasarEnter2"onchange="conMayusculas(this)"espaciar required><br><input id="stock_minimo"name="stock_minimo"placeholder="Stock minimo"class="xMiInput xPasarEnter2"onchange="conMayusculas(this)"espaciar><br><input id="precio"name="precio"placeholder="Precio de compra"onblur="xRetornaMoneda(this)"class="xMiInput xPasarEnter2"onchange="conMayusculas(this)"required espaciar><br><input id="precio_venta"name="precio_venta"placeholder="Precio de venta x unidad"onblur="xRetornaMoneda(this)"class="xMiInput xPasarEnter2 xPrecioAddPro"onchange="conMayusculas(this)"onkeyup="xEnterInInputDlgPP(event)"required espaciar><br><div class="xInvisible"><input id="idproducto"name="idproducto"> <input id="idorg"name="idorg"> <input id="idsede"name="idsede"> <input id="idproducto_familia"name="idproducto_familia"> <input id="precio_unitario"name="precio_unitario"></div></form><br><br><div class="xBoton2 xAzul"onclick="xGuardarItemProPP()">Listo, guardar</div><div class="xBoton2 xPlomo"dialog-dismiss>Cancelar</div><br><br><br></div></paper-dialog><paper-dialog id="dialog_detalle"class="dialog_redondo"style="width:90%;max-width:550px;height:auto!important;overflow:auto"modal entry-animation="scale-up-animation"exit-animation="fade-out-animation"with-backdrop><div class="xContent"><div id="dlg_foto_vista_previa-div"><a class="xDerecha xInvisible xCursor"onclick="xItemQuitarFoto()"id="dlg_btn_quitar_foto">Quitar Foto</a><br><br><x-comp-img-upload id="compImgProducto"medidasimg="[[medidaImgProducto]]"></x-comp-img-upload><br><br><br><br><div class="xBoton2 xAzul"dialog-confirm onclick="xItemGuardarFotProducto()">Listo, guardar</div><div class="xBoton2 xPlomo"dialog-dismiss>Cerrar</div></div></div></paper-dialog><br><div class="xContent"><paper-tabs selected="{{selected}}"id="tab_pro_por"><paper-tab>PRODUCTOS</paper-tab><paper-tab>PORCIONES</paper-tab></paper-tabs><div class="xLinea2"></div><br><iron-pages selected="{{selected}}"><div id="cont_productos"><div class="xFondoRowAmarillo3 xMargin5"><br><h4 class="xpadingLateralIz">Productos por almacen. Solo usuarios autorizados puedes modificar el stock, precio y/o eliminar los productos.</h4><p class="xpadingLateralIz"><img src="../../images/tr_alert_min.png"> Esta opción nos muestra los productos que se encuentran por debajo del stock mínimo.</p><br></div><p>Buscar en:<div class="xLinea2"></div><br><div><select id="sel_almacen_pp"inline></select> <input class="xMiInput"placeholder="Buscar"inline id="txt_buscar"><paper-checkbox id="chec_min"class="xpadingLateralIz">Ver solo stock minimo <img src="../../images/tr_alert_min.png"></paper-checkbox><div class="xBoton2 xAzul xDerecha"onclick="dialog_additem_pro.open()">+ Agregar Producto</div><div class="xBoton2 xVerde xDerecha"onclick="xGuardarCambiosTbProductos(1)">Guardar Cambios</div></div><br><br><div class="xLinea2"></div><br><table id="tb_productos"width="100%"class="xtable2"><thead><th align="left"width="20%">Almacen<th align="left"width="20%">Familia<th align="left">Producto<th align="left"width="80px">Stock<th align="left"width="80px">P.Venta<th align="left"width="80px">Imagen<th align="left"width="80px"class="xInvisible">nom_imagen<th width="5px"></thead></table><div class="xInvisible"><table id="tb_export_p"width="100%"class="xtable2"><thead><th align="left">Producto<th align="left">familia<th align="left">codigo_barras<th align="left">cantidad<th align="left">stock_min<th align="left">precio compra total<th align="left">precio venta<th align="left">nom_imagen<tbody><template is="dom-repeat"items="{{listProductosExport}}"as="item"><tr data-index="[[index]]"><td>{{item.producto}}<td>{{item.familia}}<td>{{item.codigo_barra}}<td>{{item.stock}}<td>{{item.stock_minimo}}<td>{{item.precio}}<td>{{item.precio_venta}}<td>{{item.img}}</template></table></div><br><br><br><div id="btn_soporte_shared"><div class="d-flexx"><button class="btn btn-sm btn-info mr-2"onclick="descargarListaProductos()">Exportar a Excel</button></div><br><br><br></div></div><div id="cont_porciones"><x-porcion-main></x-porcion-main></div></iron-pages></div></template><style>.div_foto{width:100%;height:260px;background:#e0e0e0;cursor:pointer;display:inline-block}.div_foto #dlg_label_foto{opacity:.8;text-align:center;z-index:0}.div_foto img{width:100%}</style><script>var xThisProPor,xidAlmacenbUS,xObjRowSel,xPrecio_item,xObjImgDet,xIdObjImgDet,compImgProducto,filtroStokMin="no";function xIniProPor(){xPopupLoad=document.getElementById("xLoad"),xm_LogChequea(function(){xm_log_get("ini_us"),$("body").addClass("loaded"),$("#Titulo_page").text("Productos y porciones"),xLoadAlmacenes();var o=getUrlParameter("stock_minimo","?");filtroStokMin=o||"no"}),xThisProPor.medidaImgProducto={width:220,height:200},compImgProducto=document.getElementById("compImgProducto"),$("#ctrl_open_file").change(function(o){for(var t=0;t<o.originalEvent.srcElement.files.length;t++){var a=o.originalEvent.srcElement.files[t],e=document.createElement("img"),r=new FileReader;r.onloadend=function(){e.src=r.result},r.readAsDataURL(a),$("#dlg_foto_vista_previa img").remove(),$("#dlg_foto_vista_previa").append(e).trigger("create")}}),$(".xPasarEnter2").on("keyup",function(o){var t=o.which;if(13==t||186==t){var t=$("input"),a=t.index(document.activeElement);if(null!==t[a+1]){var e=t[a+1];if(void 0===e)return;if(null==(e=e.disabled?t[a+2]:e))return;e.focus(),e.select()}return event.stopPropagation(),o.stopPropagation(),o.stopImmediatePropagation(),!1}}),$("#txt_buscar").on("keyup",function(){xBuscarXTxt(this.value)}),$("#txt_buscar_porcion").on("keyup",function(){xBuscarTbData($("#tb_porcion"),this.value),xSumarTotalesPorcion()}),$("#sel_almacen_pp").on("change",function(){xLoadProductos(sel_almacen_pp.value)}),$("#chec_min").on("change",function(){var o="";xBuscarXTxt(o=this.checked?"stock minimo":o)}),$("#tab_pro_por").on("iron-select",function(){switch(xThisProPor.selected){case 0:xLoadAlmacenes();break;case 1:xLoadPorciones()}})}function xEnterInInputDlgPP(o){o=o.which;13!=o&&186!=o||xGuardarItemProPP()}function xGuardarItemPorcionPorcion(){xvalidateFormInput("frm_add_porcion",function(o){!1!==o&&(xPopupLoad.xopen(),$("#frm_add_porcion #idorg").val(xIdOrg),$("#frm_add_porcion #idsede").val(xIdSede),$.post("../../bdphp/ManejoBD_IUD.php?tb=porcion",$("#frm_add_porcion").serialize(),function(o){xLoadPorciones(),xPopupLoad.xclose(),dialog_additem_porcion.close()}))})}function xGuardarItemProPP(){xvalidateFormInput("frm_item_pro",function(o){!1!==o&&(xPopupLoad.xopen(),xnom_familia=$("#sel_familia").val(),xPrecio_item=xMoneda($("#frm_item_pro #precio").val()),1==xNewFamilia?$.ajax({type:"POST",url:"../../bdphp/log.php?op=1602",data:{f:xnom_familia}}).done(function(o){$("#frm_item_pro #idproducto_familia").val(o),xGuardarItemProDtPP(),xLoadFamilias()}):xGuardarItemProDtPP())})}function xGuardarItemProDtPP(){xCan_item=$("#frm_item_pro #stock").val();var o=parseFloat(xPrecio_item)/parseFloat(xCan_item);$("#frm_item_pro #idorg").val(xIdOrg),$("#frm_item_pro #idsede").val(xIdSede),$("#frm_item_pro #precio_unitario").val(o),$.post("../../bdphp/ManejoBD_IUD.php?tb=producto",$("#frm_item_pro").serialize(),function(o){xIdProducto_sel=o,$.ajax({type:"POST",url:"../../bdphp/log.php?op=1807",data:{p:xIdProducto_sel,a:sel_almacen_pro.value,c:$("#frm_item_pro #stock").val()}}).done(function(o){dialog_additem_pro.close(),$("#frm_item_pro").reset(),xPopupLoad.xclose(),xLoadProductos_dt()})})}function xCargarFamiliaInput(){var a=$("#sel_familia");a.autocomplete({autoFocus:!0,source:xThisProPor.dtProFam,appendTo:$("#dialog_additem_pro"),select:function(o,t){return a.val(t.item.label),a.attr("data-id",t.item.value),$("#frm_item_pro #idproducto_familia").val(t.item.value),!1},focus:function(o,t){return!1},change:function(o,t){return null===t.item?(a.attr("data-value",""),a.attr("data-id",""),$("#frm_item_pro #idproducto_familia").val(""),xNewFamilia=!0):(xNewFamilia=!1,$("#frm_item_pro #idproducto_familia").val(t.item.value)),!1}})}function xLoadFamilias(){$.ajax({type:"POST",url:"../../bdphp/log.php?op=1601"}).done(function(o){o=$.parseJSON(o);xThisProPor.dtProFam=o.datos,xCargarFamiliaInput()})}function xLoadPorciones(){$.ajax({type:"POST",url:"../../bdphp/log.php?op=1803"}).done(function(o){var t,a="",e=(e=$.parseJSON(o)).datos.map(o=>(o.modificado=!1,o));xThisProPor.listPorciones=e;for(var r=0;r<e.length;r++)t=e[r].stock,a=String(a+'<tr class="row" data-idp="'+e[r].idporcion+'"><td>'+e[r].familia+'</td><td class="xCursor"><span onclick="xModRow(this,3);" id="td_des" data-valorginal="'+e[r].porcion+'">'+e[r].porcion+'</span></td><td class="sumar_stock xCursor" onclick="xModRow(this,2);" id="td_stock" data-valorginal="'+t+'" data-mod-stock="'+t+'" data-colummn="stock">'+t+'</td><td><span class="xDeleteRowNeutro" title="Borrar" onclick="xBorrarProcion(this);"></span></td></tr>');$("#tb_porcion .row").remove()})}function xBuscarXTxt(o){xBuscarTbData($("#tb_productos"),o),xSumarTotales()}function xLoadAlmacenes(){xPopupLoad.xopen(),$.ajax({type:"POST",url:"../../bdphp/log.php?op=1604"}).done(function(o){var t="";xDtAlam=(xDtAlam=$.parseJSON(o)).datos;for(var a=0;a<xDtAlam.length;a++)t=String(t+'<option value="'+xDtAlam[a].idalmacen+'">'+xDtAlam[a].descripcion+"</option>");t=String(t+"<option value=0>TODOS</option>"),$("#sel_almacen_pp").html(t).trigger("create"),$("#sel_almacen_pro").html(t).trigger("create"),xLoadProductos_dt(),xLoadFamilias()})}function xLoadProductos_dt(o){$.ajax({type:"POST",url:"../../bdphp/log.php?op=18"}).done(function(o){o=$.parseJSON(o).datos;xThisProPor.xdt_prodcutos=o,xLoadProductos(0)})}function xLoadProductos(t){$("#tb_productos .row").remove();var o=xThisProPor.xdt_prodcutos,a="",e="",r="",i="Subir Imagen";listProductosExportar=o.filter(o=>t===o.idalmacen),xThisProPor.listProductosExport=JSON.parse(JSON.stringify(listProductosExportar));for(var n,d,c=0;c<o.length;c++)0!=t&&t!=o[c].idalmacen||(r=e="",n=parseInt(o[c].stock_minimo),d=parseInt(o[c].stock),i=""!=o[c].img?"Cambiar Imagen":"Subir Imagen",d<=n&&0!=n&&(r="stock minimo",e='<image title="stock minimo '+n+'" src="../../images/tr_alert_min.png">'),a=String(a+'<tr class="row" data-idal="'+o[c].idproducto_stock+'" data-idp="'+o[c].idproducto+'" data-idalmacen="'+o[c].idalmacen+'"><td>'+o[c].almacen+"</td><td>"+o[c].familia+'</td><td class="xCursor"><div><span onclick="xModRow(this,3);" id="td_des" data-valorginal="'+o[c].producto+'">'+o[c].producto+'<span><span class="xDerecha">'+e+'</span><span class="xInvisible">'+r+'</span></div></td><td class="sumar_stock xCursor" onclick="xModRow(this,2);" id="td_stock" data-valorginal="'+d+'" data-mod-stock="'+d+'" data-mod-precio="" data-colummn="stock">'+d+'</td><td class="xCursor" onclick="xModRow(this,1);" id="td_pventa" data-valorginal="'+o[c].precio_venta+'" data-mod-stock="" data-mod-precio="'+o[c].precio_venta+'" data-colummn="precio_venta">'+o[c].precio_venta+'</td><td class="xCursor" onclick="openDialogImg(this);"><span class="xfont11">'+i+'</span></td><td><span class="xDeleteRowNeutro" title="Borrar" onclick="xBorrarProducto(this);"></span></td></tr>'));$("#tb_productos .row").remove(),$("#tb_productos").append(a).trigger("create"),xSumarTotales(),"si"===filtroStokMin&&xBuscarXTxt("stock minimo"),xPopupLoad.xclose()}function xSumarTotales(){var o='<tr class="tr_total xBold xfont18"><td>Totales</td><td>'+xContarCantRowVisible($("#tb_productos"),".sumar_stock")+"</td><td>-</td><td>"+xSumaCantRowVisible($("#tb_productos"),".sumar_stock")+"</td><td>-</td><td>-</td><td>-</td></tr>";$("#tb_productos .tr_total").remove(),$("#tb_productos").append(o).trigger("create")}function xSumarTotalesPorcion(){var o='<tr class="tr_total xBold xfont18"><td>Totales</td><td>'+xContarCantRowVisible($("#tb_porcion"),".sumar_stock")+"</td><td>"+xSumaCantRowVisible($("#tb_porcion"),".sumar_stock")+"</td></tr>";$("#tb_porcion .tr_total").remove(),$("#tb_porcion").append(o).trigger("create")}function xModRow(o,t){var a=$(o).text();0<$(o).find("input").length||$(o).html('<input type="text" class="xMiInput xPasarEnter2 xAlinearIzquierda" onblur="xModBlur(this,'+t+')" value="'+a+'" select>').trigger("create"),$(o).find("input").select()}function xModRowPorcion(o,t){var a=$(o).text(),e=o.parentElement.dataIndex;xThisProPor.listPorciones[e].modificado=!0,0<$(o).find("input").length||$(o).html('<input type="text" class="xMiInput xPasarEnter2 xAlinearIzquierda inputCantPorcion" onblur="xModBlurPorcion(this, '+e+", "+t+')" value="'+a+'" select>').trigger("create"),$(o).find("input").select()}function xModBlurPorcion(o,t,a){var e=$(o).val(),r=($(o).parents("table"),$(o).parent(),xThisProPor.listPorciones[t]);switch(a){case 2:r.stock=xCeroIzq(e,2);break;case 3:r.porcion=e}$(o).parent().text(e),$(o).remove()}function xModBlur(o,t){var a=$(o).val(),e=($(o).parents("table"),$(o).parent());switch(t){case 1:a=xMoneda(a),e.attr("data-mod-precio",a),e.addClass("modificado");break;case 2:a=xCeroIzq(a,2),e.attr("data-mod-stock",a),e.addClass("modificado");break;case 3:e.parents("td").attr("data-mod-descripcion",a),e.parents("td").addClass("modificado")}$(o).parent().text(a),$(o).remove()}function xGuardarCambiosPorcion(){xPopupLoad.xopen();var o=xThisProPor.listPorciones.filter(o=>o.modificado);$.ajax({type:"POST",url:"../../bdphp/log_005.php?op=21",data:{data:o}}).done(o=>{setTimeout(()=>{xPopupLoad.xclose()},200)})}function xGuardarCambiosTbProductos(o){var n=new Array,t=$("#tb_productos");t=document.getElementById("tb_productos"),(listModificados=[...listModificados=t.getElementsByClassName("modificado")]).map(o=>{var t=o.dataset.modStock,a=o.dataset.modPrecio||"",e=o.dataset.modDescripcion||"",r=o.dataset.valorginal,i=o.parentElement.dataset.idp,o=o.parentElement.dataset.idal||"";n.push({idproducto:i,idproducto_stock:o,val_stock:t=r==t?"":t,val_precio:a=r==a?"":a,val_descripcion:e=r!=e&&null!=e?e:""})}),0<n.length&&(xPopupLoad.xopen(),$.ajax({type:"POST",url:"../../bdphp/log.php?op=1801",data:{array_rows:n,op:o}}).done(function(o){o=$.parseJSON(o);1!=o.success&&alert(o.error),setTimeout(()=>{xPopupLoad.xclose()},700)}))}function xBorrarProducto(o){$("#dialog_msj_confirma #titulo_msj").text("Esta seguro de elimar este producto del almacen?. puede afectar registros relacionado."),xObjRowSel=$(o).parent().parent(),dialog_msj_confirma.open()}function xBorrarProcion(o){$("#dialog_msj_confirma #titulo_msj").text("Esta seguro de elimar esta PORCION del almacen?. puede afectar registros relacionado."),xObjRowSel=$(o).parent().parent(),dialog_msj_confirma.open()}function xOkPopupConfirm(){(-1<$("#dialog_msj_confirma #titulo_msj").text().indexOf("producto")?xConfirmBorrarProducto:xConfirmBorrarPorcion)()}function xConfirmBorrarProducto(){var o=xObjRowSel.attr("data-idalmacen"),t=xObjRowSel.attr("data-idal");$.ajax({type:"POST",url:"../../bdphp/log.php?op=1802",data:{idp:t,ida:o}}).done(function(o){xObjRowSel.fadeTo(550,0,function(){$(this).remove()}),dialog_msj_confirma.close()})}function xConfirmBorrarPorcion(){var o=xObjRowSel[0].dataIndex,o=xThisProPor.listPorciones[o].idporcion;$.ajax({type:"POST",url:"../../bdphp/log.php?op=1804",data:{idp:o}}).done(function(o){xObjRowSel.fadeTo(550,0,function(){$(this).remove()}),dialog_msj_confirma.close()})}function xSeleccionarFoto(){$("#ctrl_open_file").click()}function xItemFoto(o,t){xObjImgDet=o,xIdObjImgDet=$(o).parents("tr").attr("data-id");var a=$(o).parent().text(),o=$(o).parents("tr").find("#td_img").text();$("#dlg_foto_vista_previa img").remove(),$("#dlg_btn_quitar_foto").addClass("xInvisible"),""!==o&&(o="<img src=../img/"+o+">",$("#dlg_foto_vista_previa").append(o).trigger("create"),$("#dlg_btn_quitar_foto").removeClass("xInvisible")),$("#dialog_foto #dlg_des_item").text(a),$("#ctrl_open_file").val(""),t.stopImmediatePropagation(),t.stopPropagation()}function xItemQuitarFoto(){xPopupLoad.xopen(),$(".div_foto img").remove(),$(xObjImgDet).parents("tr").find("#td_img").text(""),$.ajax({type:"POST",url:"../../bdphp/log.php?op=20701",data:{i:xIdObjImgDet,d:""}}).done(function(o){xPopupLoad.xclose()})}function xItemGuardarFotProducto(){var o=xIdObjImgDet;uploadImgProducto(compImgProducto.getImgBase64(),o)}function uploadImgProducto(o,t){$.ajax({type:"POST",url:"upload_base64.php?op=1",data:{nomfile:t,img:o}}).done(o=>{transferenciaCompleta(t=o)})}function transferenciaCompleta(t){$.ajax({type:"POST",url:"../../bdphp/log.php?op=20701",data:{i:xIdObjImgDet,d:t}}).done(function(o){$(xObjImgDet).parents("tr").find("#td_img").text(t),xPopupLoad.xclose()})}function openDialogImg(o){xObjRowSel=(xObjImgDet=o).parentElement,xIdObjImgDet=o.parentElement.dataset.idp;$(o).parent().text();var t,o=""===(o=$(o).parents("tr").find("#td_img").text())?"":URL_IMG_CARTA+o;$("#dlg_foto_vista_previa img").remove(),$("#dlg_btn_quitar_foto").addClass("xInvisible"),""!==o&&(t='<img src="'+o+'">',$("#dlg_foto_vista_previa").append(t).trigger("create"),$("#dlg_btn_quitar_foto").removeClass("xInvisible")),$("#ctrl_open_file").val(""),compImgProducto.resetControl(),compImgProducto.setImgPathFile(o),dialog_detalle.open()}function descargarListaProductos(){var o=document.getElementById("tb_export_p").outerHTML;window.open("data:application/vnd.ms-excel,"+encodeURIComponent(o)),setTimeout(()=>{xPopupLoad.xclose()},500)}Polymer({is:"x-producto-porcion",properties:{xt_org:Number,xt_idsede:Number,xt_idus:Number,xdt_prodcutos:Object,dtProFam:Object,listPorciones:[],medidaImgProducto:[],listProductosExport:[],tipoPrecios:[]},attached:function(){this.selected=0,xThisProPor=this,xIniProPor(),this.loadTiposPrecio()},loadTiposPrecio:function(){$.ajax({type:"POST",url:"../../bdphp/log_componentes.php?op=24"}).done(function(o){o=JSON.parse(o);this.tipoPrecios=o.datos})}})</script></dom-module>