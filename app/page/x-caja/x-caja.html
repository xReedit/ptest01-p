<dom-module id="x-caja"><link rel="import"href="../../x-componentes/x-comp-printer-local-select/x-comp-printer-local-select.html"><link rel="preload"href="../../../images/_msj_envio_sunat.gif"as="image"media="(max-width: 600px)"><link rel="import"href="../../x-componentes/x-comp-btn-permiso/x-comp-dialog-permiso.html"><script async src="../../view/httpFech.js"></script><script src="../../view/notifica.js"></script><script src="../../../js/PNotify.js"></script><script src="../../../js/PNotifyConfirm.js"></script><script src="../../../js/PNotifyHistory.js"></script><link rel="stylesheet"href="../../../css/PNotifyBrightTheme.css"><template><div class="xInvisible"><audio id="notificaLlamadoCliente"autobuffer preload="auto"><source src="../../../sound/notifica-llamado.mp3"type="audio/mpeg"></audio></div><x-comp-dialog-permiso id="compUsPermisoCerrarCaja"></x-comp-dialog-permiso><paper-dialog class="dialog_redondo"id="dialog_info_supervisor"style="max-width:500px"modal entry-animation="scale-up-animation"exit-animation="fade-out-animation"><div><p class="fs-18">Cunato tengo?.<p class="fw-100 text-secondary">El importe que debe tener en caja es la suma de sus ventas en efectivo <span class="fw-600 text-primary">mas</span> sus ingresos de efectivo a caja y <span class="fw-600 text-danger">menos</span> sus salidas de efectivo de caja.</p><br><p class="fw-100 text-secondary">Puede ver sus ventas en efectivo en la opción de "Registro de Pagos". Si no encuentra su diferencia, llame al supervisor.</p><br><button dialog-dismiss class="btn btn-dark mb-2"onclick="xCjPermisoSupervisor()">Ingresar clave supervisor</button><br><button dialog-dismiss class="btn btn-primary mb-2"onclick="xCjPermisoSupervisor(1)">Solicitar Permiso Remoto</button><br><button dialog-dismiss class="btn btn-secondary">Cancelar</button></div></paper-dialog><paper-dialog class="dialog_redondo"id="dialog_permiso_remoto"style="max-width:500px"modal entry-animation="scale-up-animation"exit-animation="fade-out-animation"><div><img src="../../../images/_solicitud_remoto.png"alt="solicita"><p class="fs-18">Solicitar permiso remoto.<p class="fw-100 text-secondary">Solicitar permiso al administrador para saber su diferencia y poder cerrar su caja.</p><br><p>Quien dará el permiso?</p><select class="selected-template-1"id="selAdmin"onchange="selectedUsAdmin(this)"><template is="dom-repeat"items="{{listUsAdmin}}"as="item"><option value="{{item.idusario}}">{{ item.nombres }}</template></select><br><br><p>En efectivo tengo:</p><input class="xMiInput xPasarEnter2 fs-15 fw-600 w-50"placeholder="0.00"id="txt_total_tengo"><br><br><button class="xBoton2 xVerde"onclick="xEnviarPermisoRemoto()">Enviar</button> <button dialog-dismiss class="xBoton2 xPlomo">Cancelar</button></div></paper-dialog><paper-dialog class="dialog_redondo"id="dialog_enviando_sunat"style="width:245px"modal entry-animation="scale-up-animation"exit-animation="fade-out-animation"><div style="text-align:center"><img id="dgl_sunat_img"src="../../../images/_msj_envio_sunat.gif"alt=""><p id="dgl_sunat_msj">Enviando comprobantes electronicos.<p id="dgl_sunat_msj2"class="dgl_sunat_msj2 xInvisible xColorRow_Azul">Proceso concluido con exito.<p id="dgl_sunat_msj3 xfont11"class="dgl_sunat_msj3 center xColorRow_Plomo">...</p><paper-progress id="dgl_sunat_progress"indeterminate style="width:100%"></paper-progress><button dialog-dismiss id="dlg_sunat_btn"class="xBoton2 xVerde xInvisible">Listo</button></div></paper-dialog><paper-dialog id="dialog_erro_print"modal style="min-width:330px"modal entry-animation="scale-up-animation"exit-animation="fade-out-animation"><h4>Error en impresora</h4><p id="print_error"></p><br><div class="xBoton2 xVerde"style="margin-left:23px"onclick="xReImprimirCierre()">Intentar Nuevamente</div><div class="xBoton2 xPlomo"style="margin-left:23px"dialog-dismiss onclick="dialog_detalle.close()">No imprimir</div><br><br><br></paper-dialog><paper-dialog id="dialog_cierre"modal entry-animation="scale-up-animation"exit-animation="fade-out-animation"with-backdrop><div class="xContent"><p class="xfont14"id="msj">OK cuadre conforme. Recuerde imprimir las operaciones detalladas, luego cierre su terminal.</p><br><paper-button tabindex="0"raised class="xverde"onclick=""><iron-icon icon="save"></iron-icon>Imprimir cierre</paper-button><paper-button tabindex="0"raised class="xnegro"onclick=""><iron-icon icon="save"></iron-icon>Cerrar sistema</paper-button></div></paper-dialog><x-pass id="xPSupervisor"titulo="Permiso del administrador"val="Rol1"></x-pass><br><div class="xContent"><paper-tabs selected="{{selected}}"id="tab_caja"><paper-tab>INGRESO / SALIDA DE CAJA</paper-tab><paper-tab>CIERRE DE CAJA</paper-tab></paper-tabs><div class="xLinea2"></div><br><br><iron-pages selected="{{selected}}"><div id="ingreso_caja"><div class="xDivImpresora"><x-comp-printer-local-select></x-comp-printer-local-select></div><div><br><form id="form_ingreso"onsubmit="return!1"><select class="xTextRow2 xfont18 xCursor"id="selecie"style="width:200px"><option value="1">INGRESO A CAJA<option value="2">SALIDA DE CAJA</select><br><br><p>Detalle el motivo del movimiento de efectivo.</p><input class="xMiInput xPasarEnter2"onchange="conMayusculas(this)"placeholder="Motivo"id="motivo"name="motivo"required><br><br><input type="number"class="xMiInput"placeholder="Monto"style="width:200px"pattern="[0-9]+([\.,][0-9]+)?"step="any"id="monto"name="monto"required><div class="xInvisible"><input id="idsede"name="idsede"value="[[xt_idsede]]"> <input id="idorg"name="idorg"value="[[xt_org]]"> <input id="idusuario"name="idusuario"value="[[xt_idus]]"> <input id="fecha"name="fecha"> <input id="fecha_hora"name="fecha_hora"> <input id="tipo"name="tipo"></div></form><br><br><paper-button tabindex="0"raised class="xverde"onclick="xGuardarIngreso()"><iron-icon icon="save"></iron-icon>Listo Guardar</paper-button><br><br><br><h4>Resumen de movimientos que aun no tienen cierre</h4><div class="xLinea2"></div><table id="tb_resumen_ie"width="65%"class="xtable"><thead><th width="20px">#<th align="left">Fecha<th align="left">Tipo<th align="left">Motivo<th align="right">Importe</thead></table><div hidden$="[[ !isShowIngresoVarios ]]"><br><br><div class="xLinea2"></div><br><h3>Ingresos Varios</h3><br><table><thead><th align="left">Fecha<th align="left">Metodo<th align="left">Cliente<th align="left">Concepto<th align="right">Importe<tbody><template is="dom-repeat"items="{{listIngresosVarios}}"as="item"><tr><td>{{ item.fecha }}<td>{{ item.tipo_pago }}<td>{{ item.nom_cliente }}<td>{{ item.concepto }}<td align="right">{{ item.importe }}</template></table></div><div hidden$="[[ !isShowListaAdelantoOrden ]]"><br><br><div class="xLinea2"></div><br><h3>Adelantos de ordernes de pedido</h3><br><table><thead><th>Fecha<th>Usuario<th># Orden<th>Cliente<th>Detalle<th>Importe<th>.<tbody><template is="dom-repeat"items="{{listAdelantoOrden}}"as="item"><tr><td>{{ item.fecha_hora }}<td>{{ item.usuario }}<td>{{ item.numero }}<td>{{ item.cliente_nom }}<td>{{ item.concepto }}<td>{{ item.importe }}<td><button class="btn btn-sm btn-success"data-id="[[index]]"onclick="recibirAdelanto(this)">Recibir</button></template></table></div><div hidden$="[[ !isShowListaTicketEntrada ]]"><br><br><div class="xLinea2"></div><br><h3>Tickets de Entrada</h3><span>Recibe este ingreso en tu caja</span><br><br><table><thead><th>Fecha<th>Usuario<th>Detalle<th align="right">Total<th><tbody><template is="dom-repeat"items="{{listTicketEntrada}}"as="item"><tr><td>{{ item.fecha }}<td>{{ item.usuario }}<td><table class="w-100 border-0"><template is="dom-repeat"items="{{item.lista}}"as="row"><tr class="border-0"><td class="border-0">{{ row.cantidad }}<td class="border-0">{{ row.descripcion }}<td align="right"class="fw-600 border-0">{{ row.total }}</template></table><td align="right"class="fw-600 fs-18">S/. {{ item.total }}<td><button class="btn btn-sm btn-success"data-id="[[index]]"onclick="recibirTicketEntrada(this)">Recibir</button></template></table></div></div></div><div id="cierre_caja"><div class="xTxtCierreCajaContenedor"><b><h3 id="xTituloCierre">CIERRE DE CAJA</h3></b><p class="fs-15">indique el importe en efectivo que tiene en caja, que es igual a todas las ventas en efectivo más ingresos y menos salidas de caja.</p><br><br><div hidden$="[[!isCuentasPorCobrar]]"><p class="fs-18 fw-600 text-danger">Tiene pedidos pendientes por cobrar.<p class="text-secondary">Debe cobrar todos los pedidos para cerrar caja.</p><br></div><p class="fs-16 fw-600">Total de efectivo en caja:</p><input class="xMiInput xPasarEnter2 fs-28 fw-600 w-50"data-valor="0.10"placeholder="0.00"id="txt_total_caja"><br><br><form id="formCierre"><div id="xTituloRpt"></div><div id="xTituloRpt2"></div></form><br><div id="div_espera_rpt"class="xInvisible"><p class="fw-600 fs-20 text-primary">Por favor espere la respuesta a la solicitud por parte del administrador... <i class="fa fa-circle-o-notch fa-spin"></i></p><br></div><div id="div_rpt_solicitud"class="xInvisible fs-18"><p class="fw-600">Respuesta Solicitud<p class="fw-600">Efectivo en el Sistema: {{rowRptSolicitud.importe_sistema}}<p class$="[[rowRptSolicitud.diferecia_color]]">Tiene una diferencia de: <span class="text-danger"><strong>{{rowRptSolicitud.diferencia}}<strong></strong></strong></span></p><br></div><div id="btns_cierre"><button disabled$="[[isCuentasPorCobrar]]"class="btn btn-success"onclick="xVerificar()"><i class="fa fa-check pr-1"></i>Verificar</button> <button class="btn btn-dark"onclick="dialog_info_supervisor.open()"><i class="fa fa-money pr-1"></i>Cuanto Tengo?</button></div></div><br><br><div class="xTxtCierreCajaContenedor mt-2"hidden$="[[ !isShowLastCierres ]]"><div hidden$="[[!isShowContentConsolidado]]"><hr><div hidden$="[[isShowConsolidado]]"style="background:#d9d9d9;display:inline-block;padding:7px;border-radius:5px"><p>Para ofrecer un consolidado, todos los usuarios deben cerrar caja. Falta cerrar: {{ listUsuarioFaltaCerrar }}</div><div hidden$="[[!isShowConsolidado]]"style="background:#d9d9d9;display:inline-block;padding:7px;border-radius:5px"><p class="mr-2 fw-600 fs-15">Consolidado de Ventas y Operaciones de Todas las Cajas.<p id="title_consolidado"class="mr-2 fw-600 text-secondary"></p><br><div class="pb-2"><button class="btn btn-sm btn-primary"onclick="xGenerarConsolidadoCaja()">Genear consolidado</button> <button class="btn btn-sm btn-dark mr-1"hidden$="[[!isShowBtnDownloadConsolidado]]"onclick="donwloadConsolidadoCaja()"><i class="fa fa-download"></i> Descargar Consolidado</button></div></div></div><div hidden$="[[ !isShowLastCierres ]]"><hr><br><p class="fw-600 fs-18">Ultimos cierres de caja</p><br><table width="100%"><thead><th align="left">Fecha<th align="left">Usuario<th><tbody><template is="dom-repeat"items="{{listCierres}}"as="item"><tr><td>{{ item.fecha }} {{ item.hora }}<td>{{ item.usuario }}<td><button class="btn btn-sm btn-info"data-id="[[item.idprint_server_detalle]]"onclick="reImprimirCierreHistory(this)">Re-imprimir</button></template></table></div></div><br><br></div></iron-pages><br><br><br></div><div id="ImprimeCierre"class="xInvisible"><p id="xImpTitulo"style="font-size:18px;line-height:1px">CIERRE DE CAJA<table width="290"border="0"id="xTableList"style="font-size:12px"><tr id="Seccion_total"><tr id="Seccion_caja"><tr id="Seccion_salida"><tr id="Seccion_venta_credito"><tr id="Seccion_tipo_consumo"><tr id="Seccion_estado_pedido"><tr id="Seccion_resumen_vendido"></table></div><div id="content_pdf"class="xInvisible"style="margin-top:700px"><div id="pdf_cierre"class="xInvisible border-0"style="max-width:300px;background:#fff"><div id="div_datos_cierre_caja"></div></div></div><div id="content_pdf_consolidado"class="xInvisible"style="margin-top:700px"><div id="pdf_consolidado"class="xInvisible border-0"style="max-width:300px;background:#fff"><div id="div_datos_consolidado"></div></div></div></template></dom-module><style>paper-button[raised].colorful{background:#4285f4;color:#fff}paper-button[raised].xverde{background:#43a047;color:#fff}paper-button[raised].xnegro{background:#424242;color:#fff}.xEpaciarInputCierre input{margin-bottom:20px;font-size:18px}.xTxtRojo{color:red}.xDivImpresora{float:right}</style><script src="./cocinar.resumen.boletas.js"></script><script src="../../view/config.const.js"></script><script src="../../view/xm_all.js"></script><script src="./../x-caja/cocinar.resumen.boletas.js"></script><script src="../../view/item_pedido_print_comprobante.js"></script><script src="../../view/cpe_interno.js"></script><script src="../../view/xSOAPSunat.js"></script><script src="../../view/socket.service.p.js"></script><script>var xThisCaja,xMontoTotalCaja,xSumData,xtbReport,xArrayEncabezadoCierre,xlo_idorg,xlo_idsede,xlo_us,isSocket,titleFilePDFCierre,dateIniConsolidado,dateFinConsolidado,xPermisoSupervisor=0,xArrayCierrePrint=[],xEfectivoCaja=0,nom_supervisor="",id_supervisor=0,isPrintCierreCaja=!1,xArraySumT=[],numImtentosUs=0,guadandoIngresoSalida=!1,idUsAdminPermiso=0;function xIniCaja(){xPopupLoad=document.getElementById("xLoad"),xm_LogChequea(function(){xm_log_get("ini_us"),$("body").addClass("loaded"),xThisCaja.xt_org=xIdOrg,xThisCaja.xt_idsede=xIdSede,xThisCaja.xt_idus=xIdUsuario,$("#Titulo_page").text("Movimientos de Caja"),xtbReport=$("#xTableList"),isSocket=0!==parseInt(xm_log_get("datos_org_sede")[0].pwa)}),(xPSupervisor=document.getElementById("xPSupervisor")).valor="Rol1",xPSupervisor.addEventListener("xSend",function(e){1==e.detail.xRpts[0].p&&(nom_supervisor=e.detail.xRpts[0].nomus,id_supervisor=e.detail.xRpts[0].us,xPermisoSupervisor=1,xVerificar())}),$(".xPasarEnter2").on("keyup",function(e){var o=$(this).val(),a=$(this).attr("data-valor");if("total"!=a){parseFloat(parseFloat(o)/parseFloat(a))%1==0?($(this).removeClass("xTxtRojo"),xSumarTotal()):$(this).addClass("xTxtRojo");o=e.which;if(13==o||186==o){a=$("input"),e=a.index(document.activeElement);if(null!==a[e+1]){o=a[e+1];if(void 0===o)return;if(null==(o=o.disabled?a[e+2]:o))return;o.focus()}return!1}}}),$("#form_ingreso #monto").on("keyup",function(e){e=e.which;13!=e&&186!=e||xGuardarIngreso()}),$("#form_egreso #monto").on("keyup",function(e){e=e.which;13!=e&&186!=e||xGuardarEgreso()}),$("#txt_fin").on("keyup",function(e){e=e.which;13!=e&&186!=e||xVerificar()}),$("#tab_caja").on("iron-select",function(){switch(xThisCaja.selected){case 0:xLoadResumenIS();break;case 1:xloadLastCierres()}}),document.getElementById("compUsPermisoCerrarCaja").addEventListener("xSend",e=>{e=e.detail;idUsAdminPermiso=e.idusuario_admin,xEnviarPermisoRemoto()}),xLoadUsAdminPermiso(),xThisCaja.isCheckCuentasPorCobrar=getVariableSede("switch2"),verifyCuentasPagar()}function xGuardarIngreso(){guadandoIngresoSalida||(guadandoIngresoSalida=!0,xvalidateFormInput("form_ingreso",function(e){!1===e?guadandoIngresoSalida=!1:(e=$("#form_ingreso #selecie").val(),xPopupLoad.xopen(),$("#form_ingreso #fecha").val(xDevolverFecha()+" "+xDevolverHora()),$("#form_ingreso #monto").val(xMoneda($("#form_ingreso #monto").val())),$("#form_ingreso #tipo").val(e),$("#form_ingreso #fecha_hora").val(fechaNowYYYYMMDD()),$.post("../../bdphp/ManejoBD_IUD.php?tb=ie_caja",$("#form_ingreso").serialize(),function(e){xPopupLoad.xclose(),$("#form_ingreso #motivo").val(""),$("#form_ingreso #monto").val(""),xLoadResumenIS(),guadandoIngresoSalida=!1}))}))}function xGetDataCierre(a){xThisCaja.isErrorCierre=!1,$.ajax({type:"POST",url:"../../bdphp/log.php?op=7000",data:{id:a}}).done(function(e){var o;(e=JSON.parse(e)).success?(o=JSON.parse(e.datos[0].data),e=JSON.parse(e.datos[0].titulo),$.ajax({type:"POST",url:"../../bdphp/log.php?op=70001",data:{id:a}}).done(e=>{}),xArrayCierrePrint=cocinarDataCierre(o,e),xPopupLoad.xclose(),$("#btns_cierre").html('<button class="btn btn-success ml-2" onclick="xCerrarSessionAll();"><i class="fa fa-close"></i> Cerrar Terminal</button> <button class="btn btn-warning" onclick="xDownloadPdfCierre(1);"><i class="fa fa-file-pdf-o"></i> Descargar cierre en PDF</button>'),xPermisoSupervisor=0,xIniArraysPrint(),isPrintCierreCaja||xVerificaSiFacturacionE(),xImprimirCierre(xArrayEncabezadoCierre,xArrayCierrePrint),xEscribirDatosHtml()):($("#xTituloRpt").html("<h3>Ups! hubo un problema al cerrar. Intente nuevamente</h3>"),$("#xTituloRpt").css("color","red"),xThisCaja.isErrorCierre=!0,xPopupLoad.xclose(),$("#btns_cierre").html('<button class="btn btn-primary" onclick="xVerificar();"><i class="fa-light fa-repeat"></i> Volver a Verificar</button> <button class="btn btn-warning" onclick="xDownloadPdfCierre(1);"><i class="fa fa-file-pdf-o"></i> V</button>'))})}function cocinarDataCierre(e,a){var r,t=0,i=[],n=[];return e.map((e,o)=>{r=Object.keys(e)[0],(i=JSON.parse(e[r]))&&(n.push({des:a[o].des,t1:a[o].t1,t2:a[o].t2,t3:a[o].t3,visible:0}),i.map((e,o)=>{n[t][o]=e}),t++)}),n}function xLoadResumenIS(){$("#tb_resumen_ie .row").remove(),$("#tb_resumen_ie").append('<tr class="row"><td colspan="5"><paper-spinner active></paper-spinner></td></tr>').trigger("create"),$.ajax({type:"POST",url:"../../bdphp/log.php?op=70011"}).done(function(e){for(var o="",a=0,r="",t=$.parseJSON(e).datos,i=0;i<t.length;i++)a++,r="",1!=t[i].tipo&&(r="xColorRow_Rojo"),o=String(o+'<tr class="row '+r+'"><td>'+xCeroIzq(a,2)+"</td><td>"+t[i].fecha+"</td><td>"+t[i].des_tipo+"</td><td>"+t[i].motivo+'</td><td align="right">'+t[i].monto+"</td></tr>");$("#tb_resumen_ie .row").remove(),$("#tb_resumen_ie").append(o).trigger("create")}),xLoadAdelantoOrdenPedido(),xLoadTicketsEntradaCaja(),xLoadIngresosVariosCaja()}function xLoadAdelantoOrdenPedido(){$.ajax({type:"POST",url:"../../bdphp/log_004.php?op=15"}).done(function(e){e=JSON.parse(e).datos;xThisCaja.listAdelantoOrden=e,xThisCaja.isShowListaAdelantoOrden=0<xThisCaja.listAdelantoOrden.length})}function xSumarTotal(){xMontoTotalCaja=0,$(".xTxtCierreCajaContenedor").find("input:text").each(function(e,o){var a=$(o).val();""!=a&&"total"!=$(o).attr("data-valor")&&(xMontoTotalCaja+=parseFloat(a))}),$("#TxtTotal").val(xMoneda(xMontoTotalCaja))}function verifyCuentasPagar(){if(!xThisCaja.isCheckCuentasPorCobrar)return!1;(new httpFecht).axiosExecute({type:"POST",url:"../../bdphp/log_010.php?op=check-cuentas-cobrar"},!1,!1).then(e=>{e.success&&(e=e.datos[0],xThisCaja.isCuentasPorCobrar=0<e.cantidad)})}function xVerificar(){xMontoTotalCaja=txt_total_caja.value,$("#xTituloRpt").html("<paper-spinner active></paper-spinner>").trigger("create");var e={totalcaja:parseFloat(xMontoTotalCaja),idusuario_supervisor:id_supervisor||0};$.ajax({type:"POST",url:"../../bdphp/log.php?op=70111",data:{item:e}}).done(e=>{var o,a,r,t,i,n,s,d,l;(e=JSON.parse(e)).success&&(n=i=t=r=a="",s="1"===(e=e.datos[0]).isConforme,d="1"===e.isNumIntentosAgotado,l=parseInt(e.calcTotal),s?(o="<h3>OK cuadre conforme.</h3>",a="#060",xArmarArrayPrint(e.idbitacora),xloadLastCierres()):1==xPermisoSupervisor?(isNaN(l)||(1<l?(n="(falta "+xMoneda(l)+"). ",t="xSubrayar xBold2"):(n="(sobra "+xMoneda(l)+"). ",i="xSubrayar xBold2")),o='<p class="xfont16"><strong>Efectivo: '+xMoneda(e.efectivoCaja)+" </strong> "+n+" Resultado de caja con supervision. Si <span class="+i+">tiene sobrante</span>, haga un ingreso en caja como sobrante de efectivo. Si por el contrario <span class="+t+'>tiene faltante</span>, haga una salida de caja como faltante en caja. Luego vuela a realizar el cuadre de caja, imprima los resultados y cierre su terminal. </p><a class="xCursor xfont16" onClick="xOpenPage(22);"><strong>Ver Resumen.</strong></a>',a="#8e24aa"):(a="#F00",d?o="<h3>NUMERO DE INTENTOS DE CIERRE AGOTADO, POR FAVOR LLAME AL SUPERVISOR.</h3>":(numImtentosUs=xCeroIzq(e.numintentos,2),r='<br><span class="xBold xfont14">Intentos de cierre '+xCeroIzq(e.numintentos,2)+" de "+xCeroIzq(e.numintentos_permitidos,2)+"</span> ",l<-1&&(o="<h3>Existe sobrante en caja."+r+"</h3>"),1<l&&(o="<h3>Existe faltante en caja."+r+"</h3>"))),$("#xTituloRpt").html(o),$("#xTituloRpt").css("color",a))})}function xArmarSubItems(e,o,r){var t;7021==o?(t=xArrayCierrePrint.length-1,xArrayCierrePrint[t][0]={des:"EFECTIVO EN CAJA",t1:"",t2:"",t3:xMoneda(xEfectivoCaja)},r(!0)):$.ajax({type:"POST",url:"../../bdphp/log.php?op="+o}).done(function(e){var o=$.parseJSON(e).datos;t=xArrayCierrePrint.length-1;for(var a=0;a<o.length;a++)xArrayCierrePrint[t][a]={des:o[a].descripcion,t1:o[a].t1,t2:o[a].t2,t3:o[a].t3};0==o.length?xArrayCierrePrint[t].visible=1:xArrayCierrePrint[t].visible=0,r(!0)})}function xIniArraysPrint(e=!1){xArrayEncabezadoCierre=[];var o=1==xPermisoSupervisor?"Cierre con permiso de supervisor. "+nom_supervisor:"",a=(xDtPrint=xm_log_get("sede_generales"),xDtTipoDoc=xm_log_get("app3_woIpPrintO"),xArrayImpresoras=xm_log_get("app3_woIpPrint"),xgetImpresora(-3));return isPrintCierreCaja=null==a?(xRpt='<p class="xColorRow_Rojo">No se selecciono ninguna impresora para este documento</p><a class="xCursor xfont16" onClick="xOpenPage(22);"><strong>Ver Resumen.</strong></a>',$("#xTituloRpt2").html(xRpt),!1):(xArrayEncabezadoCierre.push({ip_print:a[0].ip_print,logo:xDtPrint[0].logo,detalle_cierre:o,titulo:e?"CONSOLIDADO DE CAJA":"CIERRE DE CAJA",var_margen_iz:a[0].var_margen_iz,var_size_font:a[0].var_size_font,papel_size:a[0].papel_size}),!0)}function xArmarArrayPrint(e){xPopupLoad.xopen(),xPopupLoad.titulo="Obteniendo Datos...",xGetDataCierre(e)}function xUpdateCerrarCession(o){$.ajax({type:"POST",url:"../../bdphp/log.php?op=70012",data:{i:xIdUsuario}}).done(function(e){xPopupLoad.xclose(),$("#btns_cierre").html('<paper-button tabindex="0" raised class="xverde" onclick="xCerrarSessionAll();"><iron-icon icon="close"></iron-icon>Cerrar terminal</paper-button>'),o(!0)})}function xImprimirCierre(e,o,a=!1){var r,t;isPrintCierreCaja&&(null!=(r=window.localStorage.getItem("::app3_woIpPrintLo"))&&""!=r&&(r=$.parseJSON(r),e[0].ip_print=r.ip,e[0].var_margen_iz=r.var_margen_iz,e[0].var_size_font=r.var_size_font,e[0].papel_size=r.papel_size),r=parseInt(xm_log_get("datos_org_sede")[0].sys_local),e[0].nom_us=xm_log_get("app3_us").nomus,e[0].nom_sede=xm_log_get("datos_org_sede")[0].sedenombre,t={Array_enca:e,ArrayItem:o},1===r?(xPopupLoad.xopen(),xSendDataPrintServer(t,4,"cuadre-caja"),a?xPopupLoad.xclose():setTimeout(()=>{xPopupLoad.xclose(),xVerificaSiFacturacionE()},1e3)):a?xPopupLoad.xclose():$.ajax({type:"POST",url:"../../print/print4.php",data:{Array_enca:e,ArrayItem:o}}).done(function(e){-1!=e.indexOf("Error")?(xPopupLoad.xclose(),$("#xTituloRpt").text(e),xErrorPrint=!0,dialog_erro_print.open()):(xErrorPrint=!1,xPopupLoad.titulo="Imprimiendo...",xPopupLoad.xopen(),xVerificaSiFacturacionE())}))}function xVerificaSiFacturacionE(){"0"!==xm_log_get("datos_org_sede")[0].facturacion_e_activo?setTimeout(function(){xPopupLoad.xclose(),dialog_enviando_sunat.open(),setTimeout(()=>{xCocinarResumenBoletas()},1e3)},1500):xPopupLoad.xclose()}function xPreparaReport(){var i;new Array;$.ajax({type:"POST",url:"../../bdphp/log.php?op=7"}).done(function(e){var o=$.parseJSON(e).datos,a=0,r=0;xCadenaRG="",xTitulo='<tr><td colspan="2" style="border-bottom:1px solid;">RESUMEN GENERAL</td></tr>';for(var t=0;t<o.length;t++)"+"==o[t].operacion1&&(a=parseFloat(o[t].importe)+parseFloat(a)),"+"==o[t].operacion2&&(r=parseFloat(o[t].importe)+parseFloat(r)),"-"==o[t].operacion2&&(r=parseFloat(r)-parseFloat(o[t].importe)),xCadenaRG=String(xCadenaRG+"<tr><td>"+o[t].descripcion+'</td><td align="right">'+xMoneda(o[t].importe)+"</td></tr>");xpie_secc1='<tr><td style="border-top:1px solid;">VENTA TOTAL</td><td align="right" style="border-top:1px solid;">'+xMoneda(a)+'</td></tr><tr class="xBold" ><td style="border-top:1px solid;border-bottom:1px solid;">EFECTIVO EN CAJA</td><td style="border-top:1px solid;border-bottom:1px solid;" align="right">'+xMoneda(r)+"</td></tr>",xtbReport.find("#Seccion_total").html(xTitulo+xCadenaRG+xpie_secc1).trigger("create"),xAddReport("INGRESO DE CAJA",701,"Seccion_caja","si",i=["Descripcion","Importe"],function(){xAddReport("SALIDA DE CAJA",7002,"Seccion_salida","si",i,function(){xImprimir()})})})}function xAddReport(e,o,r,t,a,i){for(var n,s="",d=0,l="",p=0;p<a.length;p++)l=l+"<td "+(1==p?'align="right"':"")+' style="border-bottom:1px solid;">'+a[p]+"</td>";""!=a&&(l="<tr>"+l+"</tr>"),n='<tr><td colspan="2" style="border-bottom:1px solid;">'+e+"</td></tr>",$.ajax({type:"POST",url:"../../bdphp/log.php?op="+o}).done(function(e){for(var o=$.parseJSON(e),a=0;a<o.datos.length;a++)s=String(s+'<tr><td style="font-size:9px">'+o.datos[a].descripcion+'</td><td align="right">'+o.datos[a].t2+"</td></tr>"),d=parseFloat(d)+parseFloat(o.datos[a].t2);d="si"==t?'<tr><td colspan="2" align="right" style="border-top:1px dashed;">'+xMoneda(d)+"</td></tr>":"",""==s&&(s='<tr><td colspan="2">-</td></tr>'),xtbReport.find("#"+r).html(n+l+s+d+"<br>").trigger("create"),i(!0)})}function xImprimir(){$("#ImprimeCierre").find("#xImpFecha").text(xDevolverFecha()+" "+xDevolverHora()),xImprSelec("ImprimeCierre")}function xCerrarTerminal(){xCerrarSession()}function xReImprimirCierre(e){dialog_erro_print.close(),xPopupLoad.titulo="Enviando...",xPopupLoad.xopen(),xImprimirCierre(xArrayEncabezadoCierre,xArrayCierrePrint)}function xEscribirDatosHtml(e=!1){xArrayCierrePrint.map((e,o)=>{var a=0,r=0,t=0;for(const i in e)"object"==typeof e[i]&&(a+=isNaN(parseFloat(removeComas(e[i].t1)))?0:parseFloat(removeComas(e[i].t1)),r+=isNaN(parseFloat(removeComas(e[i].t2)))?0:parseFloat(removeComas(e[i].t2)),t+=isNaN(parseFloat(removeComas(e[i].t3)))?0:parseFloat(removeComas(e[i].t3)));xArraySumT[o]={t1:0==a?"":a,t2:0==r?"":r,t3:t.toFixed(2)}});var o,r,t="",i="",n=0,s=xm_log_get("datos_org_sede")[0];for(a in xArrayCierrePrint)n=0,t="",o='<thead><th align="left">'+xArrayCierrePrint[a].des+'</th><th align="right">'+xArrayCierrePrint[a].t1+'</th><th align="right">'+xArrayCierrePrint[a].t2+'</th><th align="right">'+xArrayCierrePrint[a].t3+"</th></thead>",$.map(xArrayCierrePrint[a],function(e,o){"object"==typeof e&&(n++,t=String(t+"<tr><td>"+e.des+'</td><td align="right" class="t1">'+e.t1+'</td><td class="t2" align="right">'+e.t2+'</td><td class="t3" align="right">'+e.t3+"</td><tr>"))}),r=String('<tr><td></td><td align="right"><strong>'+xArraySumT[a].t1+'</strong></td><td align="right"><strong>'+xArraySumT[a].t2+'</strong></td><td align="right"><strong>'+xArraySumT[a].t3+"</strong></td></tr>"),0!==n&&(i=String(i+'<table class="xMarginTop fs-11" width="100%">'+o+t+r+"</table><br><br>"));const d=xDevolverFecha()+" | "+xDevolverHora();var i=`<div style = "line-height: 1;">
				<h4>${e?"CONSOLIDADO DE CAJA ("+dateIniConsolidado+" -> "+dateFinConsolidado+")":"CIERRE DE CAJA "+d}</h4>				
				<h4>Local: ${s.sedenombre}</h4>				
				<h4>Ciudad: ${s.sedeciudad} </h4>
				<p>Usuario: ${xNomUsario}</p>
				<p>Intentos: <strong>${numImtentosUs}</strong></p>
				<p>Supervisor: <trong>${nom_supervisor}</strong></p>
				<br><br>
				</div>${i}
				<br><br>
				<p>papaya.com.pe</p>`,l=(e?($("#div_datos_consolidado").append(i).trigger("create"),titleFilePDFCierre="Consolidado de caja desde "+dateIniConsolidado+" hasta "+dateFinConsolidado,setTimeout(()=>{xDownloadPdfCierre(0,!0)},1500)):($("#div_datos_cierre_caja").append(i).trigger("create"),setTimeout(()=>{titleFilePDFCierre="Cierre de caja - "+xNomUsario+" "+d,xDownloadPdfCierre()},1500)),e?"Consolidado de Caha":"Cierre de Caja"),p=e?"CONSOLIDADO DE CAJA ("+dateIniConsolidado+" -> "+dateFinConsolidado+")":"CIERRE DE CAJA | "+s.sedenombre+" | "+xDevolverFecha();s.email_cierre&&(s={to:s.email_cierre,asunto:p,titulo:l,htmlContent:(e?pdf_consolidado:pdf_cierre).outerHTML},xSendEmailClienteSES(s))}function xDownloadPdfCierre(a=0,r=!1){var e=r?($("#content_pdf_consolidado").removeClass("xInvisible"),$("#pdf_consolidado").removeClass("xInvisible"),document.getElementById("pdf_consolidado")):($("#content_pdf").removeClass("xInvisible"),$("#pdf_cierre").removeClass("xInvisible"),document.getElementById("pdf_cierre"));const t=e.scrollHeight/3.77;domtoimage.toPng(e).then(function(e){var o=new Image,e=(o.src=e,new jsPDF("p","mm",[90,t]));e.addImage(o,"JPEG",5,5),e.setProperties({title:titleFilePDFCierre}),0===a?window.open(e.output("bloburl")):e.save(titleFilePDFCierre),(r?($("#pdf_consolidado").addClass("xInvisible"),$("#content_pdf_consolidado")):($("#pdf_cierre").addClass("xInvisible"),$("#content_pdf"))).addClass("xInvisible")}).catch(function(e){})}function xloadLastCierres(){$.ajax({type:"POST",url:"../../bdphp/log_004.php?op=12"}).done(function(e){e=JSON.parse(e).datos,xThisCaja.listCierres=e,xThisCaja.isShowLastCierres=0<e.length}),$.ajax({type:"POST",url:"../../bdphp/log_004.php?op=12002"}).done(function(e){e=JSON.parse(e).datos[0],dateIniConsolidado=e.f_ini,dateFinConsolidado=e.f_fin,$("#title_consolidado").text("Consolidado de caja desde "+dateIniConsolidado+" hasta "+dateFinConsolidado),$.ajax({type:"POST",url:"../../bdphp/log_004.php?op=12001"}).done(function(e){e=JSON.parse(e).datos,xThisCaja.isShowContentConsolidado=0<e.length,xThisCaja.isShowConsolidado=1==parseInt(e[0].showConsolidado),xThisCaja.listUsuarioFaltaCerrar=e.map(e=>e.nombres).join(", ")})})}function reImprimirCierreHistory(e){e=e.dataId;xPopupLoad.xopen(),$.ajax({type:"POST",url:"../../bdphp/log_005.php?op=1703",data:{idprint:e}}).done(function(e){e=JSON.parse(e).datos,e={detalle_json:(e=0<e.length?e[0]:e).detalle_json,idprint_server_detalle:e.idprint_server_detalle+(new Date).getMilliseconds(),hora:xDevolverHora(),nomUs:"Caja",nom_documento:"cuadre-caja"};_cpSocketprinterOnly(e),setTimeout(()=>{xPopupLoad.xclose()},1500)})}function recibirAdelanto(e){e=e.dataId,e=xThisCaja.listAdelantoOrden[e];e.fecha_guardar=xDevolverFecha()+" "+xDevolverHora(),$.ajax({type:"POST",url:"../../bdphp/log_004.php?op=1501",data:{data:e}}).done(function(e){xLoadResumenIS()})}function recibirTicketEntrada(e){e=e.dataId,e=xThisCaja.listTicketEntrada[e];e.fecha_guardar=xDevolverFecha()+" "+xDevolverHora(),$.ajax({type:"POST",url:"../../bdphp/log_004.php?op=1701",data:{data:e}}).done(function(e){xLoadResumenIS()})}function xOpenDialogPermisoRemotoUs(){txt_total_tengo.value=txt_total_caja.value,com_dialog_solicitud_remota_permiso.open()}function xLoadTicketsEntradaCaja(){$.ajax({type:"POST",url:"../../bdphp/log_004.php?op=17"}).done(function(e){e=JSON.parse(e).datos;xThisCaja.isShowListaTicketEntrada=!!e&&0<e.length,xThisCaja.listTicketEntrada=e.map(e=>(e.lista=JSON.parse(e.lista),e.total=parseFloat(e.total).toFixed(2),e))})}function xLoadUsAdminPermiso(){$.ajax({type:"POST",url:"../../bdphp/log.php?op=70112"}).done(function(e){xThisCaja.listUsAdmin=JSON.parse(e).datos,selectedUsAdmin(null,0)})}function xLoadIngresosVariosCaja(){$.ajax({type:"POST",url:"../../bdphp/log_004.php?op=1702"}).done(e=>{xThisCaja.listIngresosVarios=JSON.parse(e).datos,xThisCaja.isShowIngresoVarios=0<xThisCaja.listIngresosVarios.length})}function selectedUsAdmin(e,o=null){idUsAdminPermiso=(null!==o?xThisCaja.listUsAdmin[o]:xThisCaja.listUsAdmin[e.selectedIndex]).idusuario}function xEnviarPermisoRemoto(){$.ajax({type:"POST",url:"../../bdphp/log.php?op=70113",data:{idus:idUsAdminPermiso,importe:txt_total_tengo.value}}).done(function(e){$("#div_espera_rpt").removeClass("xInvisible"),dialog_permiso_remoto.close()})}function xCajaResPermisoRemoto(e){e.idusuario_solicita===xIdUsuario&&(xThisCaja.rowRptSolicitud=e,$("#div_espera_rpt").addClass("xInvisible"),$("#div_rpt_solicitud").removeClass("xInvisible"))}function xCjPermisoSupervisor(e=0){xCompArraySolitaPermiso={tipo_permiso:4,idusuario_solicita:xIdUsuario,obj:{importe_1:txt_total_caja.value||0,importe_2:0}},xCajaPermisoRemotoSupervisorData(e)}function xCajaPermisoRemotoSupervisorData(o=0){(new httpFecht).axiosExecute({type:"POST",url:"../../bdphp/log_010.php?op=show-permiso-cerrar-caja"},!1,!1).then(e=>{xThisCaja.montoEvaluar=e.datos[0].efectivo||0,xCompArraySolitaPermiso.obj.importe_2=xThisCaja.montoEvaluar,0===o?xPSupervisor.xopen():xOpenDialogPermisoRemotoUs()})}function xGenerarConsolidadoCaja(){xPopupLoad.xopen(),$.ajax({type:"POST",url:"../../bdphp/log.php?op=70002"}).done(function(e){var e=JSON.parse(e);e.success&&(e=cocinarDataCierre(JSON.parse(e.datos[0].data),JSON.parse(e.datos[0].titulo)),xArrayCierrePrint=e,xIniArraysPrint(!0),xImprimirCierre(xArrayEncabezadoCierre,e,!0),xEscribirDatosHtml(!0),xThisCaja.isShowBtnDownloadConsolidado=!0),xPopupLoad.xclose()})}function donwloadConsolidadoCaja(){xDownloadPdfCierre(1,!0)}Polymer({is:"x-caja",properties:{xt_org:Number,xt_idsede:Number,xt_idus:Number,winchaCierre:[],listCierres:[],listUsAdmin:[],isShowLastCierres:Boolean,listAdelantoOrden:[],listTicketEntrada:[],listUsuarioFaltaCerrar:String,isShowListaAdelantoOrden:Boolean,isShowEsperaRptSolicitudCierre:Boolean,isShowRptSolicitudCierre:Boolean,isShowListaTicketEntrada:Boolean,isShowIngresoVarios:Boolean,isErrorCierre:Boolean,isShowConsolidado:Boolean,isShowContentConsolidado:Boolean,isShowBtnDownloadConsolidado:Boolean,rowRptSolicitud:[],listIngresosVarios:[],montoEvaluar:{type:Number,value:0},isCuentasPorCobrar:{type:Boolean,value:!1},isCheckCuentasPorCobrar:{type:Boolean,value:!0}},attached:function(){this.selected=0,this.isErrorCierre=!1,this.isShowLastCierres=!1,this.isShowListaAdelantoOrden=!1,this.isShowEsperaRptSolicitudCierre=!1,this.isShowRptSolicitudCierre=!1,this.isShowListaTicketEntrada=!1,this.isShowIngresoVarios=!1,this.isShowConsolidado=!1,this.isShowContentConsolidado=!1,this.isShowBtnDownloadConsolidado=!1,this.listUsuarioFaltaCerrar="",xThisCaja=this,xIniCaja(),setTimeout(()=>{_cpSocketOpen()},1e3)},detached:function(){_cpSocketClose()}})</script>