<link rel="import"href="../x-componentes/pagination-input/pagination-input.html"><link rel="import"href="../x-componentes/x-comp-meta-venta/x-comp-meta-venta.html"><link rel="import"href="../x-componentes/x-comp-dialog-send-cpe/x-comp-dialog-send-cpe.html"><dom-module id="x-historial_venta"><link rel="import"href="../x-componentes/x-comp-btn-permiso/x-comp-btn-permiso.html"><link rel="import"href="../x-componentes/x-comp-btn-permiso/x-comp-dialog-permiso.html"><script src="../view/socket.master.service.js"></script><script src="../view/socket.service.p.js"></script><script src="../view/export.excel.js"></script><link rel="stylesheet"href="../../css/searchableOptionList.css"><script src="../../js/searchableOptionList.js"></script><script async src="../view/httpFech.js"></script><script src="../view/notifica.js"></script><script src="../../js/PNotify.js"></script><script src="../../js/PNotifyConfirm.js"></script><script src="../../js/PNotifyHistory.js"></script><link rel="stylesheet"href="../../css/PNotifyBrightTheme.css"><template><div class="xInvisible"><audio id="notificaLlamadoCliente"autobuffer preload="auto"><source src="../../sound/notifica-llamado.mp3"type="audio/mpeg"></audio></div><x-comp-dialog-permiso></x-comp-dialog-permiso><x-pass id="pass_us"titulo="Usuario autorizado"valor="Pe1"></x-pass><paper-dialog id="dialog_motivo_anular_historial"style="min-width:320px"entry-animation="scale-up-animation"exit-animation="fade-out-animation"with-backdrop><div class="xContent"><h4>ANULAR</h4><h4 class="txt_anular_cambiar_mesa"></h4><br><h4>Indique el motivo de anulacion</h4><div><input class="xMiInput"placeholder="Motivo..."id="txt_motivo_anular"autofocus></div><br><br><br><div class="xBoton2 xVerde"dialog-dismiss onclick="xOpenDialogAnularPedido()">Listo</div><div class="xBoton2 xRojo"dialog-dismiss>Cancelar</div><br><br></div></paper-dialog><paper-dialog id="dialog_comprobante"style="min-width:320px"entry-animation="scale-up-animation"exit-animation="fade-out-animation"with-backdrop><div class="xContent"><x-pago id="component_pago"></x-pago></div></paper-dialog><paper-dialog id="dialog_registro_detalle"class="dialog_redondo"style="overflow:auto;overscroll-behavior:auto;min-width:50%;max-width:700px"entry-animation="scale-up-animation"exit-animation="fade-out-animation"with-backdrop><div class="mb-2"><div><div class="d-flexx justify-content-between align-items-center header-registro-venta"><div style="zoom:.9"><paper-button><div class="xMiBoton_icon_lateral2"style="margin-top:-15px;width:90px"onclick="xOpenAnularPedidoHistorial()"id="btn_anular_pedido"><img src="../../images/_delete_pedido.png"><p>Anular pedido</div></paper-button><paper-button><div class="xMiBoton_icon_lateral2"style="margin-top:-15px;width:100px"onclick="xImprimirPrecuentaHistorial()"><img src="../../images/_pre_cuenta.png"><p>Imprimir pre-cuenta</div></paper-button><paper-button><div class="xMiBoton_icon_lateral2"style="margin-top:-15px;width:50px"onclick="xAbrirDialogComprobante()"><img src="../../images/_comprobante.png"><p>Emitir Comprobante</div></paper-button><paper-button hidden$="[[!xIsPuedeReimprimirCPE]]"><div class="xMiBoton_icon_lateral2"style="margin-top:-15px;width:50px"onclick="reImprimirComprobante()"><img src="../../images/_print_vr.png"><p>Reimprimir Comprobante</div></paper-button></div><button class="btn btn-sm btn-secondary ml-2"dialog-dismiss>X</button></div><br><label for="txt_comprobante"class="xfont10">Comprobante Emitido:</label><p><span id="txt_comprobante"class="xfont20">- </span><span id="txt_ref"class="xfont16 xColorRow_Morado xpadingLateralIz"></span><div class="xLinea2"></div><label for="txt_cliente"class="xfont10">Cliente:</label><p><span id="txt_cliente"class="xfont20">- </span><span id="txt_ref"class="xfont16 xColorRow_Morado xpadingLateralIz"></span><div class="xLinea2"></div><br><div class="x_div_linea"><div><label for="txt_mesa"class="xfont10">Mesa:</label><p id="txt_mesa"class="xfont20">00</div><div><label for="txt_mozo"class="xfont10">Atendido por:</label><p id="txt_mozo"class="xfont20"></div><div><label for="txt_tpc"class="xfont10">Tiempo de atencion:</label><p id="txt_tpc"class="xfont20"></div><div><label for="txt_cat"class="xfont10"></label><p id="txt_cat"class="xfont20">-</div></div><div class="xLinea2"></div><br><br><div id="xBody"></div></div></div></paper-dialog><x-comp-dialog-send-cpe id="compDialogSendCPE_RP"></x-comp-dialog-send-cpe><div class="p-5"style="max-width:1200px!important;min-width:750px!important;margin:0 auto"><div class="d-flexx w-100 justify-content-between flex-wrap"><h3>Registro de Pagos</h3><div class="div-info mb-1"><div class="div-border text-center p-2 mr-1 div-indicador"><p class="fs-12 fw-600 text-secondary">Meta Diaria</p><x-comp-meta-venta fontsize="fs-25"></x-comp-meta-venta></div><div class="div-border text-center p-2 mr-1 div-indicador"style="max-width:150px"><p class="fs-12 fw-600 text-secondary">Metodos de Pago<div class="d-flexx justify-content-center flex-wrap"><template is="dom-repeat"items="{{listCantidadPagos}}"as="item"><div><p class="fs-11 pr-2 m-0 fw-600">{{item.id}}: <span class="fw-900 text-primary">{{item.cantidad}}</span></div></template></div></div><div class="div-border text-center p-2 mr-1 div-indicador"style="max-width:80px"><p class="fs-12 fw-600 text-secondary">Comprobantes Emitidos<p class="fw-600 fs-15">{{ numComprobantesEmitidos }}</div><div class="div-border text-center p-2 div-indicador"><p class="fs-12 fw-600 text-secondary">Importe Total<p class="fw-600 fs-25 text-primary">S/. {{ importeTotalRegistrado }}</div></div></div><div class="div-border div-filter"><div><p class="fw-900">Ver Desde</p><input style="height:20px"class="selected-template-1 xCursor"id="txt_fecha"placeholder="Elige fecha"></div><div style="width:95%"><p class="fw-900">Filtro<div class="content-div-filtro"><select class="js-select2-rp selected-template-1"id="seletecFilter"multiple="multiple"><optgroup label="Cobrado Por"><template is="dom-repeat"items="{{listCobradoPorFilter}}"as="item"><option value$="[[item]]">{{item.us_caja}}</template><optgroup label="Canal de Consumo"><template is="dom-repeat"items="{{listCanalConsumoFilter}}"as="item"><option value$="[[item]]">{{item.descripcion}}</template><optgroup label="Tipo de Comprobante"><template is="dom-repeat"items="{{listTipoComprobanteFilter}}"as="item"><option value$="[[item]]">{{item.descripcion}}</template><optgroup label="Tipo de Pago"><template is="dom-repeat"items="{{listMetodoPagoFilter}}"as="item"><option value$="[[item]]">{{item.descripcion}}</template></select></div></div><div><p class="fw-900">Buscar</p><input style="height:20px"placeholder="Indique criterio a buscar..."class="selected-template-1 w-100"onkeyup="buscarEnListaRegistroPagos(this.value)"></div></div><table class="w-100 content-table-delivery"><thead><th align="left"colspan="8"><span class="text-primary fw-600 fs-15">[[cantRegistroPagos]]</span> Registros encontrados<th align="right"><div class="dropdown"><button class="btn btn-sm btn-success"><i class="fa fa-file-excel-o"></i> Exportar <i class="fa fa-angle-down"></i></button><div class="dropdown-content"><a href="#"onclick="xGenerarReporteExcelRegistroPago()">Resumen</a> <a href="#"onclick="xGenerarReporteExcelRegistroPagoDetallado()">Detallado</a></div></div></thead><thead style="height:50px"><th>#<th align="left">Fecha<th align="center">Cobrado Por<th align="left">Canal<th align="left">Atendido Por<th align="left">Cliente<th width="85px"><th align="right"width="50px"><th align="center"style="min-width:130px">Importe<tbody><template is="dom-repeat"items="[[listRegistroPagoFilter]]"as="item"><tr class$="[[ item.row_calss ]]"><td><span class="fw-600 mr-1">{{item.num}} </span><i class="fa fa-lock"hidden$="[[!item.isCierre]]"></i><td><p class="fs-11">{{ item.fecha_des }}<p class="fs-11">{{ item.hora }}<td align="center"><p class="fs-11 fw-900"style$="[[item.us_caja_class_color]]">{{ item.us_caja }}<td><p class$="[[item.class_tpc]]">{{ item.des_consumo }}<p class="badge badge-secondary fs-12"hidden$="[[ item.isDelivery ]]">{{ item.mesa }}<div class="d-flexx"style="max-width:120px"><p class="badge badge-success mr-2"hidden$="[[ !item.isScanCodigo ]]">App<p class="fs-10 fw-600">{{ item.correlativo_dia }}</div><td><div style="max-width:130px"><p class="fs-11">{{ item.nom_usuario_show }}</div><td><div style="max-width:125px"><p class="fs-10 fw-600">{{ item.nom_cliente }}<p class="fs-10 fw-600">{{ item.referencia_pedido }}</div><td align="center"><div hidden$="[[!item.isShowComprobante]]"><p class="fs-10 fw-600 m-0">{{ item.des_comprobante }} {{ item.num_comprobante }}</p><button class="btn btn-sm fs-10 btn-flat sky mt-1 d-flexx"data-id="[[item.idregistro_pago]]"onclick="xRegistroPagoReenviarComprobante(this)"><i class="fa fa-whatsapp"></i> Reenviar</button></div><td align="right"><div class="d-flexx justify-content-end"><template is="dom-repeat"items="[[item.listIconsPago]]"as="icon"><img width="18px"class="mr-1"src$="{{ icon.icon }}"alt=""></template></div><td align="right"><div class="d-flexx justify-content-end"><p class="fw-600 text-info fs-15">S/. {{ item.total }}</p><button class="xBoton_flat_2 xCursor ml-2"onclick="xloadDetallePago(this)"data-id="{{index}}">Ver</button></div></template></table></div><br><div class="xInvisible"><table width="100%"id="tbRegistroPago"><thead><th>#<th>Fecha<th>Hora<th>Cobrado Por<th>Canal<th>Atendido Por<th>Cliente<th>Comprobante<th>Productos<th>T. Pago<th align="right"style="min-width:100px">importe<th>Estado<tbody><template is="dom-repeat"items="[[listRegistroPagoFilter]]"as="item"><tr><td>{{item.num}}<td>{{item.fecha_des}}<td>{{item.hora}}<td>{{item.us_caja}}<td>{{item.des_consumo}}<td>{{item.nom_usuario_show}}<td>{{item.nom_cliente}}<td>{{item.des_comprobante}}<td><table><template is="dom-repeat"items="[[item.list_productos]]"as="prod"><tr><td>{{prod.cantidad}}<td>{{prod.item}}<td>{{prod.total}}<td>{{prod.impresora}}</template></table><td><div class="d-flexx"><table><template is="dom-repeat"items="[[item.listDesPago]]"as="tpc"><tr><td>{{tpc.descripcion}}<td>{{ tpc.importe }}</template></table></div><td>S/. {{ item.total }}<td><p>{{item.des_estado}}</template></table></div><div class="xInvisible"><table width="100%"id="tbRegistroPagoDetalle"><thead><th>#<th>Fecha<th>Hora<th>Caja<th>Canal<th>Mesa<th>Atendido Por<th>Cliente<th>Tipo Doc<th>Serie<th>Num Doc<th>Producto<th>Cantidad<th>Precio Und<th>Total<th>Seccion<th>Area<th>Estado<tbody id="tbodyRegistroPagoDetalle"><template is="dom-repeat"items="[[listRegistroPagoExportDetallado]]"as="item"><tr><td>{{item.num}}<td>{{item.fecha_des}}<td>{{item.hora}}<td>{{item.us_caja}}<td>{{item.des_consumo}}<td>{{item.nummesa}}<td>{{item.nom_usuario_show}}<td>{{item.nom_cliente}}<td>{{item.des_comprobante}}<td>{{item.comprobante_serie}}<td>{{item.comprobante_num}}<td>{{item.producto_descripcion}}<td>{{item.producto_cant}}<td>{{item.producto_punitario}}<td>{{item.producto_total_r}}<td>{{item.producto_seccion}}<td>{{item.producto_impresora}}<td>{{item.des_estado}}</td><template is="dom-repeat"items="{{item.dynamicColumn}}"as="subitem"><td>{{ subitem }}</template></template></table></div><br><br></template><style>.div-dato-registro{border-radius:8px;background:#fff;padding:5px 15px 5px 15px;text-align:center;border:1px solid #bdbdbd;margin-left:10px}.row-anulado{background:#ffe8f0;text-decoration:line-through;color:red}.div-correlativo{inline-size:230px;overflow-wrap:break-word}.header-registro-venta{background:#d4d4d4;padding:20px 25px 10px;margin-top:-32px;margin-right:-32px;margin-left:-32px}.bg-delivery{background-color:#f8f6c2}.bg-llevar{background-color:#81fad3}.bg-mesa{background-color:#46d9f2}.div-indicador{display:flex;flex-direction:column;justify-content:center}</style><script src="../view/xJsonSunat.js"></script><script src="../view/deNumALetras.js"></script><script src="../view/item_pedido_estructura.js"></script><script src="../view/item_pedido_print_comprobante.js"></script><script src="../view/cpe_interno.js"></script><script src="../view/item_pedido_subtotales.js"></script><style>.verIconFacturado img{visibility:hidden}.btn-row-delivery{border:0;border-radius:5px;color:#fff;cursor:pointer;font-size:11px}.bg-papaya{background:#571c86;color:#fff}.btn-flat{opacity:.8}.btn-flat.blue{background:#d0e6f0;border:solid 1px #81d4fa}.btn-flat.green{background:#bfefc1;border:solid 1px #81fa8a}.btn-flat.sky{background:#b1eef8;border:solid 1px #46d9f2}.btn-flat.red{background:#f8c2c2;border:solid 1px #e66060}.btn-flat:hover{opacity:1}.content-table-delivery{padding:15px 0;background:#fff;border-radius:8px;border:1px solid #e0e0e0}.content-table-delivery tr>td{border-bottom:8px solid #e5e5e7}.container-list{border:2px solid #ccc;width:300px;height:auto;overflow-y:scroll;background:#fff}.sol-container{display:flex!important}.div-border{background:#fff;border-radius:8px;border:1px solid #e0e0e0}.div-filter{display:grid;grid-template-columns:1fr 3fr 3fr;column-gap:30px;padding:20px;margin-bottom:10px;align-items:center}.div-info{display:flex;justify-content:flex-end}</style><script>var xThisHistVenta,xTotalItemSel,xidregistro_pago_sel,xDtPrint,xPSupervisor,index_historial,x_icon_facturado,xdt_pdE,listRegistroMaster,xfecha_historial="",xArrayTpC=[],xArraySeccion_r=[],xArrayDtOrdenFiltro=[],xEstado_registro_pago=0,xhtml_anulado="",xdt_h=[],arrSumSubtTotales=[],xRpt_pago=[],data_pagination={},p_rows=0,p_fecha="";function xIniHistVenta(){xPopupLoad=document.getElementById("xLoad"),x_icon_facturado='<img src="../../images/_comprobante.png" title="se emitio comprobante" width="16px">',xm_LogChequea(function(){xm_log_get("ini_us"),$("#Titulo_page").text("Registro de pagos"),$("body").addClass("loaded"),xDtPrint=xm_log_get("sede_generales"),xloadHistorial()}),$("#txt_fecha").pickadate({format:"dd mmmm, yyyy",today:"Hoy",clear:"Borrar",close:"Cerrar",onSet:function(o){xfecha_historial=o.select?new Date(o.select).toLocaleDateString():"",p_fecha=xfecha_historial,xloadHistorial()}}),$(".js-select2-rp").select2({placeholder:"Aplicar Filtro",allowHtml:!0,allowClear:!0,tags:!0,width:"100%"}),$(".js-select2-rp").on("change",o=>{xRegistroPagoListFilter([...o.target.selectedOptions].map(o=>JSON.parse(o.value)))}),$("#dialog_motivo_anular_historial").on("iron-overlay-closed",function(){$("#txt_motivo_anular").focus()}),$("#dialog_motivo_anular_historial #txt_motivo_anular").keyup(function(o){13==o.keyCode&&(dialog_motivo_anular_historial.close(),xOpenDialogAnularPedido())}),(xPSupervisor=document.getElementById("pass_us")).setVal("Pe1"),xPSupervisor.addEventListener("xSend",function(o){1===o.detail.xRpts[0].p&&(xPermisoSupervisor=o.detail.xRpts[0].us,(0==xThisHistVenta.opPermisoPass?(xCronometro_us=30,xRefreshPermiso=setInterval(function(){xcronometro_permiso()},1e3),xAnularPedidoHistorial):xShowChangeMetodoPagoRegistro)())}),(xValPago=document.getElementById("component_pago")).addEventListener("xSend",function(o){xRpt_pago=o.detail.xRpts,0!=o.detail.xRpts[0].ok&&1==o.detail.xRpts[0].paseEnterTxt&&xRegistrarClientePagoCP()}),xValPago.addEventListener("xCancelarCerrar",function(o){xThisHistVenta.$.dialog_comprobante.close()}),xValPago.addEventListener("xListoRegistraPago",function(o){xMandarCocinarImpresionComprobante_historial()}),xValPago.addEventListener("xSelectTipoComprobante",function(o){dialog_comprobante.center()}),xValPago.addEventListener("xFormClienteValid",function(o){dialog_comprobante.center()}),$(document).on("getValorIncial",".tpf_option_change_rgister",function(o){console.log("getValorIncial comp-tp",o.detail),xThisHistVenta.idTpSelected=o.detail.values})}function xOpenDialogAnularPedido(){xThisHistVenta.opPermisoPass=0,pass_us.open()}function xAbrirDialogComprobante(){xThisHistVenta.$.dialog_comprobante.open()}function xOpenAnularPedidoHistorial(){dialog_motivo_anular_historial.open()}function xAnularPedidoHistorial(){var e="";$("#tb_det_pedidos .row").each(function(o,t){e=e+","+$(t).attr("data-idpedido")}),e=e.slice(1),xPopupLoad.xopen(),$.ajax({type:"POST",url:"../../bdphp/log.php?op=5011",data:{ArrayPeAnular:"",xPedidos:e,xMotivo:$("#txt_motivo_anular").val(),u:xPermisoSupervisor,viene_historial:xidregistro_pago_sel}}).done(function(o){xPopupLoad.xclose(),$(".xMiBoton_icon_lateral").attr("disabled",!0),xloadHistorial(),dialog_registro_detalle.close()})}function xloadHistorial(){xPopupLoad.titulo="Cargando...",xPopupLoad.xopen(),data_pagination.pageFecha=""!==p_fecha?p_fecha:xDevolverFecha();$.ajax({type:"POST",url:"../../bdphp/log.php?op=20001",data:{pagination:data_pagination}}).done(function(o){o=JSON.parse(o);var s=(xdt_h=o.datos).length+1||0,r=[],n=0,d=0;xThisHistVenta.listCobradoPorFilter=[],xThisHistVenta.listCanalConsumoFilter=[],xThisHistVenta.listAtendidoPorFilter=[],xThisHistVenta.listTipoComprobanteFilter=[],xThisHistVenta.listMetodoPagoFilter=[],xdt_h.map((t,o)=>{var e=t.fecha.split(" ");let a=[],i=[];t.isFacturaEmitido=null!==t.idce,t.isPedidoApp=1===parseInt(t.app),t.isScanCodigo=0!==parseInt(t.scan_qr),t.isCierre=0!==parseInt(t.cierre),t.icon_pago.split(",").map(o=>{a.push({icon:"../../images/"+o,id:o})}),t.des_pago.split(",").map(o=>{o=o.split("-");i.push({descripcion:o[0],importe:o[1]})}),t.listIconsPago=a,t.listDesPago=i,t.referencia_pedido=t.referencia_pedido===t.nom_cliente?"":t.referencia_pedido,t.fecha_des=e[0],t.hora=e[1],t.des_comprobante=""===t.comprobante?"":"B"===t.comprobante?"Boleta":"Factura",t.isShowComprobante=""!==t.des_comprobante,t.num_comprobante="",t.isShowComprobante&&(t.num_comprobante=t.numero.split("-"),t.num_comprobante=t.num_comprobante[0]+"-"+t.num_comprobante[1].replace(/^0+/,"")),t.mesa="0"===t.nummesa?"":"Mesa "+t.nummesa,t.list_productos=t.list_productos?JSON.parse(t.list_productos):[],t.des_pago.split(",").map(o=>{const t=o.split("-")[0];var o=0===r.length?null:r.filter(o=>o.id.toLowerCase()===t.toLowerCase())[0];o?o.cantidad++:(o={id:primeraConMayusculas(t.toLowerCase()),cantidad:1},r.push(o))}),t.anulado="1"===t.estado,t.des_estado=t.anulado?"Anulado":"Cobrado",t.row_calss=t.anulado?"row-anulado":"",t.charbusqueda+=t.anulado?"anulado, borrado, eliminado":"",t.isDelivery="DELIVERY"===t.des_consumo,t.des_consumo="CONSUMIR EN EL LOCAL"===t.des_consumo?"EN LOCAL":t.des_consumo,t.class_tpc="DELIVERY"===t.des_consumo?"bg-delivery":"PARA LLEVAR"===t.des_consumo?"bg-llevar":"bg-mesa",t.class_tpc="badge fs-12 "+t.class_tpc;e=t.anulado?0:parseFloat(t.total);n+=e,d+=""!==t.comprobante?1:0,t.us_caja=t.us_caja.split(" ")[0],t.correlativo_dia=t.correlativo_dia.split(","),t.correlativo_dia=t.correlativo_dia.join(" - ");var e=(e=t.nom_usuario.split(",")).map(o=>o.split(" ")[0]),e=(t.nom_usuario=e.join(","),t.nom_usuario_show=t.nom_usuario.split(","),t.nom_usuario_show=t.nom_usuario_show.join(" - "),xColorAleatorioRegistroPagos(t.us_caja)),e=(t.us_caja_class_color=`color: ${e};`,xThisHistVenta.listCobradoPorFilter.find(o=>o.id_us_caja===t.id_us_caja)),e=(e||(e={id_us_caja:t.id_us_caja,us_caja:t.us_caja,key:"id_us_caja",value:t.id_us_caja},xThisHistVenta.listCobradoPorFilter.push(e)),xThisHistVenta.listCanalConsumoFilter.find(o=>o.idtipo_consumo===t.idtipo_consumo));e||(e={idtipo_consumo:t.idtipo_consumo,descripcion:t.des_consumo,key:"idtipo_consumo",value:t.idtipo_consumo},xThisHistVenta.listCanalConsumoFilter.push(e)),t.isShowComprobante&&!xThisHistVenta.listTipoComprobanteFilter.find(o=>o.descripcion.toUpperCase()===t.des_comprobante.toUpperCase())&&(e={descripcion:t.des_comprobante.toUpperCase(),key:"des_comprobante",value:t.des_comprobante},xThisHistVenta.listTipoComprobanteFilter.push(e)),t.listDesPago.map(t=>{var o;xThisHistVenta.listMetodoPagoFilter.find(o=>o.descripcion.toUpperCase()===t.descripcion.toUpperCase())||(o={descripcion:t.descripcion.toUpperCase(),key:"des_pago",value:t.descripcion},xThisHistVenta.listMetodoPagoFilter.push(o))}),xThisHistVenta.listAtendidoPorFilter.find(o=>o.nom_usuario===t.nom_usuario);s--,t.num=xCeroIzq(s),t.charbusqueda=`${t.nom_usuario} ${t.correlativo_dia} ${t.des_pago} ${t.des_consumo} ${t.nom_cliente} ${t.referencia_pedido} ${t.total} ${t.des_comprobante} ${t.num_comprobante} ${t.repartidor} `+t.mesa,t.charbusqueda=t.charbusqueda.toLowerCase()}),xThisHistVenta.listRegistroPagoMaster=JSON.parse(JSON.stringify(xdt_h)),xThisHistVenta.listRegistroPagoFilter=xThisHistVenta.listRegistroPagoMaster,xThisHistVenta.listRegistroPagoFilterTmp=xThisHistVenta.listRegistroPagoFilter,xThisHistVenta.listCobradoPorFilter=JSON.parse(JSON.stringify(xThisHistVenta.listCobradoPorFilter)),xThisHistVenta.listCanalConsumoFilter=JSON.parse(JSON.stringify(xThisHistVenta.listCanalConsumoFilter)),xThisHistVenta.listTipoComprobanteFilter=JSON.parse(JSON.stringify(xThisHistVenta.listTipoComprobanteFilter)),xThisHistVenta.listMetodoPagoFilter=JSON.parse(JSON.stringify(xThisHistVenta.listMetodoPagoFilter)),listRegistroMaster=xdt_h,xThisHistVenta.listCantidadPagos=r,xThisHistVenta.importeTotalRegistrado=numeroConComas(n.toFixed(2)),xThisHistVenta.numComprobantesEmitidos=xCeroIzq(d,2),xThisHistVenta.cantRegistroPagos=xThisHistVenta.listRegistroPagoFilter.length,xPopupLoad.xclose()})}function xRegistroPagoListFilter(o){var t=xThisHistVenta.listRegistroPagoMaster;o.map(o=>{t=xRegistroPagoFilterByCodes(t,o.key,o.value)}),xThisHistVenta.listRegistroPagoFilter=JSON.parse(JSON.stringify(t)),xThisHistVenta.listRegistroPagoFilterTmp=xThisHistVenta.listRegistroPagoFilter,xResumenRegistroPagoTotales()}function xRegistroPagoFilterByCodes(o,t,e){return o.filter(o=>o[t].includes(e))}function xResumenRegistroPagoTotales(){var e=xThisHistVenta.listRegistroPagoFilter.length+1||0,a=0,i=0,s=[];xThisHistVenta.listRegistroPagoFilter.map(o=>{e--,o.num=xCeroIzq(e),o.des_pago.split(",").map(o=>{const t=o.split("-")[0];var o=0===s.length?null:s.filter(o=>o.id.toLowerCase()===t.toLowerCase())[0];o?o.cantidad++:(o={id:primeraConMayusculas(t.toLowerCase()),cantidad:1},s.push(o))});var t=o.anulado?0:parseFloat(o.total);a+=t,i+=""!==o.comprobante?1:0}),xThisHistVenta.listCantidadPagos=s,xThisHistVenta.importeTotalRegistrado=numeroConComas(a.toFixed(2)),xThisHistVenta.numComprobantesEmitidos=xCeroIzq(i,2),xThisHistVenta.cantRegistroPagos=xThisHistVenta.listRegistroPagoFilter.length}function xColorAleatorioRegistroPagos(o){o=o.split(" ");return["#f44336","#e91e63","#9c27b0","#673ab7","#3f51b5","#2196f3","#03a9f4","#00bcd4","#009688","#4caf50","#8bc34a","#cddc39","#ffeb3b","#ffc107","#ff9800","#ff5722","#795548","#9e9e9e","#607d8b"][(o[0].charAt(0).toUpperCase()+(o[1]?o[1].charAt(0).toUpperCase():"")).charCodeAt(0)-65]}function xloadDetallePago(o){xPopupLoad.xopen(),$("#tb_historial tr").removeClass("xitem_seleccionado_li");var o=o.dataId,t=xThisHistVenta.listRegistroPagoFilter[o];index_historial=o,xidregistro_pago_sel=t.idregistro_pago,xEstado_registro_pago=t.estado,xTotalItemSel=t.total,xThisHistVenta.$.component_pago.setVal(xMoneda(xTotalItemSel)),xValPago.setModoSoloComprobante(),xhtml_anulado="",$(".xMiBoton_icon_lateral").attr("disabled",!1),1===xEstado_registro_pago&&(xhtml_anulado='<h3 class="xColorRow_Rojo xBold">ANULADO</h3><div class="xLinea"></div><br><h4><strong>'+xmotio_anular.toUpperCase()+"</strong></h4>",$(".xMiBoton_icon_lateral").attr("disabled",!0)),$.ajax({type:"POST",url:"../../bdphp/log.php?op=20002",data:{i:xidregistro_pago_sel}}).done(function(o){(xdt_pdE=$.parseJSON(o)).success?(o=(xdt_pdE=xdt_pdE.datos[0]).num_comprobante,$("#txt_comprobante").text(o),xThisHistVenta.xYaTieneComprobante=null!==xdt_pdE.idce,xThisHistVenta.xYaPedidoCerrado="1"===xdt_pdE.cerrado,xThisHistVenta.xIsPuedeReimprimirCPE=!xThisHistVenta.xYaPedidoCerrado&&xThisHistVenta.xYaTieneComprobante,$("#txt_cliente").text(xdt_pdE.cliente),$("#txt_mesa").text(xdt_pdE.nummesa),$("#txt_mozo").text(xdt_pdE.usuario),$("#txt_correlativo").text(xdt_pdE.correlativo_dia),$("#xBody div").remove(),$("#xBody").append('<div><paper-spinner active class="xCentradoVerticalHorizontal"></paper-spinner></div>').trigger("create"),$.ajax({type:"POST",url:"../../bdphp/log.php?op=2003",data:{i:xidregistro_pago_sel}}).done(function(o){o=$.parseJSON(o);xArrayDtOrdenFiltro=o.datos,xLoadMipedidoBDHistorial(xThisHistVenta.xdtPedDet=xArrayDtOrdenFiltro)}),setTimeout(()=>{xPopupLoad.xclose(),dialog_registro_detalle.open()},800)):(xPopupLoad.xclose(),alert(xdt_pdE.error))})}function xLoadMipedidoBDHistorial(o){var t,e,s="",r=(xArrayTpC=new Array,xArraySeccion_r=new Array,""),n=o;for(a in n)null==xArrayTpC[n[a].idtipo_consumo]&&(xArrayTpC[n[a].idtipo_consumo]={id:n[a].idtipo_consumo,des:n[a].des_tp});for(b in xArrayTpC){for(i in s="",xArraySeccion_r=new Array,n)xArrayTpC[b].id==n[i].idtipo_consumo&&(e=n[i].des_seccion,null==xArraySeccion_r[n[i].idseccion_index]&&(xArraySeccion_r[n[i].idseccion_index]='<tr><td colspan="5" class="xBold">'+e+"</td></tr>"),e=String('<tr class="row" data-i="'+i+'" data-idpedidodetalle="'+n[i].idpedido_detalle+'" data-idpedido="'+n[i].idpedido+'" data-idtipoconsumo="'+n[i].idtipo_consumo+'"><td width="7px" class="click_row_dt_p" id="td_cant">'+xCeroIzq(n[i].cantidad,2)+'</td><td class="click_row_dt_p" width="50%">'+n[i].descripcion+'</td><td class="click_row_dt_p" align="right" id="td_importe">'+xMoneda(n[i].ptotal)+"</td></tr>"),xArraySeccion_r[n[i].idseccion_index]=xArraySeccion_r[n[i].idseccion_index]+e);for(a in t='<tr><td colspan="5" class="xFondoRowBlanco xBold">'+xArrayTpC[b].des+"</td></tr>",xArraySeccion_r)s=String(s+xArraySeccion_r[a]);r=String(r+t+s)}r='<div><table width="100%" id="tb_det_pedidos" class="xRowPading4">'+r+"</table></div>",$("#xBody div").remove(),$("#xBody").html(r).trigger("create"),xSumarTotalesHis()}function xSumarTotalesHis(){var i="";$.ajax({type:"POST",url:"../../bdphp/log.php?op=2005",data:{i:xidregistro_pago_sel}}).done(function(o){var t=$.parseJSON(o);if(t.success){t=t.datos,arrSumSubtTotales=t;for(var e=0;e<t.length;e++){var a=1===parseInt(t[e].tachado)?"xTachar":"";i=String(i+'<tr class="'+a+'"><td>'+t[e].descripcion.toUpperCase()+'</td><td align="right">'+t[e].importe+"</td></tr>")}i=String(i+'<tr><td colspan="2" align="left"><h4>FORMA DE PAGO</h4></td></tr>'),$.ajax({type:"POST",url:"../../bdphp/log.php?op=2004",data:{i:xidregistro_pago_sel}}).done(function(o){var t=$.parseJSON(o);if(console.log("xdt_tpp",t),t.success){for(var t=t.datos,e=0;e<t.length;e++){var a="1"==t[e].permission_change?"":"xInvisible";i=String(i+'<tr><td><div id="row_tp_pago_detalle" data-id="'+t[e].idregistro_pago_detalle+'"><span data-id="'+t[e].idregistro_pago_detalle+'" data-idregistro_pago="'+t[e].idregistro_pago+'" data-idtp="'+t[e].idtipo_pago+'" data-importe="'+t[e].importe+'" data-destp="'+t[e].tipo_pago+'" onclick="xPermisoChangeTP(this)"><i class="fa fa-unlock text-success mr-1 punto-flotante-verde '+a+'"></i><i class="fa fa-refresh text-primary mr-1 xCursor" title="Cambiar metodo de pago"></i></span>'+t[e].tipo_pago+'</div></td><td align="right">'+t[e].importe+"</td></tr>")}i='<div class="d-flexx justify-content-end mb-2"><table width="50%" id="tb_totales" class="xRowPading4">'+i+"</table></div><br>"+xhtml_anulado,$("#xBody").append(i).trigger("create")}else xPopupLoad.xclose(),alert(t.error)})}else xPopupLoad.xclose(),alert(t.error)}),dialog_registro_detalle.center()}function xMandarCocinarImpresionComprobante_historial(){var t=xRpt_pago[0].cliente,e=xRpt_pago[0].comprobante;const a=xCargarDatosAEstructuraImpresion(xThisHistVenta.xdtPedDet);xPopupLoad.xopen(),$.ajax({type:"POST",url:"../../bdphp/log_001.php",data:{p_from:"fe",p_comprobante:e,idregistro_pago:xidregistro_pago_sel}}).done(function(o){o=xm_all_SetResponseLog_001(o);e.correlativo=xCeroIzqNumComprobante(o.correlativo_comprobante),xCocinarImprimirComprobante(a,arrSumSubtTotales,e,t,xidregistro_pago_sel,-2),xThisHistVenta.xYaTieneComprobante=!0,xdt_h[index_historial].idtipo_comprobante=e.idtipo_comprobante,$("#row_historial"+index_historial).append(x_icon_facturado),xThisHistVenta.$.dialog_comprobante.close(),xPopupLoad.xclose()})}function xImprimirPrecuentaHistorial(){var o=[],t=xArrayDtOrdenFiltro,o=xArrayTpC.slice();for(b in o=JSON.parse(JSON.stringify(o)),xArrayTpC)for(var e in t)xArrayTpC[b].id==t[e].idtipo_consumo&&1!=t[e].visible&&null!=xArrayTpC[b]&&(t[e].precio_print=t[e].ptotal,t[e].des=t[e].descripcion,o[xArrayTpC[b].id][e]=t[e]);var a=$("#txt_mesa").text(),i=$("#txt_correlativo").text();i=(i=i.split("-"))[1],xArrayPrintEncaLi_pre_cuenta={m:a,r:"",num_pedido:i,reservar:0,solo_llevar:0,correlativo_dia:i,precuenta:!0},xMandarImprimirOtroDoc(xArrayPrintEncaLi_pre_cuenta,xDtPrint,o,arrSumSubtTotales,-1)}function reImprimirCierre(){xPopupLoad.xopen(),fecha=xDevolverFechaFormatInputDate(txt_fecha.value),$.ajax({type:"POST",url:"../../bdphp/log_005.php?op=17",data:{f:fecha}}).done(function(o){setTimeout(()=>{xPopupLoad.xclose()},1500)})}function reImprimirComprobante(){xPopupLoad.xopen();var o=xdt_pdE.num_comprobante;$.ajax({type:"POST",url:"../../bdphp/log_005.php?op=1702",data:{comprobante:o}}).done(function(o){var o=0<(o=JSON.parse(o).datos).length?o[0]:o,t=xThisHistVenta.listRegistroPagoFilter[index_historial],o={detalle_json:o.detalle_json,idprint_server_detalle:o.idprint_server_detalle+(new Date).getMilliseconds(),hora:xDevolverHora(),nomUs:t.nom_usuario,nom_documento:"comprobante"};_cpSocketprinterOnly(o),setTimeout(()=>{xPopupLoad.xclose()},1500)})}function buscarEnListaRegistroPagos(t){t=t.toLowerCase(),xThisHistVenta.listRegistroPagoFilter=xThisHistVenta.listRegistroPagoFilterTmp;var o=xThisHistVenta.listRegistroPagoFilter.filter(o=>o.charbusqueda.includes(t));xThisHistVenta.listRegistroPagoFilter=JSON.parse(JSON.stringify(o)),xResumenRegistroPagoTotales()}function buscarEnLista(t){t=t.toLowerCase();var o=listRegistroMaster.filter(o=>-1<o.charbusqueda.indexOf(t)),e=o.length+1||0,a=0,i=0,s=[];o.map(o=>{e--,o.num=xCeroIzq(e),o.des_pago.split(",").map(o=>{const t=o.split("-")[0];var o=0===s.length?null:s.filter(o=>o.id.toLowerCase()===t.toLowerCase())[0];o?o.cantidad++:(o={id:primeraConMayusculas(t.toLowerCase()),cantidad:1},s.push(o))});var t=o.anulado?0:parseFloat(o.total);a+=t,i+=""!==o.comprobante?1:0}),xThisHistVenta.listCantidadPagos=s,xThisHistVenta.importeTotalRegistrado=numeroConComas(a.toFixed(2)),xThisHistVenta.numComprobantesEmitidos=xCeroIzq(i,2)}function xGenerarReporteExcelRegistroPago(){tableToExcel("tbRegistroPago","Registro de Pago")}function xGenerarReporteExcelRegistroPagoDetallado(){data_pagination.pageFecha=""!==p_fecha?p_fecha:xDevolverFecha(),xPopupLoad.xopen();try{$.ajax({type:"POST",url:"../../bdphp/log.php?op=2000101",data:{pagination:data_pagination}}).done(function(o){o=JSON.parse(o);if(o.success){o=o.datos;let e=null;var a=o.length+1||0,t=($("#tbRegistroPagoDetalle thead tr th.th_dynamic").remove(),Object.keys(o[0]).filter(o=>o.startsWith("_")));console.log("dynamicColumnsTable",t);const i=document.querySelector("#tbRegistroPagoDetalle thead tr");t.forEach(o=>{var t=document.createElement("th");t.textContent=o,t.classList.add("th_dynamic"),i.appendChild(t)});o.map(t=>{a--,t.num=xCeroIzq(a);var o=t.fecha.split(" ");t.fecha_des=o[0],t.hora=o[1],t.us_caja=t.us_caja.split(" ")[0],t.correlativo_dia=t.correlativo_dia.split(","),t.correlativo_dia=t.correlativo_dia.join(" - ");var o=(o=t.nom_usuario.split(",")).map(o=>o.split(" ")[0]),o=(t.nom_usuario=o.join(","),t.nom_usuario_show=t.nom_usuario.split(","),t.nom_usuario_show=t.nom_usuario_show.join(" - "),t.anulado="1"===t.estado,t.des_estado=t.anulado?"Anulado":"Cobrado",t.des_consumo="CONSUMIR EN EL LOCAL"===t.des_consumo?"EN LOCAL":t.des_consumo,t.des_comprobante=""===t.comprobante?"":"B"===t.comprobante?"BOLETA":"FACTURA",t.comprobante_serie="",t.comprobante_num="",t.isShowComprobante=""!==t.des_comprobante,t.isShowComprobante&&(o=t.num_comprobante.split("-"),t.comprobante_serie=o[0],t.comprobante_num=o[1]),Object.keys(t).filter(o=>o.startsWith("_")));null===e||e!==t.idregistro_pago?e=t.idregistro_pago:o.forEach(o=>{t[o]=" "}),t.dynamicColumn=[],o.forEach(o=>{t.dynamicColumn.push(t[o])})}),xThisHistVenta.listRegistroPagoExportDetallado=JSON.parse(JSON.stringify(o)),setTimeout(()=>{tableToExcel("tbRegistroPagoDetalle","Registro de Pago Detallado"),xPopupLoad.xclose()},1500)}else xPopupLoad.xclose()})}catch(o){xPopupLoad.xclose(),console.error(o)}}function xRegistroPagoReenviarComprobante(o){const t=o.dataId;o=xThisHistVenta.listRegistroPagoFilter.find(o=>o.idregistro_pago===t),o={numero:o.num_comprobante,external_id:o.cpe_external_id};document.getElementById("compDialogSendCPE_RP").open(o)}async function xPermisoChangeTP(o){xThisHistVenta.objChangeTp.idregistro_pago_detalle=o.dataset.id,xThisHistVenta.objChangeTp.idregistro_pago=o.dataset.idregistro_pago,xThisHistVenta.objChangeTp.idtipo_pago_before=o.dataset.idtp,xThisHistVenta.objChangeTp.importe=o.dataset.importe,xThisHistVenta.objChangeTp.descripcion_before=o.dataset.destp,xThisHistVenta.opPermisoPass=1;o=await findStorageSolicudPermisoRemota(xThisHistVenta.objChangeTp.idregistro_pago_detalle,3);console.log("_objPermiso",o),o?(xPermisoSupervisor=o.idusuario_admin,xThisHistVenta.objChangeTp.idusuario_admin=o.idusuario_admin,xThisHistVenta.objChangeTp.idpermiso_remoto=o.idpermiso_remoto,xShowChangeMetodoPagoRegistro()):(xCompArraySolitaPermiso={tipo_permiso:3,obj:xThisHistVenta.objChangeTp},pass_us.open())}async function xShowChangeMetodoPagoRegistro(){var o=paramsSwalAlert;return o.title='<p class="fw-600 fs-18">Elige el metodo de pago</p>',o.html=`<div class="pb-2" style="display: inline-flex;">                    
                                    <x-comp-find-tipo-pago-option class="tpf_option_change_rgister"></x-comp-find-tipo-pago-option>
                                </div>`,o.confirmButtonText="Listo, registrar",o.showCancelButton=!0,showAlertSwalHtmlDecision(o,0).then(o=>{o.isConfirmed&&(xThisHistVenta.objChangeTp.idusuario_admin=xPermisoSupervisor,xThisHistVenta.objChangeTp.idtipo_pago_after=xThisHistVenta.idTpSelected.idtipo_pago,console.log("xThisHistVenta.objChangeTp",xThisHistVenta.objChangeTp),(new httpFecht).axiosExecute({type:"POST",url:"../../bdphp/log_010.php?op=change-tipo-pago-registro-pago",data:xThisHistVenta.objChangeTp},!0,!1).then(o=>{console.log("res",o),o.success&&(o=xThisHistVenta.listRegistroPagoFilter.find(o=>o.idregistro_pago===xidregistro_pago_sel),console.log("_rowItem",o),o.listDesPago.descripcion=xThisHistVenta.idTpSelected.descripcion,o.listIconsPago[0].icon=xThisHistVenta.idTpSelected.logo,o.listIconsPago[0].id=xThisHistVenta.idTpSelected.img,xThisHistVenta.listRegistroPagoFilter=JSON.parse(JSON.stringify(xThisHistVenta.listRegistroPagoFilter)),removeStorageSolicitudPermisoRemota(xThisHistVenta.objChangeTp.idpermiso_remoto))}))})}function xRPRemoverPuntoFlotanteVerde(o){o=document.querySelector('#row_tp_pago_detalle[data-id="'+o+'"] .punto-flotante-verde');o&&o.classList.remove("xInvisible")}Polymer({is:"x-historial_venta",properties:{xdtPedDet:Object,isCierreCaja:Boolean,xYaTieneComprobante:boolean=!0,xYaPedidoCerrado:boolean=!0,xIsPuedeReimprimirCPE:boolean=!1,listRegistro:[],importeTotalRegistrado:Number,numComprobantesEmitidos:Number,cantRegistroPagos:Number,listCantidadPagos:[],listCobradoPorFilter:[],listCanalConsumoFilter:[],listAtendidoPorFilter:[],listMetodoPagoFilter:[],listTipoComprobanteFilter:[],listRegistroPagoMaster:[],listRegistroPagoFilter:[],listRegistroPagoFilterTmp:[],listRegistroPagoExportDetallado:[],listRegistroPagoExportDetalladoRowsDynamic:String,opPermisoPass:Number,idTpSelected:{},objChangeTp:{type:Object,value:{idregistro_pago_detalle:"",idregistro_pago:"",descripcion_before:"",descripcion_after:"",idtipo_pago_before:"",idtipo_pago_after:"",importe:"",idusuario_admin:""}}},attached:function(){this.opPermisoPass=0,this.xIsPuedeReimprimirCPE=!1,this.xYaTieneComprobante=!0,this.xYaPedidoCerrado=!0,this.isCierreCaja=!1,xThisHistVenta=this,xIniHistVenta(),setTimeout(()=>{_cpSocketOpen()},1e3)},detached:function(){_cpSocketClose()},displayIndex:function(o){return xCeroIzq(o+1,1)}})</script></dom-module>