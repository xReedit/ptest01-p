<dom-module id="x-recetas"><link rel="import"href="../x-componentes/x-comp-find-producto-almacen/x-comp-find-producto-almacen.html"><template><paper-dialog id="dialog_detalle_receta"class="dialog_redondo"style="max-width:700px"entry-animation="scale-up-animation"exit-animation="fade-out-animation"with-backdrop><div class="xContent"><p class="xfont11"><strong>En ingredientes</strong> ingrese en primer lugar el ingrediente principal, del cual se contara la cantidad en la carta y en el inventario. Ejemplo: Platos: Pechuga a la plancha, ingrediente principal: Pechuga 150gr.<div class="xLinea2"></div><br><div class="x_div_linea"><div class="xitem1 xBordeDe"><h3 id="xdes_item_titulo">Sopa de pollo</h3><table class="xtable4"id="tb_item"><tr class="xInvisible"id="tr_des"><td>Descripcion<td colspan="2"><input class="xMiInput xPasarEnter2 xfont18"style="width:100%"onchange="conMayusculas(this)"placeholder="Descripcion"id="txt_descripcion"espaciar><tr><td>Precio<td colspan="2"><input class="xMiInput xPasarEnter2 xfont18"style="width:50%"placeholder="Precio"id="txt_precio"onblur="xRetornaMoneda(this)"espaciar><tr><td>Costo total<td colspan="2"><input class="xMiInput xPasarEnter2 xfont18"style="width:50%"placeholder="Costo total"id="txt_costo_t"espaciar disabled="disabled"encendido><tr><td>Rentabilidad<td colspan="2"><input class="xMiInput xPasarEnter2 xfont18"style="width:50%"placeholder="Rentabilidad"id="txt_rentabilidad"espaciar disabled="disabled"encendido></table><div class="xInvisible"><form id="frm_item"method="post"action="#"><input id="iditem"name="iditem"> <input id="idorg"name="idorg"> <input id="idsede"name="idsede"> <input id="precio"name="precio"> <input id="costo"name="costo"> <input id="descripcion"name="descripcion"></form></div></div><div class="xitem3"style="width:100%!important"><p class="fs-17 fw-600">Ingredientes<p style="font-size:11px;line-height:1.4;font-weight:600">Activa el check para indicar que el ingrediente es necesario para elaborar el plato. Si este ingrediente se queda sin stock entonces el plato también quedará sin stock.</p><br><div><p class="text-secondary fs-10">Desde:</p><select class="selected-template-1"onchange="xoptionTipoSeletedReceta(this)"><option value="1">Porcion<option value="2">Producto</select></div><table class="xtable4 w-100"id="tb_ingredientes"data-tablaname="item_ingrediente"><thead><td class="xSinBorde"width="10px"><th class="xSinBorde"width="60%"><th class="xSinBorde"width="10px"><th class="xSinBorde"width="10px"><th class="xSinBorde"width="10px"></thead><tr class="xSinBorde"data-id=""><td colspan="2"><input hidden$="[[isFromRecetaProducto]]"class="xMiInput xPasarEnter2 xDesItem"placeholder="Descripcion"onchange="conMayusculas(this)"required id="des_porcion"><x-comp-find-producto-almacen id="compProductoAlmacenReceta"hidden$="[[!isFromRecetaProducto]]"placeholder="Producto"onlynomalmacen=""appendtocmp="#dialog_detalle_receta"></x-comp-find-producto-almacen><td><input type="number"class="xMiInput xPasarEnter2"placeholder="Cant"onchange="conMayusculas(this)"id="cant_item"required><td><input type="number"class="xMiInput"placeholder="Costo"onchange="conMayusculas(this)"id="costo_item"required><td><paper-fab icon="add"onclick="xAddItemIngrediente()"title="Agregar item"class="xmini"></paper-fab></table></div></div></div><br><div class="xLinea2"></div><br><br><div class="xContent"><div class="xBoton2 xAzul"onclick="xUpdateNewItem()">Listo, guardar</div><div class="xBoton2 xPlomo"dialog-dismiss>Cancelar</div></div><br></paper-dialog><br><div class="xMiCard xradius"style="width:80%"><div class="xEncanezadoCard xFondoRowAmarillo4"><p>Define la receta de cada plato de la carta y <strong>obtenga el costo y rentabilidad</strong> por plato.<p>Es importante primero definir las porciones que se utilizaran como ingredientes.</div><div class="xContentCard"><h3>Listado de platos</h3><div class="xBoton2 xVerde xDerecha"onclick="xNuevoPlato()">Nueva receta</div><br><input class="xMiInput"placeholder="Buscar..."style="width:100%"id="txt_bus"><br><br><br><table class="sortable"width="100%"id="tb_platos"><thead><tr><th width="60%"class="xCursor"id="ds">Descripcion<th width="10px"align="right"class="xCursor"id="pv">P. venta<th width="10px"align="right"class="xCursor"id="co">Costo<th width="10px"align="right"class="xCursor"id="re">Rentabilidad</thead></table></div><br><br></div></template><style></style></dom-module><script>var xThis,xidproducto_porcionado=0,xtt_ingredientes=0,xes_nuevo_item=0,xid_item="";function xIniRecetas(){xPopupLoad=document.getElementById("xLoad"),xm_LogChequea(function(){xm_log_get("ini_us"),$("body").addClass("loaded"),$("#Titulo_page").text("Recetas y costos"),$("#tb_platos").append('<tr class="row"><td colspan="5"><paper-spinner active></paper-spinner></td></tr>').trigger("create"),xListaDeRecetas(),xloadDataRecetas()}),$(".xPasarEnter2").on("keyup",function(t){var e=t.which;if(13==e||186==e){var e=$("input"),i=e.index(document.activeElement);if(null!==e[i+1]){var o=e[i+1];if(void 0===o)return;if(null==(o=o.disabled?e[i+2]:o))return;o.focus(),o.select()}return event.stopPropagation(),t.stopPropagation(),t.stopImmediatePropagation(),!1}}),$("#costo_item").on("keyup",function(t){t=t.which;13!=t&&186!=t||xAddItemIngrediente()}),$("#txt_bus").on("keyup",function(){xBuscarTbData($("#tb_platos"),$(this).val())}),$("#txt_precio").on("keyup",function(t){xRefreshImportes();t=t.which;13!=t&&186!=t||$("#des_porcion").focus()}),$("#cant_item").on("keyup",function(){var t=$("#costo_item").val(),e=$("#cant_item").val(),t=parseFloat(t)*parseFloat(e);isNaN(t)&&(t=0),t=parseFloat(t).toFixed(2),$("#costo_item").val(t)})}function xNuevoPlato(){xes_nuevo_item=1,$("#tb_item #tr_des").removeClass("xInvisible"),$("#xdes_item_titulo").addClass("xInvisible"),xNuevaIngredientes(),dialog_detalle_receta.open()}function xNuevaIngredientes(){$("#tb_ingredientes .row").remove(),$("#tb_ingredientes .row_tt").remove(),$("#frm_item").reset(),$("#txt_descripcion").val(""),$("#txt_precio").val(""),$("#txt_costo_t").val(""),$("#txt_rentabilidad").val(""),xtt_ingredientes=0,xid_item="",dialog_detalle_receta.close()}function xAbrirDetalleReceta(t){xNuevaIngredientes(),xid_item=$(t).attr("data-id"),xes_nuevo_item=0;var e=$(t).find("#xtr_des").text();e=(e=e.split("|"))[1].trim(),$("#tb_item #tr_des").addClass("xInvisible"),$("#xdes_item_titulo").removeClass("xInvisible"),$("#xdes_item_titulo").text(e),$("#txt_precio").val($(t).find("#xtr_precio").text()),$("#txt_costo_t").val($(t).find("#xtr_costo").text()),$("#txt_rentabilidad").val($(t).find("#xtr_rentabilidad").text()),$("#tb_ingredientes").append('<tr class="row"><td colspan="4"><paper-spinner active></paper-spinner></td></tr>').trigger("create"),$.ajax({type:"POST",url:"../../bdphp/log.php?op=1702",data:{i:xid_item}}).done(function(t){var e="",i=$.parseJSON(t).datos;xThis.listItemsReceta=[];for(var o=0;o<i.length;o++)var a=""+i[o].idproducto_stock+i[o].idporcion+"-"+i[o].descripcion,r={iditem_ingrediente:i[o].iditem_ingrediente,iditem:i[o].iditem,descripcion:i[o].descripcion,cantidad:i[o].cantidad,costo:i[o].costo,idporcion:i[o].idporcion,idproducto_stock:i[o].idproducto_stock,viene_de:i[o].viene_de,necesario:i[o].necesario,idrow:a,new:0,borrado:0,modificado:0},r=(xThis.listItemsReceta.push(r),"1"==i[o].necesario?"checked":""),e=String(e+'<tr class="row" data-id="'+a+'"><td><paper-checkbox '+r+' onchange="xIngredienteNecesario(this)"></paper-checkbox></td><td data-ColumName="descripcion">'+i[o].descripcion+'</td><td align="right" data-ColumName="cantidad">'+i[o].cantidad+'</td><td align="right" data-ColumName="costo" class="row_costo">'+i[o].costo+'</td><td><span class="xDeleteRowNeutro" title="Borrar" onclick="xBorrarItemLocalPro(this);"></span></td><td data-ColumName="iditem" class="xInvisible">-item</td><td data-ColumName="idporcion" class="xInvisible">'+i[o].idporcion+'</td><td data-ColumName="idproducto_stock" class="xInvisible">'+i[o].idproducto_stock+'</td><td data-ColumName="viene_de" class="xInvisible">'+i[o].viene_de+'</td><td class="xInvisible" data-ColumName="necesario" id="td_necesario">'+i[o].necesario+"</td></tr>");$("#tb_ingredientes .row").remove(),$("#tb_ingredientes").append(e).trigger("create"),xSumaringredientes()}),dialog_detalle_receta.open()}function xloadDataRecetas(){$.ajax({type:"POST",url:"../../bdphp/log.php?op=1701"}).done(function(t){t=$.parseJSON(t);xThis.dtProItem_porcion=t.datos,xCargarDtProcionesTxt()})}function xUpdateNewItem(){xPopupLoad.xopen(),$("#frm_item #iditem").val(xid_item),$("#frm_item #idorg").val(xIdOrg),$("#frm_item #idsede").val(xIdSede),$("#frm_item #precio").val($("#txt_precio").val()),$("#frm_item #costo").val($("#txt_costo_t").val()),1==xes_nuevo_item?$("#frm_item #descripcion").val($("#txt_descripcion").val()):$("#frm_item #descripcion").val($("#xdes_item_titulo").text());var t=xes_nuevo_item?$("#txt_descripcion").val():$("#xdes_item_titulo").text();$("#frm_item #descripcion").val(t),$.post("../../bdphp/ManejoBD_IUD.php?tb=item",$("#frm_item").serialize(),function(t){xid_item=t,xGuardarRegistroReceta()})}function xGuardarRegistroReceta(){var t="",e=xArmarInsertDetalle($("#tb_ingredientes"),"",""),e=(t=""!=xid_item?"modify where iditem="+xid_item+";":t)+" "+(e=e.replace(/-item/g,xid_item));$.ajax({type:"POST",url:"../../bdphp/log_100.php?op=301",data:{xsql:e,list:xThis.listItemsReceta}}).done(function(t){xPopupLoad.xclose(),xNuevaIngredientes()})}function xAddItemIngrediente(){var t,e=$("#tb_ingredientes"),i=$("#des_porcion").val(),o=$("#costo_item").val(),a=$("#cant_item").val(),r=document.getElementById("compProductoAlmacenReceta").getProductoSeletedAlmacen(),d=xThis.isFromRecetaProducto?"2":"1",n=xThis.isFromRecetaProducto?r.value:0,r=xThis.isFromRecetaProducto?r.label:i;xidproducto_porcionado=xThis.isFromRecetaProducto?0:xidproducto_porcionado,""!=r&&""!=o&&(o=parseFloat($("#costo_item").val()).toFixed(2),t={iditem_ingrediente:0,iditem:xid_item,descripcion:r,cantidad:a,costo:o,idporcion:xidproducto_porcionado,idproducto_stock:n,viene_de:d,necesario:1,idrow:i=""+xidproducto_porcionado+n+"-"+r,new:1,borrado:0,modificado:0},xThis.listItemsReceta.push(t),t='<tr class="row" data-id="'+i+'"><td><paper-checkbox checked onchange="xIngredienteNecesario(this)"></paper-checkbox></td><td data-ColumName="descripcion">'+r+'</td><td align="right" data-ColumName="cantidad">'+a+'</td><td align="right" data-ColumName="costo" class="row_costo">'+o+'</td><td><span class="xDeleteRowNeutro" title="Borrar" onclick="xBorrarItemLocalPro(this);"></span></td><td data-ColumName="iditem" class="xInvisible">-item</td><td data-ColumName="idporcion" class="xInvisible">'+xidproducto_porcionado+'</td><td data-ColumName="idproducto_stock" class="xInvisible">'+n+'</td><td data-ColumName="viene_de" class="xInvisible">'+d+'</td><td class="xInvisible" data-ColumName="necesario" id="td_necesario">1</td></tr>',e.append(t).trigger("create"),xSumaringredientes(),$("#des_porcion").val(""),$("#costo_item").val(""),$("#cant_item").val(""),$("#des_porcion").focus())}function removeItemListReceta(e){xThis.listItemsReceta.findIndex(t=>t.idrow===e);xThis.listItemsReceta.find(t=>t.idrow===e).borrado=1}function xIngredienteNecesario(t){var e=t.checked?1:0,i=$(t).parent().parent().attr("data-id"),o=xThis.listItemsReceta.find(t=>t.idrow===i);o.necesario=e,o.modificado=1,$(t).parents("tr").find("#td_necesario").text(e)}function xSumaringredientes(){xtt_ingredientes=parseFloat(xSumaCantRow($("#tb_ingredientes"),".row_costo")).toFixed(2),$("#tb_ingredientes .row_tt").remove(),$("#tb_ingredientes").append('<tr class="row_tt"><td align="right" colspan="4"><strong>'+xtt_ingredientes+"</strong></td><td></td></tr>").trigger("create"),xRefreshImportes()}function xRefreshImportes(){var t,e=$("#txt_precio").val();$("#txt_costo_t").val(xtt_ingredientes),t=parseFloat(parseFloat(e)-parseFloat(xtt_ingredientes)).toFixed(2),e=Math.round(parseFloat(t)/parseFloat(e)*100)+"%",$("#txt_rentabilidad").val(t+" | "+e)}function xBorrarItemLocalPro(t){t=$(t).parent().parent();removeItemListReceta(t.attr("data-id")),t.fadeTo(550,0,function(){$(this).remove(),xSumaringredientes()})}function xCargarDtProcionesTxt(){var i=$("#des_porcion");i.autocomplete({autoFocus:!0,source:xThis.dtProItem_porcion,appendTo:$("#dialog_detalle_receta"),select:function(t,e){return i.val(e.item.label),i.attr("data-id",e.item.value),xidproducto_porcionado=e.item.value,$("#costo_item").val(e.item.precio_unitario),$("#cant_item").val(1),!1},focus:function(t,e){return!1},change:function(t,e){return null===e.item&&(i.attr("data-value",""),i.attr("data-id",""),xidproducto_porcionado=0,$("#costo_item").val(""),$("#cant_item").val(1)),!1}})}function xListaDeRecetas(){$.ajax({type:"POST",url:"../../bdphp/log.php?op=17"}).done(function(t){for(var e="",i=$.parseJSON(t).datos,o=0;o<i.length;o++)e=String(e+'<tr class="row xCursor" data-id="'+i[o].iditem+'" onclick="xAbrirDetalleReceta(this)"><td id="xtr_des">'+i[o].descripcion+'</td><td align="right" id="xtr_precio">'+i[o].precio+'</td><td align="right" id="xtr_costo">'+i[o].costo+'</td><td align="right" id="xtr_rentabilidad">'+i[o].rentabilidad+"</td></tr>");$("#tb_platos .row").remove(),$("#tb_platos").append(e).trigger("create");document.getElementById("tb_platos")})}function xoptionTipoSeletedReceta(t){t=t.value;xThis.isFromRecetaProducto="2"==t}Polymer({is:"x-recetas",properties:{dtProItem_porcion:Object,isFromRecetaProducto:Boolean,listItemsReceta:{type:Array,value:[]}},attached:function(){this.isFromRecetaProducto=!1,xThis=this,xIniRecetas()}})</script>