<dom-module id="x-recetas"><link rel="import"href="../x-componentes/x-comp-find-producto-almacen/x-comp-find-producto-almacen.html"><template><paper-dialog id="dialog_detalle_receta"class="dialog_redondo"style="max-width:900px"entry-animation="scale-up-animation"exit-animation="fade-out-animation"with-backdrop><div class="xContent"><p class="xfont11"><strong>En ingredientes</strong> ingrese en primer lugar el ingrediente principal, del cual se contara la cantidad en la carta y en el inventario. Ejemplo: Platos: Pechuga a la plancha, ingrediente principal: Pechuga 150gr.<div class="xLinea2"></div><br><div class="x_div_linea"><div class="xitem1 xBordeDe"><h3 id="xdes_item_titulo">Sopa de pollo</h3><table class="xtable4"id="tb_item"><tr class="xInvisible"id="tr_des"><td>Descripcion<td colspan="2"><input class="xMiInput xPasarEnter2 xfont18"style="width:100%"onchange="conMayusculas(this)"placeholder="Descripcion"id="txt_descripcion"espaciar><tr><td>Precio<td colspan="2"><input class="xMiInput xPasarEnter2 xfont18"style="width:50%"placeholder="Precio"id="txt_precio"onblur="xRetornaMoneda(this)"espaciar><tr><td>Costo total<td colspan="2"><input class="xMiInput xPasarEnter2 xfont18"style="width:50%"placeholder="Costo total"id="txt_costo_t"espaciar disabled="disabled"encendido><tr><td>Rentabilidad<td colspan="2"><input class="xMiInput xPasarEnter2 xfont18"placeholder="Rentabilidad"id="txt_rentabilidad"espaciar disabled="disabled"encendido></table><div class="xInvisible"><form id="frm_item"method="post"action="#"><input id="iditem"name="iditem"> <input id="idorg"name="idorg"> <input id="idsede"name="idsede"> <input id="precio"name="precio"> <input id="costo"name="costo"> <input id="descripcion"name="descripcion"></form></div></div><div class="xitem3"style="width:100%!important"><p class="fs-17 fw-600">Ingredientes<p style="font-size:11px;line-height:1.4;font-weight:600">Activa el check para indicar que el ingrediente es necesario para elaborar el plato. Si este ingrediente se queda sin stock entonces el plato también quedará sin stock.</p><br><div><p class="text-secondary fs-10">Desde:</p><select class="selected-template-1"id="select_tipo_receta"onchange="xoptionTipoSeletedReceta(this)"><option value="1">Porcion<option value="2">Producto<option value="3">Subreceta</select></div><table class="xtable4 w-100"id="tb_ingredientes"data-tablaname="item_ingrediente"><thead><td class="xSinBorde"width="5px"><th class="xSinBorde"width="50%"><th class="xSinBorde"width="20px"><th class="xSinBorde"width="10px"><th class="xSinBorde"width="10px"></thead><tr class="xSinBorde"data-id=""><td colspan="2"><input class="xMiInput xPasarEnter2 xDesItem"placeholder="Buscar porción"onchange="conMayusculas(this)"required id="des_porcion"> <input class="xMiInput xPasarEnter2 xDesItem"placeholder="Buscar subreceta"onchange="conMayusculas(this)"id="des_subreceta"style="display:none"><x-comp-find-producto-almacen id="compProductoAlmacenReceta"hidden$="[[!isFromRecetaProducto]]"placeholder="Producto"onlynomalmacen=""appendtocmp="#dialog_detalle_receta"></x-comp-find-producto-almacen><td><div><p style="margin-top:-28px;text-align:center;line-height:1.2em"class="fs-10"hidden="[[!isProductoConversion]]">Cantidad en: <span class="text-success w-50"><strong>{{undConvercion.unidad}}</strong></span></p><input type="number"class="xMiInput xPasarEnter2 text-center"placeholder="Cant"on-keyup="calcCostoConversion"id="cant_item"required></div><td><input type="number"class="xMiInput text-center"placeholder="Costo"id="costo_item"readonly="[[isProductoConversion]]"required><td><paper-fab icon="add"onclick="xAddItemIngrediente()"title="Agregar item"class="xmini"></paper-fab></table></div></div></div><br><div class="xLinea2"></div><br><br><div class="xContent"><div class="xBoton2 xAzul"onclick="xUpdateNewItem()">Listo, guardar</div><div class="xBoton2 xPlomo"dialog-dismiss>Cancelar</div></div><br></paper-dialog><br><div class="xMiCard xradius"style="width:80%"><div class="xEncanezadoCard xFondoRowAmarillo4"><p>Define la receta de cada plato de la carta y <strong>obtenga el costo y rentabilidad</strong> por plato.<p>Es importante primero definir las porciones que se utilizaran como ingredientes.</div><div class="xContentCard"><div class="d-flexx justify-content-between"><h3>Listado de platos</h3><div class="d-flexx"><div class="xBoton2 xVerde xDerecha"onclick="xGoSubReceta()">Subreceta</div></div></div><br><input class="xMiInput"placeholder="Buscar..."style="width:100%"id="txt_bus"><br><br><br><table class="sortable"width="100%"id="tb_platos"><thead><tr><th width="60%"class="xCursor"id="ds">Descripcion<th width="10px"align="right"class="xCursor"id="pv">P. venta<th width="10px"align="right"class="xCursor"id="co">Costo<th width="10px"align="right"class="xCursor"id="re">Rentabilidad</thead></table></div><br><br></div></template><style>.ui-autocomplete{z-index:9999!important;max-height:200px;overflow-y:auto;overflow-x:hidden}</style></dom-module><script>var xThis,xidproducto_porcionado=0,xtt_ingredientes=0,xes_nuevo_item=0,xid_item="";function xIniRecetas(){xPopupLoad=document.getElementById("xLoad"),xm_LogChequea(function(){xm_log_get("ini_us"),$("body").addClass("loaded"),$("#Titulo_page").text("Recetas y costos"),$("#tb_platos").append('<tr class="row"><td colspan="5"><paper-spinner active></paper-spinner></td></tr>').trigger("create"),xListaDeRecetas(),xloadDataRecetas()}),$(".xPasarEnter2").on("keyup",function(e){var t=e.which;if(13==t||186==t){var t=$("input"),i=t.index(document.activeElement);if(null!==t[i+1]){var o=t[i+1];if(void 0===o)return;if(null==(o=o.disabled?t[i+2]:o))return;o.focus(),o.select()}return event.stopPropagation(),e.stopPropagation(),e.stopImmediatePropagation(),!1}}),$("#costo_item").on("keyup",function(e){e=e.which;13!=e&&186!=e||xAddItemIngrediente()}),$("#txt_bus").on("keyup",function(){xBuscarTbData($("#tb_platos"),$(this).val())}),$("#txt_precio").on("keyup",function(e){xRefreshImportes();e=e.which;13!=e&&186!=e||$("#des_porcion").focus()}),$("#cant_item").on("keyup",function(){var e,t;xThis.isFromRecetaProducto||(t=$("#costo_item").val(),e=$("#cant_item").val(),t=parseFloat(t)*parseFloat(e),isNaN(t)&&(t=0),t=parseFloat(t).toFixed(2),$("#costo_item").val(t))}),document.getElementById("compProductoAlmacenReceta").addEventListener("productoSeleted",function(e){e=e.detail;xThis.isProductoConversion="1"===e.para_receta,xThis.isProductoConversion&&$.ajax({type:"POST",url:"../../bdphp/log_010.php?op=get-und-conversion-by-id",contentType:"application/json",data:JSON.stringify({id:e.idunidad_conversion})}).done(function(e){e=JSON.parse(e);xThis.undConvercion=e.datos[0]}),xThis.productoSeleted=e})}function xNuevoPlato(){xes_nuevo_item=1,$("#tb_item #tr_des").removeClass("xInvisible"),$("#xdes_item_titulo").addClass("xInvisible"),xNuevaIngredientes(),dialog_detalle_receta.open()}function xNuevaIngredientes(){$("#tb_ingredientes .row").remove(),$("#tb_ingredientes .row_tt").remove(),$("#frm_item").reset(),$("#txt_descripcion").val(""),$("#txt_precio").val(""),$("#txt_costo_t").val(""),$("#txt_rentabilidad").val(""),xtt_ingredientes=0,xid_item="",dialog_detalle_receta.close()}function xAbrirDetalleReceta(e){xNuevaIngredientes(),xid_item=$(e).attr("data-id"),xes_nuevo_item=0;var t=$(e).find("#xtr_des").text();t=(t=t.split("|"))[1].trim(),$("#tb_item #tr_des").addClass("xInvisible"),$("#xdes_item_titulo").removeClass("xInvisible"),$("#xdes_item_titulo").text(t),$("#txt_precio").val($(e).find("#xtr_precio").text()),$("#txt_costo_t").val($(e).find("#xtr_costo").text()),$("#txt_rentabilidad").val($(e).find("#xtr_rentabilidad").text()),$("#tb_ingredientes").append('<tr class="row"><td colspan="4"><paper-spinner active></paper-spinner></td></tr>').trigger("create"),$.ajax({type:"POST",url:"../../bdphp/log.php?op=1702",data:{i:xid_item}}).done(function(e){var t="",i=$.parseJSON(e).datos;xThis.listItemsReceta=[];for(var o=0;o<i.length;o++)var a=i[o].idsubreceta||0,r=""+i[o].idproducto_stock+i[o].idporcion+a+"-"+i[o].descripcion,d={iditem_ingrediente:i[o].iditem_ingrediente,iditem:i[o].iditem,descripcion:i[o].descripcion,cantidad:i[o].cantidad_show,costo:i[o].costo,idporcion:i[o].idporcion,idproducto_stock:i[o].idproducto_stock,idsubreceta:a,viene_de:i[o].viene_de,necesario:i[o].necesario,und_medida:i[o].und_medida,idrow:r,new:0,borrado:0,modificado:0},d=(xThis.listItemsReceta.push(d),"1"==i[o].necesario?"checked":""),t=String(t+'<tr class="row" data-id="'+r+'"><td colspan="2" data-ColumName="descripcion"><paper-checkbox class="m-0" '+d+' onchange="xIngredienteNecesario(this)"></paper-checkbox>'+i[o].descripcion+'</td><td align="center" data-ColumName="cantidad">'+i[o].cantidad_show+i[o].und_medida+'</td><td align="right" data-ColumName="costo" class="row_costo">'+i[o].costo+'</td><td><span class="xDeleteRowNeutro" title="Borrar" onclick="xBorrarItemLocalPro(this);"></span></td><td data-ColumName="iditem" class="xInvisible">-item</td><td data-ColumName="idporcion" class="xInvisible">'+i[o].idporcion+'</td><td data-ColumName="idproducto_stock" class="xInvisible">'+i[o].idproducto_stock+'</td><td data-ColumName="idsubreceta" class="xInvisible">'+a+'</td><td data-ColumName="viene_de" class="xInvisible">'+i[o].viene_de+'</td><td class="xInvisible" data-ColumName="necesario" id="td_necesario">'+i[o].necesario+"</td></tr>");$("#tb_ingredientes .row").remove(),$("#tb_ingredientes").append(t).trigger("create"),xSumaringredientes()}),dialog_detalle_receta.open()}function xloadDataRecetas(){$.ajax({type:"POST",url:"../../bdphp/log.php?op=1701"}).done(function(e){e=$.parseJSON(e);xThis.dtProItem_porcion=e.datos,xCargarDtProcionesTxt()}),$.ajax({type:"POST",url:"../../bdphp/log_subrecetas.php?op=listar_autocomplete"}).done(function(e){xThis.dtSubrecetas=e.datos,xCargarSubrecetasTxt()})}function xUpdateNewItem(){xPopupLoad.xopen(),$("#frm_item #iditem").val(xid_item),$("#frm_item #idorg").val(xIdOrg),$("#frm_item #idsede").val(xIdSede),$("#frm_item #precio").val($("#txt_precio").val()),$("#frm_item #costo").val($("#txt_costo_t").val()),1==xes_nuevo_item?$("#frm_item #descripcion").val($("#txt_descripcion").val()):$("#frm_item #descripcion").val($("#xdes_item_titulo").text());var e=xes_nuevo_item?$("#txt_descripcion").val():$("#xdes_item_titulo").text();$("#frm_item #descripcion").val(e),$.post("../../bdphp/ManejoBD_IUD.php?tb=item",$("#frm_item").serialize(),function(e){xid_item=e,xGuardarRegistroReceta()})}function xGuardarRegistroReceta(){var e="",t=xArmarInsertDetalle($("#tb_ingredientes"),"",""),t=(e=""!=xid_item?"modify where iditem="+xid_item+";":e)+" "+(t=t.replace(/-item/g,xid_item));$.ajax({type:"POST",url:"../../bdphp/log_100.php?op=301",data:{xsql:t,list:xThis.listItemsReceta}}).done(function(e){xPopupLoad.xclose(),xNuevaIngredientes()})}function xAddItemIngrediente(){var e=$("#tb_ingredientes"),t=$("#des_porcion").val(),i=$("#costo_item").val(),o=$("#cant_item").val(),a=xThis.isFromRecetaProducto&&xThis.undConvercion?xThis.undConvercion.abreviatura:"",r=document.getElementById("compProductoAlmacenReceta").getProductoSeletedAlmacen();let d="1";xThis.isFromRecetaProducto&&(d="2"),xThis.isFromSubreceta&&(d="3");var n=xThis.isFromRecetaProducto?r.value:0,s=xThis.isFromSubreceta?xidsubreceta_seleccionada:0;let c=t,l=(xThis.isFromRecetaProducto&&(c=r.label),xThis.isFromSubreceta&&(c=$("#des_subreceta").val()),o);xThis.isFromRecetaProducto&&xThis.undConvercion&&(t=calcularCantidadDescuento(o,xThis.undConvercion,r),l=t.cantidadDescontar),!isNaN(l)&&isFinite(l)||(l=o),xidproducto_porcionado=xThis.isFromRecetaProducto||xThis.isFromSubreceta?0:xidproducto_porcionado,""!=c&&""!=i&&(i=parseFloat($("#costo_item").val()).toFixed(2),r=""+xidproducto_porcionado+n+s+"-"+c,t={iditem_ingrediente:0,iditem:xid_item,descripcion:c,cantidad:l,cantidad_show:o,costo:i,idporcion:xidproducto_porcionado,idproducto_stock:n,idsubreceta:s,viene_de:d,necesario:1,idrow:r,new:1,borrado:0,modificado:0,und_medida:a},xThis.listItemsReceta.push(t),t='<tr class="row" data-id="'+r+'"><td colspan="2" data-ColumName="descripcion"><paper-checkbox checked onchange="xIngredienteNecesario(this)"></paper-checkbox>'+c+'</td><td align="right" data-ColumName="cantidad">'+o+a+'</td><td align="right" data-ColumName="costo" class="row_costo">'+i+'</td><td><span class="xDeleteRowNeutro" title="Borrar" onclick="xBorrarItemLocalPro(this);"></span></td><td data-ColumName="iditem" class="xInvisible">-item</td><td data-ColumName="idporcion" class="xInvisible">'+xidproducto_porcionado+'</td><td data-ColumName="idproducto_stock" class="xInvisible">'+n+'</td><td data-ColumName="idsubreceta" class="xInvisible">'+s+'</td><td data-ColumName="viene_de" class="xInvisible">'+d+'</td><td class="xInvisible" data-ColumName="necesario" id="td_necesario">1</td></tr>',e.append(t).trigger("create"),xSumaringredientes(),$("#des_porcion").val(""),$("#des_subreceta").val(""),$("#costo_item").val(""),$("#cant_item").val(""),xidsubreceta_seleccionada=0,(xThis.isFromSubreceta?$("#des_subreceta"):$("#des_porcion")).focus())}function calcularCantidadDescuento(e,t,i){var o;return isNaN(e)||e<=0?{error:!0,mensaje:"La cantidad de la receta debe ser un número positivo",cantidadDescontar:0}:t?(t=t?t.abreviatura:"",!(i=parseFloat(i.factor_conversion)||0)||i<=0?{error:!0,mensaje:"El factor de conversión debe ser un número positivo",cantidadDescontar:e}:(o=e/i,isNaN(o)||!isFinite(o)?{error:!0,mensaje:"Error en el cálculo de conversión",cantidadDescontar:e}:{error:!1,cantidadReceta:e,unidadReceta:t,cantidadDescontar:o=parseFloat(o.toFixed(4)),factorConversion:i,textoReceta:e+" "+t,textoInventario:o})):{error:!0,mensaje:"La unidad de conversión no es válida",cantidadDescontar:e}}function removeItemListReceta(t){xThis.listItemsReceta.findIndex(e=>e.idrow===t);xThis.listItemsReceta.find(e=>e.idrow===t).borrado=1}function xIngredienteNecesario(e){var t=e.checked?1:0,i=$(e).parent().parent().attr("data-id"),o=xThis.listItemsReceta.find(e=>e.idrow===i);o.necesario=t,o.modificado=1,$(e).parents("tr").find("#td_necesario").text(t)}function xSumaringredientes(){xtt_ingredientes=parseFloat(xSumaCantRow($("#tb_ingredientes"),".row_costo")).toFixed(2),$("#tb_ingredientes .row_tt").remove(),$("#tb_ingredientes").append('<tr class="row_tt"><td align="right" colspan="4"><strong>'+xtt_ingredientes+"</strong></td><td></td></tr>").trigger("create"),xRefreshImportes()}function xRefreshImportes(){var e,t=$("#txt_precio").val();$("#txt_costo_t").val(xtt_ingredientes),e=parseFloat(parseFloat(t)-parseFloat(xtt_ingredientes)).toFixed(2),t=Math.round(parseFloat(e)/parseFloat(t)*100)+"%",$("#txt_rentabilidad").val(e+" | "+t)}function xBorrarItemLocalPro(e){e=$(e).parent().parent();removeItemListReceta(e.attr("data-id")),e.fadeTo(550,0,function(){$(this).remove(),xSumaringredientes()})}function xCargarDtProcionesTxt(){var i=$("#des_porcion");i.autocomplete({autoFocus:!0,source:xThis.dtProItem_porcion,appendTo:$("#dialog_detalle_receta"),select:function(e,t){return i.val(t.item.label),i.attr("data-id",t.item.value),xidproducto_porcionado=t.item.value,$("#costo_item").val(t.item.precio_unitario),$("#cant_item").val(1),!1},focus:function(e,t){return!1},change:function(e,t){return null===t.item&&(i.attr("data-value",""),i.attr("data-id",""),xidproducto_porcionado=0,$("#costo_item").val(""),$("#cant_item").val(1)),!1}})}function xListaDeRecetas(){$.ajax({type:"POST",url:"../../bdphp/log.php?op=17"}).done(function(e){for(var t="",i=$.parseJSON(e).datos,o=0;o<i.length;o++)t=String(t+'<tr class="row xCursor" data-id="'+i[o].iditem+'" onclick="xAbrirDetalleReceta(this)"><td id="xtr_des">'+i[o].descripcion+'</td><td align="right" id="xtr_precio">'+i[o].precio+'</td><td align="right" id="xtr_costo">'+i[o].costo+'</td><td align="right" id="xtr_rentabilidad">'+i[o].rentabilidad+"</td></tr>");$("#tb_platos .row").remove(),$("#tb_platos").append(t).trigger("create");document.getElementById("tb_platos")})}function xoptionTipoSeletedReceta(e){e=e.value;xThis.isFromRecetaProducto="2"==e,xThis.isFromSubreceta="3"==e,xThis.isProductoConversion=!1,"1"==e?($("#des_porcion").show(),$("#des_subreceta").hide()):"3"==e?($("#des_porcion").hide(),$("#des_subreceta").show()):($("#des_porcion").hide(),$("#des_subreceta").hide())}var xidsubreceta_seleccionada=0;function xCargarSubrecetasTxt(){var i=$("#des_subreceta");i.hasClass("ui-autocomplete-input")&&i.autocomplete("destroy"),i.autocomplete({autoFocus:!0,source:xThis.dtSubrecetas,appendTo:"#dialog_detalle_receta",minLength:0,select:function(e,t){return i.val(t.item.label),i.attr("data-id",t.item.value),xidsubreceta_seleccionada=t.item.value,$("#costo_item").val(t.item.precio_unitario),$("#cant_item").val(1),!1},focus:function(e,t){return!1},change:function(e,t){return null===t.item&&(i.attr("data-value",""),i.attr("data-id",""),xidsubreceta_seleccionada=0,$("#costo_item").val(""),$("#cant_item").val(1)),!1}})}function xGoSubReceta(){window.location.href="#/subreceta"}Polymer({is:"x-recetas",properties:{dtProItem_porcion:Object,dtSubrecetas:Object,isFromRecetaProducto:Boolean,isFromSubreceta:{type:Boolean,value:!1},listItemsReceta:{type:Array,value:[]},isProductoConversion:{type:Boolean,value:!1},undKardex:{},undConvercion:{},productoSeleted:{type:Object,value:{}}},attached:function(){this.isFromRecetaProducto=!1,this.isFromSubreceta=!1,xThis=this,xIniRecetas()},calcCostoConversion:function(e){this.isFromRecetaProducto&&(e=parseFloat(e.target.value),e=this.productoSeleted.costo_conversion*e,costo_item.value=e)}})</script>