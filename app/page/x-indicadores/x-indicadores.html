<dom-module id="x-indicadores"><link rel="import"href="../../x-componentes/pagination-input/pagination-input.html"><link rel="import"href="../../x-componentes/x-comp-find-sede/x-comp-find-sede.html"><script src="../../../js/raphael.2.1.0.min.js"></script><script src="../../../js/justgage.js"></script><script src="../../../js/crossfilter.min.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.9.3/Chart.min.js"></script><script src="../../view/socket.service.p.js"></script><template is="dom"><paper-dialog id="dialog_meta"modal style="min-width:330px"modal entry-animation="scale-up-animation"exit-animation="fade-out-animation"><h4>Meta diaria</h4><span>Establesca una meta diaria de ventas.</span><div><input type="number"class="xMiInput"placeholder="Meta diaria"inline id="txt_new_meta"></div><br><hr><br><div class="xBoton2 xVerde divLeft23"onclick="xGuardarMeta()">Guardar</div><div class="xBoton2 xPlomo divLeft23"dialog-dismiss>Cerrar</div><br><br></paper-dialog><div class="p-20"><div class="d-flexx w-100 justify-content-between"><div style="max-width:350px"class="pr-2"><p class="fs-9 text-secondary"style="padding-bottom:6px">Sede</p><x-comp-find-sede id="compSedeIndicador"onchange="changeSede(sedes)"></x-comp-find-sede></div><div onclick="pageIndicadores2()"class="text-secondary xCursor text-center"><span><i class="fa fa-arrow-circle-up text-secondary"></i></span><p class="fs-10">Nueva Version</div><div><span class="fs-9 text-secondary">Fecha</span> <input type="date"class="xMiInput"onchange="changeFecha(event)"></div></div><hr><button class="btn btn-sm btn-success"onclick="callInterval()"><i class="fa fa-adjust"></i></button> <button class="btn btn-sm btn-success"onclick="callInterval()"><span class="fs-10">Refrescar</span></button> <button class="btn btn-sm btn-info pl-2"hidden$="{{!showBtnCierreCaja}}"onclick="reImprimirCierre()"><span class="fs-10">Imprimir Cierre</span></button> <button class="btn btn-sm btn-warning pl-2"hidden$="{{!showBtnCierreCaja}}"onclick="dialog_meta.open()"><span class="fs-10">Establecer Meta</span></button><div class="flexbox"><div class="div-grafico left"><div id="meta_diaria"class="xIndicadorSize1"></div><br></div><div class="center"><br><p class="text-left fs-16 fw-600">Tipos de Pago<hr><table class="w-100"><thead><th align="left">Tipo pago<th align="right">Importe<tbody><template is="dom-repeat"items="{{listTipoPago}}"as="item"><tr><td align="left">{{ item.key }}<td align="right">{{ item.value }}</template></table></div><div class="right"><br><p class="text-left fs-16 fw-600">Anulados<hr><table class="w-100"><thead><th align="left">Descripcion<th align="right">Importe<tbody><tr><td align="left">Pedidos Anulados ( {{ listPedidosAnulados.cantidad}} )<td align="right">{{ listPedidosAnulados.importe}}<tr><td align="left">Items Anulados ( {{ listPedidosItemAnulados.cantidad}} )<td align="right">{{ listPedidosItemAnulados.importe}}</table></div></div><hr><div class="w-100 flexbox"style="justify-content:space-around"><div class="next"style="max-width:550px"><p class="text-left fs-16 fw-600">Ventas en la Semana.</p><br><canvas id="myChartVentasSemana"></canvas></div><div class="next"style="max-width:550px"><p class="text-left fs-16 fw-600">Canales de Consumo</p><br><div><canvas id="myChart"></canvas></div></div></div><hr><div class="flexbox"><div class="left"><p class="text-left fs-16 fw-600">Mozo Virtual<hr><table class="w-100"><thead><th align="left">Canal<th align="center">Cantidad<th align="right">Importe<tbody><template is="dom-repeat"items="{{listMozoVirtual}}"as="item"><tr><td align="left">{{ item.descripcion }}<td align="center">{{ item.t2 }}<td align="right">{{ item.t3 }}</template></table></div><div class="left"><p class="text-left fs-16 fw-600">Pagos desde APP<hr><table class="w-100"><thead><th align="left">Canal<th align="center">Cantidad<th align="right">Importe<tbody><template is="dom-repeat"items="{{listPagosApp}}"as="item"><tr><td align="left">{{ item.descripcion }}<td align="center">{{ item.t2 }}<td align="right">{{ item.t3 }}</template></table></div></div><hr><div class="flexbox"><div class="left"><p class="text-left fs-16 fw-600">Lista de Secciones<hr><table class="w-100"><thead><th align="left">Seccion<th align="center">Cantidad<th align="right">Importe<tbody><template is="dom-repeat"items="{{listSeccion}}"as="item"><tr><td align="left">{{ item.key }}<td align="center">{{ item.value.cantidad }}<td align="right">{{ item.value.totalShow }}</template></table></div><div class="next"><p class="text-left fs-16 fw-600">Lista de Productos<hr><table class="w-100"><thead><th align="left">Producto<th align="center">Cantidad<th align="right">Importe<tbody><template is="dom-repeat"items="{{listProducto}}"as="item"><tr><td align="left">{{ item.key }}<td align="center">{{ item.value.cantidad }}<td align="right">{{ item.value.totalShow }}</template></table></div></div><hr><br><div><div class="w-100"><p class="text-left fs-16 fw-600">Movimientos en Caja<hr><table class="w-100"><thead><th align="left">Usuario<th align="left">Movimiento<th align="left">Motivo<th align="right">Importe<tbody><template is="dom-repeat"items="{{listCaja}}"as="item"><tr><td align="left">{{ item.usuario }}<td align="left">{{ item.tipo }}<td align="left">{{ item.motivo }}<td align="right">{{ item.monto }}</template></table></div></div><hr><br><div><div class="w-100"><p class="text-left fs-16 fw-600">Calificacion de los clientes<hr><table class="w-100"><thead><th align="left">Fecha<th align="left">Pedido<th align="left">Canal<th align="right">Cliente<th align="right">Calificacion<th align="right">Comentario<tbody><template is="dom-repeat"items="{{listCalificacionCliente}}"as="item"><tr><td align="left">{{ item.fecha_hora }}<td align="left"><span>{{ item.idpedido }} </span><span>{{ item.correlativo_dia }}</span><td align="left">{{ item.descripcion }}<td align="right">{{ item.nombre }}<td align="right"><span class$="[[ item.class_calificaicon ]]">{{ item.calificacion }}</span><td align="right">{{ item.comentario }}</template></table><br><div class="xDerecha"><pagination-input id="paginator"current-page="1"page-count="5"current-page-changed="onChangePagination_re($event)"></pagination-input></div></div></div><div id="content_dynamic"></div><br><br></div></template></dom-module><style>.div-grafico{text-align:center}.xIndicadorSize1{width:250px;height:200px;margin:0 auto;clear:both}.graficoSemana{display:inline-block;min-height:256px;width:49%}.div-item{text-align:center;max-width:250px;min-width:200px}.flexbox{display:flex;flex-direction:column;padding:5px;align-content:space-between;justify-content:space-between}.flexbox>div{text-align:center;padding:20px 0;margin:5px}@media(min-width:576px){.flexbox{flex-flow:row wrap}.flexbox>.left{order:1;flex:1}.flexbox>.right{order:2;flex:1}.flexbox>.next{order:2;flex:1}.flexbox>.center{order:3;width:100%}}@media(min-width:768px){.flexbox{flex-flow:row nowrap}.flexbox>div{width:33.33%!important}.flexbox>.left{order:1}.flexbox>.center{order:2}.flexbox>.right{order:3}.flexbox>.next{order:2}}</style><script>var xThis,compSede,dataMeta,dataVentasDia,dataVentasCanalConsumo,dataCaja,crosVenta,crosCanalConsumo,crosCaja,metaDiaria=0,grafico_meta_diaria=null,porcentajeMedaDia=0,sumImporteTotal=0,dataFiltro={},idsCierres=[],data_pagination={},p_rows=0,p_desde=0;function initIndicadores(){iniFiltros(),xIniPagination(),xThisI.showBtnCierreCaja=!1,(compSede=document.getElementById("compSedeIndicador")).addEventListener("getValorIncial",function(a){dataFiltro.idsede=a.detail.sedes.idsede,iniLoaddata()}),xThisI.$.paginator.addEventListener("page-limit-change",a=>{data_pagination=a.detail.value,p_desde=data_pagination.pageDesde,loadCalificacionCliente()}),$("body").addClass("loaded"),$("#Titulo_page").text("INDICADORES")}function xIniPagination(){xThisI.$.paginator.currentPage=1,xThisI.$.paginator.pageRows=p_rows,xThisI.$.paginator.listRows=[10,20,30,40]}function iniLoaddata(){loadMestasSede(),loadCanalConsumoTops(),loadMovimientoCaja(),loadAnulados(),loadIfCierreCaja(),contenidoDinamico(),loadMozoVirtual(),loadPagoAPP(),loadCalificacionCliente()}function changeFecha(a){dataFiltro.fecha=xDevolverFechaFormatInputDate(a.target.value),iniLoaddata()}function changeSede(a){dataFiltro.idsede=a.idsede,iniLoaddata()}function iniFiltros(){dataFiltro={idsede:0,fecha:0}}function callInterval(){xPopupLoad.xopen(),iniLoaddata(),setTimeout(()=>{xPopupLoad.xclose()},600)}function contenidoDinamico(){$.ajax({type:"POST",url:"../../bdphp/log_005.php?op=18",data:dataFiltro}).done(function(a){$("#content_dynamic").html(a).trigger("create")})}function loadVentasDia(){$.ajax({type:"POST",url:"../../bdphp/log_005.php?op=16",data:dataFiltro}).done(function(a){dataMetdataVentasDia=JSON.parse(a).datos,crosVenta=crossfilter(dataMetdataVentasDia),cocinarDataVentasDia()})}function loadCanalConsumoTops(){$.ajax({type:"POST",url:"../../bdphp/log_005.php?op=1601",data:dataFiltro}).done(function(a){dataVentasCanalConsumo=JSON.parse(a).datos,crosCanalConsumo=crossfilter(dataVentasCanalConsumo),cocinarCanalConsumoTops()})}function loadMovimientoCaja(){$.ajax({type:"POST",url:"../../bdphp/log_005.php?op=1602",data:dataFiltro}).done(function(a){xThisI.listCaja=JSON.parse(a).datos})}function loadAnulados(){$.ajax({type:"POST",url:"../../bdphp/log_005.php?op=1603",data:dataFiltro}).done(function(a){(a=JSON.parse(a).datos[0]).importe=parseFloat(a.importe).toFixed(2),xThisI.listPedidosAnulados=a}),$.ajax({type:"POST",url:"../../bdphp/log_005.php?op=1604",data:dataFiltro}).done(function(a){(a=JSON.parse(a).datos[0]).importe=parseFloat(a.importe).toFixed(2),xThisI.listPedidosItemAnulados=a})}function loadMestasSede(){$.ajax({type:"POST",url:"../../bdphp/log_005.php?op=15",data:dataFiltro}).done(function(a){(dataMeta=JSON.parse(a).datos[0])?(metaDiaria=dataMeta.diaria,loadVentasDia()):dialog_meta.open()})}function loadIfCierreCaja(){$.ajax({type:"POST",url:"../../bdphp/log_005.php?op=1606",data:dataFiltro}).done(function(a){idsCierres=JSON.parse(a).datos,xThisI.showBtnCierreCaja=0<idsCierres.length})}function loadMozoVirtual(){xThisI.listMozoVirtual=[],$.ajax({type:"POST",url:"../../bdphp/log.php?op=700221",data:dataFiltro}).done(function(a){a=JSON.parse(a);xThisI.listMozoVirtual=a.datos})}function loadPagoAPP(){$.ajax({type:"POST",url:"../../bdphp/log.php?op=700211",data:dataFiltro}).done(function(a){xThisI.listPagosApp=JSON.parse(a).datos})}function loadCalificacionCliente(){dataFiltro.pagination=data_pagination,$.ajax({type:"POST",url:"../../bdphp/log_005.php?op=16062",data:dataFiltro}).done(function(a){a=a.split("**"),p_rows=a[1];a=(a=JSON.parse(a[0])).datos;a.map(a=>{var t=parseFloat(a.calificacion);4<=t&&(a.class_calificaicon="badge bg-success text-white"),t<4&&(a.class_calificaicon="badge bg-warning"),t<3&&(a.class_calificaicon="badge bg-danger text-white")}),xThisI.listCalificacionCliente=a,xThisI.$.paginator.pageRows=p_rows})}function reImprimirCierre(){var a=idsCierres.map(a=>a.idprint_server_detalle).join(",");xPopupLoad.xopen(),setTimeout(()=>{xPopupLoad.xclose()},600),$.ajax({type:"POST",url:"../../bdphp/log_005.php?op=16061",data:{ids:a}}).done(function(a){a=JSON.parse(a).datos;xThisI.showBtnCierreCaja=0<a.length,a.map(a=>{a={descripcion_doc:"cuadre-caja",detalle_json:a.detalle_json,hora:a.hora,idprint_server_detalle:a.idprint_server_detalle,idprint_server_estructura:4,nom_documento:"cuadre-caja",tipo:"cuadre-caja"};_cpSocketEmitPrinterOnly(a)})})}function cocinarDataVentasDia(){sumImporteTotal=dataMetdataVentasDia.filter(a=>"1"===a.hoy.toString()).map(a=>parseFloat(a.importe)).reduce((a,t)=>a+t,0),graficoMetaDiaria(porcentajeMedaDia=(sumImporteTotal/metaDiaria*100).toFixed(1));var a=crossfilter(dataMetdataVentasDia.filter(a=>"1"===a.hoy.toString())).dimension(a=>a.destp).group().reduceSum(a=>parseFloat(a.importe));xThisI.listTipoPago=a.all().map(a=>(a.value=a.value.toFixed(2),a));a=crosVenta.dimension(a=>a.nomdia).group().reduceSum(a=>parseFloat(a.importe));xThisI.listSemana=a.orderNatural().all(),graficoVentasSemana()}function cocinarCanalConsumoTops(){var a=crosCanalConsumo.dimension(a=>a.destpc).group().reduceSum(a=>parseFloat(a.importe)),a=(xThisI.listCanalConsumo=a.all(),graficoCanalesConsumo(),crosCanalConsumo.dimension(a=>a.dessec)),a=(xThisI.listSeccion=sumCountDimension(a),crosCanalConsumo.dimension(a=>a.ides));xThisI.listProducto=sumCountDimension(a)}function sumCountDimension(a){return a.group().reduce(function(a,t,o){return++a.count,a.cantidad+=parseFloat(t.cantidad),a.total+=parseFloat(t.importe),a.totalShow=a.total.toFixed(2),a},function(a,t,o){return--a.count,a.cantidad-=parseFloat(t.cantidad),a.total-=parseFloat(t.importe),a.totalShow=a.total.toFixed(2),a},function(){return{count:0,total:0,cantidad:0,totalShow:"0"}}).order(function(a){return a.total}).all().sort((a,t)=>t.value.total-a.value.total)}function graficoMetaDiaria(a){grafico_meta_diaria?grafico_meta_diaria.refresh(parseInt(a)):grafico_meta_diaria=new JustGage({id:"meta_diaria",value:porcentajeMedaDia,symbol:"%",pointer:!0,pointerOptions:{toplength:-15,bottomlength:10,bottomwidth:12,color:"#8e8e93",stroke:"#ffffff",stroke_width:3,stroke_linecap:"round"},levelColors:["#e91e63","#ffc107","#64dd17"],title:"Meta Diaria",min:0,max:100,label:"Avance",counter:!0})}function graficoCanalesConsumo(){var a=document.getElementById("myChart").getContext("2d");new Chart(a,{type:"pie",data:{labels:xThisI.listCanalConsumo.map(a=>a.key.split(" ").pop()),datasets:[{label:"Importe",data:xThisI.listCanalConsumo.map(a=>a.value),backgroundColor:["#DBF2F2","#D7ECFB","#EBE0FF","#FFF5DD","#FFECD9","#FFE0E6"],borderColor:["#87D5D5","#89C8F3","#A67AFF","#CCCED2","#FFDC8A","#FBB773"],borderWidth:2}]},options:{legend:{display:!0,position:"bottom"}}})}function graficoVentasSemana(){var a=document.getElementById("myChartVentasSemana").getContext("2d");new Chart(a,{type:"line",data:{labels:xThisI.listSemana.map(a=>a.key.split("|")[1]),datasets:[{label:"Importe",data:xThisI.listSemana.map(a=>a.value),backgroundColor:["#DBF2F2"],borderColor:["#87D5D5"],borderWidth:2}]},options:{legend:{display:!1,position:"bottom"}}})}function xGuardarMeta(){var t=txt_new_meta.value;dataFiltro.meta=t,dataFiltro.new=dataMeta?0:1,$.ajax({type:"POST",url:"../../bdphp/log_005.php?op=1605",data:dataFiltro}).done(function(a){dialog_meta.close(),porcentajeMedaDia=(sumImporteTotal/t*100).toFixed(1),dataMeta?graficoMetaDiaria(porcentajeMedaDia):iniLoaddata()})}function pageIndicadores2(){xOpenPage(46)}Polymer({is:"x-indicadores",properties:{listTipoPago:[],listCanalConsumo:[],listSeccion:[],listProducto:[],listCaja:[],listSemana:[],listPedidosAnulados:[],listPedidosItemAnulados:[],listMozoVirtual:[],listPagosApp:[],listCalificacionCliente:[],showBtnCierreCaja:Boolean,metaD:Number,xt_org:Number,xt_idsede:Number},attached:function(){xThisI=this,initIndicadores(),setTimeout(()=>{_cpSocketOpen()},1e3)},detached:function(){grafico_meta_diaria=null}})</script>