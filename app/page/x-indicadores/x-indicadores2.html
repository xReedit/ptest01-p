<dom-module id="x-indicadores2"><link rel="import"href="../../x-componentes/pagination-input/pagination-input.html"><link rel="import"href="../../x-componentes/x-comp-find-sede/x-comp-find-sede.html"><link rel="import"href="../../x-componentes/x-comp-option-group/x-comp-option-group.html"><link rel="import"href="./x-indicadores-is-caja.html"><link rel="import"href="./x-indicadores-top-productos.html"><link rel="import"href="./x-indicadores-top-colaborador.html"><link rel="import"href="./x-indicadores-versus.html"><link rel="import"href="./x-indicadores-encuesta.html"><script src="../../view/socket.service.p.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.9.3/Chart.min.js"></script><script src="../../../js/crossfilter.min.js"></script><template is="dom"><paper-dialog id="dialog_meta dialog_redondo"modal style="min-width:330px"modal entry-animation="scale-up-animation"exit-animation="fade-out-animation"><h4>Meta diaria</h4><span>Establesca una meta diaria de ventas.</span><div><input type="number"class="xMiInput"placeholder="Meta diaria"inline id="txt_new_meta"></div><br><hr><br><div class="xBoton2 xVerde divLeft23"onclick="xGuardarMeta()">Guardar</div><div class="xBoton2 xPlomo divLeft23"dialog-dismiss>Cerrar</div><br><br></paper-dialog><paper-dialog id="dialog_pedidos_anulados"style="overflow:auto"modal entry-animation="scale-up-animation"exit-animation="fade-out-animation"><h4>Pedidos Anulados</h4><div><table class="width= 100%"><thead><th>Fecha<th>Borrado por<th>Item<th>Importe<tbody><template is="dom-repeat"items="{{listpedidosBorrados}}"as="item"><tr><td>{{ item.fecha }} {{ item.hora }}<td>{{ item.usuario }}<td>01 {{ item.descripcion }}<td>{{ item.importe }}</template></table></div><br><hr><br><div class="xBoton2 xPlomo divLeft23"dialog-dismiss>Cerrar</div><br><br></paper-dialog><br><div class="xMiCard xradius"style="width:90%;max-width:1250px"><div class="xEncanezadoCard"style="background:#fff0f5;color:#424242"><div class="div-content-head-op"><div class="d-flexx align-items-center"><div style="max-width:350px"class="pr-2"><p class="fs-11 text-secondary">Local<div class="d-flexx align-items-baseline"><x-comp-find-sede id="compSedeIndicador"clasecss="comp-sede-template-1 beige xCursor"addrowlast="TODOS LOCALES"onchange="changeSede(sedes)"></x-comp-find-sede></div></div></div><button class="btn btn-sm btn-dark"on-click="goDash2"><i class="fa fa-dashboard"></i> Nuevo Dashboard</button><div><p class="fs-11 text-secondary">Estadisticas</p><x-comp-option-group listop="{{listOpciones}}"id="compOptionPeriodo"></x-comp-option-group></div></div></div><div hidden$="[[!showVersus]]"><x-indicadores-versus id="pageVersusIndicadores"></x-indicadores-versus></div><div hidden$="[[showVersus]]"><div class="xContentCard"style="padding:5px 0 5px 0;background:#d3d3d3;border-bottom:2px solid #9e9e9e"><div class="w-100"><paper-tabs class="fs-17 fw-100"selected="{{selected_conf}}"id="tab_cnf"scrollable><paper-tab>Ventas</paper-tab><paper-tab>I/S Caja</paper-tab><paper-tab>Top Productos</paper-tab><paper-tab>Top Colaboradores</paper-tab></paper-tabs></div></div><div class="pt-4"><iron-pages selected="{{selected_conf}}"><div><div class="xContentCard border-bottom"style="padding:20px"><div class="div-content-grid"><div><p class="fs-18 text-secondary fw-600">Total de ventas [[ ragoTitulo ]]<p class="fs-50 color-text-principal fw-600">S/. {{ dtVentasHoy.sumImporteTotalHoyShow }}<p class="text-secondary">[[ ragoSubTitulo ]] anterior <span class="fw-600">S/. {{ dtVentasHoy.sumImporteTotalAyer }}</span></p><br><div class="d-flexx"><div class="content-dato"entero$="[[dtVentasHoy.entero]]"><div class="ico-dato-l"><i hidden$="[[!dtVentasHoy.entero]]"class="fa fa-level-up fa-2x"aria-hidden="true"></i> <i hidden$="[[dtVentasHoy.entero]]"class="fa fa-level-down fa-2x"aria-hidden="true"></i></div><div class="text-right"><p class="fs-30 fw-600 pb-1"><span hidden$="[[!dtVentasHoy.entero]]"><i class="fa fa-plus"></i></span>{{ dtVentasHoy.porcentaje }}%<p><span hidden$="[[!dtVentasHoy.entero]]">Aumento</span> <span hidden$="[[dtVentasHoy.entero]]">Menos</span> <span class="fw-600">S/. {{ dtVentasHoy.diferencia }}</span></div></div><div class="content-dato ml-2 xCursor"rojo$="[[dtVentasHoy.m_rojo]]"ambar$="[[dtVentasHoy.m_ambar]]"verde$="[[dtVentasHoy.m_verde]]"onclick="dialog_meta.open()"><div class="text-right"><p class="fs-30 fw-600 pb-1"><span><i class="fa fa-flag"></i></span> {{ dtVentasHoy.porcentaje_diaria }}%<p>Meta S/. {{ dtVentasHoy.meta_diaria }}</div></div></div><button class="btn btn-sm btn-dark"onclick="xCambiarMetaDiariaID2()">Cambiar meta diaria</button><br></div><div><canvas id="myChart"></canvas><br></div></div></div><br><div class="xContentCard border-bottom"style="padding:20px"><div class="div-content-grid"><div class="p-3"><template is="dom-repeat"items="{{listTipoPago}}"as="tpc"><div class="tableDivIndicador"><p class="pb-2">Total de venta con <span class="fw-600">{{tpc.key}}</span><div class="d-flexx justify-content-between align-items-center"><div class="d-flexx align-items-center"><img src$="[[ tpc.img ]]"alt=""><p class="fs-28 color-text-principal fw-600 pl-2">S/. {{ tpc.importe_hoy }}</div><p hidden$="[[ !tpc.showAyer ]]"class="fs-25 pl-2 lblInfo"verde$="[[tpc.entero]]"rojo$="[[ !tpc.entero ]]"><span hidden$="[[!tpc.entero]]"><i class="fa fa-plus"></i></span><span class="fw-600">{{ tpc.porcentaje }}%</span><div class="ico-dato-m mr-2"verde$="[[tpc.entero]]"rojo$="[[ !tpc.entero ]]"><span hidden$="[[!tpc.entero]]"><i class="fa fa-level-up"></i></span> <span hidden$="[[tpc.entero]]"><i class="fa fa-level-down"></i></span></div></div><div hidden$="[[ !tpc.showAyer ]]"><p class="text-secondary">[[ ragoSubTitulo ]] anterior S/.{{ tpc.importe_ayer }}</div></div></template><template is="dom-if"if="[[listDescuentos.length > 0]]"><div class="mt-4 content-table-iv"><p class="fs-18 text-secondary fw-600">Descuentos aplicados <i class="fa fa-level-down text-danger"></i></p><br><table><thead><th>Fecha<th>Usuario<th>Tipo Desc.<th align="center">Cantidad<th align="right">Importe<tbody><template is="dom-repeat"items="{{listDescuentos}}"as="item"><tr><td><p class="color-text-secondary">{{item.fecha}}<td><p class="color-text-secondary">{{item.nombres}}<td><p class="color-text-secondary">{{item.des_descuento}}<td align="center"><p class="color-text-principal">{{item.cantidad}}<td align="right"><p class="color-text-principal">{{item.importe}}</template><tr><td colspan="4"align="right"><p class="fw-600 fs-15">Total<td align="right"><p class="fw-600 fs-15 color-text-principal">{{totalDescuentos}}</table></div></template></div><div><table width="100%"><thead><th width="35%"><th align="right"><span class="fs-12 text-secondary">Hoy</span><th align="right"><span class="fs-12 text-secondary">[[ ragoSubTitulo ]] Anterior</span><th align="right"><span class="fs-12 text-secondary">Incremento</span></thead><tr class="border-bottom mb-2"style="height:67px"><td><p class="fw-600 fs-14 text-secondary">Pedidos realizados<td align="right"><p class="fw-600 fs-15 color-text-principal">{{ listPedidosTotales.pedidos_totales.hoy }}<td align="right"><p class="fw-600 fs-15 text-secondary">{{ listPedidosTotales.pedidos_totales.ayer }}<td align="right"class="text-right"><div class="align-items-center"style="display:inline-flex"><p class="fs-15 fw-600 pr-2 lblInfo"verde$="[[listPedidosTotales.pedidos_totales.entero]]"rojo$="[[ !listPedidosTotales.pedidos_totales.entero ]]">{{ listPedidosTotales.pedidos_totales.porcentaje }}%<div class="ico-dato-m mr-2"verde$="[[listPedidosTotales.pedidos_totales.entero]]"rojo$="[[ !listPedidosTotales.pedidos_totales.entero ]]"><span hidden$="[[!listPedidosTotales.pedidos_totales.entero]]"><i class="fa fa-level-up"></i></span> <span hidden$="[[listPedidosTotales.pedidos_totales.entero]]"><i class="fa fa-level-down"></i></span></div></div><tr class="border-bottom mb-2"style="height:67px"><td><p class="fw-600 fs-14 text-secondary">Ticket promedio<td align="right"><p class="fw-600 fs-15 color-text-principal">{{ listPedidosTotales.ticket_promedio.hoy }}<td align="right"><p class="fw-600 fs-15 text-secondary">{{ listPedidosTotales.ticket_promedio.ayer }}<td align="right"class="text-right"><div class="align-items-center"style="display:inline-flex"><p class="fs-15 fw-600 pr-2 lblInfo"verde$="[[listPedidosTotales.ticket_promedio.entero]]"rojo$="[[ !listPedidosTotales.ticket_promedio.entero ]]">{{ listPedidosTotales.ticket_promedio.porcentaje }}%<div class="ico-dato-m mr-2"verde$="[[listPedidosTotales.ticket_promedio.entero]]"rojo$="[[ !listPedidosTotales.ticket_promedio.entero ]]"><span hidden$="[[!listPedidosTotales.ticket_promedio.entero]]"><i class="fa fa-level-up"></i></span> <span hidden$="[[listPedidosTotales.ticket_promedio.entero]]"><i class="fa fa-level-down"></i></span></div></div><tr class="border-bottom mb-2"style="height:67px"><td><p class="fw-600 fs-14 text-secondary">Importe Pedidos Anulados<td align="right"><p class="fw-600 fs-15 color-text-principal text-danger">{{ listPedidosTotales.pedidos_anulados.importe_hoy }}<td colspan="2"><span class="fw-600 fs-14 xCursor text-info"onclick="dialog_pedidos_anulados.open()">Ver Anulados</span></table></div></div><br></div><br><div class="xContentCard border-bottom"style="padding:20px"hidden$="[[!isShowDivOtrosIngresos]]"><p class="fs-18 text-secondary fw-600">Otros Ingresos</p><br><div class="div-content-grid"><div class="p-3"><template is="dom-repeat"items="{{tablaTipoPagoIngresosVarios}}"as="tpc"><div class="tableDivIndicador"><p class="pb-2">Ingresos con <span class="fw-600">{{tpc.key}}</span><div class="d-flexx justify-content-between align-items-center"><div class="d-flexx align-items-center"><img src$="[[ tpc.img ]]"alt=""><p class="fs-21 color-text-principal fw-600 pl-2">S/. {{ tpc.importe }}</div></div></div></template></div><div class="content-table-iv"><table width="100%"class="fs-14 fw-600 text-secondary"><thead><th align="left">Fecha<th align="left">Concepto<th align="center">Tipo Pago<th align="right">Importe<tbody><template is="dom-repeat"items="{{listTipoPagoIngresosVarios}}"as="item"><tr><td>{{item.fecha_show}}<td class="fw-100">{{item.concepto}}<td><img src$="../../images/[[ item.img ]]"alt="tpc"width="24px"><td align="right"class="fw-600 color-text-principal">{{ item.importe }}</template></table></div></div></div><div class="xContentCard border-bottom"style="padding:20px;background:#cff1f5"><p class="fs-18 text-secondary fw-600">Movimientos totales</p><br><div class="div-columm-3"><div><p class="pb-2 fw-600 fs-18">Total Ventas<p class="fs-28 color-text-principal fw-600 pl-2">S/. {{ dtVentasHoy.sumImporteTotalHoyShow }}</div><div><p class="pb-2 fw-600 fs-18">Total Otros Ingresos<p class="fs-28 color-text-principal fw-600 pl-2">S/. {{ sumTotalIngresosVarios }}</div><div><p class="pb-2 fw-600 fs-18">Total<p class="fs-30 color-text-principal fw-900 pl-2">S/. {{ sumTotalMovimientos }}</div></div></div><div class="xContentCard border-bottom"style="padding:20px"><p class="fs-18 text-secondary fw-600">Canales de Consumo</p><br><div class="div-content-grid align-items-center"><div><canvas id="myChartCanalConsumo"></canvas><br></div><div><table width="100%"class="xtableIndicadores"><thead><th width="35%"><th align="right">Cantidad<th align="right">Importe<tbody><template is="dom-repeat"items="{{listCanalConsumo}}"as="tpc"><tr class="h-tr-50"><td><span class="fw-600 fs-14 text-secondary">{{ tpc.key }}</span><td align="right"><span class="fw-600 fs-14 text-secondary">{{ tpc.value }}</span><td align="right"><span class="fw-600 fs-14 color-text-principal">S/. {{ tpc.importe }}</span></template></table></div></div></div><br><div class="xContentCard border-bottom"style="padding:20px"><div class="div-content-grid"><div><p class="fs-18 text-secondary fw-600">Comprobantes Emitidos</p><br><table width="100%"class="xtableIndicadores"><thead><th>Comprobante<th>Cant<th align="right">Importe<tbody><template is="dom-repeat"items="{{listComprobantes}}"as="item"><tr class="h-tr-50"><td><span class="fw-600 fs-14 text-secondary">{{ item.descripcion }}</span><td><span class="fw-600 fs-14 text-secondary">{{ item.cantidad }}</span><td align="right"><span class="fw-600 fs-14 color-text-principal">S/. {{ item.total }}</span></template></table></div><div><p class="fs-18 text-secondary fw-600">Calificacion de los clientes.</p><br><div class="text-center w-100"><h1>{{ sedeCalificacion }} <span class="fa fa-star fa-spin text-warning"></span></h1></div></div></div><br></div><br><br><div class="xContentCard border-bottom"style="padding:20px"><p class="fs-18 text-secondary fw-600">Calificacion de los clientes detalle.</p><br><table class="xtableIndicadores w-100"><thead><th align="left">Fecha<th align="left">Canal<th align="left">Cliente<th align="right">Calificacion<th align="left">Comentario<tbody><template is="dom-repeat"items="{{listCalificacionCliente}}"as="item"><tr><td align="left"><span>{{ item.fecha_hora }}</span><td><span>{{ item.descripcion }}</span><td align="left"><span>{{ item.nombre }}</span><td align="right"><span class$="[[ item.class_calificaicon ]]">{{ item.calificacion }}</span><td align="left"><span class="fs-11">{{ item.comentario }}</span></template></table><br><div class="xDerecha"><pagination-input id="paginator"current-page="1"page-count="5"current-page-changed="onChangePagination_re($event)"></pagination-input></div><br><br></div><br><div class="xContentCard border-bottom"style="padding:20px"><x-indicadores-encuesta></x-indicadores-encuesta></div></div><div class="xContentCard"style="padding:20px"><x-indicadores-is-caja rango="[[ rangoSelected ]]"id="cajaIndicadores"></x-indicadores-is-caja></div><div class="xContentCard"style="padding:20px"><x-indicadores-top-productos rango="[[ rangoSelected ]]"id="topProductosIndicadores"></x-indicadores-top-productos></div><div class="xContentCard"style="padding:20px"><x-indicadores-top-colaborador rango="[[ rangoSelected ]]"id="topColaboradoresIndicadores"></x-indicadores-top-colaborador></div></iron-pages><br><br></div><br><br></div></div><br><br></template></dom-module><style>.border-header-e{border-radius:5px;border:1px solid #e0e0e0;background:#f0f8ff;margin-top:15px}.content-dato{display:inline-flex;background:#ff5252;padding:15px;border-radius:6px;color:#fff;align-items:center;margin-bottom:15px}.content-dato[entero]{background:#00d179}.content-dato[rojo]{background:#ff5252}.content-dato[ambar]{background:#ffd740}.content-dato[verde]{background:#00d179}.ico-dato-l{padding:10px;border-radius:5px;margin-right:10px;background:rgba(250,250,250,.5)}.ico-dato-m{padding:8px 15px;border-radius:5px;background:rgba(250,250,250,.5)}.ico-dato-m[rojo]{background:#f9d8d8;color:#f16471}.ico-dato-m[ambar]{background:#ffd740}.ico-dato-m[verde]{background:#c7f5d4;color:#00d179}.lblInfo[verde]{color:#00d179}.lblInfo[rojo]{color:#ff5252}.div-content-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(320px,1fr));grid-gap:1rem}.div-content-head-op{display:flex;flex-wrap:wrap;justify-content:space-between;align-items:flex-end;grid-gap:1rem}.h-tr-67{height:67px}.h-tr-50{height:50px}.xtableIndicadores th{font-size:12px;color:#6c757d!important}.xtableIndicadores tr{border:none;border-top:1px solid #dee2e6!important;margin-bottom:.5rem!important}.tableDivIndicador{padding-bottom:1rem;margin-bottom:.5rem;border-bottom:1px solid #dee2e6}.content-table-iv{height:290px;overflow-y:auto}.div-columm-3{display:grid;grid-template-columns:repeat(3,1fr);grid-gap:20px}.color-text-principal{color:#34c8ec;line-height:initial}</style><script>var xThisI2,_listOp,dataFiltro,dataMetdataVentasDia,crosVenta,metaDiaria,_dtVentasHoy,_dtPedidoTotales,ctxChar,ctxCharConsumo,myBarChartPrincipal,pageIndicadoresCaja,pageIndicadoresTopProducto,pageIndicadoresTopColaboradores,pageIndicadoresVersus,compOptionPeriodo,dataIngresoVarios,_listTipoConsumo=[],rangoFecha="fecha",configParamsChart={},data_pagination={},p_rows=0,p_desde=0,isInitialLoad=!0;function initIndicadores2(){xThisI2.sedeCalificacion=xm_log_get("datos_org_all_sede")[0].calificacion,_listOp=[{descripcion:"Hoy",activo:!0,value:0},{descripcion:"Semana",activo:!1,value:1},{descripcion:"Mes",activo:!1,value:2,openInputDate:!0,optionCompDate:1},{descripcion:"Rango",activo:!1,value:2,openInputDate:!0,optionCompDate:2}],xThisI2.listOpciones=_listOp,dataFiltro={idsede:0,rango:"fecha",intervalo:0},pageIndicadoresCaja=document.getElementById("cajaIndicadores"),pageIndicadoresTopProducto=document.getElementById("topProductosIndicadores"),pageIndicadoresTopColaboradores=document.getElementById("topColaboradoresIndicadores"),pageIndicadoresVersus=document.getElementById("pageVersusIndicadores"),xThisI2.rangoSelected=dataFiltro,xThisI2.selected_conf=0,loadMestasSede(),$("body").addClass("loaded"),$("#Titulo_page").text("Indicadores"),ctxChar=document.getElementById("myChart").getContext("2d"),ctxCharConsumo=document.getElementById("myChartCanalConsumo").getContext("2d"),(compOptionPeriodo=document.getElementById("compOptionPeriodo")).addEventListener("getDateSelectedOption",a=>{isInitialLoad||changeOption(a.detail)}),$("#tab_cnf").on("iron-select",function(){isInitialLoad||updatePageTab()}),xThisI2.$.paginator.currentPage=1,xThisI2.$.paginator.pageRows=p_rows,xThisI2.$.paginator.listRows=[10,20,30,40],xThisI2.$.paginator.addEventListener("page-limit-change",a=>{data_pagination=a.detail.value,p_desde=data_pagination.pageDesde,isInitialLoad||loadCalificacionCliente()})}function changeOption(a){switch(a.option){case"now":a.optionselected=0,rangoFecha="fecha",xThisI2.ragoSubTitulo="Dia ",xThisI2.ragoTitulo="Hoy";break;case"week":a.optionselected=1,rangoFecha="semana",xThisI2.ragoSubTitulo="Semana ",xThisI2.ragoTitulo=" Semana Actual",dataFiltro.fecha=0;break;case"month":var o=xDesMes(a.num_mm-1)+" "+a.num_yy;rangoFecha="mes",xThisI2.ragoSubTitulo="Mes ",xThisI2.ragoTitulo=o;break;case"range":o=" de "+xDevolverFechaFormatInputDate(a.value1)+" al "+xDevolverFechaFormatInputDate(a.value2);rangoFecha="rango",xThisI2.ragoSubTitulo=" Rango ",xThisI2.ragoTitulo=o}dataFiltro.intervalo=a.optionselected,dataFiltro.rango=rangoFecha,dataFiltro.option=a,xThisI2.rangoSelected=dataFiltro,updatePageTab()}function updatePageTab(){if(xThisI2.showVersus)pageIndicadoresVersus.showData();else switch(xThisI2.selected_conf){case 0:xloadDataVentas();break;case 1:pageIndicadoresCaja.ragoTitulo=xThisI2.ragoTitulo,pageIndicadoresCaja.showData();break;case 2:pageIndicadoresTopProducto.ragoTitulo=xThisI2.ragoTitulo,pageIndicadoresTopProducto.showData();break;case 3:pageIndicadoresTopColaboradores.ragoTitulo=xThisI2.ragoTitulo,pageIndicadoresTopColaboradores.showData()}}function changeSede(a){dataFiltro.idsede=a.idsede,-1!==a.idsede?(xThisI2.showVersus=!1,isInitialLoad=!0,loadMestasSede()):(xThisI2.showVersus=!0,pageIndicadoresVersus.showData())}function changeFecha(a){dataFiltro.fecha=xDevolverFechaFormatInputDate(a.target.value);a=xDevolverFechaParte_Dada(dataFiltro.fecha,"mmmm");updatePageTab(),xThisI2.ragoTitulo="mes"===rangoFecha?primeraConMayusculas(a.toLowerCase()):xThisI2.ragoSubTitulo,pageIndicadoresTopColaboradores.ragoTitulo=xThisI2.ragoTitulo,pageIndicadoresTopProducto.ragoTitulo=xThisI2.ragoTitulo,pageIndicadoresCaja.ragoTitulo=xThisI2.ragoTitulo,pageIndicadoresVersus.ragoTitulo=xThisI2.ragoTitulo}function loadMestasSede(){$.ajax({type:"POST",url:"../../bdphp/log_005.php?op=15",data:dataFiltro}).done(function(a){(dataMeta=JSON.parse(a).datos[0])?(metaDiaria=dataMeta.diaria,xloadDataVentas(),isInitialLoad=!1):dialog_meta.open(),loadCalificacionCliente()})}function xloadDataVentas(){xPopupLoad.xopen(),$.ajax({type:"POST",url:"../../bdphp/log_005.php?op=40",data:dataFiltro}).done(function(a){dataMetdataVentasDia=JSON.parse(a).datos,crosVenta=crossfilter(dataMetdataVentasDia),xDataVentas_tipo_pago(),xloadDataPedidos(),xloadDataOtrosIngresos(),xloadDComprobantesEmitidos(),xloadDescuentos()})}function xloadDescuentos(){$.ajax({type:"POST",url:"../../bdphp/log_005.php?op=400",data:dataFiltro}).done(function(a){a=JSON.parse(a).datos;xThisI2.totalDescuentos=a.map(a=>parseFloat(a.importe)).reduce((a,o)=>a+o,0),xThisI2.totalDescuentos=parseFloat(xThisI2.totalDescuentos).toFixed(2),xThisI2.listDescuentos=JSON.parse(JSON.stringify(a))})}function xloadDataOtrosIngresos(){xPopupLoad.xopen(),$.ajax({type:"POST",url:"../../bdphp/log_005.php?op=4000",data:dataFiltro}).done(function(a){tablaIngresoVariosTipoPago(JSON.parse(a).datos)})}function xloadDataPedidos(){$.ajax({type:"POST",url:"../../bdphp/log_005.php?op=4001",data:dataFiltro}).done(function(a){tablaInfoPedidos(JSON.parse(a).datos),$.ajax({type:"POST",url:"../../bdphp/log_005.php?op=4002",data:dataFiltro}).done(function(a){tablaInfoPedidosAnulados(JSON.parse(a).datos),xPopupLoad.xclose()})})}function xloadDComprobantesEmitidos(){$.ajax({type:"POST",url:"../../bdphp/log_005.php?op=4007",data:dataFiltro}).done(function(a){a=JSON.parse(a).datos;xThisI2.listComprobantes=a})}function xDataVentas_tipo_pago(){switch((_dtVentasHoy={sumImporteTotalHoyShow:0,sumImporteTotalHoy:0,sumImporteTotalAyer:0,diferencia:0,porcentaje:0,entero:!0,signo:"+",porcentaje_diaria:0,meta_diaria:0,m_rojo:!1,m_ambar:!1,m_verde:!1}).sumImporteTotalHoy=dataMetdataVentasDia.filter(a=>"1"===a.hoy.toString()).map(a=>parseFloat(a.importe)).reduce((a,o)=>a+o,0),_dtVentasHoy.sumImporteTotalAyer=dataMetdataVentasDia.filter(a=>"0"===a.hoy.toString()).map(a=>parseFloat(a.importe)).reduce((a,o)=>a+o,0),_dtVentasHoy.diferencia=_dtVentasHoy.sumImporteTotalHoy-_dtVentasHoy.sumImporteTotalAyer,_dtVentasHoy.porcentaje=Math.round(_dtVentasHoy.diferencia/_dtVentasHoy.sumImporteTotalAyer*100),_dtVentasHoy.entero=!(_dtVentasHoy.diferencia<0),_dtVentasHoy.signo=_dtVentasHoy.entero?"+":"-",_dtVentasHoy.sumImporteTotalHoyShow=numeroConComas(xMoneda(_dtVentasHoy.sumImporteTotalHoy)),_dtVentasHoy.sumImporteTotalAyer=numeroConComas(xMoneda(_dtVentasHoy.sumImporteTotalAyer)),_dtVentasHoy.diferencia=numeroConComas(xMoneda(_dtVentasHoy.diferencia)),_dtVentasHoy.meta_diaria=numeroConComas(xMoneda(metaDiaria)),calcularPorcentajeMetaDiaria(),tablaTipoPago(dataMetdataVentasDia),dataFiltro.rango){case"fecha":graficoVentasHoraHoy(dataMetdataVentasDia);break;case"semana":graficoVentasSemana(dataMetdataVentasDia);break;case"mes":graficoVentasMes(dataMetdataVentasDia)}}function tablaTipoPago(a){var o=crossfilter(a.filter(a=>"1"===a.hoy.toString()));let e=(i=o.dimension(a=>a.des_tp+":"+a.img)).group().reduceSum(a=>parseFloat(a.importe));var t=e.all().map(a=>(a.value=numeroConComas(a.value.toFixed(2)),a)),i=crossfilter(a.filter(a=>"0"===a.hoy.toString())).dimension(a=>a.des_tp+":"+a.img),d=(e=i.group().reduceSum(a=>parseFloat(a.importe))).all().map(a=>(a.value=numeroConComas(a.value.toFixed(2)),a)),n=[];t.map(o=>{var a=parseFloat(o.value.split(",").join("")),e=d.filter(a=>a.key===o.key)[0],t=a-(e=e?+parseFloat(e.value.split(",").join("")):0),i=Math.round(t/e*100),r=0<i,s=o.key.split(":"),a={key:s[0].toLowerCase(),importe_hoy:numeroConComas(a.toFixed(2)),showAyer:0!==e,importe_ayer:0===e?"-":numeroConComas(e.toFixed(2)),importe_diferencia:t,porcentaje:i,entero:r,img:"../../images/"+s[1]};n.push(a)}),xThisI2.listTipoPago=JSON.parse(JSON.stringify(n)),cocinarCanalConsumoHoy(o)}function tablaIngresoVariosTipoPago(a){xThisI2.isShowDivOtrosIngresos=0<a.length;var o=crossfilter(a).dimension(a=>a.des_tp+":"+a.img).group().reduceSum(a=>parseFloat(a.importe)).all().map(a=>(a.value=numeroConComas(a.value.toFixed(2)),a)),e=[],t=0;o.map(a=>{var o=parseFloat(a.value.split(",").join("")),a=a.key.split(":"),o=(t+=o,{key:a[0].toLowerCase(),importe:numeroConComas(o.toFixed(2)),img:"../../images/"+a[1]});e.push(o)}),xThisI2.tablaTipoPagoIngresosVarios=JSON.parse(JSON.stringify(e)),xThisI2.listTipoPagoIngresosVarios=JSON.parse(JSON.stringify(a)),xThisI2.sumTotalIngresosVarios=numeroConComas(t.toFixed(2)),xThisI2.sumTotalMovimientos=numeroConComas((removeComas(t)+removeComas(_dtVentasHoy.sumImporteTotalHoyShow)).toFixed(2))}function tablaInfoPedidosAnulados(a){xThisI2.listpedidosBorrados=JSON.parse(JSON.stringify(a));var a=crossfilter(a).dimension(a=>a.idpedido_borrados),o=a.group().all().length,a=(a=a.group().reduceSum(a=>parseFloat(a.importe))).all().filter(a=>a.key).map(a=>a.value).reduce((a,o)=>a+o,0);_dtPedidoTotales.pedidos_anulados.hoy=xCeroIzq(o,2),_dtPedidoTotales.pedidos_anulados.importe_hoy=numeroConComas(a.toFixed(2)),xThisI2.listPedidosTotales=JSON.parse(JSON.stringify(_dtPedidoTotales))}function tablaInfoPedidos(a){_dtPedidoTotales={pedidos_totales:{hoy:0,ayer:0,porcentaje:0,entero:!1},ticket_promedio:{hoy:0,ayer:0,porcentaje:0,entero:!1},pedidos_anulados:{hoy:0,ayer:0,porcentaje:0,entero:!1,importe_hoy:0}};var o=crossfilter(a.filter(a=>"1"===a.hoy.toString())),e=o.dimension(a=>a.idpedido),t=e.group().all().length;cocinarCanalConsumoHoyFromAPP(a);var i=(i=e.group().reduceSum(a=>parseFloat(a.importe_item))).all().map(a=>a.value).reduce((a,o)=>a+o,0),o=o.dimension(a=>"1"===a.anulado.toString()),r=o.group().all().length,s=(s=o.group().reduceSum(a=>parseFloat(a.importe_item))).all().filter(a=>a.key).map(a=>a.value).reduce((a,o)=>a+o,0),a=crossfilter(a.filter(a=>"0"===a.hoy.toString())),d=(e=a.dimension(a=>a.idpedido)).group().all().length,e=(e=e.group().reduceSum(a=>parseFloat(a.importe_item))).all().map(a=>a.value).reduce((a,o)=>a+o,0),a=(o=a.dimension(a=>"1"===a.anulado.toString())).group().all().length;o.group().reduceSum(a=>parseFloat(a.importe_item)).all().filter(a=>a.key).map(a=>a.value).reduce((a,o)=>a+o,0);_dtPedidoTotales.pedidos_totales.hoy=xCeroIzq(t,2),_dtPedidoTotales.pedidos_totales.ayer=xCeroIzq(d,2),_dtPedidoTotales.pedidos_totales.porcentaje=Math.round((t-d)/t*100),_dtPedidoTotales.pedidos_totales.entero=0<_dtPedidoTotales.pedidos_totales.porcentaje,_dtPedidoTotales.ticket_promedio.hoy=Math.round(i/t),_dtPedidoTotales.ticket_promedio.ayer=Math.round(e/d),_dtPedidoTotales.ticket_promedio.hoy=isNaN(_dtPedidoTotales.ticket_promedio.hoy)?0:_dtPedidoTotales.ticket_promedio.hoy,_dtPedidoTotales.ticket_promedio.ayer=isNaN(_dtPedidoTotales.ticket_promedio.ayer)?0:_dtPedidoTotales.ticket_promedio.ayer,_dtPedidoTotales.ticket_promedio.porcentaje=Math.round((_dtPedidoTotales.ticket_promedio.hoy-_dtPedidoTotales.ticket_promedio.ayer)/_dtPedidoTotales.ticket_promedio.hoy*100),_dtPedidoTotales.ticket_promedio.entero=0<_dtPedidoTotales.ticket_promedio.porcentaje,_dtPedidoTotales.ticket_promedio.hoy=0!=_dtPedidoTotales.ticket_promedio.hoy?numeroConComas(Math.round(i/t).toFixed(2)):0,_dtPedidoTotales.ticket_promedio.ayer=0!=_dtPedidoTotales.ticket_promedio.ayer?numeroConComas(Math.round(e/d).toFixed(2)):0,_dtPedidoTotales.pedidos_anulados.hoy=xCeroIzq(r,2),_dtPedidoTotales.pedidos_anulados.ayer=xCeroIzq(a,2),_dtPedidoTotales.pedidos_anulados.porcentaje=Math.round((r-a)/r*100),_dtPedidoTotales.pedidos_anulados.entero=0<_dtPedidoTotales.pedidos_anulados.porcentaje,_dtPedidoTotales.pedidos_anulados.importe_hoy=numeroConComas(s.toFixed(2)),xThisI2.listPedidosTotales=JSON.parse(JSON.stringify(_dtPedidoTotales))}function cocinarCanalConsumoHoy(a){_listTipoConsumo=[];var a=a.dimension(a=>a.destpc),o=a.group().reduceSum(a=>parseFloat(a.importe));a.group().all().map(a=>{_listTipoConsumo.push(a)}),o.all().map(o=>{_listTipoConsumo.filter(a=>a.key===o.key)[0].importe=o.value}),xThisI2.listCanalConsumoChart=_listTipoConsumo,graficoCanalesConsumo()}function cocinarCanalConsumoHoyFromAPP(a){var a=a.filter(a=>"1"===a.hoy.toString()&&"1"===a.is_from_client_pwa.toString()),a=crossfilter(a).dimension(a=>a.idpedido),o=a.groupAll().reduceSum(a=>parseFloat(a.importe)),a={key:"APP",value:a.groupAll().reduceCount().value(),importe:o.value()};_listTipoConsumo.push(a),_listTipoConsumo.map(a=>{a.key=primeraConMayusculas(a.key.toLowerCase()),a.importe=numeroConComas(parseFloat(a.importe).toFixed(2))}),xThisI2.listCanalConsumo=_listTipoConsumo}function graficoCanalesConsumo(){new Chart(ctxCharConsumo,{type:"pie",data:{labels:xThisI2.listCanalConsumoChart.map(a=>a.key.split(" ").pop()),datasets:[{label:"Importe",data:xThisI2.listCanalConsumoChart.map(a=>a.value),backgroundColor:["#DBF2F2","#D7ECFB","#EBE0FF","#FFF5DD","#FFECD9","#FFE0E6"],borderColor:["#87D5D5","#89C8F3","#A67AFF","#CCCED2","#FFDC8A","#FBB773"],borderWidth:2}]},options:{legend:{display:!0,position:"bottom"}}})}function graficoVentasHoraHoy(a){var a=crossfilter(a.filter(a=>"1"===a.hoy.toString())).dimension(a=>a.hora).group().reduceSum(a=>parseFloat(a.importe)).all(),o=ctxChar.createLinearGradient(0,0,0,250);o.addColorStop(0,"rgba(168,240,255, 1)"),o.addColorStop(1,"rgba(168,240,255, 0)"),configParamsChart={type:"line",data:{labels:a.map(a=>a.key),datasets:[{label:"Importe",data:a.map(a=>a.value),backgroundColor:o,borderColor:["#57D2FE"],borderWidth:2}]},options:{legend:{display:!1,position:"bottom"},scales:{xAxes:[{gridLines:{display:!0,drawBorder:!0,drawOnChartArea:!1}}],yAxes:[{gridLines:{display:!0,drawBorder:!0,drawOnChartArea:!1}}]}}},myBarChartPrincipal=null,myBarChartPrincipal=new Chart(ctxChar,configParamsChart)}function graficoVentasSemana(a){var e,a=crossfilter(a).dimension(a=>a.num_semana+"."+a.num_dia),a=(aaa=a.group().reduceSum(a=>parseFloat(a.importe))).reduce(function(a,o){return a.semana_actual=o.hoy,a.num_dia=o.num_dia,a.nom_dia=o.nom_dia,a.num_semana=o.num_semana,a.importe+=parseFloat(o.importe),a},function(a,o){return a.semana_actual=o.hoy,a.num_dia=o.num_dia,a.nom_dia=o.nom_dia,a.num_semana=o.num_semana,a.importe-=parseFloat(o.importe),a},function(){return{nom_dia:"",num_dia:0,num_semana:0,semana_actual:0,importe:0}}),t=(dias=["Lunes","Martes","Miercoles","Jueves","Viernes","Sabado","Domingo"],numdias=[1,2,3,4,5,6,7],a.all().filter(a=>"1"===a.value.semana_actual).map(a=>a.value)),i=a.all().filter(a=>"0"===a.value.semana_actual).map(a=>a.value),r=[],a=(numdias.map(o=>{e={};var a=t.filter(a=>parseInt(a.num_dia)===o)[0];e.num_dia=o,e.value=a?a.importe:0,e.semana_actual=!0,r.push(e),e={},a=i.filter(a=>parseInt(a.num_dia)===o)[0],e.num_dia=o,e.value=a?a.importe:0,e.semana_actual=!1,r.push(e)}),ctxChar.createLinearGradient(0,0,0,260)),o=(a.addColorStop(0,"rgba(33,150,243,1)"),a.addColorStop(1,"rgba(33,150,243,0)"),ctxChar.createLinearGradient(0,0,0,260)),s=(o.addColorStop(0,"rgba(149,117,205,1)"),o.addColorStop(1,"rgba(149,117,205,0)"),[dataMeta.diaria,dataMeta.diaria,dataMeta.diaria,dataMeta.diaria,dataMeta.diaria,dataMeta.diaria,dataMeta.diaria]);configParamsChart={type:"line",data:{labels:dias,datasets:[{label:"Semana Anterior",data:r.filter(a=>!a.semana_actual).map(a=>a.value),backgroundColor:o,borderColor:["#7e57c2"],borderWidth:2},{label:"Semana Actual",data:r.filter(a=>a.semana_actual).map(a=>a.value),backgroundColor:a,borderColor:["#2196f3"],borderWidth:2},{label:"Meta Diaria",data:s,borderWidth:2,borderDash:[5,5]}]},options:{legend:{display:!0,position:"top"},scales:{xAxes:[{gridLines:{display:!0,drawBorder:!0,drawOnChartArea:!1}}],yAxes:[{gridLines:{display:!0,drawBorder:!0,drawOnChartArea:!1}}]}}},updateChartPrincipal()}function graficoVentasMes(a){var a=crossfilter(a).dimension(a=>a.num_mes).group().reduceSum(a=>parseFloat(a.importe)).all(),o=ctxChar.createLinearGradient(0,0,0,260),e=(o.addColorStop(0,"rgba(33,150,243,1)"),o.addColorStop(1,"rgba(33,150,243,0)"),[]);a.map(a=>{e.push(metaDiaria)}),configParamsChart={type:"line",data:{labels:a.map(a=>primeraConMayusculas(xDesMes(parseInt(a.key)-1).toLowerCase())),datasets:[{label:"Importe",data:a.map(a=>a.value.toFixed(2)),backgroundColor:o,borderColor:["#57D2FE"],borderWidth:2},{label:"Meta Mensual",data:e,borderWidth:2,borderDash:[5,5]}]},options:{legend:{display:!1,position:"bottom"},scales:{xAxes:[{gridLines:{display:!0,drawBorder:!0,drawOnChartArea:!1}}],yAxes:[{gridLines:{display:!0,drawBorder:!0,drawOnChartArea:!1}}]}}},updateChartPrincipal()}function updateChartPrincipal(){myBarChartPrincipal.config=configParamsChart,myBarChartPrincipal.legend.options.display=configParamsChart.options.legend.display,myBarChartPrincipal.legend.options.position=configParamsChart.options.legend.position,myBarChartPrincipal.update()}function loadCalificacionCliente(){dataFiltro.pagination=data_pagination,$.ajax({type:"POST",url:"../../bdphp/log_005.php?op=16062",data:dataFiltro}).done(function(a){a=a.split("**"),p_rows=a[1];a=(a=JSON.parse(a[0])).datos;a.map(a=>{var o=parseFloat(a.calificacion);4<=o&&(a.class_calificaicon="badge bg-success text-white"),o<4&&(a.class_calificaicon="badge bg-warning"),o<3&&(a.class_calificaicon="badge bg-danger text-white")}),xThisI2.listCalificacionCliente=a,xThisI2.$.paginator.pageRows=p_rows})}function xGuardarMeta(){var o=txt_new_meta.value;dataFiltro.meta=o,dataFiltro.new=dataMeta?0:1,metaDiaria=o,$.ajax({type:"POST",url:"../../bdphp/log_005.php?op=1605",data:dataFiltro}).done(function(a){dialog_meta.close(),calcularPorcentajeMetaDiaria(o)})}async function calcularPorcentajeMetaDiaria(){var a=1;switch(dataFiltro.rango){case"fecha":a=1;break;case"semana":a=7;break;case"mes":a=30}dataMeta||await xCambiarMetaDiariaID2(),metaDiaria=dataMeta.diaria*a,_dtVentasHoy.porcentaje_diaria=(parseFloat(_dtVentasHoy.sumImporteTotalHoy)/metaDiaria*100).toFixed(1),_dtVentasHoy.m_rojo=!1,_dtVentasHoy.m_ambar=!1,_dtVentasHoy.m_verde=!1,_dtVentasHoy.meta_diaria=numeroConComas(xMoneda(metaDiaria)),_dtVentasHoy.porcentaje_diaria<30&&(_dtVentasHoy.m_rojo=!0),30<_dtVentasHoy.porcentaje_diaria&&_dtVentasHoy.porcentaje_diaria<80&&(_dtVentasHoy.m_ambar=!0),80<_dtVentasHoy.porcentaje_diaria&&(_dtVentasHoy.m_verde=!0),xThisI2.dtVentasHoy=JSON.parse(JSON.stringify(_dtVentasHoy))}async function xCambiarMetaDiariaID2(){if("1"===xm_log_get("app3_us").rol.toString()){let o=paramsSwalAlert;o.title='<p class="fw-600 fs-20">Meta de Venta Diara</p><p class="fw-600 fs-13 text-warning">Especifique el importe de venta, que será la meta diaria.</p>',o.html='<div class="p-3" style="display: inline-flex; border-radius:5px"><input type="number" placeholder="Meta Diaria" class="xMiInput text-center text-white fs-20 w-100" id="txt_meta_diaria_ventas_id"></div>',o.confirmButtonText="Listo, guardar",o.showCancelButton=!0,await showAlertSwalHtmlDecision(o,1).then(async a=>{a.isConfirmed&&(a={idsede:0,meta:txt_meta_diaria_ventas_id.value,new:0},dataMeta={diaria:txt_meta_diaria_ventas_id.value},$.ajax({type:"POST",url:"../../bdphp/log_005.php?op=1605",data:a}),o.title="",o=paramsSwalAlert)})}}Polymer({is:"x-indicadores2",properties:{listOpciones:Object,listTipoPago:Object,listPedidosTotales:Object,listCanalConsumoChart:[],listCanalConsumo:[],listpedidosBorrados:[],listComprobantes:[],listCalificacionCliente:[],listTipoPagoIngresosVarios:[],listDescuentos:[],totalDescuentos:Number,tablaTipoPagoIngresosVarios:[],sedeCalificacion:String,dtVentasHoy:Object,ragoSubTitulo:String,ragoTitulo:String,rangoSelected:String,selected_conf:Number,showVersus:Boolean,sumTotalIV:Number,sumTotalMovimientos:Number,isShowDivOtrosIngresos:Boolean},attached:function(){this.ragoSubTitulo="Dia ",this.ragoTitulo="Hoy",this.selected_conf=0,this.showVersus=!1,this.isShowDivOtrosIngresos=!1,xThisI2=this,initIndicadores2(),setTimeout(()=>{_cpSocketOpen()},1e3)},detached:function(){_cpSocketClose()},goDash2:function(){var a=btoa(JSON.stringify(getDataUsRRHH()));window.open(`https://modulo.papaya.com.pe/login?us=${a}&page=/dashboard/ventas`,"Papaya Dashboard")}})</script>