<link rel="import"href="../x-componentes/pagination-input/pagination-input.html"><dom-module id="x-historial_venta"><script src="../view/socket.master.service.js"></script><script src="../view/socket.service.p.js"></script><template><x-pass id="pass_us"titulo="Usuario autorizado"valor="Pe1"></x-pass><paper-dialog id="dialog_motivo_anular_historial"style="min-width:320px"entry-animation="scale-up-animation"exit-animation="fade-out-animation"with-backdrop><div class="xContent"><h4>ANULAR</h4><h4 class="txt_anular_cambiar_mesa"></h4><br><h4>Indique el motivo de anulacion</h4><div><input class="xMiInput"placeholder="Motivo..."id="txt_motivo_anular"autofocus></div><br><br><br><div class="xBoton2 xVerde"dialog-dismiss onclick="pass_us.open()">Listo</div><div class="xBoton2 xRojo"dialog-dismiss>Cancelar</div><br><br></div></paper-dialog><paper-dialog id="dialog_comprobante"style="min-width:320px"entry-animation="scale-up-animation"exit-animation="fade-out-animation"with-backdrop><div class="xContent"><x-pago id="component_pago"></x-pago></div></paper-dialog><br><div class="xMiCard xradius"style="width:85%"><div class="xEncanezadoCard xFondoRowAmarillo2"><p>El Registro de pago muestra todos los pedidos que fueron cancelados o pagaddos por dia y solo es informativo. Seleccione o escriba una fecha.<div class="d-flexx"><input type="date"class="xMiInput"style="width:200px"id="txt_fecha"></div></div><div class="xContentCard"style="height:100%"><div class="xdivEnLinea2"><div class="itemsDiv"><br><table width="100%"id="tb_historial"><thead><th>#<th width="40px">Hora<th align="right">Importe</thead></table><br><div><pagination-input id="paginator"current-page="1"page-count="5"current-page-changed="onChangePagination($event)"></pagination-input></div><br></div><br><div class="itemsDiv xpadingLateralDe xpadingLateralIz"style="width:75%"><br><br><div class="xDerecha"><paper-button><div class="xMiBoton_icon_lateral2"style="margin-top:-15px;width:90px"onclick="xOpenAnularPedidoHistorial()"id="btn_anular_pedido"><img src="../../images/_delete_pedido.png"><p>Anular pedido</div></paper-button><paper-button><div class="xMiBoton_icon_lateral2"style="margin-top:-15px;width:100px"onclick="xImprimirPrecuentaHistorial()"><img src="../../images/_pre_cuenta.png"><p>Imprimir pre-cuenta</div></paper-button><paper-button disabled="[[xYaTieneComprobante]]"><div class="xMiBoton_icon_lateral2"style="margin-top:-15px;width:50px"onclick="xAbrirDialogComprobante()"><img src="../../images/_comprobante.png"><p>Emitir Comprobante</div></paper-button><paper-button hidden$="[[!xIsPuedeReimprimirCPE]]"><div class="xMiBoton_icon_lateral2"style="margin-top:-15px;width:50px"onclick="reImprimirComprobante()"><img src="../../images/_print_vr.png"><p>Reimprimir Comprobante</div></paper-button></div><br><br><br><hr><br><label for="txt_comprobante"class="xfont10">Comprobante Emitido:</label><p><span id="txt_comprobante"class="xfont20">- </span><span id="txt_ref"class="xfont16 xColorRow_Morado xpadingLateralIz"></span><div class="xLinea2"></div><br><br><label for="txt_cliente"class="xfont10">Cliente:</label><p><span id="txt_cliente"class="xfont20">- </span><span id="txt_ref"class="xfont16 xColorRow_Morado xpadingLateralIz"></span><div class="xLinea2"></div><br><div class="x_div_linea"><div><label for="txt_mesa"class="xfont10">Mesa:</label><p id="txt_mesa"class="xfont20">00</div><div><label for="txt_mozo"class="xfont10">Atendido por:</label><p id="txt_mozo"class="xfont20"></div><div><label for="txt_correlativo"class="xfont10">Correlativo:</label><p id="txt_correlativo"class="xfont20"style="white-space:pre-wrap;width:50px">CO-0000</div><div><label for="txt_tpc"class="xfont10">Tiempo de atencion:</label><p id="txt_tpc"class="xfont20"></div><div><label for="txt_cat"class="xfont10"></label><p id="txt_cat"class="xfont20">-</div></div><div class="xLinea2"></div><br><br><div id="xBody"></div></div></div><br></div></div><br><br></template><script src="../view/xJsonSunat.js"></script><script src="../view/deNumALetras.js"></script><script src="../view/item_pedido_estructura.js"></script><script src="../view/item_pedido_print_comprobante.js"></script><script src="../view/cpe_interno.js"></script><script src="../view/item_pedido_subtotales.js"></script><style>.verIconFacturado img{visibility:hidden}</style><script>var xThisHistVenta,xTotalItemSel,xidregistro_pago_sel,xDtPrint,xPSupervisor,index_historial,x_icon_facturado,xdt_pdE,xfecha_historial="",xArrayTpC=[],xArraySeccion_r=[],xArrayDtOrdenFiltro=[],xEstado_registro_pago=0,xhtml_anulado="",xdt_h=[],arrSumSubtTotales=[],xRpt_pago=[],data_pagination={},p_rows=0,p_fecha="";function xIniPagination(){xThisHistVenta.$.paginator.currentPage=1,xThisHistVenta.$.paginator.pageRows=p_rows,xThisHistVenta.$.paginator.listRows=[30,60,90,120]}function xIniHistVenta(){xPopupLoad=document.getElementById("xLoad"),x_icon_facturado='<img src="../../images/_comprobante.png" title="se emitio comprobante" width="16px">',xm_LogChequea(function(){xm_log_get("ini_us"),$("#Titulo_page").text("Registro de pagos"),$("body").addClass("loaded"),xDtPrint=xm_log_get("sede_generales"),xloadHistorial()}),xIniPagination(),xThisHistVenta.$.paginator.addEventListener("page-limit-change",t=>{data_pagination=t.detail.value,p_desde=data_pagination.pageDesde,xloadHistorial()}),$("#txt_fecha").on("change",function(){var t=$(this).val().split("-");xfecha_historial=t[2]+"/"+t[1]+"/"+t[0],p_fecha=xfecha_historial,xThisHistVenta.$.paginator.currentPage=1,xloadHistorial()}),$("#dialog_motivo_anular_historial").on("iron-overlay-closed",function(){$("#txt_motivo_anular").focus()}),$("#dialog_motivo_anular_historial #txt_motivo_anular").keyup(function(t){13==t.keyCode&&(dialog_motivo_anular_historial.close(),pass_us.open())}),(xPSupervisor=document.getElementById("pass_us")).setVal("Pe1"),xPSupervisor.addEventListener("xSend",function(t){1===t.detail.xRpts[0].p&&(xPermisoSupervisor=t.detail.xRpts[0].us,xCronometro_us=30,xRefreshPermiso=setInterval(function(){xcronometro_permiso()},1e3),xAnularPedidoHistorial())}),(xValPago=document.getElementById("component_pago")).addEventListener("xSend",function(t){xRpt_pago=t.detail.xRpts,0!=t.detail.xRpts[0].ok&&1==t.detail.xRpts[0].paseEnterTxt&&xRegistrarClientePagoCP()}),xValPago.addEventListener("xCancelarCerrar",function(t){xThisHistVenta.$.dialog_comprobante.close()}),xValPago.addEventListener("xListoRegistraPago",function(t){xMandarCocinarImpresionComprobante_historial()})}function xAbrirDialogComprobante(){xThisHistVenta.$.dialog_comprobante.open()}function xOpenAnularPedidoHistorial(){dialog_motivo_anular_historial.open()}function xAnularPedidoHistorial(){$("#tb_det_pedidos .row").each(function(t,a){xidpedid_txt_change=xidpedid_txt_change+","+$(a).attr("data-idpedido")}),xidpedid_txt_change=xidpedid_txt_change.slice(1),xPopupLoad.xopen(),$.ajax({type:"POST",url:"../../bdphp/log.php?op=5011",data:{ArrayPeAnular:"",xPedidos:xidpedid_txt_change,xMotivo:$("#txt_motivo_anular").val(),u:xPermisoSupervisor,viene_historial:xidregistro_pago_sel}}).done(function(t){xPopupLoad.xclose(),$(".xMiBoton_icon_lateral").attr("disabled",!0),xloadHistorial()})}function xloadHistorial(){xPopupLoad.titulo="Cargando...",xPopupLoad.xopen(),data_pagination.pageFecha=p_fecha;$.ajax({type:"POST",url:"../../bdphp/log.php?op=20001",data:{pagination:data_pagination}}).done(function(t){t=t.split("**"),p_rows=t[1],t=$.parseJSON(t[0]);var a,o,i,e,r="";if((xdt_h=t).success){xdt_h=xdt_h.datos;var d=0;xThisHistVenta.isCierreCaja=!1;for(var n=0;n<xdt_h.length;n++)d++,o=a="","1"===xdt_h[n].cierre&&(a='<img src="../../images/candado.png" style="width:10px; heigh:10px; padding-right:2px; padding-top:4px;" class="xIzquierda EnLinea">',xThisHistVenta.isCierreCaja=!0),"1"===xdt_h[n].estado&&(o="xrow_anulado"),e=null!==xdt_h[n].idce,i=null===xdt_h[n].idce?"":x_icon_facturado,xdt_h[n].isFacturaEmitido=e,xdt_h[n].isCerrado="1"===xdt_h[n].cierre,r=String(r+'<tr class="row xCursor  '+o+'" data-index='+n+' data-id="'+xdt_h[n].idregistro_pago+'" data-idpedidos='+xdt_h[n].idpedido+' data-estado="'+xdt_h[n].estado+'" data-motivoa="'+xdt_h[n].motivo_anular+'" onclick="xloadDetallePago(this);"><td id="row_historial'+n+'">'+a+xCeroIzq(d,3)+i+"</td><td>"+xdt_h[n].hora+'</td><td align="right" class="td_total">'+xdt_h[n].total+"</td></tr>");p_upadate=!1,xThisHistVenta.$.paginator.pageRows=p_rows,$("#tb_historial .row").remove(),$("#tb_historial").append(r).trigger("create"),xPopupLoad.xclose()}else xPopupLoad.xclose(),alert(xdt_h.error)})}function xloadDetallePago(t){$("#tb_historial tr").removeClass("xitem_seleccionado_li"),$(t).addClass("xitem_seleccionado_li"),index_historial=$(t).attr("data-index"),xidregistro_pago_sel=$(t).attr("data-id"),xEstado_registro_pago=parseInt($(t).attr("data-estado")),xTotalItemSel=$(t).find(".td_total").text(),xThisHistVenta.$.component_pago.setVal(xMoneda(xTotalItemSel)),xValPago.setModoSoloComprobante(),xhtml_anulado="",$(".xMiBoton_icon_lateral").attr("disabled",!1),1===xEstado_registro_pago&&(xhtml_anulado='<h3 class="xColorRow_Rojo xBold">ANULADO</h3><div class="xLinea"></div><br><h4><strong>'+xmotio_anular.toUpperCase()+"</strong></h4>",$(".xMiBoton_icon_lateral").attr("disabled",!0)),$.ajax({type:"POST",url:"../../bdphp/log.php?op=20002",data:{i:xidregistro_pago_sel}}).done(function(t){(xdt_pdE=$.parseJSON(t)).success?(t=(xdt_pdE=xdt_pdE.datos[0]).num_comprobante,$("#txt_comprobante").text(t),xThisHistVenta.xYaTieneComprobante=null!==xdt_pdE.idce,xThisHistVenta.xYaPedidoCerrado="1"===xdt_pdE.cerrado,xThisHistVenta.xIsPuedeReimprimirCPE=!xThisHistVenta.xYaPedidoCerrado&&xThisHistVenta.xYaTieneComprobante,$("#txt_cliente").text(xdt_pdE.cliente),$("#txt_mesa").text(xdt_pdE.nummesa),$("#txt_mozo").text(xdt_pdE.usuario),$("#txt_correlativo").text(xdt_pdE.correlativo_dia),$("#xBody div").remove(),$("#xBody").append('<div><paper-spinner active class="xCentradoVerticalHorizontal"></paper-spinner></div>').trigger("create"),$.ajax({type:"POST",url:"../../bdphp/log.php?op=2003",data:{i:xidregistro_pago_sel}}).done(function(t){t=$.parseJSON(t);xArrayDtOrdenFiltro=t.datos,xLoadMipedidoBDHistorial(xThisHistVenta.xdtPedDet=xArrayDtOrdenFiltro)})):(xPopupLoad.xclose(),alert(xdt_pdE.error))})}function xLoadMipedidoBDHistorial(t){var o,e,r="",d=(xArrayTpC=new Array,xArraySeccion_r=new Array,""),n=t;for(a in n)null==xArrayTpC[n[a].idtipo_consumo]&&(xArrayTpC[n[a].idtipo_consumo]={id:n[a].idtipo_consumo,des:n[a].des_tp});for(b in xArrayTpC){for(i in r="",xArraySeccion_r=new Array,n)xArrayTpC[b].id==n[i].idtipo_consumo&&(e=n[i].des_seccion,null==xArraySeccion_r[n[i].idseccion_index]&&(xArraySeccion_r[n[i].idseccion_index]='<tr><td colspan="5" class="xBold">'+e+"</td></tr>"),e=String('<tr class="row" data-i="'+i+'" data-idpedidodetalle="'+n[i].idpedido_detalle+'" data-idpedido="'+n[i].idpedido+'" data-idtipoconsumo="'+n[i].idtipo_consumo+'"><td width="7px" class="click_row_dt_p" id="td_cant">'+xCeroIzq(n[i].cantidad,2)+'</td><td class="click_row_dt_p" width="50%">'+n[i].descripcion+'</td><td class="click_row_dt_p" align="right" id="td_importe">'+xMoneda(n[i].ptotal)+"</td></tr>"),xArraySeccion_r[n[i].idseccion_index]=xArraySeccion_r[n[i].idseccion_index]+e);for(a in o='<tr><td colspan="5" class="xFondoRowBlanco xBold">'+xArrayTpC[b].des+"</td></tr>",xArraySeccion_r)r=String(r+xArraySeccion_r[a]);d=String(d+o+r)}d='<div><table width="100%" id="tb_det_pedidos" class="xRowPading4">'+d+"</table></div>",$("#xBody div").remove(),$("#xBody").html(d).trigger("create"),xSumarTotalesHis()}function xSumarTotalesHis(){var e="";$.ajax({type:"POST",url:"../../bdphp/log.php?op=2005",data:{i:xidregistro_pago_sel}}).done(function(t){var a=$.parseJSON(t);if(a.success){a=a.datos,arrSumSubtTotales=a;for(var o=0;o<a.length;o++){var i=1===parseInt(a[o].tachado)?"xTachar":"";e=String(e+'<tr class="'+i+'"><td>'+a[o].descripcion.toUpperCase()+'</td><td align="right">'+a[o].importe+"</td></tr>")}e=String(e+'<tr><td colspan="2" align="left"><h4>FORMA DE PAGO</h4></td></tr>'),$.ajax({type:"POST",url:"../../bdphp/log.php?op=2004",data:{i:xidregistro_pago_sel}}).done(function(t){if((a=$.parseJSON(t)).success){for(var a=a.datos,o=0;o<a.length;o++)e=String(e+"<tr><td>"+a[o].tipo_pago+'</td><td align="right">'+a[o].importe+"</td></tr>");e='<div><table width="30%" id="tb_totales" class="xRowPading4 xDerecha">'+e+"</table></div><br>"+xhtml_anulado,$("#xBody").append(e).trigger("create")}else xPopupLoad.xclose(),alert(a.error)})}else xPopupLoad.xclose(),alert(a.error)})}function xMandarCocinarImpresionComprobante_historial(){var a=xRpt_pago[0].cliente,o=xRpt_pago[0].comprobante;const i=xCargarDatosAEstructuraImpresion(xThisHistVenta.xdtPedDet);xPopupLoad.xopen(),$.ajax({type:"POST",url:"../../bdphp/log_001.php",data:{p_from:"fe",p_comprobante:o,idregistro_pago:xidregistro_pago_sel}}).done(function(t){t=xm_all_SetResponseLog_001(t);o.correlativo=xCeroIzqNumComprobante(t.correlativo_comprobante),xCocinarImprimirComprobante(i,arrSumSubtTotales,o,a,xidregistro_pago_sel,-2),xThisHistVenta.xYaTieneComprobante=!0,xdt_h[index_historial].idtipo_comprobante=o.idtipo_comprobante,$("#row_historial"+index_historial).append(x_icon_facturado),xThisHistVenta.$.dialog_comprobante.close(),xPopupLoad.xclose()})}function xImprimirPrecuentaHistorial(){var t=[],a=xArrayDtOrdenFiltro,t=xArrayTpC.slice();for(b in t=JSON.parse(JSON.stringify(t)),xArrayTpC)for(var o in a)xArrayTpC[b].id==a[o].idtipo_consumo&&1!=a[o].visible&&null!=xArrayTpC[b]&&(a[o].precio_print=a[o].ptotal,a[o].des=a[o].descripcion,t[xArrayTpC[b].id][o]=a[o]);var i=$("#txt_mesa").text(),e=$("#txt_correlativo").text();e=(e=e.split("-"))[1],xArrayPrintEncaLi_pre_cuenta={m:i,r:"",num_pedido:e,reservar:0,solo_llevar:0,correlativo_dia:e,precuenta:!0},xMandarImprimirOtroDoc(xArrayPrintEncaLi_pre_cuenta,xDtPrint,t,arrSumSubtTotales,-1)}function reImprimirCierre(){xPopupLoad.xopen(),fecha=xDevolverFechaFormatInputDate(txt_fecha.value),$.ajax({type:"POST",url:"../../bdphp/log_005.php?op=17",data:{f:fecha}}).done(function(t){setTimeout(()=>{xPopupLoad.xclose()},1500)})}function reImprimirComprobante(){xPopupLoad.xopen();var t=xdt_pdE.num_comprobante;$.ajax({type:"POST",url:"../../bdphp/log_005.php?op=1701",data:{comprobante:t}}).done(function(t){setTimeout(()=>{xPopupLoad.xclose()},1500)})}Polymer({is:"x-historial_venta",properties:{xdtPedDet:Object,isCierreCaja:Boolean,xYaTieneComprobante:boolean=!0,xYaPedidoCerrado:boolean=!0,xIsPuedeReimprimirCPE:boolean=!1},attached:function(){this.xIsPuedeReimprimirCPE=!1,this.xYaTieneComprobante=!0,this.xYaPedidoCerrado=!0,this.isCierreCaja=!1,xThisHistVenta=this,xIniHistVenta(),setTimeout(()=>{_cpSocketOpen()},1e3)},detached:function(){_cpSocketClose()}})</script></dom-module>