<link rel="import"href="../x-componentes/x-comp-find-tipo-pago/x-comp-find-tipo-pago.html"><link rel="import"href="../x-componentes/pagination-input/pagination-input.html"><link rel="import"href="./x-compras-list.html"><dom-module id="x-compras"><template><paper-dialog id="dialog_additem_pro"class="dialog_redondo"modal entry-animation="scale-up-animation"exit-animation="fade-out-animation"with-backdrop><div class="xContent"><h3>Registrar nuevo producto</h3><br><form id="frm_item_pro"method="post"action="#"><input id="descripcion"name="descripcion"placeholder="Descripcion"class="xMiInput xPasarEnter2"onchange="conMayusculas(this)"required espaciar><br><input id="sel_familia"name="no_post"class="xMiInput xPasarEnter2"placeholder="Familia"onchange="conMayusculas(this)"required autofocus espaciar><br><input id="codigo_barra"name="codigo_barra"placeholder="Codigo de barras"class="xMiInput xPasarEnter2"onchange="conMayusculas(this)"espaciar><br><input id="stock_minimo"name="stock_minimo"placeholder="Stock minimo"class="xMiInput xPasarEnter2"onchange="conMayusculas(this)"espaciar><br><input id="precio"name="precio"placeholder="Precio de compra"onblur="xRetornaMoneda(this)"class="xMiInput xPasarEnter2"onchange="conMayusculas(this)"required espaciar><br><input id="precio_venta"name="precio_venta"placeholder="Precio de venta x unidad"onblur="xRetornaMoneda(this)"class="xMiInput xPasarEnter2 xPrecioAddPro"onchange="conMayusculas(this)"onkeyup="xEnterInInputDlg(event)"required espaciar><br><div class="xInvisible"><input id="idproducto"name="idproducto"> <input id="idorg"name="idorg"> <input id="idsede"name="idsede"> <input id="idproducto_familia"name="idproducto_familia"> <input id="precio_unitario"name="precio_unitario"></div></form><br><br><div class="xBoton2 xAzul"dialog-confirm onclick="xGuardarItemProComp()">Listo, guardar</div><div class="xBoton2 xPlomo"dialog-dismiss>Cancelar</div><br><br><br></div></paper-dialog><paper-dialog modal id="dialog_pago"class="tall xNoScroll dialog_redondo"entry-animation="scale-up-animation"exit-animation="fade-out-animation"with-backdrop><div id="div_pago"><x-pago id="component_pago_pro"></x-pago></div></paper-dialog><paper-dialog modal id="dialog_detalle_compora"style="min-width:400px"class="dialog_redondo"modal entry-animation="scale-up-animation"exit-animation="fade-out-animation"with-backdrop><div class="d-flexx justify-content-between"><p class="fw-600 fs-18">Detalles de compra</p><button class="btn btn-sm btn-secondary"dialog-dismiss><span class="pl-1 pr-1 fw-600">x</span></button></div><div class="m-3"><table width="100%"><thead><th align="left">Cant<th align="left">Producto<th align="right">Precio<tbody><template is="dom-repeat"items="{{ListDetalleCompra}}"as="item"><tr><td align="left">{{ item.cantidad }}<td align="left">{{ item.producto }}<td align="right">{{ item.precio }}</template><tr><td colspan="2"align="right"><span class="fw-600 fs-18">Total</span><td align="right"><span class="fw-600 fs-18">{{ sumListDetalleCompra }}</span></table></div></paper-dialog><paper-dialog class="dialog_redondo"id="dialog_registrar_pago"style="width:345px"modal entry-animation="scale-up-animation"exit-animation="fade-out-animation"><div><h4>Definir Forma de pago</h4><br><x-comp-find-tipo-pago id="compTpPago"onchange="_getTipoPago(list_tipo_pago)"></x-comp-find-tipo-pago><br><div><label for="date_fecha_pago"class="xColorRow_Plomo xfont11">Fecha de pago</label> <input type="date"class="xMiInput xPasarEnter2"id="date_fecha_pago"espaciar></div><br><br><button class="xBoton2 xVerde"onclick="xRegistrar_compra()">Listo, guardar</button> <button class="xBoton2 xPlomo"dialog-dismiss>Cancelar</button><br></div></paper-dialog><br><div class="xMiCard xradius"style="width:80%"><div id="divCompra"class="xInvisible"><div class="xInvisible"><form id="frm_compra"method="post"action="#"><input id="idorg"name="idorg"value$="[[xt_org]]"> <input id="idsede"name="idsede"value$="[[xt_idsede]]"> <input id="idproveedor"name="idproveedor"> <input id="idalmacen"name="idalmacen"> <input id="f_compra"name="f_compra"> <input id="f_registro"name="f_registro"> <input id="f_pago"name="f_pago"> <input id="fecha_hora"name="fecha_hora"> <input id="total"name="total"> <input id="a_pagar"name="a_pagar"> <input id="nota_de_compra"name="nota_de_compra"> <input id="idtipo_pago"name="idtipo_pago"> <input id="idusuario"name="idusuario"></form></div><div class="xEncanezadoCard xFondoRowAmarillo4"><p>Estos productos ingresa a:</p><select id="sel_alamcen"class="selected-template-1"inline></select></div><div class="xEncanezadoCard xHoverOpaco xTransicion3s"id="div_proveedor"><p><strong>Datos del proveedor</strong></p><br><div id="div_ínput"><form id="frm_proveedor"method="post"action="#"><div><div class="mb-1"><input id="descripcion"name="descripcion"placeholder="🔍 Nombre / Razon social"onchange="conMayusculas(this)"class="xPasarEnter2 selected-template-1"style="width:50%;min-width:250px"> <input id="telefono"name="telefono"placeholder="Telefono"onchange="conMayusculas(this)"class="selected-template-1 xPasarEnter2"style="width:44%;min-width:200px"></div><input id="dni"name="dni"placeholder="DNI / RUC"class="selected-template-1 xPasarEnter2"onchange="conMayusculas(this)"style="width:50%;min-width:200px"> <input id="direccion"name="direccion"placeholder="Direccion"class="selected-template-1 xPasarEnter2"onchange="conMayusculas(this)"style="width:44%;min-width:200px"></div><div class="xInvisible"><input id="idorg"name="idorg"> <input id="idsede"name="idsede"> <input id="idproveedor"name="idproveedor"></div></form><br><br></div></div><div class="xContentCard"><table class="xtable4"width="100%"id="tb_input"data-tablaname="producto_historial_precio"><thead><th class="xSinBorde"width="10px">Cant<th class="xSinBorde"width="60%">Producto<th class="xSinBorde"width="30px"align="right">Precio compra<th class="xSinBorde"width="10px"></thead><tr class="xSinBorde"data-id=""><td><input type="number"class="xMiInput xPasarEnter2"style="width:100%"placeholder="Cantidad"onchange="conMayusculas(this)"required id="cant_item"autofocus><td><input class="xMiInput xPasarEnter2"style="width:100%"placeholder="Descripcion"onchange="conMayusculas(this)"required id="des_item"><td><input class="xMiInput xAlinearDerecha xprecio"placeholder="Precio"onchange="conMayusculas(this)"onblur="xRetornaMoneda(this)"placeholder="Precio"id="precio_item"name="precio"required><td><paper-fab icon="add"onclick="xAddItemCompra()"title="Agregar item"></paper-fab><tr class="tt_row"></table><div class="xDerecha"><h3 id="tt_row"></h3></div><div class="xInvisible"><table id="tb_update_precio"data-tablaname="producto"></table><table id="tb_compra_items"data-tablaname="compra_items"></table><table id="tb_compra_pago"data-tablaname="compra_pago"></table></div></div><div class="xPieCard"><br><div><div class="xBoton2 xAzul"disabled$="[[!habilitarPago]]"onclick="xOpenRegistrarPago()">Listo, definir pago</div><div class="xBoton2 xPlomo ml-2"onclick="goList()">Atras</div></div><br><br></div></div><div id="divList"style="padding:30px"><div class="d-flexx justify-content-between align-content-center"><p class="fw-600 fs-20">Listado de compras</p><button class="btn btn-sm btn-primary"onclick="goCompra()">+ Nuevo</button></div><br><x-compras-list id="compListCompras"></x-compras-list></div><br><br></div></template></dom-module><script>var xThis,xCan_item,xDes_item,xPrecio_item,xnom_familia,xPrecio_und_pro,xIdProducto_sel,xValPago,xlo_idorg,xlo_idsede,xsel_proveedor,xsel_almacen,xRpt_pago,sel_idTipoPago,xdebounce,xNewItemPro=!1,xNewFamilia=!1,xPrecio_item_Add=0,xImporte_total_list=0,p_rows_re=0,p_rows=0,p_fecha="",p_filter="",p_desde=0,data_pagination={},data_pagination_re={},xe_debounce=!1;function xIniCompras(){xPopupLoad=document.getElementById("xLoad"),xm_LogChequea(function(){xm_log_get("ini_us"),$("body").addClass("loaded"),xlo_idorg=xIdOrg,xlo_idsede=xIdSede,xloadAlamcen()});var e=(dateNow=new Date).toISOString().split("T")[0];date_fecha_pago.value=e,xThis.habilitarPago=!1,$("#Titulo_page").text("Registrar Compras"),$(".xPasarEnter2").on("keyup",function(e){var o=e.which;if(13==o||186==o){var o=$("input"),a=o.index(document.activeElement);if(null!==o[a+1]){var t=o[a+1];if(void 0===t)return;if(null==(t=t.disabled?o[a+2]:t))return;t.focus(),t.select()}return event.stopPropagation(),e.stopPropagation(),e.stopImmediatePropagation(),!1}}),$(".xprecio").on("keyup",function(e){e=e.which;13!=e&&186!=e||xAddItemCompra(this)}),(xValPago=document.getElementById("component_pago_pro"))._tipo=2,xValPago.addEventListener("xSend",function(e){xRpt_pago=e.detail.xRpts,0!=e.detail.xRpts[0].ok&&xRegistrar_compra()}),xValPago.addEventListener("xCancelarCerrar",function(e){xThis.$.dialog_pago.close()}),$("#dialog_pago").on("iron-overlay-opened",function(){component_pago_pro.setFocusTxt()})}function xfiltrarDatos(){xe_debounce||(xe_debounce=!0,clearTimeout(xdebounce),xdebounce=setTimeout(()=>{xLoadCpeEmitidos("6"),xe_debounce=!1,xThis.$.paginator.currentPage=1},900))}function xEnterInInputDlg(e){e=e.which;13!=e&&186!=e||xGuardarItemProComp()}function xOpenRegistrarPago(){sel_idTipoPago=compTpPago.__data__.list_tipo_pago.idtipo_pago,dialog_registrar_pago.open()}function xAddItemCompra(){xCan_item=$("#cant_item").val(),xDes_item=$("#des_item").val(),xPrecio_item=xMoneda($("#precio_item").val(),2),""==xCan_item||""==xDes_item&&""==xPrecio_item||(xnom_familia="",(1==xNewItemPro?($("#frm_item_pro #descripcion").val(xDes_item),$("#frm_item_pro #precio").val(xPrecio_item),xnom_familia=$("#sel_familia").val(),dialog_additem_pro.open(),xCargarFamiliaInput):(xnom_familia=$("#des_item").attr("data-des-familia"),xPrecio_und_pro=parseFloat(xPrecio_item)/parseFloat(xCan_item),xAddItemLista(),xResetInputPro))())}function xAddItemLista(){var e=$("#tb_input"),o=e.find(".row").length,a='<tr class="row" id="'+(o+=xIdProducto_sel)+'"><td>'+xCan_item+"</td><td> "+xnom_familia+" | "+xDes_item+'</td><td align="right" class="ximporte_row">'+xPrecio_item+'</td><td><span class="xDeleteRowNeutro" title="Borrar" onclick="xBorrarItemLocalPro(this);"></span></td><td class="xInvisible" data-ColumName="idproducto">'+xIdProducto_sel+'</td><td class="xInvisible" data-ColumName="fecha">'+xDevolverFecha()+'</td><td class="xInvisible" data-ColumName="idorg">'+xlo_idorg+'</td><td class="xInvisible" data-ColumName="idsede">'+xlo_idsede+'</td><td class="xInvisible" data-ColumName="precio">'+xPrecio_und_pro+'</td><td class="xInvisible" data-ColumName="idproveedor">-proveedor</td></tr>',t='<tr class="row" data-update="'+xIdProducto_sel+'" id="'+o+'"><td data-ColumName="precio_unitario">'+xPrecio_und_pro+"</td></tr>",t=($("#tb_update_precio").append(t).trigger("create"),'<tr class="row" id="'+o+'"><td data-ColumName="idcompra">-compra</td><td data-ColumName="idproducto">'+xIdProducto_sel+'</td><td data-ColumName="cantidad">'+xCan_item+'</td><td data-ColumName="punitario">'+xPrecio_und_pro+'</td><td data-ColumName="ptotal">'+xPrecio_item+"</td></tr>");$("#tb_compra_items").append(t).trigger("create"),(0==e.find(".row").length?e.append(a):$("#tb_input tr.row:first").before(a)).trigger("create"),xSumarTotalLista()}function xRegistrar_compra(){var e;0!==$("#tb_input").find(".row").length&&(e=$("#frm_proveedor #descripcion"),xsel_almacen=$("#sel_alamcen option:selected").val(),xsel_proveedor=e.attr("data-id")||0,""!=e.val()?(xPopupLoad.xopen(),$("#frm_proveedor #idorg").val(xlo_idorg),$("#frm_proveedor #idsede").val(xlo_idsede),$.post("../../bdphp/ManejoBD_IUD.php?tb=proveedor",$("#frm_proveedor").serialize(),function(e){xsel_proveedor=e,xGuardarRegistroCompra()})):xGuardarRegistroCompra())}function xGuardarRegistroCompra(){var o,e=String('<tr class="row"><td data-ColumName="idcompra">-compra</td><td data-ColumName="idtipo_pago">'+sel_idTipoPago+'</td><td data-ColumName="importe">'+xImporte_total_list+"</td></tr>"),a=($("#tb_compra_pago").append(e).trigger("create"),xPopupLoad.xopen(),xArmarInsertDetalle($("#tb_update_precio"),"idproducto","","",1)),t=xArmarInsertDetalle($("#tb_input"),"","",""),r=xArmarInsertDetalle($("#tb_compra_items"),"","",""),i=xArmarInsertDetalle($("#tb_compra_pago"),"","",""),t=t.replace(/-proveedor/g,xsel_proveedor),e=$("#frm_compra");e.find("#idproveedor").val(xsel_proveedor),e.find("#idalmacen").val(xsel_almacen),e.find("#f_registro").val(xDevolverFecha()),e.find("#f_compra").val(xDevolverFecha()),e.find("#f_pago").val(xDevolverFechaFormatInputDate(date_fecha_pago.value)),e.find("#fecha_hora").val((new Date).toLocaleString()),e.find("#idtipo_pago").val(sel_idTipoPago),e.find("#total").val(xImporte_total_list),e.find("#a_pagar").val(xImporte_total_list),e.find("#idorg").val(xlo_idorg),e.find("#idsede").val(xlo_idsede),e.find("#idusuario").val(xIdUsuario),$.post("../../bdphp/ManejoBD_IUD.php?tb=compra",$("#frm_compra").serialize(),function(e){o=e,r=r.replace(/-compra/g,o),i=i.replace(/-compra/g,o);e=String(r+"; "+i+"; "+t+"; "+a);$.ajax({type:"POST",url:"../../bdphp/log_100.php?op=1",data:{xsql:e}}).done(function(e){xPopupLoad.xclose(),dialog_registrar_pago.close(),xNuevaCompra(),xLoadCpeEmitidos(),document.getElementById("compListCompras").refresh()})})}function _getTipoPago(e){sel_idTipoPago=e.idtipo_pago}function xNuevaCompra(){$("#tb_update_precio tr").remove(),$("#tb_input tr.row").remove(),$("#tb_input tr.tt_row").remove(),$("#tb_compra_items tr").remove(),$("#frm_compra").reset(),$("#frm_proveedor").reset(),$("#frm_item_pro").reset(),dialog_pago.close(),xThis.habilitarPago=!1}function xSumarTotalLista(){var e=$("#tb_input"),o='<tr class="tt_row xSinBorde"><td colspan="2" align="right"><h3>Total</h3></td><td align="right"><h3><strong>'+(xImporte_total_list=xMoneda(xSumaCantRow(e,".ximporte_row")))+'</strong></h3></td><td colspan="2"></td></tr>';e.find(".tt_row").remove(),e.append(o).trigger("create"),xThis.habilitarPago=0<parseInt(xImporte_total_list)}function xBorrarItemLocalPro(e){var e=$(e).parent().parent(),o=(e.parents("table"),e.attr("id"));e.fadeTo(550,0,function(){$(this).remove(),$("#tb_update_precio #"+o).remove(),$("#tb_compra_items #"+o).remove(),xSumarTotalLista()})}function xResetInputPro(){$("#des_item").val(""),$("#des_item").attr("data-id",""),$("#cant_item").val(""),$("#precio_item").val(""),$("#cant_item").focus()}function xGuardarItemProComp(){xPopupLoad.xopen(),xnom_familia=$("#sel_familia").val(),xPrecio_item=xMoneda($("#frm_item_pro #precio").val()),1==xNewFamilia?$.ajax({type:"POST",url:"../../bdphp/log.php?op=1602",data:{f:xnom_familia}}).done(function(e){$("#frm_item_pro #idproducto_familia").val(e),xGuardarItemProDtCompra(),xLoadFamilias()}):xGuardarItemProDtCompra()}function xGuardarItemProDtCompra(){xPrecio_und_pro=parseFloat(xPrecio_item)/parseFloat(xCan_item),$("#frm_item_pro #idorg").val(xlo_idorg),$("#frm_item_pro #idsede").val(xlo_idsede),$("#frm_item_pro #precio_unitario").val(xPrecio_und_pro),$.post("../../bdphp/ManejoBD_IUD.php?tb=producto",$("#frm_item_pro").serialize(),function(e){xIdProducto_sel=e,xAddItemLista(),dialog_additem_pro.close(),$("#frm_item_pro").reset(),xPopupLoad.xclose(),xResetInputPro()})}function xCargarProductoItem(){var a=0,t=$("#des_item");t.autocomplete({autoFocus:!0,source:xThis.dtProItem,select:function(e,o){return t.val(o.item.label),t.attr("data-id",o.item.value),t.attr("data-des-familia",o.item.familia),$("#frm_item_pro #idproducto").val(o.item.value),xIdProducto_sel=o.item.value,a=null==o.item.precio_unitario?0:o.item.precio_unitario,a=parseFloat(parseFloat(a)*parseFloat($("#cant_item").val())).toFixed(2),isNaN(a)&&(a=0),$("#frm_item_pro #precio").val(a),$("#frm_item_pro #precio_venta").val(o.item.precio_venta),$("#precio_item").val(a),!1},focus:function(e,o){return!1},change:function(e,o){return null===o.item?(t.attr("data-value",""),t.attr("data-id",""),$("#frm_item_pro #precio").val(""),$("#frm_item_pro #precio_venta").val(""),$("#frm_item_pro #idproducto").val(""),xNewItemPro=!0):(xNewItemPro=!1,$("#frm_item_pro #idproducto").val(o.item.value)),!1}})}function xloadAlamcen(){xPopupLoad.titulo="Cargando...",xPopupLoad.xopen(),$.ajax({type:"POST",url:"../../bdphp/log.php?op=1604"}).done(function(e){for(var o="",a=$.parseJSON(e).datos,t=0;t<a.length;t++)o=String(o+'<option value="'+a[t].idalmacen+'">'+a[t].descripcion+"</option>");$("#sel_alamcen").html(o).trigger("create"),xloadProductoItem()})}function xloadProductoItem(){$.ajax({type:"POST",url:"../../bdphp/log.php?op=16"}).done(function(e){e=$.parseJSON(e);xThis.dtProItem=e.datos,xCargarProductoItem(),xLoadFamilias(),xLoadProveedores()})}function xLoadFamilias(){$.ajax({type:"POST",url:"../../bdphp/log.php?op=1601"}).done(function(e){e=$.parseJSON(e);xThis.dtProFam=e.datos,xCargarFamiliaInput()})}function xLoadProveedores(){$.ajax({type:"POST",url:"../../bdphp/log.php?op=1603"}).done(function(e){e=$.parseJSON(e);xThis.dtProProveedor=e.datos,xCargarProveedores(),xPopupLoad.xclose()})}function xCargarProveedores(){var a=$("#frm_proveedor #descripcion");a.autocomplete({autoFocus:!0,source:xThis.dtProProveedor,select:function(e,o){return xsel_proveedor=o.item.value,a.val(o.item.label),a.attr("data-id",xsel_proveedor),$("#frm_proveedor #idproveedor").val(xsel_proveedor),$("#frm_proveedor #direccion").val(o.item.direccion),$("#frm_proveedor #dni").val(o.item.dni),$("#frm_proveedor #telefono").val(o.item.telefono),!1},focus:function(e,o){return!1},change:function(e,o){return null===o.item&&(a.attr("data-id",""),xsel_proveedor="",$("#frm_proveedor #idproveedor").val("")),!1}})}function xCargarFamiliaInput(){var a=$("#sel_familia");a.autocomplete({autoFocus:!0,source:xThis.dtProFam,appendTo:$("#dialog_additem_pro"),select:function(e,o){return a.val(o.item.label),a.attr("data-id",o.item.value),$("#frm_item_pro #idproducto_familia").val(o.item.value),!1},focus:function(e,o){return!1},change:function(e,o){return null===o.item?(a.attr("data-value",""),a.attr("data-id",""),$("#frm_item_pro #idproducto_familia").val(""),xNewFamilia=!0):(xNewFamilia=!1,$("#frm_item_pro #idproducto_familia").val(o.item.value)),!1}})}function xLoadCpeEmitidos(e){}function xloadDetalleCompra(e){e=e.dataId;$.ajax({type:"POST",url:"../../bdphp/log_004.php?op=1301",data:{id:e}}).done(function(e){e=JSON.parse(e).datos,(xThis.sumListDetalleCompra=0)!==e.length&&(xThis.sumListDetalleCompra=e.map(e=>parseFloat(e.precio)).reduce((e,o)=>e+o,0),xThis.sumListDetalleCompra=xThis.sumListDetalleCompra.toFixed(2),xThis.ListDetalleCompra=e,dialog_detalle_compora.open())})}function goList(){$(divCompra).addClass("xInvisible"),$(divList).removeClass("xInvisible")}function goCompra(){$(divList).addClass("xInvisible"),$(divCompra).removeClass("xInvisible")}Polymer({is:"x-compras",properties:{xt_org:Number,xt_idsede:Number,xt_idus:Number,dtProItem:Object,dtProFam:Object,dtProProveedor:Object,habilitarPago:!1,ListCpe:[],ListDetalleCompra:[],sumListDetalleCompra:Number,sumListCompra:Number},attached:function(){xThis=this,xIniCompras(),this.selected_page=0},displayIndex:function(e){return xCeroIzq(parseInt(p_desde)+(e+1),1)}})</script>