<dom-module id="x-entrada">
<script src="../../view/item_pedido_print_comprobante.js"></script>
<script rel="prefetch" type="text/javascript" src="../../view/socket.service.p.js"></script>
<template is="dom-bind">
<paper-dialog modal id="dialog_cierre_ticket_venta" class="dialog_redondo" modal entry-animation="scale-up-animation" exit-animation="fade-out-animation" with-backdrop>
<p class="fw-600">Al imprimir el resumen se realizara el corte a la fecha y hora actual.</p>
<div>
<button class="btn btn-success" onclick="xCerrarVentaTicketEntrada()"> Listo.</button>
<button class="btn btn-secondary" dialog-dismiss> Cancelar</button>
</div>
<br>
</paper-dialog>
<div class="content-ticket-rapido mt-2">
<div>
<paper-tabs selected="{{selected_tab_ticket_venta}}" class="tab-ticket" id="tabs_ticket_venta">
<paper-tab>Ticket</paper-tab>
<paper-tab>Resumen</paper-tab>
</paper-tabs>
</div>
<br>
<div class="ticket-body">
<iron-pages selected="{{selected_tab_ticket_venta}}">
<div id="ticketventa">
<div class="d-flexx justify-content-between align-items-center">
<p class="fw-600 fs-16 text-center">Ticket RÃ¡pido</p>
<select id="selSeccionesTicket" class="selected-template-1" style="max-width:170px" onchange="xChangeSeccionTicket(this)">
<template is="dom-repeat" items="{{listSeccionesTicket}}" as="item">
<option value="[[index]]">[[item.descripcion]] </option>
</template>
</select>
</div>
<br><div class="xLinea2"></div><br>
<div>
<template is="dom-repeat" items="{{listItemsTicketEntrada}}" as="item">
<div class="item-ticket">
<div data-index="[[index]]" onclick="xAddItemTicket(this,1)" class="w-100">
<p class="pl-2 noselect">{{item.descripcion}} | {{item.precio}}</p>
</div>
<div class="cantidad-ticket">
<div class="btn-ticket menos noselect" data-index="[[index]]" onclick="xAddItemTicket(this,0)">-</div>
<div class="pl-1 pr-1 noselect">{{ item.cantidad_seleccionada }}</div>
<div class="btn-ticket mas noselect" data-index="[[index]]" onclick="xAddItemTicket(this,1)">+</div>
</div>
</div>
</template>
<div class="total-ticket">
<div class="importe-total">
<p class="text-secondary mr-2 fs-18 noselect">Total</p>
<p class="fw-600 fs-26 noselect"> {{importeTotalTicketEntrada}}</p>
</div>
</div>
<br><div class="xLinea2"></div><br>
<div class="text-right">
<button class="btn btn-success fs-18" disabled$="[[ !isShowBtnTicketEntrada ]]" onclick="xSaveTicketEntrada()">Listo Registrar</button>
</div>
</div>
</div>
<div id="ticketresumen">
<p class="fw-600 fs-18">Resumen de venta:</p>
<br><div class="xLinea2"></div>
<table class="w-100">
<thead>
<th align="left">Descripcion</th>
<th align="center">Cant.</th>
<th align="right">Total</th>
</thead>
<tbody>
<template is="dom-repeat" items="{{listResumenTicketEntrada}}" as="item">
<tr>
<td>{{ item.descripcion }}</td>
<td align="center">{{ item.cantidad }}</td>
<td align="right">{{ item.total }}</td>
</tr>
</template>
<tr>
<td colspan="3" align="right">
<p class="fw-600 fs-18">S/. {{ totalResumenTicketEntrada }} </p>
</td>
</tr>
</tbody>
</table>
<br><br>
<div class="text-right">
<button class="btn btn-info fs-18" disabled$="[[ !isShowBtnResumenTicketEntrada ]]" onclick="dialog_cierre_ticket_venta.open()">Imprimir Resumen</button>
</div>
</div>
</iron-pages>
</div>
</div>
</template>
<style>.content-ticket-rapido{max-width:450px;margin:0 auto;height:calc(100vh - 80px);background:#e8e8e8}.content-ticket-rapido .ticket-body{padding:10px}.tab-ticket{background:#cbcbcb;padding:0;margin:0;border-radius:5px 5px 0 0;max-width:450px;border-bottom:2px solid #989898;font-size:18px!important}.item-ticket{font-size:14px;display:flex;justify-content:space-between;background:#f6f6f6;border-radius:5px;margin-bottom:8px;font-weight:600;align-items:center;cursor:pointer;height:48px}.item-ticket:hover{background:#fafaa4}.item-ticket .cantidad-ticket{display:flex;justify-content:space-between;font-size:25px;align-items:center}.cantidad-ticket .btn-ticket{padding:12px;border-radius:5px}.cantidad-ticket .btn-ticket.menos:hover{background:#faa}.cantidad-ticket .btn-ticket.mas:hover{background:#9ef3b4}.total-ticket{display:flex;flex-direction:row-reverse;align-items:center}.total-ticket .importe-total{display:flex;padding:10px;background:#d0d0d0;border-radius:5px;margin-top:5px}</style>
<script>var xThisEntrada;function xIniTicketEntrada(){$("#tabs_ticket_venta").on('iron-select',function(){switch(xThisEntrada.selected_tab_ticket_venta){case 1:xLoadResumenTicketEntrada();break;}})
$.ajax({type:'POST',url:'../../bdphp/log_componentes.php?op=2002'}).done(function(dtValues){dtValues=JSON.parse(dtValues);xThisEntrada.listSeccionesTicket=dtValues.datos;let _indexSelectedInit=0;let _seccionEntradaTicket=null;xThisEntrada.listSeccionesTicket.map((x,i)=>{if(x.descripcion.toLowerCase()==='ticket entrada'){_indexSelectedInit=i;_seccionEntradaTicket=x;return;}});xThisEntrada.selected_tab_ticket_venta=0;setTimeout(()=>{if(_seccionEntradaTicket){xThisEntrada.seccionSelectedInti=_seccionEntradaTicket;selSeccionesTicket.selectedIndex=_indexSelectedInit;xGetItemsSeccionTicket(_seccionEntradaTicket.idseccion);}},700);});}
function xChangeSeccionTicket(){const index=xThisEntrada.$.selSeccionesTicket.value;const _seccionSelectedTicket=xThisEntrada.listSeccionesTicket[index];xGetItemsSeccionTicket(_seccionSelectedTicket.idseccion);}
function xGetItemsSeccionTicket(_idseccion){$.ajax({type:'POST',url:'../../bdphp/log_componentes.php?op=22',data:{idseccion:_idseccion}}).done(res=>{res=JSON.parse(res);xThisEntrada.listItemsTicketEntrada=res.datos;xNewListTicketEntrada();});}
function xNewListTicketEntrada(){xThisEntrada.listItemsTicketEntrada.map(x=>{x.cantidad_seleccionada=0;x.total=0;});xThisEntrada.importeTotalTicketEntrada=0;xThisEntrada.isShowBtnTicketEntrada=false;xThisEntrada.listItemsTicketEntrada=JSON.parse(JSON.stringify(xThisEntrada.listItemsTicketEntrada));}
function xAddItemTicket(obj,suma){let itemTicketSelected=xThisEntrada.listItemsTicketEntrada[obj.dataIndex];if(suma==1){itemTicketSelected.cantidad_seleccionada++;}else{itemTicketSelected.cantidad_seleccionada=itemTicketSelected.cantidad_seleccionada===0?0:itemTicketSelected.cantidad_seleccionada-1;}
xThisEntrada.listItemsTicketEntrada=JSON.parse(JSON.stringify(xThisEntrada.listItemsTicketEntrada));xSumTotalTicketEntrada();}
function xSumTotalTicketEntrada(){xThisEntrada.listItemsTicketEntrada=xThisEntrada.listItemsTicketEntrada.map(x=>{x.total=parseFloat(x.precio)*parseFloat(x.cantidad_seleccionada);return x;})
xThisEntrada.importeTotalTicketEntrada=parseFloat(xThisEntrada.listItemsTicketEntrada.map(x=>x.total).reduce((a,b)=>a+b,0)).toFixed(2);xThisEntrada.isShowBtnTicketEntrada=xThisEntrada.importeTotalTicketEntrada>0;}
function xSaveTicketEntrada(){const _listSend=xThisEntrada.listItemsTicketEntrada.filter(x=>x.cantidad_seleccionada>0);xPopupLoad.xopen();$.ajax({type:'POST',url:'../../bdphp/log_componentes.php?op=2201',data:{items:_listSend,total:xThisEntrada.importeTotalTicketEntrada}}).done(res=>{res=JSON.parse(res)
const _correlativo=res.datos[0].correlativo;xCocinarImpresionTicketEntrada(_correlativo);setTimeout(()=>{xPopupLoad.xclose();},700);});}
function xCocinarImpresionTicketEntrada(_correlativo){const _listSend=xThisEntrada.listItemsTicketEntrada.filter(x=>x.cantidad_seleccionada>0);const _arrTotales=[{descripcion:'Total',importe:xThisEntrada.importeTotalTicketEntrada}];const printer=xgetImpresoraById(xThisEntrada.seccionSelectedInti.idimpresora);if(!printer){return;}
const _dataPrintD={lista:_listSend,impresora:printer,subtotales:_arrTotales,encabezado:{correlativo_dia:xCeroIzq(_correlativo,5),}}
xImprimirCualquierLista(_dataPrintD,7,'ticket');xNewListTicketEntrada();}
function xCerrarVentaTicketEntrada(){xPopupLoad.xopen();$.ajax({type:'POST',url:'../../bdphp/log_componentes.php?op=2203'}).done(res=>{dialog_cierre_ticket_venta.close();xCocinarImpresionResumenTicketEntrada();xLoadResumenTicketEntrada();xPopupLoad.xclose();});}
function xCocinarImpresionResumenTicketEntrada(){var _listSendResumen=[]
xThisEntrada.listResumenTicketEntrada.map(x=>{_listSendResumen.push({'descripcion':x.cantidad+' '+x.descripcion,'cantidad':x.total})});const _arrTotales=[{descripcion:'Total',importe:xThisEntrada.totalResumenTicketEntrada}];const printer=xgetImpresoraById(xThisEntrada.seccionSelectedInti.idimpresora);const _dataUs=xm_log_get('ini_us');if(!printer){return;}
const _dataPrintD={lista:_listSendResumen,impresora:printer,subtotales:_arrTotales,encabezado:{tipo:'RESUMEN DE TICKETS',titulo:'RESUMEN DE TICKETS',correlativo_lista:'',otro:'',observaciones:'Corresponde a: '+xNomU}}
xImprimirCualquierLista(_dataPrintD);}
function xLoadResumenTicketEntrada(){xPopupLoad.xopen();$.ajax({type:'POST',url:'../../bdphp/log_componentes.php?op=2202'}).done(res=>{res=JSON.parse(res)
xThisEntrada.listResumenTicketEntrada=res.datos;xThisEntrada.totalResumenTicketEntrada=parseFloat(res.datos.map(x=>parseFloat(x.total)).reduce((a,b)=>a+b,0)).toFixed(2);xThisEntrada.isShowBtnResumenTicketEntrada=parseFloat(xThisEntrada.totalResumenTicketEntrada)>0;xPopupLoad.xclose();});}
Polymer({is:'x-entrada',properties:{listSeccionesTicket:[],seccionSelectedInti:[],listItemsTicketEntrada:[],listResumenTicketEntrada:[],importeTotalTicketEntrada:Number,isShowBtnTicketEntrada:Boolean,selected_tab_ticket_venta:Number,totalResumenTicketEntrada:Number,isShowBtnResumenTicketEntrada:Boolean,},attached:function(){this.selected_tab_ticket_venta=0;this.isShowBtnTicketEntrada=false;this.isShowBtnResumenTicketEntrada=false;xThisEntrada=this;xIniTicketEntrada();_cpSocketOpen();},detached:()=>{_cpSocketClose();}})</script>
</dom-module>