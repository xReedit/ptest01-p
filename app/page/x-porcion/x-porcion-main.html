<dom-module id="x-porcion-main"><link rel="import"href="./x-porcion-detalle.html"><script src="../../../js/porcion.utils.js"></script><script src="../../../js/sedes.cache.js"></script><template><paper-dialog modal id="dialog_additem_porcion"class="dialog_redondo"modal entry-animation="scale-up-animation"style="max-width:600px"exit-animation="fade-out-animation"with-backdrop><div class="xContent"><h3>Agregar Porcion</h3><br><p><strong>Elaborar porciones para las recetas.</strong><br>Por ejemplo: de 1000gr de bistec salen 10 porciones de 100gr cada una para el preparar bistec a lo pobre.<br>Utilize la misma unidad de medida que esta en el producto a porcionar. Es decir si el producto a porcionar esta en gramos la misma unidad de medida debe ser para las prociones.</p><br><form id="frm_add_porcion"><input id="descripcion"name="descripcion"placeholder="Descripcion de la porcion"class="xMiInput xPasarEnter2"onchange="conMayusculas(this)"oninput="generarCodigoSugeridoNuevaPorcion()"autofocus required espaciar><br><input id="peso"name="peso"placeholder="Peso"class="xMiInput xPasarEnter2"onchange="conMayusculas(this)"autofocus required espaciar><br><input id="stock"name="stock"placeholder="Cantidad"class="xMiInput xPasarEnter2"onchange="conMayusculas(this)"autofocus required espaciar><br><div class="mb-2"><label class="fs-12 text-secondary">Código Único (sugerido)</label> <input id="codigo_unico"name="codigo_unico"placeholder="Código único"class="xMiInput"readonly="readonly"style="background:#f0f9ff;font-weight:600;color:#059669"><p class="fs-11 text-secondary mt-1 mb-0"><i class="fa fa-info-circle mr-1"></i> El código se genera automáticamente basado en el nombre de la porción</div><div id="container_multisede"style="display:none"class="mb-2"><label class="fs-12"><input type="checkbox"id="registrar_todas_sedes"onchange="toggleSedesLista()"> <span class="fw-600">Registrar en todas las sedes</span></label><div id="lista_sedes"style="display:none;margin-left:20px;margin-top:10px"><p class="fs-11 text-secondary mb-1">Sedes donde se registrará:<div id="sedes_disponibles"class="fs-12"></div></div></div><div class="xInvisible"><input id="idporcion"name="idporcion"> <input id="idorg"name="idorg"> <input id="idsede"name="idsede"></div></form><br><br><div class="xBoton2 xAzul"onclick="xGuardarItemPorcionPorcion()">Listo, guardar</div><div class="xBoton2 xPlomo"dialog-dismiss>Cancelar</div><br><br><br></div></paper-dialog><div class="p-2"><br><div class="xMiCard xradius"style="width:90%;max-width:1250px"><div class="xEncanezadoCard d-flexx justify-content-between"style="background:#fff0f5;color:#424242"><div class="div-content-head-op"><p class="fw-600 fs-18">Porciones<p class="fw-100 text-secondary fs-12">Lista de porciones que son parte de recetas.</div><div><button class="btn btn-sm btn-secondary"hidden$="[[!isShowDetallePorcion]]"onclick="goMainPorcion()">Atras</button></div></div><div class="p-3 mb-5"><div hidden$="[[isShowDetallePorcion]]"><input class="xMiInput"placeholder="Buscar"inline id="txt_buscar_porcion"on-input="searchPorcion"><div class="xBoton2 xAzul xDerecha"onclick="abrirDialogAgregarPorcion()">+ Agregar Porcion</div><br><br><br><div class="xLinea2"></div><br><table width="100%"><thead><th align="left">Porción<th align="left">Stock<th width="5px"><tbody><template is="dom-repeat"items="{{listPorciones}}"as="item"><tr data-id="[[item.idporcion]]"onclick="xGoDetallePorcion(this)"><td class="xCursor"><p class="m-0 p-0">{{ item.porcion }}</p><template is="dom-if"if="[[item.codigo_unico]]"><span class="fs-10 fw-600 text-success">[[item.codigo_unico]]</span></template><td class="sumar_stock xCursor"><span class="fw-600">[[item.stock]]</span><template is="dom-if"if="[[item.nombre_unidad_alternativa]]"><span class="fs-12 text-secondary"><i class="fa fa-exchange mr-1"></i> <span class="fw-600">[[calcularStockConvertidoLocal(item.stock, item.factor_conversion)]]</span> [[item.nombre_unidad_alternativa]]</span></template><td><button data-id="[[item.idporcion]]"onclick="xGoDetallePorcion(this)"class="btn btn-sm btn-xsm xBoton_flat_2">Detalle</button></template></table><br><br><br></div><div hidden$="[[!isShowDetallePorcion]]"><x-porcion-detalle objporcion$="[[objPorcion]]"></x-porcion-detalle></div></div></div></div></template></dom-module><script>var xThisProPor;let sedesDisponibles=[],siguienteNumeroSecuencial="";function xIniPorcion(){$("#Titulo_page").text("Porciones"),xLoadPorciones(),$("body").addClass("loaded")}async function abrirDialogAgregarPorcion(){document.getElementById("frm_add_porcion").reset(),document.getElementById("codigo_unico").value="",await verificarSedesDisponibles();var e=localStorage.getItem("registrar_todas_sedes_preferencia"),o=document.getElementById("registrar_todas_sedes");o.checked=null!==e&&"true"===e,document.getElementById("lista_sedes").style.display=o.checked?"block":"none",await obtenerSiguienteNumero(),dialog_additem_porcion.open()}async function verificarSedesDisponibles(){try{var e=await SedesCache.obtenerSedesDisponibles();if(e&&1<e.length){sedesDisponibles=e,document.getElementById("container_multisede").style.display="block";let i="";sedesDisponibles.forEach(e=>{var o=e.idsede==xIdSede;i+=`<span class="${o?"fw-600":""}">
                        <i class="fa fa-${o?"check-circle text-success":"circle-o"} mr-1"></i>
                        ${e.descripcion} ${o?"(Actual)":""}
                    </span> | `}),document.getElementById("sedes_disponibles").innerHTML=i}else sedesDisponibles=[],document.getElementById("container_multisede").style.display="none"}catch(e){}}async function obtenerSiguienteNumero(){try{var e=await(new httpFecht).postJson("../../bdphp/log_009.php?op=132",{});e.success&&e.siguiente_numero&&(siguienteNumeroSecuencial=e.siguiente_numero)}catch(e){}}function generarCodigoSugeridoNuevaPorcion(){var e=document.getElementById("descripcion").value;e&&siguienteNumeroSecuencial&&(e=generarCodigoUnicoPorcion(e,siguienteNumeroSecuencial),document.getElementById("codigo_unico").value=e)}function toggleSedesLista(){var e=document.getElementById("registrar_todas_sedes");document.getElementById("lista_sedes").style.display=e.checked?"block":"none",localStorage.setItem("registrar_todas_sedes_preferencia",e.checked.toString())}async function xGuardarItemPorcionPorcion(){xvalidateFormInput("frm_add_porcion",async function(e){if(!1!==e){xPopupLoad.xopen();var o=document.getElementById("descripcion").value,i=document.getElementById("peso").value,s=document.getElementById("stock").value,t=document.getElementById("codigo_unico").value,e=document.getElementById("registrar_todas_sedes").checked;try{var r=new httpFecht;if(e&&1<sedesDisponibles.length){let e=0;for(var n of sedesDisponibles){var c={descripcion:o,peso:i,stock:s,idorg:xIdOrg,idsede:n.idsede,codigo_unico:t},a=await r.postJson("../../bdphp/log_009.php?op=134",c);a.success&&e++}showToastSwal("success",`Porción registrada en ${e} de ${sedesDisponibles.length} sedes`)}else{$("#frm_add_porcion #idorg").val(xIdOrg),$("#frm_add_porcion #idsede").val(xIdSede);var d={descripcion:o,peso:i,stock:s,idorg:xIdOrg,idsede:xIdSede,codigo_unico:t};(await r.postJson("../../bdphp/log_009.php?op=134",d)).success?showToastSwal("success","Porción registrada correctamente"):showToastSwal("error","Error al guardar la porción")}xLoadPorciones(),dialog_additem_porcion.close()}catch(e){showToastSwal("error","Error al guardar la porción")}xPopupLoad.xclose()}})}function xLoadPorciones(){xPopupLoad.xopen(),$.ajax({type:"POST",url:"../../bdphp/log.php?op=1803"}).done(function(e){var o,i="",s=(s=$.parseJSON(e)).datos.map(e=>(e.modificado=!1,e));xThisProPor.listPorciones=s,xThisProPor.listPorcionesOriginal=[...s];for(var t=0;t<s.length;t++)s[t].stock=parseFloat(s[t].stock),o=s[t].stock,i=String(i+'<tr class="row" data-idp="'+s[t].idporcion+'"><td>'+s[t].familia+'</td><td class="xCursor"><span onclick="xModRow(this,3);" id="td_des" data-valorginal="'+s[t].porcion+'">'+s[t].porcion+'</span></td><td class="sumar_stock xCursor" onclick="xModRow(this,2);" id="td_stock" data-valorginal="'+o+'" data-mod-stock="'+o+'" data-colummn="stock">'+o+'</td><td><span class="xDeleteRowNeutro" title="Borrar" onclick="xBorrarProcion(this);"></span></td></tr>');$("#tb_porcion .row").remove(),xPopupLoad.xclose()})}function xGoDetallePorcion(e){const o=e.dataId;e=xThisProPor.listPorciones.filter(e=>e.idporcion===o)[0];xThisProPor.objPorcion=e,xThisProPor.isShowDetallePorcion=!0}function goMainPorcion(){xLoadPorciones(),xThisProPor.isShowDetallePorcion=!1}Polymer({is:"x-porcion-main",properties:{listPorciones:Object,objPorcion:[],isShowDetallePorcion:Boolean},attached:function(){this.isShowDetallePorcion=!1,xThisProPor=this,xIniPorcion()},searchPorcion:function(){const i=$("#txt_buscar_porcion").val().toLowerCase().trim();var e;i?(e=(this.listPorcionesOriginal||this.listPorciones).filter(e=>{var o=(e.familia||"").toLowerCase(),e=(e.porcion||"").toLowerCase();return o.includes(i)||e.includes(i)}),this.set("listPorciones",e)):this.set("listPorciones",this.listPorcionesOriginal||this.listPorciones)},calcularStockConvertidoLocal:function(e,o){return calcularStockConvertido(e,o)}})</script>