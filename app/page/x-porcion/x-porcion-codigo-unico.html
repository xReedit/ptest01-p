<dom-module id="x-porcion-codigo-unico"><script src="../../../js/porcion.utils.js"></script><template><style>.codigo-display{background:#f0f9ff;padding:15px;border-radius:8px;border:2px dashed #3b82f6;text-align:center}.codigo-text{font-size:20px;font-weight:600;color:#059669;letter-spacing:1px;font-family:monospace}.info-box{background:#fef3c7;padding:12px;border-radius:6px;border-left:4px solid #f59e0b}.ui-autocomplete{z-index:9999!important;max-height:300px;overflow-y:auto;overflow-x:hidden}</style><paper-dialog modal id="dialog_codigo_unico"class="dialog_redondo"entry-animation="scale-up-animation"style="max-width:550px"exit-animation="fade-out-animation"with-backdrop><div class="xContent"><h3><i class="fa fa-qrcode mr-2"></i>Código Único de Porción</h3><p class="fs-12 text-secondary">{{porcionNombre}}<div class="xLinea2"></div><br><template is="dom-if"if="[[codigoUnico]]"><div id="vista_codigo_guardado"><div class="codigo-display mb-3"><p class="fs-12 text-secondary m-0 mb-2">Código actual:<p class="codigo-text m-0">[[codigoUnico]]</div><div class="d-flexx justify-content-center mb-3"style="gap:10px"><button class="btn btn-sm btn-info"onclick="copiarCodigo()"><i class="fa fa-copy mr-1"></i> Copiar Código</button> <button class="btn btn-sm btn-warning"onclick="habilitarModificacion()"><i class="fa fa-edit mr-1"></i> Modificar</button> <button class="btn btn-sm btn-secondary"onclick="verPorcionesVinculadas()"><i class="fa fa-link mr-1"></i> Ver Vinculadas</button></div><div class="info-box"><p class="fs-11 m-0"><i class="fa fa-info-circle mr-1"></i> Este código permite vincular esta porción con porciones equivalentes en otros locales de tu organización.</div></div><div id="vista_modificar_codigo"style="display:none"><div class="mb-3"><p class="fs-14 fw-600 mb-2">Modificar código:<div class="d-flexx"style="gap:10px"><input id="input_codigo_modificar"class="xMiInput"placeholder="Ingrese nuevo código"value="{{codigoModificar::input}}"style="flex:1"> <button class="btn btn-sm btn-success"onclick="guardarCodigoModificado()"><i class="fa fa-check mr-1"></i> Guardar</button> <button class="btn btn-sm btn-secondary"onclick="cancelarModificacion()"><i class="fa fa-times mr-1"></i> Cancelar</button></div><p class="fs-11 text-secondary mt-2 mb-0"><i class="fa fa-exclamation-triangle mr-1"></i> <strong>Importante:</strong> Al modificar el código, se actualizará para todas las porciones vinculadas.</div></div></template><template is="dom-if"if="[[!codigoUnico]]"><div class="mb-3"><p class="fs-14 fw-600 mb-2">Código sugerido:<div class="d-flexx"style="gap:10px"><input id="input_codigo_sugerido"class="xMiInput"placeholder="Generando..."value="{{codigoSugerido::input}}"style="flex:1"> <button class="btn btn-sm btn-success"onclick="guardarCodigoSugerido()"><i class="fa fa-check mr-1"></i> Aceptar</button></div><p class="fs-11 text-secondary mt-2 mb-0"><i class="fa fa-info-circle mr-1"></i> Puedes modificar el código antes de guardarlo.</div><div class="text-center mb-3"><p class="fs-12 text-secondary">o</p><button class="btn btn-sm btn-info"onclick="mostrarPanelVincular()"><i class="fa fa-link mr-1"></i> Vincular con Código Existente</button></div><div id="panel_vincular"style="display:none;margin-top:20px;padding-top:20px;border-top:2px solid #e5e7eb"><p class="fs-14 fw-600 mb-2">Vincular con código existente:<div class="mb-2"><label class="fs-12 text-secondary">Buscar por código o nombre de porción</label> <input id="input_buscar_codigo"class="xMiInput"placeholder="Escribe para buscar..."style="width:100%"></div><div class="d-flexx"style="gap:10px"><button class="btn btn-sm btn-primary"onclick="vincularCodigoSeleccionado()"><i class="fa fa-link mr-1"></i> Vincular</button> <button class="btn btn-sm btn-secondary"onclick="ocultarPanelVincular()">Cancelar</button></div><p class="fs-11 text-secondary mt-2 mb-0"><i class="fa fa-lightbulb-o mr-1"></i> Busca el código por su valor o por el nombre de la porción.</div><div class="info-box mt-3"><p class="fs-11 m-0"><i class="fa fa-info-circle mr-1"></i> <strong>¿Para qué sirve?</strong> El código único te permite sincronizar porciones equivalentes entre diferentes locales de tu organización.</div></template><br><button class="btn btn-sm btn-secondary"dialog-dismiss>Cerrar</button><br></div></paper-dialog></template><script>let xthisCodigoUnico;async function cargarCodigo(){var o,i;xthisCodigoUnico&&xthisCodigoUnico.idporcion&&(i=new httpFecht,o={idporcion:xthisCodigoUnico.idporcion},(i=await i.postJson("../../bdphp/log_009.php?op=126",o)).success&&i.datos&&0<i.datos.length?xthisCodigoUnico.codigoUnico=i.datos[0].codigo:xthisCodigoUnico.codigoUnico="")}async function guardarCodigoSugerido(){var o,i,c;xthisCodigoUnico&&((o=(xthisCodigoUnico.codigoSugerido||"").trim())?(xPopupLoad.xopen(),c=new httpFecht,i={idporcion:xthisCodigoUnico.idporcion,codigo:o},c=await c.postJson("../../bdphp/log_009.php?op=127",i),xPopupLoad.xclose(),c.success?(showToastSwal("success","Código guardado correctamente"),xthisCodigoUnico.codigoUnico=o,xthisCodigoUnico.codigoSugerido="",xthisCodigoUnico.fire("codigo-generado",{codigo:o})):showToastSwal("error",c.message||"Error al guardar el código")):showToastSwal("error","El código no puede estar vacío"))}async function vincularCodigoSeleccionado(){var o,i,c;xthisCodigoUnico&&((o=(xthisCodigoUnico.codigoVincular||"").trim())?(xPopupLoad.xopen(),c=new httpFecht,i={idporcion:xthisCodigoUnico.idporcion,codigo:o},c=await c.postJson("../../bdphp/log_009.php?op=127",i),xPopupLoad.xclose(),c.success?(showToastSwal("success","Porción vinculada correctamente"),xthisCodigoUnico.codigoUnico=o,xthisCodigoUnico.codigoVincular="",$("#input_buscar_codigo").val(""),ocultarPanelVincular(),xthisCodigoUnico.fire("codigo-vinculado",{codigo:o})):showToastSwal("error",c.message||"Error al vincular el código")):showToastSwal("error","Debe seleccionar un código del autocomplete"))}function copiarCodigo(){if(xthisCodigoUnico&&xthisCodigoUnico.codigoUnico){var o=xthisCodigoUnico.codigoUnico,i=document.createElement("textarea");i.value=o,i.style.position="fixed",i.style.opacity="0",document.body.appendChild(i),i.select();try{document.execCommand("copy"),showToastSwal("success","Código copiado")}catch(o){showToastSwal("error","Error al copiar")}document.body.removeChild(i)}}async function verPorcionesVinculadas(){if(xthisCodigoUnico&&xthisCodigoUnico.codigoUnico){xPopupLoad.xopen();var o=new httpFecht,c={codigo:xthisCodigoUnico.codigoUnico},o=await o.postJson("../../bdphp/log_009.php?op=129",c);if(xPopupLoad.xclose(),o.success&&o.datos&&0<o.datos.length){let i='<div class="pb-2"><table class="fs-12 w-100">';i=i+'<thead><tr><th align="left">Local</th><th align="left">Porción</th><th align="left">Familia</th></tr></thead>'+"<tbody>",o.datos.forEach(o=>{i+=`<tr>
                        <td align="left">${o.nombre_sede}</td>
                        <td align="left">${o.descripcion}</td>
                        <td align="left">${o.familia}</td>
                    </tr>`}),i+="</tbody></table></div>";c=paramsSwalAlert;c.title='<p class="fw-600 fs-20">Porciones Vinculadas</p>',c.html=i,c.showCancelButton=!1,showAlertSwalHtmlDecision(c,1)}else showToastSwal("info","No hay otras porciones vinculadas")}}function mostrarPanelVincular(){var o=document.getElementById("panel_vincular");o&&(o.style.display="block"),dialog_codigo_unico.center(),buscarSugerenciaAutomatica(),setTimeout(function(){inicializarAutocomplete()},100)}async function buscarSugerenciaAutomatica(){if(xthisCodigoUnico&&xthisCodigoUnico.porcionNombre){var o=new httpFecht,i={termino:xthisCodigoUnico.porcionNombre};try{var c,t,n,a=await o.postJson("../../bdphp/log_009.php?op=131",i);a.success&&a.datos&&0<a.datos.length&&(c=a.datos.find(function(o){return o.porcion_nombre.toLowerCase()===xthisCodigoUnico.porcionNombre.toLowerCase()}))&&(t=$("#input_buscar_codigo"),n=c.codigo+" - "+c.porcion_nombre+" ("+c.total_vinculadas+" vinculadas)",t.val(n),xthisCodigoUnico.codigoVincular=c.codigo,showToastSwal("info","Se encontró una porción con el mismo nombre. Código sugerido: "+c.codigo))}catch(o){}}}function inicializarAutocomplete(){const c=$("#input_buscar_codigo");0!==c.length&&(c.autocomplete("instance")&&c.autocomplete("destroy"),c.autocomplete({autoFocus:!0,minLength:1,appendTo:$("#dialog_codigo_unico"),source:function(o,i){var c=new httpFecht,o={termino:o.term};c.postJson("../../bdphp/log_009.php?op=131",o).then(function(o){o.success&&o.datos?(o=o.datos.map(function(o){return{label:o.codigo+" - "+o.porcion_nombre+" ("+o.total_vinculadas+" vinculadas)",value:o.codigo,codigo:o.codigo,porcion_nombre:o.porcion_nombre,total_vinculadas:o.total_vinculadas}}),i(o)):i([])}).catch(function(o){i([])})},select:function(o,i){return xthisCodigoUnico&&(xthisCodigoUnico.codigoVincular=i.item.codigo),c.val(i.item.label),!1},focus:function(o,i){return!1},change:function(o,i){return null===i.item&&(c.val(""),xthisCodigoUnico)&&(xthisCodigoUnico.codigoVincular=""),!1}}))}function ocultarPanelVincular(){var o=document.getElementById("panel_vincular");o&&(o.style.display="none"),$("#input_buscar_codigo").val(""),xthisCodigoUnico&&(xthisCodigoUnico.codigoVincular="")}function habilitarModificacion(){var o,i;xthisCodigoUnico&&(xthisCodigoUnico.codigoModificar=xthisCodigoUnico.codigoUnico,o=document.getElementById("vista_codigo_guardado"),i=document.getElementById("vista_modificar_codigo"),o&&(o.style.display="none"),i)&&(i.style.display="block")}function cancelarModificacion(){var o,i;xthisCodigoUnico&&(xthisCodigoUnico.codigoModificar="",o=document.getElementById("vista_codigo_guardado"),i=document.getElementById("vista_modificar_codigo"),o&&(o.style.display="block"),i)&&(i.style.display="none")}async function guardarCodigoModificado(){var o,i,c;xthisCodigoUnico&&((o=(xthisCodigoUnico.codigoModificar||"").trim())?o===xthisCodigoUnico.codigoUnico?(showToastSwal("info","El código no ha cambiado"),cancelarModificacion()):(xPopupLoad.xopen(),c=new httpFecht,i={idporcion:xthisCodigoUnico.idporcion,codigo_anterior:xthisCodigoUnico.codigoUnico,codigo_nuevo:o},c=await c.postJson("../../bdphp/log_009.php?op=130",i),xPopupLoad.xclose(),c.success?(showToastSwal("success","Código modificado correctamente"),xthisCodigoUnico.codigoUnico=o,xthisCodigoUnico.codigoModificar="",cancelarModificacion(),xthisCodigoUnico.fire("codigo-modificado",{codigo:o})):showToastSwal("error",c.message||"Error al modificar el código")):showToastSwal("error","El código no puede estar vacío"))}Polymer({is:"x-porcion-codigo-unico",properties:{idporcion:{type:Number,notify:!0},porcionNombre:{type:String,value:""},codigoUnico:{type:String,value:""},codigoSugerido:{type:String,value:""},codigoModificar:{type:String,value:""},codigoVincular:{type:String,value:""},sugerenciasCodigos:{type:Array,value:function(){return[]}}},attached:function(){xthisCodigoUnico=this},open:function(){dialog_codigo_unico.open(),cargarCodigo(),this.codigoUnico||this.generarCodigoSugerido()},generarCodigoSugerido:async function(){if(this.porcionNombre)try{var o,i=await(new httpFecht).postJson("../../bdphp/log_009.php?op=132",{});i.success&&i.siguiente_numero?(o=generarCodigoUnicoPorcion(this.porcionNombre,i.siguiente_numero),this.codigoSugerido=o):showToastSwal("error","Error al generar código sugerido")}catch(o){showToastSwal("error","Error al generar código sugerido")}}})</script></dom-module>