<dom-module id="x-porcion-detalle"><template><paper-dialog modal id="dialog_modificar_stock_porcion"class="dialog_redondo"modal entry-animation="scale-up-animation"style="max-width:600px"exit-animation="fade-out-animation"with-backdrop><div class="xContent"><h3>Modificar Stock</h3><span class="fw-100 text-secondary fs-11">Todas las modificaciones se registrarán en el historial de cambios.</span><div class="xLinea2"></div><br><div class="d-flexx justify-content-between"><div style="max-width:90px"><p class="fs-12 text-secondary m-0">Stock Actual<p class="fs-15 fw-600">{{objporcion.stock}}</div><div class="w-50"><p class="fs-15 text-dark m-0 fw-600">Cual es el nuevo Stock?</p><input type="number"id="stock_new"placeholder="Ingrese nuevo stock"class="xMiInput xPasarEnter2"onchange="changeStockPorcion(this.value)"onkeyup="changeStockPorcion(this.value)"></div></div><br><p class$="{{classMsjStock}}">{{ msjStock }}</p><br><button class="btn btn-sm btn-primary"onclick="saveStockModifyPorcion()">Listo, guardar</button> <button class="btn btn-sm btn-secondary"dialog-dismiss>Cancelar</button></div></paper-dialog><paper-dialog modal id="dialog_modificar_descripcion_porcion"class="dialog_redondo"modal entry-animation="scale-up-animation"style="min-width:350px"exit-animation="fade-out-animation"with-backdrop><div class="xContent"><h4>Modificar Descripcion</h4><br><input id="txt_descripcion_porcion"placeholder="Descripcion"class="xMiInput"onchange="conMayusculas(this)"espaciar><br><br><br><div class="xBoton2 xAzul"onclick="xSaveModificacionDescripcionPorcion()">Listo, guardar</div><div class="xBoton2 xPlomo"dialog-dismiss>Cancelar</div><br></div></paper-dialog><div><div class="d-flexx justify-content-between align-items-center"><div class="d-flexx"><div class="mr-5"><p class="fs-12 text-secondary m-0">Descripcion<p class="fs-18 fw-600">{{objporcion.porcion}} <i class="fa fa-pencil ml-1 text-primary xCursor"onclick="xModificarDescripcionPorcionDetalle()"></i></div><div><p class="fs-12 fw-600 text-secondary m-0">Stock Actual<p class="fs-18 fw-600 xCursor"onclick="dialog_modificar_stock_porcion.open()">{{objporcion.stock}}</div></div><div class="text-right d-flexx"><button class="btn btn-sm btn-primary ml-1"onclick="dialog_modificar_stock_porcion.open()">Modificar Stock</button> <button hidden$="[[!btnPorcionPe]]"class="btn btn-sm btn-danger ml-1"onclick="xEliminarPorcionDetalle()"><i class="fa fa-trash mr-1"></i> Eliminar</button></div></div><div><br><br><p class="fs-18 text-secondary">Historial de cambios<hr><table class="w-100"><thead><th>Fecha<th>Hora<th>Usuario<th>Movimiento<th class="text-center">Cantidad<tbody><template is="dom-repeat"items="{{listPorcionHistorial}}"as="item"><tr><td>{{item.fecha}}<td>{{item.hora}}<td>{{item.nombres}}<td class$="[[ item.classMovimiento ]]">{{item.tipo_movimiento}}<td class="fw-600 text-center">{{item.cantidad}}</template></table></div></div></template></dom-module><script>var xthisPorcionDetalle;let _difStockPorcion=0,_msjModificarStock="",_stockNowPorcion=0,cantidadRecetasEnlazadasPorcion=0;async function xLoadDataPorcionDetalle(){xthisPorcionDetalle.btnPorcionPe=-1<xm_log_get("app3_us").per.indexOf("e6"),xPopupLoad.xopen();var o={idporcion:xthisPorcionDetalle.objporcion.idporcion},i=new httpFecht,c=await i.postJson("../../bdphp/log_009.php?op=101",o),c=(c.success&&(xthisPorcionDetalle.listPorcionHistorial=c.datos,xthisPorcionDetalle.listPorcionHistorial.map(o=>(o.classMovimiento="Venta"==o.tipo_movimiento?"fw-600 text-success":"Aumenta"==o.tipo_movimiento?"fw-600 text-primary":"fw-600 text-danger",o.tipo_movimiento=o.tipo_movimiento.toUpperCase(),o))),xPopupLoad.xclose(),await i.postJson("../../bdphp/log_009.php?op=116",o));c.success&&(cantidadRecetasEnlazadasPorcion=c.datos[0].cantidad)}function changeStockPorcion(o){var i=parseFloat(xthisPorcionDetalle.objporcion.stock);_stockNowPorcion=parseFloat(o),isNaN(_stockNowPorcion)?_msjModificarStock="":_stockNowPorcion>i?(_difStockPorcion=_stockNowPorcion-i,_msjModificarStock="Aumenta Stock en: "+_difStockPorcion,xthisPorcionDetalle.classMsjStock="fw-600 text-primary"):(_difStockPorcion=i-_stockNowPorcion,_msjModificarStock="Disminuye Stock en: "+_difStockPorcion,xthisPorcionDetalle.classMsjStock="fw-600 text-danger"),xthisPorcionDetalle.msjStock=_msjModificarStock}async function saveStockModifyPorcion(){var o;xPopupLoad.xopen(),0!==_difStockPorcion&&(o={idporcion:xthisPorcionDetalle.objporcion.idporcion,movimiento:_msjModificarStock.split(" ")[0],cantidad:_difStockPorcion,stock_actual:_stockNowPorcion},(await(new httpFecht).postJson("../../bdphp/log_009.php?op=10",o)).success&&(dialog_modificar_stock_porcion.close(),xthisPorcionDetalle.objporcion.stock=_stockNowPorcion,xthisPorcionDetalle.objporcion=JSON.parse(JSON.stringify(xthisPorcionDetalle.objporcion)),xLoadDataPorcionDetalle()),xPopupLoad.xclose())}function xModificarDescripcionPorcionDetalle(){txt_descripcion_porcion.value=xthisPorcionDetalle.objporcion.porcion,dialog_modificar_descripcion_porcion.open()}async function xSaveModificacionDescripcionPorcion(){var o;2<txt_descripcion_porcion.value.length&&(o={descripcion:txt_descripcion_porcion.value,idporcion:xthisPorcionDetalle.objporcion.idporcion},(await(new httpFecht).postJson("../../bdphp/log_009.php?op=115",o)).success)&&(dialog_modificar_descripcion_porcion.close(),xthisPorcionDetalle.objporcion.porcion=txt_descripcion_porcion.value,xthisPorcionDetalle.objporcion=JSON.parse(JSON.stringify(xthisPorcionDetalle.objporcion)))}async function xEliminarPorcionDetalle(){var o=paramsSwalAlert,i=0<cantidadRecetasEnlazadasPorcion?`<span class="text-warning"> Tenga en cuenta que afectara a ${cantidadRecetasEnlazadasPorcion} recetas enlazadas.</span>`:"";o.title='<p class="fw-600 fs-20">Borrar Porción</p>',o.html=`<div class="pb-2" style="display: inline-flex;">                    
                                    <p class="fs-15">Esta seguro de borrar la porción: <strong>${xthisPorcionDetalle.objporcion.porcion}</strong>. ${i}</p>
                                </div>`,o.confirmButtonText="Si, borrar",o.showCancelButton=!0,await showAlertSwalHtmlDecision(o,1).then(async o=>{o.isConfirmed&&(o={idporcion:xthisPorcionDetalle.objporcion.idporcion},(await(new httpFecht).postJson("../../bdphp/log_009.php?op=117",o)).success)&&(goMainPorcion(),xLoadPorciones())})}Polymer({is:"x-porcion-detalle",properties:{objporcion:{type:Object,notify:!0,reflectToAttribute:!0,observer:"porcionChanged"},msjStock:String,classMsjStock:String,listPorcionHistorial:[],btnPorcionPe:Boolean},porcionChanged:o=>{xLoadDataPorcionDetalle()},attached:function(){this.btnPorcionPe=!1,xthisPorcionDetalle=this}})</script>