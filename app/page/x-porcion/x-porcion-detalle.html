<dom-module id="x-porcion-detalle">
<template>
<paper-dialog modal id="dialog_modificar_stock_porcion" class="dialog_redondo" modal entry-animation="scale-up-animation" style="max-width:600px" exit-animation="fade-out-animation" with-backdrop>
<div class="xContent">
<h3>Modificar Stock</h3>
<span class="fw-100 text-secondary fs-11">Todas las modificaciones se registrarán en el historial de cambios.</span>
<div class="xLinea2"></div><br>
<div class="d-flexx justify-content-between">
<div style="max-width:90px">
<p class="fs-12 text-secondary m-0">Stock Actual</p>
<p class="fs-15 fw-600"> {{objporcion.stock}} </p>
</div>
<div class="w-50">
<p class="fs-15 text-dark m-0 fw-600">Cual es el nuevo Stock?</p>
<input type="number" id="stock_new" placeholder="Ingrese nuevo stock" class="xMiInput xPasarEnter2" onchange="changeStockPorcion(this.value)" onkeyup="changeStockPorcion(this.value)">
</div>
</div>
<br>
<p class$="{{classMsjStock}}">{{ msjStock }}</p>
<br>
<button class="btn btn-sm btn-primary" onclick="saveStockModifyPorcion()">Listo, guardar</button>
<button class="btn btn-sm btn-secondary" dialog-dismiss>Cancelar</button>
</div>
</paper-dialog>
<paper-dialog modal id="dialog_modificar_descripcion_porcion" class="dialog_redondo" modal entry-animation="scale-up-animation" style="min-width:350px" exit-animation="fade-out-animation" with-backdrop>
<div class="xContent">
<h4>Modificar Descripcion</h4>
<br>
<input type="text" id="txt_descripcion_porcion" placeholder="Descripcion" class="xMiInput" onChange="conMayusculas(this)" espaciar><br>
<br><br>
<div class="xBoton2 xAzul" onclick="xSaveModificacionDescripcionPorcion()">Listo, guardar</div>
<div class="xBoton2 xPlomo" dialog-dismiss>Cancelar</div>
<br>
</div>
</paper-dialog>
<div>
<div class="d-flexx justify-content-between align-items-center">
<div class="d-flexx">
<div class="mr-5">
<p class="fs-12 text-secondary m-0">Descripcion</p>
<p class="fs-18 fw-600"> {{objporcion.porcion}}
<i class="fa fa-pencil ml-1 text-primary xCursor" onclick="xModificarDescripcionPorcionDetalle()"></i>
</p>
</div>
<div>
<p class="fs-12 fw-600 text-secondary m-0">Stock Actual</p>
<p class="fs-18 fw-600 xCursor" onclick="dialog_modificar_stock_porcion.open()"> {{objporcion.stock}} </p>
</div>
</div>
<div class="text-right d-flexx">
<button class="btn btn-sm btn-primary ml-1" onclick="dialog_modificar_stock_porcion.open()">Modificar Stock</button>
<button hidden$=[[!btnPorcionPe]] class="btn btn-sm btn-danger ml-1" onclick="xEliminarPorcionDetalle()"><i class="fa fa-trash mr-1"></i> Eliminar</button>
</div>
</div>
<div>
<br><br>
<p class="fs-18 text-secondary">Historial de cambios</p>
<hr>
<table class="w-100">
<thead>
<th>Fecha</th>
<th>Hora</th>
<th>Usuario</th>
<th>Movimiento</th>
<th class="text-center">Cantidad</th>
</thead>
<tbody>
<template is="dom-repeat" items="{{listPorcionHistorial}}" as="item">
<tr>
<td>{{item.fecha}}</td>
<td>{{item.hora}}</td>
<td>{{item.nombres}}</td>
<td class$="[[ item.classMovimiento ]]">{{item.tipo_movimiento}}</td>
<td class="fw-600 text-center">{{item.cantidad}}</td>
</tr>
</template>
</tbody>
</table>
</div>
</div>
</template>
</dom-module>
<script>/*<![CDATA[*/var xthisPorcionDetalle;let _difStockPorcion=0
let _msjModificarStock=''
let _stockNowPorcion=0;let cantidadRecetasEnlazadasPorcion=0
async function xLoadDataPorcionDetalle(){xthisPorcionDetalle.btnPorcionPe=xm_log_get('app3_us').per.indexOf('e6')>-1;xPopupLoad.xopen();const _data={idporcion:xthisPorcionDetalle.objporcion.idporcion}
const _httpFecht=new httpFecht();const rpt=await _httpFecht.postJson('../../bdphp/log_009.php?op=101',_data)
if(rpt.success){xthisPorcionDetalle.listPorcionHistorial=rpt.datos;xthisPorcionDetalle.listPorcionHistorial.map(x=>{x.classMovimiento=x.tipo_movimiento=='Venta'?'fw-600 text-success':x.tipo_movimiento=='Aumenta'?'fw-600 text-primary':'fw-600 text-danger';x.tipo_movimiento=x.tipo_movimiento.toUpperCase();return x;})}
xPopupLoad.xclose();const rptCantidadReceta=await _httpFecht.postJson('../../bdphp/log_009.php?op=116',_data)
if(rptCantidadReceta.success){cantidadRecetasEnlazadasPorcion=rptCantidadReceta.datos[0].cantidad}}
function changeStockPorcion(value){const _stockActualPorcion=parseFloat(xthisPorcionDetalle.objporcion.stock)
_stockNowPorcion=parseFloat(value)
if(isNaN(_stockNowPorcion)){_msjModificarStock=''}
else{if(_stockNowPorcion>_stockActualPorcion){_difStockPorcion=_stockNowPorcion-_stockActualPorcion;_msjModificarStock='Aumenta Stock en: '+_difStockPorcion;xthisPorcionDetalle.classMsjStock='fw-600 text-primary'}else{_difStockPorcion=_stockActualPorcion-_stockNowPorcion;_msjModificarStock='Disminuye Stock en: '+_difStockPorcion;xthisPorcionDetalle.classMsjStock='fw-600 text-danger'}}
xthisPorcionDetalle.msjStock=_msjModificarStock}
async function saveStockModifyPorcion(){xPopupLoad.xopen();if(_difStockPorcion===0){return;}
const _data={idporcion:xthisPorcionDetalle.objporcion.idporcion,movimiento:_msjModificarStock.split(' ')[0],cantidad:_difStockPorcion,stock_actual:_stockNowPorcion}
const _httpFecht=new httpFecht();const rpt=await _httpFecht.postJson('../../bdphp/log_009.php?op=10',_data)
if(rpt.success){dialog_modificar_stock_porcion.close();xthisPorcionDetalle.objporcion.stock=_stockNowPorcion;xthisPorcionDetalle.objporcion=JSON.parse(JSON.stringify(xthisPorcionDetalle.objporcion))
xLoadDataPorcionDetalle();}
xPopupLoad.xclose();}
function xModificarDescripcionPorcionDetalle(){txt_descripcion_porcion.value=xthisPorcionDetalle.objporcion.porcion;dialog_modificar_descripcion_porcion.open();}
async function xSaveModificacionDescripcionPorcion(){if(txt_descripcion_porcion.value.length>2){const _data={descripcion:txt_descripcion_porcion.value,idporcion:xthisPorcionDetalle.objporcion.idporcion}
const _httpFecht=new httpFecht();const rpt=await _httpFecht.postJson('../../bdphp/log_009.php?op=115',_data)
if(rpt.success){dialog_modificar_descripcion_porcion.close();xthisPorcionDetalle.objporcion.porcion=txt_descripcion_porcion.value;xthisPorcionDetalle.objporcion=JSON.parse(JSON.stringify(xthisPorcionDetalle.objporcion))}}}
async function xEliminarPorcionDetalle(){const _swalAlertValues=paramsSwalAlert;const _cantRelacionado=cantidadRecetasEnlazadasPorcion>0?`<span class="text-warning">Tenga en cuenta que afectara a ${cantidadRecetasEnlazadasPorcion}recetas enlazadas.</span>`:''
_swalAlertValues.title='<p class="fw-600 fs-20">Borrar Porción</p>';_swalAlertValues.html=`<div class="pb-2"style="display: inline-flex;"><p class="fs-15">Esta seguro de borrar la porción:<strong>${xthisPorcionDetalle.objporcion.porcion}</strong>.${_cantRelacionado}</p></div>`;_swalAlertValues.confirmButtonText='Si, borrar';_swalAlertValues.showCancelButton=true;await showAlertSwalHtmlDecision(_swalAlertValues,1).then(async res=>{if(res.isConfirmed){const _data={idporcion:xthisPorcionDetalle.objporcion.idporcion}
const _httpFecht=new httpFecht();const rpt=await _httpFecht.postJson('../../bdphp/log_009.php?op=117',_data)
if(rpt.success){goMainPorcion();xLoadPorciones();}}})}
Polymer({is:'x-porcion-detalle',properties:{objporcion:{type:Object,notify:true,reflectToAttribute:true,observer:'porcionChanged',},msjStock:String,classMsjStock:String,listPorcionHistorial:[],btnPorcionPe:Boolean},porcionChanged:(obj)=>{xLoadDataPorcionDetalle()},attached:function(){this.btnPorcionPe=false;xthisPorcionDetalle=this;}})/*]]>*/</script>