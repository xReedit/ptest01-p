<dom-module id="x-porcion-detalle"><template><script src="../../../js/mi.sweet.alert.js"></script><script src="../../../js/porcion.utils.js"></script><link rel="import"href="x-porcion-codigo-unico.html"><x-porcion-codigo-unico id="comp_codigo_unico"idporcion="{{objporcion.idporcion}}"porcion-nombre="{{objporcion.porcion}}"codigo-sugerido="{{codigoSugerido}}"on-codigo-generado="onCodigoGenerado"on-codigo-vinculado="onCodigoVinculado"on-codigo-modificado="onCodigoModificado"></x-porcion-codigo-unico><paper-dialog modal id="dialog_modificar_stock_porcion"class="dialog_redondo"modal entry-animation="scale-up-animation"style="max-width:600px"exit-animation="fade-out-animation"with-backdrop><div class="xContent"><h3>Modificar Stock</h3><span class="fw-100 text-secondary fs-11">Todas las modificaciones se registrarán en el historial de cambios.</span><div class="xLinea2"></div><br><template is="dom-if"if="[[conversionActiva]]"><div class="d-flexx align-items-center mb-3"style="gap:10px"><label class="fs-12 text-secondary m-0">Unidad:</label> <select id="select_unidad_stock"class="selected-template-1"style="width:auto"onchange="toggleUnidadStock()"><option value="base">{{objporcion.porcion}}<option value="alternativa">[[conversionActiva.nombre_unidad_alternativa]]</select></div></template><div class="d-flexx justify-content-between"><div style="max-width:90px"><p class="fs-12 text-secondary m-0">Stock Actual<p class="fs-15 fw-600"id="stock_actual_display">{{objporcion.stock}}</div><div class="w-50"><p class="fs-15 text-dark m-0 fw-600">Cual es el nuevo Stock?</p><input type="number"id="stock_new"placeholder="Ingrese nuevo stock"class="xMiInput xPasarEnter2"onchange="changeStockPorcion(this.value)"onkeyup="changeStockPorcion(this.value)"step="0.01"></div></div><br><p class$="{{classMsjStock}}">{{ msjStock }}</p><br><button class="btn btn-sm btn-primary"onclick="saveStockModifyPorcion()">Listo, guardar</button> <button class="btn btn-sm btn-secondary"dialog-dismiss>Cancelar</button></div></paper-dialog><paper-dialog modal id="dialog_modificar_descripcion_porcion"class="dialog_redondo"modal entry-animation="scale-up-animation"style="min-width:350px"exit-animation="fade-out-animation"with-backdrop><div class="xContent"><h4>Modificar Descripcion</h4><br><input id="txt_descripcion_porcion"placeholder="Descripcion"class="xMiInput"onchange="conMayusculas(this)"espaciar><br><br><br><div class="xBoton2 xAzul"onclick="xSaveModificacionDescripcionPorcion()">Listo, guardar</div><div class="xBoton2 xPlomo"dialog-dismiss>Cancelar</div><br></div></paper-dialog><div><div class="d-flexx justify-content-between align-items-start"><div class="d-flexx"><div class="mr-5"><p class="fs-18 fw-600">{{objporcion.porcion}} <i class="fa fa-pencil ml-1 text-primary xCursor"onclick="xModificarDescripcionPorcionDetalle()"></i><div class="mt-2 xCursor"><table><tr onclick="dialog_modificar_stock_porcion.open()"><td align="left"class="pl-0">STOCK ACTUAL<td><p class="fs-15 fw-600 pl-2 pr-2">{{objporcion.stock}}</tr><template is="dom-if"if="[[conversionActiva]]"><tr onclick="dialog_modificar_stock_porcion.open()"><td align="left"class="pl-0">[[conversionActiva.nombre_unidad_alternativa]]<td><p class="fs-15 fw-600 pl-2 pr-2">{{stockConvertido}}</template><tr onclick="verRecetasEnlazadas()"><td align="left"class="pl-0">RECETAS ENLAZADAS<td><p class="fs-15 fw-600 pl-2 pr-2">{{listRecetasEnlazadas.length}}<tr onclick="abrirDialogCodigoUnico()"><td align="left"class="pl-0">CÓDIGO ÚNICO<td><template is="dom-if"if="[[codigoUnico]]"><p class="fs-13 fw-600 pl-2 pr-2 text-success">[[codigoUnico]]</template><template is="dom-if"if="[[!codigoUnico]]"><template is="dom-if"if="[[codigoSugerido]]"><p class="fs-12 pl-2 pr-2 text-warning">[[codigoSugerido]]</template><p class="fs-12 pl-2 pr-2 text-danger">Sin código</template></table></div></div></div><div class="text-right d-flexx"><button class="btn btn-sm btn-primary ml-1"onclick="dialog_modificar_stock_porcion.open()">Modificar Stock</button> <button class="btn btn-sm btn-secondary ml-1"onclick="toggleConfigConversion()"><i class="fa fa-cog mr-1"></i> Conversión</button> <button hidden$="[[!btnPorcionPe]]"class="btn btn-sm btn-danger ml-1"onclick="xEliminarPorcionDetalle()"><i class="fa fa-trash mr-1"></i> Eliminar</button></div></div><div id="config_conversion"style="display:none;margin-top:20px;padding:15px;background:rgb(240 247 255);border-radius:8px"><h4 class="fs-16 fw-600 mb-3">Configurar Conversión de Unidades</h4><div class="d-flexx align-items-end"style="gap:15px"><div style="flex:1"><label class="fs-12 text-secondary">Nombre de unidad alternativa</label> <input id="input_nombre_unidad"class="xMiInput"placeholder="Ej: POLLO ENTERO"value="{{nombreUnidadAlternativa::input}}"></div><div style="width:150px"><label class="fs-12 text-secondary">Factor de conversión</label> <input type="number"id="input_factor_conversion"class="xMiInput"placeholder="Ej: 8"step="0.01"min="0.01"value="{{factorConversion::input}}"></div><button class="btn btn-success btn-sm"onclick="guardarConversion()"><i class="fa fa-save mr-1"></i> Guardar</button><template is="dom-if"if="[[conversionActiva]]"><button class="btn btn-danger btn-sm"onclick="eliminarConversion()"><i class="fa fa-trash mr-1"></i> Eliminar</button></template></div><p class="fs-11 text-secondary mt-2 mb-0"><i class="fa fa-info-circle"></i> El factor indica cuántas unidades base equivalen a 1 unidad alternativa. Ejemplo: Si 8 octavos = 1 pollo, el factor es 8.</div><div><br><br><div class="d-flexx justify-content-between align-items-end"><div><p class="fs-18 text-secondary m-0">Historial de cambios<p class="fs-11 text-secondary m-0">{{historialResumenTexto}}</div><div class="d-flexx align-items-center"><div class="mr-2"><input class="selected-template-1"placeholder="Buscar (usuario / movimiento)"value="{{historialFiltroTexto::input}}"></div><div class="mr-2"><select class="selected-template-1"value="{{historialFiltroTipo::change}}"><option value="">TODOS<option value="VENTA">VENTA<option value="VENTA DEVOLUCION">VENTA DEVOLUCION<option value="AUMENTA">AUMENTA<option value="DISMINUYE">DISMINUYE<option value="RECUPERACIÓN">RECUPERACIÓN</select></div><button class="btn btn-sm btn-secondary"onclick="limpiarFiltrosHistorial()">Limpiar</button></div></div><hr><div class="d-flexx"style="gap:10px;flex-wrap:wrap"><div class="xBoton_flat_2"style="padding:8px 10px;border-radius:8px"><p class="fs-11 text-secondary m-0">Movimientos<p class="fs-15 fw-600 m-0">{{historialTotalMov}}</div><div class="xBoton_flat_2"style="padding:8px 10px;border-radius:8px"><p class="fs-11 text-secondary m-0">Cant. vendida<p class="fs-15 fw-600 m-0">{{historialTotalVentas}}</div><div class="xBoton_flat_2"style="padding:8px 10px;border-radius:8px"><p class="fs-11 text-secondary m-0">Cant. devuelta<p class="fs-15 fw-600 m-0">{{historialTotalDevoluciones}}</div><div class="xBoton_flat_2"style="padding:8px 10px;border-radius:8px"><p class="fs-11 text-secondary m-0">Neto (ventas + devol.)<p class="fs-15 fw-600 m-0">{{historialNeto}}</div><div class="xBoton_flat_2"style="padding:8px 10px;border-radius:8px"><p class="fs-11 text-secondary m-0">Último movimiento<p class="fs-12 fw-600 m-0">{{historialUltimo}}</div></div><br><table class="w-100"><thead><th style="position:sticky;top:0;background:#fff;z-index:1">Fecha<th style="position:sticky;top:0;background:#fff;z-index:1">Hora<th style="position:sticky;top:0;background:#fff;z-index:1">Usuario<th style="position:sticky;top:0;background:#fff;z-index:1">Movimiento<th class="text-right"style="position:sticky;top:0;background:#fff;z-index:1">Cantidad<th class="text-right"style="position:sticky;top:0;background:#fff;z-index:1">Stock Total<tbody><template is="dom-repeat"items="{{listPorcionHistorialView}}"as="item"><template is="dom-if"if="[[item.isGroup]]"><tr style="background:#f8fafc"><td colspan="6"style="padding:10px 8px;border-top:1px solid #e5e7eb;border-bottom:1px solid #e5e7eb"><div class="d-flexx justify-content-between align-items-center"><div class="d-flexx align-items-center"style="gap:10px"><button class="btn btn-sm btn-secondary"data-fecha$="[[item.fecha]]"onclick='toggleGrupoHistorial(this.getAttribute("data-fecha"))'>[[item.icono]]</button><div><p class="m-0 fw-600">[[item.fecha]]<div class="d-flexx"style="gap:6px;flex-wrap:wrap;margin-top:4px"><span style="display:inline-block;padding:2px 8px;border-radius:10px;background:#eef2ff"class="fs-11">Inicio: [[item.stockInicio]]</span> <span style="display:inline-block;padding:2px 8px;border-radius:10px;background:#ecfeff"class="fs-11 text-primary">Aumenta +[[item.aumenta]]</span> <span style="display:inline-block;padding:2px 8px;border-radius:10px;background:#fef2f2"class="fs-11 text-danger">Venta -[[item.disminuye]]</span> <span style="display:inline-block;padding:2px 8px;border-radius:10px;background:#f3f4f6"class="fs-11">Fin: [[item.stockFinal]]</span> <span style="display:inline-block;padding:2px 8px;border-radius:10px;background:#f0fdf4"class="fs-11 text-success">Cant. Ventas: [[item.ventas]]</span> <span style="display:inline-block;padding:2px 8px;border-radius:10px;background:#fff7ed"class="fs-11 text-warning">Cant. Devol.: [[item.devoluciones]]</span></div></div></div><div class="fs-12 text-secondary">[[item.total]] movimientos</div></div></template><template is="dom-if"if="[[!item.isGroup]]"><tr><td>{{item.fecha}}<td>{{item.hora}}<td>{{item.nombres}}<td class$="[[ item.classMovimiento ]]"><span style="display:inline-block;padding:2px 8px;border-radius:10px;background:#f3f4f6"class$="[[ item.classMovimiento ]]">{{item.tipo_movimiento}}</span><td class$="fw-600 text-right [[ item.classCantidad ]]"style="font-variant-numeric:tabular-nums">{{item.cantidad}}<td class="fw-600 text-right"style="font-variant-numeric:tabular-nums">{{item.stock_total}}</template></template></table></div></div></template></dom-module><script>var xthisPorcionDetalle;let _difStockPorcion=0,_msjModificarStock="",_stockNowPorcion=0,cantidadRecetasEnlazadasPorcion=0;async function xLoadDataPorcionDetalle(){xthisPorcionDetalle.btnPorcionPe=-1<xm_log_get("app3_us").per.indexOf("e6"),xPopupLoad.xopen();var o={idporcion:xthisPorcionDetalle.objporcion.idporcion},i=new httpFecht,t=await i.postJson("../../bdphp/log_009.php?op=101",o),t=(t.success&&cocinarArrayHistorial(t.datos),xPopupLoad.xclose(),await i.postJson("../../bdphp/log_009.php?op=11601",o));t.success&&(cantidadRecetasEnlazadasPorcion=t.datos.length,xthisPorcionDetalle.listRecetasEnlazadas=t.datos),await cargarConversionActiva(),await cargarCodigoUnico()}function cocinarArrayHistorial(o){o=o.map(o=>{let i="";return"Venta"===o.tipo_movimiento||"Disminuye"===o.tipo_movimiento?i="-":"Aumenta"!==o.tipo_movimiento&&"Recuperación"!==o.tipo_movimiento||(i="+"),{...o,cantidadOriginal:o.cantidad,cantidad:i+o.cantidad,classCantidad:"-"===i?"text-danger":"+"===i?"text-primary":"",classMovimiento:"Venta"===o.tipo_movimiento?"fw-600 text-success":"Aumenta"===o.tipo_movimiento?"fw-600 text-primary":"Recuperación"===o.tipo_movimiento?"fw-600 text-warning":"fw-600 text-danger",tipo_movimiento:o.tipo_movimiento.toUpperCase()}});calcularResumenHistorial(xthisPorcionDetalle.listPorcionHistorial=o),aplicarFiltrosHistorial()}function calcularResumenHistorial(o){var i=(o||[]).length;let t=0,a=0,e=0;(o||[]).forEach(o=>{var i=(o.tipo_movimiento||"").toUpperCase(),o=parseFloat((o.cantidad||"0").toString().replace(",","."));isNaN(o)||("VENTA"===i&&(t+=Math.abs(o),e+=o),"VENTA DEVOLUCION"===i&&(a+=Math.abs(o),e+=o))});o=o&&0<o.length?o[0]:null,xthisPorcionDetalle.historialTotalMov=i,xthisPorcionDetalle.historialTotalVentas=isNaN(t)?"0":t.toString(),xthisPorcionDetalle.historialTotalDevoluciones=isNaN(a)?"0":a.toString(),xthisPorcionDetalle.historialNeto=isNaN(e)?"0":e.toString(),xthisPorcionDetalle.historialUltimo=o?`${o.fecha} ${o.hora} - ${o.nombres} - `+o.tipo_movimiento:"",o=(xthisPorcionDetalle.listPorcionHistorialFiltered||[]).length;xthisPorcionDetalle.historialResumenTexto=i?`Mostrando ${o} de `+i:""}function aplicarFiltrosHistorial(){if(xthisPorcionDetalle){var i=xthisPorcionDetalle.listPorcionHistorial||[];const e=((xthisPorcionDetalle.historialFiltroTexto||"")+"").trim().toUpperCase(),t=((xthisPorcionDetalle.historialFiltroTipo||"")+"").trim().toUpperCase();let o=i;t&&(o=o.filter(o=>((o.tipo_movimiento||"")+"").toUpperCase()===t)),e&&(o=o.filter(o=>{var i=((o.nombres||"")+"").toUpperCase(),t=((o.tipo_movimiento||"")+"").toUpperCase(),a=((o.fecha||"")+"").toUpperCase(),o=((o.hora||"")+"").toUpperCase();return-1<i.indexOf(e)||-1<t.indexOf(e)||-1<a.indexOf(e)||-1<o.indexOf(e)})),xthisPorcionDetalle.listPorcionHistorialFiltered=o,cocinarVistaAgrupadaHistorial(),xthisPorcionDetalle.historialResumenTexto=i.length?`Mostrando ${o.length} de `+i.length:""}}function cocinarVistaAgrupadaHistorial(){if(xthisPorcionDetalle){var o=xthisPorcionDetalle.listPorcionHistorialFiltered||[];xthisPorcionDetalle.historialCollapsed||(xthisPorcionDetalle.historialCollapsed={});const x=[],P={};o.forEach(o=>{var i=o.fecha||"";P[i]||(P[i]=[]),P[i].push(o)});o=Object.keys(P);o.sort((o,i)=>o<i?1:i<o?-1:0),o.forEach(o=>{var i=P[o]||[],t=!!xthisPorcionDetalle.historialCollapsed[o];let a=0,e=0,n=0,r=0,c=0;i.forEach(o=>{var i=((o.tipo_movimiento||"")+"").toUpperCase(),o=("VENTA"===i&&(a+=1),"VENTA DEVOLUCION"===i&&(e+=1),parseFloat((o.cantidad||"0").toString().replace(",",".")));isNaN(o)||(n+=o,"AUMENTA"!==i&&"RECUPERACIÓN"!==i||0<o&&(r+=o),"VENTA"!==i&&"DISMINUYE"!==i)||o<0&&(c+=Math.abs(o))});var l=i[0]||null,s=i.length?i[i.length-1]:null,l=l?parseFloat((l.stock_total||"0").toString().replace(",",".")):NaN,d=s?parseFloat((s.stock_total||"0").toString().replace(",",".")):NaN,s=s?parseFloat((s.cantidad||"0").toString().replace(",",".")):NaN,l=isNaN(l)?"":l.toString(),d=isNaN(d)||isNaN(s)?"":(d-s).toString(),s=t?"+":"-",p=isNaN(r)?"0":r.toString(),h=isNaN(c)?"0":c.toString();x.push({isGroup:!0,fecha:o,total:i.length,stockInicio:d,stockFinal:l,aumenta:p,disminuye:h,ventas:a,devoluciones:e,icono:s}),t||i.forEach(o=>x.push({...o,isGroup:!1}))}),xthisPorcionDetalle.listPorcionHistorialView=x}}function toggleGrupoHistorial(o){xthisPorcionDetalle&&(xthisPorcionDetalle.historialCollapsed||(xthisPorcionDetalle.historialCollapsed={}),xthisPorcionDetalle.historialCollapsed[o]=!xthisPorcionDetalle.historialCollapsed[o],cocinarVistaAgrupadaHistorial())}function limpiarFiltrosHistorial(){xthisPorcionDetalle&&(xthisPorcionDetalle.historialFiltroTexto="",xthisPorcionDetalle.historialFiltroTipo="",aplicarFiltrosHistorial())}function toggleUnidadStock(){var o,i=document.getElementById("select_unidad_stock"),t=document.getElementById("stock_actual_display"),a=document.getElementById("stock_new");i&&t&&xthisPorcionDetalle&&(i=i.value,o=parseFloat(xthisPorcionDetalle.objporcion.stock)||0,"alternativa"===i&&xthisPorcionDetalle.conversionActiva?(i=(o/(parseFloat(xthisPorcionDetalle.conversionActiva.factor_conversion)||1)).toFixed(2),t.textContent=i):t.textContent=o,a&&(a.value=""),xthisPorcionDetalle.msjStock="",xthisPorcionDetalle.classMsjStock="")}function changeStockPorcion(o){var i,t=parseFloat(xthisPorcionDetalle.objporcion.stock),o=parseFloat(o),a=document.getElementById("select_unidad_stock"),a=a&&"alternativa"===a.value;_stockNowPorcion=a&&xthisPorcionDetalle.conversionActiva?o*(parseFloat(xthisPorcionDetalle.conversionActiva.factor_conversion)||1):o,isNaN(_stockNowPorcion)?(_msjModificarStock="",xthisPorcionDetalle.classMsjStock=""):_stockNowPorcion>t?(_difStockPorcion=_stockNowPorcion-t,i=a&&xthisPorcionDetalle.conversionActiva?` (${o} ${xthisPorcionDetalle.conversionActiva.nombre_unidad_alternativa} = ${_difStockPorcion.toFixed(2)} ${xthisPorcionDetalle.objporcion.porcion})`:"",_msjModificarStock="Aumenta Stock en: "+_difStockPorcion.toFixed(2)+i,xthisPorcionDetalle.classMsjStock="fw-600 text-primary"):(_difStockPorcion=t-_stockNowPorcion,i=a&&xthisPorcionDetalle.conversionActiva?` (${o} ${xthisPorcionDetalle.conversionActiva.nombre_unidad_alternativa} = ${_stockNowPorcion.toFixed(2)} ${xthisPorcionDetalle.objporcion.porcion})`:"",_msjModificarStock="Disminuye Stock en: "+_difStockPorcion.toFixed(2)+i,xthisPorcionDetalle.classMsjStock="fw-600 text-danger"),this.stock_total=_stockNowPorcion,xthisPorcionDetalle.msjStock=_msjModificarStock}async function saveStockModifyPorcion(){var o;xPopupLoad.xopen(),0!==_difStockPorcion&&(o={idporcion:xthisPorcionDetalle.objporcion.idporcion,movimiento:_msjModificarStock.split(" ")[0],cantidad:_difStockPorcion,stock_actual:_stockNowPorcion,stock_total:this.stock_total},(await(new httpFecht).postJson("../../bdphp/log_009.php?op=10",o)).success&&(dialog_modificar_stock_porcion.close(),xthisPorcionDetalle.objporcion.stock=_stockNowPorcion,xthisPorcionDetalle.objporcion=JSON.parse(JSON.stringify(xthisPorcionDetalle.objporcion)),xLoadDataPorcionDetalle()),xPopupLoad.xclose())}function xModificarDescripcionPorcionDetalle(){txt_descripcion_porcion.value=xthisPorcionDetalle.objporcion.porcion,dialog_modificar_descripcion_porcion.open()}async function xSaveModificacionDescripcionPorcion(){var o;2<txt_descripcion_porcion.value.length&&(o={descripcion:txt_descripcion_porcion.value,idporcion:xthisPorcionDetalle.objporcion.idporcion},(await(new httpFecht).postJson("../../bdphp/log_009.php?op=115",o)).success)&&(dialog_modificar_descripcion_porcion.close(),xthisPorcionDetalle.objporcion.porcion=txt_descripcion_porcion.value,xthisPorcionDetalle.objporcion=JSON.parse(JSON.stringify(xthisPorcionDetalle.objporcion)))}async function xEliminarPorcionDetalle(){var o=paramsSwalAlert,i=0<cantidadRecetasEnlazadasPorcion?`<span class="text-warning"> Tenga en cuenta que afectara a ${cantidadRecetasEnlazadasPorcion} recetas enlazadas.</span>`:"";o.title='<p class="fw-600 fs-20">Borrar Porción</p>',o.html=`<div class="pb-2" style="display: inline-flex;">                    
                                    <p class="fs-15">Esta seguro de borrar la porción: <strong>${xthisPorcionDetalle.objporcion.porcion}</strong>. ${i}</p>
                                </div>`,o.confirmButtonText="Si, borrar",o.showCancelButton=!0,await showAlertSwalHtmlDecision(o,1).then(async o=>{o.isConfirmed&&(o={idporcion:xthisPorcionDetalle.objporcion.idporcion},(await(new httpFecht).postJson("../../bdphp/log_009.php?op=117",o)).success)&&(goMainPorcion(),xLoadPorciones())})}function verRecetasEnlazadas(){var o=paramsSwalAlert;let i="";xthisPorcionDetalle.listRecetasEnlazadas.forEach(o=>{i+=`<tr>
                                <td align="left">${o.descripcion}</td>
                                <td align="right">${parseFloat(o.cantidad)}</td>
                            </tr>`}),o.title='<p class="fw-600 fs-20">Recetas enlazadas</p>',o.html=`<div class="pb-2" style="display: inline-flex;">                    
                                    <table class="fs-12 w-100">
                                        <thead>
                                            <tr>
                                                <th align="left">Producto</th>
                                                <th align="right">Cantidad</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            ${i}
                                        </tbody>                                                                                
                                    </table>
                                </div>`,o.showCancelButton=!1,showAlertSwalHtmlDecision(o,1)}function toggleConfigConversion(){var o=document.getElementById("config_conversion");"none"===o.style.display?o.style.display="block":o.style.display="none"}async function cargarConversionActiva(){var o,i;xthisPorcionDetalle&&xthisPorcionDetalle.objporcion&&(o=new httpFecht,i={idporcion:xthisPorcionDetalle.objporcion.idporcion},(o=await o.postJson("../../bdphp/log_009.php?op=124",i)).success&&o.datos&&0<o.datos.length?(i=o.datos[0],xthisPorcionDetalle.conversionActiva=i,xthisPorcionDetalle.stockConvertido=calcularStockConvertido(i.stock,i.factor_conversion),xthisPorcionDetalle.nombreUnidadAlternativa=i.nombre_unidad_alternativa,xthisPorcionDetalle.factorConversion=parseFloat(i.factor_conversion)):(xthisPorcionDetalle.conversionActiva=null,xthisPorcionDetalle.stockConvertido="",xthisPorcionDetalle.nombreUnidadAlternativa="",xthisPorcionDetalle.factorConversion=null))}function calcularStockConvertidoLocal(){var o,i;xthisPorcionDetalle&&xthisPorcionDetalle.conversionActiva&&(o=parseFloat(xthisPorcionDetalle.objporcion.stock)||0,i=parseFloat(xthisPorcionDetalle.conversionActiva.factor_conversion)||1,xthisPorcionDetalle.stockConvertido=calcularStockConvertido(o,i))}async function guardarConversion(){var o,i,t;xthisPorcionDetalle&&(o=(xthisPorcionDetalle.nombreUnidadAlternativa||"").trim(),i=parseFloat(xthisPorcionDetalle.factorConversion),o?!i||i<=0?showToastSwal("error","El factor de conversión debe ser mayor a 0"):(xPopupLoad.xopen(),t=new httpFecht,o={idporcion:xthisPorcionDetalle.objporcion.idporcion,nombre_unidad_alternativa:o.toUpperCase(),factor_conversion:i},i=await t.postJson("../../bdphp/log_009.php?op=122",o),xPopupLoad.xclose(),i.success?(showToastSwal("success","Conversión guardada correctamente"),await cargarConversionActiva(),toggleConfigConversion()):(t=i.error||i.details||"Error al guardar la conversión",showToastSwal("error",t))):showToastSwal("error","Debe ingresar el nombre de la unidad alternativa"))}async function eliminarConversion(){var o,i;xthisPorcionDetalle&&xthisPorcionDetalle.conversionActiva&&((i=paramsSwalAlert).title="¿Eliminar conversión?",i.text="¿Está seguro de eliminar esta conversión de unidades?",i.icon="warning",i.showCancelButton=!0,(await showAlertSwalHtmlDecision(i,1)).isConfirmed)&&(xPopupLoad.xopen(),i=new httpFecht,o={idporcion_unidad_conversion:xthisPorcionDetalle.conversionActiva.idporcion_unidad_conversion},i=await i.postJson("../../bdphp/log_009.php?op=123",o),xPopupLoad.xclose(),i.success?(showToastSwal("success","Conversión eliminada correctamente"),xthisPorcionDetalle.conversionActiva=null,xthisPorcionDetalle.stockConvertido="",xthisPorcionDetalle.nombreUnidadAlternativa="",xthisPorcionDetalle.factorConversion=null,toggleConfigConversion()):showToastSwal("error","Error al eliminar la conversión"))}function abrirDialogCodigoUnico(){var o=document.getElementById("comp_codigo_unico");o&&o.open()}async function cargarCodigoUnico(){var o,i;xthisPorcionDetalle&&xthisPorcionDetalle.objporcion&&(i=new httpFecht,o={idporcion:xthisPorcionDetalle.objporcion.idporcion},(i=await i.postJson("../../bdphp/log_009.php?op=126",o)).success&&i.datos&&0<i.datos.length?xthisPorcionDetalle.codigoUnico=i.datos[0].codigo:xthisPorcionDetalle.codigoUnico="")}Polymer({is:"x-porcion-detalle",properties:{objporcion:{type:Object,notify:!0,reflectToAttribute:!0,observer:"porcionChanged"},msjStock:String,stock_total:Number,classMsjStock:String,listPorcionHistorial:[],listPorcionHistorialFiltered:[],listPorcionHistorialView:[],historialFiltroTexto:{type:String,value:"",observer:"historialFiltrosChanged"},historialFiltroTipo:{type:String,value:"",observer:"historialFiltrosChanged"},historialCollapsed:Object,historialTotalMov:Number,historialTotalVentas:Number,historialTotalDevoluciones:Number,historialNeto:String,historialUltimo:String,historialResumenTexto:String,btnPorcionPe:Boolean,listRecetasEnlazadas:[],conversionActiva:Object,stockConvertido:String,nombreUnidadAlternativa:String,factorConversion:Number,codigoUnico:String,codigoSugerido:String,codigoVincular:String},historialFiltrosChanged:()=>{aplicarFiltrosHistorial()},porcionChanged:o=>{xLoadDataPorcionDetalle()},attached:function(){this.btnPorcionPe=!1,xthisPorcionDetalle=this},onCodigoGenerado:function(o){o.detail&&o.detail.codigo&&(this.codigoUnico=o.detail.codigo)},onCodigoVinculado:function(o){o.detail&&o.detail.codigo&&(this.codigoUnico=o.detail.codigo)},onCodigoModificado:function(o){o.detail&&o.detail.codigo&&(this.codigoUnico=o.detail.codigo,this.codigoSugerido="")}})</script>