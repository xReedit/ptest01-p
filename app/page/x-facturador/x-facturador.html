<link rel="import" href="../../x-componentes/x-comp-find-comprobante/x-comp-find-comprobante.html">
<link rel="import" href="../../x-componentes/x-comp-find-item-producto/x-comp-find-item-producto.html">
<dom-module id="x-facturador">
<script src="../../view/xm_all.js"></script>
<template is="dom-bind">
<paper-dialog id="dialog_tipo_pago_cpe_facturador" class="dialog_redondo" modal entry-animation="scale-up-animation">
<div class="text-center">
<p class="fw-600 fs-18">Elige el metodo de pago</p><br>
<x-comp-find-tipo-pago-option class="tpf_option_cpe_fac"></x-comp-find-tipo-pago-option><br>
<button class="xBoton2 xAzul">Listo, registrar</button>
<button class="xBoton2 xPlomo" dialog-dismiss>Cancelar</button>
</div>
</paper-dialog>
<paper-dialog id="dialog_erro_print" modal style="min-width:330px" modal entry-animation="scale-up-animation" exit-animation="fade-out-animation">
<h4>Error en impresora</h4>
<p id="print_error"></p>
<br>
<div class="xBoton2 xVerde" style="margin-left:23px" onclick="xReImprimirFac()">Intentar Nuevamente</div>
<div class="xBoton2 xPlomo" style="margin-left:23px" dialog-dismiss onclick="xNuevoPedidoVR()">No imprimir</div>
<br><br><br>
</paper-dialog>
<br>
<div class="xMiCard xradius" style="width:85%">
<div class="xEncanezadoCard xFondoRowAmarillo2">
<p>Emite comprobantes electronicos personalizados. Es decir el concepto y los montos no tienen que ser previamente registrados. <img ondblclick="xSeeFechaManual()" class="xDerecha" src="../../../images/candado.png" width="16px"></p>
</div>
<div class="xContentCard" style="height:100%">
<p class="bold xColorRow_Plomo">Comprobante</p>
<div class="container-cliente">
<div id="form_pago_cliente_fac">
<div style="width:250px;padding-left:7px">
<x-comp-find-comprobante id="compFindComprobante" onchange="_getComprobante(comprobantes)"></x-comp-find-comprobante>
</div>
<br>
<div class="xInvisible" id="contentClie">
<div style="width:260px">
<div class="w-100 d-flexx">
<div class="pr-2">
<input autofocus type="number" class="xMiInput" placeholder="RUC Cliente" pattern="[0-9]*" required id="txt_ruc" onkeyup="validarDocumentoCliente(this.value,event)" espaciar>
<div class="xInvisible" id="progress_cliente">
<paper-progress indeterminate style="width:100%;float:left;margin-top:-6px"></paper-progress>
</div>
<div>
<span class="xColorRow_Rojo xInvisible" id="txt_msj" style="padding-left:7px;float:left;margin-top:-3px"></span>
</div>
</div>
<paper-icon-button hidden$="[[!isShowSearchSunat]]" icon="icons:refresh" title="Obtner datos actualizados" onclick="validarDocumentoCliente(null,null,true,true)" style="position:relative;right:2px;float:right;background:springgreen;border-radius:5px">
</paper-icon-button>
<button class="btn btn-sm btn-success" onclick="validarDocumentoCliente(null,null,true)">Buscar</button>
</div>
</div>
<div style="padding:0 5px">
<x-comp-find-input-cliente id="clie_nombres_fac" label="Nombres | Razon Social | Buscar" class="xPasarEnter2" espaciar>
</x-comp-find-input-cliente>
</div>
<input type="text" class="xMiInput xPasarEnter2" style="width:98%" placeholder="Direccion" onChange="conMayusculas(this)" onblur="removeSpecialCharObj(this)" required id="txt_direccion" espaciar>
<input type="number" class="xMiInput xPasarEnter2" style="width:200px" placeholder="Telefono" onkeyup="showMsjTelefono(this)" required id="txt_telefono" espaciar>
<p class="fs-11 pl-2 fw-600 text-info" hidden$="[[!isShowMsjTelefono]]">Se enviará el comprobante al WhatsApp.</p>
<p class="fs-11 pl-2 fw-600 text-secondary" hidden$="[[isShowMsjTelefono]]">Para enviar el comprobante al WhatsApp.</p>
<input type="text" class="xMiInput xInvisible" style="width:98%" placeholder="Cliente" onChange="conMayusculas(this)" id="txt_nombres" espaciar required$="[[!modificarCliente]]" readonly$="[[!modificarCliente]]">
</div>
</div>
<br>
</div>
<br>
<hr class="xLinea3">
<br>
<div class="w-100 d-flexx justify-content-end">
<button class="btn btn-sm btn-success" onclick="xAddItem()">+ Agregar</button>
</div>
<table class="xtable4" width="100%">
<thead>
<th class="xSinBorde" width="10px">Cant</th>
<th class="xSinBorde" width="60%">Descripcion</th>
<th class="xSinBorde" width="30px" align="right">P.Unitario</th>
<th class="xSinBorde" width="30px" align="right">P.Total</th>
</thead>
<tr class="xSinBorde" data-id="">
<td><input type="number" pattern="[^0-9]+" class="xMiInput xPasarEnter2" style="width:100%" onkeyup="verificarInputInteger(this)" placeholder="Cant" required id="cant_item" autofocus></td>
<td>
<x-comp-find-item-producto clasecss="xMiInput xPasarEnter2 w-100" elplaceholder="Descripcion" id="compItemProductoFac"></x-comp-find-item-producto>
</td>
<td><input type="number" pattern="[^0-9]+" class="xMiInput xAlinearDerecha punitario" onblur="xRetornaMoneda(this)" placeholder="P. Unitario" id="punitario" name="precio" required></td>
<td><input type="number" class="xMiInput xAlinearDerecha xprecio" onblur="xRetornaMoneda(this)" placeholder="P. Total" id="ptotal" name="total" required readonly></td>
</tr>
<template is="dom-repeat" items="{{arrItems}}" as="item">
<tr data-value="[[index]]">
<td> <span class="xDeleteRowNeutro" title="Borrar" onclick="xBorrarItemLocalArr(this)"></span> {{item.cantidad}} </td>
<td> {{item.descripcion}} </td>
<td align="right"> {{item.punitario}} </td>
<td align="right"> {{item.ptotal}}</td>
</tr>
</template>
<template is="dom-repeat" items="{{arrTotales}}" as="total">
<tr class="tt_row">
<td colspan="2" class="xSinBorde"></td>
<td align="right"> {{ total.descripcion }} </td>
<td align="right"> {{ total.importe }} </td>
</tr>
</template>
</table>
</div>
<div class="xPieCard">
<div class="d-flexx justify-content-between align-items-center">
<div>
<div style="width:200px" hidden$="[[ !isShowCpeFactura ]]">
<br>
<label for="selectFormaPago" class="xColorRow_Plomo"> Forma de Pago: </label>
<select id="selectFormaPago" class="xTextRow2 xCursor">
<option value="0">Contado</option>
<option value="1">Credito</option>
</select>
<div hidden$="[[!isShowFechaPagoCredito]]">
<br>
<label for="fechaPagoCredito" class="xColorRow_Plomo"> Fecha de Pago: </label>
<input type="date" name="fechaPagoCredito" id="fechaPagoCredito" class="xTextRow2 xCursor" onkeydown="return false">
</div>
<br><br><br>
</div>
<div style="width:200px">
<label for="listPrint" class="xColorRow_Plomo"> Impresora: </label>
<select id="listPrint" class="xTextRow2 xCursor" onchange="fact_selectOptionCategoria()">
<template is="dom-repeat" id="listImpresora" items="[[listImpresoras]]" as="impresora">
<option value="[[index]]"> {{ impresora.descripcion }} </option>
</template>
</select>
</div>
</div>
<div>
<div class="xMiBoton_icon_option" selected$="{{ isShowIngresaCaja }}" onclick="selectOptionIngresarCaja()">
<div class="d-flexx mb-2">
<div>
<i hidden$="[[!isShowIngresaCaja]]" class="fa fa-check text-success pl-1"></i>
<i hidden$="[[isShowIngresaCaja]]" class="fa fa-close text-danger pl-2"></i>
</div>
<img src="../../../images/_caja.png" width="32px" class="mb-1">
</div>
<p>Ingresa a Caja</p>
</div>
</div>
</div>
<br>
<button class="xBoton2 xAzul" onclick="xProcesarComprobante()" disabled="[[!formValid]]" hidden="[[cpe_show]]">Listo, emitir comprobante</button>
<button class="xBoton2 xAzul" onclick="xProcesarComprobante()" hidden="[[!cpe_show]]">Volver a imprimir</button>
<button class="xBoton2 xVerde" onclick="xNuevoFac()" hidden="[[!cpe_show]]">Nuevo</button>
<br>
<p hidden$="[[ !isShowMsjBoletaRequireDNI ]]" class="animate__animated animate__flash text-danger fw-600">Si el importe total supera los S/.700.00 es necesario un DNI o RUC</p>
<br><br>
</div>
</div>
<br><br>
</template>
<script rel="prefetch" type="text/javascript" src="../../view/socket.service.p.js"></script>
<script type="text/javascript" src="../../shared/validar.numdoc.js"></script>
<script type="text/javascript" src="../../view/item_pedido_print_comprobante.js"></script>
<script type="text/javascript" src="../../view/deNumALetras.js"></script>
<script type="text/javascript" src="../../view/xJsonSunat.js"></script>
<script type="text/javascript" src="../../view/xSOAPSunat.js"></script>
<script type="text/javascript" src="../../view/item_pedido_estructura.js"></script>
<script type="text/javascript" src="../../view/item_pedido_subtotales.js"></script>
<script type="text/javascript" src="../../view/manager_storage.js"></script>
<script type="text/javascript" src="../../view/cliente.service.js"></script>
<script type="text/javascript" src="../../view/cpe_interno.js"></script>
<style type="text/css">:root{--font-size:12px;--paper-input-container-input:{font-size:var(--font-size)}--paper-input-container-label:{font-size:13px}}.tt_row td{font-weight:600;font-size:15px}</style>
</dom-module>
<script>/*<![CDATA[*/var xThisFacturador,xPopupLoad,_arrCliente=[],_arrTotal=[],_arrItems=[],cnf_ComprobanteSel,xIdCliente_pago,_listValid=false,_formValid=false,_modificarCliente=false;var impresoraSelect={},IdTpConsumo=0,rptDoc,itemsConEstructuraPrint,arr_comprobante=[],_idregistro,txt_fecha_cpe_manual='',isSocket=true,_inputAutocompleteFac,xCartaSubtotales,comprobanteFormaPago,compItemProductoFac,_labelElemetFind='',itemOptionTpSelectedCPE;var processRumComprobanteF=false;function xIniFacturador(){xPopupLoad=document.getElementById('xLoad');xThisFacturador.formValid=false;_listValid=false;_formValid=false;xThisFacturador.modificarCliente=false;xThisFacturador.arrItems=[];xThisFacturador.arrTotales=[];xThisFacturador.listImpresoras=[];xThisFacturador.cpe_show=false;xThisFacturador.fecha_manual=false
comprobanteFormaPago={forma_de_pago:'Contado',fecha_de_pago:''}
const arrEstructura=xm_log_get('estructura_pedido');xCartaSubtotales=xm_log_get('carta_subtotales');IdTpConsumo=arrEstructura[0].idtipo_consumo;fact_getAllImpresoras();$('body').addClass('loaded');$("#Titulo_page").text("Facturador");_inputAutocompleteFac=document.getElementById('clie_nombres_fac');_inputAutocompleteFacObj=_inputAutocompleteFac.$.input_clie_nombres_auto;_inputAutocompleteFac.addEventListener('input-autocomplete-selected',(event)=>{const cliente=event.detail;if(!cliente.nombres){xValidarBtnProcesar();return;}
xIdCliente_pago=cliente.idcliente;$("#txt_ruc").val(cliente.ruc);$("#txt_direccion").val(cliente.direccion);$("#txt_nombres").val(cliente.nombres);$("#txt_telefono").val(cliente.telefono);xThisFacturador.isShowMsjTelefono=cliente.telefono!=='';validarDocumentoCliente(null,null,true,false,false);});compItemProductoFac=document.getElementById('compItemProductoFac');compItemProductoFac.removespecialchart=true;compItemProductoFac.addEventListener('elementSeleted',(e)=>{var elementItemProdcutoSeleted=e.detail;_labelElemetFind=elementItemProdcutoSeleted.label?elementItemProdcutoSeleted.label.split('|')[elementItemProdcutoSeleted.label.split('|').length-1]:e.target.valueInput;elementItemProdcutoSeleted.descripcion=_labelElemetFind.trim();punitario.value=elementItemProdcutoSeleted.precio||0;verificarInputInteger(punitario);xCalcTotal();});$('.xPasarEnter2').on('keyup',function(e){var code=e.which;if(code==13||code==186){var inputs=$('input');var a=inputs.index(document.activeElement);if(inputs[a+1]!==null){var nextBox=inputs[a+1];if(nextBox===undefined){return}
if(nextBox.disabled){nextBox=inputs[a+2]}
if(nextBox==undefined){return;}
nextBox.focus();nextBox.select();}
event.stopPropagation();e.stopPropagation();e.stopImmediatePropagation()
return false;}});$(".punitario").on('keyup',function(e){var code=e.which;xCalcTotal();if(code==13||code==186){$("#punitario").val(xMoneda(this.value));$("#ptotal").focus();}});$(".xprecio").on('keyup',function(e){var code=e.which;if(code==13||code==186){xAddItem();}});$("#txt_fecha").on('change',function(){var d=$(this).val().split('-');txt_fecha_cpe_manual=d[1]===undefined?'':$(this).val();})
$('#selectFormaPago').on('change',(e)=>{xThisFacturador.isShowFechaPagoCredito=e.target.selectedIndex===1;comprobanteFormaPago.forma_de_pago=e.target.options[e.target.selectedIndex].text;if(xThisFacturador.isShowFechaPagoCredito){comprobanteFormaPago.fecha_de_pago=fechaPagoCredito.value;}else{comprobanteFormaPago.fecha_de_pago='';}
if(xThisFacturador.isShowFechaPagoCredito&&comprobanteFormaPago.fecha_de_pago===''){xThisFacturador.formValid=false;}else{xValidarBtnProcesar();}
var today=new Date().toISOString().split('T')[0];document.getElementsByName("fechaPagoCredito")[0].setAttribute('min',today);});$('#fechaPagoCredito').on('change',(evt)=>{comprobanteFormaPago.fecha_de_pago=evt.target.value;if(xThisFacturador.isShowFechaPagoCredito&&comprobanteFormaPago.fecha_de_pago===''){xThisFacturador.formValid=false;}else{xValidarBtnProcesar();}});setTimeout(()=>{xNuevoFac();},500);const _compFindComprobante=document.getElementById('compFindComprobante');_compFindComprobante.addEventListener('_onchange',(e)=>{_getComprobante(e.detail);e.stopPropagation();e.stopImmediatePropagation();})
$(document).on('getValorIncial','.tpf_option_cpe_fac',function(e){itemOptionTpSelectedCPE=e.detail.values;});}
function verificarInputInteger(obj){const _val=parseFloat(obj.value);obj.value=_val>0?_val:_val*-1;}
function removeChartSpecial(obj){obj.value=removeSpecialChar(obj.value);}
function xSeeFechaManual(){xThisFacturador.fecha_manual=!xThisFacturador.fecha_manual;}
function _getComprobante($event){cnf_ComprobanteSel=$event;xNuevoCliente();if(cnf_ComprobanteSel.idtipo_comprobante==='0'){$("#contentClie").addClass('xInvisible');}else{$("#contentClie").removeClass('xInvisible');}
xThisFacturador.modificarCliente=cnf_ComprobanteSel.codsunat==='01'?false:true;xThisFacturador.isShowCpeFactura=cnf_ComprobanteSel.codsunat==='01';}
function validarDocumentoCliente(valor,e,btnBuscar=false,buscarSoloSunat=false,newCliente=true){if(!btnBuscar){if(e.keyCode!==13)return;}
valor=valor?valor:txt_ruc.value;if(newCliente){xNuevoCliente();}
$("#txt_msj").addClass('xInvisible');const tipoDoc=cnf_ComprobanteSel;const rpt=validarNumDoc_ValidarDNIRUC(tipoDoc,valor);if(!rpt.valid){NumDocNoValid(rpt);return;};$("#progress_cliente").removeClass("xInvisible");xGetFindCliente(rpt.numdoc,rpt.servicio,buscarSoloSunat,(new_rpt)=>{if(new_rpt.success){if(new_rpt.nombres===""){rpt.valid=false;rpt.msj="No se encontraron registros. Verifique el numero de documento.";$("#progress_cliente").addClass("xInvisible");NumDocNoValid(rpt);return;}
xThisFacturador.isShowSearchSunat=new_rpt.buscarSunat;rpt.valid=true;rpt.msj="ok";rpt.cliente={idcliente:new_rpt.idcliente,nombres:new_rpt.nombres,direccion:new_rpt.direccion,num_doc:rpt.numdoc,f_nac:new_rpt.f_nac};_arrCliente=rpt.cliente;_formValid=rpt.valid;xThisFacturador.modificarCliente=false;xValidarBtnProcesar();xIdCliente_pago=new_rpt.idcliente;$("#txt_nombres").val(new_rpt.nombres);$("#txt_direccion").val(new_rpt.direccion);$("#txt_telefono").val(new_rpt.telefono);xThisFacturador.isShowMsjTelefono=new_rpt.telefono!=='';_inputAutocompleteFacObj.inputValue=new_rpt.nombres;}else{rpt.valid=false;rpt.msj=new_rpt.msg;xThisFacturador.modificarCliente=true;NumDocNoValid(rpt);xNuevoCliente();}
$("#progress_cliente").addClass("xInvisible");});}
function NumDocNoValid(rpt){_formValid=rpt.valid;xValidarBtnProcesar();$("#txt_msj").text(rpt.msj)
$("#txt_msj").removeClass('xInvisible');$("#txt_ruc").select();$("#txt_ruc").focus();}
function xNuevoCliente(){_formValid=false;xValidarBtnProcesar();xThisFacturador.isShowMsjBoletaRequireDNI=false;xThisFacturador.modificarCliente=true;xIdCliente_pago='';_arrCliente=[];_inputAutocompleteFacObj.inputValue='';$('#txt_nombres').val('');$('#txt_direccion').val('');$('#txt_telefono').val('');xThisFacturador.isShowMsjTelefono=false;$("#txt_ruc").select();$("#txt_ruc").focus();}
function validNomClienteFac(){if(cnf_ComprobanteSel.codsunat==='03'){xThisFacturador.formValid=clie_nombres_fac.$.input_clie_nombres_auto.$.input.value===''||clie_nombres_fac.$.input_clie_nombres_auto.$.input.value.length>4?true:false;}}
function xCalcTotal(){const xCan_item=$("#cant_item").val()===''?0:parseFloat($("#cant_item").val());const xPUnitario=$("#punitario").val()===''?0:parseFloat($("#punitario").val());const ptotal=(xCan_item*xPUnitario).toFixed(2)||0;$("#ptotal").val(ptotal);}
function xAddItem(){const xCan_item=$("#cant_item").val();_labelElemetFind=_labelElemetFind!==''?_labelElemetFind:compItemProductoFac.getTextInput();xDes_item=_labelElemetFind;const xPUnitario=$("#punitario").val();const xPTotal=$("#ptotal").val();if(xCan_item===''||xDes_item===''||xPUnitario===''||xPTotal===''){return}
if(parseFloat(xPUnitario)<=0){return;}
if(parseFloat(xCan_item)<=0){return;}
if(parseFloat(xPTotal)<=0){return;}
const _importeTotal=(xCan_item*xPUnitario).toFixed(2);if(parseFloat(_importeTotal)!==parseFloat(xPTotal)){return;}
const id=Date.now().toString().slice(-6);const item={'id':id,'iditem':id,'idtipo_consumo':IdTpConsumo,'des_seccion':'ITEMS','cantidad':xCan_item,'descripcion':xDes_item,'punitario':xPUnitario,'precio':xPUnitario,'ptotal':xPTotal,'precio_total_calc':xPTotal};_arrItems.push(item);xThisFacturador.arrItems=JSON.parse(JSON.stringify(_arrItems));xCalcularTotal();xNuevoItem();}
function xBorrarItemLocalArr(obj){const i=obj.parentElement.parentElement.dataValue;const itemRemove=_arrItems[i];_arrItems=_arrItems.filter(x=>x.id!==itemRemove.id);xThisFacturador.arrItems=JSON.parse(JSON.stringify(_arrItems));xCalcularTotal();}
function xNuevoItem(){$("#cant_item").val('');$("#des_item").val('');$("#punitario").val('');$("#ptotal").val('');$("#cant_item").focus();compItemProductoFac.resetText();}
function xValidarBtnProcesar(){if(_arrTotal.length>0){if(!cnf_ComprobanteSel){return;}
if(cnf_ComprobanteSel.codsunat==="03"&&_listValid&&parseFloat(_arrTotal[2].importe)<=700){xThisFacturador.formValid=true;xThisFacturador.modificarCliente=true;xThisFacturador.isShowMsjBoletaRequireDNI=false;validNomClienteFac();return;}
if(cnf_ComprobanteSel.codsunat==="03"&&parseFloat(_arrTotal[2].importe)>=700){xThisFacturador.isShowMsjBoletaRequireDNI=true;}
if(cnf_ComprobanteSel.idtipo_comprobante==="1"){xThisFacturador.formValid=true;xThisFacturador.modificarCliente=true;return;}
validNomClienteFac();}
xThisFacturador.formValid=_listValid&&_formValid;}
function xCalcularTotal(){_arrTotal=[];const SumaLista=this._arrItems.map(x=>parseFloat(x.ptotal)).reduce((a,b)=>a+b,0);_listValid=parseInt(SumaLista)===0?false:true;let _importeSubtotal=SumaLista;xCartaSubtotales.map(x=>{if(x.es_impuesto.toString()==='1'){const impuesto=parseFloat(x.monto);let importeCalc='0.00';if(x.activo==='0'){if(x.descripcion==='I.G.V'){_importeSubtotal=parseFloat(xCalcMontoBaseIGV(SumaLista,(impuesto/100)))
importeCalc=(SumaLista-_importeSubtotal).toFixed(2)}}
_arrTotal.push({'descripcion':x.descripcion,'importe':importeCalc});}});_arrTotal.unshift({'descripcion':'Sub Total','importe':xMoneda(_importeSubtotal)});const total=_arrTotal.map(x=>parseFloat(x.importe)).reduce((a,b)=>a+b,0);_arrTotal.push({'descripcion':'Total','importe':xMoneda(total)});xThisFacturador.arrTotales=JSON.parse(JSON.stringify(_arrTotal));xValidarBtnProcesar();}
async function xProcesarComprobante(){if(xThisFacturador.proccessCPEF===true){return}
xThisFacturador.proccessCPEF=true
if(xThisFacturador.cpe_show){await xMandarCocinarImpresionComprobante(arr_comprobante.correlativo,_idregistro);xProcessCpeFinish()
return;}
arr_comprobante=cnf_ComprobanteSel;if(_arrCliente.length===0){var nombres_cliente=$("#txt_nombres").val();const direccion_cliente=$("#txt_direccion").val();_arrCliente={};_arrCliente.idcliente=0;_arrCliente.num_doc='00000000';nombres_cliente=nombres_cliente===''?_inputAutocompleteFacObj.inputValue:nombres_cliente;_arrCliente.nombres=nombres_cliente===''?'PUBLICO EN GENERAL':nombres_cliente;_arrCliente.direccion=direccion_cliente;_arrCliente.telefono=$("#txt_telefono").val();}else{_arrCliente.direccion=$("#txt_direccion").val();_arrCliente.telefono=$("#txt_telefono").val();_arrCliente.idcliente=await ClienteService_Guardar(_arrCliente);}
arr_comprobante.correlativo='#';const arrCpeFac={idcliente:_arrCliente.idcliente,idcomprobante:arr_comprobante.idtipo_comprobante,idtipo_comprobante_serie:arr_comprobante?.idtipo_comprobante_serie||null,num_comprobante:arr_comprobante.correlativo,subtotal:_arrTotal[0].importe,igv:_arrTotal[1].importe,total:_arrTotal[2].importe,concepto:xThisFacturador.arrItems[0].descripcion,idtipo_pago:itemOptionTpSelectedCPE.idtipo_pago,nombres_cliente:nombres_cliente}
if(xThisFacturador.isShowIngresaCaja){const rptIngresaCaja=await xShowIngresoVarios(arrCpeFac);if(!rptIngresaCaja){console.log('nada cancelo');xProcessCpeFinish()
return;}}
xPopupLoad.xopen();if(cnf_ComprobanteSel.idtipo_comprobante==='1'){await xMandarCocinarImpresionComprobante(arr_comprobante.correlativo,null);xProcessCpeFinish()
return;}
$.ajax({type:'POST',url:'../../bdphp/log_002.php',data:{op:'102',data:arrCpeFac,arrItems:_arrItems}}).done(async function(ultimoIdCpeFac){_idregistro=[0,ultimoIdCpeFac];await xMandarCocinarImpresionComprobante(arr_comprobante.correlativo,_idregistro);xProcessCpeFinish()});}
function xProcessCpeFinish(){setTimeout(()=>{xThisFacturador.proccessCPEF=false;},1000);}
async function xMandarCocinarImpresionComprobante(correlativo,_idregistro){if(!xThisFacturador.cpe_show){arr_comprobante.fecha_manual=txt_fecha_cpe_manual;arr_comprobante=cnf_ComprobanteSel;arr_comprobante.correlativo=correlativo;arr_comprobante.forma_de_pago=comprobanteFormaPago;itemsConEstructuraPrint=xCargarDatosAEstructuraImpresion(xThisFacturador.arrItems);itemsConEstructuraPrint=itemsConEstructuraPrint.filter(x=>x);rptDoc=await xCocinarImprimirComprobante(itemsConEstructuraPrint,_arrTotal,arr_comprobante,_arrCliente,_idregistro,-2,false)}
if(rptDoc.ok=false){alert(rptDoc.msj);return;}
if(impresoraSelect.idimpresora===-1){const hash=rptDoc[0]?rptDoc[0].hash:rptDoc.hash;if(hash==='www.papaya.com.pe'){xPopupLoad.xclose();alert('Error con la conexion al servicio de Sunat. No puede descargar el pdf. Pero si puede imprimirlo. Este comprobante sera enviado a sunat al cerrar caja.');return;}
xThisFacturador.cpe_show=true;xSoapSunat_DownloadFile('pdf',rptDoc[0].external_id);xPopupLoad.xclose();return;}else{xThisFacturador.cpe_show=true;xLLamarPrintFac();}}
function xNuevoFac(){xThisFacturador.cpe_show=false;_arrCliente=[];_arrItems=[];_arrTotal=[];xThisFacturador.$.selectFormaPago.selectedIndex=0;xThisFacturador.isShowFechaPagoCredito=false;comprobanteFormaPago={forma_de_pago:'Contado',fecha_de_pago:''}
xThisFacturador.arrItems=JSON.parse(JSON.stringify(_arrItems));xThisFacturador.arrTotales=JSON.parse(JSON.stringify(_arrTotal));xNuevoCliente();txt_ruc.value='';}
function xLLamarPrintFac(){let xSetImpresora=xm_log_get('sede_generales');xSetImpresora[0].ip_print=impresoraSelect.ip;xSetImpresora[0].var_margen_iz=impresoraSelect.var_margen_iz;xSetImpresora[0].var_size_font=impresoraSelect.var_size_font
xSetImpresora[0].local=impresoraSelect.local;xSetImpresora[0].num_copias=impresoraSelect.num_copias;xSetImpresora[0].papel_size=impresoraSelect.papel_size;xImprimirComprobanteAhoraPrintPreSelect(rptDoc,itemsConEstructuraPrint,_arrTotal,arr_comprobante,_arrCliente,xSetImpresora,function(rpt_print){if(rpt_print==false){return false;}
xPopupLoad.titulo="Imprimiendo...";xPopupLoad.xopen();setTimeout(function(){xPopupLoad.xclose()},3000);xPopupLoad.xclose();});}
function xReImprimirFac(){dialog_erro_print.close();xPopupLoad.titulo="Enviando...";xPopupLoad.xopen();xLLamarPrintFac();}
function fact_selectOptionCategoria(){const index=xThisFacturador.$.listPrint.value;impresoraSelect=xThisFacturador.listImpresoras[index];}
function fact_getAllImpresoras(){$.ajax({type:'POST',url:'../../bdphp/log_002.php',data:{op:'5'}}).done(function(dtValues){var _arrPrint=[]
dtValues=$.parseJSON(dtValues);dtValues.datos.map(x=>_arrPrint.push(x));_arrPrint.push({idimpresora:-1,descripcion:'MOSTRAR EN PDF'})
xThisFacturador.listImpresoras=JSON.parse(JSON.stringify(_arrPrint));impresoraSelect=_arrPrint[0];});}
function showMsjTelefono(obj){xThisFacturador.isShowMsjTelefono=obj.value!=='';}
function selectOptionIngresarCaja(){xThisFacturador.isShowIngresaCaja=!xThisFacturador.isShowIngresaCaja;if(xThisFacturador.isShowIngresaCaja){showAlertSwalOk('info','Ingresa a caja','Estas operaciones sumaran a tu caja, en la sección ingresos varios.','Listo')}else{}}
async function xShowIngresoVarios(_arrCpeFac){const _swalAlertValues=paramsSwalAlert;_swalAlertValues.title='<p class="fw-600 fs-18">Elige el metodo de pago</p>';_swalAlertValues.html=`<div class="pb-2"style="display: inline-flex;"><x-comp-find-tipo-pago-option class="tpf_option_cpe_fac"></x-comp-find-tipo-pago-option></div>`;_swalAlertValues.confirmButtonText='Listo, registrar';_swalAlertValues.showCancelButton=true;return await showAlertSwalHtmlDecision(_swalAlertValues,0).then(res=>{if(res.isConfirmed){_arrCpeFac.idtipo_pago=itemOptionTpSelectedCPE.idtipo_pago
$.ajax({type:'POST',url:'../../bdphp/log_002.php',data:{op:'11',data:_arrCpeFac}}).done(res=>{console.log('ok');})}
return res.isConfirmed;})}
function xSaveIngresoVarios(){}
Polymer({is:'x-facturador',properties:{arrItems:[],arrTotales:[],listImpresoras:[],formValid:boolean=false,proccessCPEF:boolean=false,modificarCliente:boolean=false,cpe_show:boolean=false,fecha_manual:boolean=false,isShowSearchSunat:Boolean,isShowFechaPagoCredito:Boolean,isShowCpeFactura:Boolean,isShowMsjTelefono:Boolean,isShowMsjBoletaRequireDNI:Boolean,isShowIngresaCaja:Boolean,subscription$:Object},attached:function(){this.isShowSearchSunat=false;this.isShowFechaPagoCredito=false;this.isShowCpeFactura=false
this.isShowMsjTelefono=false;this.isShowMsjBoletaRequireDNI=false;this.isShowIngresaCaja=false;this.proccessCPEF=false;xThisFacturador=this;xIniFacturador();_cpSocketOpen();this.subscription$=onStatusSetUsChangeSede().subscribe(res=>{if(res==true){xIniFacturador();}});},detached:function(){this.subscription$.unsubscribe();},})/*]]>*/</script>