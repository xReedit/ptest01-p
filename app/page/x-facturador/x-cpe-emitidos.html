<link rel="import" href="../../x-componentes/pagination-input/pagination-input.html">
<link rel="preload" href="../../../images/_msj_envio_sunat.gif" as="image" media="(max-width: 600px)">
<dom-module id="x-cpe-emitidos">
<script type="text/javascript" src="../../view/socket.master.service.js"></script>
<script type="text/javascript" src="../../view/socket.service.p.js"></script>
<script src="../../view/xApiConsultaSunat.js"></script>
<script src="../../view/httpFech.js"></script>
<template is="dom">
<paper-dialog class="dialog_redondo" id="dialog_enviando_sunat" style="width:245px" modal entry-animation="scale-up-animation" exit-animation="fade-out-animation">
<div style="text-align:center">
<img id="dgl_sunat_img" src="../../../images/_msj_envio_sunat.gif" alt="">
<p id="dgl_sunat_msj">Enviando comprobantes electronicos.</p>
<p id="dgl_sunat_msj2" class="dgl_sunat_msj2 xInvisible xColorRow_Azul">Proceso concluido con exito.</p>
<p id="dgl_sunat_msj3" class="dgl_sunat_msj3 center xColorRow_Plomo xfont11">...</p>
<paper-progress id="dgl_sunat_progress" indeterminate style="width:100%"></paper-progress>
<button dialog-dismiss id="dlg_sunat_btn" class="xBoton2 xVerde xInvisible">Listo</button>
</div>
</paper-dialog>
<paper-dialog id="dialog_motivo_anular_comprobante" class="dialog_redondo" style="min-width:320px;max-width:600px" entry-animation="scale-up-animation" exit-animation="fade-out-animation" with-backdrop>
<div class="xContent">
<div class="d-flexx align-items-center">
<h3>ANULAR COMPROBANTE</h3> <span class="ml-2">[[ desDocCpe ]]</span>
</div>
<div class="xLinea2"></div><br>
<p>
<strong>El plazo para comunicar de baja o anular un comprobante de pago electrónico es de [[NumDaysAnularCpe]] días</strong>, contados desde el día que emites el comprobante. Si no cumples ese plazo, tendrás que generar una Nota de Crédito.
</p>
<div hidden$="[[isShoOpNotaCredito]]" class="mt-1">
<p class="fw-600 text-success">El documento esta en el plazo para dar de baja.</p>
</div>
<div hidden$="[[!isShoOpNotaCredito]]" class="mt-1">
<p class="fw-600 text-info">El documento NO cumple con el plazo, debes generar una Nota de Crédito.</p>
</div>
<br>
<h4>Indique el motivo de anulación</h4>
<div>
<input type="text" class="xMiInput" placeholder="Motivo..." id="txt_motivo_anular" autofocus>
</div>
<br><br><br>
<div class="xBoton2 xRojo" dialog-dismiss hidden$="[[isShoOpNotaCredito]]" onclick="xAnularComprobante_confirma()">Listo, dar de baja</div>
<div class="xBoton2 xAzul" dialog-dismiss hidden$="[[!isShoOpNotaCredito]]" onclick="xAnularComprobante_NotaCredito()">Listo, generar nota de crédito</div>
<div class="xBoton2 xPlomo" dialog-dismiss>Cancelar</div>
<br><br>
</div>
</paper-dialog>
<paper-dialog class="dialog_redondo" id="dialog_send_whatsapp" style="width:300px" modal entry-animation="scale-up-animation" exit-animation="fade-out-animation">
<div style="text-align:center">
<img src="../../../images/whatsapp.png" alt="">
<p id="dgl_sunat_msj">Enviar comprobante por WhatsApp.<br> [[numComprobanteSelected]] </p><br>
<input type="number" class="xMiInput xfont18 text-center" placeholder="Numero de Telefono" autofocus id="txt_wtp" onkeyup="xChangeNumWhatsApp(this)" enlinea>
<br><br>
<div id="dgl_loading_whatsapp" class="xInvisible">
<p>Enviando...</p>
<paper-progress indeterminate style="width:100%"></paper-progress>
</div>
<br>
<div id="div-btns-wsp">
<button dialog-dismiss class="xBoton2 xPlomo">Cancelar</button>
<button id="btn-send-whatsapp" onclick="sendCPEWhatsApp()" class="xBoton2 xVerde" disabled$="[[ !showBtnSendWhatsapp ]]">Enviar</button>
</div>
</div>
</paper-dialog>
<br>
<div class="xMiCard xradius" style="width:90%">
<div class="xEncanezadoCard xFondoRowAmarillo2">
<h4>Comprobantes electronicos.</h4>
<span hidden$=[[isContador]]>Estado de los comprobantes electronicos, resumenes diarios y reportes.</span>
</div>
<div class="xContentCard" style="height:100%">
<div>
<br>
<paper-tabs selected="{{selected}}" id="tab_cpe">
<paper-tab>Comprobantes</paper-tab>
<paper-tab>Resumen de boletas</paper-tab>
<paper-tab>Notas de Crédito</paper-tab>
</paper-tabs>
<div class="xLinea2"></div>
<br><br>
<iron-pages selected="{{selected}}">
<div id="div_comprobantes">
<div id="div_info_comprobantes" hidden$=[[isContador]]>
<h4>Comprobantes electronicos emitidos.</h4>
<p class="xColorRow_Plomo">Al enviar el resumen de boletas, también se procesan y se envían los documentos sin
registrar, es decir los documentos
que se emitieron en modo offline ó los que por algún motivo en su momento no se pudo establecer conexión con la
Sunat.<br>Este proceso es el mismo que se realiza al cierre de caja.</p>
<div class="d-flexx">
<button class="xBoton2 xAzul mr-2" onclick="xEnviarResumenBoletas()">Enviar Resumen de boletas</button>
<button class="xBoton2 xVerde" onclick="downloadReporteCPEEmitidos()" title="Bajar a excel"><img src="../../../images/excel.png" alt=""></button>
</div>
<p id="xTituloRpt" class="xColorRow_Rojo"></p>
</div>
<div id="div_opciones_contador" hidden$=[[!isContador]]>
<button class="xBoton2 xAzul" style="display:none" onclick="xGenerarReporteExcelMesAnterior()" title="Bajar a excel" id="btn_mes_anterior"><img src="../../../images/excel.png" alt="" style="padding-right:3px">
<span id="txt_btn_mes_anterior"></span>
</button>
</div>
<br>
<hr>
<div class="x_div_linea">
<input type="month" class="xMiInput xfont17 xitem1" style="width:200px" id="txt_fecha" enlinea>
<input type="text" class="xMiInput xfont18 xitem2" style="width:80%;bottom:-2px" placeholder="Buscar" autofocus onkeyup="xfiltrarDatos()" id="txt_buscar" enlinea>
</div>
<br><br>
<table width="100%" id="tb_list_cpe" class="xtable5">
<thead>
<th class="xNoVisibleMenos720" width="45px">#</th>
<th class="xNoVisibleMenos720" width="15%">fecha</th>
<th class="xNoVisibleMenos720" width="17%">Comprobante</th>
<th width="35%">Cliente</th>
<th align="right">Total</th>
<th>Estado</th>
<th>.</th>
</thead>
<tbody>
<template is="dom-repeat" items="{{ListCpe}}" as="item">
<tr class="animated fadeIn fast" id="{{index}}">
<td class="xNoVisibleMenos720" data-id="{{index}}">
<span hidden$="{{!item.btn_anular}}" class="xDeleteRow2" title="Anular" onclick="xAnularComprobante(this)"></span>
<span>{{displayIndex(index)}}</span>
</td>
<td class="xNoVisibleMenos720">{{item.fecha}} - {{ item.hora }}</td>
<td class="xNoVisibleMenos720">{{item.nom_comprobante}} - {{ item.numero }}</td>
<td>{{item.nomcliente}}</td>
<td align="right" class="ximporte_row">{{item.total}}</td>
<td>
<div id="rowitem">
<div id="row_estado">
<span class$={{item.class_estado}}>{{item.nom_estado}}</span>
<div hidden$="{{!item.show_nc}}">
<p class="badge badge-info fs-10">NC {{ item.nota_credito }}</p>
</div>
<template is="dom-if" if="{{_isEqualTo(item)}}">
<button class="xBoton_flat_2 xCursor" data-id="{{index}}" onclick="reenviarComprobante(this)"> Reenviar</button>
</template>
<template is="dom-if" if="{{_isEqualToSinRegistrar(item)}}">
<button class="xBoton_flat_2 xCursor" data-id="{{index}}" onclick="registrarComprobante(this)"> Registrar</button>
</template>
</div>
<div id="row_loading" class="xInvisible">
<i class="fa fa-circle-o-notch fa-spin"></i>
</div>
</div>
</td>
<td>
<div data-id="{{index}}">
<img class="xzoom-1 xCursor" hidden$="{{!item.ico_pdf}}" onclick="verDocuemnto('pdf',this)" src="../../../images/001-pdf.png" width="16px" alt="">
<img class="xzoom-1 xCursor" hidden$="{{!item.ico_xml}}" onclick="verDocuemnto('xml',this)" src="../../../images/002-xml.png" width="16px" alt="">
<img class="xzoom-1 xCursor" hidden$="{{!item.ico_cdr}}" onclick="verDocuemnto('cdr',this)" src="../../../images/003-cdr.png" width="16px" alt="">
<img class="xzoom-1 xCursor" title="Enviar x WhatsApp" onclick="openSendWhatsApp(this)" src="../../../images/whatsapp.png" width="16px" alt="wts">
</div>
</td>
</tr>
</template>
</tbody>
</table>
<br>
<div>
<pagination-input id="paginator" class="xDerecha" current-page="1" page-count="5" current-page-changed="onChangePagination($event)"></pagination-input>
</div>
<br><br><br>
<div class="xLinea2"></div>
<br>
<div class="div-resumen-cpe">
<p class="fs-17 fw-600">Resumen de comprobantes</p>
<br>
<table class="w-100">
<thead>
<th>Tipo</th>
<th align="center">Cantidad</th>
<th align="right">Total</th>
</thead>
<tbody>
<template is="dom-repeat" items="{{listResumenCpeEmitidos}}" as="item">
<tr>
<td>{{ item.nom_comprobante }}</td>
<td align="center">{{ item.cantidad }}</td>
<td align="right">{{ item.total }}</td>
</tr>
</template>
<tr>
<td colspan="3" align="right"><p class="fw-600 fs-16">{{ listResumenCpeEmitidosTotal }}</p></td>
</tr>
</tbody>
</table>
</div>
<br><br>
</div>
<div id="div_resuemn">
<h4>Resumen de boletas</h4>
<p>Todas las boletas emitidas en el dia se envian a la sunat en un unico archivo llamado resumen diario de boletas.</p>
<br>
<hr>
<div>
<input type="text" class="xMiInput xfont18" style="width:100%;bottom:-3px" placeholder="Buscar" autofocus onkeyup="xfiltrarDatos_re()" id="txt_buscar_re" enlinea>
</div>
<br><br>
<table width="100%" id="tb_list_resumen" class="xtable5">
<thead>
<th>#</th>
<th>f. Resumen</th>
<th>f. Envio</th>
<th>Estado</th>
<th>.</th>
</thead>
<tbody>
<template is="dom-repeat" items="{{ListCpeResumen}}" as="item">
<tr class="animated fadeIn fast" id="{{index}}">
<td>
<span class="xNoVisibleMenos720">{{displayIndex(index)}}</span>
</td>
<td class="xNoVisibleMenos720">{{item.fecha_resumen}}</td>
<td class="xNoVisibleMenos720">{{item.fecha_envio}}</td>
<td>{{item.msj}}</td>
<td>
<div>
<img class="xzoom-1 xCursor" hidden$="{{!item.ico_xml}}" src="../../../images/002-xml.png" width="16px" alt="">
<img class="xzoom-1 xCursor" hidden$="{{!item.ico_cdr}}" src="../../../images/003-cdr.png" width="16px" alt="">
</div>
</td>
</tr>
</template>
</tbody>
</table>
<br>
<div class="xDerecha">
<pagination-input id="paginator_re" current-page="1" page-count="5" current-page-changed="onChangePagination_re($event)"></pagination-input>
</div>
<br><br>
</div>
<div id="div_notas_credito">
<h3>Notas de Crédito</h3><br>
<table width="100%" id="tb_list_nc">
<thead>
<th>#</th>
<th>Fecha</th>
<th>Usuario</th>
<th>Nota Crédito</th>
<th width="35%">Comprobante Afectado</th>
<th>Estado</th>
<th>.</th>
</thead>
<tbody>
<template is="dom-repeat" items="{{ListCpeNC}}" as="item">
<tr>
<td><span>{{displayIndex(index)}}</span></td>
<td>
<p>{{item.fecha}}</p>
<p>{{item.hora}}</p>
</td>
<td>{{item.usuario}}</td>
<td>{{item.numero}}</td>
<td>
<p>{{item.comprobante}}</p>
<p class="text-secondary">{{item.motivo}}</p>
</td>
<td><span class="badge badge-success">Aceptado</span></td>
<td>
<div data-id="{{index}}">
<img class="xzoom-1 xCursor" onclick="verDocuemnto('pdf',this,true)" src="../../../images/001-pdf.png" width="16px" alt="">
<img class="xzoom-1 xCursor" onclick="verDocuemnto('xml',this,true)" src="../../../images/002-xml.png" width="16px" alt="">
<img class="xzoom-1 xCursor" onclick="verDocuemnto('cdr',this,true)" src="../../../images/003-cdr.png" width="16px" alt="">
<img class="xzoom-1 xCursor" title="Enviar x WhatsApp" onclick="openSendWhatsApp(this,true)" src="../../../images/whatsapp.png" width="16px" alt="wts">
</div>
</td>
</tr>
</template>
</tbody>
</table>
</div>
</iron-pages>
</div>
</div>
</div>
<br><br>
<div id="reporte" class="xInvisible">
<table id="testTable" width="100%">
<caption>
<h1>{{selEstablecimientoCpe.nomsede}} | {{selEstablecimientoCpe.ciudad}}</h1>
<h2>Reporte de comprobantes electronicos - {{selMesCPE}}</h2>
</caption>
<thead>
<th width="45px">#</th>
<th width="15%">f. Emision</th>
<th>Tipo</th>
<th>Numero</th>
<th width="35%">Cliente</th>
<th width="15%">RUC/DNI</th>
<th align="right">Sub total</th>
<th align="right">I.G.V</th>
<th align="right">Total</th>
<th>Estado Sistema</th>
</thead>
<tbody>
<template is="dom-repeat" items="{{ListReporte}}" as="row">
<tr>
<td>{{displayIndex(index)}}</td>
<td style$="{{row.style_td}}">{{row.fecha}}</td>
<td style$="{{row.style_td}}">{{row.tipo_doc}}</td>
<td style$="{{row.style_td}}">{{row.num_doc }}</td>
<td style$="{{row.style_td}}">{{row.nom_cliente}}</td>
<td style$="{{row.style_td}}">{{row.ruc}}</td>
<td style$="{{row.style_td}}">{{row.subtotal}}</td>
<td style$="{{row.style_td}}">{{row.igv}}</td>
<td style$="{{row.style_td}}">{{row.total}}</td>
<td style$="{{row.style_reporte}}">{{row.estado}}</td>
<td style$="{{row.style_estado_sunat}}">{{row.estadoCp}}</td>
</tr>
</template>
</tbody>
</table>
</div>
</template>
<style>.div-resumen-cpe{width:290px;background:#d2faf9;padding:15px;border:1px solid #ccc;border-radius:5px}</style>
</dom-module>
<script type="text/javascript" src="./list.resumen.boletas.js"></script>
<script rel="preload" type="text/javascript" src="../../view/xm_all.js"></script>
<script rel="preload" type="text/javascript" src="./../x-caja/cocinar.resumen.boletas.js"></script>
<script type="text/javascript" src="../../view/config.const.js"></script>
<script rel="preload" type="text/javascript" src="../../view/xJsonSunat.js"></script>
<script rel="preload" type="text/javascript" src="../../view/xSOAPSunat.js"></script>
<script rel="preload" type="text/javascript" src="../../view/cpe_interno.js"></script>
<script type="text/javascript" src="../../view/export.excel.js"></script>
<script>/*<![CDATA[*/var xThisCpe,lastPos=0,xPopupLoad,p_upadate=true,p_rows_re=0,p_rows=0,p_fecha='',p_filter='',p_desde=0,data_pagination={},data_pagination_re={},xdebounce,xe_debounce=false,index_anular;var cpe_mes_anterior='',cpe_yy_actual='',_us_cpe='',external_id_cpe,_apiConsultaCpeCPE,listCpeSuccessCPE=[];function xExportarExcel(){tableToExcel('testTable','Comprobantes');setTimeout(()=>{xPopupLoad.xclose();},500);}
function xIniCpe(){xThisCpe.ListCpe=[];xThisCpe.ListCpeResumen=[];xCPE_getMesYYActual();xCPEValidUs();xLoadCpeEmitidos('6');xIniPagination();xThisCpe.NumDaysAnularCpe=xm_log_get('app3_sys_const').find(x=>x.llave==='NUM_DAYS_ANULACION_CPE').value;_apiConsultaCpeCPE=new apiConsulaCpe();setTimeout(()=>{$('body').addClass('loaded');txt_fecha.valueAsDate=new Date();},500);xThisCpe.$.paginator.addEventListener('page-limit-change',(e)=>{data_pagination=e.detail.value;p_desde=data_pagination.pageDesde;lastPos=$(window).scrollTop();xApplyFilterDate();});$("#txt_fecha").on('change',function(){xThisCpe.$.paginator.currentPage=1;xApplyFilterDate();});$("#tab_cpe").on('iron-select',function(){console.log('xThisCpe.selected',xThisCpe.selected);switch(xThisCpe.selected){case 2:xLoadNotasCredito();break;}});xListRe_ini();}
function xApplyFilterDate(){var d=$(txt_fecha).val().split('-');p_fecha=d[1]===undefined?'':'01/'+d[1]+'/'+d[0];xLoadCpeEmitidos('6');xResumenMesTotaleCpe();}
function xResumenMesTotaleCpe(){$.ajax({type:'POST',url:'../../bdphp/log_002.php',data:{op:'602',fecha_mes:p_fecha}}).done(function(res){res=JSON.parse(res);xThisCpe.listResumenCpeEmitidos=res.datos;const _totalImporteCpe=xThisCpe.listResumenCpeEmitidos.map(x=>parseFloat(x.total.replace(/,/g,''))).reduce((a,b)=>a+b,0);xThisCpe.listResumenCpeEmitidosTotal=numeroConComas(_totalImporteCpe.toFixed(2));});}
function xIniPagination(){xThisCpe.$.paginator.currentPage=1;xThisCpe.$.paginator.pageRows=p_rows;xThisCpe.$.paginator.listRows=[10,20,30,40];}
function xfiltrarDatos(){if(xe_debounce)return;xe_debounce=true;clearTimeout(xdebounce);xdebounce=setTimeout(()=>{xLoadCpeEmitidos('6');xe_debounce=false;xThisCpe.$.paginator.currentPage=1;},900);}
function xLoadCpeEmitidos(op){p_filter=xThisCpe.$.txt_buscar.value;data_pagination.pageFilter=p_filter;data_pagination.pageFecha=p_fecha;let xDataRes=[];$.ajax({type:'POST',url:'../../bdphp/log_002.php',data:{op:op,pagination:data_pagination}}).done(function(res){res=res.split('**');p_rows=res[1];res=$.parseJSON(res[0]);xDataRes=res.datos;xDataRes.map(x=>{let msj_estado='';let class_estado='';const boleta=x.codsunat==='03'?true:false;const e_api=parseInt(x.estado_api)===0?true:false;const e_sunat=parseInt(x.estado_sunat)===0?true:false;let estado_cpe;let btn_enviar=false;let btn_anular=false;let style_reporte='';if(parseInt(x.anulado)===0){if(e_api&&e_sunat)estado_cpe=0;if(!e_api&&!e_sunat)estado_cpe=1;if(boleta&&e_api&&!e_sunat)estado_cpe=2;if(!boleta&&e_api&&!e_sunat)estado_cpe=3;}else{estado_cpe=4;}
switch(parseInt(estado_cpe)){case 0:msj_estado='Aceptado';class_estado='badge badge-success xColorRow_verde';btn_anular=true;style_reporte='color: green';break;case 1:msj_estado='Sin Registrar';class_estado='badge badge-warning xColorRow_Amarillo';btn_enviar=true;style_reporte='color: yellow';break;case 2:msj_estado='Registrado';class_estado='badge badge-info xColorRow_Azul';style_reporte='color: blue';break;case 3:msj_estado='Registrado';class_estado='badge badge-info xColorRow_Azul';style_reporte='color: blue';break;case 4:msj_estado='Anulado';class_estado='badge badge-danger xFondoRowRojo';style_reporte='color: red';break;}
if(x.totales_json!==''&&x.totales_json!==null){const _totales_json=JSON.parse(x.totales_json.replace('"{','{').replace('}"','}'))
x.subtotal=_totales_json.total_valor;x.igv=_totales_json.total_igv;}else{x.subtotal=x.total;x.igv='0.00';}
class_estado+=' xBold xfont11';x.ico_pdf=x.pdf==='1'?true:false;x.ico_xml=x.xml==='1'?true:false;x.ico_cdr=x.cdr==='1'?true:false;x.class_estado=class_estado;x.nom_estado=msj_estado;x.btn_enviar=btn_enviar;x.btn_anular=btn_anular;x.show_nc=x.nota_credito?true:false;x.style_reporte=style_reporte;x.isReenviandoLoading=false;})
p_upadate=false;xThisCpe.$.paginator.pageRows=p_rows;if(op==='6'){xThisCpe.ListCpe=[];xThisCpe.ListCpe=xDataRes;setTimeout(()=>{$(window).scrollTop(lastPos);},5);}else{xThisCpe.ListCpeResumen=[];xThisCpe.ListReporte=xDataRes;setTimeout(()=>{xExportarExcel();},100);}});}
function xEnviarResumenBoletas(){xPopupLoad.xclose();dialog_enviando_sunat.open();setTimeout(()=>{const rpt=xCocinarResumenBoletas();if(rpt===''){xLoadCpeEmitidos('6');}},1000);}
function verDocuemnto(tipo,obj,isNotaCredito=false){const index=obj.parentElement.dataId;const external_id=!isNotaCredito?xThisCpe.ListCpe[index].external_id:xThisCpe.ListCpeNC[index].external_id;xSoapSunat_DownloadFile(tipo,external_id)}
function xAnularComprobante(obj){if(xThisCpe.isContador)return;index_anular=obj.parentElement.dataId;const _cpeSelected=xThisCpe.ListCpe[index_anular];xThisCpe.desDocCpe=_cpeSelected.numero;xVerificarPlazoAnulacion(_cpeSelected);dialog_motivo_anular_comprobante.open();}
function xVerificarPlazoAnulacion(cpeSelected){const _numDaysDiff=xDiasTranscurridos('',cpeSelected.fecha);xThisCpe.isShoOpNotaCredito=_numDaysDiff>=7;console.log('_numDaysDiff',_numDaysDiff);}
async function xAnularComprobante_confirma(){const _external_id=xThisCpe.ListCpe[index_anular].external_id;const _codsunat=xThisCpe.ListCpe[index_anular].codsunat;const _fecha=xThisCpe.ListCpe[index_anular].fecha;const _motivo_anulacion=txt_motivo_anular.value;const dataAnulacion={codsunat:_codsunat,external_id:_external_id,motivo:_motivo_anulacion,fecha:_fecha}
lastPos=$(window).scrollTop();xm_all_xToastOpen("Conectando con Sunat...");const res=await xSoapSunat_AnularComprobante(dataAnulacion);if(res){lastPos=$(window).scrollTop();xLoadCpeEmitidos('6');}
xm_all_xToastClose();txt_motivo_anular.value='';}
async function xAnularComprobante_NotaCredito(){const _cpeSelected=xThisCpe.ListCpe[index_anular];const rpt=await xCocinarJsonNotaCredito(_cpeSelected);if(rpt){lastPos=$(window).scrollTop();xLoadCpeEmitidos('6');}
xm_all_xToastClose();}
function xGenerarReporteExcel(){const org=xm_log_get('datos_org_sede');xThisCpe.nom_sede=org?org[0].sedenombre:'';xLoadCpeEmitidos('601');}
function xGenerarReporteExcelMesAnterior(){const param_busqueda_mes_anterior=xCeroIzq(cpe_mes_anterior,2)+'/'+cpe_yy_actual;const org=xm_log_get('datos_org_sede');xThisCpe.nom_sede=org?org[0].sedenombre:'';xPopupLoad.titulo="Procesando..."
xPopupLoad.xopen();txt_buscar.value=param_busqueda_mes_anterior;setTimeout(()=>{xLoadCpeEmitidos('601');xPopupLoad.xclose();},1500);}
function xCPE_getMesYYActual(){const _f_actual=new Date();cpe_mes_anterior=_f_actual.getMonth();cpe_mes_anterior=cpe_mes_anterior===0?1:cpe_mes_anterior;cpe_yy_actual=_f_actual.getFullYear();const cpe_nom_mes=xDevolverFechaParte('mmmm');const cpe_yy_mes=xDevolverFechaParte('yy');txt_btn_mes_anterior.textContent="Resporte "+cpe_nom_mes+' '+cpe_yy_mes;}
function xCPEValidUs(){_us_cpe=xm_log_get('app3_us');if(xThisCpe.isContador){xThisCpe.isContador=parseInt(_us_cpe.rol)==2?true:false;xGetIdCpc();}}
function xGetIdCpc(){$.ajax({type:'POST',url:'../../bdphp/log_004.php?op=40101',data:{id:_us_cpe.idus}}).done((res)=>{_us_cpe.idus_cpc=res;xLoadCpeListEstablecimientosCPC();});}
function xLoadCpeListEstablecimientosCPC(){$.ajax({type:'POST',url:'../../bdphp/log_004.php?op=401',data:{id:_us_cpe.idus_cpc}}).done((res)=>{const _res=$.parseJSON(res);xThisCpe.listSedeUsContador=_res.datos;});}
function selectOptionSedeCPC(){const index=xThisCpe.$.selectSedeCPC.value;if(index===-1)return;const sedeSelect=xThisCpe.listSedeUsContador[index];$.ajax({type:'POST',url:'../../bdphp/log_004.php?op=40102',data:{ido:sedeSelect.idorg,ids:sedeSelect.idsede}}).done((res)=>{updateapp3_woDUS_changeSede(sedeSelect.idorg,sedeSelect.idsede);xIniCpe();});}
async function registrarComprobante(obj){const _idIndex=obj.dataId;const objRow=obj.parentElement.parentElement;const rowEstado=$(obj.parentElement.parentElement).find('#row_estado');const rowLoading=$(obj.parentElement.parentElement).find('#row_loading');var _rowCpe=xThisCpe.ListCpe[_idIndex];const numDoc=_rowCpe.numero?_rowCpe.numero.split('-')[1].replaceAll('0',''):'#';_rowCpe.isReenviandoLoading=true;const rpt=await xSoapSunat_EnviarDocumentApi(JSON.parse(_rowCpe.json_xml),_rowCpe.idce,numDoc);if(rpt.ok){xLoadCpeEmitidos('6');}else{alert(rpt.msj_error);}
_rowCpe.isReenviandoLoading=false;rowLoading.addClass('xInvisible');rowEstado.removeClass('xInvisible');}
async function reenviarComprobante(obj){const _idIndex=obj.dataId;const objRow=obj.parentElement.parentElement;const rowEstado=$(obj.parentElement.parentElement).find('#row_estado');const rowLoading=$(obj.parentElement.parentElement).find('#row_loading');var _rowCpe=xThisCpe.ListCpe[_idIndex];_rowCpe.isReenviandoLoading=true;rowEstado.addClass('xInvisible');rowLoading.removeClass('xInvisible');const rpt=await xSoapSunat_SendSunat(_rowCpe.external_id,_rowCpe.idce)
if(rpt.ok){xLoadCpeEmitidos('6');}else{alert(rpt.msj_error);}
_rowCpe.isReenviandoLoading=false;rowLoading.addClass('xInvisible');rowEstado.removeClass('xInvisible');}
function openSendWhatsApp(obj,isNotaCredito=false){const index=obj.parentElement.dataId;const _listGetCPE=!isNotaCredito?xThisCpe.ListCpe[index]:xThisCpe.ListCpeNC[index];external_id_cpe=_listGetCPE.external_id;xThisCpe.numComprobanteSelected=_listGetCPE.numero;$('#div-btns-wsp').removeClass('xInvisible');txt_wtp.value='';dialog_send_whatsapp.open();}
function xChangeNumWhatsApp(obj){xThisCpe.showBtnSendWhatsapp=obj.value.length>8;}
function sendCPEWhatsApp(){const dtSede=xm_log_get("datos_org_sede")[0];const _userId=dtSede.id_api_comprobante;const _payloadPdf={telefono:txt_wtp.value,external_id:external_id_cpe,user_id:_userId,numero_comprobante:xThisCpe.numComprobanteSelected,comercio:xm_log_get('datos_org_sede')[0].sedenombre};$(dgl_loading_whatsapp).removeClass('xInvisible');$('#div-btns-wsp').addClass('xInvisible');setTimeout(()=>{$(dgl_loading_whatsapp).addClass('xInvisible');dialog_send_whatsapp.close();_cpSocketComprobanteWhatApp(_payloadPdf);},3000);}
async function downloadReporteCPEEmitidos(obj){const _selMes=xThisCpe.$.txt_fecha.value.split('-');var selEstablecimiento=xm_log_get('datos_org_sede')[0];xThisCpe.selMesCPE=xDesMes(parseInt(_selMes[1])-1)+' '+_selMes[0];selEstablecimiento.nomsede=selEstablecimiento.sedenombre;selEstablecimiento.ciudad=selEstablecimiento.sedeciudad;selEstablecimiento.userid=selEstablecimiento.id_api_comprobante;xThisCpe.selEstablecimientoCpe=selEstablecimiento;const _data={establecimiento:selEstablecimiento,m:_selMes[1],y:_selMes[0]}
const rptApiToken=await _apiConsultaCpeCPE.getToken();const _apiToken=rptApiToken.access_token;var countCpeSuccess=0;xPopupLoad.titulo='Descargando...';xPopupLoad.xopen();dataListReporte=[];xThisCpe.ListReporte=[];$.ajax({type:'POST',url:'../../bdphp/log_007.php?op=2',data:{item:_data}}).done(async(res)=>{res=JSON.parse(res);if(res.error){console.log(res.error);return;}
console.log(res.data);listCpeSuccessCPE=[];const ruc_emisor=selEstablecimiento.ruc;const _numRows=res.data.length;xThisCpe.numRowsList=_numRows;for(let index=0;index<_numRows;index++){var x=res.data[index];x.estado=x.tipo_doc==='FACTURA'&&parseInt(x.ruc)===0?'ANULADO':x.estado;x.style_reporte=x.estado==='ANULADO'?'color: red':'color: green';x.style_td=x.estado==='ANULADO'?'color: red':'';try{const cpeVerificado=listCpeSuccessCPE.find(c=>c.id===x.id);if(!cpeVerificado){const codComp=x.series.indexOf('F')>-1?'01':'03';const num_doc=parseInt(x.num_doc.split('-')[1]);const monto=x.total.replace(/,/g,'');const payload={header:{ruc_receptor:x.ruc,access_token:_apiToken},body:{"numRuc":ruc_emisor,"codComp":codComp,"numeroSerie":x.series,"numero":num_doc,"fechaEmision":x.fecha,"monto":monto}}
if(selEstablecimiento.habilita_verificacion_cpe==1){const rptApiConsulta=await _apiConsultaCpeCPE.getConsulta(payload);let estado_cpe;if(rptApiConsulta?.success===true){x.success_sunat=1;estado_cpe=xEstadoCpeApi(rptApiConsulta.data.estadoCp);x.estadoCp=estado_cpe.titulo;x.style_estado_sunat='color: '+estado_cpe.color;countCpeSuccess++;listCpeSuccessCPE.push(x);}else{countCpeError++;x.success_sunat=0;x.estadoCp='Sin Respuesta';x.style_estado_sunat='color: black';xThisAdmContador.showRowsNoResponse=true;}}else{countCpeSuccess++;listCpeSuccessCPE.push(x);}}else{x=cpeVerificado;countCpeSuccess++;}
xPopupLoad.titulo='Verificando: '+countCpeSuccess+' de '+xThisCpe.numRowsList+' Documentos.';xThisCpe.numRowsVerificadoSuccess=countCpeSuccess;dataListReporte.push(x);}catch(error){console.error(error);return;}}
xPopupLoad.titulo='Cargando...';setDataListReporteCpe(dataListReporte);});}
function setDataListReporteCpe(list){xThisCpe.ListReporte=list?list:dataListReporte
setTimeout(()=>{xExportarExcel();},500);}
function xLoadNotasCredito(){xThisCpe.ListCpeNC=[];$.ajax({type:'POST',url:'../../bdphp/log_002.php',data:{op:'1001'}}).done((res)=>{const _list=JSON.parse(res);console.log('_list',_list);xThisCpe.ListCpeNC=_list.datos;});}
function xEstadoCpeApi(estado){var _estado={titulo:'',color:''};const _valEstado=estado.toString()
switch(_valEstado){case'0':_estado.titulo="NO EXISTE";_estado.color="purple";break;case'1':_estado.titulo="ACEPTADO";_estado.color="green";break;case'2':_estado.titulo="ANULADO";_estado.color="red";break;case'3':_estado.titulo="AUTORIZADO";_estado.color="green";break;case'4':_estado.titulo="NO AUTORIZADO";_estado.color="red";break;}
return _estado;}
Polymer({is:'x-cpe-emitidos',properties:{ListCpe:[],ListCpeResumen:[],ListReporte:[],listSedeUsContador:[],listResumenCpeEmitidos:[],listResumenCpeEmitidosTotal:Number,nom_sede:'',isContador:false,isReenviandoLoading:false,showBtnSendWhatsapp:false,numComprobanteSelected:String,selEstablecimientoCpe:Object,selMesCPE:String,NumDaysAnularCpe:Number,isShoOpNotaCredito:Boolean,desDocCpe:String,ListCpeNC:[],subscription$:Object,numRowsList:Number,numRowsVerificadoSuccess:Number},attached:function(){this.selected=0,this.isReenviandoLoading=false;this.showBtnSendWhatsapp=false;this.isShoOpNotaCredito=false;this.listResumenCpeEmitidosTotal=0;xThisCpe=this;xIniCpe();setTimeout(()=>{_cpSocketOpen();},1000);this.subscription$=onStatusSetUsChangeSede().subscribe(res=>{if(res==true){xIniCpe();}});},detached:function(){_cpSocketClose();this.subscription$.unsubscribe();},displayIndex:function(index){return xCeroIzq(parseInt(p_desde)+(index+1),1);},_isEqualTo:(item)=>{return item.nom_estado==='Registrado'&&item?.json_xml?.length>1;},_isEqualToSinRegistrar:(item)=>{return item.nom_estado==='Sin Registrar'&&item?.json_xml?.length>1;},_isEqualToLoading:(item)=>{return item.isReenviandoLoading;},})/*]]>*/</script>