<link rel="import"href="../../x-componentes/pagination-input/pagination-input.html"><link rel="preload"href="../../../images/_msj_envio_sunat.gif"as="image"media="(max-width: 600px)"><dom-module id="x-cpe-emitidos"><script src="../../view/socket.master.service.js"></script><script src="../../view/socket.service.p.js"></script><script src="../../view/xApiConsultaSunat.js"></script><script src="../../view/httpFech.js"></script><template is="dom"><paper-dialog class="dialog_redondo"id="dialog_enviando_sunat"style="width:245px"modal entry-animation="scale-up-animation"exit-animation="fade-out-animation"><div style="text-align:center"><img id="dgl_sunat_img"src="../../../images/_msj_envio_sunat.gif"alt=""><p id="dgl_sunat_msj">Enviando comprobantes electronicos.<p id="dgl_sunat_msj2"class="dgl_sunat_msj2 xInvisible xColorRow_Azul">Proceso concluido con exito.<p id="dgl_sunat_msj3"class="dgl_sunat_msj3 center xColorRow_Plomo xfont11">...</p><paper-progress id="dgl_sunat_progress"indeterminate style="width:100%"></paper-progress><button dialog-dismiss id="dlg_sunat_btn"class="xBoton2 xVerde xInvisible">Listo</button></div></paper-dialog><paper-dialog id="dialog_motivo_anular_comprobante"class="dialog_redondo"style="min-width:320px;max-width:600px"entry-animation="scale-up-animation"exit-animation="fade-out-animation"with-backdrop><div class="xContent"><div class="d-flexx align-items-center"><h3>ANULAR COMPROBANTE</h3><span class="ml-2">[[ desDocCpe ]]</span></div><div class="xLinea2"></div><br><p><strong>El plazo para comunicar de baja o anular un comprobante de pago electrónico es de [[NumDaysAnularCpe]] días</strong>, contados desde el día que emites el comprobante. Si no cumples ese plazo, tendrás que generar una Nota de Crédito.<div hidden$="[[isShoOpNotaCredito]]"class="mt-1"><p class="fw-600 text-success">El documento esta en el plazo para dar de baja.</div><div hidden$="[[!isShoOpNotaCredito]]"class="mt-1"><p class="fw-600 text-info">El documento NO cumple con el plazo, debes generar una Nota de Crédito.</div><br><h4>Indique el motivo de anulación</h4><div><input class="xMiInput"placeholder="Motivo..."id="txt_motivo_anular"autofocus></div><br><br><br><div class="xBoton2 xRojo"dialog-dismiss hidden$="[[isShoOpNotaCredito]]"onclick="xAnularComprobante_confirma()">Listo, dar de baja</div><div class="xBoton2 xAzul"dialog-dismiss hidden$="[[!isShoOpNotaCredito]]"onclick="xAnularComprobante_NotaCredito()">Listo, generar nota de crédito</div><div class="xBoton2 xPlomo"dialog-dismiss>Cancelar</div><br><br></div></paper-dialog><paper-dialog class="dialog_redondo"id="dialog_send_whatsapp"style="width:300px"modal entry-animation="scale-up-animation"exit-animation="fade-out-animation"><div style="text-align:center"><img src="../../../images/whatsapp.png"alt=""><p id="dgl_sunat_msj">Enviar comprobante por WhatsApp.<br>[[numComprobanteSelected]]</p><br><input type="number"class="xMiInput xfont18 text-center"placeholder="Numero de Telefono"autofocus id="txt_wtp"onkeyup="xChangeNumWhatsApp(this)"enlinea><br><br><div id="dgl_loading_whatsapp"class="xInvisible"><p>Enviando...</p><paper-progress indeterminate style="width:100%"></paper-progress></div><br><div id="div-btns-wsp"><button dialog-dismiss class="xBoton2 xPlomo">Cancelar</button> <button id="btn-send-whatsapp"onclick="sendCPEWhatsApp()"class="xBoton2 xVerde"disabled$="[[ !showBtnSendWhatsapp ]]">Enviar</button></div></div></paper-dialog><br><div class="xMiCard xradius"style="width:90%"><div class="xEncanezadoCard xFondoRowAmarillo2"><h4>Comprobantes electronicos.</h4><span hidden$="[[isContador]]">Estado de los comprobantes electronicos, resumenes diarios y reportes.</span></div><div class="xContentCard"style="height:100%"><div><br><paper-tabs selected="{{selected}}"id="tab_cpe"><paper-tab>Comprobantes</paper-tab><paper-tab>Resumen de boletas</paper-tab><paper-tab>Notas de Crédito</paper-tab></paper-tabs><div class="xLinea2"></div><br><br><iron-pages selected="{{selected}}"><div id="div_comprobantes"><div id="div_info_comprobantes"hidden$="[[isContador]]"><h4>Comprobantes electronicos emitidos.</h4><p class="xColorRow_Plomo">Al enviar el resumen de boletas, también se procesan y se envían los documentos sin registrar, es decir los documentos que se emitieron en modo offline ó los que por algún motivo en su momento no se pudo establecer conexión con la Sunat.<br>Este proceso es el mismo que se realiza al cierre de caja.<div class="d-flexx justify-content-between"><div><button class="xBoton2 xAzul mr-2"onclick="xEnviarResumenBoletas()">Enviar Resumen de boletas</button> <button class="xBoton2 xVerde"onclick="downloadReporteCPEEmitidos()"title="Bajar a excel"><img src="../../../images/excel.png"alt=""></button></div><div><button class="xBoton2 xVerde"onclick="xVincularWhatsApp()">Vincular WhastApp</button></div></div><p id="xTituloRpt"class="xColorRow_Rojo"></div><div id="div_opciones_contador"hidden$="[[!isContador]]"><button class="xBoton2 xAzul"style="display:none"onclick="xGenerarReporteExcelMesAnterior()"title="Bajar a excel"id="btn_mes_anterior"><img src="../../../images/excel.png"alt=""style="padding-right:3px"> <span id="txt_btn_mes_anterior"></span></button></div><br><hr><div class="x_div_linea"><input type="month"class="xMiInput xfont17 xitem1"style="width:200px"id="txt_fecha"enlinea> <input class="xMiInput xfont18 xitem2"style="width:80%;bottom:-2px"placeholder="Buscar"autofocus onkeyup="xfiltrarDatos()"id="txt_buscar"enlinea></div><br><br><table width="100%"id="tb_list_cpe"class="xtable5"><thead><th class="xNoVisibleMenos720"width="45px">#<th class="xNoVisibleMenos720"width="15%">fecha<th class="xNoVisibleMenos720"width="17%">Comprobante<th width="35%">Cliente<th align="right">Total<th>Estado<th>.<tbody><template is="dom-repeat"items="{{ListCpe}}"as="item"><tr class="animated fadeIn fast"id="{{index}}"><td class="xNoVisibleMenos720"data-id="{{index}}"><span hidden$="{{!item.btn_anular}}"class="xDeleteRow2"title="Anular"onclick="xAnularComprobante(this)"></span> <span>{{displayIndex(index)}}</span><td class="xNoVisibleMenos720">{{item.fecha}} - {{ item.hora }}<td class="xNoVisibleMenos720">{{item.nom_comprobante}} - {{ item.numero }}<td>{{item.nomcliente}}<td align="right"class="ximporte_row">{{item.total}}<td><div id="rowitem"><div id="row_estado"><span class$="{{item.class_estado}}">{{item.nom_estado}}</span><div hidden$="{{!item.show_nc}}"><p class="badge badge-info fs-10">NC {{ item.nota_credito }}</div><template is="dom-if"if="{{_isEqualTo(item)}}"><button class="xBoton_flat_2 xCursor"data-id="{{index}}"onclick="reenviarComprobante(this)">Reenviar</button></template><template is="dom-if"if="{{_isEqualToSinRegistrar(item)}}"><button class="xBoton_flat_2 xCursor"data-id="{{index}}"onclick="registrarComprobante(this)">Registrar</button></template></div><div id="row_loading"class="xInvisible"><i class="fa fa-circle-o-notch fa-spin"></i></div></div><td><div data-id="{{index}}"><img class="xzoom-1 xCursor"hidden$="{{!item.ico_pdf}}"onclick='verDocuemnto("pdf",this)'src="../../../images/001-pdf.png"width="16px"alt=""> <img class="xzoom-1 xCursor"hidden$="{{!item.ico_xml}}"onclick='verDocuemnto("xml",this)'src="../../../images/002-xml.png"width="16px"alt=""> <img class="xzoom-1 xCursor"hidden$="{{!item.ico_cdr}}"onclick='verDocuemnto("cdr",this)'src="../../../images/003-cdr.png"width="16px"alt=""> <img class="xzoom-1 xCursor"title="Enviar x WhatsApp"onclick="openSendWhatsApp(this)"src="../../../images/whatsapp.png"width="16px"alt="wts"></div></template></table><br><div><pagination-input id="paginator"class="xDerecha"current-page="1"page-count="5"current-page-changed="onChangePagination($event)"></pagination-input></div><br><br><br><div class="xLinea2"></div><br><div class="div-resumen-cpe"><p class="fs-17 fw-600">Resumen de comprobantes</p><br><table class="w-100"><thead><th>Tipo<th align="center">Cantidad<th align="right">Total<tbody><template is="dom-repeat"items="{{listResumenCpeEmitidos}}"as="item"><tr><td>{{ item.nom_comprobante }}<td align="center">{{ item.cantidad }}<td align="right">{{ item.total }}</template><tr><td colspan="3"align="right"><p class="fw-600 fs-16">{{ listResumenCpeEmitidosTotal }}</table></div><br><br></div><div id="div_resuemn"><h4>Resumen de boletas</h4><p>Todas las boletas emitidas en el dia se envian a la sunat en un unico archivo llamado resumen diario de boletas.</p><br><hr><div><input class="xMiInput xfont18"style="width:100%;bottom:-3px"placeholder="Buscar"autofocus onkeyup="xfiltrarDatos_re()"id="txt_buscar_re"enlinea></div><br><br><table width="100%"id="tb_list_resumen"class="xtable5"><thead><th>#<th>f. Resumen<th>f. Envio<th>Estado<th>.<tbody><template is="dom-repeat"items="{{ListCpeResumen}}"as="item"><tr class="animated fadeIn fast"id="{{index}}"><td><span class="xNoVisibleMenos720">{{displayIndex(index)}}</span><td class="xNoVisibleMenos720">{{item.fecha_resumen}}<td class="xNoVisibleMenos720">{{item.fecha_envio}}<td>{{item.msj}}<td><div><img class="xzoom-1 xCursor"hidden$="{{!item.ico_xml}}"src="../../../images/002-xml.png"width="16px"alt=""> <img class="xzoom-1 xCursor"hidden$="{{!item.ico_cdr}}"src="../../../images/003-cdr.png"width="16px"alt=""></div></template></table><br><div class="xDerecha"><pagination-input id="paginator_re"current-page="1"page-count="5"current-page-changed="onChangePagination_re($event)"></pagination-input></div><br><br></div><div id="div_notas_credito"><h3>Notas de Crédito</h3><br><table width="100%"id="tb_list_nc"><thead><th>#<th>Fecha<th>Usuario<th>Nota Crédito<th width="35%">Comprobante Afectado<th>Estado<th>.<tbody><template is="dom-repeat"items="{{ListCpeNC}}"as="item"><tr><td><span>{{displayIndex(index)}}</span><td><p>{{item.fecha}}<p>{{item.hora}}<td>{{item.usuario}}<td>{{item.numero}}<td><p>{{item.comprobante}}<p class="text-secondary">{{item.motivo}}<td><span class="badge badge-success">Aceptado</span><td><div data-id="{{index}}"><img class="xzoom-1 xCursor"onclick='verDocuemnto("pdf",this,!0)'src="../../../images/001-pdf.png"width="16px"alt=""> <img class="xzoom-1 xCursor"onclick='verDocuemnto("xml",this,!0)'src="../../../images/002-xml.png"width="16px"alt=""> <img class="xzoom-1 xCursor"onclick='verDocuemnto("cdr",this,!0)'src="../../../images/003-cdr.png"width="16px"alt=""> <img class="xzoom-1 xCursor"title="Enviar x WhatsApp"onclick="openSendWhatsApp(this,!0)"src="../../../images/whatsapp.png"width="16px"alt="wts"></div></template></table></div></iron-pages></div></div></div><br><br><div id="reporte"class="xInvisible"><table id="testTable"width="100%"><caption><h1>{{selEstablecimientoCpe.nomsede}} | {{selEstablecimientoCpe.ciudad}}</h1><h2>Reporte de comprobantes electronicos - {{selMesCPE}}</h2><thead><th width="45px">#<th width="15%">f. Emision<th>Tipo<th>Numero<th width="35%">Cliente<th width="15%">RUC/DNI<th align="right">Sub total<th align="right">I.G.V<th align="right">Total<th>Estado Sistema<tbody><template is="dom-repeat"items="{{ListReporte}}"as="row"><tr><td>{{displayIndex(index)}}<td style$="{{row.style_td}}">{{row.fecha}}<td style$="{{row.style_td}}">{{row.tipo_doc}}<td style$="{{row.style_td}}">{{row.num_doc }}<td style$="{{row.style_td}}">{{row.nom_cliente}}<td style$="{{row.style_td}}">{{row.ruc}}<td style$="{{row.style_td}}">{{row.subtotal}}<td style$="{{row.style_td}}">{{row.igv}}<td style$="{{row.style_td}}">{{row.total}}<td style$="{{row.style_reporte}}">{{row.estado}}<td style$="{{row.style_estado_sunat}}">{{row.estadoCp}}</template></table></div></template><style>.div-resumen-cpe{width:290px;background:#d2faf9;padding:15px;border:1px solid #ccc;border-radius:5px}</style></dom-module><script src="./list.resumen.boletas.js"></script><script rel="preload"src="../../view/xm_all.js"></script><script rel="preload"src="./../x-caja/cocinar.resumen.boletas.js"></script><script src="../../view/config.const.js"></script><script rel="preload"src="../../view/xJsonSunat.js"></script><script rel="preload"src="../../view/xSOAPSunat.js"></script><script rel="preload"src="../../view/cpe_interno.js"></script><script src="../../view/export.excel.js"></script><script>var xThisCpe,xPopupLoad,xdebounce,index_anular,external_id_cpe,_apiConsultaCpeCPE,lastPos=0,p_upadate=!0,p_rows_re=0,p_rows=0,p_fecha="",p_filter="",p_desde=0,data_pagination={},data_pagination_re={},xe_debounce=!1,cpe_mes_anterior="",cpe_yy_actual="",_us_cpe="",listCpeSuccessCPE=[];function xExportarExcel(){tableToExcel("testTable","Comprobantes"),setTimeout(()=>{xPopupLoad.xclose()},500)}function xIniCpe(){xThisCpe.ListCpe=[],xThisCpe.ListCpeResumen=[],xCPE_getMesYYActual(),xCPEValidUs(),xLoadCpeEmitidos("6"),xIniPagination(),xThisCpe.NumDaysAnularCpe=xm_log_get("app3_sys_const").find(e=>"NUM_DAYS_ANULACION_CPE"===e.llave).value,_apiConsultaCpeCPE=new apiConsulaCpe,setTimeout(()=>{$("body").addClass("loaded"),txt_fecha.valueAsDate=new Date},500),xThisCpe.$.paginator.addEventListener("page-limit-change",e=>{data_pagination=e.detail.value,p_desde=data_pagination.pageDesde,lastPos=$(window).scrollTop(),xApplyFilterDate()}),$("#txt_fecha").on("change",function(){xThisCpe.$.paginator.currentPage=1,xApplyFilterDate()}),$("#tab_cpe").on("iron-select",function(){2===xThisCpe.selected&&xLoadNotasCredito()}),xListRe_ini()}function xApplyFilterDate(){var e=$(txt_fecha).val().split("-");p_fecha=void 0===e[1]?"":"01/"+e[1]+"/"+e[0],xLoadCpeEmitidos("6")}function xResumenMesTotaleCpe(){$.ajax({type:"POST",url:"../../bdphp/log_002.php",data:{op:"602",fecha_mes:p_fecha}}).done(function(e){e=JSON.parse(e),xThisCpe.listResumenCpeEmitidos=e.datos;e=xThisCpe.listResumenCpeEmitidos.map(e=>removeComas(e.total)).reduce((e,o)=>e+o,0);xThisCpe.listResumenCpeEmitidosTotal=numeroConComas(e.toFixed(2))})}function xIniPagination(){xThisCpe.$.paginator.currentPage=1,xThisCpe.$.paginator.pageRows=p_rows,xThisCpe.$.paginator.listRows=[10,20,30,40]}function xfiltrarDatos(){xe_debounce||(xe_debounce=!0,clearTimeout(xdebounce),xdebounce=setTimeout(()=>{xLoadCpeEmitidos("6"),xe_debounce=!1,xThisCpe.$.paginator.currentPage=1},900))}function xLoadCpeEmitidos(o){p_filter=xThisCpe.$.txt_buscar.value,data_pagination.pageFilter=p_filter,data_pagination.pageFecha=p_fecha;let t=[];$.ajax({type:"POST",url:"../../bdphp/log_002.php",data:{op:o,pagination:data_pagination}}).done(function(e){e=e.split("**"),p_rows=e[1],e=$.parseJSON(e[0]),(t=e.datos).map(e=>{let o="",t="";var a="03"===e.codsunat,s=0===parseInt(e.estado_api),i=0===parseInt(e.estado_sunat);let n,p=!1,r=!1,d="";switch(0===parseInt(e.anulado)?(s&&i&&(n=0),s||i||(n=1),a&&s&&!i&&(n=2),a||!s||i||(n=3)):n=4,parseInt(n)){case 0:o="Aceptado",t="badge badge-success xColorRow_verde",r=!0,d="color: green";break;case 1:o="Sin Registrar",t="badge badge-warning xColorRow_Amarillo",p=!0,d="color: yellow";break;case 2:case 3:o="Registrado",t="badge badge-info xColorRow_Azul",d="color: blue";break;case 4:o="Anulado",t="badge badge-danger xFondoRowRojo",d="color: red"}""!==e.totales_json&&null!==e.totales_json?(a=JSON.parse(e.totales_json.replace('"{',"{").replace('}"',"}")),e.subtotal=a.total_valor,e.igv=a.total_igv):(e.subtotal=e.total,e.igv="0.00"),t+=" xBold xfont11",e.ico_pdf="1"===e.pdf,e.ico_xml="1"===e.xml,e.ico_cdr="1"===e.cdr,e.class_estado=t,e.nom_estado=o,e.btn_enviar=p,e.btn_anular=r,e.show_nc=!!e.nota_credito,e.style_reporte=d,e.isReenviandoLoading=!1}),p_upadate=!1,xThisCpe.$.paginator.pageRows=p_rows,"6"===o?(xThisCpe.ListCpe=[],xThisCpe.ListCpe=t,setTimeout(()=>{$(window).scrollTop(lastPos)},5)):(xThisCpe.ListCpeResumen=[],xThisCpe.ListReporte=t,setTimeout(()=>{xExportarExcel()},100)),xResumenMesTotaleCpe()})}function xEnviarResumenBoletas(){xPopupLoad.xclose(),dialog_enviando_sunat.open(),setTimeout(()=>{""===xCocinarResumenBoletas()&&xLoadCpeEmitidos("6")},1e3)}function verDocuemnto(e,o,t=!1){o=o.parentElement.dataId,t=(t?xThisCpe.ListCpeNC:xThisCpe.ListCpe)[o].external_id;xSoapSunat_DownloadFile(e,t)}function xAnularComprobante(e){xThisCpe.isContador||(index_anular=e.parentElement.dataId,e=xThisCpe.ListCpe[index_anular],xThisCpe.desDocCpe=e.numero,xVerificarPlazoAnulacion(e),dialog_motivo_anular_comprobante.open())}function xVerificarPlazoAnulacion(e){e=xDiasTranscurridos("",e.fecha);xThisCpe.isShoOpNotaCredito=7<=e}async function xAnularComprobante_confirma(){var e=xThisCpe.ListCpe[index_anular].external_id,o=xThisCpe.ListCpe[index_anular].codsunat,t=xThisCpe.ListCpe[index_anular].fecha,o={codsunat:o,external_id:e,motivo:txt_motivo_anular.value,fecha:t},e=(lastPos=$(window).scrollTop(),xm_all_xToastOpen("Conectando con Sunat..."),await xSoapSunat_AnularComprobante(o));e&&(lastPos=$(window).scrollTop(),xLoadCpeEmitidos("6")),xm_all_xToastClose(),txt_motivo_anular.value=""}async function xAnularComprobante_NotaCredito(){var e=xThisCpe.ListCpe[index_anular];await xCocinarJsonNotaCredito(e)&&(lastPos=$(window).scrollTop(),xLoadCpeEmitidos("6")),xm_all_xToastClose()}function xGenerarReporteExcel(){var e=xm_log_get("datos_org_sede");xThisCpe.nom_sede=e?e[0].sedenombre:"",xLoadCpeEmitidos("601")}function xGenerarReporteExcelMesAnterior(){var e=xCeroIzq(cpe_mes_anterior,2)+"/"+cpe_yy_actual,o=xm_log_get("datos_org_sede");xThisCpe.nom_sede=o?o[0].sedenombre:"",xPopupLoad.titulo="Procesando...",xPopupLoad.xopen(),txt_buscar.value=e,setTimeout(()=>{xLoadCpeEmitidos("601"),xPopupLoad.xclose()},1500)}function xCPE_getMesYYActual(){var e=new Date,e=(cpe_mes_anterior=0===(cpe_mes_anterior=e.getMonth())?1:cpe_mes_anterior,cpe_yy_actual=e.getFullYear(),xDevolverFechaParte("mmmm")),o=xDevolverFechaParte("yy");txt_btn_mes_anterior.textContent="Resporte "+e+" "+o}function xCPEValidUs(){_us_cpe=xm_log_get("app3_us"),xThisCpe.isContador&&(xThisCpe.isContador=2==parseInt(_us_cpe.rol),xGetIdCpc())}function xGetIdCpc(){$.ajax({type:"POST",url:"../../bdphp/log_004.php?op=40101",data:{id:_us_cpe.idus}}).done(e=>{_us_cpe.idus_cpc=e,xLoadCpeListEstablecimientosCPC()})}function xLoadCpeListEstablecimientosCPC(){$.ajax({type:"POST",url:"../../bdphp/log_004.php?op=401",data:{id:_us_cpe.idus_cpc}}).done(e=>{e=$.parseJSON(e);xThisCpe.listSedeUsContador=e.datos})}function selectOptionSedeCPC(){var e=xThisCpe.$.selectSedeCPC.value;if(-1!==e){const o=xThisCpe.listSedeUsContador[e];$.ajax({type:"POST",url:"../../bdphp/log_004.php?op=40102",data:{ido:o.idorg,ids:o.idsede}}).done(e=>{updateapp3_woDUS_changeSede(o.idorg,o.idsede),xIniCpe()})}}async function registrarComprobante(e){var o=e.dataId,t=(e.parentElement.parentElement,$(e.parentElement.parentElement).find("#row_estado")),e=$(e.parentElement.parentElement).find("#row_loading"),o=xThisCpe.ListCpe[o],a=o.numero?o.numero.split("-")[1].replaceAll("0",""):"#",a=(o.isReenviandoLoading=!0,await xSoapSunat_EnviarDocumentApi(JSON.parse(o.json_xml),o.idce,a));a.ok?xLoadCpeEmitidos("6"):alert(a.msj_error),o.isReenviandoLoading=!1,e.addClass("xInvisible"),t.removeClass("xInvisible")}async function reenviarComprobante(e){var o=e.dataId,t=(e.parentElement.parentElement,$(e.parentElement.parentElement).find("#row_estado")),e=$(e.parentElement.parentElement).find("#row_loading"),o=xThisCpe.ListCpe[o],a=(o.isReenviandoLoading=!0,t.addClass("xInvisible"),e.removeClass("xInvisible"),await xSoapSunat_SendSunat(o.external_id,o.idce));a.ok?xLoadCpeEmitidos("6"):alert(a.msj_error),o.isReenviandoLoading=!1,e.addClass("xInvisible"),t.removeClass("xInvisible")}function openSendWhatsApp(e,o=!1){e=e.parentElement.dataId,o=(o?xThisCpe.ListCpeNC:xThisCpe.ListCpe)[e];external_id_cpe=o.external_id,xThisCpe.numComprobanteSelected=o.numero,//!isNotaCredito ? xThisCpe.ListCpe[index].numero : xThisCpe.ListCpeNC[index].numero
$("#div-btns-wsp").removeClass("xInvisible"),txt_wtp.value="",dialog_send_whatsapp.open()}function xChangeNumWhatsApp(e){xThisCpe.showBtnSendWhatsapp=8<e.value.length}function sendCPEWhatsApp(){var e=xm_log_get("datos_org_sede")[0].id_api_comprobante;const o={telefono:txt_wtp.value,external_id:external_id_cpe,user_id:e,numero_comprobante:xThisCpe.numComprobanteSelected,comercio:xm_log_get("datos_org_sede")[0].sedenombre,comercio_telefono:xm_log_get("datos_org_sede")[0].telefono};$(dgl_loading_whatsapp).removeClass("xInvisible"),$("#div-btns-wsp").addClass("xInvisible"),setTimeout(()=>{$(dgl_loading_whatsapp).addClass("xInvisible"),dialog_send_whatsapp.close(),_cpSocketComprobanteWhatApp(o)},3e3)}async function downloadReporteCPEEmitidos(e){var o=xThisCpe.$.txt_fecha.value.split("-"),u=xm_log_get("datos_org_sede")[0],o=(xThisCpe.selMesCPE=xDesMes(parseInt(o[1])-1)+" "+o[0],u.nomsede=u.sedenombre,u.ciudad=u.sedeciudad,u.userid=u.id_api_comprobante,{establecimiento:xThisCpe.selEstablecimientoCpe=u,m:o[1],y:o[0]});const _=(await _apiConsultaCpeCPE.getToken()).access_token;var C=0;xPopupLoad.titulo="Descargando...",xPopupLoad.xopen(),dataListReporte=[],xThisCpe.ListReporte=[],$.ajax({type:"POST",url:"../../bdphp/log_007.php?op=2",data:{item:o}}).done(async o=>{if(!(o=JSON.parse(o)).error){listCpeSuccessCPE=[];var t=u.ruc,a=o.data.length;xThisCpe.numRowsList=a;for(let e=0;e<a;e++){var s=o.data[e];s.estado="FACTURA"===s.tipo_doc&&0===parseInt(s.ruc)?"ANULADO":s.estado,s.style_reporte="ANULADO"===s.estado?"color: red":"color: green",s.style_td="ANULADO"===s.estado?"color: red":"";try{var i,n,p,r,d,l,c=listCpeSuccessCPE.find(e=>e.id===s.id);c?(s=c,C++):(i=-1<s.series.indexOf("F")?"01":"03",n=parseInt(s.num_doc.split("-")[1]),p=s.total.replace(/,/g,""),r={header:{ruc_receptor:s.ruc,access_token:_},body:{numRuc:t,codComp:i,numeroSerie:s.series,numero:n,fechaEmision:s.fecha,monto:p}},1==u.habilita_verificacion_cpe?!0===(d=await _apiConsultaCpeCPE.getConsulta(r))?.success?(s.success_sunat=1,l=xEstadoCpeApi(d.data.estadoCp),s.estadoCp=l.titulo,s.style_estado_sunat="color: "+l.color,C++,listCpeSuccessCPE.push(s)):(countCpeError++,s.success_sunat=0,s.estadoCp="Sin Respuesta",s.style_estado_sunat="color: black",xThisAdmContador.showRowsNoResponse=!0):(C++,listCpeSuccessCPE.push(s))),xPopupLoad.titulo="Verificando: "+C+" de "+xThisCpe.numRowsList+" Documentos.",xThisCpe.numRowsVerificadoSuccess=C,dataListReporte.push(s)}catch(e){return}}xPopupLoad.titulo="Cargando...",setDataListReporteCpe(dataListReporte)}})}function xVincularWhatsApp(){xOpenPage(60)}function setDataListReporteCpe(e){xThisCpe.ListReporte=e||dataListReporte,setTimeout(()=>{xExportarExcel()},500)}function xLoadNotasCredito(){xThisCpe.ListCpeNC=[],$.ajax({type:"POST",url:"../../bdphp/log_002.php",data:{op:"1001"}}).done(e=>{e=JSON.parse(e);xThisCpe.ListCpeNC=e.datos})}function xEstadoCpeApi(e){var o={titulo:"",color:""};switch(e?e.toString():"1"){case"0":o.titulo="NO EXISTE",o.color="purple";break;case"1":o.titulo="ACEPTADO",o.color="green";break;case"2":o.titulo="ANULADO",o.color="red";break;case"3":o.titulo="AUTORIZADO",o.color="green";break;case"4":o.titulo="NO AUTORIZADO",o.color="red"}return o}Polymer({is:"x-cpe-emitidos",properties:{ListCpe:[],ListCpeResumen:[],ListReporte:[],listSedeUsContador:[],listResumenCpeEmitidos:[],listResumenCpeEmitidosTotal:Number,nom_sede:"",isContador:!1,isReenviandoLoading:!1,showBtnSendWhatsapp:!1,numComprobanteSelected:String,selEstablecimientoCpe:Object,selMesCPE:String,NumDaysAnularCpe:Number,isShoOpNotaCredito:Boolean,desDocCpe:String,ListCpeNC:[],subscription$:Object,numRowsList:Number,numRowsVerificadoSuccess:Number},attached:function(){this.selected=0,this.isReenviandoLoading=!1,this.showBtnSendWhatsapp=!1,this.isShoOpNotaCredito=!1,this.listResumenCpeEmitidosTotal=0,xThisCpe=this,xIniCpe(),setTimeout(()=>{_cpSocketOpen()},1e3),this.subscription$=onStatusSetUsChangeSede().subscribe(e=>{1==e&&xIniCpe()})},detached:function(){_cpSocketClose(),this.subscription$.unsubscribe()},displayIndex:function(e){return xCeroIzq(parseInt(p_desde)+(e+1),1)},_isEqualTo:e=>"Registrado"===e.nom_estado&&1<e?.json_xml?.length,_isEqualToSinRegistrar:e=>"Sin Registrar"===e.nom_estado&&1<e?.json_xml?.length,_isEqualToLoading:e=>e.isReenviandoLoading,_formatMoney:function(e){return numeroConComas(e)}})</script>