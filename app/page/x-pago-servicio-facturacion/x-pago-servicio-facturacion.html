<script src="../../view/xSOAPSunat.js"defer="defer"></script><script src="../../view/socket.master.service.js"defer="defer"></script><link rel="import"href="../../x-componentes/x-comp-pago-tarjeta/x-comp-pago-tarjeta.html"><dom-module id="x-pago-servicio-facturacion"><template is="dom"><x-comp-pago-tarjeta id="compPagoTarjeta"></x-comp-pago-tarjeta><div class="p-3"><div class="xMiCard xradius"style="width:80%;max-width:950px"><div class="xEncanezadoCard"style="background:#fff0f5;color:#424242"><h3>Facturación</h3></div><div class="xContentCard border-bottom"style="padding:40px"><div><h4>Meses pendientes</h4><table width="100%"><thead><th align="left">Mes<th align="left">Plan Contratado<th align="right">Importe<tbody><template is="dom-repeat"items="{{listPagoMeses}}"as="item"><tr><td align="left">{{ item.nom_mes }}<td align="left">{{ item.plan }}<td align="right">{{ item.importe_plan }}</template><tr class="xSinBorde"><td colspan="3"align="right"><p class="fw-600">S/. {{ importeMesPlan }}</table><br><hr><br><h4>Dias transcurridos</h4><table width="100%"><thead><th align="left">Descripcion<th align="center">Dias<th align="right">Importe<tbody><tr class="xSinBorde"><td align="left">Impago<td align="center">{{ diasTranscurridos }}<td align="right"><p class="fw-600">S/. {{ importeMora }}</table><br><hr><br><h4>Pago desde la aplicación</h4><table width="100%"><thead><th align="left">Descripcion<th align="center">Transacciones<th align="right">Importe<tbody><template is="dom-repeat"items="{{listTarjetas}}"as="item"><tr class="xSinBorde"><td align="left">Pagos con tarjeta <span class="text-secondary fs-10">Pendientes de abono</span><td align="center">{{ item.cantidad }}<td align="right"><p class="fw-600">S/. {{ item.importe_debitar }}</template></table><br><hr><br><div class="div-content-grid"><div><p class="fw-600">Descargar Comprobante</p><br><p class="text-secondary fs-10">Periodo:</p><select id="compFindComprobantePago"class="selected-template-1 xCursor"onchange="selectOptionComprobantes()"><template is="dom-repeat"items="{{listComprobantes}}"as="item"><option value="[[index]]">{{item.mes}}</template></select><br><br><button hidden$="[[!isComprobanteSelected]]"class="btn btn-info"onclick="xDescargarComprobante()">Descargar Comprobante</button></div><div><table width="100%"><tr align="right"><td>Total Plan<td><p class="fw-600">S/. {{ importeMesPlan }}<tr align="right"><td>Total Dias Impagos<td><p class="fw-600">S/. {{ importeMora }}<tr align="right"><td>Reconexion<td><p class="fw-600">S/. {{ importeReconexion }}<tr align="right"><td>Total Pagos por Aplicacion <span class="fw-600 text-danger">(-)<span></span></span><td><p class="fw-600">S/. {{ importeTarjeta }}<tr align="right"><td>Total a pagar<td><p class="fw-600 fs-18">S/. {{ importeTotalPagar }}</table><br><div class="d-flexx justify-content-end"><button class="btn btn-success"hidden$="[[isviewGoCero]]"onclick="goDialogCompPagar()">Pagar</button><p class="text-success fw-600 text-right"hidden$="[[!isviewGoCero]]">Importe tarjetas es mayor que el importe pendiete. Se envio confirmacion de pago.</div><br><br></div></div></div></div></div></div></template></dom-module><style>.div-content-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(320px,1fr));grid-gap:1rem}</style><script>var xThisPageCobranzaFacturcion,xCompPagoTarjeta,comprobanteSelected,xSocketPagoServicio,dtTotales=[];function xIniPageCobranzaFacturacion(){xPopupLoad=document.getElementById("xLoad"),$("body").addClass("loaded"),xThisPageCobranzaFacturcion.isviewGoCero=!1,xThisPageCobranzaFacturcion.isComprobanteSelected=!1,(xCompPagoTarjeta=document.getElementById("compPagoTarjeta")).addEventListener("onSuccessT",a=>{xSetConfirmation(xThisPageCobranzaFacturcion.importeTotalPagar,!0)}),xCompPagoTarjeta.addEventListener("onSuccessA",a=>{xSetConfirmation(xThisPageCobranzaFacturcion.importeTotalPagar,!1,a.detail)}),loadPagoSedeServicio(),xLoadComprobantesConfirmado(),conectarSocket()}function conectarSocket(){(xSocketPagoServicio=socketService.getInstance()).connectSocket()}function notificarPagoServicio(){xSocketPagoServicio.emit("restobar-pago-servicio-on",!0)}function loadPagoSedeServicio(){dtTotales=[],$.ajax({type:"POST",url:"../../bdphp/log_005.php?op=5001"}).done(function(a){a=JSON.parse(a).datos[0],xThisPageCobranzaFacturcion.listPagoMeses=JSON.parse(a.objres)||[];var o=xThisPageCobranzaFacturcion.listPagoMeses?.length||0;dtTotales.push({des:`Importe Plan meses(${o})`,importe:a.importe_mes_plan}),xThisPageCobranzaFacturcion.listTarjetas=JSON.parse(a.objTarjetas),xThisPageCobranzaFacturcion.diasTranscurridos=a.dias_transcurridos,xThisPageCobranzaFacturcion.importeMora=a.importe_mora,0<parseFloat(a.importe_mora)&&dtTotales.push({des:`Mora dias(${a.dias_transcurridos})`,importe:a.importe_mora}),xThisPageCobranzaFacturcion.importeReconexion=a.importe_reconexion,0<parseFloat(a.importe_reconexion)&&dtTotales.push({des:"Reconexion",importe:a.importe_reconexion}),xThisPageCobranzaFacturcion.importeTarjeta=a.importe_tarjeta,0<parseFloat(a.importe_tarjeta)&&dtTotales.push({des:"Tarjetas pendientes abonar",importe:a.importe_tarjeta}),xThisPageCobranzaFacturcion.importeTotalPagar=a.importe_pagar,dtTotales.push({des:"Total a pagar",importe:a.importe_pagar}),xThisPageCobranzaFacturcion.listPagoMeses.map(a=>a.nom_mes=xDesMes(parseInt(a.mes)-1)),xThisPageCobranzaFacturcion.importeMesPlan=a.importe_mes_plan,xThisPageCobranzaFacturcion.importeTotalFacturar=a.importe_facturar,parseFloat(xThisPageCobranzaFacturcion.importeTotalPagar)<0&&xSetConfirmation()})}function xSetConfirmation(a=-1,o=!1,e=null){$.ajax({type:"POST",url:"../../bdphp/log_005.php?op=5006",data:{data:{iscard:o?1:0,i:a,st:dtTotales,impf:xThisPageCobranzaFacturcion.importeTotalFacturar,dtOtros:e}}}).done(function(a){xThisPageCobranzaFacturcion.isviewGoCero=!0,notificarPagoServicio()})}function goDialogCompPagar(){(xCompPagoTarjeta=document.getElementById("compPagoTarjeta")).xopen(xThisPageCobranzaFacturcion.importeTotalPagar)}function xLoadComprobantesConfirmado(){$.ajax({type:"POST",url:"../../bdphp/log_005.php?op=5007"}).done(function(a){xThisPageCobranzaFacturcion.listComprobantes=JSON.parse(a).datos,0<xThisPageCobranzaFacturcion.listComprobantes.length&&(comprobanteSelected=xThisPageCobranzaFacturcion.listComprobantes[0],xThisPageCobranzaFacturcion.isComprobanteSelected=!0)})}function selectOptionComprobantes(){var a=xThisPageCobranzaFacturcion.$.compFindComprobantePago.value;comprobanteSelected=xThisPageCobranzaFacturcion.listComprobantes[a],xThisPageCobranzaFacturcion.isComprobanteSelected=!0}function xDescargarComprobante(){xSoapSunat_DownloadFile("pdf",comprobanteSelected.external_id)}Polymer({is:"x-pago-servicio-facturacion",properties:{listPagoMeses:[],listTarjetas:[],listComprobantes:[],importeMesPlan:Number,importeTarjeta:Number,diasTranscurridos:Number,importeMora:Number,importeReconexion:Number,importeTotalPagar:Number,importeTotalFacturar:Number,isviewGoCero:Boolean,isComprobanteSelected:Boolean},attached:function(){this.isviewGoCero=!1,this.isComprobanteSelected=!1,xThisPageCobranzaFacturcion=this,xIniPageCobranzaFacturacion()}})</script>