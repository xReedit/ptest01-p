<dom-module id="x-producto-almacen-detalle"><link rel="import"href="../../x-componentes/x-comp-select-und-medida/x-comp-select-und-medida.html"><script src="../../view/httpFech.js"></script><script src="../../services/producto/produto-service.js"></script><template><paper-dialog modal id="dialog_additem_pro_detalle"class="dialog_redondo"modal entry-animation="scale-up-animation"style="min-width:350px"exit-animation="fade-out-animation"with-backdrop><div class="xContent"><h3>Modificar Producto</h3><br><div class="xLinea2"></div><form id="frm_item_pro"><div class="d-flexx"><div class="mr-2"><p class="m-0 fs-10 text-secondary mt-2">Descripcion</p><input id="descripcion"name="descripcion"placeholder="Descripcion"class="xMiInput xPasarEnter2"onchange="conMayusculas(this)"autofocus required espaciar><br><p class="m-0 fs-10 text-secondary mt-2">Familia</p><input id="sel_familia"name="no_post"class="xMiInput xPasarEnter2"placeholder="Familia"onchange="conMayusculas(this)"required espaciar><br><p class="m-0 fs-10 text-secondary mt-2">Codigo de barras</p><input id="codigo_barra"name="codigo_barra"placeholder="Codigo de barras"class="xMiInput xPasarEnter2"onchange="conMayusculas(this)"espaciar><br></div><div><div class="d-flexx"><div style="max-width:78px"><p class="m-0 fs-10 text-secondary mt-2">Stock</p><input id="stock"readonly="readonly"name="no_post"placeholder="Stock"class="xMiInput xPasarEnter2"onchange="conMayusculas(this)"espaciar></div><div style="max-width:78px"><p class="m-0 fs-10 text-secondary mt-2">Stock Minimo</p><input id="stock_minimo"name="stock_minimo"placeholder="Stock minimo"class="xMiInput xPasarEnter2"onchange="conMayusculas(this)"required espaciar></div><br></div><p class="m-0 fs-10 text-secondary mt-2">Precio Compra</p><input id="precio"name="precio"placeholder="Precio Compra"class="xMiInput xPasarEnter2"onchange="conMayusculas(this)"required espaciar><br><p class="m-0 fs-10 text-secondary mt-2">Precio de venta</p><input id="precio_venta"name="precio_venta"placeholder="Precio de venta x unidad"onblur="xRetornaMoneda(this)"class="xMiInput xPasarEnter2 xPrecioAddPro"onchange="conMayusculas(this)"onkeyup="xEnterInInputDlgPP(event)"required espaciar><br></div></div><div><br><paper-checkbox id="check_venta_x_peso_detalle"></paper-checkbox>Se vendará por peso<br><span class="text-secondary fs-11">Podrá modificar la cantidad en Punto de Venta.</span><br></div><div><br><paper-checkbox id="check_receta"on-change="changeCheckReceta"></paper-checkbox>Se utilizará en recetas<br><span class="text-secondary fs-11">Este producto estara disponible para las recetas.</span><br></div><div hidden$="{{!isFactorConversion}}"><p style="max-width:320px;line-height:normal"class="fs-10"><strong>Ejemplo:</strong> Si el producto es Bolsa de azucar de 5KG, en <strong>Und Kardex</strong> (Unidad de compra) se coloca KG y en <strong>cantidad por presentacion</strong> 5, y la <strong>Und de Conversión</strong> seria gramos, ya que en las recetas se utilizara en gramos.<div class="d-flexx mt-2"><div><label for="cmbUndKardex">Und Kardex</label><br><x-comp-select-und-medida id="cmbUndKardex"></x-comp-select-und-medida></div><div class="ml-2"><label for="num_cantidad_presentacion">Cantidad x Presentacion</label><br><input type="number"class="selected-template-1"placeholder="Cantidad"id="num_cantidad_presentacion"></div></div><br><label for="comboUndCosto">Und de Conversión</label><p class="text-secondary fs-10 m-0">Unidad que se utilizara en las recetas</p><x-comp-select-und-medida id="cmbUndCosto"></x-comp-select-und-medida></div><br><div class="xLinea2"></div><div class="xInvisible"><input id="idproducto"name="idproducto"> <input id="idorg"name="idorg"> <input id="idsede"name="idsede"> <input id="idproducto_familia"name="idproducto_familia"> <input id="venta_x_peso"name="venta_x_peso"> <input id="para_receta"name="para_receta"> <input id="idunidad_kardex"name="idunidad_kardex"> <input id="idunidad_conversion"name="idunidad_conversion"> <input id="cantidad_presentacion"name="cantidad_presentacion"> <input id="factor_conversion"name="factor_conversion"> <input id="costo_conversion"name="costo_conversion"></div></form><br><br><div class="xBoton2 xAzul"onclick="xGuardarModificarProducto()">Listo, guardar</div><div class="xBoton2 xPlomo"dialog-dismiss>Cancelar</div><br><br><br></div></paper-dialog><paper-dialog modal id="dialog_modificar_stock_producto"class="dialog_redondo"modal entry-animation="scale-up-animation"style="max-width:600px"exit-animation="fade-out-animation"with-backdrop><div class="xContent"><h3>Modificar Stock</h3><span class="fw-100 text-secondary fs-11">Todas las modificaciones se registrarán en el historial de cambios.</span><div class="xLinea2"></div><br><div class="d-flexx justify-content-between"><div style="max-width:90px"><p class="fs-12 text-secondary m-0">Stock Actual<p class="fs-15 fw-600">{{objproducto.stock}}</div><div class="w-50"><p class="fs-15 text-dark m-0 fw-600">Cual es el nuevo Stock?</p><input type="number"id="stock_new"placeholder="Ingrese nuevo stock"class="xMiInput xPasarEnter2"onkeyup="changeStockProducto(this.value)"onchange="changeStockProducto(this.value)"></div></div><br><p class$="{{classMsjStock}}">{{ msjStock }}</p><br><button class="btn btn-sm btn-primary"onclick="saveStockModifyProducto()">Listo, guardar</button> <button class="btn btn-sm btn-secondary"dialog-dismiss>Cancelar</button></div></paper-dialog><div><div class="d-flexx justify-content-between align-items-baseline"><div><div class="d-flexx"><div class="mr-5 xCursor"onclick="xOpenModificarDetalleProducto()"><p class="fs-12 text-secondary m-0">Descripcion<p class="fs-18 fw-600">{{objproducto.producto}}</div><div class="mr-5 xCursor"onclick="xOpenModificarDetalleProducto()"><p class="fs-12 text-secondary m-0">Familia<p class="fs-18 fw-600">{{objproducto.familia}}</div></div><br><div class="d-flexx"><div class="mr-5"><p class="fs-12 text-secondary m-0">Almacén<p class="fs-18 fw-600">{{objproducto.almacen}}</div><div class="mr-5 xCursor"onclick="dialog_modificar_stock_producto.open()"><p class="fs-12 fw-600 text-secondary m-0">Stock Actual<p class="fs-18 fw-600">{{objproducto.stock}}</div><div class="mr-5 xCursor"onclick="xOpenModificarDetalleProducto()"><p class="fs-12 fw-600 text-secondary m-0">Stock Mínimo<p class="fs-15 fw-100 text-danger">{{objproducto.stock_minimo}}</div><div class="xCursor"onclick="xOpenModificarDetalleProducto()"><p class="fs-12 fw-600 text-secondary m-0">Precio de Venta<p class="fs-15 fw-600 text-info">{{objproducto.precio_venta}}</div></div></div><div class="text-right"style="max-width:200px"><button class="btn btn-sm btn-primary"onclick="dialog_modificar_stock_producto.open()">Modificar Stock</button><br><button class="btn btn-sm btn-info mt-1"onclick="xOpenModificarDetalleProducto()"><i class="fa fa-pencil mr-1"></i> Modificar Datos</button> <button hidden$="[[!btnProductoPe]]"class="btn btn-sm btn-danger mt-1"onclick="xEliminarProductoDetalle()"><i class="fa fa-trash mr-1"></i> Eliminar</button></div></div><div><br><br><p class="fs-18 text-secondary">Historial de cambios<hr><table class="w-100"><thead><th>Fecha<th>Hora<th>Usuario<th>Movimiento<th class="text-center">Stock<tbody><template is="dom-repeat"items="{{listProductoHistorial}}"as="item"><tr><td>{{item.fecha}}<td>{{item.hora}}<td>{{item.nom_usuario}}<td><p class$="[[ item.classMovimiento ]]">{{item.tipo_movimiento}}<p class="fs-10 text-secondary">{{ item.detalle }}<td class="fw-600 text-center">{{item.cantidad}}</template></table></div></div></template></dom-module><script>var xthisProductoDetalle;let _difStockProducto=0,_msjModificarStockProducto="",_stockNowProducto=0;const productoService=new ProductoService;async function xLoadDataProductoDetalle(){xthisProductoDetalle.btnProductoPe=-1<xm_log_get("app3_us").per.indexOf("e7"),xPopupLoad.xopen(),xLoadFamiliasProducto();var o={idproducto:xthisProductoDetalle.objproducto.idproducto,idproducto_stock:xthisProductoDetalle.objproducto.idproducto_stock,idalmacen:xthisProductoDetalle.objproducto.idalmacen};const t={Venta:"fw-600 text-success",Aumenta:"fw-600 text-primary",Disminuye:"fw-600 text-danger",Compra:"fw-600 text-info","Ingreso x Distribucion":"fw-600 text-warning","Salida x Distribucion":"fw-600 text-danger","Salida de Almacen":"fw-600 text-danger","Entrada a Almacen":"fw-600 text-warning"};o=await(new httpFecht).postJson("../../bdphp/log_009.php?op=111",o),o.success&&(xthisProductoDetalle.listProductoHistorial=o.datos,xthisProductoDetalle.listProductoHistorial.map(o=>(o.classMovimiento=t[o.tipo_movimiento],o.tipo_movimiento=o.tipo_movimiento.toUpperCase(),o.showDetalle=""!==o.detalle,o))),xPopupLoad.xclose(),o=document.getElementById("cmbUndKardex");const e=document.getElementById("cmbUndCosto");o.addEventListener("onchange",o=>{e.filter(o.detail.tipo),calcFactorConversionUnd()}),e.addEventListener("onchange",o=>{calcFactorConversionUnd()})}function calcFactorConversionUnd(){var o=document.getElementById("cmbUndCosto"),t=document.getElementById("cmbUndKardex"),o=o.get(),t=t.get(),t=(num_cantidad_presentacion.value||0)*t.conversion_a_base/o.conversion_a_base;factor_conversion.value=t}function xOpenModificarDetalleProducto(){$("#frm_item_pro #descripcion").val(xthisProductoDetalle.objproducto.producto),$("#frm_item_pro #sel_familia").val(xthisProductoDetalle.objproducto.familia),$("#frm_item_pro #codigo_barra").val(xthisProductoDetalle.objproducto.codigo_barra),$("#frm_item_pro #stock").val(xthisProductoDetalle.objproducto.stock),$("#frm_item_pro #stock_minimo").val(xthisProductoDetalle.objproducto.stock_minimo),$("#frm_item_pro #precio_venta").val(xthisProductoDetalle.objproducto.precio_venta),$("#frm_item_pro #idproducto_familia").val(xthisProductoDetalle.objproducto.idproducto_familia),$("#frm_item_pro #idproducto").val(xthisProductoDetalle.objproducto.idproducto),$("#frm_item_pro #venta_x_peso").val(xthisProductoDetalle.objproducto.venta_x_peso),$("#frm_item_pro #para_receta").val(xthisProductoDetalle.objproducto.para_receta),$("#cantidad_presentacion").val(xthisProductoDetalle.objproducto.cantidad_presentacion),$("#frm_item_pro #num_cantidad_presentacion").val(xthisProductoDetalle.objproducto.cantidad_presentacion),$("#frm_item_pro #idunidad_kardex").val(xthisProductoDetalle.objproducto.idunidad_kardex),$("#frm_item_pro #idunidad_conversion").val(xthisProductoDetalle.objproducto.idunidad_conversion),$("#frm_item_pro #factor_conversion").val(xthisProductoDetalle.objproducto.factor_conversion),$("#frm_item_pro #costo_conversion").val(xthisProductoDetalle.objproducto.costo_conversion),$("#frm_item_pro #precio").val(xthisProductoDetalle.objproducto.precio);var o=document.getElementById("cmbUndKardex");document.getElementById("cmbUndCosto").set(xthisProductoDetalle.objproducto.idunidad_conversion),o.set(xthisProductoDetalle.objproducto.idunidad_kardex),check_venta_x_peso_detalle.checked="1"==xthisProductoDetalle.objproducto.venta_x_peso,check_receta.checked="1"==xthisProductoDetalle.objproducto.para_receta,num_cantidad_presentacion.value=xthisProductoDetalle.objproducto.cantidad_presentacion,xthisProductoDetalle.isFactorConversion=check_receta.checked,dialog_additem_pro_detalle.open()}function xCargarFamiliaInputProducto(){var e=$("#sel_familia");e.autocomplete({autoFocus:!0,source:xthisProductoDetalle.listFamilias,appendTo:$("#dialog_additem_pro_detalle"),select:function(o,t){return e.val(t.item.label),e.attr("data-id",t.item.value),$("#frm_item_pro #idproducto_familia").val(t.item.value),!1},focus:function(o,t){return!1},change:function(o,t){return null===t.item?(e.attr("data-value",""),e.attr("data-id",""),$("#frm_item_pro #idproducto_familia").val(""),xNewFamilia=!0):(xNewFamilia=!1,$("#frm_item_pro #idproducto_familia").val(t.item.value)),!1}})}function xLoadFamiliasProducto(){$.ajax({type:"POST",url:"../../bdphp/log.php?op=1601"}).done(function(o){o=JSON.parse(o);xthisProductoDetalle.listFamilias=o.datos,xCargarFamiliaInputProducto()})}function xGuardarModificarProducto(){calcFactorConversionUnd();const t=document.getElementById("cmbUndKardex"),e=document.getElementById("cmbUndCosto"),c=(xCan_item=$("#frm_item_pro #stock").val(),$("#frm_item_pro #idorg").val(xIdOrg),$("#frm_item_pro #idsede").val(xIdSede),xthisProductoDetalle.objproducto.stock),r=check_venta_x_peso_detalle.checked?"1":"0",a=check_receta.checked?"1":"0",d=a?num_cantidad_presentacion.value:0;$("#frm_item_pro #venta_x_peso").val(r),$("#frm_item_pro #para_receta").val(a),$("#frm_item_pro #cantidad_presentacion").val(d),$("#frm_item_pro #idunidad_kardex").val(t.get().idunidad_medida),$("#frm_item_pro #idunidad_conversion").val(e.get().idunidad_medida),$.post("../../bdphp/ManejoBD_IUD.php?tb=producto",$("#frm_item_pro").serialize(),function(o){xIdProducto_sel=o,xthisProductoDetalle.objproducto.producto=$("#frm_item_pro #descripcion").val(),xthisProductoDetalle.objproducto.familia=$("#frm_item_pro #sel_familia").val(),xthisProductoDetalle.objproducto.codigo_barra=$("#frm_item_pro #codigo_barra").val(),xthisProductoDetalle.objproducto.stock_minimo=$("#frm_item_pro #stock_minimo").val(),xthisProductoDetalle.objproducto.precio_venta=$("#frm_item_pro #precio_venta").val(),xthisProductoDetalle.objproducto.idproducto_familia=$("#frm_item_pro #idproducto_familia").val(),xthisProductoDetalle.objproducto.idproducto=$("#frm_item_pro #idproducto").val(),xthisProductoDetalle.objproducto.venta_x_peso=r,xthisProductoDetalle.objproducto.para_receta=a,xthisProductoDetalle.objproducto.idunidad_kardex=t.get().idunidad_medida,xthisProductoDetalle.objproducto.idunidad_conversion=e.get().idunidad_medida,xthisProductoDetalle.objproducto.cantidad_presentacion=d,xthisProductoDetalle.objproducto.costo_conversion=$("#frm_item_pro #costo_conversion").val(),xthisProductoDetalle.objproducto=JSON.parse(JSON.stringify(xthisProductoDetalle.objproducto)),calcCostoConversionProducto(c),dialog_additem_pro_detalle.close(),$("#frm_item_pro").reset(),xPopupLoad.xclose()})}function changeStockProducto(o){var t=parseFloat(xthisProductoDetalle.objproducto.stock);_stockNowProducto=parseFloat(o),isNaN(_stockNowProducto)?(_msjModificarStockProducto="",xthisProductoDetalle.classMsjStock=""):_stockNowProducto>t?(_difStockProducto=_stockNowProducto-t,_msjModificarStockProducto="Aumenta Stock en: "+_difStockProducto,xthisProductoDetalle.classMsjStock="fw-600 text-primary"):(_difStockProducto=t-_stockNowProducto,_msjModificarStockProducto="Disminuye Stock en: "+_difStockProducto,xthisProductoDetalle.classMsjStock="fw-600 text-danger"),xthisProductoDetalle.msjStock=_msjModificarStockProducto}function calcCostoConversionProducto(o){productoService.calcCostoConversion(xthisProductoDetalle.objproducto.idproducto,o).then(o=>{})}async function saveStockModifyProducto(){var o;xPopupLoad.xopen(),0!==_difStockProducto&&(o={idproducto:xthisProductoDetalle.objproducto.idproducto,idproducto_stock:xthisProductoDetalle.objproducto.idproducto_stock,idalmacen:xthisProductoDetalle.objproducto.idalmacen,movimiento:_msjModificarStockProducto.split(" ")[0],cantidad:_difStockProducto,stock_actual:_stockNowProducto},(await(new httpFecht).postJson("../../bdphp/log_009.php?op=11",o)).success&&(dialog_modificar_stock_producto.close(),xthisProductoDetalle.objproducto.stock=_stockNowProducto,xthisProductoDetalle.objproducto=JSON.parse(JSON.stringify(xthisProductoDetalle.objproducto)),xLoadDataProductoDetalle()),xPopupLoad.xclose())}async function xEliminarProductoDetalle(){var o=paramsSwalAlert;o.title='<p class="fw-600 fs-20">Borrar Porción</p>',o.html=`<div class="pb-2" style="display: inline-flex;">                    
                                    <p class="fs-15">Esta seguro de borrar la porción: <span class="text-warning"><strong>${xthisProductoDetalle.objproducto.producto}</strong></span>.</p>
                                </div>`,o.confirmButtonText="Si, borrar",o.showCancelButton=!0,await showAlertSwalHtmlDecision(o,1).then(async o=>{o.isConfirmed&&(o={idproducto:xthisProductoDetalle.objproducto.idproducto},(await(new httpFecht).postJson("../../bdphp/log_009.php?op=118",o)).success)&&(goMainProducto(),xLoadProductos_dt())})}Polymer({is:"x-producto-almacen-detalle",properties:{objproducto:{type:Object,notify:!0,reflectToAttribute:!0,observer:"productoChanged"},msjStock:String,classMsjStock:String,listFamilias:[],listProductoHistorial:[],btnProductoPe:Boolean,isFactorConversion:{type:Boolean,value:!1},undKarexSelected:{type:Object,notify:!0},undCostoSelected:{type:Object,notify:!0}},load:o=>{xthisProductoDetalle.objproducto=o,xLoadDataProductoDetalle()},attached:function(){this.btnProductoPe=!1,xthisProductoDetalle=this},changeCheckReceta:function(o){this.isFactorConversion=o.target.checked,dialog_additem_pro_detalle.center()}})</script>