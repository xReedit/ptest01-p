<dom-module id="x-producto-almacen-detalle"><template><paper-dialog modal id="dialog_additem_pro_detalle"class="dialog_redondo"modal entry-animation="scale-up-animation"style="min-width:350px"exit-animation="fade-out-animation"with-backdrop><div class="xContent"><h3>Modificar Producto</h3><br><br><div class="xLinea2"></div><form id="frm_item_pro"><div class="d-flexx"><div class="mr-2"><p class="m-0 fs-10 text-secondary mt-2">Descripcion</p><input id="descripcion"name="descripcion"placeholder="Descripcion"class="xMiInput xPasarEnter2"onchange="conMayusculas(this)"autofocus required espaciar><br><p class="m-0 fs-10 text-secondary mt-2">Familia</p><input id="sel_familia"name="no_post"class="xMiInput xPasarEnter2"placeholder="Familia"onchange="conMayusculas(this)"required espaciar><br><p class="m-0 fs-10 text-secondary mt-2">Codigo de barras</p><input id="codigo_barra"name="codigo_barra"placeholder="Codigo de barras"class="xMiInput xPasarEnter2"onchange="conMayusculas(this)"espaciar><br></div><div><p class="m-0 fs-10 text-secondary mt-2">Stock</p><input id="stock"readonly="readonly"name="no_post"placeholder="Stock"class="xMiInput xPasarEnter2"onchange="conMayusculas(this)"espaciar><br><p class="m-0 fs-10 text-secondary mt-2">Stock Minimo</p><input id="stock_minimo"name="stock_minimo"placeholder="Stock minimo"class="xMiInput xPasarEnter2"onchange="conMayusculas(this)"required espaciar><br><p class="m-0 fs-10 text-secondary mt-2">Precio de venta</p><input id="precio_venta"name="precio_venta"placeholder="Precio de venta x unidad"onblur="xRetornaMoneda(this)"class="xMiInput xPasarEnter2 xPrecioAddPro"onchange="conMayusculas(this)"onkeyup="xEnterInInputDlgPP(event)"required espaciar><br></div></div><div><br><paper-checkbox id="check_venta_x_peso_detalle"></paper-checkbox>Se vendará por peso<br><span class="text-secondary fs-11">Podrá modificar la cantidad en Punto de Venta.</span><br></div><br><br><div class="xLinea2"></div><div class="xInvisible"><input id="idproducto"name="idproducto"> <input id="idorg"name="idorg"> <input id="idsede"name="idsede"> <input id="idproducto_familia"name="idproducto_familia"> <input id="venta_x_peso"name="venta_x_peso"></div></form><br><br><div class="xBoton2 xAzul"onclick="xGuardarModificarProducto()">Listo, guardar</div><div class="xBoton2 xPlomo"dialog-dismiss>Cancelar</div><br><br><br></div></paper-dialog><paper-dialog modal id="dialog_modificar_stock_producto"class="dialog_redondo"modal entry-animation="scale-up-animation"style="max-width:600px"exit-animation="fade-out-animation"with-backdrop><div class="xContent"><h3>Modificar Stock</h3><span class="fw-100 text-secondary fs-11">Todas las modificaciones se registrarán en el historial de cambios.</span><div class="xLinea2"></div><br><div class="d-flexx justify-content-between"><div style="max-width:90px"><p class="fs-12 text-secondary m-0">Stock Actual<p class="fs-15 fw-600">{{objproducto.stock}}</div><div class="w-50"><p class="fs-15 text-dark m-0 fw-600">Cual es el nuevo Stock?</p><input type="number"id="stock_new"placeholder="Ingrese nuevo stock"class="xMiInput xPasarEnter2"onkeyup="changeStockProducto(this.value)"onchange="changeStockProducto(this.value)"></div></div><br><p class$="{{classMsjStock}}">{{ msjStock }}</p><br><button class="btn btn-sm btn-primary"onclick="saveStockModifyProducto()">Listo, guardar</button> <button class="btn btn-sm btn-secondary"dialog-dismiss>Cancelar</button></div></paper-dialog><div><div class="d-flexx justify-content-between align-items-baseline"><div><div class="d-flexx"><div class="mr-5 xCursor"onclick="xOpenModificarDetalleProducto()"><p class="fs-12 text-secondary m-0">Descripcion<p class="fs-18 fw-600">{{objproducto.producto}}</div><div class="mr-5 xCursor"onclick="xOpenModificarDetalleProducto()"><p class="fs-12 text-secondary m-0">Familia<p class="fs-18 fw-600">{{objproducto.familia}}</div></div><br><div class="d-flexx"><div class="mr-5"><p class="fs-12 text-secondary m-0">Almacén<p class="fs-18 fw-600">{{objproducto.almacen}}</div><div class="mr-5 xCursor"onclick="saveStockModifyProducto()"><p class="fs-12 fw-600 text-secondary m-0">Stock Actual<p class="fs-18 fw-600">{{objproducto.stock}}</div><div class="mr-5 xCursor"onclick="xOpenModificarDetalleProducto()"><p class="fs-12 fw-600 text-secondary m-0">Stock Mínimo<p class="fs-15 fw-100 text-danger">{{objproducto.stock_minimo}}</div><div class="xCursor"onclick="xOpenModificarDetalleProducto()"><p class="fs-12 fw-600 text-secondary m-0">Precio de Venta<p class="fs-15 fw-600 text-info">{{objproducto.precio_venta}}</div></div></div><div class="text-right"style="max-width:200px"><button class="btn btn-sm btn-primary"onclick="dialog_modificar_stock_producto.open()">Modificar Stock</button><br><button class="btn btn-sm btn-info mt-1"onclick="xOpenModificarDetalleProducto()"><i class="fa fa-pencil mr-1"></i> Modificar Datos</button> <button hidden$="[[!btnProductoPe]]"class="btn btn-sm btn-danger mt-1"onclick="xEliminarProductoDetalle()"><i class="fa fa-trash mr-1"></i> Eliminar</button></div></div><div><br><br><p class="fs-18 text-secondary">Historial de cambios<hr><table class="w-100"><thead><th>Fecha<th>Hora<th>Usuario<th>Movimiento<th class="text-center">Stock<tbody><template is="dom-repeat"items="{{listProductoHistorial}}"as="item"><tr><td>{{item.fecha}}<td>{{item.hora}}<td>{{item.nom_usuario}}<td><p class$="[[ item.classMovimiento ]]">{{item.tipo_movimiento}}<p class="fs-10 text-secondary">{{ item.detalle }}<td class="fw-600 text-center">{{item.cantidad}}</template></table></div></div></template></dom-module><script>var xthisProductoDetalle;let _difStockProducto=0,_msjModificarStockProducto="",_stockNowProducto=0;async function xLoadDataProductoDetalle(){xthisProductoDetalle.btnProductoPe=-1<xm_log_get("app3_us").per.indexOf("e7"),xPopupLoad.xopen(),xLoadFamiliasProducto();var o={idproducto:xthisProductoDetalle.objproducto.idproducto,idproducto_stock:xthisProductoDetalle.objproducto.idproducto_stock,idalmacen:xthisProductoDetalle.objproducto.idalmacen};const t={Venta:"fw-600 text-success",Aumenta:"fw-600 text-primary",Disminuye:"fw-600 text-danger",Compra:"fw-600 text-info","Ingreso x Distribucion":"fw-600 text-warning","Salida x Distribucion":"fw-600 text-danger","Salida de Almacen":"fw-600 text-danger","Entrada a Almacen":"fw-600 text-warning"};o=await(new httpFecht).postJson("../../bdphp/log_009.php?op=111",o);o.success&&(xthisProductoDetalle.listProductoHistorial=o.datos,xthisProductoDetalle.listProductoHistorial.map(o=>(o.classMovimiento=t[o.tipo_movimiento],o.tipo_movimiento=o.tipo_movimiento.toUpperCase(),o.showDetalle=""!==o.detalle,o))),xPopupLoad.xclose()}function xOpenModificarDetalleProducto(){$("#frm_item_pro #descripcion").val(xthisProductoDetalle.objproducto.producto),$("#frm_item_pro #sel_familia").val(xthisProductoDetalle.objproducto.familia),$("#frm_item_pro #codigo_barra").val(xthisProductoDetalle.objproducto.codigo_barra),$("#frm_item_pro #stock").val(xthisProductoDetalle.objproducto.stock),$("#frm_item_pro #stock_minimo").val(xthisProductoDetalle.objproducto.stock_minimo),$("#frm_item_pro #precio_venta").val(xthisProductoDetalle.objproducto.precio_venta),$("#frm_item_pro #idproducto_familia").val(xthisProductoDetalle.objproducto.idproducto_familia),$("#frm_item_pro #idproducto").val(xthisProductoDetalle.objproducto.idproducto),$("#frm_item_pro #venta_x_peso").val(xthisProductoDetalle.objproducto.venta_x_peso),check_venta_x_peso_detalle.checked="1"==xthisProductoDetalle.objproducto.venta_x_peso,dialog_additem_pro_detalle.open()}function xCargarFamiliaInputProducto(){var r=$("#sel_familia");r.autocomplete({autoFocus:!0,source:xthisProductoDetalle.listFamilias,appendTo:$("#dialog_additem_pro_detalle"),select:function(o,t){return r.val(t.item.label),r.attr("data-id",t.item.value),$("#frm_item_pro #idproducto_familia").val(t.item.value),!1},focus:function(o,t){return!1},change:function(o,t){return null===t.item?(r.attr("data-value",""),r.attr("data-id",""),$("#frm_item_pro #idproducto_familia").val(""),xNewFamilia=!0):(xNewFamilia=!1,$("#frm_item_pro #idproducto_familia").val(t.item.value)),!1}})}function xLoadFamiliasProducto(){$.ajax({type:"POST",url:"../../bdphp/log.php?op=1601"}).done(function(o){o=JSON.parse(o);xthisProductoDetalle.listFamilias=o.datos,xCargarFamiliaInputProducto()})}function xGuardarModificarProducto(){xCan_item=$("#frm_item_pro #stock").val(),$("#frm_item_pro #idorg").val(xIdOrg),$("#frm_item_pro #idsede").val(xIdSede);var o=check_venta_x_peso_detalle.checked?"1":"0";$("#frm_item_pro #venta_x_peso").val(o),$.post("../../bdphp/ManejoBD_IUD.php?tb=producto",$("#frm_item_pro").serialize(),function(o){xIdProducto_sel=o,xthisProductoDetalle.objproducto.producto=$("#frm_item_pro #descripcion").val(),xthisProductoDetalle.objproducto.familia=$("#frm_item_pro #sel_familia").val(),xthisProductoDetalle.objproducto.codigo_barra=$("#frm_item_pro #codigo_barra").val(),xthisProductoDetalle.objproducto.stock_minimo=$("#frm_item_pro #stock_minimo").val(),xthisProductoDetalle.objproducto.precio_venta=$("#frm_item_pro #precio_venta").val(),xthisProductoDetalle.objproducto.idproducto_familia=$("#frm_item_pro #idproducto_familia").val(),xthisProductoDetalle.objproducto.idproducto=$("#frm_item_pro #idproducto").val(),xthisProductoDetalle.objproducto=JSON.parse(JSON.stringify(xthisProductoDetalle.objproducto)),dialog_additem_pro_detalle.close(),$("#frm_item_pro").reset(),xPopupLoad.xclose()})}function changeStockProducto(o){var t=parseFloat(xthisProductoDetalle.objproducto.stock);_stockNowProducto=parseFloat(o),isNaN(_stockNowProducto)?_msjModificarStockProducto="":_stockNowProducto>t?(_difStockProducto=_stockNowProducto-t,_msjModificarStockProducto="Aumenta Stock en: "+_difStockProducto,xthisProductoDetalle.classMsjStock="fw-600 text-primary"):(_difStockProducto=t-_stockNowProducto,_msjModificarStockProducto="Disminuye Stock en: "+_difStockProducto,xthisProductoDetalle.classMsjStock="fw-600 text-danger"),xthisProductoDetalle.msjStock=_msjModificarStockProducto}async function saveStockModifyProducto(){var o;xPopupLoad.xopen(),0!==_difStockProducto&&(o={idproducto:xthisProductoDetalle.objproducto.idproducto,idproducto_stock:xthisProductoDetalle.objproducto.idproducto_stock,idalmacen:xthisProductoDetalle.objproducto.idalmacen,movimiento:_msjModificarStockProducto.split(" ")[0],cantidad:_difStockProducto,stock_actual:_stockNowProducto},(await(new httpFecht).postJson("../../bdphp/log_009.php?op=11",o)).success&&(dialog_modificar_stock_producto.close(),xthisProductoDetalle.objproducto.stock=_stockNowProducto,xthisProductoDetalle.objproducto=JSON.parse(JSON.stringify(xthisProductoDetalle.objproducto)),xLoadDataProductoDetalle()),xPopupLoad.xclose())}async function xEliminarProductoDetalle(){var o=paramsSwalAlert;o.title='<p class="fw-600 fs-20">Borrar Porción</p>',o.html=`<div class="pb-2" style="display: inline-flex;">                    
                                    <p class="fs-15">Esta seguro de borrar la porción: <span class="text-warning"><strong>${xthisProductoDetalle.objproducto.producto}</strong></span>.</p>
                                </div>`,o.confirmButtonText="Si, borrar",o.showCancelButton=!0,await showAlertSwalHtmlDecision(o,1).then(async o=>{o.isConfirmed&&(o={idproducto:xthisProductoDetalle.objproducto.idproducto},(await(new httpFecht).postJson("../../bdphp/log_009.php?op=118",o)).success)&&(goMainProducto(),xLoadProductos_dt())})}Polymer({is:"x-producto-almacen-detalle",properties:{objproducto:{type:Object,notify:!0,reflectToAttribute:!0,observer:"productoChanged"},msjStock:String,classMsjStock:String,listFamilias:[],listProductoHistorial:[],btnProductoPe:Boolean},load:o=>{xthisProductoDetalle.objproducto=o,xLoadDataProductoDetalle()},attached:function(){this.btnProductoPe=!1,xthisProductoDetalle=this}})</script>