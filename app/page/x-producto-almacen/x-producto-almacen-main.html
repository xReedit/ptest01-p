<dom-module id="x-producto-almacen-main"><link rel="import"href="../../x-componentes/x-comp-find-almacen/x-comp-find-almacen.html"><link rel="import"href="./x-producto-almacen-detalle.html"><link rel="import"href="./x-producto-familia.html"><script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script><template><style>:host{display:block;padding:16px}.hidden{display:none}</style><paper-dialog modal id="dialog_additem_pro"class="dialog_redondo"modal entry-animation="scale-up-animation"exit-animation="fade-out-animation"with-backdrop style="min-width:350px"><div class="xContent"><h3>Agregar Producto</h3><form id="frm_item_pro_alm"><label for="sel_almacen_pro">Almacen donde ingresa:</label><br><select id="sel_almacen_pro"name="no_post"class="xMiInput"></select><br><br><div class="xLinea2"></div><div class="d-flexx"><div class="mr-2"><p class="m-0 fs-10 text-secondary mt-2">Descripcion</p><input id="descripcion"name="descripcion"placeholder="Descripcion"class="xMiInput xPasarEnter2"onchange="conMayusculas(this)"autofocus required espaciar><br><p class="m-0 fs-10 text-secondary mt-2">Familia</p><input id="sel_familia_pro_alm"name="no_post"class="xMiInput xPasarEnter2"placeholder="Familia"onchange="conMayusculas(this)"required espaciar><br><p class="m-0 fs-10 text-secondary mt-2">Familia</p><input id="codigo_barra"name="codigo_barra"placeholder="Codigo de barras"class="xMiInput xPasarEnter2"onchange="conMayusculas(this)"espaciar><br><p class="m-0 fs-10 text-secondary mt-2">Stock</p><input id="stock"name="no_post"placeholder="Stock"class="xMiInput xPasarEnter2"onchange="conMayusculas(this)"espaciar required><br></div><div><p class="m-0 fs-10 text-secondary mt-2">Stock Minimo</p><input id="stock_minimo"name="stock_minimo"placeholder="Stock minimo"class="xMiInput xPasarEnter2"onchange="conMayusculas(this)"espaciar><br><p class="m-0 fs-10 text-secondary mt-2">Precio de Compra</p><input id="precio"name="precio"placeholder="Precio de compra"onblur="xRetornaMoneda(this)"class="xMiInput xPasarEnter2"onchange="conMayusculas(this)"required espaciar><br><p class="m-0 fs-10 text-secondary mt-2">Precio de Venta</p><input id="precio_venta"name="precio_venta"placeholder="Precio de venta x unidad"onblur="xRetornaMoneda(this)"class="xMiInput xPasarEnter2 xPrecioAddPro"onchange="conMayusculas(this)"required espaciar><br></div></div><div><br><paper-checkbox id="check_venta_x_peso"></paper-checkbox>Se vendará por peso<br><span class="text-secondary fs-11">Podrá modificar la cantidad en Punto de Venta.</span></div><br><br><div class="xLinea2"></div><div class="xInvisible"><input id="idproducto"name="idproducto"> <input id="idorg"name="idorg"> <input id="idsede"name="idsede"> <input id="idproducto_familia"name="idproducto_familia"> <input id="precio_unitario"name="precio_unitario"> <input id="venta_x_peso"name="venta_x_peso"></div></form><br><br><div class="xBoton2 xAzul"onclick="xGuardarItemProPP()">Listo, guardar</div><div class="xBoton2 xPlomo"dialog-dismiss>Cancelar</div><br><br><br></div></paper-dialog><div class="p-2"><br><div class="xMiCard xradius"style="width:90%;max-width:1250px"><div class="xEncanezadoCard d-flexx justify-content-between"style="background:#fff0f5;color:#424242"><div class="div-content-head-op"><p class="fw-600 fs-18">Productos en Almacen<p class="fw-100 text-secondary fs-12">Los productos que se encuentren en almacen "Bodega" apareceran en todas sus cartas, disponible para la venta.</div><div><button class="btn btn-sm btn-secondary"hidden$="[[isShowMainProducto]]"onclick="goMainProducto()">Atras</button></div></div><div class="p-3 mb-5"><div hidden$="[[!isShowMainProducto]]"><div class="d-flexx justify-content-between"><div style="max-width:300px"><x-comp-find-almacen class="mr-1"id="sel_almacen_pp"></x-comp-find-almacen><div class="mt-2"><input class="xMiInput w-100 mr-1"placeholder="Buscar por producto o familia"inline id="txt_buscar_producto_almacen"> <span class="text-secondary fs-11">Busca por nombre del producto o por su familia</span></div><div class="mt-2"><paper-checkbox id="chec_min">Ver solo stock mínimo</paper-checkbox><span class="text-secondary fs-11">Productos por debajo del stock mínimo</span></div></div><div class="text-right"><button class="btn btn-sm btn-secondary"onclick="goProductoFamilias()"><i class="fa fa-group"></i> Familias</button><br><button class="btn btn-sm btn-primary mt-1"onclick="dialog_additem_pro.open()">+ Agregar producto</button><br><button class="btn btn-sm btn-success mt-1"onclick="exportarProductosExcel()"><i class="fa fa-file-excel-o"></i> Exportar a Excel</button></div></div><br><br><br><div class="xLinea2"></div><br><table width="100%"><thead><th align="left"width="20%">Almacen<th align="left"width="20%">Familia<th align="left">Producto<th align="left"width="80px">Stock</th><template is="dom-repeat"items="{{tipoPrecios}}"as="tipo"><th align="left"width="80px">P. {{ tipo.titulo }}</template><th align="left"width="80px">Accion<tbody><template is="dom-repeat"items="{{xdt_prodcutos}}"as="item"index-as="productoIndex"><tr data-id="[[item.idproducto_stock]]"class="xCursor"style$="[[_getRowStyle(item)]]"><td>{{ item.almacen }}<td>{{ item.familia }}<td>{{ item.producto }}<td><div class="d-flexx align-items-center">{{ item.stock }}<template is="dom-if"if="[[_isStockBajo(item)]]"><i class="fa fa-exclamation-triangle text-danger ml-2"></i></template></div></td><template is="dom-repeat"items="{{item.tipo_precios}}"as="tipo"index-as="tipoIndex"><td><span on-click="mostrarInput"data-tipo-index$="{{tipoIndex}}"data-producto-index$="{{productoIndex}}">{{ tipo.precio }}</span> <input class="hidden w-50 selected-template-1"value="{{tipo.precio::input}}"data-tipo-index$="{{tipoIndex}}"data-producto-index$="{{productoIndex}}"on-blur="ocultarInput"on-change="guardarPrecio"></template><td><button data-id="[[item.idproducto_stock]]"onclick="xGoDetalleProducto(this)"class="btn btn-sm btn-xsm xBoton_flat_2">Detalle</button></template><tr><td class="fw-600 fs-18">Totales<td class="fw-600 fs-18">{{ totalProductos }}<td class="fw-600 fs-18">-<td class="fw-600 fs-18">{{ totalStockProductos }}<td class="fw-600 fs-18">-<td class="fw-600 fs-18">-</table><br><br><br></div><div hidden$="[[!isShowDetalleProducto]]"><x-producto-almacen-detalle id="view_producto_detalle"objproducto$="[[productoSeleted]]"></x-producto-almacen-detalle></div><div hidden$="[[!isShowDetalleFamilias]]"><x-producto-familia></x-producto-familia></div></div></div></div></template></dom-module><script>var xThisAlmPro;function xIniAlmacenProducto(){$("#Titulo_page").text("Almacen Productos"),$("#txt_buscar_producto_almacen").on("keyup",function(){xFilterPorductoTxtSearch(this.value)}),$("#sel_almacen_pp").on("change",function(o){xAplicarFiltrosCombinados()}),$("#chec_min").on("change",function(){xFilterPorductoStockMin(this.checked)}),xLoadProductos_dt(),xLoadFamilias(),xLoadAlmacenes(),$("body").addClass("loaded")}function xLoadProductos_dt(o){$.ajax({type:"POST",url:"../../bdphp/log.php?op=18"}).done(function(o){o=(o=JSON.parse(o).datos).map(i=>(i.stock=parseFloat(i.stock),i.tipo_precios="string"==typeof i.tipo_precios?JSON.parse(i.tipo_precios):i.tipo_precios,i.tipo_precios=xThisAlmPro.tipoPrecios.map(t=>{var o=i.tipo_precios?i.tipo_precios.find(o=>o.idtipo_precio==t.idtipo_precio):null;return{idtipo_precio:t.idtipo_precio,titulo:t.titulo,idproducto_precio:o?o.idproducto_precio:0,precio:o?o.precio.toFixed(2):"GENERAL"===t.titulo?i.precio_venta:0}}),i));xThisAlmPro.listProductosMaster=o,xThisAlmPro.xdt_prodcutos=o,xSumTotalProductoAlmacen()})}function xLoadProductos(o){xAplicarFiltrosCombinados()}function xFilterPorductoTxtSearch(o){xAplicarFiltrosCombinados()}function xFilterPorductoStockMin(o){xAplicarFiltrosCombinados()}function xAplicarFiltrosCombinados(){const a=$("#txt_buscar_producto_almacen").val().toLowerCase(),r=$("#chec_min").prop("checked"),e=sel_almacen_pp.getAlmacen()?sel_almacen_pp.getAlmacen().idalmacen:"";r?xThisAlmPro.xdt_prodcutos=xThisAlmPro.listProductosMaster.filter(o=>{var t=o.producto.toLowerCase().includes(a),i=o.familia.toLowerCase().includes(a),t=t||i,i=!r||parseFloat(o.stock_minimo)>=parseFloat(o.stock),o=!e||o.idalmacen===e;return t&&i&&o}):xThisAlmPro.xdt_prodcutos=xThisAlmPro.listProductosMaster,xSumTotalProductoAlmacen()}function xSumTotalProductoAlmacen(){xThisAlmPro.totalProductos=xThisAlmPro.xdt_prodcutos.length,xThisAlmPro.totalStockProductos=xThisAlmPro.xdt_prodcutos.reduce((o,t)=>o+parseInt(t.stock||0),0)}function exportarProductosExcel(){if(xThisAlmPro.xdt_prodcutos&&0!==xThisAlmPro.xdt_prodcutos.length)try{const r=[];r.push(["Almacén","Familia","Producto","Stock","Stock Mínimo","Unidad","Precio"]),xThisAlmPro.xdt_prodcutos.forEach(o=>{r.push([o.almacen||"",o.familia||"",o.producto||"",o.stock||"0",o.stock_minimo||"0",o.unidad||"",o.precio||"0"])});var o=XLSX.utils.book_new(),t=XLSX.utils.aoa_to_sheet(r),i=[{wch:15},{wch:15},{wch:40},{wch:10},{wch:15},{wch:10},{wch:15}],a=(t["!cols"]=i,XLSX.utils.book_append_sheet(o,t,"Productos"),"productos_almacen_"+(new Date).toISOString().slice(0,10)+".xlsx");XLSX.writeFile(o,a)}catch(o){alert("Error al exportar a Excel: "+o.message)}else alert("No hay productos para exportar")}function xGoDetalleProducto(o){const t=o.dataId;o=xThisAlmPro.listProductosMaster.filter(o=>o.idproducto_stock===t)[0];xThisAlmPro.productoSeleted=o,document.getElementById("view_producto_detalle").load(o),goDetalleProducto()}function goMainProducto(){xThisAlmPro.isShowMainProducto=!0,xThisAlmPro.isShowDetalleProducto=!1,xThisAlmPro.isShowDetalleFamilias=!1}function goProductoFamilias(){xThisAlmPro.isShowMainProducto=!1,xThisAlmPro.isShowDetalleProducto=!1,xThisAlmPro.isShowDetalleFamilias=!0}function goDetalleProducto(){xThisAlmPro.isShowMainProducto=!1,xThisAlmPro.isShowDetalleProducto=!0,xThisAlmPro.isShowDetalleFamilias=!1}function xCargarFamiliaInput(){var i=$("#sel_familia_pro_alm");i.autocomplete({autoFocus:!0,source:xThisAlmPro.listFamilias,appendTo:$("#dialog_additem_pro"),select:function(o,t){return i.val(t.item.label),i.attr("data-id",t.item.value),$("#frm_item_pro_alm #idproducto_familia").val(t.item.value),!1},focus:function(o,t){return!1},change:function(o,t){return null===t.item?(i.attr("data-value",""),i.attr("data-id",""),$("#frm_item_pro_alm #idproducto_familia").val(""),xNewFamilia=!0):(xNewFamilia=!1,$("#frm_item_pro_alm #idproducto_familia").val(t.item.value)),!1}})}function xLoadFamilias(){$.ajax({type:"POST",url:"../../bdphp/log.php?op=1601"}).done(function(o){o=JSON.parse(o);xThisAlmPro.listFamilias=o.datos,xCargarFamiliaInput()})}function xLoadAlmacenes(){$.ajax({type:"POST",url:"../../bdphp/log.php?op=1604"}).done(function(o){let t="";for(var i=JSON.parse(o).datos,a=0;a<i.length;a++)t=String(t+'<option value="'+i[a].idalmacen+'">'+i[a].descripcion+"</option>");$("#sel_almacen_pro").html(t).trigger("create"),xLoadFamilias()})}function xGuardarItemProPP(){xvalidateFormInput("frm_item_pro_alm",function(o){!1!==o&&(xPopupLoad.xopen(),xnom_familia=$("#sel_familia_pro_alm").val(),xPrecio_item=xMoneda($("#frm_item_pro_alm #precio").val()),o=check_venta_x_peso.value?"1":"0",$("#frm_item_pro_alm #venta_x_peso").val(o),1==xNewFamilia?$.ajax({type:"POST",url:"../../bdphp/log.php?op=1602",data:{f:xnom_familia}}).done(function(o){$("#frm_item_pro_alm #idproducto_familia").val(o),xGuardarItemProDtPP(),xLoadFamilias()}):xGuardarItemProDtPP())})}function xGuardarItemProDtPP(){xCan_item=$("#frm_item_pro_alm #stock").val();var o=parseFloat(xPrecio_item)/parseFloat(xCan_item);$("#frm_item_pro_alm #idorg").val(xIdOrg),$("#frm_item_pro_alm #idsede").val(xIdSede),$("#frm_item_pro_alm #precio_unitario").val(o),$.post("../../bdphp/ManejoBD_IUD.php?tb=producto",$("#frm_item_pro_alm").serialize(),function(o){xIdProducto_sel=o,$.ajax({type:"POST",url:"../../bdphp/log.php?op=1807",data:{p:xIdProducto_sel,a:sel_almacen_pro.value,c:$("#frm_item_pro_alm #stock").val()}}).done(function(o){dialog_additem_pro.close(),$("#frm_item_pro_alm").reset(),xPopupLoad.xclose(),xLoadProductos_dt()})})}async function loadTiposPrecio(){$.ajax({type:"POST",url:"../../bdphp/log_010.php?op=get-tipo-precio-producto"}).done(function(o){o=JSON.parse(o);xThisAlmPro.tipoPrecios=JSON.parse(JSON.stringify(o.datos))})}Polymer({is:"x-producto-almacen-main",properties:{listProductosMaster:[],xdt_prodcutos:[],isShowDetalleProducto:Boolean,isShowDetalleFamilias:Boolean,isShowMainProducto:Boolean,totalProductos:Number,totalStockProductos:Number,productoSeleted:[],listFamilias:[],tipoPrecios:[]},attached:async function(){this.isShowMainProducto=!0,this.isShowDetalleProducto=!1,this.isShowDetalleFamilias=!1,this.totalProductos=0,this.totalStockProductos=0,xThisAlmPro=this,await loadTiposPrecio(),xIniAlmacenProducto()},ready:()=>{this.isShowMainProducto=!0,this.isShowDetalleProducto=!1,this.isShowDetalleFamilias=!1},mostrarInput:function(o){var t=o.target.getAttribute("data-tipo-index"),i=o.target.getAttribute("data-producto-index"),t=Polymer.dom(this.root).querySelector(`input[data-tipo-index="${t}"][data-producto-index="${i}"]`),i=o.target;t&&(t.classList.remove("hidden"),i.classList.add("hidden"),t.select(),t.focus())},ocultarInput:function(o){var t=o.target.getAttribute("data-tipo-index"),i=o.target.getAttribute("data-producto-index"),o=o.target,t=Polymer.dom(this.root).querySelector(`span[data-tipo-index="${t}"][data-producto-index="${i}"]`);o&&(o.classList.add("hidden"),t.classList.remove("hidden"))},guardarPrecio:function(o){var t=o.target.getAttribute("data-tipo-index"),i=o.target.getAttribute("data-producto-index"),o=o.target.value,a=(this.set(`xdt_prodcutos.${i}.tipo_precios.${t}.precio`,o),this.xdt_prodcutos[i].idproducto_stock),r=this.xdt_prodcutos[i].idproducto,e=this.xdt_prodcutos[i].tipo_precios[t],a={idproducto_stock:a,idproducto:r,idtipo_precio:e.idtipo_precio,idproducto_precio:e.idproducto_precio||0,precio:o,titulo:e.titulo};$.ajax({type:"POST",url:"../../bdphp/log_010.php?op=set-tipo-precio-producto",data:JSON.stringify(a)}).done(function(o){o=JSON.parse(o),xThisAlmPro.xdt_prodcutos[i].tipo_precios[t].idproducto_precio=o.idproducto_precio})},_isStockBajo:function(o){return o.stock<o.stock_minimo}})</script>