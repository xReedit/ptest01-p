<link rel="import"href="../../web_components/polymer/polymer.html"><link rel="import"href="../../x-componentes/x-comp-list-repartidor/x-comp-list-repartidor.html"><link rel="import"href="../../web_components/x-pago/x-pago.html"><link rel="import"href="../x-configuraciones/x-config-costo-delivery-sede/x-config-costo-delivery-sede.html"><dom-module id="x-control-delivery"><link rel="stylesheet"href="../../../css/searchableOptionList.css"><script src="../../../js/searchableOptionList.js"></script><template is="dom-bind"><paper-dialog id="dialog_comprobante_delivery"class="dialog_redondo"style="min-width:320px"entry-animation="scale-up-animation"exit-animation="fade-out-animation"with-backdrop><div class="xContent"style="padding:0 20px 0 5px"id="content_xpago_delivery"></div></paper-dialog><paper-dialog id="dialog_registrar_pago_repartidor"class="dialog_redondo"style="min-width:320px"entry-animation="scale-up-animation"exit-animation="fade-out-animation"with-backdrop><div class="xContent"style="padding:0 20px 0 5px"id="content_xpago_repartidor"></div></paper-dialog><div class="p-3"style="max-width:1200px!important;min-width:750px!important;margin:0 auto"><div class="d-flexx justify-content-between align-items-center mb-1"><h3>Control de Delivery</h3><div class="d-flexx"><button class="btn btn-sm btn-primary"id="btn_config_costo_delivery"onclick="xConfigCostoDeliveryTiendaLinea()"><i class="fa fa-cog"aria-hidden="true"></i> Costo de Entrega</button> <button class="btn btn-sm btn-secondary ml-1 xInvisible"id="btn_vista_delivery"onclick="xVistaAnteriorDelivery()">Vista Anterior</button></div></div><div class="d-flexx w-100 justify-content-between flex-wrap"><div><paper-tabs selected="{{selectedTab}}"id="select_tab_cd"><paper-tab selected="0"><i class="fa fa-list mr-1"></i> Pedidos</paper-tab><paper-tab><i class="fa fa-motorcycle mr-1"></i> Repartidores</paper-tab></paper-tabs><div class="xLinea2 w-100"></div></div><div class="div-info mb-1"><div class="div-border mr-1 text-center p-2"><p class="fw-600 fs-25">{{ arrInfo.num_pedidos }}<p class="fs-12">Pedidos</div><div class="div-border mr-1 d-flexx text-center"><div class="p-2 text-center"><p class="fw-600 text-info fs-18">{{ arrInfo.num_asignados }}<p class="fs-12">Asignados</div><div class="p-2 text-center"><p class="fw-600 fs-18">{{ arrInfo.num_asignar }}<p class="fs-12">Sin Asignar</div></div><div class="div-border mr-1 d-flexx text-center"><div class="p-2 text-center"><p class="fw-600 fs-18">{{ arrInfo.num_proceso }}<p class="fs-12">En Proceso</div><div class="p-2 text-center"><p class="fw-600 fs-18 text-warning">{{ arrInfo.num_camino }}<p class="fs-12">En Camino</div><div class="p-2 text-center"><p class="fw-600 fs-18 text-success">{{ arrInfo.num_entregados }}<p class="fs-12">Entregados</div></div><div class="div-border text-center p-2"><p class="fw-600 fs-25">S/. {{ arrInfo.importe }}<p class="fs-12">Importe</div></div></div><iron-pages selected="{{selectedTab}}"><div id="lista"><div class="div-border div-filter"><div><p class="fw-900">Ver Desde</p><input class="selected-template-1 xCursor"id="txt_fecha_delivery"placeholder="Elige fecha"></div><div><p class="fw-900">Buscar Cliente</p><input placeholder="Nombre o teléfono"class="selected-template-1 w-100"onkeyup="xCDFilterCliente(this)"></div><div style="width:95%"><p class="fw-900">Filtro<div class="content-div-filtro"><select class="js-select2 selected-template-1"id="seletecFilter"multiple="multiple"><optgroup label="Tipo de Pago"><template is="dom-repeat"items="{{listTipoPagoFilter}}"as="item"><option value$="[[item]]">{{item.descripcion}}</template><optgroup label="Usuario"><template is="dom-repeat"items="{{listUsuarioFilter}}"as="item"><option value$="[[item]]">{{item.descripcion}}</template><optgroup label="Repartdior"><template is="dom-repeat"items="{{listRepartidorFilter}}"as="item"><option value$="[[item]]">{{item.nom_repartidor}}</template><optgroup label="Estado"><template is="dom-repeat"items="{{listEstadoFilter}}"as="item"><option value$="[[item]]">{{item.descripcion}}</template><optgroup label="Condición"><template is="dom-repeat"items="{{listCondicionFilter}}"as="item"><option value$="[[item]]">{{item.descripcion}}</template></select></div></div></div><table class="w-100 content-table-delivery"><thead><th class="fw-900"align="center">#<th class="fw-900"align="left">Fecha<th class="fw-900"align="left">Cliente<th class="fw-900"align="right"style="max-width:100px">Importe<th class="fw-900"align="center">Usuario<th class="fw-900"align="left">Repartidor<th class="fw-900"align="left">Estado<th class="fw-900"align="right">Acción<tbody><template is="dom-repeat"items="{{listDeliveryPedidoFilter}}"as="item"><tr data-id="[[item.idpedido]]"class$="[[item.classNewRow]]"><td class="fw-700 fs-18"align="center">{{item.num}}<td><p>{{item.fecha}}<p>{{item.hora}}<p class="fw-700 fs-11">ID: {{item.idpedido}}<td style="max-width:250px"><p class="fw-600">{{item.nom_cliente}}<p>{{item.direccion_cliente}}<div><div class="d-inline-flex xCursor"title="Escribir al WhastApp"onclick='xCDGoWhastAppNumber(this,"cliente")'><p class="fw-700 text-info">{{item.tel_cliente}}<p class="text-success fs-14 ml-1"><i class="fa fa-whatsapp"></i></div></div><td align="right"><p class$="[[ item.classtp ]] fs-11"><span class="fw-100">{{item.paga_con}} {{item.total}}</span></p><br><button hidden$="[[item.isShowNumComprobante]]"class="btn btn-sm fs-12 btn-flat sky mt-1"onclick="xCDOpenEmitirComprobante(this)">Facturar</button><p hidden$="[[!item.isShowNumComprobante]]"class="fw-600 fs-14"><i class="fa fa-file-text-o text-primary"></i> {{item.num_comprobante}}<td align="center"><p hidden$="[[ item.showApp ]]">{{item.usuario}}<p hidden$="[[ !item.showApp ]]"class="badge badge-success">APP<td><div hidden$="[[ item.showRepartidor ]]"><div hidden$="[[item.isShowLoaderSearchRepartor]]"><p class="badge badge-secondary">No Asignado</p><br><button onclick="xCDLoaderSolicitaRepartidorPapaya(this)"hidden$="[[!item.isShowCallRepartidor]]"class="btn btn-sm fs-12 btn-flat green mt-1"><i class="fa fa-motorcycle"></i> Solicitar Repartidor</button> <button onclick="xCDOpenListRepartidor(this)"class="btn btn-sm fs-12 btn-flat sky mt-1">Asignar</button></div><div hidden$="[[!item.isShowLoaderSearchRepartor]]"style="width:60px;line-height:1"class="text-center"><span class="fs-15"><i class="fa fa-motorcycle"></i></span><p class="fw-600 m-0 fs-11">Buscando Repartidor</p><paper-progress indeterminate class="w-100"></paper-progress><button onclick="xCDCancelarSolicitarRepartidorPapaya(this)"class="btn btn-sm fs-9 fw-600 btn-flat red mt-1">Cancelar</button></div></div><div hidden$="[[ !item.showRepartidor ]]"><p class="fw-600">{{item.nom_repartidor}}<p hidden$="[[!item.isRepartidorPapaya]]"class="badge bg-papaya">Papaya Express<p hidden$="[[item.isRepartidorPapaya]]"class="badge badge-danger">Mi Red<div><div class="d-inline-flex xCursor"title="Escribir al WhastApp"onclick='xCDGoWhastAppNumber(this,"repartidor")'><p class="fw-700 text-info">{{item.tel_repartidor}}<p class="text-success fs-14 ml-1"><i class="fa fa-whatsapp"></i></div></div></div><td><p class$="[[ item.classEstado ]]">{{ item.labelEstado }}<div hidden$="[[ !item.isShowPedidoCobrado ]]"><p class="badge badge-success"><i class="fa fa-check"></i> Pagado</div><div hidden$="[[ !item.isShowPedidoAnulado ]]"><p class="badge badge-danger"><i class="fa fa-check"></i> Anulado</div><td align="right"><div hidden$="[[ item.isShowPedidoCobrado ]]"><button class="btn btn-sm fs-12 btn-flat sky"onclick="xCDOpenDetallePedido(this)">Abrir</button></div></template></table></div><div id="repartidor"class="mb-2 div-border"><div class="p-5"><table style="margin:0 auto"><thead><th>Repartidor<th align="center">Pedidos<th>Metodo Pago<th align="right">Importe Total<th align="right"><p>Costo Delivery<p class="fs-9 text-secondary">Comisión para repartidor<th align="right"><p>Total<p class="fs-9 text-secondary">Total - Delivery<th align="right"><p>Por Pagar<p class="fs-9 text-secondary">Importe total a pagar</thead><body><template is="dom-repeat"items="{{listResumenDelivery}}"as="item"><tr><td><p class="fw-600">{{item.nom_repartidor}}<p hidden$="[[!item.isRepartidorPapaya]]"class="badge bg-papaya">Papaya Express<p hidden$="[[item.isRepartidorPapaya]]"class="badge badge-danger">Mi Red<div><div class="d-inline-flex xCursor"title="Escribir al WhastApp"onclick='xCDGoWhastAppNumber(this,"repartidor")'><p class="fw-700 text-info">{{item.tel_repartidor}}<p class="text-success fs-14 ml-1"><i class="fa fa-whatsapp"></i></div></div><td align="center"><p class="fw-600 fs-18">{{ item.cant_pedidos }}<td><template is="dom-repeat"items="{{item.pedidos.metodoPago}}"as="tp"><div class="d-flexx justify-content-between"><p class="mr-1">{{ tp.descripcion }}<p>{{ convertRowFixed(tp.importe) }}</div></template><td align="right"><p class="fw-600 fs-18">{{ item.pedidos.importe_total }}<td align="right"class="fw-600 fs-18">{{ item.pedidos.entrega }}<td align="right"><p class="fw-600 fs-18">{{ item.pedidos.total }}<div class="fw-600 fs-14 text-warning"hidden$="[[!item.pedidos.showImportePagado]]"><span class="fs-10">Pagado: </span><span>{{ item.pedidos.importe_pagado }}</span></div><td align="right"class="fw-600 fs-18"><div hidden$="[[!item.pedidos.showBtnRegistroPago]]"><p class="fw-600 fs-18">{{ item.pedidos.importe_pagar }}</p><button data-id="{{item}}"class="btn btn-sm fs-11 btn-flat sky mt-1"onclick="xRegistrarPagoRepartidor(this)">Registrar Pago</button></div><div class="text-center"hidden$="[[item.pedidos.showBtnRegistroPago]]"><i class="fa fa-check text-success fa-2x"></i></div></template><tr><td colspan="3"class="p-3 fs-18">Total<td align="right"><p class="fw-600 fs-18">{{convertRowFixed(listResumenDeliveryTotales.importe_total)}}<td align="right"class="fw-600 fs-18">{{convertRowFixed(listResumenDeliveryTotales.entrega)}}<td align="right"class="fw-600 fs-18">{{convertRowFixed(listResumenDeliveryTotales.total)}}<td align="right"class="fw-600 fs-18">{{convertRowFixed(listResumenDeliveryTotales.importe_pagar)}}</table></div></div></iron-pages></div></template><style>.btn-row-delivery{border:0;border-radius:5px;color:#fff;cursor:pointer;font-size:11px}.bg-papaya{background:#571c86;color:#fff}.btn-flat{opacity:.8}.btn-flat.blue{background:#d0e6f0;border:solid 1px #81d4fa}.btn-flat.green{background:#bfefc1;border:solid 1px #81fa8a}.btn-flat.sky{background:#b1eef8;border:solid 1px #46d9f2}.btn-flat.red{background:#f8c2c2;border:solid 1px #e66060}.btn-flat:hover{opacity:1}.content-table-delivery{padding:15px 0;background:#fff;border-radius:8px;border:1px solid #e0e0e0}.content-table-delivery tr>td{border-bottom:8px solid #e5e5e7}.container-list{border:2px solid #ccc;width:300px;height:auto;overflow-y:scroll;background:#fff}.sol-container{display:flex!important}.div-border{background:#fff;border-radius:8px;border:1px solid #e0e0e0}.div-filter{display:grid;grid-template-columns:1fr 3fr 3fr;column-gap:30px;padding:20px;margin-bottom:10px;align-items:center}.div-info{display:flex;justify-content:flex-end}</style></dom-module><script>var xThisCDelivery,repartidorListSeleted,htmlDivPagoCP,xRpt_pagoCD,lastIdPedidoDeliverySearch=0,xfecha_delivery_selected="";function xIniControlDelivery(){xThisCDelivery.arrSedeInfo=xm_log_get("datos_org_all_sede")[0],$(".js-select2").select2({placeholder:"Aplicar Filtro",allowHtml:!0,allowClear:!0,tags:!0,width:"100%"}),$(".js-select2").on("change",e=>{xCDSetFilterList([...e.target.selectedOptions].map(e=>JSON.parse(e.value)))}),compPickDateDelivery=$("#txt_fecha_delivery").pickadate({format:"dd mmm yyyy",today:"Hoy",clear:"Todos",close:"Cerrar",onSet:function(e){xCDSearchAllPedidos(e.select?new Date(e.select).toLocaleDateString():"")}}),xPopupLoad.xopen(),$(document).on("selected",".comp-list-repartidor",function(e){repartidorListSeleted=e.detail}),$("#dialog_comprobante_delivery").on("iron-overlay-closed",function(){xbuscar_mesa=!1,xCDRestaurarXPagoCP()}),$("#dialog_detalle").on("iron-overlay-opened",function(){xbuscar_mesa=!0}),$("#select_tab_cd").on("iron-select",function(e){1===xThisCDelivery.selectedTab&&xCDRepartidorResumen(),e.stopPropagation(),e.stopImmediatePropagation()}),xCDSearchAllPedidos(),xCDgetAllRepartidor()}function xCDSearchAllPedidos(e=""){""==e&&(e=xDevolverFecha(),txt_fecha_delivery.value=e),$.ajax({type:"POST",url:"../../bdphp/log_009.php?op=7",data:{fecha:e}}).done(function(e){e=JSON.parse(e),xThisCDelivery.listDeliveryPedido=xCDCocinarDataItemPedido(e.datos),xPopupLoad.xclose(),xCDSetChangeListDelivery()})}function xCDSearchItemPedido(e){e=e?{idpedido:e}:"";$.ajax({type:"POST",url:"../../bdphp/log_009.php?op=7",data:{obj:e}}).done(function(e){e=xCDCocinarDataItemPedido((e=JSON.parse(e)).datos,!0);xThisCDelivery.listDeliveryPedido.unshift(e[0]),xCDSetChangeListDelivery()})}function xGetClassTpDelivery(e){return["badge badge-secondary","badge badge-primary","badge bg-papaya","badge","badge badge-warning","badge badge-info","badge badge-dark"][parseInt(e)-1]}function xCDCocinarDataItemPedido(e,o=!1){var a=o?xThisCDelivery.listDeliveryPedido.length+1:e.length;const d=o?"animated fadeIn":"",s="1"===xThisCDelivery.arrSedeInfo.pwa_delivery_reparto_solo_app,p="1"===xThisCDelivery.arrSedeInfo.pwa_delivery_servicio_propio;o="1"===xThisCDelivery.arrSedeInfo.pwa_habilitar_busqueda_mapa;xThisCDelivery.arrSedeInfo.pwa_delivery_hablitar_calc_costo_servicio;const l="1"===xThisCDelivery.arrSedeInfo.pwa_delivery_habilitar_llamar_repartidor_papaya;var n=o&&!p;return e.map(e=>{var o,i=!(!e.json_datos_delivery&&""===e.json_datos_delivery),r=(e.isDataJson=i,e.json_datos_delivery=i?JSON.parse(e.json_datos_delivery):[],o=i?e.json_datos_delivery.p_header.arrDatosDelivery:[],e.isFlagPedidoPagado="1"==e.flag_pedido_pagado,e.showRepartidor=!!e.nom_repartidor,e.isRepartidorPapaya="0"===e.sede_repartidor,e.isRepartidorPapaya=e.idrepartidor?e.isRepartidorPapaya:null,e.nom_repartidor=e.showRepartidor?toTitleCase(e.nom_repartidor):"",e.isShowCallRepartidor=i&&l,e.isShowLoaderSearchRepartor="1"==e.flag_solicita_repartidor_papaya,e.isShowBtnCancelarSolicitud=!1,e.isShowBtnCancelarSolicitudContador=0,e.paga_con=e.isRepartidorPapaya?i?o.metodoPago.descripcion:"--":e.isFlagPedidoPagado?primeraConMayusculas(e.des_tp_local)||"--":i?primeraConMayusculas(o.metodoPago.descripcion):"--",e.idtipo_pago=!e.isRepartidorPapaya&&e.isFlagPedidoPagado?e.idtipo_pago_local||1:i?o.metodoPago.idtipo_pago:1,e.classtp=xGetClassTpDelivery(e.idtipo_pago),i&&(o.direccion=o.direccion||""),e.nom_cliente=toTitleCase(e.nom_cliente),e.direccion_cliente=i?toTitleCase(o.direccion):"--",e.tel_cliente=i?o.telefono:"--",e.showApp=1==e.flag_is_cliente,(n=e.showApp&&!n?s:n)&&(e.pwa_delivery_habilitar_llamar_repartidor_papaya="1",e.flag_solicita_repartidor_papaya="1"),i&&(o=e.json_datos_delivery.p_subtotales,o=p?o:darFormatoSubTotalesDelivery(o),e.json_datos_delivery.p_subtotales=o,e.total=o.filter(e=>"TOTAL"===e.descripcion.toUpperCase())[0].importe,e.total=parseFloat(e.total).toFixed(2)),"En Proceso"),t="badge badge-secondary";switch(e.pwa_estado){case"R":r="En Camino",t="badge badge-warning";break;case"E":r="Entregado",t="badge badge-success"}return e.classEstado=t,e.labelEstado=r,e.isShowPedidoCobrado="2"==e.estado,e.isShowPedidoAnulado="3"==e.estado,e.num_comprobante=i?e.json_datos_delivery.p_header.num_comprobante:null,e.isShowNumComprobante=!!e.num_comprobante,e.num=a,e.classNewRow=d,a--,e})}function xCDLoaderSolicitaRepartidorPapaya(e){e=xCDGetItemListDelivery(e);e.flag_solicita_repartidor_papaya=1,e.isShowLoaderSearchRepartor=!0,e.isShowBtnCancelarSolicitud=!0,e.isShowBtnCancelarSolicitudContador=6,xCDSetChangeListDelivery(e),xCDTimerShowBtnCancelSOlicitudRepartidor(e.idpedido)}function xCDTimerShowBtnCancelSOlicitudRepartidor(e){const o=xCDGetItemListDeliveryById(e),i=setInterval(()=>{o.isShowBtnCancelarSolicitudContador--,0===o.isShowBtnCancelarSolicitudContador&&(xCDSolicitarRepartidorPapaya(o.idpedido),xCDSetChangeListDelivery(o),clearInterval(i))},1e3)}async function xCDSolicitarRepartidorPapaya(e){e=xCDGetItemListDeliveryById(e);e.isShowLoaderSearchRepartor&&(e.flag_solicita_repartidor_papaya=1,e.isShowLoaderSearchRepartor=!0,xCDSetChangeListDelivery(e),(await xCDUpdatePedidoDelivery({op:8,opcion:1,idpedido:e.idpedido})).success)&&_cpSocketComercioLLamaRepartidorPapaya()}async function xCDCancelarSolicitarRepartidorPapaya(e){e=xCDGetItemListDelivery(e),e.isShowLoaderSearchRepartor=!1,xCDSetChangeListDelivery(e),e={op:8,opcion:2,idpedido:e.idpedido};await xCDUpdatePedidoDelivery(e)}function xCDGetItemListDelivery(e){return xCDGetItemListMasterDeliveryById($(e).parents("tr").get(0).dataId)}function xCDGetItemListDeliveryById(o){try{var e=xThisCDelivery.listDeliveryPedidoFilter.find(e=>e.idpedido.toString()===o.toString());if(e)return xCDGetItemListMasterDeliveryById(e.idpedido)}catch(e){}}function xCDGetItemListMasterDeliveryById(o){return xThisCDelivery.listDeliveryPedido.find(e=>e.idpedido.toString()===o.toString())}function xCDSetChangeListDelivery(e=0){xThisCDelivery.listDeliveryPedido=JSON.parse(JSON.stringify(xThisCDelivery.listDeliveryPedido)),xThisCDelivery.listDeliveryPedidoFilter=xThisCDelivery.listDeliveryPedido,xCDGetListFilter()}async function xCDUpdatePedidoDelivery(e){return(new httpFecht).postJson("../../bdphp/log_009.php",e)}function xCDUpdateViewItem(e,o,i=!0){var r=xCDFindItemListById(o.idpedido);switch(e){case"repartidor":r.idrepartidor=o.idrepartidor,r.nom_repartidor=toTitleCase(o.repartidor_nom),r.tel_repartidor=o.repartidor_telefono,r.isShowLoaderSearchRepartor=!1,r.isRepartidorPapaya=i,r.showRepartidor=!0,r.pwa_estado="R",r.labelEstado="En Camino",r.classEstado="badge badge-warning";break;case"repartidor-entregado":r.pwa_estado="E",r.labelEstado="Entregado",r.classEstado="badge badge-success"}xCDSetChangeListDelivery(r)}function xCDFindItemListById(o){return xThisCDelivery.listDeliveryPedido.find(e=>e.idpedido==o)}async function xCDOpenListRepartidor(e){var o=paramsSwalAlert,o=(o.html='<p class="fs-19 fw-600">Asignar A:</p><br><x-comp-list-repartidor class="comp-list-repartidor" id="compListRepartidor"></x-comp-list-repartidor>',o.showCancelButton=!0,await showAlertSwalHtmlDecision(o));o.isConfirmed&&(o=xCDGetItemListDelivery(e),repartidorListSeleted.idpedido=o.idpedido,repartidorListSeleted.repartidor_nom=repartidorListSeleted.nombre,repartidorListSeleted.repartidor_telefono=repartidorListSeleted.telefono,xCDUpdateViewItem("repartidor",repartidorListSeleted,!1),xCDAsignarRepartidorManual(repartidorListSeleted,o))}function xCDAsignarRepartidorManual(i,r){$.ajax({type:"POST",url:"../../bdphp/log_005.php?op=1301",data:{idrepartidor:i.idrepartidor,idpedido:r.idpedido}}).done(function(e){r.idrepartidor=i.idrepartidor,_cpSocketNoiticaRepartidorFromComercio(r);try{var o=[{nombre:r.json_datos_delivery.p_header.arrDatosDelivery.nombres,telefono:r.json_datos_delivery.p_header.arrDatosDelivery.telefono,establecimiento:r.json_datos_delivery.p_header.arrDatosDelivery.establecimiento.nombre,idpedido:r.idpedido,repartidor_nom:i.nombre,repartidor_telefono:i.telefono}];_cpSocketNoiticaClienteRepartidorAsignado(o)}catch(e){}})}function xCDOpenDetallePedido(e){var o=xCDGetItemListDelivery(e);xThisCDelivery.lastObjBtnVer=$(e).parents("tr"),$(e).attr("data-numpedido",o.numpedido),$(e).attr("data-correlativo",o.correlativo_dia),$(e).attr("data-idcat",o.idcategoria),$(e).attr("data-from","control-delivery"),$(e).attr("data-isconfirmarpago","0"),$(e).attr("data-nummesa","0"),xThisCDelivery.rowItemSeleted=o,xLoadDetallesPedido(e)}function xCDOpenEmitirComprobante(e){const o=xCDGetItemListDelivery(e);xThisCDelivery.rowItemSeleted=o,$("#div_pago").empty(),$("#content_xpago_delivery").html('<x-pago id="component_pago_delivery"></x-pago>').trigger("create"),xPopupLoad.xopen(),setTimeout(()=>{xbuscar_mesa=!0,(xComoPagoDelivery=document.getElementById("component_pago_delivery")).addEventListener("xSend",function(e){xRpt_pagoCD=e.detail.xRpts}),xComoPagoDelivery.addEventListener("xCancelarCerrar",function(e){dialog_comprobante_delivery.close()}),xComoPagoDelivery.addEventListener("xListoRegistraPago",function(e){xCDGoEmitirComprobante()}),xComoPagoDelivery.addEventListener("xSelectTipoComprobante",function(e){dialog_comprobante_delivery.center()}),xComoPagoDelivery.addEventListener("xFormClienteValid",function(e){dialog_comprobante_delivery.center()}),component_pago_delivery.setVal(xMoneda(parseFloat(o.total))),component_pago_delivery.setTelefonoCliente(o.tel_cliente),component_pago_delivery.setModoSoloComprobante(),xPopupLoad.xclose(),dialog_comprobante_delivery.open()},500)}function xCDRestaurarXPagoCP(){$("#content_xpago_delivery").empty(),$("#content_xpago_repartidor").empty(),setTimeout(()=>{$("#div_pago").html('<x-pago id="component_pago"></x-pago>').trigger("create")},500)}function xCDQuitarXPagoCP(){$("#div_pago").empty()}function xCDGoEmitirComprobante(){var i=xRpt_pagoCD[0].cliente,r=xRpt_pagoCD[0].comprobante,e=xThisCDelivery.rowItemSeleted.json_datos_delivery.p_body;const t=xThisCDelivery.rowItemSeleted.json_datos_delivery.p_subtotales,a=xEstructuraItemsJsonPedidoDelivery(e);xPopupLoad.xopen(),$.ajax({type:"POST",url:"../../bdphp/log_001.php",data:{p_from:"fe",p_comprobante:r,idregistro_pago:"0"}}).done(function(e){var e=xm_all_SetResponseLog_001(e),o=(r.correlativo=xCeroIzqNumComprobante(e.correlativo_comprobante),xCocinarImprimirComprobante(a,t,r,i,0,-2),xCDGetItemListDeliveryById(xThisCDelivery.rowItemSeleted.idpedido));o.num_comprobante=""+r.descripcion.substr(0,1).toUpperCase()+r.serie+"-"+e.correlativo_comprobante,o.isShowNumComprobante=!0,xCDSetChangeListDelivery(o),$.ajax({type:"POST",url:"../../bdphp/log_002.php",data:{op:"12",id:o.idpedido,num_comprobante:o.num_comprobante}}),dialog_comprobante_delivery.close(),xPopupLoad.xclose()})}function xCDRemoveItemRow(e){var o=xCDGetItemListDeliveryById(e.idpedido);o&&((o=xUpdateMetodoPagoDelivery(o,e.p_tipo_pago[0])).estado=2,o.isShowPedidoCobrado=!0,xCDSetChangeListDelivery(o),xCDRepartidorResumen())}function xUpdateMetodoPagoDelivery(e,o){return e.idtipo_pago=o.id,e.paga_con=o.des_tp,e.classtp=xGetClassTpDelivery(o.id),e.idtipo_pago_local=o.id,e.des_tp_local=o.des_tp,e.json_datos_delivery.p_header.arrDatosDelivery.metodoPago=o,e}function xCDAddItemRow(e){lastIdPedidoDeliverySearch.toString()===e.idpedido.toString()||xCDGetItemListDeliveryById(lastIdPedidoDeliverySearch=e.idpedido)||xCDSearchItemPedido(lastIdPedidoDeliverySearch)}function xCDgetAllRepartidor(){$.ajax({type:"POST",url:"../../bdphp/log_005.php?op=13"}).done(function(e){e=JSON.parse(e),xThisCDelivery.listRepartidor=e.datos})}function xCDGoWhastAppNumber(e,o){var i,r,e=xCDGetItemListDelivery(e),o=("repartidor"==o&&(i=e.tel_repartidor,r=e.nom_repartidor),"cliente"==o&&(i=e.nom_cliente,r=e.tel_cliente),"Hola%20"+r+"%20");window.open("https://api.whatsapp.com/send?phone=51"+i+"&text="+o).focus()}function xCDGetListFilter(){xThisCDelivery.listTipoPagoFilter=[],xThisCDelivery.listRepartidorFilter=[],xThisCDelivery.listUsuarioFilter=[],xThisCDelivery.listDeliveryPedido.map(o=>{var e;xThisCDelivery.listTipoPagoFilter.find(e=>e.idtipo_pago.toString()===o.idtipo_pago.toString())||(e={idtipo_pago:o.idtipo_pago,descripcion:o.paga_con,cod:"T-"+o.idtipo_pago,key:"idtipo_pago",value:o.idtipo_pago},xThisCDelivery.listTipoPagoFilter.push(e)),!xThisCDelivery.listRepartidorFilter.find(e=>e.idrepartidor==o.idrepartidor)&&o.idrepartidor&&(e=o.nom_repartidor+(o.isRepartidorPapaya?" - Red Papaya":" - Mi Red"),e={idrepartidor:o.idrepartidor,nom_repartidor:e,red:o.isRepartidorPapaya,cod:"R-"+o.idrepartidor,key:"idrepartidor",value:o.idrepartidor},xThisCDelivery.listRepartidorFilter.push(e))}),xThisCDelivery.listRepartidorFilter.unshift({idrepartidor:0,nom_repartidor:"Red Papaya",key:"isRepartidorPapaya",value:!0}),xThisCDelivery.listRepartidorFilter.unshift({idrepartidor:0,nom_repartidor:"Mi Red",key:"isRepartidorPapaya",value:!1}),xThisCDelivery.listRepartidorFilter=JSON.parse(JSON.stringify(xThisCDelivery.listRepartidorFilter)),xThisCDelivery.listTipoPagoFilter=JSON.parse(JSON.stringify(xThisCDelivery.listTipoPagoFilter)),xThisCDelivery.listUsuarioFilter=[{id:0,descripcion:"Usuario",cod:"U-0",key:"flag_is_cliente",value:"0"},{id:1,descripcion:"APP",cod:"U-1",key:"flag_is_cliente",value:"1"}],xThisCDelivery.listEstadoFilter=[{descripcion:"En Proceso",key:"pwa_estado",value:"P"},{descripcion:"En Camino",key:"pwa_estado",value:"R"},{descripcion:"Entregado",key:"pwa_estado",value:"E"},{descripcion:"En Proceso",key:"pwa_estado",value:"P"},{descripcion:"Pagado",key:"isShowPedidoCobrado",value:!0}],xThisCDelivery.listCondicionFilter=[{descripcion:"Asignados",key:"showRepartidor",value:!0},{descripcion:"Sin Asignar",key:"showRepartidor",value:!1}],xCDInfoResumen(),xCDSetFilterList([...seletecFilter.selectedOptions].map(e=>JSON.parse(e.value)))}function xCDSetFilterList(e){var o=xThisCDelivery.listDeliveryPedido;e.map(e=>{o=xCDGetFilteredCodes(o,e.key,e.value)}),xThisCDelivery.listDeliveryPedidoFilter=JSON.parse(JSON.stringify(o)),xCDInfoResumen()}function xCDFilterCliente(e){const o=e.value.toLowerCase();e=xThisCDelivery.listDeliveryPedido,e=""===o?e:e.filter(e=>-1<(e.nom_cliente+e.tel_cliente).toLowerCase().indexOf(o));xThisCDelivery.listDeliveryPedidoFilter=JSON.parse(JSON.stringify(e))}function xCDGetFilteredCodes(e,o,i){return e.filter(e=>e[o]===i)}function xCDInfoResumen(){var e=xThisCDelivery.listDeliveryPedidoFilter,o=e.length,i=e.filter(e=>"entregado"===e.labelEstado.toLowerCase()).length,r=e.filter(e=>"en camino"===e.labelEstado.toLowerCase()).length,t=e.filter(e=>"en proceso"===e.labelEstado.toLowerCase()).length,a=e.filter(e=>e.idrepartidor).length,d=e.filter(e=>!e.idrepartidor).length,e=e.map(e=>parseFloat(e.total)).reduce((e,o)=>e+o,0),o={num_pedidos:o,num_entregados:i,num_camino:r,num_proceso:t,num_asignados:a,num_asignar:d,importe:numeroConComas(e.toFixed(2))};xThisCDelivery.arrInfo=JSON.parse(JSON.stringify(o))}function xCDRepartidorResumen(){const a=xThisCDelivery.listDeliveryPedido;var d=[],s={importe_total:0,entrega:0,total:0,importe_pagado:0,importe_pagar:0};a.filter(e=>e.idrepartidor).map(o=>{if(!d.find(e=>e.idrepartidor===o.idrepartidor)){const t=a.filter(e=>e.idrepartidor===o.idrepartidor&&"3"!==e.estado);let e=o.isRepartidorPapaya?t.filter(e=>2!==e.idtipo_pago).map(e=>{try{var o=parseFloat(e.json_datos_delivery.p_header.arrDatosDelivery.c_servicio),i=parseFloat(e.json_datos_delivery.p_header.arrDatosDelivery.costoTotalDelivery),r=isNaN(o)?0:o,t=isNaN(i)?0:i;return 0!==r?r:t}catch(e){return 0}}).reduce((e,o)=>e+o,0):t.map(e=>{try{return e.json_datos_delivery.p_subtotales.filter(e=>-1<e.descripcion.toLowerCase().indexOf("delivery")||-1<e.descripcion.toLowerCase().indexOf("entrega")).map(e=>parseFloat(e.importe)).reduce((e,o)=>e+o,0)}catch(e){return 0}}).reduce((e,o)=>e+o,0);0!=e&&o.isRepartidorPapaya||(e=t.map(e=>{try{return e.json_datos_delivery.p_body.tipoconsumo.flatMap(e=>e.secciones.flatMap(e=>e.items.map(e=>({des:e.des,precio_print:e.precio_print})))).filter(e=>-1<e.des.toLowerCase().indexOf("costo delivery")||-1<e.des.toLowerCase().indexOf("costo de delivery")||-1<e.des.toLowerCase().indexOf("costo de entrega")||-1<e.des.toLowerCase().indexOf("costo de envio")||-1<e.des.toLowerCase().indexOf("costo envio")||-1<e.des.toLowerCase().indexOf("costo entrega")).map(e=>parseFloat(e.precio_print)).reduce((e,o)=>e+o,0)}catch(e){return 0}}).reduce((e,o)=>e+o,0));var i=o.isRepartidorPapaya?e:0,i={idrepartidor:o.idrepartidor,nom_repartidor:o.nom_repartidor,tel_repartidor:o.tel_repartidor,isRepartidorPapaya:o.isRepartidorPapaya,cant_pedidos:t.length,listIdPedidos:t.map(e=>e.idpedido).join(","),pedidos:{metodoPago:[],importe_total:t.map(e=>parseFloat(e.total)).reduce((e,o)=>e+o,0)+i,entrega:isNaN(e)?0:e,total:0,importe_pagado:t.filter(e=>"2"==e.estado).map(e=>parseFloat(e.total)).reduce((e,o)=>e+o,0)+i,importe_pagar:0,showImportePagado:!1,showBtnRegistroPago:!1}},r=[];xThisCDelivery.listTipoPagoFilter.map(o=>{var e={idtipo_pago:o.idtipo_pago,descripcion:o.descripcion,importe:t.filter(e=>e.idtipo_pago===o.idtipo_pago).map(e=>parseFloat(e.total)).reduce((e,o)=>e+o,0)};r.push(e)}),i.pedidos.metodoPago=r.filter(e=>0<e.importe),i.pedidos.total=i.pedidos.importe_total-i.pedidos.entrega,i.pedidos.importe_pagado=0<i.pedidos.importe_pagado?i.pedidos.importe_pagado-i.pedidos.entrega:0,i.pedidos.importe_pagar=(i.pedidos.total-i.pedidos.importe_pagado).toFixed(2),i.pedidos.total=i.pedidos.total.toFixed(2),i.pedidos.importe_total=i.pedidos.importe_total.toFixed(2),i.pedidos.entrega=i.pedidos.entrega.toFixed(2),i.pedidos.importe_pagado=i.pedidos.importe_pagado.toFixed(2),i.pedidos.showImportePagado=0<i.pedidos.importe_pagado,i.pedidos.showBtnRegistroPago=0<i.pedidos.importe_pagar,s.importe_total+=parseFloat(i.pedidos.importe_total),s.entrega+=parseFloat(i.pedidos.entrega),s.total+=parseFloat(i.pedidos.total),s.importe_pagado+=parseFloat(i.pedidos.importe_pagado),s.importe_pagar+=parseFloat(i.pedidos.importe_pagar),d.push(i)}}),xThisCDelivery.listResumenDeliveryTotales=s,xThisCDelivery.listResumenDelivery=d}async function xRegistrarPagoRepartidor(e){e.dataId;var e=e.dataId,o=(xThisCDelivery.nomRepartidorPago=e.nom_repartidor,paramsSwalAlert),o=(o.html=`<div class="p-1">                    												
												<p class="fw-600 fs-20">Registrar Pago</p>
												<p class="fw-100 fs-14">
													Repartidor:
                                                    <span class="badge badge-warning">${e.nom_repartidor}</span>
												</p><br>
                                                <p class="fs-14">Puede registrar el pago total en diferentes metodos (efectivo, tarjeta, etc.)
                                                <span class="fs-14 text-warning">Al finalizar el registro se darán por pagados todos los pedidos del repartidor</span>.</p>
											</div>`,o.showCancelButton=!0,await showAlertSwalHtmlDecision(o));o.isConfirmed&&xShowCompRegistrarPagoRepartidor(e.pedidos.importe_pagar,e)}function xShowCompRegistrarPagoRepartidor(o,i){xPopupLoad.titulo="Cargando...",xPopupLoad.xopen(),xCDQuitarXPagoCP(),$("#content_xpago_repartidor").html('<x-pago id="component_pago_repartidor" hidden_container_pago="false"></x-pago>').trigger("create"),setTimeout(()=>{var e=document.getElementById("component_pago_repartidor");component_pago_repartidor.setVal(o),component_pago_repartidor.setModoSoloProveedor(),component_pago_repartidor.setVisibleContainerPago(),xPopupLoad.xclose(),dialog_registrar_pago_repartidor.open(),e.addEventListener("xCancelarCerrar",function(e){dialog_registrar_pago_repartidor.close(),xCDRestaurarXPagoCP()}),e.addEventListener("xListoRegistraPagoRpt",function(e){dialog_registrar_pago_repartidor.close(),setTimeout(()=>{xCDRestaurarXPagoCP()},100),xRegistrarPagoDeliveryRepartidor(e.detail,i)}),e.addEventListener("ChangeListPagoAddRemoveRow",function(e){setTimeout(()=>{dialog_registrar_pago_repartidor.center()},100)})},1e3)}async function xRegistrarPagoDeliveryRepartidor(e,o){var i={id:o.idrepartidor,list:o.listIdPedidos,op:20};(await(new httpFecht).postJson("../../bdphp/log_009.php",i)).success&&(xSetEstadoPedidoDeliveryPagado(o),xSaveRegistrarPagoDeliveryRepartidor(e))}function xSetEstadoPedidoDeliveryPagado(o){xThisCDelivery.listDeliveryPedidoFilter.filter(e=>e.idrepartidor===o.idrepartidor).map(e=>{e.estado=2,e.isShowPedidoCobrado=!0}),xThisCDelivery.listDeliveryPedido.filter(e=>e.idrepartidor===o.idrepartidor).map(e=>{e.estado=2,e.isShowPedidoCobrado=!0}),xCDSetChangeListDelivery(),xCDRepartidorResumen()}async function xSaveRegistrarPagoDeliveryRepartidor(e){e={list:e,concepto:"Pago de Repartidor "+xThisCDelivery.nomRepartidorPago,nom_cliente:"Repartidor"};$.ajax({type:"POST",url:"../../bdphp/log_002.php",data:{op:"11",data:e}}).done(e=>{})}function xConfigCostoDeliveryTiendaLinea(){var e=paramsSwalAlert;e.html=`<div class="p-1 fs-11">                    												
                                <x-config-costo-delivery-sede id="comp-config-costo-delivery-tienda"></x-config-costo-delivery-sede>
                            </div>`,e.showCancelButton=!1,e.showConfirmButton=!1,e.showCloseButton=!0;const o=showAlertSwalHtml(e,0);setTimeout(()=>{document.getElementById("comp-config-costo-delivery-tienda").addEventListener("xSaveConfigCostoDeliverySede",()=>{o.close()})},1e3)}Polymer({is:"x-control-delivery",properties:{listDeliveryPedido:[],listDeliveryPedidoFilter:[],listResumenDelivery:[],listResumenDeliveryTotales:[],selectedTab:Number,listRepartidor:[],listTipoPagoFilter:[],listUsuarioFilter:[],listEstadoFilter:[],listCondicionFilter:[],rowItemSeleted:[],arrInfo:[],arrSedeInfo:[],lastObjBtnVer:Object,nomRepartidorPago:String},attached:function(){this.selectedTab=0,_cpSocketOpen(),xThisCDelivery=this},detached:function(){_cpSocketClose()},ini:()=>{xIniControlDelivery()},convertRowFixed:e=>e.toFixed(2)})</script>