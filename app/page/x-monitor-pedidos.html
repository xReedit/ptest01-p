<link rel="import" href="../x-componentes/x-comp-find-categoria/x-comp-find-categoria.html">
<dom-module id="x-monitor-pedidos">
<script src="../../js/isotope.pkgd.min.js"></script>
<script type="text/javascript" src="../../js/raphael.2.1.0.min.js"></script>
<script type="text/javascript" src="../../js/justgage.js"></script>
<script rel="preload" src="../view/xm_all.js"></script>
<script rel="preload" type="text/javascript" src="../view/config.const.js"></script>
<script rel="preload" type="text/javascript" src="../view/socket.service.js"></script>
<template>
<paper-dialog id="dialog_cambiar_pedidos_x_hora" class="dialog_redondo" style="min-width:320px" entry-animation="scale-up-animation" exit-animation="fade-out-animation" with-backdrop>
<div class="xContent">
<br>
<div>
<label for="txt_max_p_x_h">Maximo pedidos por hora:</label>
<input type="number" min="0" pattern="[0-9]+([\.,][0-9]+)?" step="any" class="xMiInput" value="[[xval_pedidos_x_hora]]" id="txt_max_p_x_h" autofocus>
</div>
<br><br><br>
<div class="xBoton2 xVerde" dialog-dismiss onclick="xCambiarMaxPxH()">Listo</div>
<div class="xBoton2 xRojo" dialog-dismiss>Cancelar</div>
<br><br>
</div>
</paper-dialog>
<paper-dialog id="dialog_new_item" class="dialog_redondo" modal entry-animation="scale-up-animation" exit-animation="fade-out-animation">
<div class="xContent">
<br>
<h4><span id="newItemTitulo"></span></h4>
<div class="xLinea2"></div>
<br>
<form id="frmNewItem">
<input type="text" id="txt_des_item" data-id="" class="xMiInput xPasarEnter2 des_item" placeholder="ITEM" onChange="conMayusculas(this)" required espaciar autofocus>
<input type="number" min="0" placeholder="Precio" pattern="[0-9]+([\.,][0-9]+)?" step="any" onblur="xRetornaMoneda(this)" class="xMiInput xMiInput xPasarEnter2" id="txt_precio_item" required espaciar>
<input type="text" class="xMiInput xMiInput xPasarEnter2" onChange="conMayusculas(this)" placeholder="Cantidad" id="txt_cantidad_item" required espaciar>
</form>
<br><br><br>
<div class="xBoton2 xAzul" dialog-dismiss onclick="guardarNewItem()">Listo, Agregar</div>
<div class="xBoton2 xPlomo" dialog-dismiss>Cancelar</div>
<br><br><br>
</div>
</paper-dialog>
<div class="xContent">
<div id="result"></div>
<br><br>
<div class="xMiCard xradius" style="width:95%">
<div class="xEncanezadoCard xFondoRowAmarillo2">
<p><strong>La tabla indica las cantidades vendidas y el stock actual, antes del cierre, las cantidades se actualizan automaticamente. De clic en la cantidad del stock para modificar.</strong></p>
</div>
<div class="xAlinearce" style="width:100%">
<div class="xm_at_cont xAlinearce xBordeDe">
<h3>Carta:
<x-comp-find-categoria id="compFindCategoria" onchange="_getCategoria(categorias)"></x-comp-find-categoria></h3>
<br>
<div id="bodyLi" width="400px"></div>
</div>
<div class="xm_at_cont xAlinearce">
<br>
<p class="xfont16 xCentrado">El grafico muestra la cantidad de pedidos que se generan durante la ultima hora.</p>
<br>
<div class="xLinea2"></div>
<div id="pedidos_x_hora" class="xIndicadorSize1 xCentrado"></div>
<a class="xCursor xfont12 xColorRow_Morado xCentrado" onclick="dialog_cambiar_pedidos_x_hora.open()">Cambiar maximo de pedidos para el grafico</a><br>
<div class="xLinea2"></div><br>
<p class="xfont16 xCentrado">Cantidad de pedidos hechos por usuarios.</p>
<br>
<table id="tb_pu" class="xtable2 xCentrado">
<thead>
<th align="left">Usuario</th>
<th>Cantidad</th>
</thead>
</table>
</div>
</div>
</div>
</template>
<style type="text/css">paper-spinner{width:20px;height:20px}.paper-spinner-a{width:15px;height:15px}</style>
<script>/*<![CDATA[*/var $table;var xThisMonPe,xActualizar=0,xValCantAnterior,graf_ped_x_hora=null,xdtPxH,xDt_sede_other,source,xValCountPedidos=0,idCategoriaSel,cnf_CategoriaSel,xArrayEncaUlLi,_seccionNewItem,isSocket=false;function xIniMonPe(){xPopupLoad=document.getElementById("xLoad");xm_LogChequea(function(){xm_log_get("ini_us");$("body").addClass("loaded");xDt_sede_other=xm_log_get("sede_otros_datos");xThisMonPe.xval_pedidos_x_hora=xDt_sede_other[0].maximo_pedidos_x_hora;$("#Titulo_page").text("Monitoreo del stock");xCargarEnInputItem();graf_ped_x_hora=null;xRefrecarGrafico(0);config_valoresInicialesComponenteCategoria();isSocket=parseInt(xm_log_get("datos_org_sede")[0].pwa)===0?false:true;console.log("isSocket",isSocket)});$(".xPasarEnter2").on("keyup",function(g){var f=g.which;if(f==13||f==186){var c=$("input");var b=c.index(document.activeElement);if(c[b+1]!==null){var d=c[b+1];if(d===undefined){return}if(d.disabled){d=c[b+2]}if(d==undefined){return}d.focus();d.select()}event.stopPropagation();g.stopPropagation();g.stopImmediatePropagation();return false}})}function xCargarEnInputItem(){var a;$.ajax({type:"POST",url:"../../bdphp/log.php?op=2"}).done(function(b){a=$.parseJSON(b);a=a.datos;var c=$("#txt_des_item");c.autocomplete({autoFocus:true,source:a,appendTo:"#dialog_new_item",select:function(d,e){c.val(e.item.label);c.attr("data-value",e.item.value);c.parents().find("#txt_precio_item").val(e.item.precio);return false},focus:function(d,e){return false},change:function(d,e){if(e.item===null){c.attr("data-value","");c.parents().find("#txt_precio_item").val("")}return false}})})}function xOpenDialogNewItem(a){_seccionNewItem=xArrayEncaUlLi[a];newItemTitulo.textContent=_seccionNewItem.des_seccion;dialog_new_item.open();console.log("seccion agregar",_seccionNewItem)}function guardarNewItem(){xvalidateFormInput("frmNewItem",function(b){if(b===false){return}xPopupLoad.xopen();_seccionNewItem.id_item=txt_des_item.dataset.value;_seccionNewItem.des_item=txt_des_item.value;_seccionNewItem.precio_item=txt_precio_item.value;_seccionNewItem.cant_item=txt_cantidad_item.value;_seccionNewItem.det_item="";_seccionNewItem.img_item="";$.ajax({type:"POST",url:"../../bdphp/log.php?op=204002",data:{item:_seccionNewItem}}).done(function(c){var a=c.split("|");_seccionNewItem.idcarta_lista=a[0];_seccionNewItem.iditem=a[1];_seccionNewItem.cantidad=_seccionNewItem.cant_item;_seccionNewItem.des=_seccionNewItem.des_item;_seccionNewItem.detalles="";_seccionNewItem.idseccion=parseInt(_seccionNewItem.idseccion);_seccionNewItem.imprimir_comanda=1;_seccionNewItem.isalmacen=0;_seccionNewItem.isporcion="0";_seccionNewItem.precio=_seccionNewItem.precio_item;_seccionNewItem.procede=1;const d=isSocket?isSocket:false;if(isSocket){_monitoreoSocketEmitNewItemInCarta(_seccionNewItem)}$("#frmNewItem").reset();xPopupLoad.xclose();xLoadAllItem()})})}function _getCategoria(a){this.cnf_CategoriaSel=a;this.idCategoriaSel=a.idcategoria;xLoadAllItem()}function config_valoresInicialesComponenteCategoria(){this.cnf_CategoriaSel=$("#compFindCategoria")[0].__data__.categorias;this.idCategoriaSel=cnf_CategoriaSel.idcategoria;xLoadAllItem()}function xLogRun_CoutPedido(){const a=isSocket?isSocket:false;if(isSocket){return}if(typeof(EventSource)!=="undefined"){source=new EventSource("../../bdphp/log_run.php?op=1");source.onmessage=function(b){if(b.data!==xValCountPedidos){xValCountPedidos=b.data;xActualizarListaPed()}}}}function xIntervalGraficoPxH(){xLoadPedidoxHora();xLoadPedidosUsuarios()}function xLoadPedidosUsuarios(){$.ajax({type:"POST",url:"../../bdphp/log.php?op=1903"}).done(function(a){var c=$.parseJSON(a);var e="";var d=0;c=c.datos;for(var b=0;b<c.length;b++){d=parseInt(d)+parseInt(c[b].cantidad);e=String(e+'<tr class="row"><td align="left">'+c[b].nombres+'</td><td align="right">'+xCeroIzq(c[b].cantidad,2)+"</td></tr>")}e=e+'<tr class="row"><td colspan="2" align="right"><strong>'+xCeroIzq(d,2)+"</strong></td></tr>";$("#tb_pu .row").remove();$("#tb_pu").append(e).trigger("create")})}function xLoadPedidoxHora(){$.ajax({type:"POST",url:"../../bdphp/log.php?op=1902"}).done(function(a){xdtPxH=$.parseJSON(a);xdtPxH=xdtPxH.datos;if(xdtPxH.length==0){return}xRefrecarGrafico(xdtPxH[0].cantidad)})}function xRefrecarGrafico(a){if(graf_ped_x_hora==null){graf_ped_x_hora=new JustGage({id:"pedidos_x_hora",value:a,min:0,max:xThisMonPe.xval_pedidos_x_hora,title:"Pedios x hora",label:"Pedidos",startAnimationTime:3700,counter:true})}else{graf_ped_x_hora.refresh(a)}}function xLoadAllItem(){xPopupLoad.titulo="Cargando...";xPopupLoad.xopen();$.ajax({type:"POST",url:"../../bdphp/log.php?op=19",data:{idcategoria:this.idCategoriaSel}}).done(function(d){var k=$.parseJSON(d),f="",h="";xArrayEncaUlLi=[];k=k.datos;for(var e=0;e<k.length;e++){if(h==k[e].des_seccion){continue}xArrayEncaUlLi.push({id:k[e].idseccion,des_seccion:k[e].des_seccion,idseccion:k[e].idseccion,idcarta:k[e].idcarta,idcategoria:k[e].idcategoria,sec_orden:k[e].sec_orden});h=k[e].des_seccion}var j,b,c="";for(var g=0;g<xArrayEncaUlLi.length;g++){j=xArrayEncaUlLi[g].id;xCadenaHeadUlDt=String('<div class="table-titulo"><div class="table-like__item"><span class="name"><p class="xfont16 xBold pos-relative">'+xArrayEncaUlLi[g].des_seccion+' <span class="btnAddItem xfont12 xCursor" onClick="xOpenDialogNewItem('+g+')">Agregar</span></p></span><span class="stock valing-b">Stock</span><span class="number valing-b">Salio</span></div></div>');f="";for(var a=0;a<k.length;a++){if(j==k[a].idseccion){f=String(f+'<li class="table-like__item row li'+k[a].idcarta_lista+'" id="li'+k[a].idcarta_lista+'"><div class="name text_puntos">'+k[a].plato+'</div><div class="stock xCursor contar" data-isporcion="'+k[a].isporcion+'" data-iditem="'+k[a].iditem+'" data-idcarta_lista="'+k[a].idcarta_lista+'" data-procede="'+k[a].procede+'" id="cantidad_stock" title="editar" onclick="xModRow(this);"><strong>'+xCeroIzq(k[a].cantidad,2)+'</strong></div><div class="number contar cant_vendido" id="cantidad_vendido">'+xCeroIzq(k[a].cant_vendido,2)+"</div></li>")}}f='<ul class="table-like" data-id="'+g+'">'+f+'</ul><li class="table-like__item_total"><p class="t_stock" id="total_row'+g+'"><stong>-</stong></p><p class="t_number" id="total_row_cant_vendido'+g+'"><stong>-</stong></p></li><br><br>';c=String(c+xCadenaHeadUlDt+f)}xPopupLoad.xclose();$("#bodyLi").html(c).trigger("create");xLogRun_CoutPedido();xActualizarListaPed();$table=$(".table-like").isotope({layoutMode:"vertical",getSortData:{name:".name",number:".number parseInt",stock:".stock parseInt",}});$table.isotope({sortBy:"stock"})})}function monitoreoStockEmitItemModificado(b){const a={cantidad:parseInt(b.val()),idcarta_lista:b.parent().attr("data-idcarta_lista"),iditem:b.parent().attr("data-iditem"),isalmacen:b.parent().attr("data-procede")==="1"?0:1,isporcion:b.parent().attr("data-isporcion")};_monitoreoSocketEmitItemModificado(a);_monitoreoStockItemModificado(a)}function _monitoreoStockItemModificado(b){const d="#li"+b.idcarta_lista;const c=b.cantidad;var a="";$(d+" div.stock").text(b.cantidad);$(d+" div.stock").html("<strong>"+xCeroIzq(c,2)+"<strong>");setRowClassEstado(b)}function _monitoreoStockNuevoPedido(){xIntervalGraficoPxH()}function setRowClassEstado(b){const d="#li"+b.idcarta_lista;const c=b.cantidad;var a="";if(c<6){a="xFondoRowRojo"}else{if(c<11){a="xFondoRowAmarillo"}}$(d).removeClass("xFondoRowRojo");$(d).removeClass("xFondoRowAmarillo");$(d).addClass(a);$table.isotope("reloadItems").isotope();xSumarTotales()}function xModRow(c,b){var a=$(c).text();xValCantAnterior=a;if($(c).find("input").length>0){$(c).find("input").select();return}$(c).html('<input type="number" min="0" pattern="[0-9]+([.,][0-9]+)?" step="any" class="xMiInput xPasarEnter2 xAlinearIzquierda" onblur="xModBlur(this,'+b+')" value="'+a+'" select>').trigger("create");$(c).find("input").select();xActualizar=1}function xModBlur(f,c){var b=$(f).val();if(b==xValCantAnterior){$(f).parent().html("<strong>"+xCeroIzq(b,2)+"</strong>");$(f).remove();return}var a=$(f).parent().attr("data-procede"),e=$(f).parent().attr("data-idcarta_lista"),d=$(f).parent().attr("data-iditem");if(isSocket){monitoreoStockEmitItemModificado($(f));$(f).parent().html('<paper-spinner id="aax" class="paper-spinner-a" active></paper-spinner>').trigger("create");$("#aax").parent().html("<strong>"+xCeroIzq(b,2)+"</strong>");$("#aax").remove();return}$(f).parent().html('<paper-spinner id="aax" class="paper-spinner-a" active></paper-spinner>').trigger("create");$.ajax({type:"POST",url:"../../bdphp/log.php?op=1901",data:{p:a,idcl:e,idi:d,c:b}}).done(function(g){$("#aax").parent().html("<strong>"+xCeroIzq(b,2)+"</strong>");$("#aax").remove()});xActualizar=0}function xActualizarListaPed(){$.ajax({type:"POST",url:"../../bdphp/log.php?op=19",data:{idcategoria:this.idCategoriaSel}}).done(function(b){var a=$.parseJSON(b),e="",c="",f;a=a.datos;for(var d=0;d<a.length;d++){c="";f=a[d].cantidad;e=".li"+a[d].idcarta_lista;if(xActualizar==0){$(".table-like__item"+e+" .number").text(xCeroIzq(a[d].cant_vendido,2));$(".table-like__item"+e+" .stock").html("<strong>"+xCeroIzq(f,2)+"<strong>");if(f<6){c="xFondoRowRojo"}else{if(f<11){c="xFondoRowAmarillo"}}$(".table-like__item"+e).removeClass("xFondoRowRojo");$(".table-like__item"+e).removeClass("xFondoRowAmarillo");$(".table-like__item"+e).addClass(c)}}if(xActualizar==0){$table.isotope("reloadItems").isotope()}xSumarTotales();xIntervalGraficoPxH()})}function xSumarTotales(){var b=0,a=0,c;$(".table-like").each(function(d,e){c=$(e).attr("data-id");b=0;a=0;$(e).find(".contar").each(function(f,g){if($(g).hasClass("cant_vendido")){if(!isNaN(parseInt($(g).text()))){a=a+parseInt($(g).text())}}else{if(!isNaN(parseInt($(g).text()))){b=b+parseInt($(g).text())}}});$("#total_row"+c).html("<strong>"+xCeroIzq(b,2)+"</strong>");$("#total_row_cant_vendido"+c).html("<strong>"+xCeroIzq(a,2)+"</strong>")})}function xCambiarMaxPxH(){var a=txt_max_p_x_h.value;$.ajax({type:"POST",url:"../../bdphp/log.php?op=309",data:{p:a}}).done(function(b){xThisMonPe.xval_pedidos_x_hora=a;dialog_cambiar_pedidos_x_hora.close();graf_ped_x_hora.max=xThisMonPe.xval_pedidos_x_hora;graf_ped_x_hora.refresh(0,xThisMonPe.xval_pedidos_x_hora);xDt_sede_other[0].maximo_pedidos_x_hora=xThisMonPe.xval_pedidos_x_hora})}Polymer({is:"x-monitor-pedidos",properties:{xval_pedidos_x_hora:Number},attached:function(){xThisMonPe=this;xIniMonPe();_monitoreoSocketIsConnect()},detached:function(){_monitoreoSocketClose()}});/*]]>*/</script>
</dom-module>