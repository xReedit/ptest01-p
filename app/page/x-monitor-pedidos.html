<link rel="import"href="../x-componentes/x-comp-find-categoria/x-comp-find-categoria.html"><link rel="import"href="../x-componentes/x-comp-item-subitems-edit/x-comp-item-subitems-edit.html">;<dom-module id="x-monitor-pedidos"><script src="../../js/isotope.pkgd.min.js"></script><script src="../../js/raphael.2.1.0.min.js"></script><script src="../../js/justgage.js"></script><template><paper-dialog id="dialog_cambiar_pedidos_x_hora"class="dialog_redondo"style="min-width:320px"entry-animation="scale-up-animation"exit-animation="fade-out-animation"with-backdrop><div class="xContent"><br><div><label for="txt_max_p_x_h">Maximo pedidos por hora:</label> <input type="number"min="0"pattern="[0-9]+([\.,][0-9]+)?"step="any"class="xMiInput"value="[[xval_pedidos_x_hora]]"id="txt_max_p_x_h"autofocus></div><br><br><br><div class="xBoton2 xVerde"dialog-dismiss onclick="xCambiarMaxPxH()">Listo</div><div class="xBoton2 xRojo"dialog-dismiss>Cancelar</div><br><br></div></paper-dialog><paper-dialog id="dialog_subitem"class="dialog_redondo"style="width:90%;max-width:500px;height:auto!important;overflow:auto"modal entry-animation="scale-up-animation"exit-animation="fade-out-animation"><div class="xContent"><h4 id="dlg_des_item_detalle">Item</h4><div class="xLinea2"></div><x-comp-item-subitems-edit id="comp-subitems-content"></x-comp-item-subitems-edit><br><div class="xBoton2 xPlomo xDerecha"dialog-dismiss>Cerrar</div><br><br></div></paper-dialog><paper-dialog id="dialog_new_item"class="dialog_redondo"modal entry-animation="scale-up-animation"exit-animation="fade-out-animation"><div class="xContent"><br><h4><span id="newItemTitulo"></span></h4><div class="xLinea2"></div><br><form id="frmNewItem"><input id="txt_des_item"data-id=""class="xMiInput xPasarEnter2 des_item"placeholder="ITEM"onchange="conMayusculas(this)"required espaciar autofocus> <input type="number"min="0"placeholder="Precio"pattern="[0-9]+([\.,][0-9]+)?"step="any"onblur="xRetornaMoneda(this)"class="xMiInput xMiInput xPasarEnter2"id="txt_precio_item"required espaciar> <input class="xMiInput xMiInput xPasarEnter2"onchange="conMayusculas(this)"placeholder="Cantidad"id="txt_cantidad_item"required espaciar></form><br><br><br><div class="xBoton2 xAzul"dialog-dismiss onclick="guardarNewItem()">Listo, Agregar</div><div class="xBoton2 xPlomo"dialog-dismiss>Cancelar</div><br><br><br></div></paper-dialog><div class="xContent"><div id="result"></div><br><br><div class="xMiCard xradius"style="width:95%"><div class="xEncanezadoCard xFondoRowAmarillo2"><p><strong>La tabla indica las cantidades vendidas y el stock actual, antes del cierre, las cantidades se actualizan automaticamente. De clic en la cantidad del stock para modificar.</strong></div><div class="xAlinearce"style="width:100%"><div class="xm_at_cont xAlinearce xBordeDe"><h3>Carta:<x-comp-find-categoria id="compFindCategoria"onchange="_getCategoria(categorias)"></x-comp-find-categoria></h3><br><div id="bodyLi"width="400px"></div></div><div class="xm_at_cont xAlinearce"><br><p class="xfont16 xCentrado">El grafico muestra la cantidad de pedidos que se generan durante la ultima hora.</p><br><div class="xLinea2"></div><div id="pedidos_x_hora"class="xIndicadorSize1 xCentrado"></div><a class="xCursor xfont12 xColorRow_Morado xCentrado"onclick="dialog_cambiar_pedidos_x_hora.open()">Cambiar maximo de pedidos para el grafico</a><br><div class="xLinea2"></div><br><p class="xfont16 xCentrado">Cantidad de pedidos hechos por usuarios.</p><br><table id="tb_pu"class="xtable2 xCentrado"><thead><th align="left">Usuario<th>Cantidad</thead></table></div></div></div></div></template><style type="text/css">paper-spinner{width:20px;height:20px}.paper-spinner-a{width:15px;height:15px}</style><script rel="prefetch"src="../view/socket.service.js"></script><script>var $table,xThisMonPe,xValCantAnterior,xdtPxH,xDt_sede_other,source,idCategoriaSel,cnf_CategoriaSel,xArrayEncaUlLi,_seccionNewItem,dtAllItems,xCompSubItemContet,objSeccionAdd,xActualizar=0,graf_ped_x_hora=null,xValCountPedidos=0,isSocket=!1,reloadIsotope=!1;function xIniMonPe(){xPopupLoad=document.getElementById("xLoad"),xm_LogChequea(function(){xm_log_get("ini_us"),$("body").addClass("loaded"),xDt_sede_other=xm_log_get("sede_otros_datos"),xThisMonPe.xval_pedidos_x_hora=xDt_sede_other[0].maximo_pedidos_x_hora,$("#Titulo_page").text("Monitoreo del stock"),xCargarEnInputItem(),graf_ped_x_hora=null,xRefrecarGrafico(0),config_valoresInicialesComponenteCategoria(),isSocket=0!==parseInt(xm_log_get("datos_org_sede")[0].pwa),$("body").addClass("loaded")}),$(".xPasarEnter2").on("keyup",function(e){var t=e.which;if(13==t||186==t){var t=$("input"),o=t.index(document.activeElement);if(null!==t[o+1]){var a=t[o+1];if(void 0===a)return;if(null==(a=a.disabled?t[o+2]:a))return;a.focus(),a.select()}return e.stopPropagation(),e.stopImmediatePropagation(),!1}}),xCompSubItemContet=document.getElementById("comp-subitems-content")}function xCargarEnInputItem(){var t;$.ajax({type:"POST",url:"../../bdphp/log.php?op=2"}).done(function(e){t=$.parseJSON(e).datos;var o=$("#txt_des_item");o.autocomplete({autoFocus:!0,source:t,appendTo:"#dialog_new_item",select:function(e,t){return o.val(t.item.label),o.attr("data-value",t.item.value),o.parents().find("#txt_precio_item").val(t.item.precio),!1},focus:function(e,t){return!1},change:function(e,t){return null===t.item&&(o.attr("data-value",""),o.parents().find("#txt_precio_item").val("")),!1}})})}function xOpenDialogNewItem(e){_seccionNewItem=xArrayEncaUlLi[e],newItemTitulo.textContent=_seccionNewItem.des_seccion,objSeccionAdd=$("#ulItems"+e),dialog_new_item.open()}function guardarNewItem(){xvalidateFormInput("frmNewItem",function(e){!1!==e&&(xPopupLoad.xopen(),_seccionNewItem.id_item=txt_des_item.dataset.value,_seccionNewItem.des_item=txt_des_item.value,_seccionNewItem.precio_item=txt_precio_item.value,_seccionNewItem.cant_item=txt_cantidad_item.value,_seccionNewItem.det_item="",_seccionNewItem.img_item="",$.ajax({type:"POST",url:"../../bdphp/log.php?op=204002",data:{item:_seccionNewItem}}).done(function(e){e=e.split("|"),_seccionNewItem.cantidad=_seccionNewItem.cant_item,_seccionNewItem.des=_seccionNewItem.des_item,_seccionNewItem.detalles="",_seccionNewItem.idcarta_lista=e[0],_seccionNewItem.idimpresora=_seccionNewItem.idimpresora,_seccionNewItem.iditem=e[1],_seccionNewItem.idseccion=parseInt(_seccionNewItem.idseccion),_seccionNewItem.imprimir_comanda=1,_seccionNewItem.isalmacen=0,_seccionNewItem.isporcion="0",_seccionNewItem.precio=_seccionNewItem.precio_item,_seccionNewItem.precio_unitario=_seccionNewItem.precio_item,_seccionNewItem.procede=1,_seccionNewItem.sec_orden=_seccionNewItem.sec_orden,_seccionNewItem.seccion=_seccionNewItem.des_seccion,_seccionNewItem.selected=!1,_seccionNewItem.subitem_cant_select=0,_seccionNewItem.subitem_required_select=0,_seccionNewItem.subitems=null,_seccionNewItem.ver_stock_cero=0,_seccionNewItem.visible=!0,isSocket&&_monitoreoSocketEmitNewItemInCarta(_seccionNewItem),$("#frmNewItem").reset(),xPopupLoad.xclose(),dtAllItems.push(_seccionNewItem),e=dtAllItems.length-1,e='<li class="table-like__item row li'+_seccionNewItem.idcarta_lista+'" id="li'+_seccionNewItem.idcarta_lista+'"><div class="name text_puntos">'+_seccionNewItem.des+'</div><div class="stock xCursor contar" data-isporcion="'+_seccionNewItem.isporcion+'" data-iditem="'+_seccionNewItem.iditem+'" data-idcarta_lista="'+_seccionNewItem.idcarta_lista+'" data-procede="'+_seccionNewItem.procede+'" id="cantidad_stock" title="editar" onclick="xModRow(this, '+e+');"><strong>'+xCeroIzq(_seccionNewItem.cantidad,2)+'</strong></div><div class="number contar cant_vendido" id="cantidad_vendido">0</div></li>';$(objSeccionAdd).append(e).trigger("create"),$table.isotope("reloadItems").isotope()}))})}function _getCategoria(e){this.cnf_CategoriaSel=e,this.idCategoriaSel=e.idcategoria,xLoadAllItem()}function config_valoresInicialesComponenteCategoria(){this.cnf_CategoriaSel=compFindCategoria.__data__.categorias,this.idCategoriaSel=cnf_CategoriaSel.idcategoria}function xLogRun_CoutPedido(){isSocket||"undefined"!=typeof EventSource&&((source=new EventSource("../../bdphp/log_run.php?op=1")).onmessage=function(e){e.data!==xValCountPedidos&&(xValCountPedidos=e.data,xActualizarListaPed())})}function xIntervalGraficoPxH(){xLoadPedidoxHora(),xLoadPedidosUsuarios()}function xLoadPedidosUsuarios(){$.ajax({type:"POST",url:"../../bdphp/log.php?op=1903"}).done(function(e){for(var t="",o=0,a=$.parseJSON(e).datos,i=0;i<a.length;i++)o=parseInt(o)+parseInt(a[i].cantidad),t=String(t+'<tr class="row"><td align="left">'+a[i].nombres+'</td><td align="right">'+xCeroIzq(a[i].cantidad,2)+"</td></tr>");t=t+'<tr class="row"><td colspan="2" align="right"><strong>'+xCeroIzq(o,2)+"</strong></td></tr>",$("#tb_pu .row").remove(),$("#tb_pu").append(t).trigger("create")})}function xLoadPedidoxHora(){$.ajax({type:"POST",url:"../../bdphp/log.php?op=1902"}).done(function(e){0!=(xdtPxH=(xdtPxH=$.parseJSON(e)).datos).length&&xRefrecarGrafico(xdtPxH[0].cantidad)})}function xRefrecarGrafico(e){null==graf_ped_x_hora?graf_ped_x_hora=new JustGage({id:"pedidos_x_hora",value:e,min:0,max:xThisMonPe.xval_pedidos_x_hora,title:"Pedios x hora",label:"Pedidos",startAnimationTime:3700,counter:!0}):graf_ped_x_hora.refresh(e)}function xLoadAllItem(){xPopupLoad.titulo="Cargando...",xPopupLoad.xopen(),$.ajax({type:"POST",url:"../../bdphp/log.php?op=19",data:{idcategoria:this.idCategoriaSel}}).done(function(e){dtAllItems=$.parseJSON(e),xcandena_a="",xNom_seccion_ul="",xArrayEncaUlLi=[],dtAllItems=dtAllItems.datos;for(var t=0;t<dtAllItems.length;t++)xNom_seccion_ul!=dtAllItems[t].des_seccion&&(xArrayEncaUlLi.push({id:dtAllItems[t].idseccion,des_seccion:dtAllItems[t].des_seccion,idseccion:dtAllItems[t].idseccion,idcarta:dtAllItems[t].idcarta,idcategoria:dtAllItems[t].idcategoria,sec_orden:dtAllItems[t].sec_orden}),xNom_seccion_ul=dtAllItems[t].des_seccion);for(var o,a="",i=0;i<xArrayEncaUlLi.length;i++){o=xArrayEncaUlLi[i].id,xCadenaHeadUlDt=String('<div class="table-titulo"><div class="table-like__item"><span class="name"><p class="xfont16 xBold pos-relative">'+xArrayEncaUlLi[i].des_seccion+' <span class="btnAddItem xfont12 xCursor" onClick="xOpenDialogNewItem('+i+')">Agregar</span></p></span><span class="stock valing-b">Stock</span></div></div>'),xcandena_a="";for(var n=0;n<dtAllItems.length;n++)o==dtAllItems[n].idseccion&&(xcandena_a=String(xcandena_a+'<li class="table-like__item row li'+dtAllItems[n].idcarta_lista+'" id="li'+dtAllItems[n].idcarta_lista+'"><div class="name text_puntos">'+dtAllItems[n].plato+'</div><div class="stock xCursor contar" data-isporcion="'+dtAllItems[n].isporcion+'" data-iditem="'+dtAllItems[n].iditem+'" data-idcarta_lista="'+dtAllItems[n].idcarta_lista+'" data-procede="'+dtAllItems[n].procede+'" id="cantidad_stock" title="editar" onclick="xModRow(this, '+n+');"><strong>'+xCeroIzq(dtAllItems[n].cantidad,2)+"</strong></div></li>"));xcandena_a='<ul class="table-like" id="ulItems'+i+'" data-id="'+i+'">'+xcandena_a+'</ul><li class="table-like__item_total"><p class="t_stock" id="total_row'+i+'"><stong>-</stong></p><p class="t_number" id="total_row_cant_vendido'+i+'"><stong>-</stong></p></li><br><br>',a=String(a+xCadenaHeadUlDt+xcandena_a)}xPopupLoad.xclose(),$("#bodyLi").html(a).trigger("create"),($table=$(".table-like")).isotope({layoutMode:"vertical",getSortData:{name:".name",number:".number parseInt",stock:".stock parseInt"}}),$table.isotope({sortBy:"stock"}),xLogRun_CoutPedido(),xActualizarListaPed()})}function _monitoreoStockUpdateCarta(e){xLoadAllItem()}function monitoreoStockEmitItemModificado(e){e={cantidad:parseInt(e.val()),idcarta_lista:e.parent().attr("data-idcarta_lista"),iditem:e.parent().attr("data-iditem"),isalmacen:"0"===e.parent().attr("data-procede")?1:0,isporcion:e.parent().attr("data-isporcion"),from_monitor:!0};_monitoreoSocketEmitItemModificado(e),_monitoreoStockItemModificado(e)}function _monitoreoStockItemModificado(e){var t="#li"+e.idcarta_lista,o=e.cantidad;$(t+" div.stock").text(e.cantidad),$(t+" div.stock").html("<strong>"+xCeroIzq(o,2)+"<strong>"),setRowClassEstado(e)}function _monitoreoStockNuevoPedido(){xIntervalGraficoPxH()}function setRowClassEstado(e){var t="#li"+e.idcarta_lista,e=e.cantidad,o="";e<6?o="xFondoRowRojo":e<11&&(o="xFondoRowAmarillo"),$(t).removeClass("xFondoRowRojo"),$(t).removeClass("xFondoRowAmarillo"),$(t).addClass(o),$table.isotope("reloadItems").isotope(),xSumarTotales()}function evaluarItemIsSubitem(e){var t=!1;return e.subitems&&("object"==typeof e.subitems?e.subitems:JSON.parse(e.subitems)).map(e=>{e.opciones.map(e=>{if("ND"!=e.cantidad)return t=!0})}),t}function xModRow(e,t,o){var t=dtAllItems[t],a=evaluarItemIsSubitem(t);a?(dlg_des_item_detalle.textContent=t.plato,xCompSubItemContet.iditem=t.iditem,xCompSubItemContet.itemselected=t,xCompSubItemContet.frommonitor=!0,xCompSubItemContet.loadSubItemIni(),dialog_subitem.open()):(a=$(e).text(),xValCantAnterior=a,0<$(e).find("input").length?$(e).find("input").select():($(e).html('<input type="number" min="0" pattern="[0-9]+([.,][0-9]+)?" step="any" class="xMiInput xPasarEnter2 xAlinearIzquierda" onblur="xModBlur(this,'+o+')" value="'+a+'" select>').trigger("create"),$(e).find("input").select(),xActualizar=1))}function xModBlur(e,t){var o,a,i,n=$(e).val();n==xValCantAnterior?($(e).parent().html("<strong>"+xCeroIzq(n,2)+"</strong>"),$(e).remove()):(o=$(e).parent().attr("data-procede"),a=$(e).parent().attr("data-idcarta_lista"),i=$(e).parent().attr("data-iditem"),isSocket?(monitoreoStockEmitItemModificado($(e)),$(e).parent().html('<paper-spinner id="aax" class="paper-spinner-a" active></paper-spinner>').trigger("create"),$("#aax").parent().html("<strong>"+xCeroIzq(n,2)+"</strong>"),$("#aax").remove(),2==o&&xActualizarListaPed()):($(e).parent().html('<paper-spinner id="aax" class="paper-spinner-a" active></paper-spinner>').trigger("create"),$.ajax({type:"POST",url:"../../bdphp/log.php?op=1901",data:{p:o,idcl:a,idi:i,c:n}}).done(function(e){$("#aax").parent().html("<strong>"+xCeroIzq(n,2)+"</strong>"),$("#aax").remove()}),xActualizar=0),event.stopPropagation(),event.stopImmediatePropagation())}function xActualizarListaPed(){$.ajax({type:"POST",url:"../../bdphp/log.php?op=19",data:{idcategoria:this.idCategoriaSel}}).done(function(e){for(var t,o,a="",i=$.parseJSON(e).datos,n=0;n<i.length;n++)a="",o=i[n].cantidad,t=".li"+i[n].idcarta_lista,$(".table-like__item"+t+" .number").text(xCeroIzq(i[n].cant_vendido,2)),$(".table-like__item"+t+" .stock").html("<strong>"+xCeroIzq(o,2)+"<strong>"),o<6?a="xFondoRowRojo":o<11&&(a="xFondoRowAmarillo"),$(".table-like__item"+t).removeClass("xFondoRowRojo"),$(".table-like__item"+t).removeClass("xFondoRowAmarillo"),$(".table-like__item"+t).addClass(a);0==xActualizar&&$table.isotope("reloadItems").isotope(),xSumarTotales(),xIntervalGraficoPxH()})}function xSumarTotales(){var o,a=0,i=0;$(".table-like").each(function(e,t){o=$(t).attr("data-id"),i=a=0,$(t).find(".contar").each(function(e,t){$(t).hasClass("cant_vendido")?isNaN(parseInt($(t).text()))||(i+=parseInt($(t).text())):isNaN(parseInt($(t).text()))||(a+=parseInt($(t).text()))}),$("#total_row"+o).html("<strong>"+xCeroIzq(a,2)+"</strong>"),$("#total_row_cant_vendido"+o).html("<strong>"+xCeroIzq(i,2)+"</strong>")})}function xCambiarMaxPxH(){var t=txt_max_p_x_h.value;$.ajax({type:"POST",url:"../../bdphp/log.php?op=309",data:{p:t}}).done(function(e){xThisMonPe.xval_pedidos_x_hora=t,dialog_cambiar_pedidos_x_hora.close(),graf_ped_x_hora.max=xThisMonPe.xval_pedidos_x_hora,graf_ped_x_hora.refresh(0,xThisMonPe.xval_pedidos_x_hora),xDt_sede_other[0].maximo_pedidos_x_hora=xThisMonPe.xval_pedidos_x_hora})}Polymer({is:"x-monitor-pedidos",properties:{xval_pedidos_x_hora:Number},attached:function(){xThisMonPe=this,xIniMonPe(),_monitoreoSocketIsConnect()},detached:function(){_monitoreoSocketClose()}})</script></dom-module>