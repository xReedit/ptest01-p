<link rel="import" href="../../x-componentes/pagination-input/pagination-input.html">
<dom-module id="x-clientes">
	<template is="dom">

		<paper-dialog class="dialog_redondo" id="dialog_borrar" entry-animation="scale-up-animation"
			exit-animation="fade-out-animation" with-backdrop>
			<div class="xtxtCentro">
				<img src="../../../images/_dlg_remove.gif" alt="" width="150px">
			</div>
			<p>Esta seguro de querer borrar este registro?</p>
			<br>
			<div class="buttons">
				<button class="xBoton2 xPlomo" dialog-dismiss>Cancelar</button>
				<button class="xBoton2 xRojo" onclick="xDlgBorrar();">Si, borrar</button>
			</div>
		</paper-dialog>

		<paper-dialog class="dialog_redondo" id="dialog_new_cliente" style="min-width: 545px;" modal
			entry-animation="scale-up-animation" exit-animation="fade-out-animation">
			<div>
				<paper-tabs selected="{{selected}}" id="tab_cliente">
					<paper-tab>DATOS DEL CLIENTE</paper-tab>
					<paper-tab>HISTORIAL</paper-tab>
				</paper-tabs>
				<div class="xLinea2"></div><br>
				<iron-pages selected="{{selected}}">
					<div id="div_datos">
						<form id="form_new_cliente" method="POST" autocomplete="off">
							<input type="text" class="xMiInput xPasarEnter2" placeholder="NOMBRES" value$="[[selItemClie.nombres]]"
								autocomplete="off" onChange="conMayusculas(this)" id="nombres" name="nombres" espaciar required>
							<input type="number" class="xMiInput xPasarEnter2" placeholder="RUC | DNI" value$="[[selItemClie.ruc]]"
								autocomplete="off" onChange="conMayusculas(this)" id="ruc" name="ruc" espaciar required>
							<input type="number" class="xMiInput xPasarEnter2" placeholder="TELEFONO" onChange="conMayusculas(this)"
								id="telefono" value$="[[selItemClie.telefono]]" autocomplete="off" name="telefono" espaciar required>
							<textarea class="xMiInput xPasarEnter2" max-rows="2" placeholder="DIRECCION" onChange="conMayusculas(this)"
								autocomplete="off" id="txt_direccion" espaciar></textarea>

							<div class="xInvisible">
								<input type="text" id="idcliente" name="idcliente" value$="[[selItemClie.idcliente]]">
								<input type="text" id="idorg" name="idorg" value$="[[xt_org]]">
								<input type="text" id="direccion" name="direccion" value$="[[selItemClie.direccion]]">
								<input type="text" id="f_registro" name="f_registro" value$="[[selItemClie.f_registro]]">
							</div>
						</form>
					</div>
					<div id="div_historial">
						<div class="x_div_linea">
							<div id="historial" class="xitem-col-8 xBordeDe" style="height: 50vh; overflow-y: auto;">
								<div>
									<p><strong>Historial de consumo</strong></p>
									<table width="100%">
										<thead class="xfont10">
											<th>#</th>
											<th>Fecha</th>											
											<th align="right">Importe</th>
										</thead>
										<tbody>
											<template is="dom-repeat" items="{{selItemClieListConsumo}}" as="subitem_c">
												<tr class="xfont10">
													<td data-id="{{index}}"><span>{{displayIndex(index)}}</span></td>													
													<td>{{subitem_c.fecha_mostrar}}</td>
													<td align="right">{{subitem_c.total}}</td>
												</tr>
											</template>											
										</tbody>
									</table>
								</div>
							</div>
							<div id="historial-2" class="xitem-auto">
								<div>
									<label for="d1" class="xColorRow_Plomo xfont10">Cantidad: </label>
									<h3 id="d1">{{selItemClieListConsumo.length}}</h3>
									<label for="d2" class="xColorRow_Plomo xfont10">Importe Total: </label>
									<h3 id="d2" class="xfont16x">{{selItemClieEstadistica.total_c}}</h3>
									<label for="d2" class="xColorRow_Plomo xfont10">Ticket Promedio: </label>
									<h3 id="d2" class="xfont16x">{{selItemClieEstadistica.ticket}}</h3>
									<label for="d2" class="xColorRow_Plomo xfont10">Viene cada: </label>
									<h3 id="d2" class="xfont16x">{{selItemClieEstadistica.frecuencia}}</h3>
									<label for="d2" class="xColorRow_Plomo xfont10">Ultima visita: </label>
									<h3 id="d2" class="xfont16x">{{selItemClieEstadistica.last_fecha}}</h3>
								</div>
								
							</div>
							<hr>
						</div>
					</div>
				</iron-pages>
				
				<br><br>
				<button id="dlg_sunat_btn" onclick="newCliente()" class="xBoton2 xVerde">Listo
					Guardar</button>
				<button dialog-dismiss class="xBoton2 xRojo">Cerrar</button>
			</div>
		</paper-dialog>

		<br><br>
		<div class="xMiCard xradius" style="width:90%">
			<div class="xEncanezadoCard xFondoRowAmarillo2">
				<h3>Registro de clientes.</h3>
				<p>Agrega y actualiza los datos de tus clientes.</p>
			</div>
			<div class="xContentCard" style="height: 100%;">
				<!-- <button onclick="openDIalognewCliente()">new</button> -->
				<paper-fab icon="add" onclick="openDIalognewCliente()" title="Agregar" tabindex="0" class="xDerecha">
				</paper-fab>
				<input type="text" class="xMiInput xfont15" style="width:100%;" placeholder="Buscar" autofocus
					onkeyup="xfiltrarDatos_cliente()" id="txt_buscar_cliente" enlinea>
				<br>
				<table width="100%">
					<thead>
						<th>#</th>
						<th>Cliente</th>
						<th>Tipo</th>
						<th>RUC/DNI</th>
						<th>Direccion</th>
						<th width="100px">Telefono</th>
						<!-- <th>f. Nacimiento</th> -->
						<!-- <th>f. Registro</th> -->						
						<th></th>
					</thead>
					<tbody>
						<template is="dom-repeat" items="{{ListClientes}}" as="item">
							<tr data-t="cliente" data-id="{{item.idcliente}}"
								class="animated fadeIn fast xCursor" id="{{index}}" onclick="_getClienteEdit(this)">
								<td data-id="{{index}}"><span>{{displayIndex(index)}}</span></td>
								<td>{{item.nombres}}</td>
								<td>{{item.tipo}}</td>
								<td>{{item.ruc}}</td>
								<td>{{item.direccion}}</td>
								<td>{{item.telefono}}</td>
								<!-- <td>{{item.f_registro}}</td> -->
								<!-- <td><span class="xDeleteRow" title="Borrar" onclick="xDialogBorrarObj(this);"></span></td> -->
								<td>
									<span class="xDeleteRow2" title="Anular" onclick="xDialogBorrarObj(this);"></span>
									<!-- <div style="display: flex;" class="xCursor">
										<span class="xEditRow" style="margin-right: 5px;" title="Editar" onclick="xDialogBorrarObj(this);"></span>
									</div> -->
								</td>
							</tr>
						</template>					
					</tbody>
				</table>
				<br>
				<div>
					<pagination-input id="paginator" class="xDerecha" current-page="1" page-count="5"
						current-page-changed="onChangePagination($event)"></pagination-input>
				</div>
				<br><br>
			</div>
		</div>
	</template>
</dom-module>

<script>
	var xThisCliente, sel_idTipoIngreso, xObjBorrar, p_rows=0, p_filter='', p_desde=0, data_pagination={},
		fecha_filtrar = new Date(), xdebounce, xe_debounce=false,
		_mm, _yy, dateNow;

	function xIniPagination() {        
        xThisCliente.$.paginator.currentPage = 1;
        xThisCliente.$.paginator.pageRows = p_rows;
        xThisCliente.$.paginator.listRows = [10,20,30,40];
	}
	
	function xIniCliente() {

		$('body').addClass('loaded');


		var _dtUs = xm_log_get('app3_us');
		xThisCliente.xt_org = _dtUs.ido;
		xThisCliente.xt_idsede = _dtUs.idsede;
		xThisCliente.xt_idus = _dtUs.idus;		

		xIniPagination();

		xThisCliente.$.paginator.addEventListener('page-limit-change', (e) => {
            data_pagination = e.detail.value; // datos del componente
            p_desde = data_pagination.pageDesde; // para el # de fila            
            getAllListClientes();
		}); 
		
		getAllListClientes();

		$('.xPasarEnter2').on('keyup', function (e) {
			var code = e.which;
			if (code == 13 || code == 186) {
				var inputs = $('input'); // storage a array of Inputs
				var a = inputs.index(document.activeElement);
				if (inputs[a + 1] !== null) {
					var nextBox = inputs[a + 1];
					if (nextBox === undefined) {
						return
					}
					if (nextBox.disabled) {
						nextBox = inputs[a + 2]
					}

					if (nextBox == undefined) {
						return;
					}
					nextBox.focus();
					nextBox.select();
					//event.preventDefault();
				}
				return false;
			}
		});

		// setTimeout(() => {
		// 	sel_idTipoIngreso = compTpIngreso.__data__.list_tipo_ingreso.idtipo_ingreso;
		// 	console.log(sel_idTipoIngreso);
		// }, 1000);
	}

	function openDIalognewCliente() {	
		xThisCliente.selItemClie = [];
		xThisCliente.selItemClieEstadistica = [];
		xThisCliente.selItemClieListConsumo = [];
		txt_direccion.value = '';
		dialog_new_cliente.open();
	}

	function getAllListClientes() {
		// xPopupLoad.xopen();
		const p_filter = xThisCliente.$.txt_buscar_cliente.value;
		data_pagination.pageFilter = p_filter;

	
		$.ajax({
				type: 'POST',
				url: '../../bdphp/log_005.php?op=4',
				data: {
					pagination:data_pagination
				}
			})
			.done((res) => {
				res = res.split('**');
				const _res = JSON.parse(res[0]);
				xThisCliente.ListClientes = _res.datos;				
				p_rows = res[1];	
				
				p_upadate = false; // para que no vuelva a llamar esta funcion
				xThisCliente.$.paginator.pageRows = p_rows;
								
			});
	}

	function xfiltrarDatos_cliente() {
		if (xe_debounce) return;
		xe_debounce = true;
		clearTimeout(xdebounce);

		xdebounce = setTimeout(() => {
			getAllListClientes();
			// clearTimeout(xdebounce);
			xe_debounce = false;
			xThisCliente.$.paginator.currentPage = 1;
			// xIniPagination();
		}, 900);
	}




	function newCliente() {		
		const frm_clie = $("#form_new_cliente");		
		frm_clie.find("#idorg").val(xThisCliente.xt_org);		
		frm_clie.find("#f_registro").val(xDevolverFecha());
		frm_clie.find("#direccion").val(txt_direccion.value);
		xvalidateForm('form_new_cliente', function (a) {
			if (a === false) {
				return;
			}

			if (frm_clie.find("#nombres").val() == '' ) return false;

			xPopupLoad.xopen();

			$.post("../../bdphp/ManejoBD_IUD.php?tb=cliente", $("#form_new_cliente").serialize(),
				function (a) {
					xPopupLoad.xclose();
					$("#form_new_cliente").reset();
					xPopupLoad.xclose();
					
					getAllListClientes();
					dialog_new_cliente.close();
				})
		})

	}

	function xDialogBorrarObj(obj, event) {
		xObjBorrar = obj;
		dialog_borrar.open();
	}

	function xDlgBorrar() {
		xBorrarItem(xObjBorrar);
		dialog_borrar.close();
	}

	function _getClienteEdit(obj){
		const index = obj.id;
		xThisCliente.selItemClie = xThisCliente.ListClientes[index];
		txt_direccion.value = xThisCliente.selItemClie.direccion;

		// informacion de consumo
		$.ajax({
				type: 'POST',
				url: '../../bdphp/log_005.php?op=401',
				data: {
					i: xThisCliente.selItemClie.idcliente
				}
			})
			.done((res) => {				
				res = JSON.parse(res);	
				
				xThisCliente.selItemClieListConsumo = res.datos;
				
				xThisCliente.selItemClieEstadistica = [];
				xThisCliente.selItemClieEstadistica = res.datos.reduce((a, b) => {
					a.calc_frecuencia = a.calc_frecuencia + (Math.floor((new Date(b.fecha) - new Date(a.calc_fecha)) / (1000 * 60 * 60 * 24)));
					a.calc_frecuencia = isNaN(a.calc_frecuencia) ? 0 : a.calc_frecuencia;
					a.calc_fecha = b.fecha;
					a.count = a.count ? parseFloat(a.count) + 1 : 2;
					a.total_c = parseFloat(a.total) + parseFloat(b.total);
					a.total_c = parseFloat(a.total_c).toFixed(2)
					
					a.frecuencia = parseInt(a.calc_frecuencia / a.count);
					a.frecuencia = a.frecuencia === 0 ? 1 + ' dia' : a.frecuencia + ' dias';
					a.ticket = parseFloat(a.total_c / a.count).toFixed(2);
					a.last_fecha = b.fecha_mostrar.split(' ')[0];
					return a;
				});

				console.log(xThisCliente.selItemClieEstadistica);
				console.log(xThisCliente.selItemClieListConsumo);
								
			});


		dialog_new_cliente.open();
	}


	Polymer({
		is: 'x-clientes',
		properties: {
			xt_org: Number,
			xt_idsede: Number,
			sumList: String,
			ListClientes: [],
			selItemClie: [],
			selItemClieListConsumo: [],
			selItemClieEstadistica: [],
		},
		attached: function () {
			this.selected = 0,
			xThisCliente = this;
			xIniCliente();
		},
		displayIndex: function (index) {
			return xCeroIzq(index + 1, 1);
		},
	})
</script>