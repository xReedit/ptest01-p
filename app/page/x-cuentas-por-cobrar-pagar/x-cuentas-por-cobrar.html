<dom-module id="x-cuentas-por-cobrar"><template><div class="p-2"><div class="d-flexx justify-content-between"><p class="fw-600 fs-15">Cuentas por Cobrar</p><button hidden$="[[!showDetalleCuentaCobrar]]"class="btn btn-sm btn-secondary"onclick="xGoBackListaCuentasCobrar()"><i class="fa fa-arrow-left mr-1"></i> Atras</button><div hidden$="[[showDetalleCuentaCobrar]]"><button class="btn btn-sm btn-primary"onclick="xGoListCuentaCobrarHistorial()"><i class="fa fa-history"></i> Historial</button> <button class="btn btn-sm btn-secondary"onclick="xGoBackListaCuentasCobrarPrincipal()"><i class="fa fa-arrow-left mr-1"></i> Atras</button></div></div><div hidden$="[[!showDetalleCuentaCobrar]]"class="mt-2"><div class="xLinea2"></div><br></div><div hidden$="[[showDetalleCuentaCobrar]]"><div><p>Ventas registrados al credito.</div><br><input id="text_buscar_cliente_credito"class="xMiInput w-100"placeholder="Buscar Cliente"onkeyup="xBuscarClienteCredito(this)"><br><br><div><table class="w-100"><thead><th>#<th>Cliente<th align="right">Imp. Consumo<th align="right">Pagó<th align="right">Debe Aún<th align="center"><tbody><template is="dom-repeat"items="{{listCuentasPagar}}"><tr><td>{{displayIndex(index)}}<td>{{item.nom_cliente}} <i hidden$="[[!item.isHistory]]"class="fa fa-history text-primary"></i><td align="right"><p class="fw-600">{{item.total}}<td align="right"><p class="fw-600 text-success">{{item.pago}}<td align="right"><p class="fw-600 text-primary">{{item.debe}}<td><button data-id="[[item.idcliente]]"style="width:60px"class="btn btn-sm btn-xsm xBoton_flat_2"onclick="xCobrarCuentaCliente(this)"><span hidden$="[[item.isHistory]]">Cobrar</span> <span hidden$="[[!item.isHistory]]">Ver</span></button></template><tr><td align="right"colspan="2"><p class="fw-600 fs-15">Totales<td align="right"><p class="fw-600 fs-17">{{totalConsumoCliente}}<td align="right"><p class="fw-600 fs-17">{{totalPagadoCliente}}<td align="right"><p class="fw-600 fs-17">{{totalDebeCliente}}<td></table></div></div><div hidden$="[[!showDetalleCuentaCobrar]]"><section><p class="fw-600 fs-17">{{ objCuentaCobrar.nom_cliente }}<div class="d-flexx"><p class="fw-600 fs-15 mr-2"><i class="fa fa-id-card-o mr-1"></i> {{ objCuentaCobrar.num_dni }}<p class="fw-600 fs-15"><i class="fa fa-phone mr-1"></i> {{ objCuentaCobrar.telfono }}</div></section><br><div class="xLinea2"></div><br><section><div class="grid-container"><div class="column1"><div class="column-title"><p>Consumos al credito</div><div class="div-table"><table class="w-100 fs-12"><thead><th style="width:30px"><input type="checkbox"id="check-all-consumos"onclick="selectAllConsumos(this)"><th>#<th>Fecha<th>Consumo<th>Pagado<th>Debe<tbody><template is="dom-repeat"items="{{listConsumosCreditoCliente}}"><tr><td><input type="checkbox"class="consumo-check"data-index="{{index}}"data-id="{{item.idregistro_pago_detalle}}"data-debe="{{item.debe}}"onclick="calcularTotalSeleccionado()"><td>{{displayIndex(index)}}<td><p>{{item.fecha}}<p hidden$="[[item.isCuentaPagada]]"class="fs-10 text-secondary">{{item.pasaron}}</p><span hidden$="[[!item.isCuentaPagada]]"class="badge badge-primary">{{item.pasaron}}</span><td>{{item.total}}<td>{{item.pagado}}<td>{{item.debe}}</template></table></div></div><div class="column2"><div class="column-title"><p>Historial de Pagos</div><div class="div-table"><table class="w-100 fs-12"><thead><th>Fecha<th>Usuario<th align="right">Pagado<tbody><template is="dom-repeat"items="{{listCuentaPagarHistoriaPagosCliente}}"><tr><td><p>{{item.fecha}}<p>{{item.hora}}<td>{{item.nom_usuario}}<td align="right"><p class="fw-600">{{item.importe}}<p class$="[[item.classTp]]">{{item.nom_tipo_pago}}</template></table></div></div></div></section><br><section class="div-resumen-cuenta-pagar"><p class="fw-600 fs-15 text-secondary mb-3">Resumen de cuenta pendiente por pagar<div class="grid-totales pb-2"><div><p>Imp. Consumo<p class="fs-23 fw-600">{{ arrTotalesListCreditoCliente.total }}</div><div><p>Pagado<p class="fs-23 fw-600 text-success">{{ arrTotalesListCreditoCliente.pagado_show }}</div><div><p>Debe Aún<p class="fs-23 fw-600 text-primary">{{ arrTotalesListCreditoCliente.debe_show }}</div><div><p class="fw-600 fs-15">Importe a Pagar<p class="fs-11 text-secondary">Indique aqui el importe que pagará<div id="div-importe-seleccionado"style="display:none;margin-bottom:5px"><p class="fw-600 fs-13 text-primary">Importe seleccionado: <span id="importe-seleccionado">0.00</span></div><input type="number"class="xMiInput fs-23 fw-600"id="txt_importe_pago_cuenta_credito"onkeyup="xValidarBtnPagoCuentaCobrar(this)"placeholder=""> <button disabled$="[[!enabledBtnCobrarCuenta]]"class="btn btn-sm mt-2 btn-primary"style="float:right"onclick="xShowIngresoPagoCuentaCobrar()">Registrar Pago</button></div></div></section></div></div></template><style>.grid-container{display:grid;grid-template-columns:1fr 1fr;gap:10px}.column1{border:1px solid #ccc;border-radius:5px}.column2{border:1px solid #ccc;border-radius:5px}.column-title{border-radius:5px 5px 0 0;color:#fff!important;padding:5px 10px 5px 10px;background:#424242;height:30px;justify-content:space-between;display:flex;align-items:center}.div-table{max-height:300px;overflow:auto}.grid-totales{display:grid;grid-template-columns:1fr 1fr 1fr 1fr auto;gap:10px}.div-resumen-cuenta-pagar{border:1px solid #d7d7d7;padding:10px;border-radius:5px}@media (max-width:767px){.grid-container{grid-template-columns:1fr}.column2{margin-top:10px}.grid-totales{grid-template-columns:1fr 1fr}}</style><script>var xThisCuentasPorCobrar,itemOptionTpCuentaCobrarSelected;async function xInitCuentasPorCobrar(e=23){xPopupLoad.xopen();e=await(new httpFecht).postJson("../../bdphp/log_009.php?op="+e);e.success&&(xThisCuentasPorCobrar.listCuentasPagar=e.datos,xThisCuentasPorCobrar.listCuentasPagarMaster=e.datos.map(e=>(e.isHistory=0==parseFloat(e.debe),e)),xShowTotalCuentasPagar()),xPopupLoad.xclose(),$(document).on("getValorIncial",".tpf_option_cuenta_cobrar",function(e){itemOptionTpCuentaCobrarSelected=e.detail.values})}function xGoListCuentaCobrarHistorial(){xThisCuentasPorCobrar.showHistoryPagos=!0,xInitCuentasPorCobrar(23001)}function xShowTotalCuentasPagar(){xThisCuentasPorCobrar.totalConsumoCliente=xThisCuentasPorCobrar.listCuentasPagar.map(e=>parseFloat(removeComas(e.total))).reduce((e,o)=>e+o,0),xThisCuentasPorCobrar.totalPagadoCliente=xThisCuentasPorCobrar.listCuentasPagar.map(e=>parseFloat(removeComas(e.pago))).reduce((e,o)=>e+o,0),xThisCuentasPorCobrar.totalDebeCliente=xThisCuentasPorCobrar.listCuentasPagar.map(e=>parseFloat(removeComas(e.debe))).reduce((e,o)=>e+o,0),xThisCuentasPorCobrar.totalConsumoCliente=xThisCuentasPorCobrar.totalConsumoCliente.toFixed(2),xThisCuentasPorCobrar.totalPagadoCliente=xThisCuentasPorCobrar.totalPagadoCliente.toFixed(2),xThisCuentasPorCobrar.totalDebeCliente=xThisCuentasPorCobrar.totalDebeCliente.toFixed(2)}function xBuscarClienteCredito(e){const o=e.value;xThisCuentasPorCobrar.listCuentasPagar=xThisCuentasPorCobrar.listCuentasPagarMaster.filter(e=>e.nom_cliente.toLowerCase().includes(o.toLowerCase())),xShowTotalCuentasPagar()}function xCobrarCuentaCliente(e){const o=e.dataId;e=xThisCuentasPorCobrar.listCuentasPagar.find(e=>e.idcliente==o);xThisCuentasPorCobrar.objCuentaCobrar=e,xThisCuentasPorCobrar.showDetalleCuentaCobrar=!0,txt_importe_pago_cuenta_credito.value="",xLoadConsumoCreditoByCliente()}async function xLoadConsumoCreditoByCliente(){xPopupLoad.xopen(),xThisCuentasPorCobrar.enabledBtnCobrarCuenta=!1;var e=document.getElementById("div-importe-seleccionado"),e=(e&&(e.style.display="none"),{idcliente:xThisCuentasPorCobrar.objCuentaCobrar.idcliente}),a=xThisCuentasPorCobrar.showHistoryPagos?230101:2301,a=await(new httpFecht).postJson("../../bdphp/log_009.php?op="+a,e);if(a.success){xThisCuentasPorCobrar.listConsumosCreditoCliente=a.datos.map(e=>(e.isCuentaPagada="1"==e.flag_pagado,e));let o={total:0,pagado:0,debe:0,pagadoShow:0,debeShow:0};a.datos.map(e=>{o.total+=parseFloat(removeComas(e.total)),o.pagado+=parseFloat(removeComas(e.pagado)),o.debe+=parseFloat(removeComas(e.debe))}),o.total=o.total.toFixed(2),o.pagado=o.pagado.toFixed(2),o.debe=o.debe.toFixed(2),o.pagado_show=o.pagado,o.debe_show=o.debe,xThisCuentasPorCobrar.arrTotalesListCreditoCliente=o,setTimeout(()=>{var e=document.getElementById("check-all-consumos");e&&(e.checked=!1),document.querySelectorAll(".consumo-check").forEach(e=>{e.checked=!1})},100)}xListCuentaPagarHistoriaPagosCliente(),xPopupLoad.xclose()}async function xListCuentaPagarHistoriaPagosCliente(){var e={idcliente:xThisCuentasPorCobrar.objCuentaCobrar.idcliente},e=await(new httpFecht).postJson("../../bdphp/log_009.php?op=2303",e);e.success&&(xThisCuentasPorCobrar.listCuentaPagarHistoriaPagosCliente=e.datos.map(e=>(e.classTp=getColorTipoPago(e.idtipo_pago),e.fecha=e.fecha_hora.split(" ")[0],e.hora=e.fecha_hora.split(" ")[1],e)))}function selectAllConsumos(e){const o=e.checked;document.querySelectorAll(".consumo-check").forEach(e=>{e.checked=o}),calcularTotalSeleccionado()}function calcularTotalSeleccionado(){var e=document.querySelectorAll(".consumo-check:checked");let o=0;e.forEach(e=>{e=parseFloat(removeComas(e.dataDebe));isNaN(e)||(o+=e)});var a=document.getElementById("div-importe-seleccionado"),t=document.getElementById("importe-seleccionado"),e=(0<e.length?(a&&(a.style.display="block"),t&&(t.textContent=o.toFixed(2))):a&&(a.style.display="none"),document.getElementById("txt_importe_pago_cuenta_credito"));e&&(e.value=o.toFixed(2),e.fromCheckbox=!0,xValidarBtnPagoCuentaCobrar(e),e.fromCheckbox=!1)}function xGoBackListaCuentasCobrar(){xThisCuentasPorCobrar.showDetalleCuentaCobrar=!1}function xValidarBtnPagoCuentaCobrar(e){let o=parseFloat(e.value);isNaN(o)?(xThisCuentasPorCobrar.enabledBtnCobrarCuenta=!1,o=0):0<o&&(xThisCuentasPorCobrar.enabledBtnCobrarCuenta=!0),e.fromCheckbox||((a=document.getElementById("div-importe-seleccionado"))&&(a.style.display="none"),(a=document.getElementById("check-all-consumos"))&&(a.checked=!1),document.querySelectorAll(".consumo-check").forEach(e=>{e.checked=!1}));var a=parseFloat(xThisCuentasPorCobrar.arrTotalesListCreditoCliente.debe),e=(o>a&&(o=a,e.value=o),0===o&&(xThisCuentasPorCobrar.enabledBtnCobrarCuenta=!1),a-o);xThisCuentasPorCobrar.arrTotalesListCreditoCliente.pagado_show=o.toFixed(2),xThisCuentasPorCobrar.arrTotalesListCreditoCliente.debe_show=e.toFixed(2),xThisCuentasPorCobrar.arrTotalesListCreditoCliente=JSON.parse(JSON.stringify(xThisCuentasPorCobrar.arrTotalesListCreditoCliente)),xThisCuentasPorCobrar.importePagadoCuentaCobrar=o}async function xShowIngresoPagoCuentaCobrar(e){var o=paramsSwalAlert,o=(o.title='<p class="fw-600 fs-18">Elige el metodo de pago</p><p class="fs-13">Se registrará como una <span class="fw-600 text-primary">ingreso a caja</span></p>',o.html=`<div class="pb-2" style="display: inline-flex;">                    
                                        <x-comp-find-tipo-pago-option class="tpf_option_cuenta_cobrar"></x-comp-find-tipo-pago-option>
                                    </div>`,o.confirmButtonText="Listo, registrar",o.showCancelButton=!0,await showAlertSwalHtmlDecision(o,0));o.isConfirmed&&(xPopupLoad.xopen(),xShowProccessPagoCuentaCredito())}function procesarConsumo(a,t){var r={importeRestante:t,itemPagado:null};if(!(t<=0)){let o=parseFloat(removeComas(a.debe));if(!(o<=0)){t=t-o;let e=parseFloat(removeComas(a.pagado));r.importeRestante=Math.max(0,t),o=0<=t?(e=parseFloat(a.importe),0):(t=Math.abs(t),e=parseFloat(a.importe)-t,t),r.itemPagado={idregistro_pago_detalle:a.idregistro_pago_detalle,pagado:e,flag_pagado:0==o?"1":"0"}}}return r}async function xShowProccessPagoCuentaCredito(){xPopupLoad.xopen();var e=document.querySelectorAll(".consumo-check:checked"),o=0<e.length;let a=[],t=xThisCuentasPorCobrar.importePagadoCuentaCobrar;if(o){const s=new Map;e.forEach(e=>{e=parseInt(e.dataIndex);s.set(e,!0)}),xThisCuentasPorCobrar.listConsumosCreditoCliente.forEach((e,o)=>{s.has(o)&&0<t&&(o=procesarConsumo(e,t),t=o.importeRestante,o.itemPagado)&&a.push(o.itemPagado)})}else for(const n of[...xThisCuentasPorCobrar.listConsumosCreditoCliente].sort((e,o)=>e.idregistro_pago_detalle-o.idregistro_pago_detalle)){if(t<=0)break;var r=procesarConsumo(n,t);t=r.importeRestante,r.itemPagado&&a.push(r.itemPagado)}o=new httpFecht,e={idcliente:xThisCuentasPorCobrar.objCuentaCobrar.idcliente,idtipo_pago:itemOptionTpCuentaCobrarSelected.idtipo_pago,importe:xThisCuentasPorCobrar.importePagadoCuentaCobrar,debe:xThisCuentasPorCobrar.arrTotalesListCreditoCliente.debe_show,idusuario:xIdUsuario,listPagados:a};(await o.postJson("../../bdphp/log_009.php?op=2302",e)).success?(xThisCuentasPorCobrar.showDetalleCuentaCobrar=!1,xInitCuentasPorCobrar(),xRegistrarIngresoCajaCobroCredito()):xPopupLoad.xclose()}function xRegistrarIngresoCajaCobroCredito(e){var o={idtipo_pago:itemOptionTpCuentaCobrarSelected.idtipo_pago,total:xThisCuentasPorCobrar.importePagadoCuentaCobrar.toFixed(2),concepto:"PAGO DE CUENTA - "+xThisCuentasPorCobrar.objCuentaCobrar.nom_cliente,nom_cliente:xThisCuentasPorCobrar.objCuentaCobrar.nom_cliente};$.ajax({type:"POST",url:"../../bdphp/log_002.php",data:{op:"11",data:o}})}Polymer({is:"x-cuentas-por-cobrar",properties:{listCuentasPagar:[],listCuentasPagarMaster:[],listConsumosCreditoCliente:[],listCuentaPagarHistoriaPagosCliente:[],arrTotalesListCreditoCliente:{},totalDebeCliente:Number,totalConsumoCliente:Number,totalPagadoCliente:Number,showDetalleCuentaCobrar:Boolean,objCuentaCobrar:Object,enabledBtnCobrarCuenta:Boolean,importePagadoCuentaCobrar:Number,showHistoryPagos:Boolean},attached:function(){this.importePagadoCuentaCobrar=0,this.showDetalleCuentaCobrar=!1,this.enabledBtnCobrarCuenta=!1,this.showHistoryPagos=!1,xThisCuentasPorCobrar=this,xInitCuentasPorCobrar()},displayIndex:function(e){return xCeroIzq(e+1,1)}})</script></dom-module>