<dom-module id="x-cuentas-por-cobrar"><template><div class="p-2"><div class="d-flexx justify-content-between"><p class="fw-600 fs-15">Cuentas por Cobrar</p><button hidden$="[[!showDetalleCuentaCobrar]]"class="btn btn-sm btn-secondary"onclick="xGoBackListaCuentasCobrar()"><i class="fa fa-arrow-left mr-1"></i> Atras</button><div hidden$="[[showDetalleCuentaCobrar]]"><button class="btn btn-sm btn-primary"onclick="xGoListCuentaCobrarHistorial()"><i class="fa fa-history"></i> Historial</button> <button class="btn btn-sm btn-secondary"onclick="xGoBackListaCuentasCobrarPrincipal()"><i class="fa fa-arrow-left mr-1"></i> Atras</button></div></div><div hidden$="[[!showDetalleCuentaCobrar]]"class="mt-2"><div class="xLinea2"></div><br></div><div hidden$="[[showDetalleCuentaCobrar]]"><div><p>Ventas registrados al credito.</div><br><input id="text_buscar_cliente_credito"class="xMiInput w-100"placeholder="Buscar Cliente"onkeyup="xBuscarClienteCredito(this)"><br><br><div><table class="w-100"><thead><th>#<th>Cliente<th align="right">Imp. Consumo<th align="right">Pagó<th align="right">Debe Aún<th align="center"><tbody><template is="dom-repeat"items="{{listCuentasPagar}}"><tr><td>{{displayIndex(index)}}<td>{{item.nom_cliente}} <i hidden$="[[!item.isHistory]]"class="fa fa-history text-primary"></i><td align="right"><p class="fw-600">{{item.total}}<td align="right"><p class="fw-600 text-success">{{item.pago}}<td align="right"><p class="fw-600 text-primary">{{item.debe}}<td><button data-id="[[item.idcliente]]"style="width:60px"class="btn btn-sm btn-xsm xBoton_flat_2"onclick="xCobrarCuentaCliente(this)"><span hidden$="[[item.isHistory]]">Cobrar</span> <span hidden$="[[!item.isHistory]]">Ver</span></button></template><tr><td align="right"colspan="2"><p class="fw-600 fs-15">Totales<td align="right"><p class="fw-600 fs-17">{{totalConsumoCliente}}<td align="right"><p class="fw-600 fs-17">{{totalPagadoCliente}}<td align="right"><p class="fw-600 fs-17">{{totalDebeCliente}}<td></table></div></div><div hidden$="[[!showDetalleCuentaCobrar]]"><section><p class="fw-600 fs-17">{{ objCuentaCobrar.nom_cliente }}<div class="d-flexx"><p class="fw-600 fs-15 mr-2"><i class="fa fa-id-card-o mr-1"></i> {{ objCuentaCobrar.num_dni }}<p class="fw-600 fs-15"><i class="fa fa-phone mr-1"></i> {{ objCuentaCobrar.telfono }}</div></section><br><div class="xLinea2"></div><br><section><div class="grid-container"><div class="column1"><div class="column-title"><p>Consumos al credito</div><div class="div-table"><table class="w-100 fs-12"><thead><th>#<th>Fecha<th>Consumo<th>Pagado<th>Debe<tbody><template is="dom-repeat"items="{{listConsumosCreditoCliente}}"><tr><td>{{displayIndex(index)}}<td><p>{{item.fecha}}<p hidden$="[[item.isCuentaPagada]]"class="fs-10 text-secondary">{{item.pasaron}}</p><span hidden$="[[!item.isCuentaPagada]]"class="badge badge-primary">{{item.pasaron}}</span><td>{{item.total}}<td>{{item.pagado}}<td>{{item.debe}}</template></table></div></div><div class="column2"><div class="column-title"><p>Historial de Pagos</div><div class="div-table"><table class="w-100 fs-12"><thead><th>Fecha<th>Usuario<th align="right">Pagado<tbody><template is="dom-repeat"items="{{listCuentaPagarHistoriaPagosCliente}}"><tr><td><p>{{item.fecha}}<p>{{item.hora}}<td>{{item.nom_usuario}}<td align="right"><p class="fw-600">{{item.importe}}<p class$="[[item.classTp]]">{{item.nom_tipo_pago}}</template></table></div></div></div></section><br><section class="div-resumen-cuenta-pagar"><p class="fw-600 fs-15 text-secondary mb-3">Resumen de cuenta pendiente por pagar<div class="grid-totales pb-2"><div><p>Imp. Consumo<p class="fs-23 fw-600">{{ arrTotalesListCreditoCliente.total }}</div><div><p>Pagado<p class="fs-23 fw-600 text-success">{{ arrTotalesListCreditoCliente.pagado_show }}</div><div><p>Debe Aún<p class="fs-23 fw-600 text-primary">{{ arrTotalesListCreditoCliente.debe_show }}</div><div><p class="fw-600 fs-15">Importe a Pagar<p class="fs-11 text-secondary">Indique aqui el importe que pagará</p><input type="number"class="xMiInput fs-23 fw-600"id="txt_importe_pago_cuenta_credito"onkeyup="xValidarBtnPagoCuentaCobrar(this)"placeholder=""> <button disabled$="[[!enabledBtnCobrarCuenta]]"class="btn btn-sm mt-2 btn-primary"style="float:right"onclick="xShowIngresoPagoCuentaCobrar()">Registrar Pago</button></div></div></section></div></div></template><style>.grid-container{display:grid;grid-template-columns:1fr 1fr;gap:10px}.column1{border:1px solid #ccc;border-radius:5px}.column2{border:1px solid #ccc;border-radius:5px}.column-title{border-radius:5px 5px 0 0;color:#fff!important;padding:5px 10px 5px 10px;background:#424242;height:30px;justify-content:space-between;display:flex;align-items:center}.div-table{max-height:300px;overflow:auto}.grid-totales{display:grid;grid-template-columns:1fr 1fr 1fr 1fr auto;gap:10px}.div-resumen-cuenta-pagar{border:1px solid #d7d7d7;padding:10px;border-radius:5px}@media (max-width:767px){.grid-container{grid-template-columns:1fr}.column2{margin-top:10px}.grid-totales{grid-template-columns:1fr 1fr}}</style><script>var xThisCuentasPorCobrar,itemOptionTpCuentaCobrarSelected;async function xInitCuentasPorCobrar(a=23){xPopupLoad.xopen();a=await(new httpFecht).postJson("../../bdphp/log_009.php?op="+a);a.success&&(xThisCuentasPorCobrar.listCuentasPagar=a.datos,xThisCuentasPorCobrar.listCuentasPagarMaster=a.datos.map(a=>(a.isHistory=0==parseFloat(a.debe),a)),xShowTotalCuentasPagar()),xPopupLoad.xclose(),$(document).on("getValorIncial",".tpf_option_cuenta_cobrar",function(a){itemOptionTpCuentaCobrarSelected=a.detail.values})}function xGoListCuentaCobrarHistorial(){xThisCuentasPorCobrar.showHistoryPagos=!0,xInitCuentasPorCobrar(23001)}function xShowTotalCuentasPagar(){xThisCuentasPorCobrar.totalConsumoCliente=xThisCuentasPorCobrar.listCuentasPagar.map(a=>parseFloat(removeComas(a.total))).reduce((a,o)=>a+o,0),xThisCuentasPorCobrar.totalPagadoCliente=xThisCuentasPorCobrar.listCuentasPagar.map(a=>parseFloat(removeComas(a.pago))).reduce((a,o)=>a+o,0),xThisCuentasPorCobrar.totalDebeCliente=xThisCuentasPorCobrar.listCuentasPagar.map(a=>parseFloat(removeComas(a.debe))).reduce((a,o)=>a+o,0),xThisCuentasPorCobrar.totalConsumoCliente=xThisCuentasPorCobrar.totalConsumoCliente.toFixed(2),xThisCuentasPorCobrar.totalPagadoCliente=xThisCuentasPorCobrar.totalPagadoCliente.toFixed(2),xThisCuentasPorCobrar.totalDebeCliente=xThisCuentasPorCobrar.totalDebeCliente.toFixed(2)}function xBuscarClienteCredito(a){const o=a.value;xThisCuentasPorCobrar.listCuentasPagar=xThisCuentasPorCobrar.listCuentasPagarMaster.filter(a=>a.nom_cliente.toLowerCase().includes(o.toLowerCase())),xShowTotalCuentasPagar()}function xCobrarCuentaCliente(a){const o=a.dataId;a=xThisCuentasPorCobrar.listCuentasPagar.find(a=>a.idcliente==o);xThisCuentasPorCobrar.objCuentaCobrar=a,xThisCuentasPorCobrar.showDetalleCuentaCobrar=!0,txt_importe_pago_cuenta_credito.value="",xLoadConsumoCreditoByCliente()}async function xLoadConsumoCreditoByCliente(){xPopupLoad.xopen(),xThisCuentasPorCobrar.enabledBtnCobrarCuenta=!1;var a={idcliente:xThisCuentasPorCobrar.objCuentaCobrar.idcliente},e=xThisCuentasPorCobrar.showHistoryPagos?230101:2301,e=await(new httpFecht).postJson("../../bdphp/log_009.php?op="+e,a);if(e.success){xThisCuentasPorCobrar.listConsumosCreditoCliente=e.datos.map(a=>(a.isCuentaPagada="1"==a.flag_pagado,a));let o={total:0,pagado:0,debe:0,pagadoShow:0,debeShow:0};e.datos.map(a=>{o.total+=parseFloat(removeComas(a.total)),o.pagado+=parseFloat(removeComas(a.pagado)),o.debe+=parseFloat(removeComas(a.debe))}),o.total=o.total.toFixed(2),o.pagado=o.pagado.toFixed(2),o.debe=o.debe.toFixed(2),o.pagado_show=o.pagado,o.debe_show=o.debe,xThisCuentasPorCobrar.arrTotalesListCreditoCliente=o}xListCuentaPagarHistoriaPagosCliente(),xPopupLoad.xclose()}async function xListCuentaPagarHistoriaPagosCliente(){var a={idcliente:xThisCuentasPorCobrar.objCuentaCobrar.idcliente},a=await(new httpFecht).postJson("../../bdphp/log_009.php?op=2303",a);a.success&&(xThisCuentasPorCobrar.listCuentaPagarHistoriaPagosCliente=a.datos.map(a=>(a.classTp=getColorTipoPago(a.idtipo_pago),a.fecha=a.fecha_hora.split(" ")[0],a.hora=a.fecha_hora.split(" ")[1],a)))}function xGoBackListaCuentasCobrar(){xThisCuentasPorCobrar.showDetalleCuentaCobrar=!1}function xValidarBtnPagoCuentaCobrar(a){let o=parseFloat(a.value);isNaN(o)?(xThisCuentasPorCobrar.enabledBtnCobrarCuenta=!1,o=0):0<o&&(xThisCuentasPorCobrar.enabledBtnCobrarCuenta=!0);var e=parseFloat(xThisCuentasPorCobrar.arrTotalesListCreditoCliente.debe),a=(o>e&&(o=e,a.value=o),0===o&&(xThisCuentasPorCobrar.enabledBtnCobrarCuenta=!1),e-o);xThisCuentasPorCobrar.arrTotalesListCreditoCliente.pagado_show=o.toFixed(2),xThisCuentasPorCobrar.arrTotalesListCreditoCliente.debe_show=a.toFixed(2),xThisCuentasPorCobrar.arrTotalesListCreditoCliente=JSON.parse(JSON.stringify(xThisCuentasPorCobrar.arrTotalesListCreditoCliente)),xThisCuentasPorCobrar.importePagadoCuentaCobrar=o}async function xShowIngresoPagoCuentaCobrar(a){var o=paramsSwalAlert,o=(o.title='<p class="fw-600 fs-18">Elige el metodo de pago</p><p class="fs-13">Se registrará como una <span class="fw-600 text-primary">ingreso a caja</span></p>',o.html=`<div class="pb-2" style="display: inline-flex;">                    
                                        <x-comp-find-tipo-pago-option class="tpf_option_cuenta_cobrar"></x-comp-find-tipo-pago-option>
                                    </div>`,o.confirmButtonText="Listo, registrar",o.showCancelButton=!0,await showAlertSwalHtmlDecision(o,0));o.isConfirmed&&(xPopupLoad.xopen(),xShowProccessPagoCuentaCredito())}async function xShowProccessPagoCuentaCredito(){xPopupLoad.xopen();let r=[],s=xThisCuentasPorCobrar.importePagadoCuentaCobrar;xThisCuentasPorCobrar.listConsumosCreditoCliente.map(e=>{if(0<s){let a=parseFloat(removeComas(e.debe));var t=s-a;let o=e.pagado;s-=a,a=0<t?(o=e.importe,0):(t*=-1,o=e.importe-t,t),r.push({idregistro_pago_detalle:e.idregistro_pago_detalle,pagado:o,flag_pagado:0==a?"1":"0"})}});var a=new httpFecht,o={idcliente:xThisCuentasPorCobrar.objCuentaCobrar.idcliente,idtipo_pago:itemOptionTpCuentaCobrarSelected.idtipo_pago,importe:xThisCuentasPorCobrar.importePagadoCuentaCobrar,debe:xThisCuentasPorCobrar.arrTotalesListCreditoCliente.debe_show,idusuario:xIdUsuario,listPagados:r};(await a.postJson("../../bdphp/log_009.php?op=2302",o)).success?(xThisCuentasPorCobrar.showDetalleCuentaCobrar=!1,xInitCuentasPorCobrar(),xRegistrarIngresoCajaCobroCredito()):xPopupLoad.xclose()}function xRegistrarIngresoCajaCobroCredito(a){var o={idtipo_pago:itemOptionTpCuentaCobrarSelected.idtipo_pago,total:xThisCuentasPorCobrar.importePagadoCuentaCobrar.toFixed(2),concepto:"PAGO DE CUENTA - "+xThisCuentasPorCobrar.objCuentaCobrar.nom_cliente,nom_cliente:xThisCuentasPorCobrar.objCuentaCobrar.nom_cliente};$.ajax({type:"POST",url:"../../bdphp/log_002.php",data:{op:"11",data:o}})}Polymer({is:"x-cuentas-por-cobrar",properties:{listCuentasPagar:[],listCuentasPagarMaster:[],listConsumosCreditoCliente:[],listCuentaPagarHistoriaPagosCliente:[],arrTotalesListCreditoCliente:{},totalDebeCliente:Number,totalConsumoCliente:Number,totalPagadoCliente:Number,showDetalleCuentaCobrar:Boolean,objCuentaCobrar:Object,enabledBtnCobrarCuenta:Boolean,importePagadoCuentaCobrar:Number,showHistoryPagos:Boolean},attached:function(){this.importePagadoCuentaCobrar=0,this.showDetalleCuentaCobrar=!1,this.enabledBtnCobrarCuenta=!1,this.showHistoryPagos=!1,xThisCuentasPorCobrar=this,xInitCuentasPorCobrar()},displayIndex:function(a){return xCeroIzq(a+1,1)}})</script></dom-module>