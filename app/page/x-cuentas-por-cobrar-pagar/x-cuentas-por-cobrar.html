<dom-module id="x-cuentas-por-cobrar"><script src="../../view/xSOAPSunat.js"></script><template><paper-dialog id="dialog_registro_detalle_consumo"class="dialog_redondo"style="overflow:auto;overscroll-behavior:auto;min-width:50%;max-width:700px"entry-animation="scale-up-animation"exit-animation="fade-out-animation"with-backdrop><div class="modal-dialog modal-lg"role="document"><div class="modal-content"><div class="d-flexx justify-content-between align-items-center header-dialog"><h4>Detalle del Consumo</h4><button class="btn btn-sm btn-secondary ml-2"dialog-dismiss>X</button></div><div class="modal-body mt-3"><div id="detalle-consumo-contenido"><div><p><strong>Fecha Consumo:</strong> {{consumoDetalle.fecha_consumo}}<p><strong>Transcurrido:</strong> {{consumoDetalle.pasaron}}</div><br><table class="w-100"><thead><tr><th>Descripción<th align="center">Cantidad<th align="right">Precio<tbody id="detalle-items"><template is="dom-repeat"items="[[listItemsConsumo]]"><tr><td>{{item.descripcion}}<td align="center">{{item.cantidad}}<td align="right">{{item.ptotal}}</template></table><br><div style="display:flex;align-items:flex-end;flex-direction:column"class="mr-2"><p><strong>Total Consumo:</strong> {{consumoDetalle.importe}}<p><strong>Total Pagado:</strong> {{consumoDetalle.pagado}}<p><strong>Debe Aún:</strong> {{consumoDetalle.debe}}</div></div></div><div class="modal-footer"><button class="btn btn-primary"hidden$="[[!tieneComprobante(consumoDetalle.external_id)]]"on-tap="verPdfComprobante"><i class="fa fa-file-pdf-o"></i> Ver Comprobante</button> <button dialog-dismiss class="btn btn-secondary">Cerrar</button></div></div></div></paper-dialog><div class="p-2"><div class="d-flexx justify-content-between"><p class="fw-600 fs-15">Cuentas por Cobrar</p><button hidden$="[[!showDetalleCuentaCobrar]]"class="btn btn-sm btn-secondary"onclick="xGoBackListaCuentasCobrar()"><i class="fa fa-arrow-left mr-1"></i> Atras</button><div hidden$="[[showDetalleCuentaCobrar]]"><button class="btn btn-sm btn-primary"onclick="xGoListCuentaCobrarHistorial()"><i class="fa fa-history"></i> Historial</button> <button class="btn btn-sm btn-secondary"onclick="xGoBackListaCuentasCobrarPrincipal()"><i class="fa fa-arrow-left mr-1"></i> Atras</button></div></div><div hidden$="[[!showDetalleCuentaCobrar]]"class="mt-2"><div class="xLinea2"></div><br></div><div hidden$="[[showDetalleCuentaCobrar]]"><div><p>Ventas registrados al credito.</div><br><input id="text_buscar_cliente_credito"class="xMiInput w-100"placeholder="Buscar Cliente"onkeyup="xBuscarClienteCredito(this)"><br><br><div><table class="w-100"><thead><th>#<th>Cliente<th align="right">Imp. Consumo<th align="right">Pagó<th align="right">Debe Aún<th align="center"><tbody><template is="dom-repeat"items="{{listCuentasPagar}}"><tr><td>{{displayIndex(index)}}<td>{{item.nom_cliente}} <i hidden$="[[!item.isHistory]]"class="fa fa-history text-primary"></i><td align="right"><p class="fw-600">{{item.total}}<td align="right"><p class="fw-600 text-success">{{item.pago}}<td align="right"><p class="fw-600 text-primary">{{item.debe}}<td><button data-id="[[item.idcliente]]"style="width:60px"class="btn btn-sm btn-xsm xBoton_flat_2"onclick="xCobrarCuentaCliente(this)"><span hidden$="[[item.isHistory]]">Cobrar</span> <span hidden$="[[!item.isHistory]]">Ver</span></button></template><tr><td align="right"colspan="2"><p class="fw-600 fs-15">Totales<td align="right"><p class="fw-600 fs-17">{{totalConsumoCliente}}<td align="right"><p class="fw-600 fs-17">{{totalPagadoCliente}}<td align="right"><p class="fw-600 fs-17">{{totalDebeCliente}}<td></table></div></div><div hidden$="[[!showDetalleCuentaCobrar]]"><section><p class="fw-600 fs-17">{{ objCuentaCobrar.nom_cliente }}<div class="d-flexx"><p class="fw-600 fs-15 mr-2"><i class="fa fa-id-card-o mr-1"></i> {{ objCuentaCobrar.num_dni }}<p class="fw-600 fs-15"><i class="fa fa-phone mr-1"></i> {{ objCuentaCobrar.telfono }}</div></section><br><div class="xLinea2"></div><br><section><div class="grid-container"><div class="column1"><div class="column-title d-flex justify-content-between align-items-center"><p>Consumos al credito<p class="fw-600 text-primary">Total: <span id="total-consumos-credito">0.00</span></div><div class="div-table"><table class="w-100 fs-12"><thead><th style="width:30px"><input type="checkbox"id="check-all-consumos"onclick="selectAllConsumos(this)"><th>#<th>Fecha<th>Consumo<th>Pagado<th>Debe<tbody><template is="dom-repeat"items="{{listConsumosCreditoCliente}}"><tr><td><input type="checkbox"class="consumo-check"data-index="{{index}}"data-id="{{item.idregistro_pago_detalle}}"data-debe="{{item.debe}}"onclick="calcularTotalSeleccionado()"><td>{{displayIndex(index)}}<td><p>{{item.fecha}}<p hidden$="[[item.isCuentaPagada]]"class="fs-10 text-secondary">{{item.pasaron}}</p><span hidden$="[[!item.isCuentaPagada]]"class="badge badge-primary">{{item.pasaron}}</span><td>{{item.total}} <button class="btn btn-sm btn-xsm xBoton_flat_2"data-id="{{item.idregistro_pago_detalle}}"onclick="verDetalleConsumo(this)">Ver</button><td>{{item.pagado}}<td>{{item.debe}}</template></table></div></div><div class="column2"><div class="column-title d-flex justify-content-between align-items-center"><p>Historial de Pagos<p class="fw-600 text-success">Total: <span id="total-historial-pagos">0.00</span></div><div class="div-table"><table class="w-100 fs-12"><thead><th>Fecha<th>Usuario<th align="right">Pagado<tbody><template is="dom-repeat"items="{{listCuentaPagarHistoriaPagosCliente}}"><tr><td><p>{{item.fecha}}<p>{{item.hora}}<td>{{item.nom_usuario}}<td align="right"><p class="fw-600">{{item.importe}}<p class$="[[item.classTp]]">{{item.nom_tipo_pago}}</template></table></div></div></div></section><br><section class="div-resumen-cuenta-pagar"><p class="fw-600 fs-15 text-secondary mb-3">Resumen de cuenta pendiente por pagar<div class="grid-totales pb-2"><div><p>Imp. Consumo<p class="fs-23 fw-600">{{ arrTotalesListCreditoCliente.total }}</div><div><p>Pagado<p class="fs-23 fw-600 text-success">{{ arrTotalesListCreditoCliente.pagado_show }}</div><div><p>Debe Aún<p class="fs-23 fw-600 text-primary">{{ arrTotalesListCreditoCliente.debe_show }}</div><div><p class="fw-600 fs-15">Importe a Pagar<p class="fs-11 text-secondary">Indique aqui el importe que pagará<div id="div-importe-seleccionado"style="display:none;margin-bottom:5px"><p class="fw-600 fs-13 text-primary">Importe seleccionado: <span id="importe-seleccionado">0.00</span></div><input type="number"class="xMiInput fs-23 fw-600"id="txt_importe_pago_cuenta_credito"onkeyup="xValidarBtnPagoCuentaCobrar(this)"placeholder=""> <button disabled$="[[!enabledBtnCobrarCuenta]]"class="btn btn-sm mt-2 btn-primary"style="float:right"onclick="xShowIngresoPagoCuentaCobrar()">Registrar Pago</button></div></div></section></div></div></template><style>.grid-container{display:grid;grid-template-columns:1fr 1fr;gap:10px}.column1{border:1px solid #ccc;border-radius:5px}.column2{border:1px solid #ccc;border-radius:5px}.column-title{border-radius:5px 5px 0 0;color:#fff!important;padding:5px 10px 5px 10px;background:#424242;height:30px;justify-content:space-between;display:flex;align-items:center}.div-table{max-height:300px;overflow:auto}.grid-totales{display:grid;grid-template-columns:1fr 1fr 1fr 1fr auto;gap:10px}.div-resumen-cuenta-pagar{border:1px solid #d7d7d7;padding:10px;border-radius:5px}@media (max-width:767px){.grid-container{grid-template-columns:1fr}.column2{margin-top:10px}.grid-totales{grid-template-columns:1fr 1fr}}</style><script>var xThisCuentasPorCobrar,itemOptionTpCuentaCobrarSelected;async function xInitCuentasPorCobrar(o=23){xPopupLoad.xopen();o=await(new httpFecht).postJson("../../bdphp/log_009.php?op="+o);o.success&&(xThisCuentasPorCobrar.listCuentasPagar=o.datos,xThisCuentasPorCobrar.listCuentasPagarMaster=o.datos.map(o=>(o.isHistory=0==parseFloat(o.debe),o)),xShowTotalCuentasPagar()),xPopupLoad.xclose(),$(document).on("getValorIncial",".tpf_option_cuenta_cobrar",function(o){itemOptionTpCuentaCobrarSelected=o.detail.values})}function xGoListCuentaCobrarHistorial(){xThisCuentasPorCobrar.showHistoryPagos=!0,xInitCuentasPorCobrar(23001)}function xShowTotalCuentasPagar(){xThisCuentasPorCobrar.totalConsumoCliente=xThisCuentasPorCobrar.listCuentasPagar.map(o=>parseFloat(removeComas(o.total))).reduce((o,e)=>o+e,0),xThisCuentasPorCobrar.totalPagadoCliente=xThisCuentasPorCobrar.listCuentasPagar.map(o=>parseFloat(removeComas(o.pago))).reduce((o,e)=>o+e,0),xThisCuentasPorCobrar.totalDebeCliente=xThisCuentasPorCobrar.listCuentasPagar.map(o=>parseFloat(removeComas(o.debe))).reduce((o,e)=>o+e,0),xThisCuentasPorCobrar.totalConsumoCliente=xThisCuentasPorCobrar.totalConsumoCliente.toFixed(2),xThisCuentasPorCobrar.totalPagadoCliente=xThisCuentasPorCobrar.totalPagadoCliente.toFixed(2),xThisCuentasPorCobrar.totalDebeCliente=xThisCuentasPorCobrar.totalDebeCliente.toFixed(2)}function xBuscarClienteCredito(o){const e=o.value;xThisCuentasPorCobrar.listCuentasPagar=xThisCuentasPorCobrar.listCuentasPagarMaster.filter(o=>o.nom_cliente.toLowerCase().includes(e.toLowerCase())),xShowTotalCuentasPagar()}function xCobrarCuentaCliente(o){const e=o.dataId;o=xThisCuentasPorCobrar.listCuentasPagar.find(o=>o.idcliente==e);xThisCuentasPorCobrar.objCuentaCobrar=o,xThisCuentasPorCobrar.showDetalleCuentaCobrar=!0,txt_importe_pago_cuenta_credito.value="",xLoadConsumoCreditoByCliente()}async function xLoadConsumoCreditoByCliente(){xPopupLoad.xopen(),xThisCuentasPorCobrar.enabledBtnCobrarCuenta=!1;var o=document.getElementById("div-importe-seleccionado"),o=(o&&(o.style.display="none"),{idcliente:xThisCuentasPorCobrar.objCuentaCobrar.idcliente}),t=xThisCuentasPorCobrar.showHistoryPagos?230101:2301,t=await(new httpFecht).postJson("../../bdphp/log_009.php?op="+t,o);if(t.success){xThisCuentasPorCobrar.listConsumosCreditoCliente=t.datos.map(o=>(o.isCuentaPagada="1"==o.flag_pagado,o));let e=0;t.datos.forEach(o=>{e+=parseFloat(removeComas(o.debe))});o=document.getElementById("total-consumos-credito");o&&(o.textContent=e.toFixed(2));let a={total:0,pagado:0,debe:0,pagadoShow:0,debeShow:0};t.datos.map(o=>{a.total+=parseFloat(removeComas(o.total)),a.pagado+=parseFloat(removeComas(o.pagado)),a.debe+=parseFloat(removeComas(o.debe))}),a.total=a.total.toFixed(2),a.pagado=a.pagado.toFixed(2),a.debe=a.debe.toFixed(2),a.pagado_show=a.pagado,a.debe_show=a.debe,xThisCuentasPorCobrar.arrTotalesListCreditoCliente=a,setTimeout(()=>{var o=document.getElementById("check-all-consumos");o&&(o.checked=!1),document.querySelectorAll(".consumo-check").forEach(o=>{o.checked=!1})},100)}xListCuentaPagarHistoriaPagosCliente(),xPopupLoad.xclose()}async function xListCuentaPagarHistoriaPagosCliente(){var o={idcliente:xThisCuentasPorCobrar.objCuentaCobrar.idcliente},o=await(new httpFecht).postJson("../../bdphp/log_009.php?op=2303",o);if(o.success){xThisCuentasPorCobrar.listCuentaPagarHistoriaPagosCliente=o.datos.map(o=>(o.classTp=getColorTipoPago(o.idtipo_pago),o.fecha=o.fecha_hora.split(" ")[0],o.hora=o.fecha_hora.split(" ")[1],o));let e=0;o.datos.forEach(o=>{e+=parseFloat(removeComas(o.importe))});o=document.getElementById("total-historial-pagos");o&&(o.textContent=e.toFixed(2))}}function selectAllConsumos(o){const e=o.checked;document.querySelectorAll(".consumo-check").forEach(o=>{o.checked=e}),calcularTotalSeleccionado()}function calcularTotalSeleccionado(){var o=document.querySelectorAll(".consumo-check:checked");let e=0;o.forEach(o=>{o=parseFloat(removeComas(o.dataDebe));isNaN(o)||(e+=o)});var a=document.getElementById("div-importe-seleccionado"),t=document.getElementById("importe-seleccionado"),o=(0<o.length?(a&&(a.style.display="block"),t&&(t.textContent=e.toFixed(2))):a&&(a.style.display="none"),document.getElementById("txt_importe_pago_cuenta_credito"));o&&(o.value=e.toFixed(2),o.fromCheckbox=!0,xValidarBtnPagoCuentaCobrar(o),o.fromCheckbox=!1)}function xGoBackListaCuentasCobrar(){xThisCuentasPorCobrar.showDetalleCuentaCobrar=!1}function xValidarBtnPagoCuentaCobrar(o){let e=parseFloat(o.value);isNaN(e)?(xThisCuentasPorCobrar.enabledBtnCobrarCuenta=!1,e=0):0<e&&(xThisCuentasPorCobrar.enabledBtnCobrarCuenta=!0),o.fromCheckbox||((a=document.getElementById("div-importe-seleccionado"))&&(a.style.display="none"),(a=document.getElementById("check-all-consumos"))&&(a.checked=!1),document.querySelectorAll(".consumo-check").forEach(o=>{o.checked=!1}));var a=parseFloat(xThisCuentasPorCobrar.arrTotalesListCreditoCliente.debe),o=(e>a&&(e=a,o.value=e),0===e&&(xThisCuentasPorCobrar.enabledBtnCobrarCuenta=!1),a-e);xThisCuentasPorCobrar.arrTotalesListCreditoCliente.pagado_show=e.toFixed(2),xThisCuentasPorCobrar.arrTotalesListCreditoCliente.debe_show=o.toFixed(2),xThisCuentasPorCobrar.arrTotalesListCreditoCliente=JSON.parse(JSON.stringify(xThisCuentasPorCobrar.arrTotalesListCreditoCliente)),xThisCuentasPorCobrar.importePagadoCuentaCobrar=e}async function xShowIngresoPagoCuentaCobrar(o){var e=paramsSwalAlert,e=(e.title='<p class="fw-600 fs-18">Elige el metodo de pago</p><p class="fs-13">Se registrará como una <span class="fw-600 text-primary">ingreso a caja</span></p>',e.html=`<div class="pb-2" style="display: inline-flex;">                    
                                        <x-comp-find-tipo-pago-option class="tpf_option_cuenta_cobrar"></x-comp-find-tipo-pago-option>
                                    </div>`,e.confirmButtonText="Listo, registrar",e.showCancelButton=!0,await showAlertSwalHtmlDecision(e,0));e.isConfirmed&&(xPopupLoad.xopen(),xShowProccessPagoCuentaCredito())}function procesarConsumo(a,t){var r={importeRestante:t,itemPagado:null};if(!(t<=0)){let e=parseFloat(removeComas(a.debe));if(!(e<=0)){t=t-e;let o=parseFloat(removeComas(a.pagado));r.importeRestante=Math.max(0,t),e=0<=t?(o=parseFloat(a.importe),0):(t=Math.abs(t),o=parseFloat(a.importe)-t,t),r.itemPagado={idregistro_pago_detalle:a.idregistro_pago_detalle,pagado:o,flag_pagado:0==e?"1":"0"}}}return r}async function xShowProccessPagoCuentaCredito(){xPopupLoad.xopen();var o=document.querySelectorAll(".consumo-check:checked"),e=0<o.length;let a=[],t=xThisCuentasPorCobrar.importePagadoCuentaCobrar;if(e){const s=new Map;o.forEach(o=>{o=parseInt(o.dataIndex);s.set(o,!0)}),xThisCuentasPorCobrar.listConsumosCreditoCliente.forEach((o,e)=>{s.has(e)&&0<t&&(e=procesarConsumo(o,t),t=e.importeRestante,e.itemPagado)&&a.push(e.itemPagado)})}else for(const n of[...xThisCuentasPorCobrar.listConsumosCreditoCliente].sort((o,e)=>o.idregistro_pago_detalle-e.idregistro_pago_detalle)){if(t<=0)break;var r=procesarConsumo(n,t);t=r.importeRestante,r.itemPagado&&a.push(r.itemPagado)}e=new httpFecht,o={idcliente:xThisCuentasPorCobrar.objCuentaCobrar.idcliente,idtipo_pago:itemOptionTpCuentaCobrarSelected.idtipo_pago,importe:xThisCuentasPorCobrar.importePagadoCuentaCobrar,debe:xThisCuentasPorCobrar.arrTotalesListCreditoCliente.debe_show,idusuario:xIdUsuario,listPagados:a};(await e.postJson("../../bdphp/log_009.php?op=2302",o)).success?(xThisCuentasPorCobrar.showDetalleCuentaCobrar=!1,xInitCuentasPorCobrar(),xRegistrarIngresoCajaCobroCredito()):xPopupLoad.xclose()}function xRegistrarIngresoCajaCobroCredito(o){var e={idtipo_pago:itemOptionTpCuentaCobrarSelected.idtipo_pago,total:xThisCuentasPorCobrar.importePagadoCuentaCobrar.toFixed(2),concepto:"PAGO DE CUENTA - "+xThisCuentasPorCobrar.objCuentaCobrar.nom_cliente,nom_cliente:xThisCuentasPorCobrar.objCuentaCobrar.nom_cliente};$.ajax({type:"POST",url:"../../bdphp/log_002.php",data:{op:"11",data:e}})}function verPdfComprobante(){0!=this.consumoDetalle.external_id&&xSoapSunat_DownloadFile("pdf",this.consumoDetalle.external_id)}async function verDetalleConsumo(o){const e=o.dataId;if(e){xPopupLoad.xopen();try{const a=xThisCuentasPorCobrar.listConsumosCreditoCliente.find(o=>o.idregistro_pago_detalle==e);a?$.ajax({type:"POST",url:"../../bdphp/log.php?op=2003",data:{i:a.idregistro_pago}}).done(function(o){(o=JSON.parse(o)).success&&o.datos&&(a.fecha_consumo=xDevolverFechaDada2(a.fecha),xThisCuentasPorCobrar.consumoDetalle=a,xThisCuentasPorCobrar.listItemsConsumo=o.datos,dialog_registro_detalle_consumo.open())}):(xAlert.error("No se encontró información del consumo"),xPopupLoad.xclose())}catch(o){xAlert.error("Error al cargar el detalle del consumo")}finally{xPopupLoad.xclose()}}}Polymer({is:"x-cuentas-por-cobrar",properties:{listCuentasPagar:[],listCuentasPagarMaster:[],listConsumosCreditoCliente:[],listCuentaPagarHistoriaPagosCliente:[],arrTotalesListCreditoCliente:{},totalDebeCliente:Number,totalConsumoCliente:Number,totalPagadoCliente:Number,showDetalleCuentaCobrar:Boolean,objCuentaCobrar:Object,enabledBtnCobrarCuenta:Boolean,importePagadoCuentaCobrar:Number,showHistoryPagos:Boolean,listItemsConsumo:Array,consumoDetalle:Object},tieneComprobante:function(o){return o&&0!=o},verPdfComprobante:function(){this.consumoDetalle&&this.consumoDetalle.external_id&&0!=this.consumoDetalle.external_id&&xSoapSunat_DownloadFile("pdf",this.consumoDetalle.external_id)},attached:function(){this.importePagadoCuentaCobrar=0,this.showDetalleCuentaCobrar=!1,this.enabledBtnCobrarCuenta=!1,this.showHistoryPagos=!1,xThisCuentasPorCobrar=this,xInitCuentasPorCobrar()},displayIndex:function(o){return xCeroIzq(o+1,1)}})</script></dom-module>