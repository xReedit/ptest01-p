<link rel="import"href="../x-componentes/x-comp-find-categoria/x-comp-find-categoria.html"><link rel="import"href="../x-componentes/x-comp-descuento/x-comp-descuento.html"><dom-module id="x-control-mesas"><script src="../view/config.const.js"></script><script src="../view/socket.service.p.js"></script><script src="../view/notifica.js"></script><template><x-pass id="pass_us"titulo="Usuario autorizado"valor="Pe1"></x-pass><paper-dialog id="dialog_erro_print"modal style="min-width:330px"modal entry-animation="scale-up-animation"exit-animation="fade-out-animation"><h4>Error en impresora</h4><p id="print_error"></p><br><div class="xBoton2 xVerde divLeft23"onclick="xReImprimir()">Intentar Nuevamente</div><div class="xBoton2 xPlomo divLeft23"dialog-dismiss onclick="dialog_detalle.close()">No imprimir</div><br><br><br></paper-dialog><paper-dialog style="min-width:290px;background:#212121;color:#fff"id="dialog_borrar_item"entry-animation="scale-up-animation"exit-animation="fade-out-animation"with-backdrop><div class="xContent"><h3>BORRAR REGISTRO?</h3><br><div class="xBoton2 xVerde"dialog-dismiss onclick="xEliminarItemPedido()">SI</div><div class="xBoton2 xRojo"dialog-dismiss>Cancelar</div><br><br></div></paper-dialog><paper-dialog style="min-width:290px;width:80%"id="dialog_add_item"entry-animation="scale-up-animation"exit-animation="fade-out-animation"with-backdrop><div class="xContent"><br><div><input class="xMiInput"placeholder="buscar..."style="width:70%"inline id="txt_bus_item"> <input type="number"class="xMiInput"placeholder="cantidad"style="width:20%"value="1"pattern="[0-9]+([\.,][0-9]+)?"step="any"min="1"inline id="cant_item"></div><br><br><br><div class="xBoton2 xVerde"dialog-confirm onclick="xBorrar_item()">SI</div><div class="xBoton2 xRojo"dialog-dismiss>Cancelar</div><br><br></div></paper-dialog><paper-dialog id="dialog_cambiar_mesa"style="max-width:350px"entry-animation="scale-up-animation"exit-animation="fade-out-animation"with-backdrop><div class="xContent"><br><h4>CAMBIAR</h4><h4 id="titulo_cambiar_mesa"class="txt_anular_cambiar_mesa">Cambiar de mesa todos los pedidos</h4><div><h4>Mesa:</h4><input type="number"class="xMiInput xfont18"placeholder="Numero mesa"enlinea pattern="[0-9]+([\.,][0-9]+)?"step="any"min="1"inline id="txt_num_mesa_change"autofocus></div><br><br><br><div class="xBoton2 xVerde"dialog-confirm onclick="xCambiarMesa()">Cambiar</div><div class="xBoton2 xRojo"dialog-dismiss>Cancelar</div><br><br></div></paper-dialog><paper-dialog id="dialog_motivo_anular"style="min-width:320px"entry-animation="scale-up-animation"exit-animation="fade-out-animation"with-backdrop><div class="xContent"><h4>ANULAR</h4><h4 class="txt_anular_cambiar_mesa"></h4><br><h4>Indique el motivo de anulacion</h4><div><input class="xMiInput"placeholder="Motivo..."id="txt_motivo_anular"autofocus></div><br><br><br><div class="xBoton2 xVerde"dialog-dismiss onclick="pass_us.open()">Listo</div><div class="xBoton2 xRojo"dialog-dismiss>Cancelar</div><br><br></div></paper-dialog><paper-dialog id="dialog_cambiar_item"style="border:1px solid #bdbdbd"entry-animation="scale-up-animation"exit-animation="fade-out-animation"with-backdrop><h3>CAMBIAR POR</h3><div><input class="xMiInput xfont18 xPasarEnter2"placeholder="Buscar"id="list_bus_item"inline autofocus espaciar> <input type="number"min="1"max="2"onkeyup="xValidarCant_change(this)"onchange="xValidarCant_change(this)"class="xMiInput xfont18 xPasarEnter2 xtxtCentro"placeholder="Cantidad"id="txt_bus_cant"value="1"inline espaciar> <input class="xMiInput xPasarEnter2"placeholder="Especificaciones..."id="txt_espcificacion"inline autofocus espaciar><form id="frm_change_item"method="post"class="xInvisible"><input id="idpedido_detalle"name="idpedido_detalle"> <input id="idpedido"name="idpedido"> <input id="idtipo_consumo"name="idtipo_consumo"> <input id="idcategoria"name="idcategoria"> <input id="idcarta_lista"name="idcarta_lista"> <input id="iditem"name="iditem"> <input id="idseccion"name="idseccion"> <input id="cantidad"name="cantidad"> <input id="punitario"name="punitario"> <input id="ptotal"name="ptotal"> <input id="descripcion"name="descripcion"></form><br><br><div class="xBoton2 xVerde"dialog-confirm onclick="xCambiar_item()">Listo</div><div class="xBoton2 xRojo"dialog-dismiss>Cancelar</div><br></div></paper-dialog><paper-dialog style="min-width:290px;max-width:450px"id="dialog_info_call_repartidor"entry-animation="scale-up-animation"exit-animation="fade-out-animation"with-backdrop><div class="xContent"><p id="msj_dialo_call"></p><br><div class="xBoton2 xVerde"dialog-dismiss onclick="xCallRepartidorPapayaExec()">Si, Confirmo.</div><div class="xBoton2 xPlomo"dialog-dismiss>Cancelar</div><br><br></div></paper-dialog><paper-dialog modal id="dialog_detalle"class="tall-polys tall xNoScroll"entry-animation="scale-up-animation"exit-animation="fade-out-animation"with-backdrop><div><iron-pages selected="0"id="content_page"class="xNoScroll"><div id="div_detalle_pedido"class="xNoScroll"><div class="lh-7"><div class="xDerecha"><paper-fab mini icon="perm-phone-msg"onclick="xCallRepartidorPapaya()"title="Llamar a Repartidor de Papaya Express"tabindex="0"class="btnAddPapaya"id="btnLlamarRepartidorP"></paper-fab><paper-fab icon="add"onclick="xOpenLULI()"title="[F8] Agregar item"tabindex="0"class="btnAdd2"></paper-fab></div><h3 id="p_mesa">MESA 02</h3><div class="xfont11 pb-3"><span id="p_correlativo">CO: 00112</span><span id="p_referencia"> DR VALDES</span><span id="p_antendido"> | ATENDIDO POR: ORLANDO</span></div><div class="xdiv-info-delivery xInvisible lh-15"id="content-info-delivery"><div id="divRepartidorPropio"class="pb-3"><div id="divRepartidorNom"class="xInvisible"><span class="xfont11">Repartidor: </span><span class="xBold"id="a_nom_repartidor"></span><hr></div><div id="divRepartidorSelect"class="xInvisible"><span class="xfont11">Repartidor: </span><select name=""id="selectRepartidor"onchange="selectRepartidor()"><option value="-1">No Asignado</option><template is="dom-repeat"items="{{listRepartidor}}"as="repartidor"><option value="[[index]]">[[repartidor.nombre]]</template></select><hr></div></div><div class="div-info-pedido"><div class="w-50"><span class="xColorRow_Plomo3 fs-13">Datos del Cliente</span><div id="info-pedido"class="fs-11"></div></div><div class="w-50"><p class="xColorRow_Plomo3 fs-13">Comprobante<div id="info-comprobante"class="fs-11"></div></div></div><div id="div-info-delivery-from-app"class="xInvisible"style="padding:5px 0 5px 0;border-top:1px solid #bbbb;background:#faebd7"><div class="xfont12"id="txt-info-delivery-from-app"></div></div></div></div><div class="xLinea"></div><br><div class="content-pedido"><table width="100%"class="xtable4"><tr class="xSinBorde_tr"valign="top"><td width="40%"class="pd-r-10"><div class="xtd-derecha"><table width="100%"id="tb_pedidos"class="xRowPading4"><thead><th colspan="5"align="left">PEDIDOS</thead><tr class="row selected1 xCursor check_item_p"data-idpedido="1"><td><paper-checkbox checked="checked"class="check_item"></paper-checkbox>1<td>Pedido 00102<td>13:15:02<td align="right"class="td_importe"id="td_importe">120.00<tr class="row selected1 xCursor check_item_p"data-idpedido="2"><td><paper-checkbox checked="checked"class="check_item"></paper-checkbox>2<td>Pedido 00102<td>13:15:02<td align="right"class="td_importe"id="td_importe">120.00<tr class="row selected1 xCursor check_item_p"data-idpedido="3"><td><paper-checkbox checked="checked"class="check_item"></paper-checkbox>3<td>Pedido 00102<td>13:15:02<td align="right"class="td_importe"id="td_importe">120.00</table><br><x-comp-descuento id="component_descuento_pedido"importeventa$="[[ importeTotalPedido ]]"></x-comp-descuento></div><td class="xBordeIzq pd-l-10"><img src="../../images/_union.png"onclick="xJuntarFilasIguales()"class="xDerecha xAlinearce xCursor pos-union"title="Unir items"> <img src="../../images/_juntar_row.png"onclick="xDesJuntarItem()"class="xDerecha xAlinearce xCursor pd-l-10-a"title="Separar items"><div class="xtd-derecha"id="xBody"><div><table width="100%"id="tb_det_pedidos"class="xRowPading4"><tr><td colspan="5"class="xFondoRowPlomo">CONSUMIR EN EL LOCAL<tr><td colspan="5"><h4>ENTRADAS</h4><tr class="row xCursor"data-idpedidodetalle="1"data-idpedido="1"data-punitario="1.00"data-idtipoconsumo="1"data-idcategoria="1"data-idcartalista="117422605116"><td width="50px"class="click_row_dt_p"id="td_cant"><paper-checkbox class="check_item"></paper-checkbox>03<td class="click_row_dt_p">COCO RALLADO<td class="click_row_dt_p"align="right"id="td_importe">0.00<td align="center"class="td_op"data-op="cambiar"><img src="../../images/_change.png"title="Cambiar"><td align="center"class="td_op"data-op="borrar"><img src="../../images/_delete3.png"title="Borrar"><tr class="row xCursor"data-idpedidodetalle="2"data-idpedido="1"data-punitario="2.00"data-idtipoconsumo="1"data-idcategoria="1"data-idcartalista="11122605116"><td width="50px"class="click_row_dt_p"id="td_cant"><paper-checkbox class="check_item"></paper-checkbox>02<td class="click_row_dt_p">GELATINA<td class="click_row_dt_p"align="right"id="td_importe">2.00<td align="center"class="td_op"data-op="cambiar"><img src="../../images/_change.png"title="Cambiar"><td align="center"class="td_op"data-op="borrar"><img src="../../images/_delete3.png"title="Borrar"></table></div></div><div class="d-flexx justify-content-end align-items-center"style="position:sticky;width:100%"hidden$="[[ !isAddItemRow ]]"><button class="btn btn-success"style="margin-top:-80px"onclick="xArmarSqlAddLUlI()"><i class="fa fa-check"></i> Confirmar</button></div></table></div><div class="xAddItemPedido xNoScroll"id="SelAddLuLi"><div><x-comp-find-categoria id="compFindCategoria"onchange="_getCategoria(categorias)"></x-comp-find-categoria><select class="xTextRow2 xCursor w-100"id="select_ulTPC"></select> <input class="xMiInput w-100"placeholder="Buscar.."id="txt_bus_item_add"></div><br><ul id="accordion"class="list_add_item noselect"></ul><br><div class="footer_dialog-more-item xFondoRowPlomo3"><div class="xLinea"></div><br><div class="xBoton2 xVerde"onclick="xArmarSqlAddLUlI()">F9 | Confirmar</div><div class="xBoton2 xPlomo"onclick="xCloseLULI()">Cerrar</div><br></div><div class="xInvisible"><table data-tablaname="pedido_detalle"id="xli_tb_pedido_ad"></table></div></div><div class="footer_dialog xAlinearce xFondoRowBlanco2"><div class="xLinea"></div><br><div class="xDerecha pos-fotter-btn"><div class="xMiBoton_icon_lateral mg-t-15"onclick="xImprimirPrecuenta()"><img src="../../images/_pre_cuenta.png"><p>Imprimir pre-cuenta</div><div class="xMiBoton_icon_lateral mg-t-15"onclick="xOpenCambiarMesa()"id="btn_cambiar_mesa"><img src="../../images/_cambiar_mesa.png"><p>Cambiar de mesa</div><div class="xMiBoton_icon_lateral mg-t-15"onclick="xOpenAnularPedido()"id="btn_anular_pedido"><img src="../../images/_delete_pedido.png"><p>Anular pedido</div></div><button class="xBoton2 xAzul"id="btn_registrar_pago"onclick="xIrPage(1)">F10 | Listo, pagar</button> <button class="xBoton2 xPlomo"dialog-dismiss>Cerrar</button><br></div></div><div id="div_pago"><x-pago id="component_pago"></x-pago></div><br><br></iron-pages></div></paper-dialog><br><div class="xContent d-flex"><div class="grid"id="_gridCM"><paper-spinner active class="xCentradoVerticalHorizontal"></paper-spinner></div></div></template><style>.lh-7{line-height:7px}.lh-15{line-height:15px}.pd-r-10{padding-right:10px}.pd-l-10{padding-left:10px}.pd-l-10-a{padding-left:10px;position:absolute;right:40px}.mg-t-15{margin-top:-15px}.pos-union{position:absolute;right:78px}.pos-fotter-btn{margin-top:12px;display:inline-flex}.div-filtro-header-input{width:80px;margin-right:5px}.subtotal-tr-row{padding-top:1px;padding-bottom:1px}.xdiv-info-delivery{padding:10px 0 0 0;border-top:1px solid #d3d3d3;margin-top:10px;color:gray}.content-info-delivery{line-height:15px}.txt-info-delivery{line-height:15px!important}.txt-info-delivery-from-app{padding:5px 5px!important}</style></dom-module><style type="text/css">.grid:after{content:'';display:block;clear:both}#dialog_detalle.tall{border-radius:5px;width:100%;min-width:300px;position:fixed;top:0;left:2;bottom:0;right:2;margin:2px;min-height:50vh;width:-webkit-fill-available;height:-webkit-fill-available}#dialog_detalle.tall-polys{width:-webkit-fill-available;height:-webkit-fill-available;border-radius:5px}#dialog_detalle.normal{border-radius:5px;width:auto 0;min-width:300px}.xtd-derecha{height:calc(100vh - 193px);bottom:0;overflow-y:auto}img.xdisabled{pointer-events:none;opacity:.5;cursor:auto}</style><script src="../view/item_pedidos.js"></script><script src="../view/xJsonSunat.js"></script><script src="../view/xSOAPSunat.js"></script><script src="../view/cpe_interno.js"></script><script src="../view/cliente.service.js"></script><script src="../view/item_pedido_estructura.js"></script><script src="../view/item_pedido_subtotales.js"></script><script src="../view/item_pedido_print_comprobante.js"></script><script src="../view/deNumALetras.js"></script><script src="../view/manager_storage.js"></script><script>var xThisCM,xsourceEvent,xRefreshPedidos,xRefreshHora,xIdFiltro1="",xCronometro_us=0,xPermisoSupervisor=0,xRefreshPermiso,xpass_op,xid_pedido_detalle_item,xid_carta_lista_de,xid_carta_lista_a,xidprocede_item_lista,xdescontar_en_item_lista,xIDdescontar_en_item_lista,xid_pedido,xid_tpc_item,xid_cat_item,xcant_item,xobj_row_item,xObj_miPedido,xPopupLoad,xtt_pedidos=0,xDtPrint=[],xDtSede_cm=[],xArrayEnca=[],xArrayPrintEncaLi=[],xArrayPedido=[],xDtSubTotales=[],xRpt_pago=[],xitem_print,xidpedido_filtro=0,xArraychek_pedido=[],xAgrupar_item_activo=!1,xArrayTpC=[],xArraySeccion=[],xArrayDtOrdenFiltro=[],xopen_add_item=!1,xidpedid_txt_change="",xSelAllPedidos=!1,xbuscar_mesa=!1,iIniIsotope=!1,xkey_f10=!0,xidCategoriaPD="",xArrayItemEliminar=[],xCountTotalPedidos=0,xValCountPedidos=0,enProcesoGuardarPago=!1,guardandoPedido_cp=0,checkItemsSeleccionados=[],arrSumSubtTotales=[],ImporteDiferencia=0,xImporteTotalSeleccionados=0,datosDelivery=null,isSocket=!1,isPedidoOpenDeliveryCliente=!1,arrTotalesDeliveryCliente,xid_pedido_selected,optionDeliveryCliente,xdtDpedido,pasoRedibujado=!1,isPedidoPagadoFromApp=!1,cuentaEventoLoadIni=0,cuentaEventoLoadIniPrincipal=0,xCompDescuentoPedido,arrSubtTotalesDescuento,xPSupervisor,lastIdPedidoPrint=0,EstadoLoadMesas=!1,firstLoad_mesas=!0;function xIniControlMesa(){$("#accordion").accordion({heightStyle:"content",animate:50}),$("#spinner_li").spinner({min:0,step:1}),$("#tb_accordion").accordion({heightStyle:"content"}),xPopupLoad=document.getElementById("xLoad"),isSocket=0!==parseInt(xm_log_get("datos_org_sede")[0].pwa),firstLoad_mesas=!0,xm_log_get("ini_us"),xNuevoPedidoCM(),xTraerDtTipoConsumo(),xLoadDtPrintCM(),xLoadMesas(),xRefreshHora=setInterval(function(){xCalcularTiempoPedido()},2e3);var e=getUrlParameter("df1","?"),e=(xIdFiltro1=getUrlParameter("f1","?"),$("#Titulo_page").text("PEDIDOS | "+e),document.title="Control de Pedidos",$("#div_filtro_header").html('<input type="text" class="xMiInput" id="txt_bus_mesa" name="txt_bus_mesa" style="width:80px; margin-right:5px;" placeholder="mesa" letrablanco><div class="xBoton2 xVerde" onclick="xOrdenPedido(1);">Por Estado</div><div class="xBoton2 xPlomo" onclick="xOrdenPedido(0);">Por Numero</div>'),xThisCM.xt_org=xIdOrg,xThisCM.xt_idsede=xIdSede,xThisCM.xt_idus=xIdUsuario,document.defaultAction=!1,detectEvent);document.body.onkeydown=e,$(".xPasarEnter2").on("keyup",function(e){var a,t,e=e.which;if(13==e||186==e)return a=(e=$("input")).index(document.activeElement),null!==e[a+1]&&(t=(t=e[a+1]).disabled?e[a+2]:t).focus(),!1}),$("#txt_bus_item_add").keyup(function(e){var a=$(this).val();""==a?$(".list_add_item li").each(function(){$(this).show()}):($(".list_add_item li").each(function(){($(this).text()+$(this).attr("data-cat")).search(new RegExp(a,"i"))<0?$(this).hide():($(this).show(),$(this).find("ul").show())}),13==e.keyCode&&1==$(".list_add_item li ul li:visible").length&&(xBtnSumarRestarKey($(".list_add_item li ul li:visible").find(".xBtn_li"),1),$(this).val("")))}),$(document).on("focusout",".list_add_item li ul li",function(e){var a=$(this).find("#xinput_li");"inline-block"==$(a).css("display")&&""==$(a)[0].value&&$(a).css("display","none")}),$(document).on("click",".xbtn_li_editar",function(e){$(this).parent().find("#xinput_li").css("display","inline-block"),$(this).parent().find("#xinput_li").focus(),e.stopPropagation(),e.stopImmediatePropagation()}),$(document).on("click",".check_item_p",function(e){xCheckPedidos(),1==xSelAllPedidos&&$("#tb_pedidos .check_item").each(function(e,a){a.checked=!1,$(a).parent().parent().removeClass("selected1"),$(a).parent().parent().find("#td_importe").removeClass("td_importe")});var a=this.classList.contains("selected1");$(this).attr("data-idpedido");1==a?($(this).removeClass("selected1"),$(this).find(".check_item").attr("checked",!1),$(this).find("#td_importe").removeClass("td_importe")):($(this).addClass("selected1"),$(this).find(".check_item").attr("checked",!0),$(this).find("#td_importe").addClass("td_importe")),xFiltrarRowArray(),xSumarTotalPedidos(),xCheckPedidos(),e.stopPropagation(),e.stopImmediatePropagation()}),$(document).on("click",".click_row_dt_p",function(e){var a=$(this).parent();1==a.hasClass("selected1")?(a.removeClass("selected1"),a.find(".check_item").attr("checked",!1),a.find("#td_importe").removeClass("td_importe")):(a.addClass("selected1"),a.find(".check_item").attr("checked",!0),a.find("#td_importe").addClass("td_importe")),xSumarTotalPedidos(),e.stopPropagation(),e.stopImmediatePropagation()}),$(document).on("click",".btn-add-item",function(e){var a=(xobj_row_item=$(this).parents("tr")[0]).dataset.idtipoconsumo,t=parseInt(xobj_row_item.dataset.cantidad)+1,o=parseFloat(xobj_row_item.dataset.punitario),o=parseFloat(t*o).toFixed(2);xobj_row_item.dataset.cantidad=t,xobj_row_item.dataset.total=o,xobj_row_item.dataset.total_r=o,$(xobj_row_item).find("#td_cant").text(xCeroIzq(t,2)),$(xobj_row_item).find("#td_importe").text(o),$("#select_ulTPC").val(a),xThisCM.isAddItemRow=!0,handlerFnMiPedidoControl(e),e.stopPropagation(),e.stopImmediatePropagation()}),$(document).on("click",".td_op",function(e){"0"==$(this).attr("data-procede")&&(xpass_op=$(this).attr("data-op"),xobj_row_item=$(this).parent(),1!=xAgrupar_item_activo)&&(xArrayItemEliminar=[],xArrayItemEliminar={procede:xobj_row_item.attr("data-descontar"),cant_descontar:xobj_row_item.attr("data-cant_descontar"),idprocede:xobj_row_item.attr("data-iddescontar"),idalmacen_items:xobj_row_item.attr("data-idcartalista"),idcarta_lista:xobj_row_item.attr("data-idcartalista"),iditem:xobj_row_item.attr("data-iditem"),idpedido_detalle:xobj_row_item.attr("data-idpedidodetalle"),idpedido:xobj_row_item.attr("data-idpedido"),precio_total:parseFloat(xobj_row_item.find("#td_importe").text()),precio_unitario:xobj_row_item.attr("data-punitario")},0==xCronometro_us?(xPSupervisor.setVal("Pe1"),pass_us.open()):xOp_permiso(),e.stopPropagation(),e.stopImmediatePropagation())}),(xPSupervisor=document.getElementById("pass_us")).setVal("Pe1"),xPSupervisor.addEventListener("xSend",function(e){1===e.detail.xRpts[0].p&&(xPermisoSupervisor=e.detail.xRpts[0].us,xCronometro_us=30,xRefreshPermiso=setInterval(function(){xcronometro_permiso()},1e3),xOp_permiso(),e.stopPropagation(),e.stopImmediatePropagation())}),$("#dialog_cotent").on("iron-overlay-opened",function(){$("#dialog_cotent #us").focus()}),(xValPago=document.getElementById("component_pago")).setObjConntet($("#dialog_detalle")),xValPago.addEventListener("xSend",function(e){xRpt_pago=e.detail.xRpts,0!==e.detail.xRpts[0].ok&&1==e.detail.xRpts[0].paseEnterTxt&&xRegistrarClientePagoCP()}),xValPago.addEventListener("xCancelarCerrar",function(e){xIrPage(0)}),xValPago.addEventListener("xListoRegistraPago",function(e){xRegistrarClientePagoCP()}),(xCompDescuentoPedido=document.getElementById("component_descuento_pedido")).addEventListener("changeDescuento",function(e){var a=e.detail;arrSubtTotalesDescuento=colocarDescuentoSubtotales(a.value,arrSumSubtTotales,a.descripcion,a.isAgregar),xSumarTotalPedidos(null,!0),e.stopPropagation(),e.stopImmediatePropagation()}),$("#dialog_detalle").on("iron-overlay-closed",function(){xbuscar_mesa=!1}),$("#dialog_detalle").on("iron-overlay-opened",function(){xbuscar_mesa=!0}),$("#dialog_cambiar_mesa").on("iron-overlay-closed",function(){$("#txt_num_mesa_change").focus()}),$("#dialog_motivo_anular").on("iron-overlay-closed",function(){$("#txt_motivo_anular").focus()}),$("#dialog_motivo_anular #txt_motivo_anular").keyup(function(e){13==e.keyCode&&(dialog_motivo_anular.close(),xPSupervisor.setVal("Pe1"),pass_us.open())}),$("#dialog_cambiar_mesa #txt_num_mesa_change").keyup(function(e){13==e.keyCode&&xCambiarMesa()}),$("#content_page").on("iron-select",function(e,a){1==e.target.selected&&component_pago.setFocusTxt()}),$(document).on("keyup",".xMiTextReferencia",function(e){e=e.target.parentElement.parentElement.dataset.index;xidTipoConsumo=$("#select_ulTPC option:selected").val(),itemPedidos_objItemSelected=xGeneralDataCarta[e],xidItem=itemPedidos_objItemSelected.idcarta_lista}),$(document.body).on("keydown","#txt_bus_mesa",function(t){var o;13==t.keyCode&&(o=parseInt($(this).val()),$(".xMiCardPedido.xOcupado").each(function(e,a){parseInt($(a).find(".numero").text())==o?(xLoadDetallesPedido($(a)),$("#txt_bus_mesa").select(),t.stopPropagation(),t.stopImmediatePropagation()):$("#txt_bus_mesa").val("")})),t.stopPropagation(),t.stopImmediatePropagation()}),(compFindCategoria=document.getElementById("compFindCategoria")).addEventListener("getValorIncial",function(e){let a;var t;a=e.detail.categorias,getLocalStorage("::app3_cat_defualt")?((t=JSON.parse(getLocalStorage("::app3_cat_defualt"))).idcategoria!=a.idcategoria?setLocalSotrage("::app3_cat_defualt",JSON.stringify(a)):a=t,xidCategoriaPD=a.idcategoria,setTimeout(()=>{compFindCategoria.$.compFindListCategoria.value=a.index},500)):xidCategoriaPD=e.detail.categorias.idcategoria,setLocalSotrage("::app3_cat_defualt",JSON.stringify(a))}),xPopupLoad=document.getElementById("xLoad"),$(document.body).on("change","#select_ulTPC",function(e){xChangeTipoConsumoItems(e.target.value)}),getAllRepartidor()}function _getCategoria(e){xidCategoriaPD=e.idcategoria,setLocalSotrage("::app3_cat_defualt",JSON.stringify(e)),xLoadDataUlAdd()}function xValPagoMostrarContainerPago(){xValPago.setVisibleContainerPago()}async function PreparComprobante(){var e=await getItemsSeleccionados(),e=e.esSeleccionTotal?[]:e.arrayPedidosSeleccionados,e=xCargarDatosAEstructuraImpresion(e);xArmarSubtotalesArray(e,xDtPrint)}async function getItemsSeleccionados(){var t,e,o="",i=[],d=0,r=0,a=parseFloat($("#tb_pedidos #tt_importe_pagar_t").text()),_=($("#tb_pedidos .row.selected1").each(function(e,a){d++,o=o+$(a).attr("data-idpedido")+",",t=$(a).attr("data-idcliente"),r+=parseFloat(r)+parseFloat($(a).find("#td_importe")),xid_tipo_consumo=$(a).attr("data-idtipoconsumo"),0===i.filter(e=>e===t).length&&i.push(t)}),o=o.slice(0,-1),e=d==xdtDpedido.length,[]),n=$("#tb_det_pedidos"),m=n.find(".row.selected1").length,s=(n.find(".row").length,parseInt(n.find(".row").length)),l=parseInt(n.find(".row.selected1").length),s=!(l<s&&0<l);return n.find(".row").each(function(e,a){var t=$(a).attr("data-idpedido"),o=($(a).attr("data-idcliente"),$(a).attr("data-iditem")),i=$(a).attr("data-idpedidodetaller"),d=$(a).attr("data-totalr"),r=$(a).attr("data-punitario"),n=$(a).attr("data-cantidadr"),s=$(a).attr("data-total"),l=($(a).attr("data-cantidad"),$(a).attr("data-des_seccion")),p=$(a).attr("data-idseccion"),c=$(a).attr("data-subtotales_tachados"),x=$(a).find("#descripcion_item").text();-1!==i.indexOf(",")&&(i=i.slice(0,-1),d=d.slice(0,-1),n=n.slice(0,-1)),xid_tipo_consumo=$(a).attr("data-idtipoconsumo"),0!==m&&!$(a).hasClass("selected1")||_.push({des_seccion:l,idseccion:p,descripcion:x,idpedido:t,idpedido_detalle:i,iditem:o,cantidad:n,precio:r,total:d,ptotal:s,idtipo_consumo:xid_tipo_consumo,subtotales_tachados:c})}),{esSeleccionTodoPeidoLista:e,esSeleccionTotal:s,arrayPedidosSeleccionados:_,arrayIdClienteUsPedido:i,idPedidosSeleccionados:o,tipoConsumo:xid_tipo_consumo,importeTotalSeleccionado:a,importeTotalSubItemSeleccionados:r}}function addListClienteUsuarioPedido(e){}function xCheckPedidos(){var t=0,o=0,i="";xidpedid_txt_change="",xSelAllPedidos=!1,$("#btn_cambiar_mesa").attr("disabled",!1),$("#btn_anular_pedido").attr("disabled",!1),$("#btn_registrar_pago").attr("disabled",!1),xkey_f10=!0,$("#tb_pedidos .check_item").each(function(e,a){1==a.checked&&(xidpedid_txt_change=xidpedid_txt_change+","+$(a).parent().parent().attr("data-idpedido"),xnum_pedido_check=$(a).parent().parent().find("td:nth-child(2)").text(),i=i+" "+xnum_pedido_check+",",t++),o++}),0==t&&($("#btn_cambiar_mesa").attr("disabled","disabled").off("click"),$("#btn_registrar_pago").attr("disabled","disabled").off("click"),$("#btn_anular_pedido").attr("disabled","disabled").off("click"),xkey_f10=!1),o==t&&(i="todos los pedidos: ",xSelAllPedidos=!0),t<o&&(i="los pedidos: "+(i=i.slice(0,-1))+"."),$(".txt_anular_cambiar_mesa").text(i),xidpedid_txt_change=xidpedid_txt_change.slice(1)}function empty(){}function detectEvent(e){var a=e||window.event;if(27==a.keyCode){if(dialog_cambiar_mesa.opened)return void dialog_cambiar_mesa.close();if(xopen_add_item)return void xCloseLULI();if(1==content_page.selected)return void xIrPage(0);if(dialog_detalle.opened)return void dialog_detalle.close()}if(48<=e.keyCode&&e.keyCode<=57||96<=e.keyCode&&e.keyCode<=105){if(1==xbuscar_mesa)return;$("#txt_bus_mesa").focus(),1==xbuscar_mesa&&($("#txt_bus_mesa").select(),xbuscar_mesa=!1)}if(119<=a.keyCode&&a.keyCode<=121)return 119==a.keyCode&&dialog_detalle.opened&&xOpenLULI(),120==a.keyCode&&xopen_add_item&&xArmarSqlAddLUlI(),121==a.keyCode&&1==xkey_f10&&1!==xThisCM.$.content_page.selected&&(xIrPage(1),a.stopPropagation(),e.stopPropagation(),e.stopImmediatePropagation()),document.defaultAction}function xOpenAnularPedido(){""==xidpedid_txt_change&&xCheckPedidos(),""!=xidpedid_txt_change&&(xpass_op="anular_pedido",xPSupervisor.setVal("Pe1"),dialog_motivo_anular.open())}function xAnularPedido(){xCheckPedidos();var d=[];$("#tb_det_pedidos .row").each(function(e,a){var t=parseFloat($(a).find("#td_cant").text()),o=($(a).attr("data-idpedido"),$(a).attr("data-iddescontar")),i=$(a).attr("data-cant_descontar"),a=$(a).attr("data-descontar");d.push({idpedidos:xidpedid_txt_change,m_a:$("#txt_motivo_anular").val(),c:i,cant_item:t,iddescontar:o,tabladescontar:a})}),xPopupLoad.xopen(),$.ajax({type:"POST",url:"../../bdphp/log.php?op=5011",data:{ArrayPeAnular:d,xPedidos:xidpedid_txt_change,xMotivo:$("#txt_motivo_anular").val(),u:xPermisoSupervisor}}).done(function(e){xPopupLoad.xclose(),xActualizarItems(),1==xSelAllPedidos&&($(xObj_miPedido).removeClass("xOcupado"),$(xObj_miPedido).removeClass("xDespachado"),$(xObj_miPedido).addClass("xNeutro"),$(xObj_miPedido).find(".show-led-precuenta").addClass("xInvisible"),$(xObj_miPedido).find(".show-led-print").addClass("xInvisible"),$(xObj_miPedido).find(".show-ico-mozo").addClass("xInvisible"),$(xObj_miPedido).find(".show-mozo-pedido").removeClass("pintar"),$(xObj_miPedido).find("#nommozo").text("."),$(xObj_miPedido).find(".importe").text("."),$(xObj_miPedido).find(".tiempo").text("disponible"),$(xObj_miPedido).attr("data-hora",""),$(xObj_miPedido).attr("data-estado","b"),$(xObj_miPedido).attr("data-abrir-detalle","0"),$(".grid").isotope("updateSortData",$(xObj_miPedido)).isotope("layout")),dialog_detalle.close()})}function xOpenCambiarMesa(){""==xidpedid_txt_change&&xCheckPedidos(),""!=xidpedid_txt_change&&dialog_cambiar_mesa.open()}function xCambiarMesa(){var e=txt_num_mesa_change.value;""!=e&&(xPopupLoad.xopen(),$.ajax({type:"POST",url:"../../bdphp/log.php?op=5010",data:{n:e,i:xidpedid_txt_change}}).done(function(e){dialog_cambiar_mesa.close(),txt_num_mesa_change.value="",xPopupLoad.xclose(),dialog_detalle.close(),$("#dialog_cambiar_mesa #titulo_cambiar_mesa").text().indexOf("todos")<0||($(xObj_miPedido).removeClass("xOcupado"),$(xObj_miPedido).removeClass("xDespachado"),$(xObj_miPedido).addClass("xNeutro"),$(xObj_miPedido).find(".show-led-precuenta").addClass("xInvisible"),$(xObj_miPedido).find(".show-led-print").addClass("xInvisible"),$(xObj_miPedido).find(".show-ico-mozo").addClass("xInvisible"),$(xObj_miPedido).find(".show-mozo-pedido").removeClass("pintar"),$(xObj_miPedido).find("#nommozo").text("."),$(xObj_miPedido).find(".importe").text("."),$(xObj_miPedido).find(".tiempo").text("disponible"),$(xObj_miPedido).attr("data-hora",""),$(xObj_miPedido).attr("data-estado","b"),$(xObj_miPedido).attr("data-abrir-detalle","0"),$(".grid").isotope("updateSortData",$(xObj_miPedido)).isotope("layout")),xPintarEstadoPedido()}))}async function xImprimirPrecuenta(){var e=xCargarDatosAEstructuraImpresion(checkItemsSeleccionados.arrayPedidosSeleccionados),a=$("#p_mesa").text().split(" "),t=$("#p_correlativo").text(),a=(t=(t=(t=t.replace("CO-","")).replace("|","")).replace(/\s/g,""),xdtDpedido[0].nummesa);xArrayPrintEncaLi_pre_cuenta={m:a,r:"",num_pedido:t,reservar:0,solo_llevar:0,correlativo_dia:t,precuenta:!0,delivery:datosDelivery?1:0,arrDatosDelivery:datosDelivery},xMandarImprimirOtroDoc(xArrayPrintEncaLi_pre_cuenta,xDtPrint,e,arrSumSubtTotales,-1),xUpdatePrintPrecuentaPedido(checkItemsSeleccionados.idPedidosSeleccionados),$(xObj_miPedido).find(".show-led-precuenta").removeClass("xInvisible")}function xImprimirComprobante(){var e=xCargarDatosAEstructuraImpresion(checkItemsSeleccionados.arrayPedidosSeleccionados);xCocinarImprimirComprobante(e,arrSumSubtTotales,-2)}function xTraerDtTipoConsumo(){for(var e="",a=xm_log_get("estructura_pedido"),t=0;t<a.length;t++)e=String(e+'<option value="'+a[t].idtipo_consumo+'">'+a[t].descripcion+"</option>");$("#select_ulTPC").html(e).trigger("create")}function xOpenLULI(){xopen_add_item=!0,$("#SelAddLuLi").css("display","inline-block"),$("#select_ulTPC").val($("#select_ulTPC option:first").val()),xLoadDataUlAdd()}function xCloseLULI(){_cpSocketRestoreFromPedidoStorage(),$("#SelAddLuLi").css("display","none"),xopen_add_item=!1}function xNuevoPedidoCM(){try{isSocket&&_cpSocketClearStorage()}catch(e){}window.localStorage.removeItem("::app3_sys_dta_pe"),xArrayPedido=new Array,xDtSubTotales=new Array,guardandoPedido_cp=0,xThisCM.isAddItemRow=!1,xLoadArrayPedido()}function xLoadDataUlAdd(){$("#accordion").html('<div><paper-spinner active class="xCentradoVerticalHorizontal"></paper-spinner></div>').trigger("create"),xNuevoPedidoCM(),xGeneralLoadItems(xidCategoriaPD,function(){for(var e=new Array,a="",t=0;t<xGeneralDataCarta.length;t++)a!=xGeneralDataCarta[t].des_seccion&&(e.push({id:xGeneralDataCarta[t].idseccion_index,des_seccion:xGeneralDataCarta[t].des_seccion}),a=xGeneralDataCarta[t].des_seccion);for(var o,i="",d="",r="",n=0;n<e.length;n++){for(var s=e[n].id,l=String('<li class="li_tocuh"><div>'+e[n].des_seccion+"</div>"),p=0;p<xGeneralDataCarta.length;p++)s==xGeneralDataCarta[p].idseccion_index&&(r="",o=xGeneralDataCarta[p].cantidad,parseInt(o)<=0&&(r="xTachar"),"ND"==o&&(o=1e3),xGeneralDataCarta[p].stock_actual=o,xGeneralDataCarta[p].idcategoria=xidCategoriaPD,i=String(i+'<li class="row" id="li'+xGeneralDataCarta[p].idcarta_lista+'" data-index = "'+p+'" data-signo="+"  data-idcategoria="'+xidCategoriaPD+'" data-cat="'+e[n].des_seccion+'" data-idcl="'+xGeneralDataCarta[p].idcarta_lista+'" data-idcartalista="'+xGeneralDataCarta[p].idcarta_lista+'" data-idseccion="'+xGeneralDataCarta[p].idseccion+'" data-idseccionindex="'+xGeneralDataCarta[p].idseccion_index+'" data-iditem="'+xGeneralDataCarta[p].iditem+'" data-punitario="'+xGeneralDataCarta[p].precio+'" data-idimpresora="'+xGeneralDataCarta[p].idimpresora+'" data-idprocede="'+xGeneralDataCarta[p].idprocede+'" data-procede="'+xGeneralDataCarta[p].procede+'" data-procedeindex="'+xGeneralDataCarta[p].procede_index+'" data-imprimircomanda="'+xGeneralDataCarta[p].imprimir_comanda+'" data-iddescontar="'+xGeneralDataCarta[p].idprocede+'" data-cant_descontar="'+xGeneralDataCarta[p].cant_descontar+'" data-stock_actual="'+xGeneralDataCarta[p].cantidad+'" data-idalmacen_items="'+xGeneralDataCarta[p].idalmacen_items+'"><div><div class="xicon3 xeditar xbtn_li_editar" title="editar" style="width:15px;height:15px;"></div><p class="xtitulo_li '+r+'">'+xGeneralDataCarta[p].des_item+'</p><p class="xInvisible">'+xGeneralDataCarta[p].codigo_barra+'</p><input type="text" class="xMiInput xMiTextReferencia" anchofull id="xinput_li"></div><div class="xBtn_contet_li"><div class="xBtn_li">-</div><span class="xcant_li" data-cantmax="'+o+'">0</span><div class="xBtn_li">+</div></div></li>'));i=l+'<ul id="content_item_pedido">'+i+"</ul></li>",d=String(d+i),i=i=""}$("#accordion").html(d).trigger("create"),$("#accordion").accordion("refresh"),$("#accordion").accordion({collapsible:!0,active:!1}),$("#txt_bus_item_add").focus()})}function _cpStockItemModificado(e){if(isSocket&&xopen_add_item){var a="#li"+e.idcarta_lista;const t=e.cantidad;e=$(a).attr("data-index");xtachar_li="",parseInt(t)<=0&&(xtachar_li="xTachar"),"ND"==t&&(t=1e3),$(a).attr("data-stock_actual",t),$(a+" span.xcant_li").attr("data-cantmax",t),xGeneralDataCarta[e].stock_actual=t,xGeneralDataCarta[e].cantidad=t,itemPedidos_objItemSelected=xGeneralDataCarta[e],""!=xtachar_li?$(a).find(".xtitulo_li").addClass(xtachar_li):$(a).find(".xtitulo_li").removeClass("xTachar")}}async function xArmarSqlAddLUlI(){if(1!==guardandoPedido_cp){guardandoPedido_cp=1;var t,o,i,d,e=$("#select_ulTPC option:selected").val(),a=$("#select_ulTPC option:selected").text().trim().toLowerCase();if($("#tb_pedidos .check_item").each(function(e,a){1==a.checked&&($(a).parent().parent().attr("data-idpedido"),$(a).parent().parent().attr("data-idcat"),t=$(a).parent().parent().attr("data-m"),o=$(a).parent().parent().attr("data-nump"),i=$(a).parent().parent().attr("data-correlativo"),d=$(a).parent().parent().attr("data-ref"))}),xGeneralValidarRegalasCarta(xArrayPedidoObj,!0),0!=xArmarSubtotalesArray()){var r="0",n="0";switch(a){case"para llevar":r="1";break;case"delivery":n="1"}"0"!==r||"0"!==n||""!==t&&"0"!==t?(xArrayPrintEncaLi={m:xCeroIzq(t,2),r:xMayusculaPrimera(xSoloMinuscula(d)),num_pedido:xCeroIzq(o,5),reservar:0,solo_llevar:r,delivery:n,correlativo_dia:i},xarr_header={idclie:0,referencia:"",idcategoria:xidCategoriaPD,mesa:xCeroIzq(t,2),num_pedido:o,reservar:0,tipo_consumo:e,subtotales_tachados:""},xarr_body=xArrayPedidoObj,xarr_subtotales=xLocal_xDtSubTotales,xVerificarSiSeImprimeComanda(xArrayPedidoObj),a={p_from:"1",p_header:xarr_header,p_body:xarr_body,p_subtotales:xarr_subtotales,estado_p:0},await goSendPedidoFecht(a),xPopupLoad.xopen(),(1==xVerificarImprimirComanda?xLLamarPrintAddLUlI:(xLoadDetallesPedido(xObj_miPedido),xNuevoPedidoCM(),xCloseLULI))(),xSumarTotalPedidos(1),$(xObj_miPedido).removeClass("xDespachado")):(alert("Indique numero de mesa. Coloque cero(0) si no corresponde"),guardandoPedido_cp=0)}}}function xLLamarPrintAddLUlI(){xCocinarImprimirComanda(xArrayPrintEncaLi,xArrayPedidoObj,xLocal_xDtSubTotales,e=>{e?dialog_erro_print.open():(xPopupLoad.xclose(),xLoadDetallesPedido(xObj_miPedido),xNuevoPedidoCM(),xCloseLULI())})}function xIrPage(e){switch(e){case 0:$("#dialog_detalle").removeClass("normal"),$("#dialog_detalle").addClass("tall");break;case 1:xValPago.setVisiblePanel1(),component_pago.setVal(xMoneda(xtt_pedidos)),component_pago.setIsPedidoPagadoFromAPP(isPedidoPagadoFromApp)}content_page.selected=e}async function xRegistrarClientePagoCP(){var e,a,t,o,i,d;enProcesoGuardarPago||(enProcesoGuardarPago=!0,xPopupLoad.titulo="Guardando...",xPopupLoad.xopen(),e=xRpt_pago[0].cliente,d=""===xRpt_pago[0].idcliente?0:xRpt_pago[0].idcliente,a=xRpt_pago[0].comprobante,t=""===e.idcliente?await ClienteService_Guardar(e):e.idcliente,e.idcliente=t,"1"===xdtDpedido[0].pwa_is_delivery.toString()&&(i=xdtDpedido[0].json_datos_delivery.p_header.arrDatosDelivery,e.direccion=(""!==e.direccion?e:i).direccion,e.nombres=""!==e.nombres?e.nombres:i.nombre,e.telefono=i.telefono,e.referencia=i.referencia),d!=t&&xValPago.reloadInputDatalientes(),o=parseInt($("#tb_pedidos .row").length),i=parseInt($("#tb_pedidos .row.selected1").length),o-=i,d=await getItemsSeleccionados(),xarr_cliente={cliente:e,i:d.idPedidosSeleccionados},xarr_header={idclie:e.idcliente,ImporteTotal:xMoneda(xtt_pedidos),tipo_consumo:d.tipoConsumo,idPedidoSeleccionados:d.idPedidosSeleccionados,is_from_client_pwa:xdtDpedido[0].is_from_client_pwa},xarr_comprobante=a,xarr_items_seleccionados=d.arrayPedidosSeleccionados,xarr_list_cliente_usuario_pedido=d.arrayIdClienteUsPedido,xarr_tipo_pago=xRpt_pago[0].xtipo_pagos,xarr_subtotal=arrSumSubtTotales,(d.esSeleccionTotal&&d.esSeleccionTodoPeidoLista?$.ajax({type:"POST",url:"../../bdphp/log_001.php",data:{p_from:"b",p_cliente:JSON.stringify(xarr_cliente),p_header:JSON.stringify(xarr_header),p_tipo_pago:JSON.stringify(xarr_tipo_pago),p_subtotales:JSON.stringify(xarr_subtotal),p_comprobante:JSON.stringify(xarr_comprobante)}}).done(function(e){var a=xm_all_SetResponseLog_001(e),t=a.idregistro_pago;e=a.correlativo_comprobante,enProcesoGuardarPago=!1,xRegistrarPagoCM(o),_cpSocketEmitPedidoPagoCliente(xarr_list_cliente_usuario_pedido),xarr_subtotal=darFormatoSubTotalesParaFacturacion(arrSumSubtTotales),xMandarCocinarImpresionComprobante(e,t)}):$.ajax({type:"POST",url:"../../bdphp/log_001.php",data:{p_from:"c",p_items_seleccionados:JSON.stringify(xarr_items_seleccionados),p_cliente:JSON.stringify(xarr_cliente),p_header:JSON.stringify(xarr_header),p_tipo_pago:JSON.stringify(xarr_tipo_pago),p_subtotales:JSON.stringify(xarr_subtotal),p_comprobante:JSON.stringify(xarr_comprobante)}}).done(function(e){var a=xm_all_SetResponseLog_001(e),t=a.idregistro_pago;e=a.correlativo_comprobante,enProcesoGuardarPago=!1,xLoadDetallesPedido(xObj_miPedido),_cpSocketPintarPedido(null),_cpSocketEmitPedidoPagoCliente(xarr_list_cliente_usuario_pedido),xarr_subtotal=darFormatoSubTotalesParaFacturacion(arrSumSubtTotales),xMandarCocinarImpresionComprobante(e,t)})).fail(enProcesoGuardarPago=!1))}function xRegistrarPagoCM(e){var a=parseInt($(xObj_miPedido).attr("data-nummesa")),t=parseInt($(xObj_miPedido).attr("data-isconfirmarpago"));0==e&&(0!=a&&"0"===t.toString()?($(xObj_miPedido).removeClass("xOcupado"),$(xObj_miPedido).removeClass("xDespachado"),$(xObj_miPedido).addClass("xNeutro"),$(xObj_miPedido).find(".show-led-precuenta").addClass("xInvisible"),$(xObj_miPedido).find(".show-led-print").addClass("xInvisible"),$(xObj_miPedido).find(".show-ico-mozo").addClass("xInvisible"),$(xObj_miPedido).find(".show-mozo-pedido").removeClass("pintar"),$(xObj_miPedido).find("#nommozo").text("."),$(xObj_miPedido).find(".importe").text("."),$(xObj_miPedido).find(".tiempo").text("disponible"),$(xObj_miPedido).attr("data-hora",""),$(xObj_miPedido).attr("data-estado","b"),$(xObj_miPedido).attr("data-abrir-detalle","0"),$(".grid").isotope("updateSortData",$(xObj_miPedido)).isotope("layout")):($(".grid").isotope("remove",$(xObj_miPedido)).isotope("layout"),$(xObj_miPedido).remove())),xPopupLoad.xclose(),dialog_detalle.close()}async function xMandarCocinarImpresionComprobante(e,a){var t,o;0<xRpt_pago.length&&(xPopupLoad.xclose(),t=xRpt_pago[0].cliente,(o=xRpt_pago[0].comprobante).correlativo=xReturnCorrelativoComprobante(o),xArrayItemComprobante=xCargarDatosAEstructuraImpresion(checkItemsSeleccionados.arrayPedidosSeleccionados),xCocinarImprimirComprobante(xArrayItemComprobante,arrSumSubtTotales,o,t,a,-2)),xRpt_pago=[]}function isPedidoInMesa(a,e){$.ajax({type:"POST",url:"../../bdphp/log.php?op=507",data:{m:e,p:"",confirmar_pago:0}}).done(function(e){$.parseJSON(e).datos[0]||($(a).removeClass("xOcupado"),$(a).removeClass("xDespachado"),$(a).addClass("xNeutro"),$(a).find(".show-led-precuenta").addClass("xInvisible"),$(a).find(".show-led-print").addClass("xInvisible"),$(a).find(".show-ico-mozo").addClass("xInvisible"),$(a).find(".show-mozo-pedido").removeClass("pintar"),$(a).find("#nommozo").text("."),$(a).find(".importe").text("."),$(a).find(".tiempo").text("disponible"),$(a).attr("data-hora",""),$(a).attr("data-estado","b"),$(a).attr("data-abrir-detalle","0"),$(".grid").isotope("updateSortData",$(a)).isotope("layout"))})}function xLoadDetallesPedido(e){var x,_,a,m,u,v;0==$(e).attr("data-abrir-detalle")||(xAgrupar_item_activo=isPedidoOpenDeliveryCliente=!1,xPopupLoad.titulo="Cargando...",xPopupLoad.xopen(),xIrPage(0),xObj_miPedido=$(e),xLocal_SubTotal_Quitados="",x=$(e).attr("data-nummesa"),_=$(e).attr("data-numpedido"),a=$(e).attr("data-correlativo"),m=$(e).attr("data-idcat"),u=$(e).attr("data-isconfirmarpago"),v="",v="0"==x?"PEDIDO "+xCeroIzq(a,5):"MESA "+xCeroIzq(x,2),$.ajax({type:"POST",url:"../../bdphp/log.php?op=507",data:{m:x,p:_,confirmar_pago:u}}).done(function(e){var a="",t="",o="",i="";isPedidoPagadoFromApp="1"===u.toString(),xdtDpedido=(xdtDpedido=$.parseJSON(e)).datos,xid_pedido_selected=xdtDpedido[0].idpedido;var d,r,n,e="ATENDIDO POR: "+(xdtDpedido[0].nom_usuario||"Cliente")+" | ";$("#p_correlativo").text("CO-"+xCeroIzq(xdtDpedido[0].correlativo_dia,5)+" | "),$("#p_referencia").text(xdtDpedido[0].referencia+" | "),$("#p_antendido").text(e),datosDelivery=xdtDpedido[0].json_datos_delivery;try{datosDelivery=""!=datosDelivery&&"{}"!=datosDelivery&&"[]"!=datosDelivery?JSON.parse(datosDelivery):null}catch(e){datosDelivery=JSON.parse(datosDelivery.replace(/(\r\n|\n|\r)/g,""))}e=!!(xdtDpedido[0].json_datos_delivery=datosDelivery),$("#btnLlamarRepartidorP").addClass("xInvisible"),$("#content-info-delivery").addClass("xInvisible"),e&&((e=!!(optionDeliveryCliente=datosDelivery)&&!!optionDeliveryCliente.p_header&&1===optionDeliveryCliente.p_header.delivery)&&(isComercioServicioDeliveryPropio="1"===xDtSede_cm[0].pwa_delivery_servicio_propio,isPedidoOpenDeliveryCliente=e,v="Pedido #"+_,a=optionDeliveryCliente.p_header.arrDatosDelivery.pasoRecoger?"El cliente pasa a recoger. ":xdtDpedido[0].nom_repartidor?"REPARTIDOR: "+xdtDpedido[0].nom_repartidor+" "+xdtDpedido[0].ap_repartidor+". Telefono: "+xdtDpedido[0].tel_repartidor:"Repartidor ... ",e=optionDeliveryCliente.p_header.arrDatosDelivery.tipoComprobante,d=optionDeliveryCliente.p_header.arrDatosDelivery.metodoPago,r=e?e.dni||"Publico en general "+(e.otro_dato||""):"Publico en general",n=2===d.idtipo_pago?"El pedido YA ESTA pagado, solo recogen.":"El pedido DEBE ser pagado",isPedidoPagadoFromApp=2===d.idtipo_pago,t=" | Facturacion: "+e.descripcion+" "+r+"  |  "+n,i="<p>"+e.descripcion+" "+r+"  </p><strong>"+n+"</strong></p>",$("#div-info-delivery-from-app").removeClass("xInvisible"),arrTotalesDeliveryCliente=isComercioServicioDeliveryPropio?optionDeliveryCliente.p_subtotales:darFormatoSubTotalesDelivery(optionDeliveryCliente.p_subtotales),$("#btnLlamarRepartidorP").removeClass("xInvisible"),d="1"===xdtDpedido[0].flag_solicita_repartidor_papaya,isPuedeLLamarRepartdiroPapaya="1"===xDtSede_cm[0].pwa_delivery_habilitar_llamar_repartidor_papaya,d&&!isPuedeLLamarRepartdiroPapaya&&$("#btnLlamarRepartidorP").addClass("xInvisible"),xdtDpedido[0].idrepartidor?($("#divRepartidorNom #a_nom_repartidor").text(xdtDpedido[0].nom_repartidor+" "+xdtDpedido[0].ap_repartidor),$("#divRepartidorNom").removeClass("xInvisible"),$("#divRepartidorSelect").addClass("xInvisible"),$("#btnLlamarRepartidorP").addClass("xInvisible")):isComercioServicioDeliveryPropio&&!d?($("select#selectRepartidor").val(-1),$("#divRepartidorSelect").removeClass("xInvisible"),$("#divRepartidorNom").addClass("xInvisible")):($("#divRepartidorNom").removeClass("xInvisible"),$("#divRepartidorSelect").addClass("xInvisible"),$("#btnLlamarRepartidorP").addClass("xInvisible"),$("#divRepartidorNom #a_nom_repartidor").text("Repartidor no asignado.."))),(datosDelivery="object"==typeof datosDelivery&&datosDelivery.p_header?0===datosDelivery.p_header.delivery?null:datosDelivery.p_header.arrDatosDelivery:datosDelivery)?($("#content-info-delivery").removeClass("xInvisible"),datosDelivery.paga_con=datosDelivery.paga_con.replace("undefined",""),e=datosDelivery.num_doc||" | "+datosDelivery.nombre+" | "+datosDelivery.direccion+" | "+datosDelivery.telefono+" | "+datosDelivery.paga_con,$("#txt-info-delivery").text("DELIVERY: "+e+t),datosDelivery.pasoRecoger?($("#divRepartidorPropio").addClass("xInvisible"),$("#btnLlamarRepartidorP").addClass("xInvisible"),o='<p><i class="fa fa-user"></i> '+xdtDpedido[0].referencia+'</p><p><i class="fa fa-phone"></i> '+datosDelivery.telefono+"</p>",i='<p class="badge badge-warning fs-14"><strong> <i class="fa fa-user"></i> El cliente pasa a recoger. <strong></p>'):($("#divRepartidorPropio").removeClass("xInvisible"),$("#btnLlamarRepartidorP").removeClass("xInvisible"),r=""===xdtDpedido[0].referencia?datosDelivery.nombre:xdtDpedido[0].referencia,n=datosDelivery.referencia?'<p><i class="fa fa-map-marker"></i> '+datosDelivery.referencia+"</p>":"",o='<p><i class="fa fa-user"></i> '+r+'</p><p><i class="fa fa-map-marker"></i> '+datosDelivery.direccion+"</p>"+n+'<p><i class="fa fa-phone"></i> '+datosDelivery.telefono+"</p>"),i+='<p><strong>Metodo de pago: </strong><span class="badge '+(datosDelivery.metodoPago&&2===datosDelivery.metodoPago.idtipo_pago?"fs-14 badge-info":"badge-secondary")+'">'+datosDelivery.paga_con+"</span></p>",$("#txt-info-delivery-from-app").text(a),$("#div-info-delivery-from-app").removeClass("xInvisible"),$("#info-comprobante").html(i),$("#info-pedido").html(o),"0"!==xDtSede_cm[0].pwa_delivery_servicio_propio&&"0"!==xdtDpedido[0].flag_solicita_repartidor_papaya||$("#div-info-delivery-from-app").addClass("xInvisible"),"1"===xdtDpedido[0].flag_solicita_repartidor_papaya&&(arrTotalesDeliveryCliente=darFormatoSubTotalesComisionRepartidor(xDtSede_cm[0],optionDeliveryCliente.p_subtotales,optionDeliveryCliente.p_header.arrDatosDelivery.costoTotalDelivery,!0))):$("#content-info-delivery").addClass("xInvisible"));for(var s="",l=1,p=0;p<xdtDpedido.length;p++){let e="";switch(xdtDpedido[p].val_color_despachado){case"1":e="xColorRow_verde";break;case"2":e="xColorRow_Ambar";break;case"3":e="xColorRow_Rojo"}var c=""===e?"xColorRow_Plomo":e,c=0<xdtDpedido[p].tiempo_atencion.length?'<td class="'+e+'">'+xdtDpedido[p].tiempo_atencion+' <span class="xfont11 '+c+'">min</span></td>':"<td></td>",s=String(s+'<tr class="row selected1 xCursor check_item_p" data-idcategoria="'+xidCategoriaPD+'" data-idpedido="'+xdtDpedido[p].idpedido+'" data-idcliente="'+xdtDpedido[p].idcliente+'" data-idcat="'+m+'" data-punitario="'+xdtDpedido[p].punitario+'" data-total="'+xdtDpedido[p].total+'" data-m="'+xdtDpedido[0].nummesa+'" data-idtipoconsumo="'+xdtDpedido[0].idtipo_consumo+'" data-nump="'+xdtDpedido[0].numpedido+'" data-correlativo="'+xdtDpedido[0].correlativo_dia+'" data-ref="'+xdtDpedido[0].referencia+'">" data-subtotales_tachados="'+xdtDpedido[0].subtotales_tachados+'"><td><paper-checkbox checked class="check_item"></paper-checkbox>'+l+"</td><td>"+xdtDpedido[p].des_pedido+' <span class="xfont10 xColorRow_Plomo">'+xdtDpedido[p].referencia+"</span></td><td>"+xdtDpedido[p].min_transcurridos+' <span class="xfont11 xColorRow_Plomo">min</span></td>'+c+'<td align="right" class="td_importe" id="td_importe">'+xMoneda(xdtDpedido[p].total)+"</td></tr>");l++}$("#tb_pedidos .row").remove(),$("#tb_pedidos").append(s).trigger("create"),$("#xBody div").remove(),$("#xBody").append('<div><paper-spinner active class="xCentradoVerticalHorizontal"></paper-spinner></div>').trigger("create"),$.ajax({type:"POST",url:"../../bdphp/log.php?op=3051",data:{m:x,p:_,confirmar_pago:u}}).done(function(e){e=$.parseJSON(e);xArrayDtOrdenFiltro=e.datos,xLoadMipedidoBD(xThisCM.xdtPedDet=xArrayDtOrdenFiltro),xSumarTotalPedidos(),xCheckPedidos()}),xPopupLoad.xclose(),dialog_detalle.open(),xThisCM.isAddItemRow=!1,xNuevoPedidoCM(),event.stopPropagation()}),$("#p_mesa").text(v),xGeneralDataCarta)||xLoadDataUlAdd()}function xVerificarCheckPedidos(){xArraychek_pedido=[],$(".check_item_p .check_item").each(function(e,a){a.checked&&xArraychek_pedido.push({idp:$(a).parent().parent().attr("data-idpedido")})})}function xFiltrarRowArray(){var e=xThisCM.xdtPedDet.slice(),e=JSON.parse(JSON.stringify(e));xAgrupar_item_activo=!1,xVerificarCheckPedidos();for(var a=0;a<e.length;a++)for(var t=0;t<xArraychek_pedido.length;t++){if(e[a].idpedido==xArraychek_pedido[t].idp){e[a].visible=0;break}e[a].visible=1}xLoadMipedidoBD(xArrayDtOrdenFiltro=e)}function xDesJuntarItem(){var i,d,r;$("#tb_det_pedidos .row").each(function(e,a){i=parseInt($(a).find("#td_cant").text()),p_total=parseFloat($(a).find("#td_importe").text()),d=0===p_total?0:parseFloat($(a).attr("data-punitario")),r=$(a).attr("data-idpedidodetalle");for(var t=$(a),o=0;0<i;)0<o&&(t=$(a).clone(!0),$(t).find("#checkboxLabel").empty()),p_total-=d,$(t).attr("data-totalr",d),$(t).attr("data-total",d),$(t).attr("data-cantidadr",1),$(t).attr("data-idpedidodetaller",r),$(t).find("#td_cant").text("01").trigger("create"),$(t).find("#td_importe").text(xMoneda(d)),0<o&&$(this).after(t),d=p_total<=0?0:d,o++,i--})}function xJuntarFilasIguales(){var e=xThisCM.xdtPedDet.slice(),e=JSON.parse(JSON.stringify(e)),i="",d="",r="";xAgrupar_item_activo=!0,0===xArraychek_pedido.length&&xVerificarCheckPedidos(),hist=e.map(e=>(e.grupo=e.idtipo_consumo+e.idseccion_index+e.idcarta_lista,e)).filter(e=>e.grupo).reduce(function(e,a){e[xi_grupo=a.grupo]?(xcant_item=parseFloat(e[xi_grupo].cantidad),xptotal_item=parseFloat(e[xi_grupo].ptotal)):(xptotal_item=xcant_item=0,r=d=i=""),i_cantidad=parseFloat(a.cantidad),i_ptotal=parseFloat(a.ptotal),xcant_item+=i_cantidad,xptotal_item+=i_ptotal,i=i+a.idpedido_detalle+"|"+a.idpedido+",",d=d+i_cantidad+",",r=r+i_ptotal+",";var t=a.idtipo_consumo+a.idseccion_index+a.idcarta_lista,o=!1;for(z in xArraychek_pedido){if(a.idpedido==xArraychek_pedido[z].idp){o=!0;break}o=!1}return 1==o&&(e[xi_grupo]||(e[xi_grupo]=a),e[xi_grupo].cantidad=xCeroIzq(xcant_item,2),e[xi_grupo].ptotal=xMoneda(xptotal_item)),e[t].idpedido_detalle_r=i,e[t].cantidad_r=d,e[t].total_r=r,e},{}),xLoadMipedidoBD(xArrayDtOrdenFiltro=hist)}function xLoadMipedidoBD(e){var t,o,d="",r=(xArrayTpC=[],xArraySeccion=[],""),n=e,s="";for(a in n)null==xArrayTpC[n[a].idtipo_consumo]&&(xArrayTpC[n[a].idtipo_consumo]={id:n[a].idtipo_consumo,des:n[a].des_tp});xArraychek_pedido=[];for(b in xArrayTpC){for(i in d="",xArraySeccion=[],n)xArrayTpC[b].id==n[i].idtipo_consumo&&1!=n[i].visible&&(n[i].procede,1==xAgrupar_item_activo?s="xdisabled":xAgrupar_item_activo="",o=n[i].des_seccion,null==xArraySeccion[n[i].idseccion_index]&&(xArraySeccion[n[i].idseccion_index]='<tr><td colspan="5" class="xBold">'+o+"</td></tr>"),o=String('<tr class="row xCursor" data-idpedidodetalle="'+n[i].idpedido_detalle+'" data-i="'+i+'" data-idpedido="'+n[i].idpedido+'" data-idcliente="'+n[i].idcliente+'" data-punitario="'+n[i].punitario+'" data-idtipoconsumo="'+n[i].idtipo_consumo+'" data-idcategoria="'+n[i].idcategoria+'" data-iditem="'+n[i].iditem+'" data-idcartalista="'+n[i].idcarta_lista+'" data-procede="'+n[i].procede+'" data-descontar="'+n[i].descontar_en+'" data-iddescontar="'+n[i].iddescontar+'" data-cant_descontar="'+n[i].cant_descontar+'" data-idpedidodetaller="'+n[i].idpedido_detalle_r+'" data-cantidadr="'+n[i].cantidad_r+'" data-totalr="'+n[i].total_r+'" data-cantidad="'+n[i].cantidad+'" data-total="'+n[i].ptotal+'" data-des_seccion="'+o+'" data-subtotales_tachados="'+n[i].subtotales_tachados+'" data-idbus = "'+n[i].idseccion+'" data-idseccion="'+n[i].idseccion+'" ><td width="50px" class="click_row_dt_p" id="cant_descontar"><paper-checkbox class="check_item"></paper-checkbox><span id="td_cant">'+xCeroIzq(n[i].cantidad,2)+'</span></td><td class="click_row_dt_p" width="50%" id="descripcion_item">'+n[i].descripcion+'</td><td class="click_row_dt_p" align="right" id="td_importe">'+n[i].ptotal+'</td><td align="center" style="width: 35px" class="rowadditem" data-op="itempedido" data-procede=0><div class="btn-add-item btn-sm-add-row" data-op="itempedido" title="Agregar Uno"><i class="fa fa-plus" data-op="itempedido"></i></div></td><td align="center" style="width: 20px" class="td_op" data-op="borrar" data-procede=0><img src="../../images/_delete3.png" title="Borrar" class="'+s+'"></td></tr>'),xArraySeccion[n[i].idseccion_index]=xArraySeccion[n[i].idseccion_index]+o);for(a in t='<tr><td colspan="5" class="xFondoRowBlanco xBold">'+xArrayTpC[b].des+"</td></tr>",xArraySeccion)d=String(d+xArraySeccion[a]);r=String(r+t+d)}r='<div><table width="100%" id="tb_det_pedidos" class="xRowPading4">'+r+"</table></div>",$("#xBody div").remove(),$("#xBody").html(r).trigger("create")}function xLoadDtPrintCM(){xDtPrint=xm_log_get("sede_generales"),xDtSede_cm=xm_log_get("datos_org_all_sede")}function xcronometro_permiso(){0==--xCronometro_us&&clearInterval(xRefreshPermiso)}function xOp_permiso(){switch(xpass_op){case"borrar":0<xCronometro_us&&30!=xCronometro_us?dialog_borrar_item.open():xEliminarItemPedido();break;case"borrar":xPermisoSupervisor=xIdUsuario,dialog_borrar_item.open();break;case"cambiar":$("#txt_bus_cant").val(1),$("#txt_espcificacion").val(""),$("#list_bus_item").val(""),dialog_cambiar_item.open();break;case"anular_pedido":xAnularPedido()}}function xEliminarItemPedido(){xPopupLoad.xopen(),$.ajax({type:"POST",url:"../../bdphp/log.php?op=3042",data:{xarr:xArrayItemEliminar,u:xPermisoSupervisor}}).done(function(e){var a,t,o,i,d;(xe_rpt=$.parseJSON(e)).success?(a=parseFloat(xobj_row_item.find("#td_cant").text()),o=(t=xBuscarAttrTbData($("#tb_pedidos"),"data-idpedido",xArrayItemEliminar.idpedido)).find("#td_importe").text(),d=xobj_row_item.attr("data-i"),a--,i=parseFloat(xArrayItemEliminar.precio_total),0==a&&(t.find("#td_importe").text("0"),$(xobj_row_item).fadeTo(500,0,function(){$(this).remove()}),xThisCM.xdtPedDet[d].visible=1),0<i&&(d=parseFloat(xArrayItemEliminar.precio_total-xArrayItemEliminar.precio_unitario),xobj_row_item.find("#td_importe").text(xMoneda(d)),$(xobj_row_item).attr("data-totalr",d),$(xobj_row_item).attr("data-total",d),$(xobj_row_item).attr("data-cantidad",a),$(xobj_row_item).attr("data-cantidadr",a),o=parseFloat(o-xArrayItemEliminar.precio_unitario),t.find("#td_importe").text(xMoneda(parseFloat(xMoneda(o)))),o<=0)&&$(t).fadeTo(500,0,function(){$(this).remove()}),xobj_row_item.find("#td_cant").text(xCeroIzq(a,2)),setTimeout(()=>{xSumarTotalPedidos(1)},550),xPopupLoad.xclose()):alert(e.error)})}function xModifcar_item_cant_importe(n){xPopupLoad.xopen(),$.ajax({type:"POST",url:"../../bdphp/log.php?op="+n,data:{i:xid_pedido_detalle_item,u:xPermisoSupervisor}}).done(function(e){var a=xBuscarAttrTbData($("#tb_pedidos"),"data-idpedido",xid_pedido),t=a.find("#td_importe").text(),o=xobj_row_item.find("#td_importe").text(),i=o,d=parseFloat(xobj_row_item.find("#td_cant").text()),r=xArmarArrayDescontarStock(xobj_row_item,"+"),r=r[0].stock+" "+r[0].importe;$.ajax({type:"POST",url:"../../bdphp/log.php?op=100",data:{xsql:r}}).done(function(){xLoadDetallesPedido(xObj_miPedido)}),0<parseInt(i)&&(o=xobj_row_item.attr("data-punitario")),i=xMoneda(parseFloat(i)-parseFloat(o)),t=xMoneda(parseFloat(t)-parseFloat(o)),503==n&&(d--,xid_carta_lista_a=""),a.find("#td_importe").text(t),xobj_row_item.find("#td_importe").text(i),xobj_row_item.find("#td_cant").text(xCeroIzq(d,2)),0==d&&$(xobj_row_item).fadeTo(550,0,function(){$(this).remove()}),xSumarTotalPedidos(),xPopupLoad.xclose()})}function xReImprimir(){dialog_erro_print.close(),xPopupLoad.titulo="Enviando...",xPopupLoad.xopen(),(0<xDtSubTotales.length?xLLamarPrintAddLi:xLLamarPrint)()}function xLLamarPrint(){xPopupLoad.xopen(),xPopupLoad.titulo="Enviando...";var e=$("#p_mesa").text(),a=$("#p_correlativo").text();xArrayEnca={m:e,correlativo_dia:a,item:xitem_print},$.ajax({type:"POST",url:"../../print/print3_1.php",data:{Array_enca:xArrayEnca,Array_print:xDtPrint}}).done(function(e){xPopupLoad.xclose(),-1!=e.indexOf("Error")?($("#print_error").text(e),dialog_erro_print.open()):(xPopupLoad.titulo="Exito!",setTimeout(function(){dialog_detalle.close()},1e3))})}function xLLamarPrintAddLi(){xArrayPrintEncaLi.solo_llevar=0,xArrayPrintEncaLi.reservar=0,xPopupLoad.titulo="Enviando...",$.ajax({type:"POST",url:"../../print/print3.php",data:{Array_enca:xArrayPrintEncaLi,Array_print:xDtPrint,ArrayItem:xArrayPedidoObj,ArraySubTotales:xDtSubTotales}}).done(function(e){xPopupLoad.xclose(),-1!=e.indexOf("Error")?($("#print_error").text(e),dialog_erro_print.open()):(xPopupLoad.titulo="Exito!",xNuevoPedidoCM())})}function xCambiar_item(){null==$("#list_bus_item").attr("data-id")?($("#list_bus_item").val(""),$("#list_bus_item").focus()):xModifcar_item_cant_importe(504)}function xValidarCant_change(e){parseInt($(e).val())>parseInt($(e).attr("max"))&&$(e).val($(e).attr("max"))}async function xSumarTotalPedidos(e,a){var p=xtt_pedidos=0,t=$("#tb_pedidos"),t=($("#tb_pedidos .total").remove(),xtt_pedidos=xSumaCantRow(t,".td_importe"),t=$("#tb_det_pedidos"),p=xSumaCantRow(t,".td_importe"),(checkItemsSeleccionados=await getItemsSeleccionados()).arrayPedidosSeleccionados),o=xCargarDatosAEstructuraImpresion(t),o=xArmarSubtotalesArray(o,t.importeTotalSubItemSeleccionados),c=(xImporteTotalSeleccionados=checkItemsSeleccionados.esSeleccionTotal?o:xImporteTotalSeleccionados,xImporteTotalSeleccionados=isPedidoOpenDeliveryCliente?getImporteTotalSubTotalesDelivery(arrTotalesDeliveryCliente):xImporteTotalSeleccionados,arrSumSubtTotales=isPedidoOpenDeliveryCliente?arrTotalesDeliveryCliente:xLocal_xDtSubTotales,xLocal_xDtSubTotales=arrSumSubtTotales=a?arrSubtTotalesDescuento:arrSumSubtTotales,"");xLocal_xDtSubTotales.forEach((e,a)=>{var t,o,i,d="",r="",n=e.tachado?"xTachar":"",s=e.tachado?"Add":"Quitar",l=e.tachado?e.importe_tachado:parseFloat(e.importe).toFixed(2),a=e.quitar?'<span data-tachado="'+e.tachado+'" class="xCursor xBold xColorRow_Azul xfont11" title="no cobrar" onclick="quitarSubTotal(this, '+a+')"> '+s+" </span>":"";"TOTAL"===e.descripcion.toUpperCase()?(r="tt_importe_pagar_t",o="",t="xfont18 xBold",i="IMPORTE A PAGAR",p=parseFloat(e.importe).toFixed(2)):(t="xfont15",i=e.descripcion.toUpperCase(),d="subtotal-tr-row"),c=c+'<tr class="total '+n+'"><td colspan="4" class="'+d+'"><p class="'+o+'">'+i+" "+a+'</p></td><td align="right" class="'+d+'"><p class="'+t+' xColorRow_Azul" id="'+r+'">'+l+"</p></td></tr>"}),t=String('<tr class="total"><td colspan="4">CONSUMO TOTAL</><td align="right"><P class="xfont18" id="tt_consumo_t"><b>'+xMoneda(xtt_pedidos)+"</b></p></td></tr>"),o=parseFloat(xImporteTotalSeleccionados)-parseFloat(p),t=String(t+c+'<tr class="total"><td colspan="4">DIFERENCIA</><td align="right"><P class="xfont18 xColorRow_Rojo"><b>'+xMoneda(ImporteDiferencia=a?0:o)+"</b></p></td></tr>"),$("#tb_pedidos").append(t).trigger("create"),xtt_pedidos=p,xThisCM.importeTotalPedido=xtt_pedidos,0!=parseFloat(xtt_pedidos)||a?$(xObj_miPedido).find(".importe").text(xMoneda(xtt_pedidos)):($(xObj_miPedido).removeClass("xOcupado"),$(xObj_miPedido).removeClass("xDespachado"),$(xObj_miPedido).addClass("xNeutro"),$(xObj_miPedido).find(".show-led-precuenta").addClass("xInvisible"),$(xObj_miPedido).find(".show-led-print").addClass("xInvisible"),$(xObj_miPedido).find(".show-ico-mozo").addClass("xInvisible"),$(xObj_miPedido).find(".show-mozo-pedido").removeClass("pintar"),$(xObj_miPedido).find("#nommozo").text("."),$(xObj_miPedido).find(".importe").text("."),$(xObj_miPedido).find(".tiempo").text("disponible"),$(xObj_miPedido).attr("data-hora",""),$(xObj_miPedido).attr("data-estado","b"),$(xObj_miPedido).attr("data-abrir-detalle","0"),$(".grid").isotope("updateSortData",$(xObj_miPedido)).isotope("layout"),dialog_detalle.close()),a||xCompDescuentoPedido.reset()}function quitarSubTotal(e,a){const i=e.dataset.tachado;var d=xLocal_xDtSubTotales[a].id||"";"true"===i?(d+=",",xLocal_SubTotal_Quitados=xLocal_SubTotal_Quitados.replace(d,""),xLocal_xDtSubTotales[a].tachado=!1,e.dataset.tachado=!1,xLocal_xDtSubTotales[a].importe_tachado=parseFloat()):(xLocal_SubTotal_Quitados+=d+",",xLocal_xDtSubTotales[a].tachado=!0,xLocal_xDtSubTotales[a].importe_tachado=xLocal_xDtSubTotales[a].importe,e.dataset.tachado=!0),$("#tb_det_pedidos .row").each(function(e,a){var t=$(a).attr("data-i"),o=$(a).attr("data-subtotales_tachados"),o="true"===i?o.replace(d,""):o+d+",";$(a).attr("data-subtotales_tachados",o),xThisCM.xdtPedDet[t].subtotales_tachados=o}),xSumarTotalPedidos()}function xOrdenPedido(e){switch(e){case 0:$(".grid").isotope({sortBy:["tpc","numero","estado"]});break;case 1:$(".grid").isotope({sortBy:["tpc","estado","numero"]})}}function xFiltroPedidos(e){$("#div_filtro_header").removeClass("xInvisible");var a=window.location.href;xDesFiltro1=$(e).find(".titulo").text(),xIdFiltro1=$(e).attr("data-id"),-1==a.indexOf("c_pedido")&&xOpenPage(2,"?f1="+xIdFiltro1+"?df1="+xDesFiltro1),xIdFiltro1=".tpc"+xIdFiltro1,$("#Titulo_page").text("PEDIDOS | "+xDesFiltro1),iIniIsotope?$(".grid").isotope({filter:xIdFiltro1}):iIniIsotope=!0}async function xLoadMesas(){$(".grid").html('<paper-spinner active class="xCentradoVerticalHorizontal"></paper-spinner>').trigger("create"),$(".grid").isotope("destroy"),xPintarMesas(),xLogRun_CuentaNumeroPedidos()}function xPintarMesas(){for(var e=xm_log_get("estructura_pedido").filter(e=>"LOCAL"===e.titulo).map(e=>e.idtipo_consumo)[0],a="tpc"+e,t=(xIdFiltro1=e,parseInt(xm_log_get("datos_org_all_sede")[0].mesas)),o=1,i="",d=0;d<t;d++)xtxtEstado="xNeutro",i=String(i+'<div class="xMiCardPedido xNeutro '+a+'" data-estado="b" data-tpc="'+a+'" data-abrir-detalle=0><div class="show-led-print xInvisible" title="Impreso"> <i class="fa fa-print"></i> </div><div class="show-led-precuenta xInvisible" title="Precuenta"><i class="fa fa-pencil-square-o"></i></div><p class="tipo">Mesa</p><p class="show-mozo-pedido" title="Atendido por"><span class="fs-8 pr-1 show-ico-mozo xInvisible"><i class="fa fa-user-circle"></i></span> <span id="nommozo">-</span></p><h3 class="numero">'+xCeroIzq(o,2)+'</h3><p class="tiempo xfont11">disponible</p><p class="importe xBold">-</p></div>'),o++;xIdFiltro1=-1<xIdFiltro1.indexOf("tpc")?xIdFiltro1:".tpc"+xIdFiltro1,$(".grid").html(i).trigger("create"),$(".grid").isotope({itemSelector:".xMiCardPedido",layoutMode:"fitRows",getSortData:{tpc:"[data-tpc]",estado:"[data-estado]",numero:".numero parseInt"},sortBy:["tpc","numero","estado"],filter:xIdFiltro1}),iIniIsotope=!0,xPintarEstadoPedido()}function xPintarEstadoPedido(t=0){var e=xm_log_get("estructura_pedido").filter(e=>"LOCAL"===e.titulo).map(e=>e.idtipo_consumo)[0],c=(xIdFiltro1=e,parseInt(xm_log_get("datos_org_all_sede")[0].mesas),"tpc1");$.ajax({type:"POST",url:"../../bdphp/log.php?op=501",data:{objPedido:t}}).done(function(e){var o,i,d=JSON.parse(e),l=0;if(xCadenaNewItem="",d=d.datos.map(e=>(e.actualizado=!1,e)),!pasoRedibujado){$(".xMiCardPedido .numero").each(function(e,a){0;const t=$(a).parent();a.textContent,(i=d.filter(e=>xCeroIzq(e.nummesa,2)===a.textContent||xCeroIzq(e.correlativo_dia,4)===a.textContent)[0])&&("1"===i.confirmar_pago&&"0"!==i.nummesa?isPedidoInMesa(t,i.nummesa):(o=0===parseInt(i.despachado)?"":"xDespachado",i.hora,l=xArmarSubtotalesFromTotal(i),t.removeClass("xNeutro"),t.removeClass("xDespachado"),t.addClass("xOcupado"),t.addClass("xCursor"),t.addClass(o),t.find(".show-ico-mozo").removeClass("xInvisible"),t.find(".show-led-print").removeClass("xInvisible"),t.find(".show-mozo-pedido").addClass("pintar"),"1"===i.is_precuenta.toString()?t.find(".show-led-precuenta").removeClass("xInvisible"):t.find(".show-led-precuenta").addClass("xInvisible"),"1"===i.is_printer.toString()&&t.find(".show-led-print").removeClass("xInvisible"),l="DELIVERY"===i.des_tipo_consumo.toUpperCase()?"-":"S/. "+xMoneda(xArmarSubtotalesFromTotal(i)),t.find(".importe").text(l),t.attr("data-hora",i.hora),t.attr("data-p",i.idpedido),t.attr("data-nummesa",i.nummesa),t.attr("data-isconfirmarpago",i.confirmar_pago),t.attr("data-numpedido",i.numpedido),t.attr("data-correlativo",i.correlativo_dia),t.attr("data-estado","a"),t.attr("data-abrir-detalle","1"),t.click(function(e){xLoadDetallesPedido(t),e.stopPropagation(),e.stopImmediatePropagation()}),t.find("#nommozo").text(i.nommozo),i.actualizado=!0))});var p="";if(!pasoRedibujado){try{d.filter(e=>"1"==e.confirmar_pago).map(e=>{var a=document.getElementById(e.idpedido);a&&(a=$(a),"0"==e.nummesa?(a.addClass("xInfo"),a.find(".iconPedido").addClass("fa fa-credit-card fa-2x"),a.find(".tipo").text("Pago App")):(e.actualizado=!0,e.dibujado=!0))})}catch(e){}d.filter(e=>!e.actualizado).map(t=>{if(!t.dibujado){$(".xMiCardPedido .tipo").each(function(e,a){"mesa"!==a.textContent.toLowerCase()&&a.parentElement.dataset.numpedido===t.numpedido&&$(".grid").isotope("remove",$(a.parentElement)).isotope("layout")});var a=t.json_datos_delivery;try{t.json_datos_delivery=""!=a&&"{}"!=a&&"[]"!=a?JSON.parse(a):null}catch(e){t.json_datos_delivery=JSON.parse(a.replace(/(\r\n|\n|\r)/g,""))}p="",c=t.idtipo_consumo,1===parseInt(t.reserva)&&(c="99",p='<p class="ref_reserva xfont12">'+t.referencia+"</p>"),c="tpc"+c;var a="xOcupado ",e="a",o='<i class="iconPedido"></i>',i='<p class="fs-15 pb-8"> #'+t.idpedido+"</p>",d="Pedido",r=(t.json_datos_delivery&&t.json_datos_delivery.p_header&&t.json_datos_delivery.p_header.arrDatosDelivery.metodoPago&&(a=2===t.json_datos_delivery.p_header.arrDatosDelivery.metodoPago.idtipo_pago?"xWarning ":"xOcupado ",t.json_datos_delivery.p_header.arrDatosDelivery.pasoRecoger&&(a="xWarning ",i='<p class="xfont10">'+t.json_datos_delivery.p_header.arrDatosDelivery.nombre+"</p>",o='<i class="iconPedido fa fa-user fa-2x"></i>',d="Cliente Pasa Recoger",e="r"),t.json_datos_delivery.p_header.arrDatosDelivery.tiempoEntregaProgamado&&t.json_datos_delivery.p_header.arrDatosDelivery.tiempoEntregaProgamado.modificado&&(a="xWarning ",t.json_datos_delivery.p_header.arrDatosDelivery.nombre,i='<p class="fs-15 pb-8"> #'+t.idpedido+"</p>",o='<i class="iconPedido fa fa-clock-o fa-2x"></i>',d="Pedido Programado  "+t.json_datos_delivery.p_header.arrDatosDelivery.tiempoEntregaProgamado.dia+" "+t.json_datos_delivery.p_header.arrDatosDelivery.tiempoEntregaProgamado.hora,e="p"),2===t.json_datos_delivery.p_header.arrDatosDelivery.metodoPago.idtipo_pago)&&(a="xInfo ",t.json_datos_delivery.p_header.arrDatosDelivery.nombre,i='<p class="fs-15 pb-8"> #'+t.idpedido+"</p>",o='<i class="iconPedido fa fa-credit-card fa-2x"></i>',d="Pedido Pagado",e="t"),"0"===t.reserva.toString()&&"LOCAL"===t.tipo_consumo_titulo.toUpperCase()?"":xCeroIzq(t.correlativo_dia,4)),n=""===r?"Mesa ":"",s=""===n?`<p class="fs-9 pb-2">${t.referencia}</p>`:"",n=("1"===t.confirmar_pago.toString()&&(a="xInfo ",i="Mesa"===n.trim()?'<p class="fs-15 pb-8">'+n+xCeroIzq(t.nummesa,2)+"</p>":i,o='<i class="iconPedido fa fa-credit-card fa-2x"></i>',d="Pago App",e="t"),l="DELIVERY"===t.des_tipo_consumo.toUpperCase()?"-":"S/. "+xMoneda(xArmarSubtotalesFromTotal(t)),"xInvisible");"1"===t.is_printer.toString()&&(n=""),xCadenaNewItem=String(xCadenaNewItem+'<div class="xMiCardPedido '+a+c+' xCursor" id="'+t.idpedido+'" data-estado="'+e+'" data-tpc="'+c+'" data-hora="'+t.hora+'" data-p="'+t.idpedido+'" data-nummesa="'+t.nummesa+'" data-correlativo="'+t.correlativo_dia+'" data-isconfirmarpago="'+t.confirmar_pago+'" data-numpedido="'+t.numpedido+'"  data-abrir-detalle="1" onclick="xLoadDetallesPedido(this)">'+o+'<div class="show-led-print '+n+'" title="Impreso"> <i class="fa fa-print"></i> </div><p class="tipo">'+d+'</p><h3 class="numero">'+r+"</h3>"+i+s+'<p class="tiempo xfont11"></p>'+p+'<p class="importe xBold">'+l+"</p></div>"),t.dibujado=!0,t.actualizado=!0}}),0<d.length&&(d[d.length-1].actualizado=!0),""!=xCadenaNewItem&&(e=$(xCadenaNewItem),$(".grid").append(e).isotope("appended",e)),pasoRedibujado=iIniIsotope=!0,setTimeout(()=>{pasoRedibujado=!1},500),xCadenaNewItem="";const a=[];d.map(e=>{e=0==e.nummesa?"|"+xCeroIzq(e.correlativo_dia,4)+"|":"|"+xCeroIzq(e.nummesa,2)+"|";a.push(e)}),0===t&&xResetMesaDefault(a.join(","))}}}),$(".grid").isotope("updateSortData")}function _cpSocketPintarPedido(e){pNotificaNuevoPedido(e);var a=0;e&&(a=e.idpedido?e.isFromVR?{idpedido:e.idpedido,nummesa:""===e.m?0:e.m}:{idpedido:e.idpedido,nummesa:""===e.p_header.m?0:e.p_header.m}:{idpedido:(e=JSON.parse(e.detalle_json)).Array_enca.idpedido,nummesa:""===e.Array_enca.m?0:e.Array_enca.m}),lastIdPedidoPrint!==a.idpedido&&(lastIdPedidoPrint=a.idpedido,setTimeout(()=>{lastIdPedidoPrint=0},600),pasoRedibujado=!1,xPintarEstadoPedido(a))}function _cpSocketPintarFlagPedidoImpreso(e){(e=JSON.parse(e)).map(e=>{e=xBuscarPedidoDom((pedidoEnca=e.item.data.Array_enca).m,pedidoEnca.num_pedido);e&&""!==$(e).find(".importe").val()&&$(e).find(".show-led-print").removeClass("xInvisible")})}function xBuscarPedidoDom(t="0",o="0"){var i;return t=parseInt(t),o=parseInt(o),0!==t?$(".xMiCardPedido").each((e,a)=>{parseInt(a.dataset.nummesa)===t&&(i=a)}):$(".xMiCardPedido").each((e,a)=>{parseInt(a.dataset.numpedido)===o&&(i=a)}),i}function _cpSocketPintarNumerosPagosNotificados(){var e=$("#labelPagoFromApp"),a=parseInt(e.find(".xIndicadorCant-no-remove").text()),a=isNaN(a)?0:a;a++,e.find(".xIndicadorCant-no-remove").remove(),e.append('<span class="xIndicadorCant-no-remove">'+a+"</span>").trigger("create")}function xLogRun_CuentaNumeroPedidos(){isSocket||"undefined"!=typeof EventSource&&((xsourceEvent=new EventSource("../../bdphp/log_run.php?op=1")).onmessage=function(e){e.data!==xValCountPedidos&&(xValCountPedidos=e.data,firstLoad_mesas?firstLoad_mesas=!1:xActualizarItems())})}function xVerificarSiActualizaItems(){isSocket||$.ajax({type:"POST",url:"../../bdphp/log.php?op=50101"}).done(function(e){(e=parseInt(e))!=xCountTotalPedidos&&(xCountTotalPedidos=e,xActualizarItems())})}function xActualizarItems(){isSocket||xPintarEstadoPedido()}function xResetMesaDefault(o){$(".xMiCardPedido.xOcupado .numero").each(function(e,a){var t=$(a).parent(),a="|"+a.textContent+"|";6!==a.length&&-1===o.indexOf(a)&&(t.removeClass("xOcupado"),t.removeClass("xDespachado"),t.removeClass("xCursor"),t.addClass("xNeutro"),t.find(".show-led-precuenta").addClass("xInvisible"),t.find(".importe").text("-"),t.find(".tiempo").text("disponible"),t.attr("data-abrir-detalle","0"),t.attr("data-estado","b"),t.removeAttr("data-p"),t.removeAttr("data-hora"),t.removeAttr("data-numpedido"),t.removeAttr("data-correlativo"))}),$(".grid").isotope("updateSortData")}function xCalcularTiempoPedido(){var d,t=new Array;for(a in $(".xMiCardPedido.xOcupado").each(function(e,i){d=$(i).attr("data-hora"),xidtpc_item=(xidtpc_item=$(i).attr("data-tpc")).replace("tpc",""),isNaN(parseInt(t[xidtpc_item]))&&(t[xidtpc_item]=0),t[xidtpc_item]=parseInt(t[xidtpc_item])+1,xTiempoTranscurridos_2(d,function(e,a,t,o){d=xTiempoDe_MS_Hora(o),$(i).find(".tiempo").text(d)})}),$("#list_menu_lateral .xIndicadorCant").each(function(e,a){$(a).remove()}),t){var e="#DesTPC"+a;$(e).find("div .xIndicadorCant").remove(),$(e).find("div").append('<span class="xIndicadorCant">'+t[a]+"</span>").trigger("create")}}function xLoadItems_add(){$.ajax({type:"POST",url:"../../bdphp/log.php?op=901"}).done(function(dtConsumo){var xcadenaConsumo="",xdtConsumo=$.parseJSON(dtConsumo),xdtPro=eval(JSON.stringify(xdtConsumo.datos).replace(/descripcion/g,"label").replace(/idt/g,"value"));const _objListProductoVenta=$("#ListProductoVenta");_objListProductoVenta.autocomplete({autoFocus:!0,source:xdtPro,select:function(e,a){return _objListProductoVenta.val(a.item.label),_objListProductoVenta.attr("data-value",a.item.value),_objListProductoVenta.attr("data-tipo",a.item.tipo),_objListProductoVenta.attr("data-idproductodetalle",a.item.idproducto_detalle),$("#pventa").val(a.item.precio),!1},focus:function(e,a){return!1},change:function(e,a){return null===a.item&&_objListProductoVenta.attr("data-value",""),!1}})})}function getAllRepartidor(){$.ajax({type:"POST",url:"../../bdphp/log_005.php?op=13"}).done(function(e){e=$.parseJSON(e),xThisCM.listRepartidor=e.datos})}function selectRepartidor(){var e=xThisCM.$.selectRepartidor.value;const a=xThisCM.listRepartidor[e];$.ajax({type:"POST",url:"../../bdphp/log_005.php?op=1301",data:{idrepartidor:a.idrepartidor,idpedido:xid_pedido_selected}}).done(function(e){xdtDpedido[0].idrepartidor=a.idrepartidor,_cpSocketNoiticaRepartidorFromComercio(xdtDpedido[0])})}function xCallRepartidorPapaya(){var e=optionDeliveryCliente.p_header.arrDatosDelivery.costoTotalDelivery;$("#dialog_info_call_repartidor #msj_dialo_call").text(`Deseo Solicitar un repartidor de Papaya Express para este pedido. Al confirmar no podra asignar este pedido a ningún otro repartidor.
					Ademas el comercio asume el costo del servicio de entrega (S/. ${parseFloat(e).toFixed(2)}). Desea confirmar su solicitud?`),dialog_info_call_repartidor.open()}function xCallRepartidorPapayaExec(){$.ajax({type:"POST",url:"../../bdphp/log_005.php?op=1302",data:{idpedido:xid_pedido_selected}}).done(function(e){arrTotalesDeliveryCliente=darFormatoSubTotalesComisionRepartidor(xDtSede_cm[0],optionDeliveryCliente.p_subtotales,optionDeliveryCliente.p_header.arrDatosDelivery.costoTotalDelivery,!0),xSumarTotalPedidos(),_cpSocketComercioLLamaRepartidorPapaya()})}Polymer({is:"x-control-mesas",properties:{xt_org:Number,xt_idsede:Number,xt_idus:Number,dt_item:Object,xdtPedDet:Object,isLoadMesasIsotope:Boolean,isAddItemRow:Boolean,listRepartidor:[],importeTotalPedido:Number},attached:function(){(xThisCM=this).select_page=0,iIniIsotope=!1,xIniControlMesa(),xbuscar_mesa=!1,setTimeout(()=>{_cpSocketOpen()},1e3)},ready:()=>{},detached:function(){clearInterval(xRefreshHora),clearInterval(xRefreshPermiso),xbuscar_mesa=!0,_cpSocketClose()}})</script>