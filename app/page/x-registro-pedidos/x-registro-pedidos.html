<dom-module id="x-registro-pedidos"><link rel="stylesheet"href="../../../css/searchableOptionList.css"><script src="../../../js/searchableOptionList.js"></script><script async src="../../view/httpFech.js"></script><script src="../../view/notifica.js"></script><script src="../../view/socket.service.p.js"></script><script src="../../../js/PNotify.js"></script><script src="../../../js/PNotifyConfirm.js"></script><script src="../../../js/PNotifyHistory.js"></script><script async src="../../../js/picket.js"></script><script async src="../../../js/picket.date.js"></script><link rel="stylesheet"href="../../../css/PNotifyBrightTheme.css"><script src="../../../js/sweetalert2.js"></script><script src="../../../js/mi.sweet.alert.js"></script><template><paper-dialog id="dialog_pedido_detalle"class="dialog_redondo"style="overflow:auto;overscroll-behavior:auto;min-width:50%;max-width:700px"entry-animation="scale-up-animation"exit-animation="fade-out-animation"with-backdrop><div class="mb-2"><div><div class="d-flexx justify-content-between align-items-center header-registro-venta"><div><h3>Detalle del Pedido</h3></div><button class="btn btn-sm btn-secondary ml-2"dialog-dismiss>X</button></div><br><div style="display:flex;justify-content:flex-end"><button id="btn_reimprimir_detalle"class="btn btn-sm btn-flat"onclick="xReimprimirComandaDetalle()"title="Reimprimir comanda">üñ®Ô∏è Reimprimir Comanda</button></div><br><label for="txt_cliente_det"class="xfont10">Cliente:</label><p><span id="txt_cliente_det"class="xfont20">-</span><div class="xLinea2"></div><label for="txt_referencia_det"class="xfont10">Referencia:</label><p><span id="txt_referencia_det"class="xfont20">-</span><div class="xLinea2"></div><br><div class="x_div_linea"><div><label for="txt_mesa_det"class="xfont10">Mesa/Pedido:</label><p id="txt_mesa_det"class="xfont20">00</div><div><label for="txt_mozo_det"class="xfont10">Atendido por:</label><p id="txt_mozo_det"class="xfont20"></div><div><label for="txt_canal_det"class="xfont10">Canal:</label><p id="txt_canal_det"class="xfont20"></div><div><label for="txt_fecha_det"class="xfont10">Fecha:</label><p id="txt_fecha_det"class="xfont20"></div></div><div class="xLinea2"></div><br><br><div id="xBodyPedido"></div></div></div></paper-dialog><div class="p-5"style="max-width:1200px!important;min-width:750px!important;margin:0 auto"><div class="d-flexx w-100 justify-content-between flex-wrap"><div class="d-flexx align-items-center"><div class="pr-2"><img src="../../../images/_pedidos_registrados.png"alt="pedidos_registrados"></div><div><h3>Pedidos Registrados</h3><p class="fw-600 fs-14 text-secondary">Lista de pedidos registrados</div></div></div><br><div class="div-border div-filter"><div><p class="fw-900">Fecha</p><input style="height:20px"class="selected-template-1 xCursor"id="txt_fecha"placeholder="Elige fecha"></div><div style="width:95%"><p class="fw-900">Filtro<div class="content-div-filtro"><select class="js-select2-pedidos selected-template-1"id="selectFilter"multiple="multiple"><optgroup label="Atendido Por"><template is="dom-repeat"items="{{listAtendidoPorFilter}}"as="item"><option value$="[[item]]">{{item.nom_usuario}}</template><optgroup label="Canal de Consumo"><template is="dom-repeat"items="{{listCanalConsumoFilter}}"as="item"><option value$="[[item]]">{{item.descripcion}}</template><optgroup label="Cobrado"><template is="dom-repeat"items="{{listEstadoFilter}}"as="item"><option value$="[[item]]">{{item.descripcion}}</template></select></div></div><div><p class="fw-900">Buscar</p><input style="height:20px"placeholder="Indique criterio a buscar..."class="selected-template-1 w-100"onkeyup="buscarEnListaPedidos(this.value)"></div></div><table class="w-100 content-table-delivery"><thead><tr><th align="left"colspan="2"><span class="text-primary fw-600 fs-15">[[cantPedidos]]</span> Registros encontrados<th align="right"colspan="7"><div style="display:flex;justify-content:flex-end;align-items:center;gap:10px"><div class="div-border text-center p-2 div-indicador"style="min-width:100px"><p class="fs-10 fw-600 text-secondary mb-1">Total Pedidos<p class="fw-600 fs-18 text-primary mb-0">{{ totalPedidos }}</div><div class="div-border text-center p-2 div-indicador"style="min-width:100px"><p class="fs-10 fw-600 text-secondary mb-1">Cobrados<p class="fw-600 fs-16 text-success mb-0">{{ pedidosCobrados }}</div><div class="div-border text-center p-2 div-indicador"style="min-width:100px"><p class="fs-10 fw-600 text-secondary mb-1">Pendientes<p class="fw-600 fs-16 text-warning mb-0">{{ pedidosPendientes }}</div><div class="div-border text-center p-2 div-indicador"style="min-width:120px"><p class="fs-10 fw-600 text-secondary mb-1">Importe Total<p class="fw-600 fs-18 text-primary mb-0">S/. {{ importeTotal }}</div></div><tr style="height:50px"><th>#<th align="left">Fecha/Hora<th align="left">Atendido Por<th align="left">Canal<th align="center">Cobrado<th align="center">Mesa/Pedido<th align="center">Productos<th align="right">Importe<tbody><template is="dom-repeat"items="[[listPedidosFilter]]"as="item"><tr class$="[[ item.row_class ]]"><td><span class="fw-600 mr-1">{{item.num}}</span><td><p class="fs-11">{{ item.fecha_des }}<p class="fs-11">{{ item.hora }}<td><div><p class="fs-11">{{ item.nom_usuario_show }}</div><td><p class$="[[item.class_tpc]]">{{ item.des_consumo }}<p class="badge badge-secondary fs-12"hidden$="[[ item.isDelivery ]]">{{ item.mesa }}<div class="d-flexx"><p class="badge badge-success mr-2"hidden$="[[ !item.isScanCodigo ]]">App<p class="fs-10 fw-600">Correlativo: {{ item.correlativo_dia }}</div><td align="center"><span class$="[[item.badge_estado]]">{{ item.estado_texto }}</span><td align="center"><p class="fs-12 fw-600">{{ item.mesa_pedido }}<p class="fs-10 fw-600 text-secondary">{{ item.nom_cliente }}<p class="fs-10 fw-600 text-secondary">{{ item.referencia_pedido }}<td align="center"><span class="badge badge-info">{{ item.cant_productos }}</span> <span class$="[[ item.badge_impreso ]]"style="font-size:10px;margin-right:5px">{{ item.texto_impreso }}</span><td align="right"><div class="d-flexx justify-content-end align-items-center"><p class="fw-600 text-info fs-15 mr-2">S/. {{ item.total }}</p><button class="xBoton_flat_2 xCursor mr-1"onclick="xLoadDetallePedido(this)"data-id="{{index}}">Ver</button></div></template></table></div></template><style>.content-table-delivery{padding:15px 0;background:#fff;border-radius:8px;border:1px solid #e0e0e0}.content-table-delivery tr>td{border-bottom:8px solid #e5e5e7}.div-border{background:#fff;border-radius:8px;border:1px solid #e0e0e0}.div-filter{display:grid;grid-template-columns:1fr 3fr 3fr;column-gap:30px;padding:20px;margin-bottom:10px;align-items:center}.div-info{display:flex;justify-content:flex-end}.div-indicador{display:flex;flex-direction:column;justify-content:center}.header-registro-venta{background:#d4d4d4;padding:20px 25px 10px;margin-top:-32px;margin-right:-32px;margin-left:-32px}.bg-delivery{background-color:#f8f6c2}.bg-llevar{background-color:#81fad3}.bg-mesa{background-color:#46d9f2}.row-anulado{background:#ffe8f0;text-decoration:line-through;color:red}.x_div_linea{display:grid;grid-template-columns:repeat(4,1fr);gap:10px}.xLinea2{border-bottom:1px solid #e0e0e0;margin:10px 0}</style><script>var xThisRegistroPedidos,xidpedido_sel,xfecha_pedidos="",data_pagination_pedidos={},p_rows_pedidos=0,p_fecha_pedidos="",listPedidosMaster=[],xPedidoDetalleActual=(Polymer({is:"x-registro-pedidos",properties:{listPedidosFilter:{type:Array,value:[]},listPedidosMaster:{type:Array,value:[]},listAtendidoPorFilter:{type:Array,value:[]},listCanalConsumoFilter:{type:Array,value:[]},listEstadoFilter:{type:Array,value:[]},cantPedidos:{type:Number,value:0},totalPedidos:{type:String,value:"0"},pedidosCobrados:{type:String,value:"0"},pedidosPendientes:{type:String,value:"0"},importeTotal:{type:String,value:"0.00"}},attached:function(){xThisRegistroPedidos=this,$("#Titulo_page").text("Registro de Pedidos"),$("body").addClass("loaded"),xIniRegistroPedidos()}}),null),xIndexPedidoDetalleActual=-1;function xIniRegistroPedidos(){xPopupLoad=document.getElementById("xLoad"),xm_LogChequea(function(){xm_log_get("ini_us"),xLoadPedidos()}),$("#txt_fecha").pickadate({format:"dd mmmm, yyyy",today:"Hoy",clear:"Borrar",close:"Cerrar",onSet:function(e){xfecha_pedidos=e.select?xDevolverFechaDada2(e.select):"",p_fecha_pedidos=xfecha_pedidos,xLoadPedidos()}}),$(".js-select2-pedidos").select2({placeholder:"Aplicar Filtro",allowHtml:!0,allowClear:!0,tags:!0,width:"100%"}),$(".js-select2-pedidos").on("change",e=>{xPedidosListFilter([...e.target.selectedOptions].map(e=>JSON.parse(e.value)))})}function convertirFechaISO(e){var o;return e&&""!==e?3===(o=e.split("/")).length?`${o[2]}-${o[1]}-`+o[0]:e:(new Date).toISOString().split("T")[0]}function xLoadPedidos(){xPopupLoad.titulo="Cargando pedidos...",xPopupLoad.xopen();var e=convertirFechaISO(""!==p_fecha_pedidos?p_fecha_pedidos:xDevolverFecha());data_pagination_pedidos.pageFecha=e,$.ajax({type:"POST",url:"../../bdphp/log_010.php?op=get-registro-pedidos",data:{pagination:data_pagination_pedidos}}).done(function(e){var e=(e=JSON.parse(e)).datos,d=e.length+1||0,s=0,t=0,a=0;xThisRegistroPedidos.listAtendidoPorFilter=[],xThisRegistroPedidos.listCanalConsumoFilter=[],xThisRegistroPedidos.listEstadoFilter=[{descripcion:"COBRADO",key:"estado_cobrado",value:"1"},{descripcion:"PENDIENTE",key:"estado_cobrado",value:"0"}],e.map((o,e)=>{var i=o.fecha_hora.split(" ");o.fecha_des=i[0],o.hora=i[1],o.isScanCodigo=0!==parseInt(o.scan_qr),o.mesa="0"===o.nummesa?"":"Mesa "+o.nummesa,o.mesa_pedido="0"===o.nummesa?"P-"+o.idpedido:"Mesa "+o.nummesa,o.referencia_pedido=o.referencia_pedido===o.nom_cliente?"":o.referencia_pedido,o.estado_cobrado=null!==o.idregistro_pago&&"0"!==o.idregistro_pago,o.estado_texto=o.estado_cobrado?"COBRADO":"PENDIENTE",o.badge_estado=o.estado_cobrado?"badge badge-success":"badge badge-warning",o.estado_cobrado?t++:a++,o.anulado="1"===o.estado,o.row_class=o.anulado?"row-anulado":"",o.isDelivery="DELIVERY"===o.des_consumo,o.des_consumo="CONSUMIR EN EL LOCAL"===o.des_consumo?"EN LOCAL":o.des_consumo,o.class_tpc="DELIVERY"===o.des_consumo?"bg-delivery":"PARA LLEVAR"===o.des_consumo?"bg-llevar":"bg-mesa",o.class_tpc="badge fs-12 "+o.class_tpc,o.correlativo_dia=o.correlativo_dia||"";var i=(i=o.nom_usuario.split(",")).map(e=>e.split(" ")[0]),i=(o.nom_usuario=i.join(","),o.nom_usuario_show=o.nom_usuario.split(",").join(" - "),o.cant_productos=o.cant_productos||"0",o.total=parseFloat(o.total||0).toFixed(2),o.impreso=1===parseInt(o.impreso),o.texto_impreso=o.impreso?"‚úì Impreso":"‚úó No Impreso",o.badge_impreso=o.impreso?"badge badge-success":"badge badge-secondary",o.anulado?0:parseFloat(o.total)),i=(s+=i,xThisRegistroPedidos.listAtendidoPorFilter.find(e=>e.idusuario===o.idusuario)),i=(i||(i={idusuario:o.idusuario,nom_usuario:o.nom_usuario,key:"idusuario",value:o.idusuario},xThisRegistroPedidos.listAtendidoPorFilter.push(i)),xThisRegistroPedidos.listCanalConsumoFilter.find(e=>e.idtipo_consumo===o.idtipo_consumo));i||(i={idtipo_consumo:o.idtipo_consumo,descripcion:o.des_consumo,key:"idtipo_consumo",value:o.idtipo_consumo},xThisRegistroPedidos.listCanalConsumoFilter.push(i)),d--,o.num=xCeroIzq(d),o.charbusqueda=`${o.nom_usuario} ${o.correlativo_dia} ${o.des_consumo} ${o.nom_cliente} ${o.referencia_pedido} ${o.total} ${o.mesa} `+o.estado_texto,o.charbusqueda=o.charbusqueda.toLowerCase()}),xThisRegistroPedidos.listPedidosMaster=JSON.parse(JSON.stringify(e)),xThisRegistroPedidos.listPedidosFilter=xThisRegistroPedidos.listPedidosMaster,listPedidosMaster=e,xThisRegistroPedidos.listAtendidoPorFilter=JSON.parse(JSON.stringify(xThisRegistroPedidos.listAtendidoPorFilter)),xThisRegistroPedidos.listCanalConsumoFilter=JSON.parse(JSON.stringify(xThisRegistroPedidos.listCanalConsumoFilter)),xThisRegistroPedidos.totalPedidos=xCeroIzq(e.length,2),xThisRegistroPedidos.pedidosCobrados=xCeroIzq(t,2),xThisRegistroPedidos.pedidosPendientes=xCeroIzq(a,2),xThisRegistroPedidos.importeTotal=numeroConComas(s.toFixed(2)),xThisRegistroPedidos.cantPedidos=xThisRegistroPedidos.listPedidosFilter.length,xPopupLoad.xclose()}).fail(function(e){xPopupLoad.xclose()})}function xPedidosListFilter(e){var o=xThisRegistroPedidos.listPedidosMaster;e.map(e=>{o=xPedidosFilterByCodes(o,e.key,e.value)}),xThisRegistroPedidos.listPedidosFilter=JSON.parse(JSON.stringify(o)),xResumenPedidosTotales()}function xPedidosFilterByCodes(e,o,i){return"estado_cobrado"===o?e.filter(e=>e[o]===("1"===i)):e.filter(e=>e[o]==i)}function xResumenPedidosTotales(){var e=xThisRegistroPedidos.listPedidosFilter.length;let o=0,i=0,d=0;xThisRegistroPedidos.listPedidosFilter.forEach(e=>{e.estado_cobrado?o++:i++,d+=parseFloat(e.total)}),xThisRegistroPedidos.totalPedidos=xCeroIzq(e,2),xThisRegistroPedidos.pedidosCobrados=xCeroIzq(o,2),xThisRegistroPedidos.pedidosPendientes=xCeroIzq(i,2),xThisRegistroPedidos.importeTotal=numeroConComas(d.toFixed(2)),xThisRegistroPedidos.cantPedidos=e}function buscarEnListaPedidos(e){if(""===e)xThisRegistroPedidos.listPedidosFilter=JSON.parse(JSON.stringify(xThisRegistroPedidos.listPedidosMaster));else{const o=e.toLowerCase();e=xThisRegistroPedidos.listPedidosMaster.filter(e=>e.charbusqueda.includes(o)),xThisRegistroPedidos.listPedidosFilter=JSON.parse(JSON.stringify(e))}xResumenPedidosTotales()}function xLoadDetallePedido(e){xPopupLoad.xopen();e=e.dataId;const o=xThisRegistroPedidos.listPedidosFilter[e];xidpedido_sel=o.idpedido,xPedidoDetalleActual=o,xIndexPedidoDetalleActual=e,$.ajax({type:"POST",url:"../../bdphp/log_010.php?op=get-detalle-pedido",data:{idpedido:xidpedido_sel}}).done(function(e){e=$.parseJSON(e).datos;$("#txt_cliente_det").text(o.nom_cliente),$("#txt_referencia_det").text(o.referencia_pedido||"-"),$("#txt_mesa_det").text(o.mesa_pedido),$("#txt_mozo_det").text(o.nom_usuario_show),$("#txt_canal_det").text(o.des_consumo),$("#txt_fecha_det").text(o.fecha_des+" "+o.hora),xLoadDetallePedidoBody(e),setTimeout(()=>{xPopupLoad.xclose(),dialog_pedido_detalle.open()},500)}).fail(function(e){xPopupLoad.xclose()})}function xLoadDetallePedidoBody(e){var o="",d=[],s=[];for(a in e)null==d[e[a].idtipo_consumo]&&(d[e[a].idtipo_consumo]={id:e[a].idtipo_consumo,des:e[a].des_tp});for(b in d){var t,r,n,l="",s=[];for(i in e)d[b].id==e[i].idtipo_consumo&&(r=e[i].des_seccion,n="",e[i].nom_impresora&&"Sin impresora"!==e[i].nom_impresora?(n='<span class="fs-11 text-info">üñ®Ô∏è '+e[i].nom_impresora,e[i].nom_impresora_otro&&""!==e[i].nom_impresora_otro&&(n+=" | "+e[i].nom_impresora_otro),n+="</span>"):n='<span class="fs-11 text-secondary">üñ®Ô∏è Ninguno</span>',null==s[e[i].idseccion_index]&&(s[e[i].idseccion_index]='<tr><td colspan="3" class="xBold">'+r+" "+n+"</td></tr>"),r=`
                            <tr>
                                <td width="7px">${xCeroIzq(e[i].cantidad,2)}</td>
                                <td width="50%">${e[i].descripcion}</td>
                                <td align="right">${xMoneda(e[i].ptotal)}</td>
                            </tr>
                        `,s[e[i].idseccion_index]=s[e[i].idseccion_index]+r);for(a in t='<tr><td colspan="3" class="xFondoRowBlanco xBold">'+d[b].des+"</td></tr>",s)l=String(l+s[a]);o=String(o+t+l)}o='<div><table width="100%" class="xRowPading4">'+o+"</table></div>",$("#xBodyPedido div").remove(),$("#xBodyPedido").html(o).trigger("create"),xSumarTotalesPedido()}function xSumarTotalesPedido(){$.ajax({type:"POST",url:"../../bdphp/log_010.php?op=get-subtotales-pedido",data:{idpedido:xidpedido_sel}}).done(function(e){if((o=$.parseJSON(e)).success){for(var o=o.datos,i="",d=0;d<o.length;d++)var s=1===parseInt(o[d].tachado)?"xTachar":"",i=String(i+'<tr class="'+s+'"><td>'+o[d].descripcion.toUpperCase()+'</td><td align="right">'+o[d].importe+"</td></tr>");i='<div class="d-flexx justify-content-end mb-2"><table width="50%" class="xRowPading4">'+i+"</table></div><br>",$("#xBodyPedido").append(i).trigger("create")}})}function xGenerarReporteExcelPedidos(){}function xGenerarReporteExcelPedidosDetallado(){}function xReimprimirComandaDetalle(){if(xPedidoDetalleActual){const o=xPedidoDetalleActual;var e=o.impreso?"<p><strong>‚ö†Ô∏è ADVERTENCIA DE REIMPRESI√ìN</strong></p><p>Este pedido <strong>YA FUE IMPRESO</strong> anteriormente.</p><p>Reimprimir podr√≠a generar <strong>confusi√≥n en el √°rea de producci√≥n</strong> y causar que el pedido se duplique.</p><p>¬øEst√° seguro que desea continuar con la reimpresi√≥n?</p>":"<p>¬øEst√° seguro que desea imprimir este pedido?</p>";Swal.fire({icon:"warning",title:o.impreso?"Confirmar Reimpresi√≥n":"Confirmar Impresi√≥n",html:e,showCancelButton:!0,confirmButtonText:"S√≠, reimprimir",cancelButtonText:"Cancelar",confirmButtonColor:"#4285F4",cancelButtonColor:"#d33",...backgroundAlertSwal}).then(e=>{e.isConfirmed&&xEjecutarReimpresion(o)})}}function xEjecutarReimpresion(e){xPopupLoad.titulo="Obteniendo datos de impresi√≥n...",xPopupLoad.xopen(),$.ajax({type:"POST",url:"../../bdphp/log_010.php?op=get-datos-reimpresion-pedido",data:{idpedido:e.idpedido}}).done(function(e){var e=JSON.parse(e);e.success&&e.datos&&0!==e.datos.length?(e={detalle_json:"string"==typeof(e=e.datos[0]).detalle_json?JSON.parse(e.detalle_json):e.detalle_json,idprint_server_estructura:e.idprint_server_estructura,tipo:e.tipo,descripcion_doc:e.tipo,nom_documento:e.tipo,idprint_server_detalle:e.idprint_server_detalle},"function"==typeof _cpSocketEmitPrinterOnly?(_cpSocketEmitPrinterOnly(e),xPopupLoad.xclose(),xNotifica("Comanda enviada a impresi√≥n","success")):(xPopupLoad.xclose(),xNotifica("Error: Funci√≥n de impresi√≥n no disponible","error"))):(xPopupLoad.xclose(),xNotifica("No se encontraron datos de impresi√≥n para este pedido","error"))}).fail(function(e){xPopupLoad.xclose(),xNotifica("Error al obtener datos de impresi√≥n","error")})}</script></dom-module>