<dom-module id="x-permiso-remoto"><template><br><div class="xMiCard xradius"style="width:90%;max-width:1250px"><div class="xEncanezadoCard"style="background:#fff0f5;color:#424242"><div class="div-content-head-op"><p class="fw-600 fs-18">Solicitudes remotas de cierre.<p class="fw-100 text-secondary fs-12">Usuarios solicitan permiso para saber su diferencia y poder cerrar caja.</div></div><div class="p-3 mb-5"><div hidden$="[[ showListPermiso ]]"><br><button class="btn btn-sm btn-success"onclick="xIniPermisoRemoto(!0)"><i class="fa fa-refresh pr-1"></i>Actualizar</button><table width="100%"><thead><th>Usuario<th>Diferencia<tbody><template is="dom-repeat"items="{{listSolicitudes}}"as="item"><tr data-id="[[index]]"><td><p class="fs-11">{{ item.fecha }}<p>{{ item.usuario }}<p>Efectivo: <strong>{{ item.importe }}</strong><td><div hidden$="{{!item.is_visto}}"><p>Efectivo Sistema: {{item.importe_sistema}}<p class$="[[item.diferecia_color]]">{{item.diferecia_estado}}: {{item.diferencia}}</div><div><div id="div_btns"><button data-id="[[index]]"hidden$="{{item.is_visto}}"class="btn btn-sm btn-info"onclick="xVerDiferenciaCaja(this)">Ver Diferencia</button><div hidden$="{{!item.is_visto}}"><div hidden$="{{item.is_enviado}}"><button data-id="[[index]]"class="btn btn-sm btn-success"onclick="xEnviarResultadoPermiso(this)">Enviar Resultado</button><p class="fw-600 xInvisible"id="labelEnviado">Enviado.</div></div><p class="fw-600"hidden$="{{!item.is_enviado}}">Enviado.</div><div id="div_loader"class="xInvisible"><i class="fa fa-circle-o-notch fa-spin"></i></div></div></template></table></div></div></div></template></dom-module><script src="../../view/socket.service.p.js"></script><script>var xThisPermisoRemoto,rowLoader,rowBtns;function xIniPermisoRemoto(o=!1){o&&(xPopupLoad.titulo="Actualizando...",xPopupLoad.xopen()),xThisPermisoRemoto.listSolicitudes=[],$.ajax({type:"POST",url:"../../bdphp/log_009.php?op=6"}).done(function(o){o=JSON.parse(o).datos.map(o=>(o.is_visto="0"!==o.visto,o.is_enviado="0"!==o.enviado,o.showloader=!1,"+"===o.signo?(o.diferecia_color="text-info fw-600",o.diferecia_estado="Sobrante"):(o.diferecia_color="text-danger fw-600",o.diferecia_estado="Faltante"),o));xThisPermisoRemoto.listSolicitudes=JSON.parse(JSON.stringify(o))}),setTimeout(()=>{xPopupLoad.xclose(),xPopupLoad.titulo="Guardando..."},2e3),$("body").addClass("loaded")}function xVerDiferenciaCaja(o){var e=o.dataId;const i=xThisPermisoRemoto.listSolicitudes[e];rowLoader=$(o.parentElement.parentElement).find("#div_loader"),rowBtns=$(o.parentElement.parentElement).find("#div_btns"),i.showloader=!0,rowLoader.removeClass("xInvisible"),rowBtns.addClass("xInvisible"),setTimeout(()=>{xShowVerificacionCaja(i)},1e3)}function xShowVerificacionCaja(i,o){var e={totalcaja:parseFloat(i.importe),idusuario_supervisor:xIdUsuario,idusuario_solicita:i.idusuario_solicita};$.ajax({type:"POST",url:"../../bdphp/log.php?op=7011101",data:{item:e}}).done(o=>{o=JSON.parse(o).datos;var o=parseFloat(o[0].efectivoCaja),e=parseFloat(i.importe)-o;-1<e?(i.signo="+",i.diferecia_color="text-info fw-600",i.diferecia_estado="Sobrante"):(i.signo="-",i.diferecia_color="text-danger fw-600",i.diferecia_estado="Faltante"),i.diferencia=e.toFixed(2),i.importe_sistema=o.toFixed(2),i.visto=1,i.is_visto=!0,xSavePermisoRemoto(i)})}function xSavePermisoRemoto(e){$.ajax({type:"POST",url:"../../bdphp/log.php?op=7011102",data:{item:e}}).done(o=>{xIniPermisoRemoto(),e.showloader=!1,rowBtns.removeClass("xInvisible"),rowLoader.addClass("xInvisible")})}function xEnviarResultadoPermiso(e){var o=e.dataId,o=xThisPermisoRemoto.listSolicitudes[o];_cpSocketPermisoCierreRemotoEnviarRpt(o),$.ajax({type:"POST",url:"../../bdphp/log.php?op=7011103",data:{id:o.idcierre_permiso_remoto}}).done(o=>{$(e.parentElement).find("#labelEnviado").removeClass("xInvisible"),e.remove()})}Polymer({is:"x-permiso-remoto",properties:{listSolicitudes:[]},attached:function(){xThisPermisoRemoto=this,xIniPermisoRemoto(),setTimeout(()=>{_cpSocketOpen()},1e3)},detached:function(){_cpSocketClose()},_isEqualToLoading:o=>o.showloader})</script>