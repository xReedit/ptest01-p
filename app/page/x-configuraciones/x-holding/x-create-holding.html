<dom-module id="x-create-holding"><link rel="import"href="../../../x-componentes/x-comp-find-sede/x-comp-find-sede.html"><link rel="import"href="../../../x-componentes/x-comp-search-data/x-comp-search-data.html"><link rel="import"href="../../../x-componentes/x-comp-find-tipo-pago/x-comp-find-tipo-pago.html"><template><style>:host{display:block;padding:16px}paper-card{width:100%;padding:16px}.buttons{margin-top:16px}</style><paper-tabs selected="{{selected_holding}}"id="tab_cnf"scrollable><paper-tab>Marcas</paper-tab><paper-tab>Tipo Pago</paper-tab></paper-tabs><div class="xLinea2"></div><br><iron-pages selected="{{selected_holding}}"><div id="div_holding"><h3>Marcas</h3><hr><div><div><input class="selected-template-1"onchange="conMayusculas(this)"id="text_nom_holding"placeholder="Nombre"value="{{holding.nombre}}"required> <input class="selected-template-1"onchange="conMayusculas(this)"id="text_ciudad_holding"placeholder="Ciudad"value="{{holding.ciudad}}"required> <button class="btn btn-sm btn-primary"on-click="guardarCambios">Guardar Cambios</button></div><div hidden$="[[!isShowMarcas]]"><hr><h3>Marcas</h3><span class="fw-100 text-secundary">El nombre e imagen comercial son los que figuran en el app mesero y QR.</span><br><br><br><table class="w-100"><thead><th>Sede<th>Nombre Comercial<th>Oferta Comercial<th>Imagen Comercial<th>.<tbody><tr><td><x-comp-search-data id="searchSede"class="xMiInput"label="Buscar Sede"source-data="[[listSedes]]"search-key="nombre"display-key="nombre"min-chars="2"on-item-selected="handleSedeSelection"></x-comp-search-data><td><input class="xMiInput"onchange="conMayusculas(this)"placeholder="Nombre Comercial"value="{{holding_marca.marcas.nombre_marca}}"id="textMarcaNom"required><td><input class="xMiInput"placeholder="Imagen Comercial"value="{{holding_marca.marcas.imagen_url}}"id="textMarcaImagen"required><td><input class="xMiInput"onchange="conMayusculas(this)"placeholder="Oferta Comercial"value="{{holding_marca.marcas.oferta_comercial}}"id="textMarcaOferta"required><td><button class="btn btn-sm btn-primary"on-click="addMarca">Agregar Marca</button></tr><template is="dom-repeat"items="{{listMarcaShow}}"><tr><td><span class="fs-900 mr-1">{{displayIndex(index)}}</span> <span>{{item.nom_sede}}</span><td>{{item.nombre_comercial}}<td>{{item.oferta_comercial}}<td style="max-width:200px"><img src$="{{item.imagen_url_comercial}}"width="180px"alt=""class="xCursor"on-click="changeImage"><td><button class="btn btn-sm btn-danger"on-click="removeMarca"data-id="{{item.idsede_holding_marcas}}"><i class="fa fa-trash"></i></button></template></table><br><button class="btn btn-primary"on-click="saveMarcas">Guardar Marcas</button><br><br></div></div></div><div id="div_tipo_pago"><h3>Tipo Pago</h3><p class="text-secondary fs-11">En este se configuran los tipos de pago aceptados y comisiones</p><br><div><table><thead><th>Tipo Pago<th>Comision<th><tbody><tr><td><x-comp-find-tipo-pago id="findTipoPago"class="xMiInput"></x-comp-find-tipo-pago><td><input class="xMiInput"id="textComision"type="number"placeholder="Comision"value="0"required><td><button class="btn btn-sm btn-primary"on-click="addTipoPago">Agregar</button></tr><template is="dom-repeat"items="[[listTipoPago]]"><tr><td>{{item.nom_tipo_pago}}<td>{{item.comision}}%<td><button class="btn btn-sm btn-danger"on-click="removeTipoPago"><i class="fa fa-trash"></i></button></template></table><br></div></div></iron-pages></template><script>Polymer({is:"x-create-holding",properties:{selected_holding:{type:Number,value:0},isHolding:{type:Boolean,value:!1},isShowMarcas:{type:Boolean,value:!1},holding:{type:Object,value:function(){return{idsede_holding:null,idsede:null,nombre:"",ciudad:""}}},holding_marca:{type:Object,value:function(){return{idsede:"",nom_sede:"",nombre_comercial:"",imagen_url_comercial:"",oferta_comercial:""}}},listSedes:{type:Array,value:function(){return[]}},listMarcas:{type:Array,value:function(){return[]}},listMarcaShow:{type:Array,value:function(){return[]}},sedeSelected:{type:Object,value:function(){return{}}},listTipoPago:{type:Array,value:function(){return[]}}},ready:function(){xPopupLoad.xopen(),$.ajax({type:"POST",url:"../../bdphp/log_010.php",data:JSON.stringify({op:"get-holding"})}).done(i=>{i=JSON.parse(i).datos[0];this.holding.idsede_holding=i.idsede_holding,this.holding.idsede=i.idsede,this.holding.nombre=i.nombre,this.holding.ciudad=i.ciudad,this.$.text_ciudad_holding.value=this.holding.ciudad,this.$.text_nom_holding.value=this.holding.nombre,this.loadHoldinMarcas(),this.isShowMarcas=!0}),this.loadDataSedes(),this.loadTipoPagoHolding()},loadHoldinMarcas:function(){$.ajax({type:"POST",url:"../../bdphp/log_010.php",data:JSON.stringify({op:"get-load-holding-marcas",idsede_holding:this.holding.idsede_holding})}).done(i=>{i=JSON.parse(i);this.listMarcas=i.datos,this.listMarcaShow=this.listMarcas.filter(i=>!i.is_remove),this.listMarcaShow=JSON.parse(JSON.stringify(this.listMarcaShow)),xPopupLoad.xclose()})},loadDataSedes:function(){$.ajax({type:"POST",url:"../../bdphp/log_componentes.php?op=1001"}).done(i=>{i=JSON.parse(i),this.listSedes=i.datos})},guardarCambios:function(){this.holding.nombre=this.$.text_nom_holding.value.toUpperCase(),this.holding.ciudad=this.$.text_ciudad_holding.value.toUpperCase(),this.holding.idsede=xIdSede;var i={op:"set-holding",holding:this.holding};$.ajax({type:"POST",url:"../../bdphp/log_010.php",data:JSON.stringify(i)}).done(i=>{i=JSON.parse(i);this.holding.idsede_holding=i.idsede_holding,this.isShowMarcas=!0})},addMarca:function(){var i={idsede_marca:this.sedeSelected.idsede,idsede_holding:this.holding.idsede_holding,nom_sede:this.sedeSelected.nombre,nombre_comercial:this.$.textMarcaNom.value,imagen_url_comercial:this.$.textMarcaImagen.value,oferta_comercial:this.$.textMarcaOferta.value,is_new:!0,is_remove:!1};this.listMarcas.push(i),this.listMarcaShow=this.listMarcas.filter(i=>!i.is_remove),this.listMarcaShow=JSON.parse(JSON.stringify(this.listMarcaShow))},submitForm:function(){this.$.holdingForm.validate()},handleSedeSelection:function(i){i=i.detail.item;this.sedeSelected=i},saveMarcas:function(){xPopupLoad.xopen();var i={op:"set-holdin-marcas",marcas:this.listMarcas};$.ajax({type:"POST",url:"../../bdphp/log_010.php",data:JSON.stringify(i)}).done(i=>{xPopupLoad.xclose()})},removeMarca:async function(i){var e=paramsSwalAlert,e=(e.title="Eliminar Marca",e.text="¿Está seguro de eliminar la marca?",e.type="warning",e.showCancelButton=!0,e.confirmButtonText="Si, eliminar",e.cancelButtonText="Cancelar",e.html="",await showAlertSwalHtmlDecision(e));e.isConfirmed&&(e=i.model.index,this.listMarcas[e].is_remove=!0,this.listMarcaShow=this.listMarcas.filter(i=>!i.is_remove),this.listMarcaShow=JSON.parse(JSON.stringify(this.listMarcaShow)))},displayIndex:function(i){return xCeroIzq(i+1,1)},changeImage:async function(i){var e=i.model.item.imagen_url_comercial,o=paramsSwalAlert,e=(o.title="Cambiar imagen comercial",o.html=`<input id="changeImageMarca" class="selected-template-1" placeholder="URL de la imagen" value="${e}">`,o.showCancelButton=!0,o.confirmButtonText="Listo Cambiar",o.type="info",await showAlertSwalHtmlDecision(o));e.isConfirmed&&(o=document.getElementById("changeImageMarca").value,i.model.item.imagen_url_comercial=o,this.saveChangeImage(i.model.item.idsede_holding_marcas,o),this.listMarcaShow=JSON.parse(JSON.stringify(this.listMarcaShow)))},saveChangeImage:function(i,e){$.ajax({type:"POST",url:"../../bdphp/log_010.php",data:JSON.stringify({op:"set-change-image-marca-holding",idsede_holding_marcas:i,url_image:e})}).done(i=>{})},loadTipoPagoHolding:function(){$.ajax({type:"POST",url:"../../bdphp/log_010.php",data:JSON.stringify({op:"get-holding-metodo-pago",idsede_holding:this.holding.idsede_holding})}).done(i=>{i=JSON.parse(i);this.listTipoPago=i.datos||[]})},addTipoPago:function(){const e=this.$.findTipoPago.list_tipo_pago;var i=this.$.textComision.value;e&&i?this.listTipoPago.find(i=>i.idtipo_pago===e.idtipo_pago)?alert("Este tipo de pago ya ha sido agregado"):(xPopupLoad.xopen(),i={op:"set-holding-metodo-pago",idtipo_pago:e.idtipo_pago,comision:i,idsede_holding:this.holding.idsede_holding,estado:0},$.ajax({type:"POST",url:"../../bdphp/log_010.php",data:JSON.stringify(i)}).done(i=>{xPopupLoad.xclose(),this.$.textComision.value="0",this.loadTipoPagoHolding()}).fail(i=>{xPopupLoad.xclose(),alert("Error al agregar el tipo de pago")})):alert("Debe seleccionar un tipo de pago y especificar una comisión")},removeTipoPago:async function(i){var e=paramsSwalAlert,e=(e.title="Eliminar Tipo de Pago",e.text="¿Está seguro de eliminar este tipo de pago?",e.type="warning",e.showCancelButton=!0,e.confirmButtonText="Si, eliminar",e.cancelButtonText="Cancelar",e.html="",await showAlertSwalHtmlDecision(e));e.isConfirmed&&(e=i.model.index,i=this.listTipoPago[e],xPopupLoad.xopen(),e={op:"set-holding-metodo-pago",id:i.idsede_holding_metodo_pago,idtipo_pago:i.idtipo_pago,comision:i.comision,estado:1},$.ajax({type:"POST",url:"../../bdphp/log_010.php",data:JSON.stringify(e)}).done(i=>{xPopupLoad.xclose(),this.loadTipoPagoHolding()}).fail(i=>{xPopupLoad.xclose(),alert("Error al eliminar el tipo de pago")}))},saveTiposPago:function(){var i;this.listTipoPago&&0!==this.listTipoPago.length&&(xPopupLoad.xopen(),i=this.listTipoPago.map(i=>{var e={op:"set-holding-metodo-pago",idtipo_pago:i.idtipo_pago,comision:i.comision,estado:i.estado||0};return i.idsede_holding_metodo_pago&&0<i.idsede_holding_metodo_pago&&(e.id=i.idsede_holding_metodo_pago),$.ajax({type:"POST",url:"../../bdphp/log_010.php",data:JSON.stringify(e)})}),Promise.all(i).then(i=>{xPopupLoad.xclose(),this.loadTipoPagoHolding()}).catch(i=>{xPopupLoad.xclose(),alert("Error al guardar los tipos de pago")}))}})</script></dom-module>