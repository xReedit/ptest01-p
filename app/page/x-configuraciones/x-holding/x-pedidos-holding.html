<script src="../../../view/socket.service.p.js"></script><dom-module id="x-pedidos-holding"><template><br><div class="xMiCard xradius"style="width:85%;max-width:1100px"><div class="xEncanezadoCard"style="background:#fff0f5;color:#424242"><div class="d-flexx justify-content-between align-items-center"><h3>Pedidos por Marcas</h3></div></div><div class="xLinea2"></div><div class="xContentCard"style="padding:20px"><div class="container"><div class="filter-section mb-2 d-flexx justify-content-between align-items-end"><div class="d-flexx"><div><p class="fw-600">Marca</p><select class="selected-template-1 fs-15"id="filterMarca"on-change="_filterByMarca"><option value="">Todas las marcas</option><template is="dom-repeat"items="[[listaMarcas]]"><option value="[[item.marca]]">[[item.marca]]</template></select></div><div class="ml-3"><p class="fw-600">Fecha</p><input style="height:20px"class="selected-template-1 xCursor"id="txt_fecha_pedido_holding"placeholder="Elige fecha"></div></div><div><p>[[cuentaDebitarMarca]]</div></div><hr><table class="w-100"><thead><th>#<th align="left">Fecha<th align="center">Atendido Por<th align="center">Marca<th align="center">Mesa<th align="right">Total<th align="center">Medio<th>Estado<tbody><template is="dom-repeat"items="[[pedidosFiltrados]]"><tr class="pedido-item"><td>{{displayIndex(index)}}<td>[[item.fecha]]<td align="center">[[item.nom_us]]<td align="center">[[item.marca]]<td align="center"><p>Mesa: [[item.nummesa]]<td align="right">[[item.total_r]]<td align="center"><img src="[[item.icon_show]]"alt="Método de pago"width="16"class="ml-1"><td><span class$="[[_getDebitadoClass(item.estado_debitado)]]">[[item.estado_debitado]]</span></template></table><br><div class="resumen-section mt-3"><p class="fw-600 fs-15 mb-2">Resumen de Pagos<div class="resumen-content"><div class="resumen-metodos"><template is="dom-repeat"items="[[resumenMetodosPago]]"><div class="metodo-item"><div class="mr-2"><img src="[[item.icon]]"alt="[[item.name]]"width="32"></div><div><span class="metodo-name">[[item.name]]:</span> <span class="metodo-total">S/. [[item.total]]</span><template is="dom-if"if="[[item.hasCommission]]"><div class="comision-info fs-14"><span class="comision-rate">Comisión ([[item.commissionRate]]%):</span> <span class="comision-amount">-S/. [[item.commissionAmount]]</span> <span class="total-after-commission">Total neto: S/. [[item.totalAfterCommission]]</span></div></template></div></div></template></div><div class="total-general ml-5"><div><strong>Total Pedidos:</strong> <span>[[totalPedidos]]</span></div><div><strong>Total General:</strong> <span>S/. [[totalGeneral]]</span></div><div><strong>Total Comisiones:</strong> <span>S/. [[totalComisiones]]</span></div><div><strong>Total Neto a Debitar:</strong> <span class="fw-600 fs-18">S/. [[totalNeto]]</span></div></div><div><div ml-2 hidden$="[[!showBtnDebitar]]"><button class="btn btn-primary"on-click="debitarPedidos">Debitar</button></div></div></div><div class="text-right"><p class="fw-600"id="p_fecha_debitado"></div></div></div></div></div></template><style>.comision-info{font-size:.9em;color:#666}.total-general div{margin:5px 0}.comision-amount{color:#d32f2f}.total-after-commission{font-weight:700;color:#1976d2}.metodo-item{display:flex;margin:5px 0}.resumen-content{display:flex;font-size:14px}</style><script>Polymer({is:"x-pedidos-holding",properties:{pedidos:{type:Array,value:function(){return[]}},listIdsPedidos:{type:Array,value:function(){return[]}},pedidosFiltrados:{type:Array,value:function(){return[]}},listaMarcas:{type:Array,value:function(){return[]}},resumenMetodosPago:{type:Array,value:function(){return[]}},totalGeneral:{type:String,value:"0.00"},commissionRate:{type:Number,value:2.5},totalComisiones:{type:String,value:"0.00"},totalNeto:{type:String,value:"0.00"},totalPedidos:{type:Number,value:0},showBtnDebitar:{type:Boolean,value:!1},marcaSeleccionada:{type:Object,value:function(){return{}}},fechaDebitado:{type:String,value:""},cuentaDebitarMarca:{type:String,value:""},fechaSelected:{type:String,value:""}},attached:function(){this.pedidos=[],this._initializeSocket(),$("body").addClass("loaded")},detached:function(){},_pintarPedidoHolding:function(i){this.getPedidoById(i.idpedido)},async getPedidoById(i){this.searchItemInPedidos(i)||(this.listIdsPedidos.push(i),await $.ajax({type:"POST",url:"../../bdphp/log_010.php",data:JSON.stringify({op:"get-pedido-holding-by-id",idpedido:i})}).done(i=>{i=JSON.parse(i).datos[0];this.addPedidoInPedidos(i)}))},_initializeSocket:async function(){_cpSocketOpen(),await this.getComisionMetodoPago(),this.getPedidosHoldingByDay(),this.showBtnDebitar=!1,$("#txt_fecha_pedido_holding").pickadate({format:"dd mmmm, yyyy",today:"Hoy",clear:"Borrar",close:"Cerrar",onSet:i=>{i=i.select?xDevolverFechaDada2(i.select):"";this.fechaSelected=xSetInputDate(i),this.getPedidosHoldingByDay()}})},searchItemInPedidos:function(t){return this.listIdsPedidos.find(i=>i==t)},getPedidosHoldingByDay(){this.pedidos=[],this.pedidosFiltrados=[];var i=""===this.fechaSelected?(new Date).toISOString().split("T")[0]:this.fechaSelected;$.ajax({type:"POST",url:"../../bdphp/log_010.php",data:JSON.stringify({op:"get-pedidos-holding-by-day",fecha:i,idsede_holding:6})}).done(i=>{i=JSON.parse(i).datos;0===i.length?(this.pedidosFiltrados=JSON.parse(JSON.stringify(this.pedidosFiltrados)),this._actualizarResumen()):i.forEach(i=>{this.addPedidoInPedidos(i)})})},addPedidoInPedidos(i){var t=JSON.parse(i.pedido_json),t=(i.tipo_pago=t.p_header.paymentMozo.methods,i.tipo_pago.some(t=>this.metodosConComision.some(i=>i.idtipo_pago==t.id)));i.estado_debitado="1"==i.debitado?"Debitado":"Pendiente",i.icon_show=t?"../../images/pinpad.png":i.tipo_pago[0].icon,this.pedidos.push(i),this.pedidosFiltrados=this.pedidos,this.listIdsPedidos.push(i.idpedido),this.pedidosFiltrados=JSON.parse(JSON.stringify(this.pedidosFiltrados)),this._actualizarListaMarcas(),this._actualizarResumen()},_actualizarListaMarcas(){var i=[...new Set(this.pedidos.map(i=>({marca:i.marca,idsede:i.idsede})))];this.listaMarcas=i.reduce((i,t)=>{return i.find(i=>i.marca===t.marca)||i.push({marca:t.marca,idsede:t.idsede}),i},[])},_filterByMarca(i){const t=i.target.value;this.marcaSeleccionada=this.listaMarcas.find(i=>i.marca===t),this.showBtnDebitar=""!==t,this.fechaDebitado="",this.cuentaDebitarMarca="",t?(this.pedidosFiltrados=this.pedidos.filter(i=>i.marca===t),i=this.pedidosFiltrados.some(i=>"1"!==i.debitado),(this.showBtnDebitar=i)||(i=this.pedidosFiltrados[0].idregistro_pago_marca,this.getRegistroPagoMarca(i)),this.getCuentaDebitarMarca()):this.pedidosFiltrados=this.pedidos,this.pedidosFiltrados=JSON.parse(JSON.stringify(this.pedidosFiltrados)),this._actualizarResumen()},_actualizarResumen(){let a={},o=0,d=0,s=new Set;a.digital={id:"digital",name:"Medios Digitales POS",icon:"../../images/pinpad.png",total:0,hasCommission:!0,commissionRate:this.metodosConComision[0].comision,commissionAmount:0,totalAfterCommission:0},this.pedidosFiltrados.forEach(i=>{var t,e;s.has(i.idregistro_pago)||(s.add(i.idregistro_pago),t=parseFloat(i.total_r)||0,i.tipo_pago.some(t=>this.metodosConComision.some(i=>i.idtipo_pago==t.id))?(a.digital.total+=t,e=t*a.digital.commissionRate/100,a.digital.commissionAmount+=e,d+=e):i.tipo_pago.forEach(i=>{a[i.id]||(a[i.id]={id:i.id,name:i.name,icon:i.icon,total:0,hasCommission:!1,commissionAmount:0,totalAfterCommission:0});var t=parseFloat(i.amount_real)||0;a[i.id].total+=t}),o+=t)}),this.resumenMetodosPago=Object.values(a).filter(i=>0<i.total).map(i=>({...i,total:i.total.toFixed(2),commissionAmount:i.commissionAmount.toFixed(2),totalAfterCommission:(i.total-i.commissionAmount).toFixed(2)})),this.totalGeneral=o.toFixed(2),this.totalComisiones=d.toFixed(2),this.totalNeto=(o-d).toFixed(2),this.totalPedidos=this.pedidosFiltrados.length},getComisionMetodoPago:async function(i){await $.ajax({type:"POST",url:"../../bdphp/log_010.php",data:JSON.stringify({op:"get-comision-metodo-pago-holding"})}).done(i=>{i=JSON.parse(i).datos;this.metodosConComision=i})},debitarPedidos:async function(){var i,t=paramsSwalAlert,t=(t.title='<p class="fw-600 fs-20">Número de Operación</p>',t.html='<div class="p-3" style="display: inline-flex; border-radius:5px"><input type="number" placeholder="# Opercion bancaria" class="xMiInput text-center text-white fs-20 w-100" id="txt_numero_operacion_debitado"></div>',t.confirmButtonText="Listo, guardar",t.showCancelButton=!0,await showAlertSwalHtmlDecision(t,1));t.isDismissed||(t=this.pedidosFiltrados.map(i=>i.idpedido).join(","),i=document.getElementById("txt_numero_operacion_debitado").value,this.resumenMetodosPago,this.marcaSeleccionada.idsede,await $.ajax({type:"POST",url:"../../bdphp/log_010.php",data:JSON.stringify({op:"set-debitar-pedido-holding",idpedidos:t,numoperacion:i,resumen:JSON.stringify(this.resumenMetodosPago),idsede:this.marcaSeleccionada.idsede})}).done(i=>{this.getPedidosHoldingByDay()}))},getRegistroPagoMarca:async function(i){await $.ajax({type:"POST",url:"../../bdphp/log_010.php",data:JSON.stringify({op:"get-registro-pago-marca",idregistro_pago_marca:i})}).done(i=>{i=JSON.parse(i).datos[0];this.fechaDebitado=`Fecha Debitado:  ${i.fecha} <br> Numero Operación: `+i.num_operacion,p_fecha_debitado.innerHTML=this.fechaDebitado})},getCuentaDebitarMarca:async function(){await $.ajax({type:"POST",url:"../../bdphp/log_010.php",data:JSON.stringify({op:"get-cuenta-debitar-marca",idsede_marca:this.marcaSeleccionada.idsede})}).done(i=>{this.cuentaDebitarMarca="Cuenta a Debitar: "+JSON.parse(i).datos[0].cuenta_debitar})},_getIconByTipoPago:function(i){return"1"==i.id?i.icon:"../../images/pinpad.png"},_getDebitadoClass:function(i){return"Debitado"===i?"text-success":"text-danger"},_verDetalle:function(i){i=i.target.dataset.pedido;this.fire("ver-detalle-pedido",{idpedido:i})},_marcarListo:function(i){var t=i.target.dataset.pedido,i=(this.socket.send(JSON.stringify({action:"pedido_listo",idpedido:t})),this.pedidos.findIndex(function(i){return i.idpedido==t}));-1!==i&&this.splice("pedidos",i,1)},_formatTime:function(i){return new Date(i).toLocaleTimeString()},displayIndex:function(i){var t=this.pedidos.length;return xCeroIzq(t-i,1)}})</script></dom-module>