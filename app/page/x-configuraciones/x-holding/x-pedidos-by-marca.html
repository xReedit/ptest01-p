<script src="../../../view/socket.service.p.js"></script><dom-module id="x-pedidos-by-marca"><template><br><div class="xMiCard xradius"style="width:85%;max-width:1100px"><div class="xEncanezadoCard"style="background:#fff0f5;color:#424242"><div class="d-flexx justify-content-between align-items-center"><div><h3>Pedidos Registrados en Patio</h3><p class="m-0">Pedidos registrados previo pago</div></div></div><div class="xLinea2"></div><div class="xContentCard"style="padding:20px"><div class="container"><br><div><p class="fw-600">Fecha</p><input style="height:20px"class="selected-template-1 xCursor"id="txt_fecha_pedido_marca"placeholder="Elige fecha"></div><hr><table class="w-100"><thead><th>#<th align="left">Fecha<th align="center">Atendido Por<th align="center">Referencia<th align="center">Ubicación<th align="right">Total<th align="center">Medio<th align="center">Acción<tbody><template is="dom-repeat"items="[[pedidosFiltrados]]"><tr class="pedido-item"data-pedido$="[[item.idpedido]]"><td>{{displayIndex(index)}}<td>[[item.fecha]]<td align="center">[[item.nom_us]]<td align="center"><p>[[item.referencia]]</p><template is="dom-if"if="[[_isHolding(item.is_holding)]]"><p class="text-primary fw-600 fs-10">PATIO</template><td align="center"><div class="d-flexx align-items-center justify-content-center"><template is="dom-if"if="[[item.showClienteNumberTable]]"><span class="location-indicator mr-2"></span></template><p class$="[[_getShowNumberTable(item.showClienteNumberTable)]]">[[item.nummesa]]</div><td align="right">[[item.total_r]]<td align="center"><template is="dom-if"if="[[!item.showHolding]]"><template is="dom-repeat"items="[[item.tipo_pago]]"as="metodo"><img src="[[metodo.icon]]"alt="Método de pago"width="16"class="ml-1"></template></template><template is="dom-if"if="[[item.showHolding]]"><img src="[[item.icon_show]]"alt="Método de pago"width="16"class="ml-1"></template><td align="center"><template is="dom-if"if="[[_showBotonLlamarMesero(item)]]"><button class="fs-10 btn btn-sm btn-warning"on-click="_handleLlamarMesero"id="btnCallPedidoListo"data-pedido$="[[item.idpedido]]"data-mesa$="[[item.nummesa]]"data-referencia$="[[item.referencia]]"data-idusuario$="[[item.idusuario]]">Llamar Mesero</button></template><template is="dom-if"if="[[_showBotonPedidoListo(item)]]"><button class="fs-10 btn btn-sm btn-info"on-click="_handleMarcarPedidoListo"data-pedido$="[[item.idpedido]]">Pedido Listo</button></template><template is="dom-if"if="[[_showBotonEntregado(item)]]"><button class="fs-10 btn btn-sm btn-success"on-click="_handleMarcarEntregado"data-pedido$="[[item.idpedido]]">Entregado</button></template><template is="dom-if"if="[[_isPedidoEntregado(item)]]"><p class="text-success m-0">Entregado ✓</template></template></table><div class="resumen-section mt-5"><p class="fw-600 fs-15 mb-2">Resumen de Pagos<div class="resumen-content"><div class="resumen-metodos"><div id="resumen-caja-container"><template is="dom-repeat"items="[[resumenCaja]]"><template is="dom-if"if="[[item.isHeader]]"><div class="metodo-header"><span class="metodo-name">[[item.name]]</span> <span class="metodo-total">S/. [[item.total]]</span></div></template><template is="dom-if"if="[[!item.isHeader]]"><div class="metodo-item"><div class="mr-2"><img src="[[item.icon]]"alt="[[item.name]]"width="32"></div><div><span class="metodo-name">[[item.name]]:</span> <span class="metodo-total">S/. [[item.total]]</span></div></div></template></template></div><div id="resumen-patio-container"><template is="dom-repeat"items="[[resumenPatio]]"><template is="dom-if"if="[[item.isHeader]]"><div class="metodo-header"><span class="metodo-name">[[item.name]]</span> <span class="metodo-total">S/. [[item.total]]</span></div></template><template is="dom-if"if="[[!item.isHeader]]"><div class="metodo-item"><div class="mr-2"><img src="[[item.icon]]"alt="[[item.name]]"width="32"></div><div><span class="metodo-name">[[item.name]]:</span> <span class="metodo-total">S/. [[item.total]]</span><template is="dom-if"if="[[item.hasCommission]]"><div class="comision-info fs-14"><span class="comision-rate">Comisión ([[item.commissionRate]]%):</span> <span class="comision-amount">-S/. [[item.commissionAmount]]</span> <span class="total-after-commission">Total neto: S/. [[item.totalAfterCommission]]</span></div></template></div></div></template></template></div><div class="total-general"><div><strong>Total Pedidos:</strong> <span>[[totalPedidos]]</span></div><div><strong>Total Caja:</strong> <span>S/. [[totalCaja]]</span></div><div><strong>Total Patio:</strong> <span>S/. [[totalPatio]]</span></div><div><strong>Total General:</strong> <span class="fw-600 fs-18">S/. [[totalGeneral]]</span></div></div></div><div class="text-right"><p class="fw-600"id="p_fecha_debitado"></div></div></div></div></div></div></template><style>.resumen-metodos{display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:20px;width:100%}.comision-info{font-size:.9em;color:#666}.total-general div{margin:5px 0}.comision-amount{color:#d32f2f}.total-after-commission{font-weight:700;color:#1976d2}.metodo-item{display:flex;margin:5px 0}.resumen-content{display:flex;font-size:14px}.location-indicator{display:inline-block;width:8px;height:8px;border-radius:50%;background-color:#2ecc71;margin-left:8px;animation:pulse 2s infinite}@keyframes pulse{0%{transform:scale(.95);box-shadow:0 0 0 0 rgba(46,204,113,.7)}70%{transform:scale(1);box-shadow:0 0 0 6px rgba(46,204,113,0)}100%{transform:scale(.95);box-shadow:0 0 0 0 rgba(46,204,113,0)}}.fade-out{opacity:0;transition:opacity .3s ease-out}.fade-in{opacity:1;transition:opacity .3s ease-in}.metodo-header{font-weight:700;font-size:1.1em;color:#1976d2;margin-top:10px;padding:5px 0;border-bottom:2px solid #1976d2}.metodo-separator{height:1px;background:#eee;margin:15px 0}</style><script>Polymer({is:"x-pedidos-by-marca",properties:{pedidos:{type:Array,value:function(){return[]}},listIdsPedidos:{type:Array,value:function(){return[]}},pedidosFiltrados:{type:Array,value:function(){return[]}},listaMarcas:{type:Array,value:function(){return[]}},resumenMetodosPago:{type:Array,value:function(){return[]}},totalCaja:{type:String,value:"0.00"},commissionRate:{type:Number,value:2.5},totalPatio:{type:String,value:"0.00"},totalGeneral:{type:String,value:"0.00"},totalPedidos:{type:Number,value:0},showBtnDebitar:{type:Boolean,value:!1},marcaSeleccionada:{type:Object,value:function(){return{}}},fechaDebitado:{type:String,value:""},cuentaDebitarMarca:{type:String,value:""},fechaSelected:{type:String,value:""},pedidosLlamando:{type:Object,value:function(){return{}}},pedidosListos:{type:Object,value:function(){return{}}}},attached:function(){this.pedidos=[],this._initializeSocket()},detached:function(){},_pintarPedidoHolding:function(t){setTimeout(()=>{this.getPedidoById(t.idpedido)},2e3)},_pintarMozoEnCamino:function(e){const o=this.pedidosFiltrados.findIndex(t=>t.idpedido===e);if(-1!==o){var t=this.pedidosFiltrados[o];if("2"!=t.estado){t.estado=2;t=this.$$(`.pedido-item[data-pedido="${e}"]`);if(t){const i=t.querySelector("#btnCallPedidoListo");i.disabled=!0,i.textContent="En camino...",i.classList.remove("btn-warning"),i.classList.add("btn-primary"),setTimeout(()=>{$.ajax({type:"POST",url:"../../bdphp/log_010.php",data:JSON.stringify({op:"set-pedido-listo",idpedido:e})}).done(t=>{JSON.parse(t).success&&(i.style.display="none",this.set(`pedidosFiltrados.${o}.estado`,"2"),(t=document.createElement("button")).className="fs-10 btn btn-sm btn-success fade-in",t.textContent="Entregado",t.dataset.pedido=e,t.addEventListener("click",this.marcarEntregado.bind(this)),i.parentNode.appendChild(t))})},5e3)}}}},async getPedidoById(t){t&&!this.searchItemInPedidos(t)&&(this.listIdsPedidos.push(t),await $.ajax({type:"POST",url:"../../bdphp/log_010.php",data:JSON.stringify({op:"get-pedido-marca-by-id",idpedido:t})}).done(t=>{t=JSON.parse(t).datos[0];this.addPedidoInPedidos(t)}))},_initializeSocket:async function(){_cpSocketOpen(),await this.getComisionMetodoPago(),this.getPedidosMarcaByDay(),this.showBtnDebitar=!1,$("#txt_fecha_pedido_marca").pickadate({format:"dd mmmm, yyyy",today:"Hoy",clear:"Borrar",close:"Cerrar",onSet:t=>{t=t.select?xDevolverFechaDada2(t.select):"";this.fechaSelected=xSetInputDate(t),this.getPedidosMarcaByDay()}})},searchItemInPedidos:function(e){return this.listIdsPedidos.find(t=>t==e)},getPedidosMarcaByDay(){this.pedidos=[],this.pedidosFiltrados=[];var t=""===this.fechaSelected?(new Date).toISOString().split("T")[0]:this.fechaSelected;$.ajax({type:"POST",url:"../../bdphp/log_010.php",data:JSON.stringify({op:"get-pedidos-marca-by-day",fecha:t,idsede_holding:6})}).done(t=>{t=JSON.parse(t).datos;0===t.length?(this.pedidosFiltrados=JSON.parse(JSON.stringify(this.pedidosFiltrados)),this._actualizarResumen()):(t.forEach(t=>{this.addPedidoInPedidos(t)}),this.elaborarTotales())})},addPedidoInPedidos(t){var e;t.tipo_pago=JSON.parse(t.tipo_pago),t.showHolding="1"==t.is_holding,"1"===t.is_holding?(e=t.tipo_pago.some(e=>this.metodosConComision.some(t=>t.idtipo_pago==e.id)),t.icon_show=e?"../../images/pinpad.png":"../../images/_tp_01.png"):(t.tipo_pago=t.tipo_pago.map(t=>({...t,icon:"../../images/"+t.icon,name:t.descripcion})),t.icon_show=t.tipo_pago[0].icon),t.estado_debitado="1"==t.debitado?"Debitado":"Pendiente",t.total_r=t.total,this.unshift("pedidos",t),this.pedidosFiltrados=this.pedidos,this.pedidosFiltrados=JSON.parse(JSON.stringify(this.pedidosFiltrados)),this._actualizarResumen()},_actualizarResumen(){const o={titulo:"VENTAS EN CAJA",metodos:{},total:0},i={titulo:"VENTAS EN PATIO",metodos:{},total:0,comision:{total:0,porcentaje:0<this.metodosConComision?.length?this.metodosConComision[0].comision:2.5}},n=(i.metodos.digital={id:"digital",name:"Medios Digitales POS (PATIO)",icon:"../../images/pinpad.png",total:0,hasCommission:!0,commissionRate:i.comision.porcentaje,commissionAmount:0},new Set),e=(this.pedidosFiltrados.forEach(a=>{if(!n.has(a.idregistro_pago)){n.add(a.idregistro_pago);const s="1"===a.is_holding,d=s?i:o;var t=i.comision.porcentaje,e=a.tipo_pago.some(e=>this.metodosConComision.some(t=>t.idtipo_pago==e.id));s&&e?(e=a.tipo_pago.reduce((t,e)=>t+parseFloat(e.amount_real),0),i.total=e,d.metodos.digital.total+=e,e=e*t/100,d.metodos.digital.commissionAmount+=e,i.comision.total+=e):a.tipo_pago.forEach(t=>{var e=parseFloat(t.amount_real)||0,o=t.id||"1",i=t.descripcion||t.name||"Efectivo";d.metodos[o]||(d.metodos[o]={id:o,name:i+(s?" (PATIO)":""),icon:a.icon_show||"../../images/"+(t.icon||"_tp_01.png"),total:0,hasCommission:!1,commissionRate:0,commissionAmount:0}),d.metodos[o].total+=e,d.total+=e})}}),0===i.metodos.digital.total&&delete i.metodos.digital,[]),a=[];0<Object.keys(o.metodos).length&&(e.push({name:o.titulo,isHeader:!0,total:o.total.toFixed(2)}),Object.values(o.metodos).sort((t,e)=>e.total-t.total).forEach(t=>{e.push({...t,total:t.total.toFixed(2)})})),0<Object.keys(i.metodos).length&&(a.push({name:i.titulo,isHeader:!0,total:(i.total-i.comision.total).toFixed(2)}),Object.values(i.metodos).sort((t,e)=>e.total-t.total).forEach(t=>{var e={...t,total:t.total.toFixed(2)};t.hasCommission&&(e.commissionAmount=t.commissionAmount.toFixed(2)),e.totalAfterCommission=(t.total-t.commissionAmount).toFixed(2),a.push(e)})),this.set("resumenCaja",e),this.set("resumenPatio",a),this.set("hayContenidoDoble",0<e.length&&0<a.length),this.totalPedidos=this.pedidosFiltrados.length,this._resumenLocal=o,this._resumenPatio=i,this.set("resumenMetodosPago",[...e,...a])},elaborarTotales:function(t){let e=0,o=0;0<this.resumenPatio.length&&(e=this.resumenPatio.filter(t=>!t.isHeader).map(t=>parseFloat(t.totalAfterCommission)).reduce((t,e)=>t+e,0),this.resumenPatio[0].total=e.toFixed(2)),0<this.resumenCaja.length&&(o=this.resumenCaja[0].total),this.totalCaja=o,this.totalPatio=e.toFixed(2),this.totalGeneral=(parseFloat(this.totalCaja)+parseFloat(this.totalPatio)).toFixed(2)},_tieneComision(e){return this.metodosConComision?.some(t=>t.idtipo_pago==e)||!1},getComisionMetodoPago:async function(t){await $.ajax({type:"POST",url:"../../bdphp/log_010.php",data:JSON.stringify({op:"get-comision-metodo-pago-holding"})}).done(t=>{t=JSON.parse(t).datos;this.metodosConComision=t})},debitarPedidos:async function(){var t,e=paramsSwalAlert,e=(e.title='<p class="fw-600 fs-20">Número de Operación</p>',e.html='<div class="p-3" style="display: inline-flex; border-radius:5px"><input type="number" placeholder="# Opercion bancaria" class="xMiInput text-center text-white fs-20 w-100" id="txt_numero_operacion_debitado"></div>',e.confirmButtonText="Listo, guardar",e.showCancelButton=!0,await showAlertSwalHtmlDecision(e,1));e.isDismissed||(e=this.pedidosFiltrados.map(t=>t.idpedido).join(","),t=document.getElementById("txt_numero_operacion_debitado").value,this.resumenMetodosPago,this.marcaSeleccionada.idsede,await $.ajax({type:"POST",url:"../../bdphp/log_010.php",data:JSON.stringify({op:"set-debitar-pedido-holding",idpedidos:e,numoperacion:t,resumen:JSON.stringify(this.resumenMetodosPago),idsede:this.marcaSeleccionada.idsede})}).done(t=>{this.getPedidosMarcaByDay()}))},getRegistroPagoMarca:async function(t){await $.ajax({type:"POST",url:"../../bdphp/log_010.php",data:JSON.stringify({op:"get-registro-pago-marca",idregistro_pago_marca:t})}).done(t=>{t=JSON.parse(t).datos[0];this.fechaDebitado=`Fecha Debitado:  ${t.fecha} <br> Numero Operación: `+t.num_operacion,p_fecha_debitado.innerHTML=this.fechaDebitado})},getCuentaDebitarMarca:async function(){await $.ajax({type:"POST",url:"../../bdphp/log_010.php",data:JSON.stringify({op:"get-cuenta-debitar-marca",idsede_marca:this.marcaSeleccionada.idsede})}).done(t=>{this.cuentaDebitarMarca="Cuenta a Debitar: "+JSON.parse(t).datos[0].cuenta_debitar})},llamarPedidoListo:function(t){const e=t.target,o=e.dataset.pedido;var i,t=e.dataset.mesa,a=e.dataset.referencia,s=e.dataset.idusuario;this.pedidosLlamando[o]||(e.disabled=!0,e.textContent="Llamando...",this.pedidosLlamando[o]=!0,s={idsede_notificar:(i=xm_log_get("datos_org_all_sede")[0]).idsede,idorg_notificar:i.idorg,idusuario:s,idpedido:o,nom_marca:i.nombre,referencia:`Mesa: ${t} - `+a},_cpSocketEmitCallMozoHolding(s),setTimeout(()=>{e.disabled=!1,e.textContent="Llamar Mesero",delete this.pedidosLlamando[o]},5e3))},marcarPedidoListo:function(t){const e=t.target.dataset.pedido,o=t.target;this.pedidosListos[e]||(o.disabled=!0,o.classList.add("fade-out"),o.textContent="Procesando...",setTimeout(()=>{$.ajax({type:"POST",url:"../../bdphp/log_010.php",data:JSON.stringify({op:"set-pedido-listo",idpedido:e})}).done(t=>{JSON.parse(t).success?(o.style.display="none",-1!==(t=this.pedidosFiltrados.findIndex(t=>t.idpedido===e))&&(this.set(`pedidosFiltrados.${t}.estado`,"2"),(t=document.createElement("button")).className="fs-10 btn btn-sm btn-success fade-in",t.textContent="Entregado",t.dataset.pedido=e,t.addEventListener("click",this.marcarEntregado.bind(this)),o.parentNode.appendChild(t))):(o.disabled=!1,o.classList.remove("fade-out"),o.textContent="Pedido Listo",delete this.pedidosListos[e])})},2e3))},marcarEntregado:function(t){const e=t.target.dataset.pedido,o=t.target;o.closest("tr");o.disabled=!0,o.classList.add("fade-out"),o.textContent="Procesando...",setTimeout(()=>{$.ajax({type:"POST",url:"../../bdphp/log_010.php",data:JSON.stringify({op:"set-pedido-entregado",idpedido:e})}).done(t=>{JSON.parse(t).success?(o.style.display="none",-1!==(t=this.pedidosFiltrados.findIndex(t=>t.idpedido===e))&&(this.set(`pedidosFiltrados.${t}.estado`,"3"),(t=document.createElement("p")).className="text-success m-0 fade-in",t.textContent="Entregado ✓",o.parentNode.appendChild(t))):(o.disabled=!1,o.classList.remove("fade-out"),o.textContent="Entregado")})},2e3)},updateUbicacionCliente:function(t){let e=t.idpedidos.split(",");const o=t.numberTable;this.pedidosFiltrados.forEach(t=>{e.includes(t.idpedido)&&(t.showClienteNumberTable=!0,t.nummesa="Ubicacion: "+o)}),this.pedidosFiltrados=JSON.parse(JSON.stringify(this.pedidosFiltrados))},_getIconByTipoPago:function(t){return"1"==t.id?t.icon:"../../images/pinpad.png"},_getDebitadoClass:function(t){return"Debitado"===t?"text-success":"text-danger"},_getShowNumberTable:function(t){return t?"text-success fw-900":"text-dark fw-100"},_showBotonLlamarMesero:function(t){return"1"===t.is_holding&&"2"!==t.estado&&"3"!==t.estado},_showBotonPedidoListo:function(t){return("1"!==t.is_holding||t.showClienteNumberTable)&&"2"!==t.estado&&"3"!==t.estado},_showBotonEntregado:function(t){return"2"===t.estado},_isPedidoEntregado:function(t){return"3"===t.estado},_formatTime:function(t){return new Date(t).toLocaleTimeString()},_isHolding:function(t){return"1"===t},displayIndex:function(t){var e=this.pedidos.length;return xCeroIzq(e-t,1)},_handleLlamarMesero:function(t){this.llamarPedidoListo(t)},_handleMarcarPedidoListo:function(t){this.marcarPedidoListo(t)},_handleMarcarEntregado:function(t){this.marcarEntregado(t)},_handleDebitarPedidos:function(t){this.debitarPedidos(t)}})</script></dom-module>