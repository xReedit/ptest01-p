<script src="../../../view/socket.service.p.js"></script><dom-module id="x-pedidos-meseros"><link rel="import"href="../../../page/x-configuraciones/x-holding/componentes/x-metodo-pago.html"><template><paper-dialog class="dialog_redondo"id="dialogMetodoPago"modal with-backdrop><x-metodo-pago id="metodoPago"></x-metodo-pago><br><div><button class="btn btn-sm btn-dark"dialog-dismiss>Cerrar</button></div></paper-dialog><br><div class="xMiCard xradius"style="width:85%;max-width:1100px"><div class="xEncanezadoCard"style="background:#fff0f5;color:#424242"><div class="d-flexx justify-content-between align-items-center"><div><h3>Pedidos cobrados por los meseros</h3><span>En este se pueden ver los pedidos cobrados por los meseros. En la opción "Metodos de pago" se pueden configurar los<br>tipos de pago y comisiones que estarán disponibles en la aplicacion del mesero</span></div><div><button class="btn btn-sm btn-secondary ml-2"on-click="getShowMetodosPago"><i class="fa fa-credit-card"></i> <span>Metodos de pago</span></button></div></div></div><div class="xLinea2"></div><div class="xContentCard"style="padding:20px"><div class="container"><div class="filter-section mb-2 d-flexx justify-content-between align-items-end"><div class="d-flexx align-items-end"><div><p class="fw-600">Nombre</p><select class="selected-template-1 fs-15"id="filterMozo"on-change="_filterByMozo"><option value="">Todas los meseros</option><template is="dom-repeat"items="[[listaMozos]]"><option value="[[item.nom_mozo]]">[[item.nom_mozo]]</template></select></div><div class="ml-3"><p class="fw-600">Fecha</p><input style="height:20px"class="selected-template-1 xCursor"id="txt_fecha_pedido_mozo"placeholder="Elige fecha"></div><button class="btn btn-sm btn-dark ml-2"on-click="getPedidosHoldingMeserosByDay"><i class="fa fa-refresh"></i> <span>Actualizar</span></button></div></div><hr><table class="w-100"><thead><th>#<th align="left">Fecha<th align="center">Pedido<th align="center">Atendido Por<th align="center">Marca<th align="center">Mesa<th align="right">Medios<th align="right">Estado<tbody><template is="dom-repeat"items="[[pedidosFiltrados]]"><tr class="pedido-item"><td>{{displayIndex(index)}}<td>[[item.fecha]]<td align="center">[[item.idpedido]]<td align="center">[[item.nom_us]]<td align="center">[[item.marca]]<td align="center"><p>Mesa: [[item.nummesa]]<td align="right"><div class="d-flexx justify-content-end"><img src="[[item.icon]]"alt="Método de pago"width="16"class="ml-1"> <span class="ml-1">[[item.importe]]</span></div><td align="right"><span class$="[[_getCerradoClass(item.estado_cerrado)]]">[[item.estado_cerrado]]</span></template></table><br><br><div><p class="fs-18 fw-600">Resumen de pagos</p><br><div><div class="resumen-content d-flexx fs-15"><div class="metodos-pago"><template is="dom-repeat"items="[[resumenMetodosPago]]"><div class="metodo-item"><img src="[[item.icon]]"alt="Método de pago"width="16"class="ml-1"> <span class="ml-2">[[item.cantidad]]</span> <span class="fw-600 ml-2">[[item.metodo]]</span> <span class="fw-900 ml-2">[[_formatImporte(item.total)]]</span></div></template></div><div class="total-general ml-5"><p><span class="fw-900">Total de pedidos:</span> [[pedidosFiltrados.length]]<p><span class="fw-900">Importe Total:</span> <span class="fs-18">[[importeTotal]]</span></div><div class="ml-5"><button class="btn btn-primary"on-click="cerrarCuentaMozo"hidden$="[[!showBtnCerrarCuentaMozo]]">Cerrar cuenta</button></div></div></div></div><br></div></div></div></template><style>.comision-info{font-size:.9em;color:#666}.total-general div{margin:5px 0}.comision-amount{color:#d32f2f}.total-after-commission{font-weight:700;color:#1976d2}.metodo-item{display:flex;margin:5px 0}.resumen-content{display:flex;font-size:14px}</style><script>Polymer({is:"x-pedidos-meseros",properties:{pedidos:{type:Array,value:function(){return[]}},listIdsPedidos:{type:Array,value:function(){return[]}},pedidosFiltrados:{type:Array,value:function(){return[]}},listaMarcas:{type:Array,value:function(){return[]}},listaMozos:{type:Array,value:function(){return[]}},resumenMetodosPago:{type:Array,value:function(){return[]}},showBtnCerrarCuentaMozo:{type:Boolean,value:!1},mozoSeleccionada:{type:Object,value:function(){return{}}},fechaSelected:{type:String,value:""},importeTotal:{type:Number,value:0},dataSedeHolding:{type:Object,value:function(){return{}}},idsede_holding:{type:Number,value:0}},attached:function(){this.pedidos=[],this._initializeSocket(),this.initPage(),$("body").addClass("loaded")},detached:function(){},initPage:async function(){this.dataSedeHolding=xm_log_get("datos_sede_holding"),this.idsede_holding=this.dataSedeHolding.idsede_holding||0},_pintarPedidoHolding:function(e){this.getPedidoById(e.idpedido)},async getPedidoById(e){this.searchItemInPedidos(e)||(this.listIdsPedidos.push(e),await delay(1e3),await $.ajax({type:"POST",url:"../../bdphp/log_010.php",data:JSON.stringify({op:"get-pedidos-holding-meseros-by-id",idpedido:e,idsede_holding:this.idsede_holding})}).done(e=>{e=JSON.parse(e).datos;e.forEach(e=>{this.addPedidoInPedidos(e)})}))},_initializeSocket:async function(){_cpSocketOpen(),this.getPedidosHoldingMeserosByDay(),$("#txt_fecha_pedido_mozo").pickadate({format:"dd mmmm, yyyy",today:"Hoy",clear:"Borrar",close:"Cerrar",onSet:e=>{e=e.select?xDevolverFechaDada2(e.select):"";this.fechaSelected=xSetInputDate(e),this.getPedidosHoldingMeserosByDay()}})},searchItemInPedidos:function(o){return this.listIdsPedidos.find(e=>e==o)},getPedidosHoldingMeserosByDay(){xPopupLoad.xopen(),this.pedidos=[],this.pedidosFiltrados=[],$.ajax({type:"POST",url:"../../bdphp/log_010.php",data:JSON.stringify({op:"get-pedidos-holding-meseros-by-day",fecha:this.fechaSelected,idsede_holding:this.idsede_holding})}).done(e=>{xPopupLoad.xclose();e=JSON.parse(e).datos;0===e.length?(this.pedidosFiltrados=JSON.parse(JSON.stringify(this.pedidosFiltrados)),this._actualizarResumen()):e.forEach(e=>{this.addPedidoInPedidos(e)})})},addPedidoInPedidos(e){e.estado_cerrado="1"==e.cerrado_mesero?"Cerrado":"Pendiente",this.pedidos.push(e),e.icon="../../images/"+e.icon,this.pedidos.sort((e,o)=>parseInt(o.idpedido)-parseInt(e.idpedido)),this.pedidosFiltrados=this.pedidos,this.listIdsPedidos.push(e.idpedido),this.pedidosFiltrados=JSON.parse(JSON.stringify(this.pedidosFiltrados)),this._actualizarListaMozos(),this._actualizarResumen()},_actualizarListaMozos(){var e=[...new Set(this.pedidos.map(e=>({nom_mozo:e.nom_mozo,idusuario:e.idusuario})))];this.listaMozos=e.reduce((e,o)=>{return e.find(e=>e.nom_mozo===o.nom_mozo)||e.push({nom_mozo:o.nom_mozo,idusuario:o.idusuario}),e},[])},_filterByMozo(e){const o=e.target.value;this.mozoSeleccionada=this.listaMozos.find(e=>e.nom_mozo===o),this.showBtnCerrarCuentaMozo=""!==o,o?(this.pedidosFiltrados=this.pedidos.filter(e=>e.nom_mozo===o),e=this.pedidosFiltrados.some(e=>"1"!==e.cerrado_mesero),this.showBtnCerrarCuentaMozo=e):this.pedidosFiltrados=this.pedidos,this.pedidosFiltrados=JSON.parse(JSON.stringify(this.pedidosFiltrados)),this._actualizarResumen()},_actualizarResumen(){let o={totalPedidos:new Set,metodosPago:{}};this.pedidosFiltrados.forEach(e=>{o.totalPedidos.add(e.idregistro_pago),o.metodosPago[e.des_tp]||(o.metodosPago[e.des_tp]={cantidad:0,total:0,icon:e.icon}),o.metodosPago[e.des_tp].cantidad++,o.metodosPago[e.des_tp].total+=parseFloat(e.importe)}),this.resumenMetodosPago=Object.keys(o.metodosPago).map(e=>({metodo:e,cantidad:o.metodosPago[e].cantidad,total:o.metodosPago[e].total,icon:o.metodosPago[e].icon})),this.importeTotal=this.pedidosFiltrados.reduce((e,o)=>e+parseFloat(o.importe),0),this.importeTotal=this.importeTotal.toFixed(2),this.resumenMetodosPago=JSON.parse(JSON.stringify(this.resumenMetodosPago))},cerrarCuentaMozo:function(){xPopupLoad.xopen();var e=this.pedidosFiltrados.map(e=>e.idpedido).join(",");$.ajax({type:"POST",url:"../../bdphp/log_010.php",data:JSON.stringify({op:"set-cerrar-pedidos-meseros",idpedidos:e})}).done(e=>{this.showBtnCerrarCuentaMozo=!1,this.getPedidosHoldingMeserosByDay()})},_formatImporte:function(e){return parseFloat(e).toFixed(2)},_getCerradoClass:function(e){return"Cerrado"===e?"text-success":"text-danger"},_formatTime:function(e){return new Date(e).toLocaleTimeString()},displayIndex:function(e){var o=this.pedidos.length;return xCeroIzq(o-e,1)},getShowMetodosPago:function(){dialogMetodoPago.open()}})</script></dom-module>