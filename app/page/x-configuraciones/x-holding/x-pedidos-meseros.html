<script src="../../../view/socket.service.p.js"></script><dom-module id="x-pedidos-meseros"><template><br><div class="xMiCard xradius"style="width:85%;max-width:1100px"><div class="xEncanezadoCard"style="background:#fff0f5;color:#424242"><div class="d-flexx justify-content-between align-items-center"><h3>Pedidos por Mozos</h3></div></div><div class="xLinea2"></div><div class="xContentCard"style="padding:20px"><div class="container"><div class="filter-section mb-2 d-flexx justify-content-between align-items-end"><div class="d-flexx"><div><p class="fw-600">Nombre</p><select class="selected-template-1 fs-15"id="filterMozo"on-change="_filterByMozo"><option value="">Todas los meseros</option><template is="dom-repeat"items="[[listaMozos]]"><option value="[[item.nom_mozo]]">[[item.nom_mozo]]</template></select></div><div class="ml-3"><p class="fw-600">Fecha</p><input style="height:20px"class="selected-template-1 xCursor"id="txt_fecha_pedido_mozo"placeholder="Elige fecha"></div></div></div><hr><table class="w-100"><thead><th>#<th align="left">Fecha<th align="center">Pedido<th align="center">Atendido Por<th align="center">Marca<th align="center">Mesa<th align="right">Medios<th align="right">Estado<tbody><template is="dom-repeat"items="[[pedidosFiltrados]]"><tr class="pedido-item"><td>{{displayIndex(index)}}<td>[[item.fecha]]<td align="center">[[item.idpedido]]<td align="center">[[item.nom_us]]<td align="center">[[item.marca]]<td align="center"><p>Mesa: [[item.nummesa]]<td align="right"><div class="d-flexx justify-content-end"><img src="[[item.icon]]"alt="Método de pago"width="16"class="ml-1"> <span class="ml-1">[[item.importe]]</span></div><td align="right"><span class$="[[_getCerradoClass(item.estado_cerrado)]]">[[item.estado_cerrado]]</span></template></table><br><br><div><p class="fs-18 fw-600">Resumen de pagos</p><br><div><div class="resumen-content d-flexx fs-15"><div class="metodos-pago"><template is="dom-repeat"items="[[resumenMetodosPago]]"><div class="metodo-item"><img src="[[item.icon]]"alt="Método de pago"width="16"class="ml-1"> <span class="ml-2">[[item.cantidad]]</span> <span class="fw-600 ml-2">[[item.metodo]]</span> <span class="fw-900 ml-2">[[_formatImporte(item.total)]]</span></div></template></div><div class="total-general ml-5"><p><span class="fw-900">Total de pedidos:</span> [[pedidosFiltrados.length]]<p><span class="fw-900">Importe Total:</span> <span class="fs-18">[[importeTotal]]</span></div><div class="ml-5"><button class="btn btn-primary"on-click="cerrarCuentaMozo"hidden$="[[!showBtnCerrarCuentaMozo]]">Cerrar cuenta</button></div></div></div></div><br></div></div></div></template><style>.comision-info{font-size:.9em;color:#666}.total-general div{margin:5px 0}.comision-amount{color:#d32f2f}.total-after-commission{font-weight:700;color:#1976d2}.metodo-item{display:flex;margin:5px 0}.resumen-content{display:flex;font-size:14px}</style><script>Polymer({is:"x-pedidos-meseros",properties:{pedidos:{type:Array,value:function(){return[]}},listIdsPedidos:{type:Array,value:function(){return[]}},pedidosFiltrados:{type:Array,value:function(){return[]}},listaMarcas:{type:Array,value:function(){return[]}},listaMozos:{type:Array,value:function(){return[]}},resumenMetodosPago:{type:Array,value:function(){return[]}},showBtnCerrarCuentaMozo:{type:Boolean,value:!1},mozoSeleccionada:{type:Object,value:function(){return{}}},fechaSelected:{type:String,value:""},importeTotal:{type:Number,value:0}},attached:function(){this.pedidos=[],this._initializeSocket(),$("body").addClass("loaded")},detached:function(){},_pintarPedidoHolding:function(o){this.getPedidoById(o.idpedido)},async getPedidoById(o){this.searchItemInPedidos(o)||(this.listIdsPedidos.push(o),await $.ajax({type:"POST",url:"../../bdphp/log_010.php",data:JSON.stringify({op:"get-pedidos-holding-meseros-by-id",idpedido:o})}).done(o=>{o=JSON.parse(o).datos[0];this.addPedidoInPedidos(o)}))},_initializeSocket:async function(){_cpSocketOpen(),this.getPedidosHoldingMeserosByDay(),$("#txt_fecha_pedido_mozo").pickadate({format:"dd mmmm, yyyy",today:"Hoy",clear:"Borrar",close:"Cerrar",onSet:o=>{o=o.select?xDevolverFechaDada2(o.select):"";this.fechaSelected=xSetInputDate(o),this.getPedidosHoldingMeserosByDay()}})},searchItemInPedidos:function(e){return this.listIdsPedidos.find(o=>o==e)},getPedidosHoldingMeserosByDay(){xPopupLoad.xopen(),this.pedidos=[],this.pedidosFiltrados=[];var o=""===this.fechaSelected?(new Date).toISOString().split("T")[0]:this.fechaSelected;$.ajax({type:"POST",url:"../../bdphp/log_010.php",data:JSON.stringify({op:"get-pedidos-holding-meseros-by-day",fecha:o,idsede_holding:6})}).done(o=>{xPopupLoad.xclose();o=JSON.parse(o).datos;0===o.length?(this.pedidosFiltrados=JSON.parse(JSON.stringify(this.pedidosFiltrados)),this._actualizarResumen()):o.forEach(o=>{this.addPedidoInPedidos(o)})})},addPedidoInPedidos(o){o.estado_cerrado="1"==o.cerrado_mesero?"Cerrado":"Pendiente",this.pedidos.push(o),o.icon="../../images/"+o.icon,this.pedidosFiltrados=this.pedidos,this.listIdsPedidos.push(o.idpedido),this.pedidosFiltrados=JSON.parse(JSON.stringify(this.pedidosFiltrados)),this._actualizarListaMozos(),this._actualizarResumen()},_actualizarListaMozos(){var o=[...new Set(this.pedidos.map(o=>({nom_mozo:o.nom_mozo,idusuario:o.idusuario})))];this.listaMozos=o.reduce((o,e)=>{return o.find(o=>o.nom_mozo===e.nom_mozo)||o.push({nom_mozo:e.nom_mozo,idusuario:e.idusuario}),o},[])},_filterByMozo(o){const e=o.target.value;this.mozoSeleccionada=this.listaMozos.find(o=>o.nom_mozo===e),this.showBtnCerrarCuentaMozo=""!==e,e?(this.pedidosFiltrados=this.pedidos.filter(o=>o.nom_mozo===e),o=this.pedidosFiltrados.some(o=>"1"!==o.cerrado_mesero),this.showBtnCerrarCuentaMozo=o):this.pedidosFiltrados=this.pedidos,this.pedidosFiltrados=JSON.parse(JSON.stringify(this.pedidosFiltrados)),this._actualizarResumen()},_actualizarResumen(){let e={totalPedidos:new Set,metodosPago:{}};this.pedidosFiltrados.forEach(o=>{e.totalPedidos.add(o.idregistro_pago),e.metodosPago[o.des_tp]||(e.metodosPago[o.des_tp]={cantidad:0,total:0,icon:o.icon}),e.metodosPago[o.des_tp].cantidad++,e.metodosPago[o.des_tp].total+=parseFloat(o.importe)}),this.resumenMetodosPago=Object.keys(e.metodosPago).map(o=>({metodo:o,cantidad:e.metodosPago[o].cantidad,total:e.metodosPago[o].total,icon:e.metodosPago[o].icon})),this.importeTotal=this.pedidosFiltrados.reduce((o,e)=>o+parseFloat(e.importe),0),this.importeTotal=this.importeTotal.toFixed(2),this.resumenMetodosPago=JSON.parse(JSON.stringify(this.resumenMetodosPago))},cerrarCuentaMozo:function(){xPopupLoad.xopen();var o=this.pedidosFiltrados.map(o=>o.idpedido).join(",");$.ajax({type:"POST",url:"../../bdphp/log_010.php",data:JSON.stringify({op:"set-cerrar-pedidos-meseros",idpedidos:o})}).done(o=>{this.showBtnCerrarCuentaMozo=!1,this.getPedidosHoldingMeserosByDay()})},_formatImporte:function(o){return parseFloat(o).toFixed(2)},_getCerradoClass:function(o){return"Cerrado"===o?"text-success":"text-danger"},_formatTime:function(o){return new Date(o).toLocaleTimeString()},displayIndex:function(o){var e=this.pedidos.length;return xCeroIzq(e-o,1)}})</script></dom-module>