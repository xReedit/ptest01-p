<dom-module id="x-carta-virtual-mesas">
<script src="../../../../js/qrious.js"></script>
<link rel="import" href="../../../x-componentes/x-comp-img-upload/x-comp-img-upload-2.html">
<template is="dom">
<paper-dialog oncontextmenu="null" id="dialog_qr" modal class="dialog-redondo" entry-animation="scale-up-animation" exit-animation="fade-out-animation">
<p> {{ objQrSelected.titulo }} </p>
<canvas id="qr-download"></canvas>
<br>
<div style="display:flex">
<div class="xBoton2 xVerde" onclick="copiarQr()">Copiar</div>
<div class="xBoton2 xPlomo" dialog-dismiss>Cerrar</div>
</div>
</paper-dialog>
<div>
<h3>Logo</h3>
<p>Logo que va en el diseño impreso.</p>
<div class="xLinea2"></div>
<div>
<x-comp-img-upload-2 id="compImgLogo" medidasimg="[[medidaLogo]]"></x-comp-img-upload-2>
</div>
<br>
<div class="xLinea2"></div>
<br>
<h3>Codigos QR para las mesas</h3>
<p>Toca para descargar.</p>
<br>
<div class="content-qr" style="background:white">
<paper-tabs selected="{{selectedTab}}">
<paper-tab>Centro de Mesa</paper-tab>
<paper-tab>Solo Qr</paper-tab>
<paper-tab>Stiker</paper-tab>
</paper-tabs>
<div class="xLinea2"></div>
<br><br>
<iron-pages selected="{{selectedTab}}" style="background:white">
<div id="template-1">
<div class="div-copy-all" style="background:white;max-width:1600px" id="div-pdf-qr">
<template is="dom-repeat" items="{{objListMesasQr}}" as="item">
<div class="codigo-qr content-bg-qr xCursor" onclick="xCopyQrCarta(this)" data-index=[[index]]>
<div class="bg-qr-mesa">
<div class="content-logo-qr">
<img src$="[[imgLogoQr]]" alt="logo-qr">
</div>
<p class="fw-900 fs-25 num-mesa">{{item.nummesa}}</p>
<img class="img-qr" src="{{item.codigo_d1}}" alt="qr">
</div>
</div>
</template>
</div>
<button class="btn btn-primary" onclick="xCopyAllQrCarta(this)"><i class="fa fa-copy"></i> Descargar Todo</button>
</div>
<div id="template-2">
<template is="dom-repeat" items="{{objListMesasQr}}" as="item">
<div class="codigo-qr xCursor" onclick="generateQRCode(this,1)" data-index=[[index]]>
<img src="{{item.codigo}}" alt="">
<span>{{item.nummesa}}</span>
</div>
</template>
</div>
<div id="template-3">
<div class="div-copy-all" style="background:white;max-width:1600px">
<template is="dom-repeat" items="{{objListMesasQr}}" as="item">
<div class="div-sticker m-2 xCursor" onclick="xCopyQrCarta(this)" data-index=[[index]]>
<div class="text-center">
<h3 class="fw-900">PIDE AQUí</h3>
<p class="m-0 fs-15 fw-600">Atención sin esperas. Escanea el QR con la camara de tu celular.</p>
</div>
<div class="codigo-qr">
<div class="d-flexx align-items-center">
<div>
<img src="{{item.codigo_d1}}" alt="codigo-qr">
</div>
<div class="text-center">
<p class="fs-15 fw-600 mb-2">Mesa #</p>
<p class="fs-50 fw-600">{{item.nummesa}}</p>
</div>
</div>
</div>
<div style="margin-top:-20px">
<p class="m-0 fs-12 fw-600">papaya.com.pe</p>
</div>
</div>
</template>
</div>
<br>
<button class="btn btn-primary" onclick="xCopyAllQrCarta(this)"><i class="fa fa-copy"></i> Descargar Todo</button>
</div>
</iron-pages>
</div>
<br><br>
<h3>Otros Codigos QR</h3>
<p>Toca para descargar.</p>
<div class="xLinea2"></div>
<div class="content-qr">
<template is="dom-repeat" items="{{objListOtherQr}}" as="item_o">
<div class="codigo-qr xCursor" onclick="generateQRCode(this,0)" data-index=[[index]]>
<img src="{{item_o.codigo}}" alt="">
<span>{{item_o.titulo}}</span>
</div>
</template>
</div>
<br>
<br><br>
<div class="xLinea2"></div>
<br>
<h4>LINK DELIVERY para compartir.</h4>
<span>De clic en este link para copiarlo y compartirlo con sus clientes por sus redes sociales, los llevara directo a visualizar su carta desde donde podrá realizar su pedido</span>
<p class="text-info xCursor" title="Copiar" onclick="copiarUrl()" id="urlcopy">{{url_delivery}}</p>
<br>
<span>Además puede acortar el enlaze con este servicio: <a href="https://bitly.com/" target="_blank" class="text-info">Short URL</a></span>
<br>
<br><div class="xLinea2"></div>
<br>
<br><br>
</div>
</template>
</dom-module>
<style>.content-qr{display:inline-block}.codigo-qr{display:inline-grid;text-align:center}.bg-qr-mesa{background-image:url('./plano_qr.png');background-repeat:no-repeat;background-size:contain}.content-bg-qr{width:312px;height:480PX;margin-bottom:6px;background:white}.bg-qr-mesa .num-mesa{position:relative;left:110px;top:-65px;color:white;font-size:70px}.bg-qr-mesa .img-qr{top:10px;position:relative}.content-logo-qr{width:81px;height:81px;border-radius:50%;overflow:hidden;position:relative;left:12px;top:5px;background:white;border:.04em solid}.content-logo-qr>img{width:84px;text-align:center;position:relative;left:-2px}.div-sticker{width:250px;text-align:center;background:white;border:1px solid;border-radius:5px;padding:20px;display:inline-block}</style>
<script>/*<![CDATA[*/var xThisCartaVMesas,compImgLogo,_keyUrlLogoQr='';function xIniCartaVirtualMesas(){xThisCartaVMesas.medidaLogo={width:200,height:200}
const _dataSede=xm_log_get('datos_org_sede')[0];_keyUrlLogoQr=_dataSede.idorg+''+_dataSede.idsede+'logoqr.png';compImgLogo=document.getElementById('compImgLogo');compImgLogo.addEventListener('setImg',res=>{const nomfileImg='logoqr';const img_promo=res.detail;uploadImgLogo(img_promo,nomfileImg)})
xThisCartaVMesas.imgAfiche=URL_IMG_CARTA+'afiche_qr_modelo.jpg';loadDatosCartaMesas();}
function loadDatosCartaMesas(){$.ajax({type:'POST',url:'../../bdphp/log_005.php?op=903'}).done(function(res){res=JSON.parse(res);xThisCartaVMesas.objListMesasQr=JSON.parse(res.datos[0].mesas);xThisCartaVMesas.objListMesasQr.map(x=>{const _cod=x.codigo.replace('/#','');x.codigoDownload='https://chart.apis.google.com/chart?cht=qr&chs=400x400&chl='+_cod;x.codigo_d1='https://chart.apis.google.com/chart?cht=qr&chs=185x185&chl='+_cod;x.codigo='https://chart.apis.google.com/chart?cht=qr&chs=75x75&chl='+_cod;x.titulo='Mesa '+x.nummesa;x.codigo_qr=_cod;return x;})
xThisCartaVMesas.objListOtherQr=[];var listOther=[];xThisCartaVMesas.qrLLevar={};var _cod=res.datos[0].qr_para_llevar;xThisCartaVMesas.qrLLevar.codigoDownload='https://chart.apis.google.com/chart?cht=qr&chs=400x400&chl='+_cod;xThisCartaVMesas.qrLLevar.codigo='https://chart.apis.google.com/chart?cht=qr&chs=50x50&chl='+_cod;xThisCartaVMesas.qrLLevar.titulo='Solo para llevar';xThisCartaVMesas.qrLLevar.codigo_qr=_cod;xThisCartaVMesas.qrDelivery={};_cod=res.datos[0].qr_delivery;xThisCartaVMesas.qrDelivery.codigoDownload='https://chart.apis.google.com/chart?cht=qr&chs=400x400&chl='+_cod;xThisCartaVMesas.qrDelivery.codigo='https://chart.apis.google.com/chart?cht=qr&chs=50x50&chl='+_cod;xThisCartaVMesas.qrDelivery.titulo='Delivery';xThisCartaVMesas.qrDelivery.codigo_qr=_cod;xThisCartaVMesas.url_delivery=_cod;listOther.push(xThisCartaVMesas.qrLLevar);listOther.push(xThisCartaVMesas.qrDelivery);xThisCartaVMesas.objListOtherQr=JSON.parse(JSON.stringify(listOther));const _pathImg=URL_IMG_PROMO+_keyUrlLogoQr;try{compImgLogo.setImgPathFile(_pathImg);xThisCartaVMesas.imgLogoQr=_pathImg;}catch(error){compImgLogo.resetControl(_pathImg);xThisCartaVMesas.imgLogoQr='';}});}
function descargarAfiche(){window.open(xThisCartaVMesas.imgAfiche,'Afiche',"width=500,height=500");}
function descargarOtroQR(obj){const index=obj.dataIndex;const fileDown=xThisCartaVMesas.objListOtherQr[index];const url=fileDown.codigoDownload;window.open(url,"CodigoQR","width=500,height=500");}
function descarGarQR(obj){const index=obj.dataIndex;const fileDown=xThisCartaVMesas.objListMesasQr[index];const url=fileDown.codigoDownload;window.open(url,"CodigoQR","width=500,height=500");}
function generateQRCode(obj,op){const index=obj.dataIndex;var item=op===0?xThisCartaVMesas.objListOtherQr[index]:xThisCartaVMesas.objListMesasQr[index];xThisCartaVMesas.objQrSelected=item;var qr=new QRious({foreground:'black',element:document.getElementById('qr-download'),size:350,value:item.codigo_qr});dialog_qr.open();}
async function copiarQr(){var img=document.getElementById('qr-download');img=img.toDataURL('image/png');const response=await fetch(img)
const blob=await response.blob()
await setToClipboard(blob);}
async function xCopyQrCarta(obj){var scale=9;domtoimage.toPng(obj,{quality:1.0,width:obj.clientWidth*scale,height:obj.clientHeight*scale,style:{transform:'scale('+scale+')',transformOrigin:'top left'}}).then(function(dataUrl){var link=document.createElement("a");link.download="ImageQr.png";link.href=dataUrl;link.click();}).then(function(){console.log("download Done");});}
function xConvertToPDF(obj){var element=document.querySelector('#div-pdf-qr');var pdf=new jsPDF();var specialElementHandlers={'#editor':function(element,renderer){return true;}};pdf.fromHTML(element.innerHTML,15,15,{'width':170,'elementHandlers':specialElementHandlers});;pdf.save('sample-file.pdf');}
async function xCopyAllQrCarta(obj){const _obj=$(obj).parent().find('.div-copy-all')[0];xCopyQrCarta(_obj);}
async function setToClipboard(blob){showToastSwal('success','Copiado!');const data=[new ClipboardItem({[blob.type]:blob})]
return navigator.clipboard.write(data)}
function copiarUrl(){var text=document.getElementById('urlcopy').innerText;var elem=document.createElement("textarea");document.body.appendChild(elem);elem.value=text;elem.select();document.execCommand("copy");document.body.removeChild(elem);}
function uploadImgLogo(imgBase64,nomfile){$.ajax({type:'POST',url:'upload_base64.php?op=6',data:{nomfile:nomfile,img:imgBase64}}).done((res)=>{console.log('ok');});}
Polymer({is:'x-carta-virtual-mesas',properties:{xt_org:Number,xt_idsede:Number,objListMesasQr:Object,qrLLevar:Object,qrDelivery:Object,objListOtherQr:Object,objQrSelected:Object,url_delivery:String,imgAfiche:String,medidaLogo:Object,imgLogoQr:String,selectedTab:Number},attached:function(){this.selectedTab=0
xThisCartaVMesas=this;xIniCartaVirtualMesas();}})/*]]>*/</script>