<dom-module id="x-carta-virtual-mesas">
    <template is="dom"> 
        <div>
            <h3>Codigos QR para las mesas</h3>
            <p>Toca para descargar.</p>
            <div class="xLinea2"></div>
            <br>
            <div class="content-qr">
                <template is="dom-repeat" items="{{objListMesasQr}}" as="item">
                    <div class="codigo-qr xCursor" onclick="descarGarQR(this)" data-index = [[index]]>
                        <!-- <a href="#" download="{{item.codigoDownload}}"> -->
                            <img src="{{item.codigo}}" alt="">
                            <span>{{item.nummesa}}</span>
                        <!-- </a> -->
                    </div>
                </template>
            </div>
            <br><br>
            <h3>Otros Codigos QR</h3>
            <p>Toca para descargar.</p>
            <div class="xLinea2"></div>
            <div class="content-qr">
                <template is="dom-repeat" items="{{objListOtherQr}}" as="item_o">
                    <div class="codigo-qr xCursor" onclick="descargarOtroQR(this)" data-index = [[index]]>                        
                        <img src="{{item_o.codigo}}" alt="">
                        <span>{{item_o.titulo}}</span>
                    </div>
                </template>
            </div>

            <br><br>
            <h3>Modelo de afiche</h3>
            <p>Toca para descargar.</p>
            <div class="xLinea2"></div>           
            <a href="{{imgAfiche}}" download>
                <img class="xCursor" src="{{imgAfiche}}" alt="" width="100">
            </a>       
            

            
            <br><br><br><br><br><br>
        </div>
    </template>
</dom-module>

<style>
    .content-qr {
        display: inline-block;        
    }

    .codigo-qr {
        display: inline-grid;
        text-align: center;
    }

</style>

<script>
    var xThisCartaVMesas;

    function xIniCartaVirtualMesas() {
        console.log('ini mesa carta');

        xThisCartaVMesas.imgAfiche = URL_IMG_CARTA + 'afiche_qr_modelo.jpg';
        console.log('xThisCartaVMesas.imgAfiche', xThisCartaVMesas.imgAfiche);

        loadDatosCartaMesas();
        // loadReglasPwa();
    }

    function  loadDatosCartaMesas() {
        $.ajax({ type: 'POST', url: '../../bdphp/log_005.php?op=903'})
	    .done( function (res) {
            res = JSON.parse(res);
            // console.log('mesas', res.datos[0].mesas);
            xThisCartaVMesas.objListMesasQr = JSON.parse(res.datos[0].mesas);
            xThisCartaVMesas.objListMesasQr.map(x => {
                x.codigoDownload = `https://chart.apis.google.com/chart?cht=qr&chs=400x400&chl=${x.codigo}`;
                x.codigo = `https://chart.apis.google.com/chart?cht=qr&chs=50x50&chl=${x.codigo}`;
                return x;
            })
            // console.log(xThisCartaVMesas.objListMesasQr);


            // codigo qr para llevar
            xThisCartaVMesas.objListOtherQr = [];
            var listOther = [];
            xThisCartaVMesas.qrLLevar = {};
            var _cod = res.datos[0].qr_para_llevar;
            xThisCartaVMesas.qrLLevar.codigoDownload = `https://chart.apis.google.com/chart?cht=qr&chs=400x400&chl=${_cod}`;
            xThisCartaVMesas.qrLLevar.codigo = `https://chart.apis.google.com/chart?cht=qr&chs=50x50&chl=${_cod}`;
            xThisCartaVMesas.qrLLevar.titulo = 'Solo para llevar';
            
            // codigo qr delivery
            xThisCartaVMesas.qrDelivery = {};
            _cod = res.datos[0].qr_delivery;
            xThisCartaVMesas.qrDelivery.codigoDownload = `https://chart.apis.google.com/chart?cht=qr&chs=400x400&chl=${_cod}`;
            xThisCartaVMesas.qrDelivery.codigo = `https://chart.apis.google.com/chart?cht=qr&chs=50x50&chl=${_cod}`;
            xThisCartaVMesas.qrDelivery.titulo = 'Delivery';

            listOther.push(xThisCartaVMesas.qrLLevar);
            listOther.push(xThisCartaVMesas.qrDelivery);
            xThisCartaVMesas.objListOtherQr = JSON.parse(JSON.stringify(listOther));

            console.log('xThisCartaVMesas.objListOtherQr', xThisCartaVMesas.objListOtherQr);
        });
    }

    function descargarAfiche() {
        window.open(xThisCartaVMesas.imgAfiche, 'Afiche', "width=500,height=500");
    }

    function descargarOtroQR(obj) {
        const index = obj.dataIndex;
        const fileDown = xThisCartaVMesas.objListOtherQr[index];
        const url = fileDown.codigoDownload;
        window.open(url, "CodigoQR", "width=500,height=500");
    }

    function descarGarQR(obj) {
        const index = obj.dataIndex;
        const fileDown = xThisCartaVMesas.objListMesasQr[index];

        const url = fileDown.codigoDownload;
        window.open(url, "CodigoQR", "width=500,height=500");
        // var a = document.createElement("a");

        // a.href = url;
        // fileName = url.split("/").pop();
        // a.download = 'aaaa.png';
        // document.body.appendChild(a);
        // a.click();
        // window.URL.revokeObjectURL(url);
        // a.remove();
        // var downloading = browser.downloads.download({
        //     url : fileDown.codigoDownload,
        //     filename : fileDown.nummesa + '.png',
        //     conflictAction : 'uniquify'
        //     });

        // downloading.then(null, null);
    }
    // function saveParamentros() {
    //     xPopupLoad.xopen();
    //     var _data = {
    //         'pwa_time_limit': txt_minutos.value,
    //         'pwa_msj_ini': txt_bienvenida.value,
    //         'pwa_time_min_despacho': txt_minutos_min_despacho.value,
    //         'pwa_time_max_despacho': txt_minutos_max_despacho.value,
    //         'latitude': txt_latitude.value,
    //         'longitude': txt_longitude.value
    //     }

    //     $.ajax({ 
    //         type: 'POST', 
    //         url: '../../bdphp/log_005.php?op=902', 
    //         data: {item: _data}
    //     })
	//     .done( function (res) {
    //         console.log(res);
    //         xPopupLoad.xclose();
    //     })
    // }

    Polymer({
            is: 'x-carta-virtual-mesas',
            properties: {
                xt_org:Number,
                xt_idsede:Number,
                objListMesasQr: Object,
                qrLLevar: Object,
                qrDelivery: Object,
                objListOtherQr: Object,
                imgAfiche: String
            },
            attached: function () {                
                xThisCartaVMesas = this;
                xIniCartaVirtualMesas();
            }
        })
</script>
