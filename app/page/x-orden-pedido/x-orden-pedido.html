<link rel="import"href="../../x-componentes/x-comp-find-tipo-pago/x-comp-find-tipo-pago.html"><link rel="import"href="../../x-componentes/x-comp-find-item-producto/x-comp-find-item-producto.html"><dom-module id="x-orden-pedido"><script src="../../view/httpFech.js"></script><script src="../../view/item_pedido_print_comprobante.js"></script><script src="../../view/item_pedido_estructura.js"></script><script src="../../view/item_pedido_subtotales.js"></script><script src="../../view/deNumALetras.js"></script><script src="../../view/xJsonSunat.js"></script><script src="../../view/cpe_interno.js"></script><script rel="prefetch"src="../../view/socket.service.p.js"></script><template is="dom"><paper-dialog class="dialog_redondo"id="dialog_adelanto"entry-animation="scale-up-animation"exit-animation="fade-out-animation"with-backdrop><div class="p-2"><h4>Registrar Adelanto</h4><br><div class="p-1"><x-comp-find-tipo-pago onchange="selectTipoPago(this)"id="compTipoPago"></x-comp-find-tipo-pago></div><input class="xMiInput xPasarEnter2 w-100"placeholder="Concepto"onchange="conMayusculas(this)"id="txt_concepto_adelanto"required espaciar> <input type="number"class="xMiInput xPasarEnter2 w-50"placeholder="Importe"onchange="conMayusculas(this)"id="txt_importe_adelanto"required espaciar></div><br><div class="buttons"><button class="xBoton2 xPlomo"dialog-dismiss>Cancelar</button> <button class="xBoton2 xAzul"onclick="xRegistrarAdelanto()">Registrar Adelanto</button></div></paper-dialog><paper-dialog id="dialog_comprobante"style="min-width:320px"entry-animation="scale-up-animation"exit-animation="fade-out-animation"with-backdrop><div class="xContent"><x-pago id="component_pago"></x-pago></div></paper-dialog><paper-dialog class="dialog_redondo"id="dialog_nota"entry-animation="scale-up-animation"exit-animation="fade-out-animation"with-backdrop><div class="p-2"><h4>Registrar Nota:</h4><textarea class="xPasarEnter2 selected-template-1 w-100"name=""id="txt_nota_nota"cols="4"rows="4"maxlength="150"></textarea></div><div class="buttons"><button class="xBoton2 xPlomo"dialog-dismiss>Cancelar</button> <button class="xBoton2 xAzul"onclick="xRegistrarNota()">Registar Nota</button></div></paper-dialog><div class="xMiCard xradius"style="width:85%;max-width:1100px"><div class="xEncanezadoCard"style="background:#fff0f5;color:#424242"><div class="d-flexx justify-content-between align-items-center"><h3>Orden de pedido {{ correlativoOrden }}</h3><button class="btn btn-sm btn-secondary"onclick="goBackLista()"><i class="fa fa-arrow-circle-left"></i> Atras</button></div></div><div class="xLinea2"></div><div class="p-2"style="background:beige;color:#424242"><paper-button><div class="xMiBoton_icon_lateral2"style="margin-top:-15px;width:90px"onclick="cocinarImpresionOrdenPedido()"id="btn_anular_pedido"><img src="../../../images/_print_1_vr.png"><p>Imprimir</div></paper-button><paper-button disabled$="[[!isDisabledFacturar]]"><div class="xMiBoton_icon_lateral2"style="margin-top:-15px;width:90px"onclick="xAbrirDialogComprobante()"id="btn_anular_pedido"><img src="../../../images/_comprobante.png"><p>Emitir Comprobante</div></paper-button><paper-button><div class="xMiBoton_icon_lateral2"style="margin-top:-15px"onclick="generatePDFOrdenPedido()"id="btn_anular_pedido"><img src="../../../images/001-pdf-file.png"><p>PDF</div></paper-button></div><div class="xLinea2"></div><div class="xContentCard"style="padding:20px"><div class="w-100"><form action=""id="form_pago_cliente"><div class="rowx pb-2"><div class="col-sm-7"><h5>Cliente</h5><input class="xMiInput xPasarEnter2 w-100"placeholder="Nombre / Razon Social"onkeyup="removeSpecialCharObj(this)"onchange="conMayusculas(this)"id="frm_nombres"required espaciar> <input class="xMiInput xPasarEnter2 w-100"placeholder="Direccion de entrega"onkeyup="removeSpecialCharObj(this)"onchange="conMayusculas(this)"id="frm_direccion"espaciar> <input class="xMiInput xPasarEnter2 w-100"placeholder="Telefono"onkeyup="removeSpecialCharObj(this)"onchange="conMayusculas(this)"id="frm_telefono"required espaciar></div><div class="col-sm-4"><h5>Fecha de entrega</h5><input type="datetime-local"class="xMiInput w-100"placeholder="Fecha de entrega"id="f_entrega"required enlinea espaciar> <input class="xMiInput xPasarEnter2 w-100"placeholder="Nota"onkeyup="removeSpecialCharObj(this)"onchange="conMayusculas(this)"id="txt_nota"espaciar></div><div class="xInvisible"><input id="form_idorden_pedido"></div></div></form><br><div class="xLinea2"></div><br><br><div class="w-100 d-flexx justify-content-end"><button class="btn btn-sm btn-success"onclick="xAddItem()">+ Agregar</button></div><table class="xtable4"width="100%"><thead><th class="xSinBorde"width="60%">Descripcion<th class="xSinBorde"width="10px">Cant<th class="xSinBorde"width="30px"align="right">P.Unitario<th class="xSinBorde"width="30px"align="right">P.Total</thead><tr class="xSinBorde"data-id=""><td><x-comp-find-item-producto clasecss="xMiInput xPasarEnter2 w-100"id="compItemProducto"></x-comp-find-item-producto><td><input type="number"class="xMiInput xPasarEnter2"style="width:100%"placeholder="Cant"onchange="conMayusculas(this)"onkeyup="xCalcTotal()"required id="cant_item"autofocus><td><input type="number"class="xMiInput xAlinearDerecha punitario"onchange="conMayusculas(this)"onblur="xRetornaMoneda(this)"placeholder="P. Unitario"id="punitario"name="precio"required><td><input type="number"class="xMiInput xAlinearDerecha xprecio"onchange="conMayusculas(this)"onblur="xRetornaMoneda(this)"placeholder="P. Total"id="ptotal"name="total"required readonly="readonly"></tr><template is="dom-repeat"items="{{arrItems}}"as="item"><tr data-value="[[index]]"><td><span class="xDeleteRowNeutro"title="Borrar"onclick="xBorrarItemLocalArr(this)"></span> {{item.descripcion}}<td>{{item.cantidad}}<td align="right">{{item.punitario}}<td align="right">{{item.ptotal}}</template><template is="dom-repeat"items="{{arrTotales}}"as="total"><tr class="tt_row"><td colspan="2"class="xSinBorde"><td align="right">{{ total.descripcion }}<td align="right">{{ total.importe }}</template><tr hidden$="[[!showNotaAdelanto]]"><td colspan="2"class="xSinBorde"><td align="right">Adelanto<td align="right"><span class="xColorRow_Amarillo xBold">{{totalAdelanto}}</span><tr hidden$="[[!showNotaAdelanto]]"><td colspan="2"class="xSinBorde"><td align="right">Pendiente<td align="right"><span class="xColorRow_Azul xBold">{{totalPendiente}}</span></table><br><button class="btn btn-info"onclick="xGuardarOrdenPedido()">Listo, Guardar.</button><br><br><br><hr><br><div class="rowx pb-2"style="display:flex;justify-content:space-between"hidden$="[[!showNotaAdelanto]]"><div class="col-sm-4"><div class="d-flexx align-items-center"><h5>Notas o cambios</h5><button class="btn btn-sm btn-success ml-1"onclick="dialog_nota.open()">+</button></div><hr><table class="xtable4"width="100%"><thead><th class="xSinBorde"width="70%">Nota</thead><template is="dom-repeat"items="{{ListOrdenNotas}}"as="item"><tr data-value="[[index]]"><td><span class="fs-11">{{item.fecha_hora}} | {{item.nota}}</span></template></table></div><div class="col-sm-6"><div class="d-flexx align-items-center"><h5>Adelantos</h5><button class="btn btn-sm btn-success ml-1"onclick="dialog_adelanto.open()">+</button></div><hr><table class="xtable4"width="100%"><thead><th class="xSinBorde"width="70%">Concepto<th class="xSinBorde"width="40%">T. Pago<th class="xSinBorde"width="30px"align="right">Importe</thead><template is="dom-repeat"items="{{ListOrdenAdelanto}}"as="item"><tr data-value="[[index]]"><td><span class="fs-11">{{item.fecha_hora}} | {{item.concepto}}</span><td><span class="fs-11">{{item.des_tipo_pago}}</span><td align="right"><span class="fs-11">{{item.importe}}</span></template><tr><td colspan="2"><td align="right"><h5>{{ totalAdelanto }}</h5></table></div></div></div></div></div></template></dom-module><script>var xThisOrden,xPopupLoad,idOrdenPedido,cnf_ComprobanteSel,xIdCliente_pago,rptDoc,itemsConEstructuraPrint,_idregistro,tipoPagoSelected,compTipoPagoSelected,compItemProducto,elementItemProdcutoSeleted,_arrCliente=[],_arrTotal=[],_arrItems=[],_listValid=!1,_formValid=!1,_modificarCliente=!1,impresoraSelect={},IdTpConsumo=0,arr_comprobante=[],txt_fecha_cpe_manual="",isSocket=!0,xRpt_pago=[];function xIniOrdenPedido(){xThisOrden.formValid=!1,_formValid=_listValid=!1,xThisOrden.modificarCliente=!1,xThisOrden.arrItems=[],xThisOrden.arrTotales=[],xThisOrden.listImpresoras=[],xThisOrden.ListOrdenAdelanto=[],xThisOrden.cpe_show=!1,xThisOrden.fecha_manual=!1,xThisOrden.correlativoOrden="";var e=xm_log_get("estructura_pedido");IdTpConsumo=e[0].idtipo_consumo,(compTipoPagoSelected=document.getElementById("compTipoPago")).addEventListener("getValorIncial",e=>{selectTipoPago(e.target)}),(compItemProducto=document.getElementById("compItemProducto")).addEventListener("elementSeleted",e=>{e=(elementItemProdcutoSeleted=e.detail).label?elementItemProdcutoSeleted.label.split("|")[elementItemProdcutoSeleted.label.split("|").length-1]:e.target.valueInput;elementItemProdcutoSeleted.descripcion=e.trim(),punitario.value=elementItemProdcutoSeleted.precio||0}),fact_getAllImpresoras(),$("body").addClass("loaded"),$(".xPasarEnter2").on("keyup",function(e){var t=e.which;if(13==t||186==t){var t=$("input"),o=t.index(document.activeElement);if(null!==t[o+1]){var a=t[o+1];if(void 0===a)return;if(null==(a=a.disabled?t[o+2]:a))return;a.focus(),a.select()}return event.stopPropagation(),e.stopPropagation(),e.stopImmediatePropagation(),!1}}),$(".punitario").on("keyup",function(e){e=e.which;xCalcTotal(),13!=e&&186!=e||($("#punitario").val(xMoneda(this.value)),$("#ptotal").focus(),xAddItem())}),$(".xprecio").on("keyup",function(e){e=e.which;13!=e&&186!=e||xAddItem()}),$("#txt_fecha").on("change",function(){var e=$(this).val().split("-");txt_fecha_cpe_manual=void 0===e[1]?"":$(this).val()}),(xValPago=document.getElementById("component_pago")).addEventListener("xSend",function(e){xRpt_pago=e.detail.xRpts;e.detail.xRpts[0].ok}),xValPago.addEventListener("xCancelarCerrar",function(e){xThisOrden.$.dialog_comprobante.close()}),xValPago.addEventListener("xListoRegistraPago",function(e){xMandarCocinarImpresionComprobante_OrdenPedido()})}function xCalcTotal(){var e=""===$("#cant_item").val()?0:parseFloat($("#cant_item").val()),t=""===$("#punitario").val()?0:parseFloat($("#punitario").val()),e=parseFloat(parseFloat(e)*parseFloat(t)).toFixed(2)||0;$("#ptotal").val(e)}function xAddItem(){var e,t=$("#cant_item").val(),o=elementItemProdcutoSeleted.descripcion,a=$("#punitario").val(),r=$("#ptotal").val();""===t||""===o&&""===a&&""===r||(e={id:e=xCeroIzq(_arrItems.length+1,3),iditem:e,idtipo_consumo:IdTpConsumo,des_seccion:"ITEMS",cantidad:t,descripcion:o,punitario:a,precio:a,ptotal:r,precio_total_calc:r},_arrItems.push(e),xThisOrden.arrItems=JSON.parse(JSON.stringify(_arrItems)),xCalcularTotal(),xNuevoItem())}function xBorrarItemLocalArr(e){e=e.parentElement.parentElement.dataValue;_arrItems.splice(e,1),xThisOrden.arrItems=JSON.parse(JSON.stringify(_arrItems)),xCalcularTotal()}function xNuevoItem(){$("#cant_item").val(""),$("#des_item").val(""),$("#punitario").val(""),$("#ptotal").val(""),compItemProducto.resetText(),compItemProducto.focusText()}function xNuevoOrden(){$("#form_pago_cliente").reset(),$("#form_pago_cliente #frm_nombres").val(""),$("#form_pago_cliente #frm_direccion").val(""),$("#form_pago_cliente #frm_telefono").val(""),$("#form_pago_cliente #txt_nota").val(""),$("#form_pago_cliente #form_idorden_pedido").val(""),xThisOrden.arrItems=[],xThisOrden.arrTotales=[],xThisOrden.listImpresoras=[],xThisOrden.ListOrdenes=[],xThisOrden.ListOrdenAdelanto=[],xThisOrden.ListOrdenNotas=[],xThisOrden.totalAdelanto=0,xThisOrden.totalPendiente=0,xThisOrden.correlativoOrden="",xThisOrden.showNotaAdelanto=!1,xThisOrden.isDisabledFacturar=!1}function xCalcularTotal(){var e=xm_log_get("carta_subtotales");_arrTotal=[];const o=this._arrItems.map(e=>parseFloat(e.ptotal)).reduce((e,t)=>e+t,0);_listValid=0!==parseInt(o),_arrTotal.push({descripcion:"Sub Total",importe:xMoneda(o)}),e.map(e=>{var t;"1"===e.es_impuesto&&(t=parseFloat(e.monto),t="0"===e.activo?parseFloat(o*(t/100)).toFixed(2):"0.00",_arrTotal.push({descripcion:e.descripcion,importe:t}))});e=_arrTotal.map(e=>parseFloat(e.importe)).reduce((e,t)=>e+t,0);_arrTotal.push({descripcion:"Total",importe:xMoneda(e)}),xThisOrden.arrTotales=JSON.parse(JSON.stringify(_arrTotal)),xValidarBtnProcesar()}function xValidarBtnProcesar(){0<_arrTotal.length&&"03"===xThisOrden.codsunat&&_listValid&&parseFloat(_arrTotal[2].importe)<=700?xThisOrden.formValid=!0:xThisOrden.formValid=_listValid&&_formValid}function fact_getAllImpresoras(){$.ajax({type:"POST",url:"../../bdphp/log_002.php",data:{op:"5"}}).done(function(e){var t=[];e=$.parseJSON(e),t.push({idimpresora:-1,descripcion:"MOSTRAR EN PDF"}),e.datos.map(e=>t.push(e)),xThisOrden.listImpresoras=JSON.parse(JSON.stringify(t)),impresoraSelect=t[0]})}function xGuardarOrdenPedido(){xPopupLoad.xopen();var e={header:{nombres:frm_nombres.value,direccion:frm_direccion.value,telefono:frm_telefono.value,fecha_entrega:f_entrega.value,nota:txt_nota.value,total:xThisOrden.arrTotales[xThisOrden.arrTotales.length-1].importe,idorden_pedido:""===form_idorden_pedido.value?0:form_idorden_pedido.value,numero:xThisOrden.correlativoOrden},body:xThisOrden.arrItems,totales:xThisOrden.arrTotales};$.ajax({type:"POST",url:"../../bdphp/log_005.php?op=20",data:{item:JSON.stringify(e)}}).done(e=>{e=JSON.parse(e).datos[0],idOrdenPedido=e.idorden,xThisOrden.correlativoOrden=xCeroIzq(e.correlativo,4),xThisOrden.showNotaAdelanto=!0,setTimeout(()=>{xPopupLoad.xclose()},200)})}function xRegistrarAdelanto(e=!1){var t=parseFloat(txt_importe_adelanto.value);0===(isNaN(t)?0:t)&&!e||(xPopupLoad.xopen(),t={id:idOrdenPedido,idtipo_pago:tipoPagoSelected.idtipo_pago,concepto:e?"":txt_concepto_adelanto.value,importe:txt_importe_adelanto.value},$.ajax({type:"POST",url:"../../bdphp/log_005.php?op=2001",data:t}).done(e=>{xPopupLoad.xclose();e=JSON.parse(e).datos;xThisOrden.totalAdelanto=0,xThisOrden.totalPendiente=0,xThisOrden.ListOrdenAdelanto=e,xThisOrden.ListOrdenAdelanto.map(e=>{xThisOrden.totalAdelanto+=parseFloat(e.importe),e.importe=parseFloat(e.importe).toFixed(2)}),xThisOrden.totalAdelanto=parseFloat(xThisOrden.totalAdelanto).toFixed(2),xThisOrden.totalPendiente=parseFloat(xThisOrden.arrTotales[xThisOrden.arrTotales.length-1].importe)-parseFloat(xThisOrden.totalAdelanto),xThisOrden.totalPendiente=xThisOrden.totalPendiente.toFixed(2),xThisOrden.isDisabledFacturar=parseInt(xThisOrden.totalPendiente)<=0,dialog_adelanto.close()}))}function xRegistrarNota(e=!1){xPopupLoad.xopen();e={id:idOrdenPedido,nota:e?"":txt_nota_nota.value};$.ajax({type:"POST",url:"../../bdphp/log_005.php?op=2002",data:e}).done(e=>{xPopupLoad.xclose();e=JSON.parse(e).datos;xThisOrden.ListOrdenNotas=e,dialog_nota.close()})}function selectTipoPago(e){tipoPagoSelected=e.list_tipo_pago}function goBackLista(){xNuevoOrden(),xThisOrden.fire("goBackOrden")}function loadOrden(e){frm_nombres.value=e.cliente_nom,frm_direccion.value=e.direccion_entrega,frm_telefono.value=e.cliente_telefono,txt_nota.value=e.nota,frm_telefono.value=e.cliente_telefono,f_entrega.value=e.fecha_entrega,form_idorden_pedido.value=e.idorden_pedido,xThisOrden.correlativoOrden=e.numero,idOrdenPedido=e.idorden_pedido,_arrItems=e.detalle_json,xThisOrden.arrItems=_arrItems,xCalcularTotal(),xRegistrarNota(xThisOrden.showNotaAdelanto=!0),xRegistrarAdelanto(!0)}function cocinarImpresionOrdenPedido(){setDataCocinarImprimir();xThisOrden.dataPrintOdenPedido;xImprimirCualquierLista(_dataPrintD,6,"orden_pedido")}function setDataCocinarImprimir(){var e=JSON.parse(JSON.stringify(xThisOrden.arrTotales)),t=(e.push({descripcion:"Adelanto",importe:xThisOrden.totalAdelanto}),e.push({descripcion:"Pendiente",importe:xThisOrden.totalPendiente}),xgetImpresora(-7)),t={lista:xThisOrden.arrItems,impresora:t,subtotales:e,encabezado:{tipo:"ORDEN DE PEDIDO",titulo:"ORDEN DE PEDIDO",correlativo_lista:idOrdenPedido,otro:"PEDIDO",observaciones:"",nombres:frm_nombres.value,direccion:frm_direccion.value,telefono:frm_telefono.value,fecha_entrega:f_entrega.value,nota:txt_nota.value}};xThisOrden.dataPrintOdenPedido=t}function generatePDFOrdenPedido(){setDataCocinarImprimir();var e=xThisOrden.dataPrintOdenPedido,t=10*e.lista.length,o=10*e.subtotales.length,d=new jsPDF({orientation:"p",unit:"pt",format:[213.2,120+(100+t+o)]}),l=(d.setFontSize(9),20),t=xm_log_get("datos_org_sede")[0].sedenombre,o=xm_log_get("datos_org_sede")[0].sedetelefono,a=xm_log_get("datos_org_sede")[0].sededireccion,r=d.internal.pageSize.getWidth(),n=d.getStringUnitWidth(t)*d.internal.getFontSize()/d.internal.scaleFactor;d.text(t,(r-n)/2,l),l+=10,n=d.getStringUnitWidth(t=o)*d.internal.getFontSize()/d.internal.scaleFactor,d.text(t,(r-n)/2,l),l+=10,n=d.getStringUnitWidth(t=a)*d.internal.getFontSize()/d.internal.scaleFactor,d.text(t,(r-n)/2,l),l+=10,t="Fecha: "+(new Date).toLocaleString(),n=d.getStringUnitWidth(t)*d.internal.getFontSize()/d.internal.scaleFactor,d.text(t,(r-n)/2,l),l+=10,d.setLineWidth(.5),d.setDrawColor(0),d.line(10,l,203.2,l),l=l+10+10,d.text(e.encabezado.tipo,10,l),l+=10,d.text("Nombres: "+e.encabezado.nombres,10,l),l+=10,d.text("Dirección: "+e.encabezado.direccion,10,l),l+=10,d.text("Teléfono: "+e.encabezado.telefono,10,l),l+=10,d.text("Fecha de Entrega: "+e.encabezado.fecha_entrega,10,l),l+=10,d.text("Nota: "+e.encabezado.nota,10,l),l=l+10+10,d.text("Productos: ",10,l),l+=10,d.setLineWidth(.5),d.setDrawColor(0),d.line(10,l,203.2,l),l+=10,e.lista.forEach(function(e,t){for(var o=l,a=e.ptotal.toString(),r=d.getStringUnitWidth(a)*d.internal.getFontSize(),a=(d.text(a,203.2-r,o),e.cantidad+" "+e.descripcion),n=d.splitTextToSize(a,150),i=0;i<n.length;i++)d.text(n[i],10,l),l+=10}),l+=10,d.setLineWidth(.5),d.setDrawColor(0),d.line(10,l,203.2,l),l+=10,e.subtotales.forEach(function(e,t){var e=e.descripcion+": "+e.importe,o=d.getStringUnitWidth(e)*d.internal.getFontSize();d.text(e,203.2-o,l),l+=10}),d.save("ticket.pdf")}function xAbrirDialogComprobante(){var e=xThisOrden.arrTotales[xThisOrden.arrTotales.length-1].importe;xThisOrden.$.component_pago.setVal(xMoneda(e)),xValPago.setModoSoloComprobante(),xThisOrden.$.dialog_comprobante.open()}function xMandarCocinarImpresionComprobante_OrdenPedido(){var t=xRpt_pago[0].cliente,o=xRpt_pago[0].comprobante;const a=xCargarDatosAEstructuraImpresion(xThisOrden.arrItems),r=xThisOrden.arrTotales;xPopupLoad.xopen(),$.ajax({type:"POST",url:"../../bdphp/log_001.php",data:{p_from:"f",p_comprobante:o}}).done(function(e){e=xm_all_SetResponseLog_001(e);o.correlativo=xCeroIzqNumComprobante(e.correlativo_comprobante),xCocinarImprimirComprobante(a,r,o,t,"",-2),xThisOrden.$.dialog_comprobante.close(),xPopupLoad.xclose()})}Polymer({is:"x-orden-pedido",properties:{arrItems:[],arrTotales:[],listImpresoras:[],ListOrdenes:[],ListOrdenAdelanto:[],ListOrdenNotas:[],totalAdelanto:0,totalPendiente:0,correlativoOrden:"",showNotaAdelanto:!1,setfechaorden:String,setidorden:Number,isDisabledFacturar:Boolean,dataPrintOdenPedido:Object},attached:function(){this.isDisabledFacturar=!1,(xThisOrden=this).showNotaAdelanto=!1,xIniOrdenPedido(),_cpSocketOpen()},displayIndex:function(e){return xCeroIzq(e+1,1)},newOrden:function(){xNuevoOrden()},setValuesShowOrden:(e,t)=>{_arrItems=[],t&&(f_entrega.value=t+"T00:00"),e&&loadOrden(e)}})</script>