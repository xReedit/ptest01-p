<dom-module id="x-produccion"><link rel="import"href="../../x-componentes/x-comp-find-producto-almacen/x-comp-find-producto-almacen.html"><script src="../../view/httpFech.js"></script><script src="../../view/item_pedido_print_comprobante.js"></script><script rel="prefetch"src="../../view/socket.service.p.js"></script><template is="dom-bind"><paper-dialog modal id="dialog_detalle_produccion"style="min-width:400px"class="dialog_redondo"modal entry-animation="scale-up-animation"exit-animation="fade-out-animation"with-backdrop><div class="d-flexx justify-content-between"><p class="fw-600 fs-18">Detalles de produccion</p><button class="btn btn-sm btn-secondary"dialog-dismiss><span class="pl-1 pr-1 fw-600">x</span></button></div><div><p><span class="fw-600">Fecha: </span>{{ fechaProduccion }}<p><span class="fw-600">Obersvaciones: </span>{{ observacionesProduccion }}</div><hr><div><table width="100%"><thead><th align="left">Producto<th align="center">Cantidad<tbody><template is="dom-repeat"items="{{listItemAddProduccionD}}"as="item"><tr><td align="left">{{ item.descripcion }}<td align="center">{{ item.cantidad }}</template></table></div><br><br></paper-dialog><paper-dialog id="dialog_additem_pro_produccion"class="dialog_redondo"modal entry-animation="scale-up-animation"exit-animation="fade-out-animation"with-backdrop><div class="xContent"><h3>Registrar nuevo producto</h3><br><form id="frm_item_pro"method="post"action="#"><input id="descripcion"name="descripcion"placeholder="Descripcion"class="xMiInput xPasarEnter2"onchange="conMayusculas(this)"required espaciar><br><input id="sel_familia"name="no_post"class="xMiInput xPasarEnter2"placeholder="Familia"onchange="conMayusculas(this)"required autofocus espaciar><br><input id="codigo_barra"name="codigo_barra"placeholder="Codigo de barras"class="xMiInput xPasarEnter2"onchange="conMayusculas(this)"espaciar><br><input id="stock_minimo"name="stock_minimo"placeholder="Stock minimo"class="xMiInput xPasarEnter2"onchange="conMayusculas(this)"espaciar><br><input id="precio"name="precio"placeholder="Precio de compra"onblur="xRetornaMoneda(this)"class="xMiInput xPasarEnter2"onchange="conMayusculas(this)"required espaciar><br><input id="precio_venta"name="precio_venta"placeholder="Precio de venta x unidad"onblur="xRetornaMoneda(this)"class="xMiInput xPasarEnter2 xPrecioAddPro"onchange="conMayusculas(this)"required espaciar><br><div class="xInvisible"><input id="idproducto"name="idproducto"> <input id="idorg"name="idorg"> <input id="idsede"name="idsede"> <input id="idproducto_familia"name="idproducto_familia"> <input id="precio_unitario"name="precio_unitario"></div></form><br><br><div class="xBoton2 xAzul"dialog-confirm onclick="xGuardarItemProCompNuevo()">Listo, guardar</div><div class="xBoton2 xPlomo"dialog-dismiss>Cancelar</div><br><br><br></div></paper-dialog><br><div class="xMiCard xradius"style="width:90%;max-width:1250px"><div class="xEncanezadoCard"style="background:#fff0f5;color:#424242"><div class="div-content-head-op"><p class="fw-600 fs-18">Producción de productos</div></div><div class="p-3 mb-5"><div hidden$="[[ showDetalleProduccion ]]"><div class="d-flexx justify-content-between align-items-center"><p class="fs-15 fw-600">Listado de produccion</p><button class="btn btn-sm btn-info"onclick="goDetalleProduccion()">+ Nuevo</button></div><br><table width="100%"><thead><th>#<th>Fecha<th>Usuario<th>Observaciones<th><tbody><template is="dom-repeat"items="{{listProduccion}}"as="item"><tr data-id="[[index]]"><td data-id="{{index}}"><span>{{ item.idproduccion_producto }}</span><td>{{ item.fecha }}<td>{{ item.usuario }}<td>{{ item.detalle }}<td align="right"><button class="btn btn-sm btn-success"data-id="{{item.idcompra}}"onclick="xloadDetalleProduccion(this)">Ver</button></template></table></div><div hidden$="[[ !showDetalleProduccion ]]"><p class="fw-600 text-secondary">Todos los productos ingresaran al almacen de producción.<table width="100%"><thead><td width="80%">Producto<td>Cantidad<td><tbody><tr><td><x-comp-find-producto-almacen id="compProductoAlmacen"onlynomproducto=""idalmacenfiltro$="[[idAlmacenProduccion]]"></x-comp-find-producto-almacen><td><input type="number"class="xMiInput xPasarEnter2 fs-12"id="text_cantidad_producto"><td><button class="btn btn-sm btn-success"onclick="addProductoList()">+</button></tr><template is="dom-repeat"items="{{listItemAddProduccion}}"as="item"><tr data-id="[[item.idproducto_stock]]"><td>{{ item.descripcion }}<td>{{ item.cantidad }}<td><span class="xDeleteRow ml-2"title="Anular"onclick="removeItemListProd(this)"></span></template></table><br><br><br><div><textarea name=""id="txt_detalle"cols="30"maxlength="150"rows="2"placeholder="Observaciones"></textarea><br><hr><br><div class="d-flexx"><button class="btn btn-info"disabled$="[[isDisabledGuardar]]"onclick="guardarProduccion()">Guardar Produccion</button> <button class="btn btn-success ml-2"hidden$="[[!isGuardadoProduccion]]"onclick="cocinarImpresionProduccion()">Imprimir</button> <button class="btn btn-secondary ml-2"onclick="goDetalleProduccion()">Atras</button></div></div></div></div></div><br><br></template><script>var xThisPageProduccion,_idAlmacenProduccion,compProductoAlmacen,lastIdProduccion,rowItemAdd={},listItemProduccion=[];function xIniPageProduccion(){compProductoAlmacen=document.getElementById("compProductoAlmacen"),xlistaProduccion(),createAlmacenProduccion(),xLoadFamiliasProd(),$("body").addClass("loaded"),$(".xPasarEnter2").on("keyup",function(o){var i=o.which;if(13==i||186==i){var i=$("input"),e=i.index(document.activeElement);if(null!==i[e+1]){var t=i[e+1];if(void 0===t)return;if(null==(t=t.disabled?i[e+2]:t))return;t.focus(),t.select()}return event.stopPropagation(),o.stopPropagation(),o.stopImmediatePropagation(),!1}}),$("#text_cantidad_producto").on("keyup",function(o){o=o.which;13!=o&&186!=o||addProductoList()})}function xloadProductoProduccion(o){o.value.length<3||$.ajax({type:"POST",url:"../../bdphp/log_009.php?op=1"}).done(function(o){o=JSON.parse(o);xThisPageProduccion.dtProItem=o.datos,xCargarProductoItem()})}function createAlmacenProduccion(){$.ajax({type:"POST",url:"../../bdphp/log_009.php?op=1"}).done(function(o){isNaN(parseInt(o))?alert("Primero cree el almacen Produccion"):(_idAlmacenProduccion=o,xThisPageProduccion.idAlmacenProduccion=_idAlmacenProduccion)})}function xCargarFamiliaInput(){var e=$("#sel_familia");e.autocomplete({autoFocus:!0,source:xThisPageProduccion.dtProFam,appendTo:$("#dialog_additem_pro_produccion"),select:function(o,i){return e.val(i.item.label),e.attr("data-id",i.item.value),$("#frm_item_pro #idproducto_familia").val(i.item.value),!1},focus:function(o,i){return!1},change:function(o,i){return null===i.item?(e.attr("data-value",""),e.attr("data-id",""),$("#frm_item_pro #idproducto_familia").val(""),xNewFamilia=!0):(xNewFamilia=!1,$("#frm_item_pro #idproducto_familia").val(i.item.value)),!1}})}function xGuardarItemProCompNuevo(){xvalidateFormInput("frm_item_pro",function(o){!1!==o&&(xPopupLoad.xopen(),xnom_familia=$("#sel_familia").val(),xPrecio_item=xMoneda($("#frm_item_pro #precio").val()),1==xNewFamilia?$.ajax({type:"POST",url:"../../bdphp/log.php?op=1602",data:{f:xnom_familia}}).done(function(o){$("#frm_item_pro #idproducto_familia").val(o),xGuardarItemProDtPPProd(),xLoadFamiliasProd()}):xGuardarItemProDtPPProd())})}function xLoadFamiliasProd(){$.ajax({type:"POST",url:"../../bdphp/log.php?op=1601"}).done(function(o){o=$.parseJSON(o);xThisPageProduccion.dtProFam=o.datos,xCargarFamiliaInput()})}function xGuardarItemProDtPPProd(){xCan_item=rowItemAdd.cantidad;var o=parseFloat(xPrecio_item)/parseFloat(xCan_item);$("#frm_item_pro #idorg").val(xIdOrg),$("#frm_item_pro #idsede").val(xIdSede),$("#frm_item_pro #precio_unitario").val(o),$.post("../../bdphp/ManejoBD_IUD.php?tb=producto",$("#frm_item_pro").serialize(),function(o){xIdProducto_sel=o,$.ajax({type:"POST",url:"../../bdphp/log.php?op=1808",data:{p:xIdProducto_sel,a:xThisPageProduccion.idAlmacenProduccion,c:xCan_item}}).done(function(o){rowItemAdd.idproducto_stock=o,dialog_additem_pro_produccion.close(),xPopupLoad.xclose(),$("#frm_item_pro").reset(),setItemList()})})}function addProductoList(){var o=compProductoAlmacen.getProductoSeletedAlmacen();rowItemAdd.cantidad=text_cantidad_producto.value,(o?(rowItemAdd.descripcion=o.label,rowItemAdd.idproducto_stock=o.value,setItemList):(rowItemAdd.descripcion=des_item_comp.value,$("#frm_item_pro #descripcion").val(rowItemAdd.descripcion),dialog_additem_pro_produccion.open(),xCargarFamiliaInput))()}function setItemList(){(listItemProduccion=xThisPageProduccion.listItemAddProduccion||[]).push(rowItemAdd),setListListProd(),compProductoAlmacen.resetText(),text_cantidad_producto.value="",compProductoAlmacen.focusText()}function removeItemListProd(o){const i=o.parentNode.parentNode.dataId;listItemProduccion=listItemProduccion.filter(o=>o.idproducto_stock!==i),setListListProd()}function setListListProd(){xThisPageProduccion.isDisabledGuardar=0===listItemProduccion.length,xThisPageProduccion.listItemAddProduccion=JSON.parse(JSON.stringify(listItemProduccion))}async function guardarProduccion(){var o;xPopupLoad.xopen(),0!==xThisPageProduccion.listItemAddProduccion.length&&(o={op:2,list:xThisPageProduccion.listItemAddProduccion,detalle:txt_detalle.value},o=await(new httpFecht).postJson("../../bdphp/log_009.php",o),xThisPageProduccion.isDisabledGuardar=!0,lastIdProduccion=o.respuesta,xPopupLoad.xclose(),xThisPageProduccion.isGuardadoProduccion=!0,xlistaProduccion())}function cocinarImpresionProduccion(){var o=xgetImpresora(-6),o={lista:xThisPageProduccion.listItemAddProduccion,impresora:o,subtotales:[],encabezado:{tipo:"PRODUCCION",titulo:"PRODUCCION",correlativo_lista:lastIdProduccion,otro:"ALMACEN PRODUCCION",observaciones:txt_detalle.value}};xImprimirCualquierLista(o)}function xlistaProduccion(){$.ajax({type:"POST",url:"../../bdphp/log_009.php?op=3"}).done(function(o){o=JSON.parse(o);xThisPageProduccion.listProduccion=o.datos})}function xloadDetalleProduccion(o){o=o.parentNode.parentNode;const i=xThisPageProduccion.listProduccion[o.dataId];$.ajax({type:"POST",url:"../../bdphp/log_009.php?op=301",data:{id:i.idproduccion_producto}}).done(function(o){o=JSON.parse(o);xThisPageProduccion.listItemAddProduccionD=o.datos,xThisPageProduccion.observacionesProduccion=i.detalle,xThisPageProduccion.fechaProduccion=i.fecha,dialog_detalle_produccion.open()})}function goDetalleProduccion(){xThisPageProduccion.showDetalleProduccion=!xThisPageProduccion.showDetalleProduccion,xThisPageProduccion.showDetalleProduccion||(xThisPageProduccion.listItemAddProduccion=[],listItemProduccion=[])}Polymer({is:"x-produccion",properties:{idAlmacenProduccion:Number,dtProFam:[],listItemAddProduccion:[],listItemAddProduccionD:[],isDisabledGuardar:Boolean,listProduccion:[],observacionesProduccion:String,fechaProduccion:String,showDetalleProduccion:Boolean,isGuardadoProduccion:Boolean},attached:function(){this.isDisabledGuardar=!0,this.showDetalleProduccion=!1,this.isGuardadoProduccion=!1,xThisPageProduccion=this,xIniPageProduccion(),_cpSocketOpen()},ready:()=>{xLoadFamiliasProd()},displayIndex:function(o){return xCeroIzq(o+1,1)}})</script></dom-module>