<link rel="import" href="../web_components/x-pago/x-pago.html">
<link rel="import" href="../x-componentes/x-comp-find-categoria/x-comp-find-categoria.html">
<link rel="import" href="../web_components/paper-progress/paper-progress.html">
<link rel="import" href="../x-componentes/x-comp-datos-delivery/x-comp-datos-delivery.html">
<dom-module id="x-venta-rapida">
<template>
<br>
<x-comp-datos-delivery id="component_datos_delivery"></x-comp-datos-delivery>
<paper-dialog id="dialog_pagar_vr" class="dialog_redondo" modal entry-animation="scale-up-animation" exit-animation="fade-out-animation">
<div id="div_pago_vr">
<x-pago id="component_pago_vr"></x-pago>
</div>
</paper-dialog>
<paper-dialog id="dialog_erro_print" modal style="min-width:330px" modal entry-animation="scale-up-animation" exit-animation="fade-out-animation">
<h4>Error en impresora</h4>
<p id="print_error"></p>
<br>
<div class="xBoton2 xVerde divLeft23" onclick="xReImprimir()">Intentar Nuevamente</div>
<div class="xBoton2 xPlomo divLeft23"dialog-dismiss onclick="xNuevoPedidoVR()">No imprimir</div>
<br><br><br>
</paper-dialog>
<div class="xMiCard xradius" style="width:95%">
<div class="xEncanezadoCard xFondoRowAmarillo2">
<div style="width:150px">
<x-comp-find-categoria id="compFindCategoria" onchange="_getCategoria(categorias)"></x-comp-find-categoria>
</div>
<div class="xDerecha">
<paper-button onclick="_pantallaCompleta()" class="btn-full-screen">
<iron-icon title="Datos Adicionales" icon$="{{xIconScreen}}">Datos
</iron-icon>
</paper-button>
</div>
</div>
<div class="xEncanezadoCard xFondoRowAmarillo4">
<div class="xizquierda" style="margin-top:-15px">
<paper-input label="MESA" class="xEnLineaTable xtxt_enca" id="txt_mesa" data-val="mesa"style="width:90px"></paper-input>
<paper-input label="REFERENCIA" class="xEnLineaTable xtxt_enca" id="txt_ref" data-val="referencia" style="width:280px"></paper-input>
</div>
<div class="xDerecha" style="margin-top:-25px">
<div class="xBoton2 xAzul xInvisible" id="btn_enviar_cuenta" onclick="xEnviarACuenta()">[F8] Enviar a cuenta</div>
<div class="xBoton2 xVerde xInvisible" id="btn_registrar_pago" onclick="xIrARegistrarPago()">[F10] Registrar pago</div>
</div>
</div>
<div class="xContentCard" style="height:100%">
<div class="xdivEnLinea2x">
<div class="itemsDivx a">
<div class="xtitulo">
<h4>SECCIONES</h4>
</div>
<div class="xMenu_body_vr" id="_xMenu_body_vr"></div>
</div>
<div class="itemsDivx b" id="xVentaRapidaBuscar">
<div class="xMarginLateral10">
<br>
<input type="text" class="xMiInput xfont18" placeholder="Codigo de barras o descripcion" id="txt_bus_item" autofocus>
</div><br>
<div class="xLinea2"></div>
<ul id="accordion" class="list_add_item2">
</ul>
</div>
<div class="itemsDivx c">
<div class="xtitulo">
<a href="#" onclick="xNuevoPedidoVR()" class="xDerecha EnLinea xColorRow_Azul">Nuevo pedido</a>
<h4>PEDIDO</h4>
</div><br>
<div class="xCentradoDiv">
<select class="xMiInput" id="select_ulTPC"></select>
<div id="div_btn_data_delivery" class="EnLinea xInvisible" style="text-align:center">
<paper-button onclick="dialog_datos_delivery.open()">
<iron-icon title="Datos Adicionales" class="btn_apunte_deliver EnLinea" icon="icons:attach-file">Datos
</iron-icon>
Datos Adjuntos
</paper-button>
</div>
</div>
<br>
<div id="xBody">
</div>
<br><br>
<div class="xLinea7"></div>
<div class="xLineaSombra"></div>
<div class="xdiv_Totales">
<br>
<table width="100%" data-TablaName="pedido_subtotales" id="xtb_pedido_subtotales"></table>
<br>
<div style="float:left">
<paper-checkbox style="padding:10px;display:block" class="noselect" id="check_reserva">Reservar</paper-checkbox><br>
</div>
</div>
</div>
</div>
</div>
</div>
</template>
</dom-module>
<style type="text/css">.move a:focus{outline:0}.xdivEnLinea2x{display:flex;flex-direction:row;flex-wrap:nowrap;justify-content:space-between;height:100%}.xdivEnLinea2x>.itemsDivx{width:380px;height:calc(100vh - 260px);border:solid rgba(0,0,0,.25) 1px;overflow-y:auto;-webkit-transition:all .3s ease;-o-transition:all .3s ease;-ms-transition:all .3s ease;-moz-transition:all .3s ease;transition:all .3s ease}.xdivEnLinea2x>.itemsDivx.b{width:50%}.itemsDivx .xtitulo{padding:5px;background:rgba(189,189,189,0.5);border-bottom:1px solid rgba(0,0,0,.25)}ul.list_add_item2 li.divLi{padding:0}.content_li{padding:10px 25px 8px}@media screen and (max-width:920px){.xdivEnLinea2x{display:grid;grid-template-areas:"head main" "foot main";justify-items:stretch;justify-content:center;align-content:stretch;height:75vh;width:100%}.xdivEnLinea2x>.itemsDivx{height:auto}.xdivEnLinea2x>.itemsDivx.a{grid-area:head;width:342px}.xdivEnLinea2x>.itemsDivx.b{grid-area:main;width:385px}.xdivEnLinea2x>.itemsDivx.c{grid-area:foot;width:342px}}.btn-full-screen{float:right;top:-30px;right:-15px;margin:0}.subtotal-tr-row{padding-top:1px;padding-bottom:1px}</style>
<script type="text/javascript" src="../view/item_pedidos.js"></script>
<script type="text/javascript" src="../view/xJsonSunat.js"></script>
<script type="text/javascript" src="../view/xSOAPSunat.js"></script>
<script type="text/javascript" src="../view/cpe_interno.js"></script>
<script type="text/javascript" src="../view/item_pedido_estructura.js"></script>
<script type="text/javascript" src="../view/item_pedido_subtotales.js"></script>
<script type="text/javascript" src="../view/item_pedido_print_comprobante.js"></script>
<script type="text/javascript" src="../view/deNumALetras.js"></script>
<script type="text/javascript" src="../view/manager_storage.js"></script>
<script type="text/javascript" src="../view/cliente.service.js"></script>
<script type="text/javascript" src="../../js/keynavigator-min.js"></script>
<script>/*<![CDATA[*/var xThisVentaRapida,$li,$xlist_li,xedit_detalle_item=false,xArrayRegla=[],xDtPrint=[],xDtSubTotales=[],xenviar_cuenta=false,xregistrar_pago=false,xtxt_select=false,xidCategoriaVR,tt_pedido=0,xIdPedido='',xEstadoPedido,xnum_mesa_valido=false,xNumMesasBd,xarr_header=[],xarr_body=[],xarr_footer=[],xarr_tipo_pago=[],xRpt_pago=[],guardando_vr=false,xdelivery=0,xReservar=0,xsolo_llevar=0,xid_cliente_pago=0,xarr_subtotales=[],arrDatosAdjuntoDelivery=[],xIdCliente_pedido='',xClientePedidoFnac='',isSreenFull=false;function xIniVentaRapida(){xm_log_get('ini_us');$("#Titulo_page").text("Venta Rapida");document.title="Venta Rapida";$('body').addClass('loaded');xPopupLoad=document.getElementById('xLoad');xArrayRegla=xm_log_get('reglas_de_carta');xDtPrint=xm_log_get('sede_generales');xNumMesasBd=parseInt(xDtPrint[0].mesas);xLoadArrayPedido();xTraerDtTipoConsumo();$(document.body).on('change','#select_ulTPC',function(e){$('#div_btn_data_delivery').addClass('xInvisible');xdelivery=0;if($('#select_ulTPC :selected').text().toLowerCase()==="delivery"){$('#div_btn_data_delivery').removeClass('xInvisible');xdelivery=1;}})
compFindCategoria=document.getElementById('compFindCategoria');compFindCategoria.addEventListener('getValorIncial',function(e){let valCategoriaLoalStorage;valCategoriaLoalStorage=e.detail.categorias
if(getLocalStorage('::app3_cat_defualt')){valCategoriaLoalStorage=JSON.parse(getLocalStorage('::app3_cat_defualt'));xidCategoriaVR=valCategoriaLoalStorage.idcategoria;setTimeout(()=>{compFindCategoria.$.compFindListCategoria.value=valCategoriaLoalStorage.index;},500);}else{xidCategoriaVR=e.detail.categorias.idcategoria;}
setLocalSotrage('::app3_cat_defualt',JSON.stringify(valCategoriaLoalStorage));xLoadCartaVR();});document.defaultAction=false;var eventHandler=true?detectEvent:empty;document.body['onkeydown']=eventHandler;$("#txt_mesa").on('keyup',function(){if(tt_pedido==0||this.value==''){$("#btn_enviar_cuenta").addClass('xInvisible');xenviar_cuenta=false}else{$("#btn_enviar_cuenta").removeClass('xInvisible');xenviar_cuenta=true}
var xValtxtMesa=this.value;xnum_mesa_valido=true;if(xValtxtMesa<=0||xValtxtMesa>xNumMesasBd){xnum_mesa_valido=false;}})
$xlist_li=$('#accordion li:visible').keynavigator({useCache:false,cycle:true,activeClass:'xitem_seleccionado_li',onBeforeActive:function($el){$el.toggleClass(this.options.activeClass);return $el.hasClass(this.options.activeClass);}});$(document.body).on('focusout','#accordion li',function(e){var element_input=$(this).find("#xinput_li");if($(element_input).css('display')=='inline-block'){if($(element_input)[0].value==''){$(element_input).css('display','none');}}
xedit_detalle_item=false;})
$(document.body).on('click','.xbtn_li_editar',function(e){const _thisObj=$(this);_thisObj.parent().find('#xinput_li').css('display','inline-block');_thisObj.parent().find('#xinput_li').focus();xedit_detalle_item=true;e.stopPropagation();e.stopPropagation();e.stopImmediatePropagation()});$('#txt_bus_item').keyup(function(e){const _thisObj=$(this);var filter=_thisObj.val();if(e.keyCode==40){$xlist_li.eq(0).focus();$xlist_li.eq(0).addClass('xitem_seleccionado_li');$xlist_li.eq(0).click();}
if(filter==''){$('#accordion li').each(function(){_thisObj.show();})
xIniFocusMoveLi();return;}
var xtext_data='';$(".list_add_item2 li").each(function(){xtext_data=this.textContent+this.dataset.cat;if(xtext_data.search(new RegExp(filter,"i"))<0){$(this).hide();}else{$(this).show();}});xIniFocusMoveLi();if(e.keyCode==13){if($xlist_li.length==1){xBtnSumarRestarKey($xlist_li.find('.xBtn_li2'),1);xVerMipedidoVR();_thisObj.val('');}}});$(document.body).keydown(function(e){if(dialog_datos_delivery.opened)return;if(e.keyCode!=107&&e.keyCode!=109&&e.keyCode!=40&&e.keyCode!=38&&e.keyCode!=117&&e.keyCode!=118&&e.keyCode!=17&&e.keyCode!=77){if(document.activeElement.offsetParent!=null){if(document.activeElement.offsetParent.innerText=='REFERENCIA'||document.activeElement.offsetParent.innerText=='MESA'){return;}}
if(xedit_detalle_item==true){return;}
$("#txt_bus_item").focus();if(xtxt_select==true){$("#txt_bus_item").select();xtxt_select=false;}}})
$(document.body).on('click','#accordion div.xBtn_li2',function(e){const _itemIndex=e.target.parentElement.parentElement.dataset.index;xVerMipedidoVR();});$(document.body).on('keydown',$xlist_li,function(e){if(e.keyCode==38||e.keyCode==40){var container=$('#xVentaRapidaBuscar'),scrollTo=$xlist_li.filter('.xitem_seleccionado_li:last');container.scrollTop(scrollTo.offset().top+(container.scrollTop()-container.offset().top)-100)
e.stopPropagation();e.stopImmediatePropagation()
return false;}
if(e.keyCode==107||e.keyCode==109){xtxt_select=true;var xval_add=e.keyCode==107?1:-1;xBtnSumarRestarKey($(this).find('li.xitem_seleccionado_li .xBtn_li2'),xval_add);xVerMipedidoVR();e.stopPropagation();e.stopImmediatePropagation()}});xCompDatosDelivery=document.getElementById('component_datos_delivery');xCompDatosDelivery.addEventListener('xGetDatosDelivery',function(e){arrDatosAdjuntoDelivery=e.detail.datos;});xValPago=document.getElementById('component_pago_vr');xValPago.setObjConntet($("#dialog_pagar_vr"))
xValPago.addEventListener('xSend',function(e){xRpt_pago=e.detail.xRpts;var p=e.detail.xRpts[0].ok;if(p!==0){if(e.detail.xRpts[0].paseEnterTxt==1){xRegistrarClientePagoVR();}}});xValPago.addEventListener('xCancelarCerrar',function(e){xThisVentaRapida.$.dialog_pagar_vr.close();});xValPago.addEventListener('xListoRegistraPago',function(e){xRegistrarClientePagoVR();});$("#dialog_pagar_vr").on('iron-overlay-opened',function(){component_pago_vr.setFocusTxt();$("#btn_pago").attr('disabled',true);})
document.addEventListener('GeneralUpdateItemsSolo',function(e){xLoadCartaVR();e.stopPropagation();e.stopImmediatePropagation()
e.cancelBubble=true;})}
function _getCategoria(categoria){console.log(categoria);xidCategoriaVR=categoria.idcategoria;setLocalSotrage('::app3_cat_defualt',JSON.stringify(categoria));xLoadCartaVR();}
function empty(){}
function detectEvent(e){var evt=e||window.event;if(dialog_datos_delivery.opened)return;if(evt.ctrlKey&&evt.keyCode==77){txt_mesa.$.input.focus();}
if(evt.keyCode==27){if(dialog_pagar_vr.opened){xThisVentaRapida.$.dialog_pagar_vr.close();$("#txt_bus_item").focus();xedit_detalle_item=false;return;}}
if(evt.keyCode>=116&&evt.keyCode<=123){if(evt.keyCode==119){xEnviarACuenta();return;}
if(evt.keyCode==121){if(!dialog_pagar_vr.opened){if(guardando_vr){return;}
xIrARegistrarPago();evt.stopPropagation();e.stopPropagation();e.stopImmediatePropagation();}}
return document.defaultAction;}}
function xValPagoMostrarContainerPago(){xValPago.setVisibleContainerPago();}
function xIrARegistrarPago(){if(xregistrar_pago==false){return;}
if(guardando_vr){return;}
xValPago.setVisiblePanel1();xedit_detalle_item=true;xEstadoPedido=2;xThisVentaRapida.$.dialog_pagar_vr.open()
$("#component_pago_vr").focus();component_pago_vr.setVal(xMoneda(tt_pedido));}
function xEnviarACuenta(){if(guardando_vr){return;}
guardando_vr=true;if(xenviar_cuenta==true){if(xnum_mesa_valido==false&&xdelivery===0){alert('Numero de mesa no es valido.');return;}
xPopupLoad.titulo="Guardando...";xPopupLoad.xopen();setTimeout(()=>{xEstadoPedido=0;xid_cliente_pago=0;xGuardarPedidoVR(function(){guardando_vr=false;});},500);}}
function xNuevoPedidoVR(){window.localStorage.removeItem("::app3_sys_dta_pe");xPopupLoad.xopen();xLoadArrayPedido();xLoadCartaVR();$("#xtb_pedido_subtotales tr").remove();$("#tb_pedido_detalle").remove();$(".xcheck_print").attr('checked',false);xregistrar_pago=false;xenviar_cuenta=false;xid_cliente_pago=0;$("#btn_registrar_pago").addClass('xInvisible');$("#btn_enviar_cuenta").addClass('xInvisible');$("#txt_mesa").val('');$("#txt_ref").val('');xedit_detalle_item=false;check_reserva.checked=false;$("#txt_bus_item").focus();guardando_vr=false;xValPago.setResetFormaPago();xRpt_pago=[];arrDatosAdjuntoDelivery=[];frm_cliente.reset();xLocal_SubTotal_Quitados='';}
function xIniFocusMoveLi(){$xlist_li=$('#accordion li:visible').keynavigator({cycle:true,activeClass:'xitem_seleccionado_li'});}
function xRegistrarClientePagoVR(){$("#btn_pago").attr('disabled',true);if(guardando_vr===true){return;}
guardando_vr=true;xid_cliente_pago=xRpt_pago[0].idcliente;xPopupLoad.titulo="Guardando...";xPopupLoad.xopen();xGuardarPedidoVR(function(){dialog_pagar_vr.close();});}
function xRegistrarPagoVR(xidclie,xidp){var idtpc=select_ulTPC.value;$.ajax({type:'POST',url:'../../bdphp/log.php?op=509',data:{idclie:xidclie,tt:xMoneda(tt_pedido),idp:xidp,xArrayItems:'',ArrayPago:xRpt_pago[0].xtipo_pagos,idtipo_consumo:idtpc}}).done(function(xidC){xidC=$.parseJSON(xidC);if(!xidC.success){alert(xidC.error);return;}
xPopupLoad.xclose();xThisVentaRapida.$.dialog_pagar_vr.close();});}
async function xGuardarPedidoVR(responde){var xmesa=$("#txt_mesa").val(),xref=$("#txt_ref").val(),xtotal=$(".xPedidoTotal").text(),xCantidad_descontar=0,xItem_descontar='',xsql_descontar='',xNumPedido='',xIdTpc_pe='',xsub_sql_descontar='',p_from='',xIdPedido='',xReservar=0;if(tt_pedido==0){return;}
if(check_reserva.checked==true){xmesa='0';$("#txt_mesa").val(0);xReservar=1;}
xsolo_llevar=0;xdelivery=0;var xcount_seccion=0;$("#xBody .xEncabezadoTpConX").each(function(index,element){$("#btn_enviar_cuenta").addClass('xInvisible');xcount_seccion++;if(index==0){xIdTpc_pe=$(element).attr('data-idtpc');}
const _textElement=$(element).text();if(_textElement.toLowerCase().indexOf('llevar')>-1){xsolo_llevar=1;}
if(_textElement.toLowerCase().indexOf('delivery')>-1){xdelivery=1;xenviar_cuenta=true;$("#btn_enviar_cuenta").removeClass('xInvisible');}})
if(xcount_seccion>1){xsolo_llevar=0;}
var xarr_tipo_pago=xRpt_pago[0]?xRpt_pago[0]['xtipo_pagos']:[];const _idCLienteCompara=xRpt_pago[0]?xRpt_pago[0].idcliente===''?0:xRpt_pago[0].idcliente:0;var DatosCliente=xRpt_pago[0]?xRpt_pago[0].cliente.nombres!=''?xRpt_pago[0].cliente:arrDatosAdjuntoDelivery.length!=0?arrDatosAdjuntoDelivery:[]:[];var ComprobanteSeleccionado=xRpt_pago[0]?xRpt_pago[0].comprobante:[];var xid_cliente_pago=DatosCliente.idcliente===""?await ClienteService_Guardar(DatosCliente):DatosCliente.idcliente;var xidpedido_seleccionados='';DatosCliente.idcliente=xid_cliente_pago;if(_idCLienteCompara!=xid_cliente_pago){xValPago.reloadInputDatalientes();}
xGeneralValidarRegalasCarta(xArrayPedidoObj,true);if(xArmarSubtotalesArray()==0){return}
xVerificarImprimirComanda=false;xVerificarSiSeImprimeComanda(xArrayPedidoObj)
xref=xref===''?DatosCliente.nombres?DatosCliente.nombres:DatosCliente.nombre||'':xref;xarr_cliente={'cliente':DatosCliente,'i':xidpedido_seleccionados};xarr_header={idclie:xid_cliente_pago,referencia:xref,idcategoria:xidCategoriaVR,mesa:xmesa,reservar:xReservar,tipo_consumo:xIdTpc_pe,subtotales_tachados:xLocal_SubTotal_Quitados,arrDatosDelivery:arrDatosAdjuntoDelivery}
xarr_comprobante=ComprobanteSeleccionado;xarr_body=xArrayPedidoObj;xarr_subtotales=xLocal_xDtSubTotales;if(xEstadoPedido===2){xarr_tipo_pago=xRpt_pago[0].xtipo_pagos;p_from='ab';}else{xarr_tipo_pago=[];p_from='a';}
xPopupLoad.xopen();$.ajax({type:'POST',url:'../../bdphp/log_001.php',data:{p_from:p_from,p_cliente:xarr_cliente,p_body:xarr_body,p_header:xarr_header,p_tipo_pago:xarr_tipo_pago,p_subtotales:xarr_subtotales,p_comprobante:xarr_comprobante,estado_p:xEstadoPedido}}).done(function(idP){const _arrRpt=xm_all_SetResponseLog_001(idP);const xrpt_correlativo=_arrRpt.correlativo_comprobante;const xCorrelativo_dia=xCeroIzq(_arrRpt.correlativo_dia,5);const xsub_sql_descontar='';const xIdRegistroPago=_arrRpt.idregistro_pago;xNumPedido=xCeroIzq(_arrRpt.numpedido,5);xIdPedido=_arrRpt.idpedido;xArrayEnca={m:xCeroIzq(xmesa,2),r:xMayusculaPrimera(xSoloMinuscula(xref)),num_pedido:xNumPedido,reservar:0,solo_llevar:xsolo_llevar,delivery:xdelivery,correlativo_dia:xCorrelativo_dia,arrDatosDelivery:arrDatosAdjuntoDelivery};if(p_from==='ab'){xMandarCocinarImpresionComprobante(xrpt_correlativo,xIdRegistroPago);}
if(xVerificarImprimirComanda==true){guardando_vr=true;xLLamarPrintVR()}else{xPopupLoad.xclose();xNuevoPedidoVR();}
responde(true)}).fail(guardando_vr=false);}
function xMandarCocinarImpresionComprobante(correlativo,idregistro_pago){if(xRpt_pago.length>0){var arr_cliente=xRpt_pago[0].cliente;var arr_comprobante=xRpt_pago[0].comprobante;arr_comprobante.correlativo=xReturnCorrelativoComprobante(arr_comprobante);xCocinarImprimirComprobante(xArrayPedidoObj,xarr_subtotales,arr_comprobante,arr_cliente,idregistro_pago,-2);}}
function xLLamarPrintVR(){xCocinarImprimirComanda(xArrayEnca,xArrayPedidoObj,xarr_subtotales,(res)=>{if(res==false){xPopupLoad.xclose();xNuevoPedidoVR();}else{dialog_erro_print.open();}});}
function xReImprimir(){dialog_erro_print.close();xPopupLoad.titulo="Enviando...";xPopupLoad.xopen();xLLamarPrintVR();}
function xLoadCartaVR(){xGeneralLoadItems(xidCategoriaVR,function(){xPopupLoad.xopen();var xCadenaCarta='';var xSeccionArray=new Array();var xidSeccionArray='';var xDetalleItemCarta='';var xCountArray=0;for(var i=0;i<xGeneralDataCarta.length;i++){if(xidSeccionArray!=xGeneralDataCarta[i].idseccion){xidSeccionArray=xGeneralDataCarta[i].idseccion;xDetalleItemCarta='';for(var y=0;y<xGeneralDataCarta.length;y++){if(xidSeccionArray==xGeneralDataCarta[y].idseccion){if(parseInt(xGeneralDataCarta[i].cantidad)>0||xGeneralDataCarta[i].cantidad=='ND'){xDetalleItemCarta=xDetalleItemCarta+xGeneralDataCarta[y].des_item+', ';}}}
xDetalleItemCarta=xDetalleItemCarta.slice(0,-2);xDetalleItemCarta=xMayusculaPrimera(xSoloMinuscula(xDetalleItemCarta));xSeccionArray[xCountArray]={'des':xGeneralDataCarta[i].des_seccion,'id':xGeneralDataCarta[i].idseccion_index,'detalle':xDetalleItemCarta,'procede':xGeneralDataCarta[i].procede};xCountArray++;}}
for(var z=0;z<xSeccionArray.length;z++){xCadenaCarta=String(xCadenaCarta+'<div class="xmenu_item xBordeBold xPading15 xCursor" data-id="'+xSeccionArray[z].id+'" data-procede="'+xSeccionArray[z].procede+'" onclick="xFiltrarItemsCartaDet(this);">'+'<p class="xtitulo_item">'+xSeccionArray[z].des+'</p>'+'</div>')};$("#_xMenu_body_vr div").remove();$("#_xMenu_body_vr").append(xCadenaCarta).trigger('create');xLoadItemsDetalleCartaALL();setTimeout(()=>{xPopupLoad.xclose();},300);})}
function xFiltrarItemsCartaDet(xobj){var filter=xobj.dataset.id;if(filter==''){$('#accordion li').each(function(){$(this).show();})
return;}
$("#accordion li").each(function(a,element){if(filter==element.dataset.idseccionindex){$(element).show();}else{$(element).hide();}})
xIniFocusMoveLi();$xlist_li.eq(0).focus();$xlist_li.eq(0).addClass('xitem_seleccionado_li');$xlist_li.eq(0).click();}
function xLoadItemsDetalleCartaALL(){$("#accordion ul").remove();var xCadenaItems='';var xtachar_li='';var xCantidadMax=0;for(var p=0;p<xGeneralDataCarta.length;p++){xtachar_li='';xCantidadMax=xGeneralDataCarta[p].cantidad;if(parseInt(xCantidadMax)<=0){xtachar_li='xTachar';}
if(xCantidadMax=='ND'){xCantidadMax=1000;}
xGeneralDataCarta[p].stock_actual=xCantidadMax;xGeneralDataCarta[p].idcategoria=xidCategoriaVR;xCadenaItems=String(xCadenaItems+'<li class="noselect divLi" data-isli="1" data-signo="+" data-index="'+p+'" data-idcategoria="'+xidCategoriaVR+'" data-cat="'+xGeneralDataCarta[p].des_seccion+'" data-idcl="'+xGeneralDataCarta[p].idcarta_lista+'" data-idseccion="'+xGeneralDataCarta[p].idseccion+'" data-idseccionindex="'+xGeneralDataCarta[p].idseccion_index+'" data-iditem="'+xGeneralDataCarta[p].iditem+'" data-idcartalista="'+xGeneralDataCarta[p].idcarta_lista+'" data-punitario="'+xGeneralDataCarta[p].precio+'" data-idimpresora="'+xGeneralDataCarta[p].idimpresora+'" data-idprocede="'+xGeneralDataCarta[p].idprocede+'" data-procede="'+xGeneralDataCarta[p].procede+'" data-procedeindex="'+xGeneralDataCarta[p].procede_index+'" data-ventarapida=1 data-imprimircomanda="'+xGeneralDataCarta[p].imprimir_comanda+'" data-iddescontar="'+xGeneralDataCarta[p].idprocede+'" data-cant_descontar="'+xGeneralDataCarta[p].cant_descontar+'" data-idalmacen_items="'+xGeneralDataCarta[p].idalmacen_items+'">'+'<div class="content_li">'+'<div>'+'<div class="xicon3 xeditar xbtn_li_editar" title="editar"></div>'+'<p class="xtitulo_li2 '+xtachar_li+'">'+xGeneralDataCarta[p].des_item+'</p>'+'<p class="xInvisible">'+xGeneralDataCarta[p].codigo_barra+'</p>'+'<input type="text" class="xMiInput xMiTextReferencia" anchofull id="xinput_li">'+'</div>'+'<div class="xBtn_contet_li2">'+'<div class="xBtn_li2 resta">-</div>'+'<span class="xcant_li2" data-cantmax="'+xCantidadMax+'">0</span>'+'<div class="xBtn_li2 suma">+</div>'+'</div>'+'</div>'+'</li>');};$("#accordion").html(xCadenaItems).trigger('create');xIniFocusMoveLi();}
function xVerMipedidoVR(){var xTpConsumo='';var xCadenaItemArray;var xEncabezadoCollapse='';var xCadenaCollapse='';var xArraySeccion=new Array();var xIdColapse='';var xCadenaGrupo='';var xCantItems;var xIndicacionItem='';$("#xBody div").remove();xDtPedido=xArrayPedidoObj;for(var i=0;i<xDtPedido.length;i++){xCadenaItemArray='';xEncabezadoCollapse='';xCadenaCollapse='';xIndicacionItem='';xArraySeccion=new Array();xCantItems=0;if(xDtPedido[i]==null){continue;}
xTpConsumo=xDtPedido[i].des;$.map(xDtPedido[i],function(n,z){if(typeof n=="object"){if(n!=null){xIndicacionItem='';if(n.cantidad=='00'){return;}
if(n.indicaciones!=undefined&&n.indicaciones!=''){xIndicacionItem='<span class="xPedidoItem_indicaciones">('+n.indicaciones+')</span>';}
if(xArraySeccion[n.idseccion_index]==null){xArraySeccion[n.idseccion_index]='<tr><td colspan="2" class="xSinBorde xBold">'+n.des_seccion+'</td></tr>';}
xCadenaItemArray=String('<tr class="xPedidoItem row" data-id="'+n.iditem+'" data-idseccion="'+n.idseccion+'" data-seccion="'+n.des_seccion+'" data-idbus="'+n.idseccion+'" data-idtipocobus="'+n.idtipo_consumo+'" data-idprocede="'+n.idprocede+'" data-procede="'+n.procede+'" data-procedeindex="'+n.procede_index+'" data-ventarapida=1 data-imprimircomanda="'+n.imprimir_comanda+'" data-iddescontar="'+n.idprocede+'" data-cant_descontar="'+n.cant_descontar+'" data-idalmacen_items="'+n.idalmacen_items+'">'+'<td width="90%">'+xCeroIzq(n.cantidad,2)+' | '+n.des+' '+xIndicacionItem+'</td>'+'<td class="xInvisible" data-ColumName="cantidad" id="cant_descontar">'+xCeroIzq(n.cantidad,2)+'</td>'+'<td width="10px" align="right" class="xtb_pedido_importe" data-ColumName="ptotal" id="ptotal">'+n.precio_total+'</td>'+'<td class="xInvisible" id="ptotal_calc">'+n.precio_total_calc+'</td>'+'<td class="xInvisible" data-ColumName="punitario" id="punitario">'+n.precio+'</td>'+'<td class="xInvisible" id="td_cant">'+n.cantidad+'</td>'+'<td class="xInvisible" data-ColumName="iditem">'+n.iditem2+'</td>'+'<td class="xInvisible" data-ColumName="idcarta_lista" id="id_descontar">'+n.iditem+'</td>'+'<td class="xInvisible" data-ColumName="idseccion">'+n.idseccion+'</td>'+'<td class="xInvisible" id="row_idprocede">'+n.idprocede+'</td>'+'<td class="xInvisible" data-ColumName="idcategoria">'+n.idcategoria+'</td>'+'<td class="xInvisible" data-ColumName="idtipo_consumo">'+xDtPedido[i].id+'</td>'+'<td class="xInvisible" data-ColumName="descripcion">'+n.des+' '+n.indicaciones+'</td>'+'<td class="xInvisible" data-ColumName="procede">'+n.procede_index+'</td>'+'<td class="xInvisible" id="row_tb_procede">'+n.procede+'</td>'+'<td class="xInvisible" data-ColumName="idpedido">?p</td>'+'</tr>');xArraySeccion[n.idseccion_index]=xArraySeccion[n.idseccion_index]+xCadenaItemArray;xHayPedido=1;xCantItems=parseInt(xCantItems)+parseInt(n.cantidad);}}});if(xCadenaItemArray!=''){xEncabezadoCollapse='<tr><td colspan="2" class="xFondoRowPlomo noselect xBold xMargin5 xEncabezadoTpConX" data-idtpc="'+xDtPedido[i].id+'">'+xDtPedido[i].des+'</td></tr>';for(a in xArraySeccion){xCadenaCollapse=String(xCadenaCollapse+xArraySeccion[a]);};xCadenaGrupo=String(xCadenaGrupo+xEncabezadoCollapse+xCadenaCollapse);}};xCadenaGrupo=String('<table width="100%" class="xtb_pedido" data-TablaName="pedido_detalle" id="tb_pedido_detalle">'+xCadenaGrupo+'</table></div></div>');$("#xBody").html(xCadenaGrupo).trigger('create');xValidarReglaCarta();}
function xValidarReglaCarta(){xGeneralValidarRegalasCarta($('.xtb_pedido'),false);xSumarTotal();}
function xSumarTotal(){xGeneralValidarRegalasCarta(xArrayPedidoObj,true);tt_pedido=xArmarSubtotalesArray();var htmlSubtotales='';var _fontSize,_fontSizeTitulo,titulo,_style='',_id='',_colorImporte='',xBtnQuitar='',classTachado='',textBnQuitar='(-)',importeRow;xLocal_xDtSubTotales.forEach((element,index)=>{classTachado=element.tachado?'xTachar':'';textBnQuitar=element.tachado?'Add':'Quitar';importeRow=element.tachado?element.importe_tachado:element.importe;xBtnQuitar=element.quitar?'<span data-tachado="'+element.tachado+'" class="xCursor xBold xColorRow_Azul xfont11" title="no cobrar" onclick="quitarSubTotal(this, '+index+')"> '+textBnQuitar+' </span>':'';if(element.descripcion.toUpperCase()==="TOTAL"){_id='tt_importe_pagar_t';_fontSizeTitulo='';_fontSize='xfont24 xBold';titulo='IMPORTE A PAGAR';xtt_pedidos_det=parseFloat(element.importe);}else{_colorImporte='xColorRow_Plomo';_fontSize='xfont15';_fontSizeTitulo=='xfont15';titulo=element.descripcion.toUpperCase();_style='subtotal-tr-row';}
htmlSubtotales=htmlSubtotales+'<tr class="total '+classTachado+'">'+'<td colspan="3" class="'+_style+'"><p class="'+_fontSizeTitulo+' xColorRow_Plomo">'+titulo+' '+xBtnQuitar+'</p></td>'+'<td align="right" class="'+_style+'"><p class="'+_fontSize+' '+_colorImporte+'" id="'+_id+'">'+importeRow+'</p></td>'+'</tr>';});$("#xtb_pedido_subtotales").html(htmlSubtotales).trigger('create');if(tt_pedido==0){$("#btn_registrar_pago").addClass('xInvisible');xregistrar_pago=false;$("#btn_enviar_cuenta").addClass('xInvisible');xenviar_cuenta=false;}else{$("#btn_registrar_pago").removeClass('xInvisible');xregistrar_pago=true;if($("#txt_mesa").val()!=''||xdelivery===1){$("#btn_enviar_cuenta").removeClass('xInvisible');xenviar_cuenta=true}}}
function quitarSubTotal(obj,index){const tachado=$(obj).attr('data-tachado');const idQuitar=xLocal_xDtSubTotales[index].id;if(tachado==="true"){xLocal_SubTotal_Quitados=xLocal_SubTotal_Quitados.replace(idQuitar+",",'');}else{if(xLocal_SubTotal_Quitados.indexOf(idQuitar)>=0){return;}
xLocal_SubTotal_Quitados+=idQuitar+',';}
xSumarTotal();}
function xTraerDtTipoConsumo(){var xCadenaSelectUlTPC='',xDtTpC=xm_log_get('estructura_pedido');for(var i=0;i<xDtTpC.length;i++){xCadenaSelectUlTPC=String(xCadenaSelectUlTPC+'<option value="'+xDtTpC[i].idtipo_consumo+'">'+xDtTpC[i].descripcion+'</option>');};$("#select_ulTPC").html(xCadenaSelectUlTPC).trigger('create');}
function _pantallaCompleta(){xThisVentaRapida.xIconScreen=isSreenFull?'icons:fullscreen-exit':'icons:fullscreen';isSreenFull=!isSreenFull;pantallaCompleta();}
Polymer({is:'x-venta-rapida',properties:{xt_org:Number,xt_idsede:Number,xt_idus:Number,xdt_items:Object,hidden_container_registro_pago:boolean=false,valid_form_cliente_pago:boolean=false,valid_monto_pago:boolean=false,xIconScreen:String,},attached:function(){this.selected_us=0;this.xIconScreen='icons:fullscreen';xThisVentaRapida=this;xIniVentaRapida();},detached:function(){document.defaultAction=false;document['onkeydown']=empty;clearInterval(xGeneralRelojUpdateItemsSolo);}})/*]]>*/</script>