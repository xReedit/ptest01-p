var xImpresoraPrint,_numIntCorrelativoBD;async function xCocinarImprimirComprobante(r,o,a,e,i,t,p=!0){e.nombres=4<e.nombres.length?e.nombres:"";let n={};var s,m;return!a||"0"===a.idtipo_comprobante?(n.imprime=!1,n):(p&&!xgetComprobanteImpresora(t)&&(n.imprime=!1),0==r.length?(n.imprime=!1,n.ok=!1,n.msj="Los datos del comprobante no son correctos.",n):(t=xm_log_get("datos_org_sede"),s=(o=darFormatoSubTotalesParaFacturacion(o,!1)).length-1,m=parseFloat(o[s].importe),o[s].importe_letras=numeroALetras(m),p&&(a.pie_pagina_comprobante=xImpresoraPrint[0].pie_pagina_comprobante),"0"!==a.codsunat&&xm_all_xToastOpen("Conectando con Sunat..."),s="object"==typeof i,_numIntCorrelativoBD=parseInt(a.correlativo),m=isNaN(_numIntCorrelativoBD),a.correlativo&&""!==a.correlativo&&!s&&"#"!==a.correlativo&&!m&&0!=_numIntCorrelativoBD||(s=await xGetCorrelativoComprobante(a),a.correlativo=s,_numIntCorrelativoBD=s),r=isComprobanteConsumo(a,o,r),(n=await xJsonSunatCocinarDatos(r,o,a,e,i)).ok?(t[0].hash=n.hash,t[0].external_id=n.external_id,a.correlativo=n.correlativo_comprobante||a.correlativo,a.facturacion_correlativo_api=n.facturacion_correlativo_api||a.facturacion_correlativo_api,!p||(m=parseInt(localStorage.getItem("::app3_sys_print_cpe")),0===(m=isNaN(m)?1:m))?t:void xImprimirComprobanteAhora(t,r,o,a,e,function(r){return 0!=r})):(alert(n.msj_error+". Mande a imprimir el comprobante desde Registro de pagos"),xPopupLoad.close,n)))}function xImprimirComprobanteAhora(r,o,a,e,i,t){var p,o=xEstructuraItemsJsonComprobante(o,a,!0),o=xEstructuraItemsAgruparPrintJsonComprobante(o),n=parseInt(xm_log_get("datos_org_sede")[0].sys_local);r[0].nom_us=xm_log_get("app3_us").nomus,comprobarNumCorrelativoComprobante(e);try{xarr_tipo_pago&&(p=[],xarr_tipo_pago.map(r=>{var o=parseFloat(r.importe_recibido)-parseFloat(r.importe),a=o<0?r.importe:r.importe_recibido,r={id:r.id||"1",des_tp:r.des_tp||"Efectivo",importe:r.importe,importe_recibido:a,importe_vuelto:o<0?0:o};p.push(r)}))}catch(r){}var s={Array_enca:r,Array_print:xImpresoraPrint,ArrayItem:o,ArraySubTotales:a,ArrayComprobante:e,ArrayCliente:i,ArrayTipoPago:p};1===n?(xPopupLoad.xopen(),xSendDataPrintServer(s,2,"comprobante"),setTimeout(()=>{xPopupLoad.xclose(),t(!1)},1e3)):$.ajax({type:"POST",url:"../../print/print5.php",data:{Array_enca:r,Array_print:xImpresoraPrint,ArrayItem:o,ArraySubTotales:a,ArrayComprobante:e,ArrayCliente:i}}).done(function(r){return-1!=r.indexOf("Error")?(xPopupLoad.xclose(),$("#print_error").text(r),xErrorPrint=!0,dialog_erro_print.open()):(xErrorPrint=!1,xPopupLoad.titulo="Imprimiendo...",xPopupLoad.xopen(),setTimeout(function(){xPopupLoad.xclose()},3e3)),t(xErrorPrint)})}function xImprimirComprobanteAhoraPrintPreSelect(r,o,a,e,i,t,p){xPopupLoad.titulo="Imprimiendo...";var n=parseInt(xm_log_get("datos_org_sede")[0].sys_local),s=(r[0].nom_us=xm_log_get("app3_us").nomus,comprobarNumCorrelativoComprobante(e),{Array_enca:r,Array_print:t,ArrayItem:o,ArraySubTotales:a,ArrayComprobante:e,ArrayCliente:i});1===n?(xPopupLoad.xopen(),xSendDataPrintServer(s,2,"comprobante"),setTimeout(()=>{xPopupLoad.xclose(),p(!1)},1e3)):$.ajax({type:"POST",url:"../../print/print5.php",data:{Array_enca:r,Array_print:t,ArrayItem:o,ArraySubTotales:a,ArrayComprobante:e,ArrayCliente:i}}).done(function(r){return-1!=r.indexOf("Error")?(xPopupLoad.xclose(),$("#print_error").text(r),xErrorPrint=!0,dialog_erro_print.open()):(xErrorPrint=!1,xPopupLoad.titulo="Imprimiendo...",xPopupLoad.xopen(),setTimeout(function(){xPopupLoad.xclose()},3e3)),p(xErrorPrint)})}function xgetComprobanteImpresora(r){for(var o=xm_log_get("app3_woIpPrint"),a=xm_log_get("app3_woIpPrintO"),e=window.localStorage.getItem("::app3_woIpPrintLo"),i=((xImpresoraPrint=xm_log_get("sede_generales"))[0].num_copias,r),t=!1,p=0;p<a.length;p++)if(a[p].idtipo_otro==r){i=a[p].idimpresora;break}if(null!=e&&""!=e)e=$.parseJSON(e),xImpresoraPrint[0].ip_print=e.ip,xImpresoraPrint[0].var_margen_iz=e.var_margen_iz,xImpresoraPrint[0].var_size_font=e.var_size_font,xImpresoraPrint[0].local=1,xImpresoraPrint[0].num_copias=e.num_copias,xImpresoraPrint[0].copia_local=e.copia_local,xImpresoraPrint[0].img64=e.img64,xImpresoraPrint[0].papel_size=e.papel_size,t=!0;else for(p=0;p<o.length;p++)if(o[p].idimpresora==i){t=!0,i=o[p].ip,xImpresoraPrint[0].ip_print=i,xImpresoraPrint[0].var_margen_iz=o[p].var_margen_iz,xImpresoraPrint[0].var_size_font=o[p].var_size_font,xImpresoraPrint[0].local=0,xImpresoraPrint[0].num_copias=o[p].num_copias,xImpresoraPrint[0].copia_local=0,xImpresoraPrint[0].img64=o[p].img64,xImpresoraPrint[0].papel_size=o[p].papel_size;break}return t}function xgetImpresora(r){for(var o=xm_log_get("app3_woIpPrint"),a=xm_log_get("app3_woIpPrintO"),e=window.localStorage.getItem("::app3_woIpPrintLo"),i=((xImpresoraPrint=xm_log_get("sede_generales"))[0].num_copias,xImpresoraPrint[0].papel_size,r),t=!1,p=0;p<a.length;p++)if(a[p].idtipo_otro==r){i=a[p].idimpresora;break}if(null!=e&&""!=e)e=$.parseJSON(e),xImpresoraPrint[0].ip_print=e.ip,xImpresoraPrint[0].var_margen_iz=e.var_margen_iz,xImpresoraPrint[0].var_size_font=e.var_size_font,xImpresoraPrint[0].local=1,xImpresoraPrint[0].num_copias=e.num_copias,xImpresoraPrint[0].copia_local=e.copia_local,xImpresoraPrint[0].img64=e.img64,xImpresoraPrint[0].papel_size=e.papel_size,t=!0;else for(p=0;p<o.length;p++)if(o[p].idimpresora==i){t=!0,i=o[p].ip,xImpresoraPrint[0].ip_print=i,xImpresoraPrint[0].var_margen_iz=o[p].var_margen_iz,xImpresoraPrint[0].var_size_font=o[p].var_size_font,xImpresoraPrint[0].local=0,xImpresoraPrint[0].num_copias=o[p].num_copias,xImpresoraPrint[0].copia_local=0,xImpresoraPrint[0].img64=o[p].img64,xImpresoraPrint[0].papel_size=o[p].papel_size;break}return t?xImpresoraPrint:null}function xgetImpresoraById(o){var r=xm_log_get("app3_woIpPrint"),a=(xm_log_get("app3_woIpPrintO"),window.localStorage.getItem("::app3_woIpPrintLo")),e=((xImpresoraPrint=xm_log_get("sede_generales"))[0].num_copias,xImpresoraPrint[0].papel_size,xImpresoraPrint[0].var_size_font_tall_comanda),i=!1,r=(null!=a&&""!=a?(a=$.parseJSON(a),xImpresoraPrint[0].ip_print=a.ip,xImpresoraPrint[0].var_margen_iz=a.var_margen_iz,xImpresoraPrint[0].var_size_font=a.var_size_font,xImpresoraPrint[0].local=1,xImpresoraPrint[0].num_copias=a.num_copias,xImpresoraPrint[0].copia_local=a.copia_local,xImpresoraPrint[0].img64=a.img64,xImpresoraPrint[0].papel_size=a.papel_size,i=!0):(a=r.filter(r=>parseInt(r.idimpresora)==o)[0])&&(i=!0,xImpresoraPrint[0].ip_print=a.ip,xImpresoraPrint[0].var_margen_iz=a.var_margen_iz,xImpresoraPrint[0].var_size_font=a.var_size_font,xImpresoraPrint[0].local=0,xImpresoraPrint[0].num_copias=a.num_copias,xImpresoraPrint[0].var_size_font_tall_comanda=e,xImpresoraPrint[0].copia_local=0,xImpresoraPrint[0].img64="",xImpresoraPrint[0].papel_size=a.papel_size),i?xImpresoraPrint:null);return r}function xCocinarImprimirComanda(e,i,t,p){if(0!==i.length){var n=xm_log_get("app3_woIpPrint"),o=(xm_log_get("app3_woIpPrintO"),window.localStorage.getItem("::app3_woIpPrintLo")),s=xm_log_get("sede_generales"),m=0,a=0;s[0].num_copias;const l=s[0].var_size_font_tall_comanda,d="1"===s[0].isprint_all_delivery.toString();e.is_print_subtotales=s[0].isprint_subtotales_comanda,e.isprint_copy_short=s[0].isprint_copy_short,e.isprint_all_short=s[0].isprint_all_short,i=i.filter(r=>r),null!=o&&""!=o&&(o=$.parseJSON(o),xArmarSubtotalesArray(i,s),s[0].ip_print=o.ip,s[0].var_margen_iz=o.var_margen_iz,s[0].var_size_font=o.var_size_font,s[0].local=1,s[0].num_copias=o.num_copias,s[0].copia_local=o.copia_local,s[0].img64=o.img64,s[0].papel_size=o.papel_size,"0"===o.img64&&(s[0].logo64=""),0==parseInt(o.num_copias)&&0==parseInt(o.copia_local)||xImprimirComandaAhora(e,s,i,t,r=>{p(r)}));let r=xm_log_get("estructura_pedido");0<(r=r.filter(r=>"0"!==r.idimpresora)).length&&r.map(r=>{var o=r.idtipo_consumo;xIdPrint=r.idimpresora,xArrayBodyPrint=[];for(var a=0;a<i.length;a++)null!=i[a]&&parseInt(o)==parseInt(i[a].id)&&$.map(i[a],function(r,o){"object"==typeof r&&(void 0===xArrayBodyPrint[a]&&(xArrayBodyPrint[a]={des:i[a].des,id:i[a].id,titlo:i[a].titulo}),xArrayBodyPrint[a][r.iditem]=r,i[a].flag_add_tpc=!0)});0!=xArrayBodyPrint.length&&(m++,xArmarSubtotalesArray(xArrayBodyPrint,s),r=n.filter(r=>parseInt(r.idimpresora)==xIdPrint)[0],s[0].ip_print=r.ip,s[0].var_margen_iz=r.var_margen_iz,s[0].var_size_font=r.var_size_font,s[0].local=0,s[0].num_copias=r.num_copias,s[0].var_size_font_tall_comanda=l,s[0].copia_local=0,s[0].img64=r.img64,s[0].papel_size=r.papel_size,"0"===r.img64&&(s[0].logo64=""),xImprimirComandaAhora(e,s,xArrayBodyPrint,t,function(r){p(r)}))});for(var _=0;_<n.length;_++){xIdPrint=n[_].idimpresora,xArrayBodyPrint=[],a++;for(var c=0;c<i.length;c++)null!=i[c]&&$.map(i[c],function(r,o){var a="delivery"===i[c].des.toLowerCase();"object"!=typeof r||i[c].flag_add_tpc||"0"!==r.imprimir_comanda&&(xIdPrint==r.idimpresora&&(void 0===xArrayBodyPrint[c]&&(xArrayBodyPrint[c]={des:i[c].des,id:i[c].id,titlo:i[c].titulo}),a&&d?Object.values(i[c]).filter(r=>"object"==typeof r).map(r=>xArrayBodyPrint[c][r.iditem]=r):xArrayBodyPrint[c][r.iditem]=r),xIdPrint.toString()==r.idimpresora_otro.toString())&&(void 0===xArrayBodyPrint[c]&&(xArrayBodyPrint[c]={des:i[c].des,id:i[c].id,titlo:i[c].titulo}),a&&d?Object.values(i[c]).filter(r=>"object"==typeof r).map(r=>xArrayBodyPrint[c][r.iditem]=r):xArrayBodyPrint[c][r.iditem]=r)});0!=xArrayBodyPrint.length&&(m++,xArmarSubtotalesArray(xArrayBodyPrint,s),s[0].ip_print=n[_].ip,s[0].var_margen_iz=n[_].var_margen_iz,s[0].var_size_font=n[_].var_size_font,s[0].local=0,s[0].num_copias=n[_].num_copias,s[0].var_size_font_tall_comanda=l,s[0].copia_local=0,s[0].img64=n[_].img64,s[0].papel_size=n[_].papel_size,"0"===n[_].img64&&(s[0].logo64=""),xImprimirComandaAhora(e,s,xArrayBodyPrint,t,function(r){n.length==a&&0==r?p&&p(!1):p&&p(!0)}))}0===m&&p&&p(!1)}}function xImprimirComandaAhora(r,o,a,e,i){xPopupLoad.titulo="Imprimiendo...";var t=parseInt(xm_log_get("datos_org_sede")[0].sys_local),p=(r.nom_us=xm_log_get("app3_us").nomus,{Array_enca:r,Array_print:o,ArrayItem:a.filter(r=>!0),ArraySubTotales:e});1===t?(xSendDataPrintServer(p,1,"comanda"),setTimeout(()=>{i(!1)},300)):$.ajax({type:"POST",url:"../../print/print3.php",data:{Array_enca:r,Array_print:o,ArrayItem:a,ArraySubTotales:e},success:function(r){-1!=r.indexOf("Error")?(xPopupLoad.xclose(),$("#print_error").text(r),xErrorPrint=!0):(xErrorPrint=!1,xPopupLoad.titulo="Imprimiendo...",xPopupLoad.xopen(),setTimeout(function(){xPopupLoad.xclose()},3e3)),i(xErrorPrint)},error:function(r,o,a){xPopupLoad.xclose(),$("#print_error").text("Error, Verifique que la ticketera este prendida y que tenga papel."),xErrorPrint=!0,i(xErrorPrint)}})}function xImprimirCualquierLista(r,o=5,a="listado"){xPopupLoad.titulo="Imprimiendo...",xPopupLoad.xopen(),r.encabezado.nom_us=xm_log_get("app3_us").nomus,xSendDataPrintServer({Array_enca:r.encabezado||"",Array_print:r.impresora,ArrayItem:r.lista,ArraySubTotales:r.subtotales||""},o,a),setTimeout(()=>{xPopupLoad.xclose()},300)}function xSendDataPrintServer(o,a,e){switch(a){case 3:break;case 4:if(""===o.Array_enca[0].ip_print)return;break;default:try{if(""===o.Array_print[0].ip_print)return;o.Array_print[0].logo64="",o.Array_print[0].logo=""}catch(r){}}o=JSON.stringify(o),e="pre cuenta"===e?"comanda":e,$.ajax({url:"../../bdphp/log_003.php?op=1",type:"POST",data:{datos:o,idprint_server_estructura:a,tipo:e}}).done(r=>{_cpSocketEmitPrinterOnly({detalle_json:o,idprint_server_estructura:a,tipo:e,descripcion_doc:e,nom_documento:e,idprint_server_detalle:r})}).fail(function(r){alert("error",r)})}function xReturnCorrelativoComprobante(r){let o;var a;return"0"===r.codsunat?(o=parseInt(r.correlativo)+1,o=xCeroIzq(o,7),$.ajax({type:"POST",url:"../../bdphp/log_002.php",data:{op:"103",i:r.idtipo_comprobante_serie}})):(a=0!==parseInt(r.facturacion_correlativo_api),o=a?"#":parseInt(r.correlativo)+1,a||(r.facturacion_correlativo_api=1)),o}function xUpdatePrintPrecuentaPedido(r){$.ajax({url:"../../bdphp/log_003.php?op=6",type:"POST",data:{id:r}})}async function xGetCorrelativoComprobante(r){r=await $.ajax({type:"POST",url:"../../bdphp/log_002.php",data:{op:"103001",i:r.idtipo_comprobante_serie,obj:r}}),r=JSON.parse(r);return r.success?r.datos[0].num:"#"}function comprobarNumCorrelativoComprobante(r){parseInt(r.correlativo);isNaN(_numIntCorrelativoBD)&&(r.correlativo=_numIntCorrelativoBD)}function getImpresoraByTpc(o){var r=xm_log_get("estructura_pedido"),a=xm_log_get("app3_woIpPrint");let e=null;const i=r.filter(r=>parseInt(r.idtipo_consumo)==o)[0];return(e=i&&"0"!==i.idimpresora?a.filter(r=>parseInt(r.idimpresora)==i.idimpresora)[0]:e)||!1}function getImpresoraByIdImpresoraSeccion(o){var r=xm_log_get("app3_woIpPrint").filter(r=>parseInt(r.idimpresora)==parseInt(o))[0];return r||!1}function cocinarImpresionAnulacionOne(r,o,a,e){let i;var t,p;(i=(i=getImpresoraByTpc(r.idtipoconsumo))||getImpresoraByIdImpresoraSeccion(r.idimpresora_seccion))&&(t=[],p=r.des_tp.toUpperCase(),r=r.descripcion.toUpperCase(),e="0"===e.nummesa?"PEDIDO "+e.numpedido:"MESA "+e.nummesa,a=`Caja: ${a} - Supervisor: `+o,t.push({descripcion:r.toUpperCase(),cantidad:"01"}),i.ip_print=i.ip,xImprimirCualquierLista({lista:t,impresora:[i],subtotales:[],encabezado:{titulo:"ANULACION",tipo_consumo:p,mesa:e,correlativo_lista:0,usuario:a,motivo:""}}))}function cocinarImpresionAnulacionList(r,o,a,e,i){let t=[];if(r.map(o=>{var r,a,e=getImpresoraByTpc(o.idtipoconsumo);e&&(e.ip_print=e.ip,(r=t.filter(r=>r.idtipoconsumo===o.idtipoconsumo)[0])?(a={descripcion:o.descripcion,cantidad:xCeroIzq(o.cant_item,2)},r.items.push(a)):(r=[],a={descripcion:o.descripcion,cantidad:xCeroIzq(o.cant_item,2)},r.push(a),t.push({idtipoconsumo:o.idtipoconsumo,idseccion:o.idseccion,des_tpc:o.des_tp,printer:e,items:r})),o.chekPrint=!0)}),r.map(o=>{if(o.chekPrint)return!1;var r,a,e=getImpresoraByIdImpresoraSeccion(o.idimpresora_seccion);e&&(e.ip_print=e.ip,(r=t.filter(r=>r.idtipoconsumo===o.idtipoconsumo)[0])?(a={descripcion:o.descripcion,cantidad:xCeroIzq(o.cant_item,2)},r.items.push(a)):(r=[],a={descripcion:o.descripcion,cantidad:xCeroIzq(o.cant_item,2)},r.push(a),t.push({idtipoconsumo:o.idtipoconsumo,idseccion:o.idseccion,des_tpc:o.des_tp,printer:e,items:r})))}),0===t.length)return!1;const p="0"===e.nummesa?"PEDIDO "+e.numpedido:"MESA "+e.nummesa,n=`Caja: ${a} - Supervisor: `+o;t.map(r=>{xImprimirCualquierLista({lista:r.items,impresora:[r.printer],subtotales:[],encabezado:{titulo:"ANULACION",tipo_consumo:r.des_tpc,mesa:p,correlativo_lista:0,usuario:n,motivo:i.toUpperCase()}})})}function isComprobanteConsumo(r,o,a){if(2==r?.modo.id){({...a});try{var e,i=Date.now().toString().slice(-6),t=xm_log_get("estructura_pedido")[0].idtipo_consumo,p=o.filter(r=>"total"===r.descripcion.toLowerCase())[0].importe,n=""===r.modo.modo_title.trim()?"POR CONSUMO":r.modo.modo_title;if(0===(e=xCargarDatosAEstructuraImpresion([{id:i,iditem:i,idtipo_consumo:t,des_seccion:"ITEMS",cantidad:1,descripcion:n,punitario:p,precio:p,ptotal:p,precio_total_calc:p}],o,!1)).length)return a;a=e}catch(r){}}return a}async function reimpresionDocumento(r){xPopupLoad.xopen();r=await(new httpFecht).axiosExecute({type:"GET",url:"../../bdphp/api.php?route=get-comprobante/"+r},!0,!1);!1===r.success?(alert("Error al obtener el comprobante"),xPopupLoad.xclose()):(r.Array_enca.nom_us=xm_log_get("app3_us").nomus,r.Array_enca=[r.Array_enca],xgetComprobanteImpresora(-2),delete xImpresoraPrint[0].pie_pagina,r.Array_print=xImpresoraPrint,1===parseInt(xm_log_get("datos_org_sede")[0].sys_local)&&(xSendDataPrintServer(r,2,"comprobante"),setTimeout(()=>{xPopupLoad.xclose()},1e3)))}