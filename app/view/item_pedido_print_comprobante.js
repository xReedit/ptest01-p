var xImpresoraPrint,_numIntCorrelativoBD;async function xCocinarImprimirComprobante(r,o,e,a,i,t,p=!0){a.nombres=4<a.nombres.length?a.nombres:"";let n={};var s,m;return!e||"0"===e.idtipo_comprobante?(n.imprime=!1,n):(p&&!xgetComprobanteImpresora(t)&&(n.imprime=!1),0==r.length?(n.imprime=!1,n.ok=!1,n.msj="Los datos del comprobante no son correctos.",n):(t=xm_log_get("datos_org_sede"),s=(o=darFormatoSubTotalesParaFacturacion(o,!1)).length-1,m=parseFloat(o[s].importe),o[s].importe_letras=numeroALetras(m),p&&(e.pie_pagina_comprobante=xImpresoraPrint[0].pie_pagina_comprobante),"0"!==e.codsunat&&xm_all_xToastOpen("Conectando con Sunat..."),s="object"==typeof i,_numIntCorrelativoBD=parseInt(e.correlativo),m=isNaN(_numIntCorrelativoBD),e.correlativo&&""!==e.correlativo&&!s&&"#"!==e.correlativo&&!m&&0!=_numIntCorrelativoBD||(s=await xGetCorrelativoComprobante(e),e.correlativo=s,_numIntCorrelativoBD=s),r=isComprobanteConsumo(e,o,r),(n=await xJsonSunatCocinarDatos(r,o,e,a,i)).ok?(t[0].hash=n.hash,t[0].external_id=n.external_id,e.correlativo=n.correlativo_comprobante||e.correlativo,e.facturacion_correlativo_api=n.facturacion_correlativo_api||e.facturacion_correlativo_api,!p||(m=parseInt(localStorage.getItem("::app3_sys_print_cpe")),0===(m=isNaN(m)?1:m))?t:void xImprimirComprobanteAhora(t,r,o,e,a,function(r){return 0!=r})):(alert(n.msj_error+". Mande a imprimir el comprobante desde Registro de pagos"),xPopupLoad.close,n)))}function xImprimirComprobanteAhora(r,o,e,a,i,t){var p,o=xEstructuraItemsJsonComprobante(o,e,!0),o=xEstructuraItemsAgruparPrintJsonComprobante(o),n=parseInt(xm_log_get("datos_org_sede")[0].sys_local);r[0].nom_us=xm_log_get("app3_us").nomus,comprobarNumCorrelativoComprobante(a);try{xarr_tipo_pago&&(p=[],xarr_tipo_pago.map(r=>{var o=parseFloat(r.importe_recibido)-parseFloat(r.importe),e=o<0?r.importe:r.importe_recibido,r={id:r.id||"1",des_tp:r.des_tp||"Efectivo",importe:r.importe,importe_recibido:e,importe_vuelto:o<0?0:o};p.push(r)}))}catch(r){}var s={Array_enca:r,Array_print:xImpresoraPrint,ArrayItem:o,ArraySubTotales:e,ArrayComprobante:a,ArrayCliente:i,ArrayTipoPago:p};1===n?(xPopupLoad.xopen(),xSendDataPrintServer(s,2,"comprobante"),setTimeout(()=>{xPopupLoad.xclose(),t(!1)},1e3)):$.ajax({type:"POST",url:"../../print/print5.php",data:{Array_enca:r,Array_print:xImpresoraPrint,ArrayItem:o,ArraySubTotales:e,ArrayComprobante:a,ArrayCliente:i}}).done(function(r){return-1!=r.indexOf("Error")?(xPopupLoad.xclose(),$("#print_error").text(r),xErrorPrint=!0,dialog_erro_print.open()):(xErrorPrint=!1,xPopupLoad.titulo="Imprimiendo...",xPopupLoad.xopen(),setTimeout(function(){xPopupLoad.xclose()},3e3)),t(xErrorPrint)})}function xImprimirComprobanteAhoraPrintPreSelect(r,o,e,a,i,t,p){xPopupLoad.titulo="Imprimiendo...";var n=parseInt(xm_log_get("datos_org_sede")[0].sys_local),s=(r[0].nom_us=xm_log_get("app3_us").nomus,comprobarNumCorrelativoComprobante(a),{Array_enca:r,Array_print:t,ArrayItem:o,ArraySubTotales:e,ArrayComprobante:a,ArrayCliente:i});1===n?(xPopupLoad.xopen(),xSendDataPrintServer(s,2,"comprobante"),setTimeout(()=>{xPopupLoad.xclose(),p(!1)},1e3)):$.ajax({type:"POST",url:"../../print/print5.php",data:{Array_enca:r,Array_print:t,ArrayItem:o,ArraySubTotales:e,ArrayComprobante:a,ArrayCliente:i}}).done(function(r){return-1!=r.indexOf("Error")?(xPopupLoad.xclose(),$("#print_error").text(r),xErrorPrint=!0,dialog_erro_print.open()):(xErrorPrint=!1,xPopupLoad.titulo="Imprimiendo...",xPopupLoad.xopen(),setTimeout(function(){xPopupLoad.xclose()},3e3)),p(xErrorPrint)})}function xgetComprobanteImpresora(r){for(var o=xm_log_get("app3_woIpPrint"),e=xm_log_get("app3_woIpPrintO"),a=window.localStorage.getItem("::app3_woIpPrintLo"),i=((xImpresoraPrint=xm_log_get("sede_generales"))[0].num_copias,r),t=!1,p=0;p<e.length;p++)if(e[p].idtipo_otro==r){i=e[p].idimpresora;break}if(null!=a&&""!=a)a=$.parseJSON(a),xImpresoraPrint[0].ip_print=a.ip,xImpresoraPrint[0].var_margen_iz=a.var_margen_iz,xImpresoraPrint[0].var_size_font=a.var_size_font,xImpresoraPrint[0].local=1,xImpresoraPrint[0].num_copias=a.num_copias,xImpresoraPrint[0].copia_local=a.copia_local,xImpresoraPrint[0].img64=a.img64,xImpresoraPrint[0].papel_size=a.papel_size,t=!0;else for(p=0;p<o.length;p++)if(o[p].idimpresora==i){t=!0,i=o[p].ip,xImpresoraPrint[0].ip_print=i,xImpresoraPrint[0].var_margen_iz=o[p].var_margen_iz,xImpresoraPrint[0].var_size_font=o[p].var_size_font,xImpresoraPrint[0].local=0,xImpresoraPrint[0].num_copias=o[p].num_copias,xImpresoraPrint[0].copia_local=0,xImpresoraPrint[0].img64=o[p].img64,xImpresoraPrint[0].papel_size=o[p].papel_size;break}return t}function xgetImpresora(r){for(var o=xm_log_get("app3_woIpPrint"),e=xm_log_get("app3_woIpPrintO"),a=window.localStorage.getItem("::app3_woIpPrintLo"),i=((xImpresoraPrint=xm_log_get("sede_generales"))[0].num_copias,xImpresoraPrint[0].papel_size,r),t=!1,p=0;p<e.length;p++)if(e[p].idtipo_otro==r){i=e[p].idimpresora;break}if(null!=a&&""!=a)a=$.parseJSON(a),xImpresoraPrint[0].ip_print=a.ip,xImpresoraPrint[0].var_margen_iz=a.var_margen_iz,xImpresoraPrint[0].var_size_font=a.var_size_font,xImpresoraPrint[0].local=1,xImpresoraPrint[0].num_copias=a.num_copias,xImpresoraPrint[0].copia_local=a.copia_local,xImpresoraPrint[0].img64=a.img64,xImpresoraPrint[0].papel_size=a.papel_size,t=!0;else for(p=0;p<o.length;p++)if(o[p].idimpresora==i){t=!0,i=o[p].ip,xImpresoraPrint[0].ip_print=i,xImpresoraPrint[0].var_margen_iz=o[p].var_margen_iz,xImpresoraPrint[0].var_size_font=o[p].var_size_font,xImpresoraPrint[0].local=0,xImpresoraPrint[0].num_copias=o[p].num_copias,xImpresoraPrint[0].copia_local=0,xImpresoraPrint[0].img64=o[p].img64,xImpresoraPrint[0].papel_size=o[p].papel_size;break}return t?xImpresoraPrint:null}function xgetImpresoraById(o){var r=xm_log_get("app3_woIpPrint"),e=(xm_log_get("app3_woIpPrintO"),window.localStorage.getItem("::app3_woIpPrintLo")),a=((xImpresoraPrint=xm_log_get("sede_generales"))[0].num_copias,xImpresoraPrint[0].papel_size,xImpresoraPrint[0].var_size_font_tall_comanda),i=!1,r=(null!=e&&""!=e?(e=$.parseJSON(e),xImpresoraPrint[0].ip_print=e.ip,xImpresoraPrint[0].var_margen_iz=e.var_margen_iz,xImpresoraPrint[0].var_size_font=e.var_size_font,xImpresoraPrint[0].local=1,xImpresoraPrint[0].num_copias=e.num_copias,xImpresoraPrint[0].copia_local=e.copia_local,xImpresoraPrint[0].img64=e.img64,xImpresoraPrint[0].papel_size=e.papel_size,i=!0):(e=r.filter(r=>parseInt(r.idimpresora)==o)[0])&&(i=!0,xImpresoraPrint[0].ip_print=e.ip,xImpresoraPrint[0].var_margen_iz=e.var_margen_iz,xImpresoraPrint[0].var_size_font=e.var_size_font,xImpresoraPrint[0].local=0,xImpresoraPrint[0].num_copias=e.num_copias,xImpresoraPrint[0].var_size_font_tall_comanda=a,xImpresoraPrint[0].copia_local=0,xImpresoraPrint[0].img64="",xImpresoraPrint[0].papel_size=e.papel_size),i?xImpresoraPrint:null);return r}function xCocinarImprimirComanda(a,i,t,p,n){if(0!==i.length){var s=xm_log_get("app3_woIpPrint"),o=(xm_log_get("app3_woIpPrintO"),window.localStorage.getItem("::app3_woIpPrintLo")),m=xm_log_get("sede_generales"),_=0,e=0;m[0].num_copias;const d=m[0].var_size_font_tall_comanda,u="1"===m[0].isprint_all_delivery.toString();a.is_print_subtotales=m[0].isprint_subtotales_comanda,a.isprint_copy_short=m[0].isprint_copy_short,a.isprint_all_short=m[0].isprint_all_short,i=i.filter(r=>r),null!=o&&""!=o&&(o=$.parseJSON(o),xArmarSubtotalesArray(i,m),m[0].ip_print=o.ip,m[0].var_margen_iz=o.var_margen_iz,m[0].var_size_font=o.var_size_font,m[0].local=1,m[0].num_copias=o.num_copias,m[0].copia_local=o.copia_local,m[0].img64=o.img64,m[0].papel_size=o.papel_size,"0"===o.img64&&(m[0].logo64=""),0==parseInt(o.num_copias)&&0==parseInt(o.copia_local)||xImprimirComandaAhora(a,m,i,t,n,r=>{p(r)}));let r=xm_log_get("estructura_pedido");0<(r=r.filter(r=>"0"!==r.idimpresora)).length&&r.map(r=>{var o=r.idtipo_consumo;xIdPrint=r.idimpresora,xArrayBodyPrint=[];for(var e=0;e<i.length;e++)null!=i[e]&&parseInt(o)==parseInt(i[e].id)&&$.map(i[e],function(r,o){"object"==typeof r&&(void 0===xArrayBodyPrint[e]&&(xArrayBodyPrint[e]={des:i[e].des,id:i[e].id,titlo:i[e].titulo}),xArrayBodyPrint[e][r.iditem]=r,i[e].flag_add_tpc=!0)});0!=xArrayBodyPrint.length&&(_++,xArmarSubtotalesArray(xArrayBodyPrint,m),r=s.filter(r=>parseInt(r.idimpresora)==xIdPrint)[0],m[0].ip_print=r.ip,m[0].var_margen_iz=r.var_margen_iz,m[0].var_size_font=r.var_size_font,m[0].local=0,m[0].num_copias=r.num_copias,m[0].var_size_font_tall_comanda=d,m[0].copia_local=0,m[0].img64=r.img64,m[0].papel_size=r.papel_size,"0"===r.img64&&(m[0].logo64=""),xImprimirComandaAhora(a,m,xArrayBodyPrint,t,n,function(r){p(r)}))});for(var c=0;c<s.length;c++){xIdPrint=s[c].idimpresora,xArrayBodyPrint=[],e++;for(var l=0;l<i.length;l++)null!=i[l]&&$.map(i[l],function(r,o){var e="delivery"===i[l].des.toLowerCase();"object"!=typeof r||i[l].flag_add_tpc||"0"!==r.imprimir_comanda&&(xIdPrint==r.idimpresora&&(void 0===xArrayBodyPrint[l]&&(xArrayBodyPrint[l]={des:i[l].des,id:i[l].id,titlo:i[l].titulo}),e&&u?Object.values(i[l]).filter(r=>"object"==typeof r).map(r=>xArrayBodyPrint[l][r.iditem]=r):xArrayBodyPrint[l][r.iditem]=r),xIdPrint.toString()==r.idimpresora_otro.toString())&&(void 0===xArrayBodyPrint[l]&&(xArrayBodyPrint[l]={des:i[l].des,id:i[l].id,titlo:i[l].titulo}),e&&u?Object.values(i[l]).filter(r=>"object"==typeof r).map(r=>xArrayBodyPrint[l][r.iditem]=r):xArrayBodyPrint[l][r.iditem]=r)});0!=xArrayBodyPrint.length&&(_++,xArmarSubtotalesArray(xArrayBodyPrint,m),m[0].ip_print=s[c].ip,m[0].var_margen_iz=s[c].var_margen_iz,m[0].var_size_font=s[c].var_size_font,m[0].local=0,m[0].num_copias=s[c].num_copias,m[0].var_size_font_tall_comanda=d,m[0].copia_local=0,m[0].img64=s[c].img64,m[0].papel_size=s[c].papel_size,"0"===s[c].img64&&(m[0].logo64=""),xImprimirComandaAhora(a,m,xArrayBodyPrint,t,n,function(r){s.length==e&&0==r?p&&p(!1):p&&p(!0)}))}0===_&&p&&p(!1)}}function xImprimirComandaAhora(r,o,e,a,i,t){xPopupLoad.titulo="Imprimiendo...";var p=parseInt(xm_log_get("datos_org_sede")[0].sys_local),i=(r.nom_us=xm_log_get("app3_us").nomus,{Array_enca:r,Array_print:o,ArrayItem:e.filter(r=>!0),ArraySubTotales:a,idpedido:i&&i.idpedido?i.idpedido:null});1===p?(xSendDataPrintServer(i,1,"comanda"),setTimeout(()=>{t(!1)},300)):$.ajax({type:"POST",url:"../../print/print3.php",data:{Array_enca:r,Array_print:o,ArrayItem:e,ArraySubTotales:a},success:function(r){-1!=r.indexOf("Error")?(xPopupLoad.xclose(),$("#print_error").text(r),xErrorPrint=!0):(xErrorPrint=!1,xPopupLoad.titulo="Imprimiendo...",xPopupLoad.xopen(),setTimeout(function(){xPopupLoad.xclose()},3e3)),t(xErrorPrint)},error:function(r,o,e){xPopupLoad.xclose(),$("#print_error").text("Error, Verifique que la ticketera este prendida y que tenga papel."),xErrorPrint=!0,t(xErrorPrint)}})}function xImprimirCualquierLista(r,o=5,e="listado"){xPopupLoad.titulo="Imprimiendo...",xPopupLoad.xopen(),r.encabezado.nom_us=xm_log_get("app3_us").nomus,xSendDataPrintServer({Array_enca:r.encabezado||"",Array_print:r.impresora,ArrayItem:r.lista,ArraySubTotales:r.subtotales||""},o,e),setTimeout(()=>{xPopupLoad.xclose()},300)}function xSendDataPrintServer(o,e,a){switch(e){case 3:break;case 4:if(""===o.Array_enca[0].ip_print)return;break;default:try{if(""===o.Array_print[0].ip_print)return;o.Array_print[0].logo64="",o.Array_print[0].logo=""}catch(r){}}var r=o.idpedido;o=JSON.stringify(o),a="pre cuenta"===a?"comanda":a,$.ajax({url:"../../bdphp/log_003.php?op=1",type:"POST",data:{datos:o,idprint_server_estructura:e,tipo:a,idpedido:r}}).done(r=>{r={detalle_json:o,idprint_server_estructura:e,tipo:a,descripcion_doc:a,nom_documento:a,idprint_server_detalle:r};_cpSocketEmitPrinterOnly(r)}).fail(function(r){alert("error",r)})}function xReturnCorrelativoComprobante(r){let o;var e;return"0"===r.codsunat?(o=parseInt(r.correlativo)+1,o=xCeroIzq(o,7),$.ajax({type:"POST",url:"../../bdphp/log_002.php",data:{op:"103",i:r.idtipo_comprobante_serie}})):(e=0!==parseInt(r.facturacion_correlativo_api),o=e?"#":parseInt(r.correlativo)+1,e||(r.facturacion_correlativo_api=1)),o}function xUpdatePrintPrecuentaPedido(r){$.ajax({url:"../../bdphp/log_003.php?op=6",type:"POST",data:{id:r}})}async function xGetCorrelativoComprobante(r){r=await $.ajax({type:"POST",url:"../../bdphp/log_002.php",data:{op:"103001",i:r.idtipo_comprobante_serie,obj:r}}),r=JSON.parse(r);return r.success?r.datos[0].num:"#"}function comprobarNumCorrelativoComprobante(r){parseInt(r.correlativo);isNaN(_numIntCorrelativoBD)&&(r.correlativo=_numIntCorrelativoBD)}function getImpresoraByTpc(o){var r=xm_log_get("estructura_pedido"),e=xm_log_get("app3_woIpPrint");let a=null;const i=r.filter(r=>parseInt(r.idtipo_consumo)==o)[0];return(a=i&&"0"!==i.idimpresora?e.filter(r=>parseInt(r.idimpresora)==i.idimpresora)[0]:a)||!1}function getImpresoraByIdImpresoraSeccion(o){var r=xm_log_get("app3_woIpPrint").filter(r=>parseInt(r.idimpresora)==parseInt(o))[0];return r||!1}function cocinarImpresionAnulacionOne(r,o,e,a){let i;var t,p;(i=(i=getImpresoraByTpc(r.idtipoconsumo))||getImpresoraByIdImpresoraSeccion(r.idimpresora_seccion))&&(t=[],p=r.des_tp.toUpperCase(),r=r.descripcion.toUpperCase(),a="0"===a.nummesa?"PEDIDO "+a.numpedido:"MESA "+a.nummesa,e=`Caja: ${e} - Supervisor: `+o,t.push({descripcion:r.toUpperCase(),cantidad:"01"}),i.ip_print=i.ip,xImprimirCualquierLista({lista:t,impresora:[i],subtotales:[],encabezado:{titulo:"ANULACION",tipo_consumo:p,mesa:a,correlativo_lista:0,usuario:e,motivo:""}}))}function cocinarImpresionAnulacionList(r,o,e,a,i){let t=[];if(r.map(o=>{var r,e,a=getImpresoraByTpc(o.idtipoconsumo);a&&(a.ip_print=a.ip,(r=t.filter(r=>r.idtipoconsumo===o.idtipoconsumo)[0])?(e={descripcion:o.descripcion,cantidad:xCeroIzq(o.cant_item,2)},r.items.push(e)):(r=[],e={descripcion:o.descripcion,cantidad:xCeroIzq(o.cant_item,2)},r.push(e),t.push({idtipoconsumo:o.idtipoconsumo,idseccion:o.idseccion,des_tpc:o.des_tp,printer:a,items:r})),o.chekPrint=!0)}),r.map(o=>{if(o.chekPrint)return!1;var r,e,a=getImpresoraByIdImpresoraSeccion(o.idimpresora_seccion);a&&(a.ip_print=a.ip,(r=t.filter(r=>r.idtipoconsumo===o.idtipoconsumo)[0])?(e={descripcion:o.descripcion,cantidad:xCeroIzq(o.cant_item,2)},r.items.push(e)):(r=[],e={descripcion:o.descripcion,cantidad:xCeroIzq(o.cant_item,2)},r.push(e),t.push({idtipoconsumo:o.idtipoconsumo,idseccion:o.idseccion,des_tpc:o.des_tp,printer:a,items:r})))}),0===t.length)return!1;const p="0"===a.nummesa?"PEDIDO "+a.numpedido:"MESA "+a.nummesa,n=`Caja: ${e} - Supervisor: `+o;t.map(r=>{xImprimirCualquierLista({lista:r.items,impresora:[r.printer],subtotales:[],encabezado:{titulo:"ANULACION",tipo_consumo:r.des_tpc,mesa:p,correlativo_lista:0,usuario:n,motivo:i.toUpperCase()}})})}function isComprobanteConsumo(r,o,e){if(2==r?.modo.id){({...e});try{var a,i=Date.now().toString().slice(-6),t=xm_log_get("estructura_pedido")[0].idtipo_consumo,p=o.filter(r=>"total"===r.descripcion.toLowerCase())[0].importe,n=""===r.modo.modo_title.trim()?"POR CONSUMO":r.modo.modo_title;if(0===(a=xCargarDatosAEstructuraImpresion([{id:i,iditem:i,idtipo_consumo:t,des_seccion:"ITEMS",cantidad:1,descripcion:n,punitario:p,precio:p,ptotal:p,precio_total_calc:p}],o,!1)).length)return e;e=a}catch(r){}}return e}async function reimpresionDocumento(r){xPopupLoad.xopen();r=await(new httpFecht).axiosExecute({type:"GET",url:"../../bdphp/api.php?route=get-comprobante/"+r},!0,!1);!1===r.success?(alert("Error al obtener el comprobante"),xPopupLoad.xclose()):(r.Array_enca.nom_us=xm_log_get("app3_us").nomus,r.Array_enca=[r.Array_enca],xgetComprobanteImpresora(-2),delete xImpresoraPrint[0].pie_pagina,r.Array_print=xImpresoraPrint,1===parseInt(xm_log_get("datos_org_sede")[0].sys_local)&&(xSendDataPrintServer(r,2,"comprobante"),setTimeout(()=>{xPopupLoad.xclose()},1e3)))}