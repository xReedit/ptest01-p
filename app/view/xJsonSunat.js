async function xJsonSunatCocinarDatos(a,r,i,n,c){var _={};if("0"!==xm_log_get("datos_org_sede")[0].facturacion_e_activo&&"0"!==i.codsunat){var s=0,d=(xm_log_get("carta_subtotales").filter(o=>-1<o.descripcion.indexOf("I.G.V")).map(o=>s=o),parseFloat(s.monto)),l="1"===s.activo,a=(r=darFormatoSubTotalesParaFacturacion(r,!1),xEstructuraItemsJsonComprobante(a,r,!1));try{2===i?.modo.id&&(a=a.slice(0,1))}catch(o){}var a=xJsonSunatCocinarItemDetalle(a,d,l),p=xm_log_get("datos_org_sede"),u=(p[0].logo64.split("base64,")[1],n.num_doc),m=i.descripcion.substr(0,1).toUpperCase(),g=10<=u.length?6:1,x=i.codsunat,v=i.idtipo_comprobante_serie,u=0===u.length?"00000000":u,f=r.length-1;let o=parseFloat(r[f].importe);var f=o,h=r.filter(o=>"I.G.V"===o.descripcion).map(o=>o.importe)[0]||0,r=r.filter(o=>6===o.id)[0],b=0;let e={};var S=[],C=[];let t=0;!!r&&(t=-1*parseFloat(r.importe),b=o-parseFloat(h)+t,r=(t/b).toFixed(2),S.push({codigo:"02",descripcion:"Descuento Global afecta a la base imponible",porcentaje:r,monto:t.toFixed(2),base:b.toFixed(2)}),o+=t),l?(h=(o-t).toFixed(2),e={total_descuentos:t.toFixed(2),total_exportacion:0,total_operaciones_gravadas:0,total_operaciones_inafectas:0,total_operaciones_exoneradas:o,total_operaciones_gratuitas:0,total_igv:0,total_impuestos:0,total_valor:h,total_venta:h},C.push({codigo:"2001",valor:"BIENES TRANSFERIDOS EN LA AMAZONÍA REGIÓN SELVA PARA SER CONSUMIDOS EN LA MISMA."})):(r=f,b=parseFloat(parseFloat(d)/100),l=xCalcMontoBaseIGV(r,b),h=parseFloat(r-l).toFixed(2),e={total_descuentos:0,total_exportacion:0,total_operaciones_gravadas:l,total_operaciones_inafectas:0,total_operaciones_exoneradas:0,total_operaciones_gratuitas:0,total_igv:h,total_impuestos:h,total_valor:l,total_venta:r});var f=xSetInputDate(xDevolverFecha()),d=xDevolverHora(),b=(rptDate=(rptDate=f+"|"+d).split("|"),i.fecha_manual||null),h=null===b?rptDate[0]:b,l=rptDate[1],r=""===p[0].sededireccion?p[0].direccion:p[0].sededireccion,f=p[0].sedenombre,d=n?.telefono||"",b=(comprobarNumCorrelativoComprobante(i),n?.nombres||"PUBLICO EN GENERAL"),F=i.forma_de_pago?.fecha_de_pago||"",E=i?.observaciones||"",m={serie_documento:""+m+i.serie,numero_documento:i.correlativo,fecha_de_emision:""+h,hora_de_emision:""+l,codigo_tipo_operacion:"0101",codigo_tipo_documento:""+x,codigo_tipo_moneda:"PEN",fecha_de_vencimiento:""+(""!==F?F:h),numero_orden_de_compra:"",datos_del_emisor:{codigo_pais:"PE",ubigeo:p[0].ubigeo,direccion:r+"  | "+p[0].sedeciudad,correo_electronico:"",telefono:""+p[0].telefono,codigo_del_domicilio_fiscal:p[0].codigo_del_domicilio_fiscal},datos_del_cliente_o_receptor:{codigo_tipo_documento_identidad:""+g,numero_documento:""+u,apellidos_y_nombres_o_razon_social:""+(""===b.trim()?"PUBLICO EN GENERAL":b),codigo_pais:"PE",ubigeo:"150101",direccion:n.direccion,correo_electronico:"",telefono:""+d},descuentos:S,totales:e,items:a,leyendas:C,extras:{forma_de_pago:i.forma_de_pago,observaciones:removeSpecialCharString(E),vendedor:"",caja:"",idcliente:n.idcliente}};1==("object"==typeof c?1:0)||"#"===i.correlativo?_=xSendApiSunat(m,c,v,!0,f):(xSendApiSunat(m,c,v,!0,f),_.ok=!0,_.qr="",_.hash="www.papaya.com.pe",_.external_id="",_.correlativo_comprobante=i.correlativo)}else _.ok=!0,_.qr="",_.hash="",_.external_id="";return _}function xJsonSunatCocinarItemDetalle(o,d,l){var p=[];const u=parseFloat(parseFloat(d)/100);return o.map((e,o)=>{let t="20",a=.01,r=0,i=parseFloat(e.precio_total).toFixed(2),n=e.punitario||e.precio_total;var c=parseFloat(e.precio_total),_=parseFloat(n),s=parseFloat(e.cantidad);if(0!==c){s*_!==c&&(_=c/s,n=_.toFixed(2));let o=n;l?a=parseFloat(e.precio_total):(t="10",o=xCalcMontoBaseIGV(n,u),i=o*e.cantidad,a=i,r=parseFloat(parseFloat(e.precio_total)-a).toFixed(2));c={codigo_interno:e.id,descripcion:e.des,codigo_producto_sunat:"90101500",codigo_producto_gsl:"90101500",unidad_de_medida:"NIU",cantidad:e.cantidad,valor_unitario:o,codigo_tipo_precio:"01",precio_unitario:n,codigo_tipo_afectacion_igv:t,total_base_igv:a,porcentaje_igv:d,total_igv:r,total_impuestos:r,total_valor_item:i,total_item:e.precio_total};p.push(c)}}),p}async function xCocinarJsonNotaCredito(o){var e=JSON.parse(o.json_xml),t=getSerieDoc(o.numero),a=o.codsunat,t={serie_documento:"F"+t,numero_documento:"#",fecha_de_emision:xSetInputDate(xDevolverFecha()),hora_de_emision:xDevolverHora(),codigo_tipo_documento:"07",codigo_tipo_nota:"01",motivo_o_sustento_de_nota:txt_motivo_anular.value,codigo_tipo_moneda:"PEN",numero_orden_de_compra:"",documento_afectado:{serie_documento:e.serie_documento,numero_documento:parseInt(e.numero_documento),codigo_tipo_documento:a},datos_del_emisor:e.datos_del_emisor,datos_del_cliente_o_receptor:e.datos_del_cliente_o_receptor,totales:e.totales,items:e.items,extras:{}};return await xSendNotaCredito(t,o.idce)}async function xSendNotaCredito(e,t){var o=xm_log_get("datos_org_sede")[0],a=o.url_api_fac||"",a=(""===a?xm_log_get("app3_sys_const")[0].value:a)+"/documents",r=HEADERS_COMPROBANTE,o=(r.Authorization="Bearer "+o.authorization_api_comprobante,xm_all_xToastOpen("Conectando con Sunat..."),await fetch(a,{method:"POST",headers:r,body:JSON.stringify(e)}).then(function(o){return o.json()}).then(function(o){return 1==o.success?(o.idce=t,o.jsonxml=e,CpeInterno_RegistrarNC(o),showToastSwal("success","Listo proceso correcto.")):showAlertSwalOk("error","Ocurrio un error!",o.message),o}).catch(async function(o){return showAlertSwalOk("error","Ocurrio un error!","No se pudo concretar el proceso. Error inesperado."),!1}));return o}function getSerieDoc(o){return o.split("-")[0].replace(/\D/g,"")}async function xSendApiSunat(a,o,r,e=0,i=""){var t=xm_log_get("datos_org_sede")[0],n=t.url_api_fac||"",n=(""===n?xm_log_get("app3_sys_const")[0].value:n)+"/documents",c=HEADERS_COMPROBANTE,_=(c.Authorization="Bearer "+t.authorization_api_comprobante,{});const s=a.serie_documento+"-"+a.numero_documento,d=a.datos_del_cliente_o_receptor.apellidos_y_nombres_o_razon_social,l=a.datos_del_cliente_o_receptor.telefono,p=a.extras.idcliente,u=a.totales.total_venta,m=a.totales,g="object"==typeof o?o[1]:o,x="object"==typeof o?1:0;return xm_all_xToastOpen("Conectando con Sunat..."),setTimeout(()=>{xm_all_xToastClose()},2e3),await fetch(n,{method:"POST",headers:c,body:JSON.stringify(a)}).then(function(o){return o.json()}).then(function(o){try{!o.response||o.response.error_soap;var e=o.response||o,t=!!e?.code;e.success;t&&xVerificarCodeResponseCPE(e)}catch(o){}_.ok=!0,_.qr=o.data.qr,_.hash=o.data.hash,_.external_id=o.data.external_id,_.correlativo_comprobante=xCeroIzqNumberComprobante(o.data.number).split("-")[1],_.facturacion_correlativo_api=1,o.data.nomcliente=d,o.data.idcliente=p,o.data.total=u,o.data.totales_json=m,o.data.numero=s,o.data.idregistro_pago=g,o.data.viene_facturador=x,o.data.idtipo_comprobante_serie=r,o.data.jsonxml=a,CpeInterno_Registrar(o),""!==l&&(e=(t=xm_log_get("datos_org_sede")[0]).id_api_comprobante,xSendWhatsAppPdfComrpobante({telefono:l,external_id:_.external_id,numero_comprobante:o.data.number,comercio:i,user_id:e,comercio_telefono:t.telefono}))}).catch(async function(o){var e={pdf:"0",cdr:"0",xml:"0",idcliente:p,total:u,totales_json:m,nomcliente:d,numero:s,jsonxml:a,external_id:"",estado_api:0,estado_sunat:1,viene_facturador:x,idtipo_comprobante_serie:r},e=(_.ok=!0,_.qr="",_.hash="www.papaya.com.pe",_.external_id="",await CpeInterno_Error(e,g,x,r));_.correlativo_comprobante=e.correlativo,_.facturacion_correlativo_api=e.facturacion_correlativo_api}),_}function xSendWhatsAppPdfComrpobante(o){_cpSocketComprobanteWhatApp(o)}