var xArrayPedidoObj,xidTipoConsumo,xidItem,xCambioCantidad=!1,xLocal_TotalImporte=0,xErrorPrint=!1,xArrayDesTipoConsumo=[],xVerificarImprimirComanda=!1,xGeneralDataCarta,xGeneralRelojUpdateItemsSolo,xGeneralRelojUpdateItemsCambioBd,xDisparaUpdateItems=new Event("GeneralUpdateItemsSolo"),xGeneralNumPedidosActual=0,xGeneralUpdateSeccion=0,xGeneralDataSeccion,xNumPedidosBD=0,xGeneralArraySubTotales=[],itemPedidos_objItemSelected=[],objOptionItemSelect;function handlerFnMiPedido(e){const _thisObj=$(this),_viene_venta_rapida=(xCambioCantidad=!0,xidTipoConsumo=_thisObj.parent().attr("data-id"),parseInt(_thisObj.parent().attr("data-ventarapida"))),_viene_subitems_mod=parseInt(_thisObj.parent().attr("data-viene-subitems-mod"));1==_viene_subitems_mod&&modificarUnSubItem(_thisObj),xidItem=itemPedidos_objItemSelected.idcarta_lista||itemPedidos_objItemSelected.iditem;var xOperacion=_thisObj.text(),objCant=_thisObj.parent().find(".xCant_item"),objCant_cant=xArrayPedidoObj[xidTipoConsumo]&&xArrayPedidoObj[xidTipoConsumo][xidItem]?xArrayPedidoObj[xidTipoConsumo][xidItem].cantidad:0,xStockActual=itemPedidos_objItemSelected.stock_actual,xidItem2=itemPedidos_objItemSelected.iditem===xidItem&&itemPedidos_objItemSelected.iditem2||itemPedidos_objItemSelected.iditem,xDesItem=itemPedidos_objItemSelected.des_item,xPrecioItem=itemPedidos_objItemSelected.precio,xIndicaciones=itemPedidos_objItemSelected.xindicaciones,xCantActual=parseInt(objCant_cant),xCantSeccion=parseInt(xArrayPedidoObj[xidTipoConsumo].cantidad),xCantTotalItem=0,xDesSeccion=itemPedidos_objItemSelected.des_seccion||xTituloDet,xIdSeccionItem=itemPedidos_objItemSelected.idseccion,xIdSeccionItem_index=itemPedidos_objItemSelected.idseccion_index,xRowidimpresora=itemPedidos_objItemSelected.idimpresora,xRowidimpresora_otro=itemPedidos_objItemSelected.idimpresora_otro,xRowidporcion=itemPedidos_objItemSelected.idprocede,xRowProcede=itemPedidos_objItemSelected.procede,xRowProcede_index=itemPedidos_objItemSelected.procede_index,ximprmir_comanda=itemPedidos_objItemSelected.imprimir_comanda,xcant_descontar=itemPedidos_objItemSelected.cant_descontar,xidalmacen_items=itemPedidos_objItemSelected.idalmacen_items,xidDescontar=xRowidporcion,xPrecioTotal,xcant_max=parseInt(xStockActual),xidcategoria=itemPedidos_objItemSelected.idcategoria,xStockActual=xcant_max,xSotockSocket=xcant_max,xSotockSocketRun=xcant_max,xcantRunSocket=xcant_max,xcant=xCantActual,xsigno=xOperacion,sec_orden=itemPedidos_objItemSelected.sec_orden,subitems_selected_index=itemPedidos_objItemSelected.subitems_selected_index,xCantActual=isNaN(xCantActual)?0:xCantActual,xCantSeccion=isNaN(xCantSeccion)?0:xCantSeccion,xcant=xCantActual;if(_thisObj.parents(".xpedir_item").find(".xCant_item").each(function(e,t){t=parseInt($(t).text());isNaN(t)&&(t=0),xCantTotalItem=parseInt(xCantTotalItem)+t}),1===_viene_venta_rapida)"+"==xOperacion?(isSocket?(xSotockSocket=0<xcant_max?parseFloat(xSotockSocket)-1:0,xSotockSocketRun=-1<xcant_max?parseFloat(xSotockSocketRun)-1:0,0<xcant_max&&xcant++):xcant<xcant_max&&xcant++,xcantRunSocket=xcant):(xSotockSocket=0===xcant?xcant_max:parseFloat(xSotockSocket)+1,xSotockSocketRun=0===xcant?xcant_max:parseFloat(xSotockSocketRun)+1,xcant--,xcantRunSocket=xcant,xcant=xcant<=0?0:xcant),xCantActual=xcant,xCount_cant_ico=xcant;else{if(isNaN(xCantTotalItem)&&(xCantTotalItem=0),xCantActual=parseInt(xCantActual)+xOperacion+parseInt(1),xCantTotalItem=parseInt(xCantTotalItem)+xOperacion+parseInt(1),xCount_cant_ico=parseInt(xCount_cant_ico)+xOperacion+parseInt(1),xCantSeccion=parseInt(xCantSeccion)+xOperacion+parseInt(1),xCantActual=eval(xCantActual),xCantTotalItem=eval(xCantTotalItem),xCount_cant_ico=eval(xCount_cant_ico),xCantSeccion=eval(xCantSeccion),xCount_cant_ico<0&&(xCount_cant_ico=0),"ND"!=xStockActual&&xCantTotalItem>parseInt(xStockActual))return;xCantActual<=0?(xCantActual=0,objCant.addClass("xInvisible")):objCant.removeClass("xInvisible")}objCant.text(xCeroIzq(xCantActual,2)),xPrecioTotal=parseFloat(xCantActual*xPrecioItem).toFixed(2);const mySubItemView=checkMySubitemView(xidTipoConsumo,xidItem),isSubItemControlable=!!itemPedidos_objItemSelected?.subitems&&1===parseInt(itemPedidos_objItemSelected.subitems[0].iscontrolable),idSubItemControlable=isSubItemControlable?itemPedidos_objItemSelected.subitems_selected[0].iditem_subitem:0,sumar=(xArrayPedidoObj[xidTipoConsumo].cantidad=xCantSeccion,xArrayPedidoObj[xidTipoConsumo][xidItem]={idcategoria:xidcategoria,idseccion:xIdSeccionItem,idseccion_index:xIdSeccionItem_index,des_seccion:xDesSeccion,sec_orden:sec_orden,iditem:xidItem,idtipo_consumo:xidTipoConsumo,stock_actual:xStockActual,cantidad:xCantActual,precio:xPrecioItem,des:xDesItem,precio_total:xPrecioTotal,precio_total_calc:xPrecioTotal,precio_print:"",indicaciones:xIndicaciones,iditem2:xidItem2,idimpresora:xRowidimpresora,idimpresora_otro:xRowidimpresora_otro,idprocede:xRowidporcion,procede:xRowProcede,procede_index:xRowProcede_index,imprimir_comanda:ximprmir_comanda,iddescontar:xidDescontar,cant_descontar:xcant_descontar,idalmacen_items:xidalmacen_items,visible:0,pwa:isSocket?1:0,isporcion:itemPedidos_objItemSelected.isporcion,precio_unitario:itemPedidos_objItemSelected.precio_unitario,detalle:itemPedidos_objItemSelected.detalle,subitems:itemPedidos_objItemSelected.subitems,subitems_selected:itemPedidos_objItemSelected.subitems_selected,subitem_required_select:itemPedidos_objItemSelected.subitem_required_select,subitem_cant_select:itemPedidos_objItemSelected.subitem_cant_select,subitems_view:itemPedidos_objItemSelected.subitems_view||mySubItemView,isporcion:itemPedidos_objItemSelected.isporcion,iditem_subitem:idSubItemControlable,subitems_selected_index:subitems_selected_index},"+"===xsigno),_objIcoPedido=(xAddSubItemsView(xidTipoConsumo,xidItem,sumar),xCantActual<=0&&delete xArrayPedidoObj[xidTipoConsumo][xidItem],window.localStorage.setItem("::app3_sys_dta_pe",JSON.stringify(xArrayPedidoObj)),window.localStorage.setItem("::app3_sys_dta_count_ico",xCount_cant_ico),$("#_xIco_MiPedido .xCantPedio_ico"));if(0<xCount_cant_ico?(_objIcoPedido.text(xCeroIzq(xCount_cant_ico,2)),_objIcoPedido.removeClass("xInvisible")):_objIcoPedido.addClass("xInvisible"),"ND"!==itemPedidos_objItemSelected.cantidad&&isSocket&&0<=xcantRunSocket&&-1<xSotockSocketRun){itemPedidos_objItemSelected.stock_actual=xSotockSocket;const itemNotifySocket={cantidad:xSotockSocket,idcarta_lista:itemPedidos_objItemSelected.idcarta_lista,iditem:itemPedidos_objItemSelected.iditem,isalmacen:"0"===itemPedidos_objItemSelected.procede.toString()?1:0,isporcion:itemPedidos_objItemSelected.isporcion,subitems:"string"==typeof itemPedidos_objItemSelected.subitems?JSON.parse(itemPedidos_objItemSelected.subitems):itemPedidos_objItemSelected.subitems,subitems_selected:itemPedidos_objItemSelected.subitems_selected,sumar:"+"===xsigno};_cpSocketEmitItemModificado(itemNotifySocket),_cpSocketSavePedidoStorage(xArrayPedidoObj),compItemSumImporte()}xcantRunSocket=!0;const xVistaMiPedido=document.getElementById("mipedido-view");return xVistaMiPedido&&xVistaMiPedido._outLoadPedido(),1==_viene_venta_rapida&&xVerMipedidoVR(),e.stopPropagation(),e.stopImmediatePropagation(),!1}async function handlerFnMiPedidoControl(e,t=null){var i="xcant_li",a=e.target||e,o="itempedido"===a.dataset.op,d=(a=o?$(a).parents("tr")[0]:a).dataset.index?a:(a.parentElement.dataset.index?a:(a.parentElement.parentElement.dataset.index?a:a.parentElement).parentElement).parentElement,r=d.dataset,n=r.ventarapida,c=r.index,s=a.dataset.idcategoria;if(o){s&&1!=s&&xGeneralDataCarta[0].idcategoria!=s&&(xGeneralDataCarta=await xGeneralLoadItemsAddItem(s));const F=a.dataset.iditem.toString();xGeneralDataCarta.map((e,t)=>{e.iditem.toString()===F&&(c=t)})}else c=r.index;if(xidTipoConsumo=$("#select_ulTPC option:selected").val(),itemPedidos_objItemSelected=xGeneralDataCarta[c],1==n&&(i="xcant_li2",isShowOpcionesPrimero)&&itemPedidos_objItemSelected.subitems&&"0"!==itemPedidos_objItemSelected.subitems&&itemPedidos_objItemSelected.opciones)xCompSubitems.openDialog(null,c);else{xidItem=itemPedidos_objItemSelected.idcarta_lista;var d=d.getElementsByClassName(i),d=$(d),i="+"!=a.textContent&&"-"!=a.textContent?r.signo:a.textContent,i=o?"+":i,r=xArrayPedidoObj[xidTipoConsumo]&&xArrayPedidoObj[xidTipoConsumo][xidItem]?xArrayPedidoObj[xidTipoConsumo][xidItem].cantidad:0,a=null!==t?t:parseInt(r),r=itemPedidos_objItemSelected.stock_actual||1e4,l=xidTipoConsumo,m=xidItem,p=itemPedidos_objItemSelected.des_item,_=itemPedidos_objItemSelected.indicaciones||"",u=itemPedidos_objItemSelected.precio,x=itemPedidos_objItemSelected.idimpresora,b=itemPedidos_objItemSelected.idimpresora_otro,S=itemPedidos_objItemSelected.idprocede,I=itemPedidos_objItemSelected.procede,P=itemPedidos_objItemSelected.procede_index,f=itemPedidos_objItemSelected.idseccion,v=itemPedidos_objItemSelected.idseccion_index,j=itemPedidos_objItemSelected.des_seccion,g=itemPedidos_objItemSelected.iditem===xidItem&&itemPedidos_objItemSelected.iditem2||itemPedidos_objItemSelected.iditem,C=itemPedidos_objItemSelected.imprimir_comanda,y=itemPedidos_objItemSelected.cant_descontar,s=itemPedidos_objItemSelected.idcategoria||s,A=itemPedidos_objItemSelected.idalmacen_items,h=r,k=r,w=r,O=r,T=itemPedidos_objItemSelected.sec_orden,o=(null!==t?a=t:"+"==i?(!isSocket||o?a<r&&a++:(k=0<r?parseFloat(k)-1:0,w=-1<r?parseFloat(w)-1:0,0<r&&a++),O=a):(k=0===a?r:parseFloat(k)+1,w=0===a?r:parseFloat(w)+1,a=(O=--a)<=0?0:a),t=parseFloat(parseFloat(u)*parseFloat(a)).toFixed(2),checkMySubitemView(l,l));if(xArrayPedidoObj[l][m]={idcategoria:s,idseccion:f,idseccion_index:v,sec_orden:T,des_seccion:j,iditem:m,idtipo_consumo:l,stock_actual:h,cantidad:a,precio:u,des:p,precio_total:t,precio_total_calc:t,precio_print:t,indicaciones:_,iditem2:g,idimpresora:x,idimpresora_otro:b,idprocede:S,procede:I,procede_index:P,imprimir_comanda:C,cant_descontar:y,idalmacen_items:A,visible:0,pwa:isSocket?1:0,isporcion:itemPedidos_objItemSelected.isporcion,precio_unitario:itemPedidos_objItemSelected.precio_unitario,detalle:itemPedidos_objItemSelected.detalle,subitems:itemPedidos_objItemSelected.subitems,subitems_selected:itemPedidos_objItemSelected.subitems_selected,subitem_required_select:itemPedidos_objItemSelected.subitem_required_select,subitem_cant_select:itemPedidos_objItemSelected.subitem_cant_select,subitems_view:itemPedidos_objItemSelected.subitems_view||o,isporcion:itemPedidos_objItemSelected.isporcion,venta_x_peso:itemPedidos_objItemSelected.venta_x_peso,idcarta_lista:itemPedidos_objItemSelected.idcarta_lista},d.text(a),$(d).hasClass("input-modifica")&&0!==a&&$(d).val(a),1==n&&"1"==itemPedidos_objItemSelected.venta_x_peso){xVerMipedidoVR();try{e.stopPropagation(),e.stopImmediatePropagation()}catch(e){}}else{a<=0?(a=0,d.removeClass("cant_fixed_li"),delete xArrayPedidoObj[l][m]):d.addClass("cant_fixed_li"),"ND"!==itemPedidos_objItemSelected.cantidad&&isSocket&&0<=O&&-1<w&&(r={cantidad:itemPedidos_objItemSelected.stock_actual=k,idcarta_lista:itemPedidos_objItemSelected.idcarta_lista,iditem:itemPedidos_objItemSelected.iditem,isalmacen:"0"===itemPedidos_objItemSelected.procede.toString()?1:0,isporcion:itemPedidos_objItemSelected.isporcion,subitems:"string"==typeof itemPedidos_objItemSelected.subitems?JSON.parse(itemPedidos_objItemSelected.subitems):itemPedidos_objItemSelected.subitems,subitems_selected:itemPedidos_objItemSelected.subitems_selected,sumar:"+"===i},_cpSocketEmitItemModificado(r),_cpSocketSavePedidoStorage(xArrayPedidoObj)),O=!0,1==n&&xVerMipedidoVR();try{e.stopPropagation(),e.stopImmediatePropagation()}catch(e){}}}}function xNotifyItemModificado(e){e.cantidad,objItem.parent().attr("data-idcarta_lista"),objItem.parent().attr("data-iditem"),objItem.parent().attr("data-procede"),objItem.parent().attr("data-isporcion")}function checkMySubitemView(e,t){try{return xArrayPedidoObj[e][t].subitems_view||null}catch(e){return null}}function xSendItemBySocket(e){e={cantidad:xSotockSocket,idcarta_lista:itemPedidos_objItemSelected.idcarta_lista,iditem:itemPedidos_objItemSelected.iditem,isalmacen:"0"===itemPedidos_objItemSelected.procede.toString()?1:0,isporcion:itemPedidos_objItemSelected.isporcion,subitems:"string"==typeof itemPedidos_objItemSelected.subitems?JSON.parse(itemPedidos_objItemSelected.subitems):itemPedidos_objItemSelected.subitems,subitems_selected:itemPedidos_objItemSelected.subitems_selected,sumar:"+"===e};_cpSocketEmitItemModificado(e),_cpSocketSavePedidoStorage(xArrayPedidoObj),compItemSumImporte()}function modificarUnSubItem(e){var t=(e=e.parents("tr")[0]).dataset.idtipo_consumo,i=e.dataset.idcarta_lista;const a=e.dataset.idsubitem;e=e.dataset.index,t=xArrayPedidoObj[t][i],i=t.subitems_view.filter(e=>e.id===a)[0].subitems;t.subitems_selected=[],t.subitems_selected=i,t.subitems_selected_index=e,(itemPedidos_objItemSelected=t).des_item=t.des,itemPedidos_objItemSelected.idcarta_lista=t.iditem,itemPedidos_objItemSelected.subitems_selected_index=e}function xAddSubItemsView(e,t,i){var a,o,d=xArrayPedidoObj[e][t];d.subitems_view=d.subitems_view||[],d.subitems&&0!==d.subitems.length&&(a={id:"",des:[],cantidad_seleccionada:0,precio:0,indicaciones:"",subitems:[]},d.subitems_selected&&0<d.subitems_selected.length?(d.subitems_selected.map(e=>{a.id+=e.iditem_subitem.toString(),a.des.push(primeraConMayusculas(e.des.toLowerCase().trim())),a.cantidad_seleccionada=1,a.precio+=parseFloat(e.precio),a.indicaciones+=void 0===e.indicaciones?"":" ("+e.indicaciones+")",a.indicaciones_item=d.indicaciones,a.subitems.push(e)}),a.des=a.des.join(","),a.des+=void 0===d.indicaciones?"":",("+d.indicaciones+")",d.indicaciones="",d.subitems_view=d.subitems_view||[],o=d.subitems_view.filter(e=>e.id===a.id&&e.indicaciones_item===a.indicaciones_item)[0],(o=d.subitems_selected_index?d.subitems_view[parseInt(d.subitems_selected_index)]:o)?i?(o.indicaciones+=a.indicaciones,o.cantidad_seleccionada+=1,o.precio+=a.precio):this.restarCantSubItemView(d,o):i?(d.subitems_view.push(a),xArrayPedidoObj[e][t].subitems_view=d.subitems_view):this.restarCantSubItemView(d,null)):this.restarCantSubItemView(d,null),this.addPrecioItemMiPedido(d))}function restarCantSubItemView(e,t=null){var i;t?(i=t.precio/t.cantidad_seleccionada,--t.cantidad_seleccionada,t.precio-=i,t.precio=t.precio<0?0:t.precio,t.cantidad_seleccionada<=0&&(e.subitems_view=e.subitems_view.filter(e=>0<e.cantidad_seleccionada))):(i=e.subitems_view.length,(t=e.subitems_view[i-1])&&(i=t.precio/t.cantidad_seleccionada,t.cantidad_seleccionada--,t.precio-=i,t.cantidad_seleccionada<=0&&(e.subitems_view=e.subitems_view.filter(e=>0<e.cantidad_seleccionada)),e.subitems_selected=t.subitems))}function addPrecioItemMiPedido(e){e.cantidad_seleccionada=e.cantidad;var t=e.subitems_view?e.subitems_view.map(e=>parseFloat(e.precio)).reduce((e,t)=>e+t,0):0,i=e.cantidad*parseFloat(e.precio_unitario),i=parseFloat(i+t).toFixed(2);e.precio_total=i,e.precio_print=i}function xBtnSumarRestarKey(e,t){t=0<t?".suma":".resta";handlerFnMiPedidoControl($(e).parent().find(t)[0])}function xEstructuraExpress(e,t,i){t="1"===t.toString(),i="1"===i.toString();var i=[],a={tipoconsumo:[]},o={titulo:"",secciones:[],descripcion:"",idtipo_consumo:"",count_items_seccion:1,cantidad_seleccionada:1};if(t){var d,r=[],n=[],c=!1,s=!1;for(const p in e)if(e.hasOwnProperty(p)){var l,m=e[p];(o={titulo:"",secciones:[],descripcion:"",idtipo_consumo:"",count_items_seccion:1,cantidad_seleccionada:1}).descripcion=m.des,o.titulo=m.titulo,o.idtipo_consumo=m.id,s=!1,r=[];for(const _ in m)m.hasOwnProperty(_)&&"object"==typeof(l=m[_])&&(d=l.idseccion,c=!(s=!0),(n=r.filter(e=>e.idseccion===d)[0])||(c=!0,n={des:l.des_seccion,idseccion:l.idseccion,sec_orden:1,count_items:1,idimpresora:l.idimpresora,ver_stock_cero:l.visible,items:[]}),n.items.push({des:l.des,img:"",sumar:!1,iditem:l.iditem,precio:l.precio,procede:l.procede,seccion:l.des_seccion,visible:!0,cantidad:l.cantidad,detalles:l.detalle,selected:!0,subitems:l.subitems,isalmacen:l.idalmacen_items,idseccion:l.idseccion,isporcion:l.isporcion,sec_orden:1,des_seccion:l.des_seccion,idimpresora:l.idimpresora,precio_print:l.precio_total,precio_total:l.precio_total,idcarta_lista:l.iditem,subitems_view:l.subitems_view,precio_default:l.precio,ver_stock_cero:0,precio_unitario:l.precio_unitario,imprimir_comanda:l.imprimir_comanda,itemtiposconsumo:[],precio_total_calc:l.precio_total_calc,subitems_selected:[],subitem_cant_select:l.subitem_cant_select,cantidad_seleccionada:l.cantidad,subitem_required_select:l.subitem_required_select}),c)&&r.push(n);s&&(o.secciones=r,a.tipoconsumo.push(o))}i=0<a.tipoconsumo.length?a:[]}return i}function xChangeTipoConsumoItems(t){const a=xArrayPedidoObj.filter(e=>e).filter(e=>e.id===t)[0];xArrayPedidoObj.filter(e=>e).filter(e=>e.id!==t).map(e=>{for(const i in e){var t;e.hasOwnProperty(i)&&"object"==typeof(t=e[i])&&(t.idtipo_consumo=a.id,a[i]=t,delete e[i])}}),xVerMipedidoVR()}function xClassEstadoItem(e){var t="",i="";return"ND"==e?(t="xEstadoVerde",i="xFondoColorVerde"):(5<(e=parseInt(e))&&(t="xEstadoAmarillo",i="xFondoColorAmarillo"),10<=e&&(t="xEstadoVerde",i="xFondoColorVerde"),e<=5&&(t="xEstadoAmbar",i="xFondoColorAmbar"),e<=0&&(t="xEstadoRojo",i="xFondoColorRojo")),t+"|"+i}function xLoadArrayPedido(){null!==(xArrayPedidoObj=JSON.parse(window.localStorage.getItem("::app3_sys_dta_pe")))&&0<xArrayPedidoObj.length||(xArrayDesTipoConsumo=[],xArrayPedidoObj=[],xm_log_get("estructura_pedido").map(e=>{var t=e.idtipo_consumo;xArrayPedidoObj[t]={id:e.idtipo_consumo,des:e.descripcion,titulo:e.titulo},xArrayDesTipoConsumo.push({id:e.idtipo_consumo,des:e.descripcion,titulo:e.titulo})}),window.localStorage.setItem("::app3_sys_dta_pe",JSON.stringify(xArrayPedidoObj)))}function xVerificarSiSeImprimeComanda(e){null==e&&(e=xArrayPedidoObj),xVerificarImprimirComanda=!1;for(var t=0;t<e.length;t++)null!=e[t]&&$.map(e[t],function(e,t){"object"==typeof e&&0!=e.cantidad&&1==e.imprimir_comanda&&(xVerificarImprimirComanda=!0)})}function xObtnerValSumArray(e,i){for(var a=0,t=0;t<e.length;t++)null!=e[t]&&$.map(e[t],function(e,t){"object"==typeof e&&e.idseccion===i&&(a=parseFloat(a)+parseFloat(e.cantidad))});return a}function xObtnerValSumTable(e,i,a,o){var d=0;return $(e).find(".row").each(function(e,t){$(t).attr(i)===a&&(d=parseFloat(d)+parseFloat($(t).find(o).text()))}),parseInt(d)}function xSumaCantArray(e){for(var n=0,t=0;t<e.length;t++)null!=e[t]&&$.map(e[t],function(a,e){if("object"==typeof a){var o=parseFloat(a.precio),d=!!a.subitems_view;let e=a.cantidad,t=0;t=-1<e.toString().indexOf(",")?(e=(e=e.split(",")).reduce((e,t)=>parseFloat(e)+parseFloat(t)),parseFloat(a.ptotal)):(e=parseFloat(a.cantidad),parseFloat(parseFloat(e*o).toFixed(2)));var r=""===a.precio_print?parseFloat(a.precio_total_calc):parseFloat(a.precio_print);let i=(r>t&&!d?o:r).toFixed(2);""===i&&(i=a.precio_total_calc),n+=parseFloat(i)}});return n}function xMandarImprimirOtroDoc(e,t,i,a){for(var o=xm_log_get("app3_woIpPrint"),d=xm_log_get("app3_woIpPrintO"),r=window.localStorage.getItem("::app3_woIpPrintLo"),n=a,c=!1,s=0;s<d.length;s++)if(-1==d[s].idtipo_otro){n=d[s].idimpresora;break}if(null!=r&&""!=r)r=$.parseJSON(r),t[0].ip_print=r.ip,t[0].var_margen_iz=r.var_margen_iz,t[0].var_size_font=r.var_size_font,t[0].papel_size=r.papel_size,t[0].num_copias=r.num_copias,t[0].local=1,c=!0;else for(s=0;s<o.length;s++)if(o[s].idimpresora==n){c=!0,n=o[s].ip,t[0].ip_print=n,t[0].var_margen_iz=o[s].var_margen_iz,t[0].var_size_font=o[s].var_size_font,t[0].papel_size=o[s].papel_size,t[0].num_copias=o[s].num_copias,t[0].copia_local=o[s].copia_local,t[0].local=0;break}return 0!=c&&0!=i.length&&(xArmarSubtotalesArray(i,t),void xImprimirAhora(e,t,i,xLocal_xDtSubTotales,function(e){0!=e&&(xPopupLoad.titulo="Imprimiendo...",xPopupLoad.xopen(),setTimeout(function(){xPopupLoad.xclose()},3e3))}))}function xMandarImprimirOtroDoc(e,t,i,a,o,d=!1){var r=xm_log_get("app3_woIpPrint"),n=xm_log_get("app3_woIpPrintO"),c=window.localStorage.getItem("::app3_woIpPrintLo"),s=o,l=!1;-1===o&&(d="1"==xm_log_get("sede_generales")[0].isprint_cpe_short);for(var m=t[0].var_size_font_tall_comanda=0;m<n.length;m++)if(n[m].idtipo_otro==o){s=n[m].idimpresora;break}if(null!=c&&""!=c)c=$.parseJSON(c),t[0].ip_print=c.ip,t[0].var_margen_iz=c.var_margen_iz,t[0].var_size_font=c.var_size_font,t[0].papel_size=c.papel_size,t[0].num_copias=c.num_copias,t[0].local=1,l=!0;else for(m=0;m<r.length;m++)if(r[m].idimpresora==s){l=!0,s=r[m].ip,t[0].ip_print=s,t[0].var_margen_iz=r[m].var_margen_iz,t[0].var_size_font=r[m].var_size_font,t[0].papel_size=r[m].papel_size,t[0].num_copias=r[m].num_copias,t[0].copia_local=r[m].copia_local,t[0].local=0;break}return 0!=l&&0!=i.length&&(d&&(i=xEstructuraItemsJsonComprobante(i,a,!1,!0),i=xEstructuraItemsAgruparPrintJsonComprobante(i)),void xImprimirAhora(e,t,i,a,function(e){0!=e&&(xPopupLoad.titulo="Imprimiendo...",xPopupLoad.xopen(),setTimeout(function(){xPopupLoad.xclose()},3e3))}))}function xMandarImprimir(e,t,i,a){var o,d=new Array,r=0,n=0,c=window.localStorage.getItem("::app3_woIpPrintLo"),s=xm_log_get("app3_woIpPrint");null!=c&&""!=c&&(c=$.parseJSON(c),xArmarSubtotalesArray(i,t),t[0].ip_print=c.ip,t[0].var_margen_iz=c.var_margen_iz,t[0].var_size_font=c.var_size_font,t[0].local=1,xImprimirAhora(e,t,i,xLocal_xDtSubTotales,function(e){0!=e&&(xPopupLoad.titulo="Imprimiendo...",xPopupLoad.xopen(),setTimeout(function(){xPopupLoad.xclose()},3e3))}));for(var l=0;l<s.length;l++){o=s[l].idimpresora,d=new Array,r++;for(var m=0;m<i.length;m++)null!=i[m]&&$.map(i[m],function(e,t){"object"==typeof e&&o==e.idimpresora&&(void 0===d[m]&&(d[m]={des:i[m].des,id:i[m].id,titlo:i[m].titulo}),d[m][e.iditem]=e)});0!=d.length&&(n++,xArmarSubtotalesArray(d,t),t[0].ip_print=s[l].ip,t[0].var_margen_iz=s[l].var_margen_iz,t[0].var_size_font=s[l].var_size_font,t[0].local=0,xImprimirAhora(e,t,d,xLocal_xDtSubTotales,function(e){s.length==r&&0==e?(setTimeout(function(){try{xNuevoPedidoMP()}catch(e){return!1}},2700),a&&a(!0)):a&&a(!1)}))}0==n&&a&&a(!0)}function xImprimirAhora(e,t,i,a,o){xPopupLoad.titulo="Imprimiendo...";var d=parseInt(xm_log_get("datos_org_sede")[0].sys_local),r=(e.nom_us=xm_log_get("app3_us").nomus,{Array_enca:e,Array_print:t,ArrayItem:i,ArraySubTotales:a});1===d?(xPopupLoad.xopen(),xSendDataPrintServer(r,1,"pre cuenta"),setTimeout(()=>(xPopupLoad.xclose(),o(!1)),1e3)):$.ajax({type:"POST",url:"../../print/print3.php",data:{Array_enca:e,Array_print:t,ArrayItem:i,ArraySubTotales:a}}).done(function(e){return-1!=e.indexOf("Error")?(xPopupLoad.xclose(),$("#print_error").text(e),xErrorPrint=!0,dialog_erro_print.open()):(xErrorPrint=!1,xPopupLoad.titulo="Imprimiendo...",xPopupLoad.xopen(),setTimeout(function(){xPopupLoad.xclose()},3e3)),o(xErrorPrint)})}function xBuscarCantidadPorSeccionArray(e,i,t){var a=0;return null!=t[e]&&$.map(t[e],function(e,t){"object"==typeof e&&null!=e&&e.idseccion==i&&(a=parseFloat(a)+parseFloat(e.cantidad))}),a}function xCargarCategoriaActual(e){for(var t=xm_log_get("categorias"),i=0;i<t.length;i++)xMenuCategoria={id:t[i].idcategoria,des:t[i].descripcion};return 1==t.length&&t[0].idcategoria,e(t)}function xGeneralLoadItems(e,t){localStorage.removeItem("::app3_listSubItem"),$.ajax({type:"POST",url:"../../bdphp/log.php?op=205",data:{idcategoria:e}}).done(function(e){e=JSON.parse(e);if(xGeneralDataCarta=e.datos,t)return t(xGeneralDataCarta)})}async function xGeneralLoadItemsAddItem(e){localStorage.removeItem("::app3_listSubItem");e=await $.ajax({type:"POST",url:"../../bdphp/log.php?op=205",data:{idcategoria:e}}),e=JSON.parse(e);return xGeneralDataCarta=e.datos}function xLimpiarItemSeleccionadosSubItems(){xGeneralDataCarta.filter(e=>e.subitems_selected).map(e=>{e.subitems_selected=[]})}function xLimpiarItemIndicaciones(){xGeneralDataCarta.filter(e=>e.indicaciones).map(e=>{e.indicaciones="",e.xindicaciones=""})}function xGeneralSeccionMiPedido(t,i){if(localStorage.getItem("::app3_sys_last_cat_load")===t&&void 0!==xGeneralDataSeccion)return i(!1);$.ajax({type:"POST",url:"../../bdphp/log.php?op=2041",data:{idcategoria:t}}).done(function(e){e=JSON.parse(e);if(e.success)return xGeneralDataSeccion=e.datos,localStorage.setItem("::app3_sys_last_cat_load",t),i?i(xGeneralDataSeccion):void 0;alert(e.error)})}function xDisparaEventoLoadItemCambioBd(){clearInterval(xGeneralRelojUpdateItemsCambioBd),xGeneralRelojUpdateItemsCambioBd=setInterval(function(){xGeneralActualizarLoadItemCambioBd()},2e4)}function xGeneralActualizarLoadItemCambioBd(){$.ajax({type:"POST",url:"../../bdphp/log.php?op=3012"}).done(function(e){xGeneralNumPedidosActual!=(xNumPedidosBD=e)&&(xGeneralNumPedidosActual=1,xGeneralLoadItems())})}function xDisparaEventoLoadItemInactividad(){clearInterval(xGeneralRelojUpdateItemsSolo),xGeneralRelojUpdateItemsSolo=setInterval(function(){xGeneralActualizaItemInactividad()},11e4)}function xGeneralActualizaItemInactividad(){var i=!0;if(null!=xArrayPedidoObj)for(var e=0;e<xArrayPedidoObj.length&&(null==xArrayPedidoObj[e]||($.map(xArrayPedidoObj[e],function(e,t){"object"==typeof e&&(i=!1)}),i));e++);i&&(1==xDisparaUpdateItems.cancelBubble&&(xDisparaUpdateItems=new Event("GeneralUpdateItemsSolo")),document.dispatchEvent(xDisparaUpdateItems))}function xGeneralValidarRegalasCarta(e,t){var i=xm_log_get("reglas_de_carta"),a="",c=0;if(xVerificarImprimirComanda=!1,null!=xArrayPedidoObj)for(var o=0;o<xArrayPedidoObj.length;o++)null!=xArrayPedidoObj[o]&&$.map(xArrayPedidoObj[o],function(e,t){"object"==typeof e&&(e.precio_print="",e.precio_total_calc=e.precio_total)});if(t){var s=e;for(xi in i){a=i[xi].idseccion,m=i[xi].idseccion_detalle,c=xObtnerValSumArray(s,a),xCantidadBuscarSecc_detalle=xObtnerValSumArray(s,m),l=(l=c-xCantidadBuscarSecc_detalle)<0?c:l;for(o=0;o<s.length;o++)if(null!=s[o]){if(c<=0)break;$.map(s[o],function(e,t){var i,a,o,d,r,n;"object"==typeof e&&(d=e.idseccion,i=e.iditem,a=e.idtipo_consumo,o=parseFloat(e.precio_total_calc),n=xMoneda(o),0!==o)&&d===m&&(d=e.cantidad,c>=xCantidadBuscarSecc_detalle?n="0.00":0<l&&(r=e.precio,n=(n=o-(n=parseFloat(parseFloat(l*r))))<0?"0.00":xMoneda(n),l=l-d<0?0:l-d),e.precio_total_calc=n,e.precio_print=n,e.cant_descontado=d,s[a][i].precio_print=n,xArrayPedidoObj[a][i].precio_print=n)})}}return s}for(var d=$(e),r=0;r<i.length;r++){var l,a=i[r].idseccion,m=i[r].idseccion_detalle;0!==(c=xObtnerValSumTable($(d),"data-idbus",a,"#cant_descontar"))&&(xCantidadBuscarSecc_detalle=xObtnerValSumTable($(d),"data-idbus",m,"#cant_descontar"),l=(l=c-xCantidadBuscarSecc_detalle)<0?c:l,$(d).find(".row").each(function(e,t){var i,a=$(t).attr("data-idbus"),o=$(t).attr("data-id"),d=$(t).attr("data-idtipocobus"),r=parseFloat($(t).find("#ptotal").text()),n=xMoneda(r);0!==r&&a===m&&(a=parseInt($(t).find("#cant_descontar").text()),c>=xCantidadBuscarSecc_detalle?n="0.00":0<l&&(i=parseFloat($(t).find("#punitario").text()),n=(n=r-(n=parseFloat(parseFloat(l*i))))<0?"0.00":xMoneda(n),l=l-a<0?0:l-a),$(t).find("#ptotal").text(n),$(t).attr("cant_descontado",a),xArrayPedidoObj[d][o].precio_print=n)}))}}function xGeneralSumarTotales(e){var t=new Array,i=0,a=0;null==e&&(e=xArrayPedidoObj);for(var o=0;o<e.length;o++)null!=e[o]&&$.map(e[o],function(e,t){"object"==typeof e&&(a=""==e.precio_print?e.precio_total:e.precio_print,i=parseFloat(i)+parseFloat(a))});var d,r,n=xm_log_get("sede_generales"),c="",s="",l="",m=0;(xGeneralArraySubTotales=new Array).push({descripcion:"Sub Total",importe:xMoneda(i),visible:!0});for(var p=0;p<n.length;p++)if(""!=(c=n[p].des_detalle)&&(d=parseFloat(parseFloat(n[p].porcentaje)/100).toFixed(2),d=parseFloat(parseFloat(i)*parseFloat(d)).toFixed(2),s=String(s+'<tr class="row"><td data-ColumName="descripcion" class="xPedidoSubTotal">'+c+'</td><td data-ColumName="importe" align="right">'+d+'</td><td class="xInvisible" data-ColumName="estado">0</td><td class="xInvisible" data-ColumName="idpedido">?p</td></tr>'),xGeneralArraySubTotales.push({descripcion:xMayusculaPrimera(c.toLowerCase()),importe:xMoneda(d),visible:!0}),i=parseFloat(i)+parseFloat(d)),""!=(r=n[p].ad_idtp_consumo)){for(var _,u=(u=n[p].ad_idseccion).split(","),x=0,b=0;b<u.length;b++)_=u[b],x=parseFloat(x)+xBuscarCantidadPorSeccion(r,_);0!=x&&(m=parseInt(m)+parseFloat(x)*parseFloat(n[p].ad_importe),m=xMoneda(m),l=String(l+'<tr class="row"><td><div class="xPedidoSubTotal" data-iddes="'+xGeneralArraySubTotales.length+'" data-importe="'+m+'"><paper-checkbox class="noselect" onchange="xNoCobrarSubTotal(this);" checked title="no cobrar" id="check'+n[p].ad_descripcion+'">'+n[p].ad_descripcion+'</paper-checkbox></div></td><td class="xInvisible" data-ColumName="descripcion">'+n[p].ad_descripcion+'</td><td data-ColumName="importe" align="right">'+m+'</td><td class="xInvisible" data-ColumName="estado" id="td_estado_subt">0</td></tr>'),xGeneralArraySubTotales.push({descripcion:xMayusculaPrimera(n[p].ad_descripcion.toLowerCase()),importe:m,visible:!0}),i=parseFloat(i)+parseFloat(m))}return(xGeneralArraySubTotales=1==xGeneralArraySubTotales.length?new Array:xGeneralArraySubTotales).push({descripcion:"Total",importe:xMoneda(i),visible:!0}),s=s+l+'<tr class="row xBold"><td class="xInvisible" data-ColumName="descripcion">TOTAL</td><td class="xInvisible" data-ColumName="importe" id="td_total_subt_2">'+xMoneda(i)+'</td><td colspan="2" align="right" class="xPedidoTotal xSinBorde"><h3 class="xBold" id="td_total_subt">'+xMoneda(i)+'</h3></td><td class="xInvisible" data-ColumName="estado">0</td></tr>',t.push({ImporteTotal:i,CadenaRow:s}),t}function xGeneralArmarSubTotalesBD(e,n){var c="";$.ajax({type:"POST",url:"../../bdphp/log.php?op=2052",data:{m:e}}).done(function(e){if((t=$.parseJSON(e)).success){var t,i=(t=t.datos).length,a=0,o=0;xGeneralArraySubTotales=new Array;for(var d=0;d<t.length;d++)0==d&&(a=o=t[d].importe),1<i&&0<d&&(a-=t[d].importe,xGeneralArraySubTotales[d]={descripcion:t[d].descripcion,importe:xMoneda(t[d].importe),visible:!0});1<i?(xGeneralArraySubTotales[0]={descripcion:"Sub Total",importe:xMoneda(a),visible:!0},xGeneralArraySubTotales[i]={descripcion:"Total",importe:xMoneda(o),visible:!0}):xGeneralArraySubTotales[0]={descripcion:"Total",importe:xMoneda(o),visible:!0};for(var r=0;r<xGeneralArraySubTotales.length-1;r++)c=c+'<tr class="row"><td>'+xGeneralArraySubTotales[r].descripcion+'</td><td align="right">'+xGeneralArraySubTotales[r].importe+"</td></tr>";return c=c+'<tr class="row xBold"><td></td><td align="right"><h3 class="xBold">'+xMoneda(o)+"</h3></td></tr>",n?n(c):void 0}alert(t.error)})}function xBuscarCantidadPorSeccion(e,i){var a=0;return $.map(xArrayPedidoObj[e],function(e,t){"object"==typeof e&&null!=e&&e.idseccion==i&&(a=parseFloat(a)+parseFloat(e.cantidad))}),a}function xNoCobrarSubTotal(e){var t=$(e).parent().attr("data-iddes"),i=$(e).parent().attr("data-importe"),a=$("#td_total_subt").text(),o=0;xGeneralArraySubTotales[t].visible=e.checked,a=0==e.checked?(o=1,e.title="cobrar",$(e).addClass("check_red"),xMoneda(parseFloat(a)-parseFloat(i))):(e.title="no cobrar",$(e).removeClass("check_red"),xMoneda(parseFloat(a)+parseFloat(i))),$(e).parents("tr").find("#td_estado_subt").text(o),$("#td_total_subt").text(a),$("#td_total_subt_2").text(a),xGeneralArraySubTotales[xGeneralArraySubTotales.length-1].importe=a}function xArmarArrayDescontarStock(e,t){var i=new Array,a="",o="",d=$(e).attr("data-iddescontar"),r=$(e).attr("data-procede"),n=$(e).attr("data-cant_descontar"),c=parseInt($(e).find(".xcant_li").text()),s=(isNaN(c)&&(c=parseFloat($(e).find("#td_cant").text())),isNaN(parseInt(r))||(r=$(e).attr("data-descontar")),"+"==t&&(c=1),$(e).attr("data-idpedido")),l=$(e).attr("data-idpedidodetalle"),e=parseFloat($(e).attr("data-punitario")),n=n.split(","),d=d.split(",");for(xi in null!=l&&(xsql1="update pedido_detalle set cantidad=cantidad-1, estado=if((cantidad)<=0,1,0), ptotal=format(ptotal-"+e+",2) where idpedido_detalle="+l+"; \r",xsql2="update pedido set total=format(total-"+e+",2),estado=if((total)<=0,3,0) where idpedido="+s+"; \r update pedido_subtotales set importe=format(importe-"+e+",2) where idpedido="+s+" and descripcion='TOTAL'; \r",o=String(xsql1+" "+xsql2)),d)xid_des=d[xi],xcant_des=c,"porcion"==r&&(xcant_des=parseFloat(n[xi])*parseFloat(c)),xcampo_procede="stock=stock"+t+xcant_des,a=a+" update "+r+" set "+(xcampo_procede="carta_lista"==r?"cantidad=if(cantidad='ND','ND',cantidad"+t+xcant_des+")":xcampo_procede)+" where id"+r+"="+xid_des+";\r";return i.push({stock:a,importe:o}),i}function xArmarTipoConsumo(e=0){var t="";for(a in xArrayDesTipoConsumo=JSON.parse(window.localStorage.getItem("::app3_sys_dta_pe")))null!=xArrayDesTipoConsumo[a]&&(t=String(t+'<div class="xpedir_row" data-ventarapida="'+e+'" data-id="'+xArrayDesTipoConsumo[a].id+'"><p>'+xArrayDesTipoConsumo[a].des+'</p><p class="xCant_item"></p><div class="xBtnIz xBtn">-</div><div class="xBtnDe xBtn">+</div></div>'));return t='<div class="xpedir_item">'+t+"</div>"}async function xVerificarStockItemPedidoBefore(){var i=[];const a=xEstructuraItemsJsonComprobante(xArrayPedidoObj,[]).filter(e=>"ND"!=e.stock_actual).filter(e=>parseInt(e.stock_actual)<=5);var e=a.filter(e=>1===parseInt(e.procede)).map(e=>e.id).join(","),t=a.filter(e=>0===parseInt(e.procede)).map(e=>e.id).join(",");return 0===e.length&&0===t.length||(await $.ajax({type:"POST",url:"../../bdphp/log.php?op=3031",data:{i:e,p:t}}).done(function(e){$.parseJSON(e).datos.map(e=>{const t=e.idcarta_lista;_item=a.filter(e=>e.id===t).map(e=>e),parseFloat(_item[0].stock_actual)>parseFloat(e.cantidad)&&(_item[0].stock_actual=parseFloat(e.cantidad),i.push(_item[0]))})}),i)}function xUpdateItemNoStock(e,t){$.ajax({type:"POST",url:"../../bdphp/log.php?op=2301",data:{p_from:e,i:t}}).done(e=>{})}function xSendItemVentaxPesoVR(e){e=e.map(e=>Object.values(e)).filter(e=>3<e.length)[0].filter(e=>"object"==typeof e).filter(e=>"1"===e.venta_x_peso);0!==e.length&&e.map(e=>{"ND"!==e.cantidad&&isSocket&&(e.stock_actual=e.stock_actual-e.cantidad,e={cantidad:e.cantidad,idcarta_lista:e.idcarta_lista,iditem:e.iditem,isalmacen:"0"===e.procede.toString()?1:0,isporcion:e.isporcion,subitems:"string"==typeof e.subitems?JSON.parse(itemPedidos_objItemSelected.subitems):itemPedidos_objItemSelected.subitems,subitems_selected:e.subitems_selected,sumar:!0,venta_x_peso:1},_cpSocketEmitItemModificado(e)),xcantRunSocket=!0})}function updateStockOnOrderCompletion(e){e=e.map(e=>Object.values(e)).filter(e=>3<e.length)[0].filter(e=>"object"==typeof e).filter(e=>"ND"!==e.isporcion).filter(e=>"1"!==e.venta_x_peso);if(0!==e.length){let t=[];e.map(e=>{e.stock_actual=e.stock_actual-e.cantidad;e={cantidad:e.cantidad,idcarta_lista:e.idcarta_lista,iditem:e.iditem,iditem2:e.iditem2,isalmacen:"0"===e.procede.toString()?1:0,isporcion:e.isporcion,subitems:"string"==typeof e.subitems?JSON.parse(itemPedidos_objItemSelected.subitems):itemPedidos_objItemSelected.subitems,subitems_selected:e.subitems_selected,sumar:!0,venta_x_peso:1};t.push(e)}),isSocket&&_cpSocketEmitItemAllModificado(t)}}$(document.body).on("click","#_xSubMenu_body div.xBtn",handlerFnMiPedido),$(document.body).on("click","#_xdlgBody div.xBtn",handlerFnMiPedido),$(document.body).on("click",".subitem-content-resumen div.btnCount",handlerFnMiPedido),$(document.body).on("click","#content_item_pedido div.xBtn_li",e=>handlerFnMiPedidoControl(e)),$(document.body).on("click","#accordion div.xBtn_contet_li2",e=>handlerFnMiPedidoControl(e)),$(document.body).on("click","#accordion div.content_li",function(e){isTouch&&handlerFnMiPedidoControl(e)}),$(document.body).on("click",".list_add_item ul li",function(e){-1<e.target.className.indexOf("xbtn_li_editar")||handlerFnMiPedidoControl(e)}),$(document.body).on("click","#accordion div.xBtn_contet_li2 .input-venta-rapida-mod",e=>{e.target.select(),e.stopPropagation(),e.stopImmediatePropagation()}),$(document.body).on("keyup","#accordion div.xBtn_contet_li2 .input-venta-rapida-mod",e=>{var t=e.target.value;e.target.validity.patternMismatch&&"."!==e.key?e.target.value=e.target.value.slice(0,-1):handlerFnMiPedidoControl(e.target.parentNode,""==t?0:t),e.stopPropagation(),e.stopImmediatePropagation()}),$(document.body).on("keyup",".xMiTextReferencia",function(e){if(xidTipoConsumo){var t=e.target.value;itemPedidos_objItemSelected.indicaciones=t,itemPedidos_objItemSelected.xindicaciones=t;try{xArrayPedidoObj[xidTipoConsumo][xidItem].indicaciones=t}catch(e){}return window.localStorage.setItem("::app3_sys_dta_pe",JSON.stringify(xArrayPedidoObj)),e.stopPropagation(),e.stopImmediatePropagation(),!1}});