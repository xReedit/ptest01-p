var xArrayPedidoObj,xidTipoConsumo,xidItem,xCambioCantidad=!1,xLocal_TotalImporte=0,xErrorPrint=!1,xArrayDesTipoConsumo=[],xVerificarImprimirComanda=!1,xGeneralDataCarta,xGeneralRelojUpdateItemsSolo,xGeneralRelojUpdateItemsCambioBd,xDisparaUpdateItems=new Event("GeneralUpdateItemsSolo"),xGeneralNumPedidosActual=0,xGeneralUpdateSeccion=0,xGeneralDataSeccion,xNumPedidosBD=0,xGeneralArraySubTotales=[],itemPedidos_objItemSelected=[],objOptionItemSelect;let idtipo_precio_selected_vr=0;function xArrayPedidoToCleanObject(t){if(!t||!Array.isArray(t))return{};var i={};for(let e=0;e<t.length;e++)null!==t[e]&&void 0!==t[e]&&(i[e]=t[e]);return i}function handlerFnMiPedido(e){const _thisObj=$(this),_viene_venta_rapida=(xCambioCantidad=!0,xidTipoConsumo=_thisObj.parent().attr("data-id"),parseInt(_thisObj.parent().attr("data-ventarapida"))),_viene_subitems_mod=parseInt(_thisObj.parent().attr("data-viene-subitems-mod"));1==_viene_subitems_mod&&modificarUnSubItem(_thisObj),xidItem=itemPedidos_objItemSelected.idcarta_lista||itemPedidos_objItemSelected.iditem;let precio_producto=itemPedidos_objItemSelected.precio;try{if(0!==idtipo_precio_selected_vr&&""!==itemPedidos_objItemSelected.tipo_precios){itemPedidos_objItemSelected.tipo_precios="string"==typeof itemPedidos_objItemSelected.tipo_precios?JSON.parse(itemPedidos_objItemSelected.tipo_precios):itemPedidos_objItemSelected.tipo_precios;const tipo_precio=itemPedidos_objItemSelected.tipo_precios.filter(e=>e.idtipo_precio===idtipo_precio_selected_vr);0<tipo_precio.length&&(precio_producto=tipo_precio[0].precio)}}catch(error){}var xOperacion=_thisObj.text(),objCant=_thisObj.parent().find(".xCant_item"),objCant_cant=xArrayPedidoObj[xidTipoConsumo]&&xArrayPedidoObj[xidTipoConsumo][xidItem]?xArrayPedidoObj[xidTipoConsumo][xidItem].cantidad:0,xStockActual=itemPedidos_objItemSelected.stock_actual,xidItem2=itemPedidos_objItemSelected.iditem===xidItem&&itemPedidos_objItemSelected.iditem2||itemPedidos_objItemSelected.iditem,xDesItem=itemPedidos_objItemSelected.des_item,xPrecioItem=precio_producto,xIndicaciones=itemPedidos_objItemSelected.xindicaciones,xCantActual=parseInt(objCant_cant),xCantSeccion=parseInt(xArrayPedidoObj[xidTipoConsumo].cantidad),xCantTotalItem=0,xDesSeccion=itemPedidos_objItemSelected.des_seccion||xTituloDet,xIdSeccionItem=itemPedidos_objItemSelected.idseccion,xIdSeccionItem_index=itemPedidos_objItemSelected.idseccion_index,xRowidimpresora=itemPedidos_objItemSelected.idimpresora,xRowidimpresora_otro=itemPedidos_objItemSelected.idimpresora_otro,xRowidporcion=itemPedidos_objItemSelected.idprocede,xRowProcede=itemPedidos_objItemSelected.procede,xRowProcede_index=itemPedidos_objItemSelected.procede_index,ximprmir_comanda=itemPedidos_objItemSelected.imprimir_comanda,xcant_descontar=itemPedidos_objItemSelected.cant_descontar,xidalmacen_items=itemPedidos_objItemSelected.idalmacen_items,xidDescontar=xRowidporcion,xPrecioTotal,xcant_max=void 0!==itemPedidos_objItemSelected.stock_actual&&null!==itemPedidos_objItemSelected.stock_actual?itemPedidos_objItemSelected.stock_actual:1e4,xidcategoria=itemPedidos_objItemSelected.idcategoria,xStockActual=xcant_max,xSotockSocket=xcant_max,xSotockSocketRun=xcant_max,xcantRunSocket=xcant_max,xcant=xCantActual,xsigno=xOperacion,sec_orden=itemPedidos_objItemSelected.sec_orden,subitems_selected_index=itemPedidos_objItemSelected.subitems_selected_index,xCantActual=isNaN(xCantActual)?0:xCantActual,xCantSeccion=isNaN(xCantSeccion)?0:xCantSeccion,xcant=xCantActual;if(0!==parseFloat(xcant_max)||"+"!==xOperacion){if(_thisObj.parents(".xpedir_item").find(".xCant_item").each(function(e,t){t=parseInt($(t).text());isNaN(t)&&(t=0),xCantTotalItem=parseInt(xCantTotalItem)+t}),1===_viene_venta_rapida)"+"==xOperacion?(isSocket?(xSotockSocket=0<xcant_max?parseFloat(xSotockSocket)-1:0,xSotockSocketRun=-1<xcant_max?parseFloat(xSotockSocketRun)-1:0,0<xcant_max&&xcant++):xcant<xcant_max&&xcant++,xcantRunSocket=xcant):(xSotockSocket=0===xcant?xcant_max:parseFloat(xSotockSocket)+1,xSotockSocketRun=0===xcant?xcant_max:parseFloat(xSotockSocketRun)+1,xcant--,xcantRunSocket=xcant,xcant=xcant<=0?0:xcant),xCantActual=xcant,xCount_cant_ico=xcant;else{if(isNaN(xCantTotalItem)&&(xCantTotalItem=0),xCantActual=parseInt(xCantActual)+xOperacion+parseInt(1),xCantTotalItem=parseInt(xCantTotalItem)+xOperacion+parseInt(1),xCount_cant_ico=parseInt(xCount_cant_ico)+xOperacion+parseInt(1),xCantSeccion=parseInt(xCantSeccion)+xOperacion+parseInt(1),xCantActual=eval(xCantActual),xCantTotalItem=eval(xCantTotalItem),xCount_cant_ico=eval(xCount_cant_ico),xCantSeccion=eval(xCantSeccion),xCount_cant_ico<0&&(xCount_cant_ico=0),"ND"!=xStockActual&&xCantTotalItem>parseInt(xStockActual))return;xCantActual<=0?(xCantActual=0,objCant.addClass("xInvisible")):objCant.removeClass("xInvisible")}objCant.text(xCeroIzq(xCantActual,2)),xPrecioTotal=parseFloat(xCantActual*xPrecioItem).toFixed(2);const mySubItemView=checkMySubitemView(xidTipoConsumo,xidItem),isSubItemControlable=!!itemPedidos_objItemSelected?.subitems&&1===parseInt(itemPedidos_objItemSelected.subitems[0].iscontrolable),idSubItemControlable=isSubItemControlable?itemPedidos_objItemSelected.subitems_selected[0].iditem_subitem:0,sumar=(xArrayPedidoObj[xidTipoConsumo].cantidad=xCantSeccion,xArrayPedidoObj[xidTipoConsumo][xidItem]={idcategoria:xidcategoria,idseccion:xIdSeccionItem,idseccion_index:xIdSeccionItem_index,des_seccion:xDesSeccion,sec_orden:sec_orden,iditem:xidItem,idtipo_consumo:xidTipoConsumo,stock_actual:xStockActual,cantidad:xCantActual,precio:xPrecioItem,des:xDesItem,precio_total:xPrecioTotal,precio_total_calc:xPrecioTotal,precio_print:"",indicaciones:xIndicaciones,iditem2:xidItem2,idimpresora:xRowidimpresora,idimpresora_otro:xRowidimpresora_otro,idprocede:xRowidporcion,procede:xRowProcede,procede_index:xRowProcede_index,imprimir_comanda:ximprmir_comanda,iddescontar:xidDescontar,cant_descontar:xcant_descontar,idalmacen_items:xidalmacen_items,visible:0,pwa:isSocket?1:0,isporcion:itemPedidos_objItemSelected.isporcion,precio_unitario:itemPedidos_objItemSelected.precio_unitario,detalle:itemPedidos_objItemSelected.detalle,subitems:itemPedidos_objItemSelected.subitems,subitems_selected:itemPedidos_objItemSelected.subitems_selected,subitem_required_select:itemPedidos_objItemSelected.subitem_required_select,subitem_cant_select:itemPedidos_objItemSelected.subitem_cant_select,subitems_view:itemPedidos_objItemSelected.subitems_view||mySubItemView,isporcion:itemPedidos_objItemSelected.isporcion,iditem_subitem:idSubItemControlable,subitems_selected_index:subitems_selected_index},"+"===xsigno),_objIcoPedido=(xAddSubItemsView(xidTipoConsumo,xidItem,sumar),xCantActual<=0&&delete xArrayPedidoObj[xidTipoConsumo][xidItem],setTimeout(()=>{var e=xArrayPedidoToCleanObject(xArrayPedidoObj);window.localStorage.setItem("::app3_sys_dta_pe",JSON.stringify(e))},0),window.localStorage.setItem("::app3_sys_dta_count_ico",xCount_cant_ico),$("#_xIco_MiPedido .xCantPedio_ico")),isSubItemCantidad=(0<xCount_cant_ico?(_objIcoPedido.text(xCeroIzq(xCount_cant_ico,2)),_objIcoPedido.removeClass("xInvisible")):_objIcoPedido.addClass("xInvisible"),checkExistSubItemsWithCantidad(itemPedidos_objItemSelected));if(("ND"!==itemPedidos_objItemSelected.cantidad||isSubItemCantidad)&&isSocket&&0<=xcantRunSocket&&-1<xSotockSocketRun){itemPedidos_objItemSelected.stock_actual=xSotockSocket;const itemNotifySocket={cantidad:xSotockSocket,idcarta_lista:itemPedidos_objItemSelected.idcarta_lista,iditem:itemPedidos_objItemSelected.iditem,isalmacen:"0"===itemPedidos_objItemSelected.procede.toString()?1:0,isporcion:itemPedidos_objItemSelected.isporcion,subitems:"string"==typeof itemPedidos_objItemSelected.subitems?JSON.parse(itemPedidos_objItemSelected.subitems):itemPedidos_objItemSelected.subitems,subitems_selected:itemPedidos_objItemSelected.subitems_selected,sumar:"+"===xsigno};_cpSocketEmitItemModificado(itemNotifySocket),_cpSocketSavePedidoStorage(xArrayPedidoObj),compItemSumImporte()}xcantRunSocket=!0;const xVistaMiPedido=document.getElementById("mipedido-view");return xVistaMiPedido&&xVistaMiPedido._outLoadPedido(),1==_viene_venta_rapida&&xVerMipedidoVR(),e.stopPropagation(),e.stopImmediatePropagation(),!1}}function checkExistSubItemsWithCantidad(e){return!!e.subitems&&!!Array.isArray(e.subitems)&&e.subitems.some(e=>Array.isArray(e.opciones)&&e.opciones.some(e=>"ND"!==e.cantidad))}async function handlerFnMiPedidoControl(t,i=null){var o="xcant_li",a=t.target||t,d="itempedido"===a.dataset.op,r=(a=d?$(a).parents("tr")[0]:a).dataset.index?a:(a.parentElement.dataset.index?a:(a.parentElement.parentElement.dataset.index?a:a.parentElement).parentElement).parentElement,c=r.dataset,s=c.ventarapida,n=c.index,l=a.dataset.idcategoria;if(d){l&&1!=l&&xGeneralDataCarta[0].idcategoria!=l&&(xGeneralDataCarta=await xGeneralLoadItemsAddItem(l));const N=a.dataset.iditem.toString();xGeneralDataCarta.map((e,t)=>{e.iditem.toString()===N&&(n=t)})}else n=c.index;if(xidTipoConsumo=$("#select_ulTPC option:selected").val(),itemPedidos_objItemSelected=xGeneralDataCarta[n],1==s&&(o="xcant_li2",isShowOpcionesPrimero)&&itemPedidos_objItemSelected.subitems&&"0"!==itemPedidos_objItemSelected.subitems)xCompSubitems.openDialog(null,n);else{xidItem=itemPedidos_objItemSelected.idcarta_lista;var r=r.getElementsByClassName(o),r=$(r),o="+"!=a.textContent&&"-"!=a.textContent?c.signo:a.textContent,o=d?"+":o,c=xArrayPedidoObj[xidTipoConsumo]&&xArrayPedidoObj[xidTipoConsumo][xidItem]?xArrayPedidoObj[xidTipoConsumo][xidItem].cantidad:0,a=null!==i?i:parseInt(c),c=void 0!==itemPedidos_objItemSelected.stock_actual&&null!==itemPedidos_objItemSelected.stock_actual?itemPedidos_objItemSelected.stock_actual:1e4,m=xidTipoConsumo,p=xidItem;let e=itemPedidos_objItemSelected.precio;try{0!==idtipo_precio_selected_vr&&""!==itemPedidos_objItemSelected.tipo_precios&&(itemPedidos_objItemSelected.tipo_precios="string"==typeof itemPedidos_objItemSelected.tipo_precios?JSON.parse(itemPedidos_objItemSelected.tipo_precios):itemPedidos_objItemSelected.tipo_precios,0<(_=itemPedidos_objItemSelected.tipo_precios.filter(e=>e.idtipo_precio===idtipo_precio_selected_vr)).length)&&(e=_[0].precio)}catch(e){}var _=itemPedidos_objItemSelected.des_item,u=itemPedidos_objItemSelected.indicaciones||"",x=e,b=itemPedidos_objItemSelected.idimpresora,S=itemPedidos_objItemSelected.idimpresora_otro,I=itemPedidos_objItemSelected.idprocede,P=itemPedidos_objItemSelected.procede,f=itemPedidos_objItemSelected.procede_index,j=itemPedidos_objItemSelected.idseccion,v=itemPedidos_objItemSelected.idseccion_index,y=itemPedidos_objItemSelected.des_seccion,g=itemPedidos_objItemSelected.iditem===xidItem&&itemPedidos_objItemSelected.iditem2||itemPedidos_objItemSelected.iditem,C=itemPedidos_objItemSelected.imprimir_comanda,A=itemPedidos_objItemSelected.cant_descontar,l=itemPedidos_objItemSelected.idcategoria||l,h=itemPedidos_objItemSelected.idalmacen_items,O=c,k=c,T=c,w=c,F=itemPedidos_objItemSelected.sec_orden,d=(null!==i?a=i:"+"==o?(!isSocket||d?a<c&&a++:(k=0<c?parseFloat(k)-1:0,T=-1<c?parseFloat(T)-1:0,0<c&&a++),w=a):(k=0===a?c:parseFloat(k)+1,T=0===a?c:parseFloat(T)+1,a=(w=--a)<=0?0:a),i=parseFloat(parseFloat(x)*parseFloat(a)).toFixed(2),checkMySubitemView(m,m));if(xArrayPedidoObj[m][p]={idcategoria:l,idseccion:j,idseccion_index:v,sec_orden:F,des_seccion:y,iditem:p,idtipo_consumo:m,stock_actual:O,cantidad:a,precio:x,des:_,precio_total:i,precio_total_calc:i,precio_print:i,indicaciones:u,iditem2:g,idimpresora:b,idimpresora_otro:S,idprocede:I,procede:P,procede_index:f,imprimir_comanda:C,cant_descontar:A,idalmacen_items:h,visible:0,pwa:isSocket?1:0,isporcion:itemPedidos_objItemSelected.isporcion,precio_unitario:itemPedidos_objItemSelected.precio_unitario,detalle:itemPedidos_objItemSelected.detalle,subitems:itemPedidos_objItemSelected.subitems,subitems_selected:itemPedidos_objItemSelected.subitems_selected,subitem_required_select:itemPedidos_objItemSelected.subitem_required_select,subitem_cant_select:itemPedidos_objItemSelected.subitem_cant_select,subitems_view:itemPedidos_objItemSelected.subitems_view||d,isporcion:itemPedidos_objItemSelected.isporcion,venta_x_peso:itemPedidos_objItemSelected.venta_x_peso,idcarta_lista:itemPedidos_objItemSelected.idcarta_lista},r.text(a),1==s&&xVerMipedidoVR(),$(r).hasClass("input-modifica")&&0!==a&&$(r).val(a),1==s&&"1"==itemPedidos_objItemSelected.venta_x_peso)try{t.stopPropagation(),t.stopImmediatePropagation()}catch(e){}else{a<=0?(a=0,r.removeClass("cant_fixed_li"),delete xArrayPedidoObj[m][p]):r.addClass("cant_fixed_li"),"ND"!==itemPedidos_objItemSelected.cantidad&&isSocket&&0<=w&&-1<T&&(c={cantidad:itemPedidos_objItemSelected.stock_actual=k,idcarta_lista:itemPedidos_objItemSelected.idcarta_lista,iditem:itemPedidos_objItemSelected.iditem,isalmacen:"0"===itemPedidos_objItemSelected.procede.toString()?1:0,isporcion:itemPedidos_objItemSelected.isporcion,subitems:"string"==typeof itemPedidos_objItemSelected.subitems?JSON.parse(itemPedidos_objItemSelected.subitems):itemPedidos_objItemSelected.subitems,subitems_selected:itemPedidos_objItemSelected.subitems_selected,sumar:"+"===o},_cpSocketEmitItemModificado(c),_cpSocketSavePedidoStorage(xArrayPedidoObj)),w=!0;try{t.stopPropagation(),t.stopImmediatePropagation()}catch(e){}}}}function xNotifyItemModificado(e){e.cantidad,objItem.parent().attr("data-idcarta_lista"),objItem.parent().attr("data-iditem"),objItem.parent().attr("data-procede"),objItem.parent().attr("data-isporcion")}function checkMySubitemView(e,t){try{return xArrayPedidoObj[e][t].subitems_view||null}catch(e){return null}}function xSendItemBySocket(e){e={cantidad:xSotockSocket,idcarta_lista:itemPedidos_objItemSelected.idcarta_lista,iditem:itemPedidos_objItemSelected.iditem,isalmacen:"0"===itemPedidos_objItemSelected.procede.toString()?1:0,isporcion:itemPedidos_objItemSelected.isporcion,subitems:"string"==typeof itemPedidos_objItemSelected.subitems?JSON.parse(itemPedidos_objItemSelected.subitems):itemPedidos_objItemSelected.subitems,subitems_selected:itemPedidos_objItemSelected.subitems_selected,sumar:"+"===e};_cpSocketEmitItemModificado(e),_cpSocketSavePedidoStorage(xArrayPedidoObj),compItemSumImporte()}function modificarUnSubItem(e){var t=(e=e.parents("tr")[0]).dataset.idtipo_consumo,i=e.dataset.idcarta_lista;const o=e.dataset.idsubitem;e=e.dataset.index,t=xArrayPedidoObj[t][i],i=t.subitems_view.filter(e=>e.id===o)[0].subitems;t.subitems_selected=[],t.subitems_selected=i,t.subitems_selected_index=e,(itemPedidos_objItemSelected=t).des_item=t.des,itemPedidos_objItemSelected.idcarta_lista=t.iditem,itemPedidos_objItemSelected.subitems_selected_index=e}function xAddSubItemsView(e,t,i){var o,a,d=xArrayPedidoObj[e][t];d.subitems_view=d.subitems_view||[],d.subitems&&0!==d.subitems.length&&(o={id:"",des:[],cantidad_seleccionada:0,precio:0,indicaciones:"",subitems:[]},d.subitems_selected&&0<d.subitems_selected.length?(d.subitems_selected.map(e=>{o.id+=e.iditem_subitem.toString(),o.des.push(primeraConMayusculas(e.des.toLowerCase().trim())),o.cantidad_seleccionada=1,o.precio+=parseFloat(e.precio),o.indicaciones+=void 0===e.indicaciones?"":" ("+e.indicaciones+")",o.indicaciones_item=d.indicaciones,o.subitems.push(e)}),o.des=o.des.join(","),o.des+=void 0===d.indicaciones?"":",("+d.indicaciones+")",d.indicaciones="",d.subitems_view=d.subitems_view||[],a=d.subitems_view.filter(e=>e.id===o.id&&e.indicaciones_item===o.indicaciones_item)[0],(a=d.subitems_selected_index?d.subitems_view[parseInt(d.subitems_selected_index)]:a)?i?(a.indicaciones+=o.indicaciones,a.cantidad_seleccionada+=1,a.precio+=o.precio):this.restarCantSubItemView(d,a):i?(d.subitems_view.push(o),xArrayPedidoObj[e][t].subitems_view=d.subitems_view):this.restarCantSubItemView(d,null)):this.restarCantSubItemView(d,null),this.addPrecioItemMiPedido(d))}function restarCantSubItemView(e,t=null){var i;t?(i=t.precio/t.cantidad_seleccionada,--t.cantidad_seleccionada,t.precio-=i,t.precio=t.precio<0?0:t.precio,t.cantidad_seleccionada<=0&&(e.subitems_view=e.subitems_view.filter(e=>0<e.cantidad_seleccionada))):(i=e.subitems_view.length,(t=e.subitems_view[i-1])&&(i=t.precio/t.cantidad_seleccionada,t.cantidad_seleccionada--,t.precio-=i,t.cantidad_seleccionada<=0&&(e.subitems_view=e.subitems_view.filter(e=>0<e.cantidad_seleccionada)),e.subitems_selected=t.subitems))}function addPrecioItemMiPedido(e){e.cantidad_seleccionada=e.cantidad;var t=e.subitems_view?e.subitems_view.map(e=>parseFloat(e.precio)).reduce((e,t)=>e+t,0):0,i=e.cantidad*parseFloat(e.precio_unitario),i=parseFloat(i+t).toFixed(2);e.precio_total=i,e.precio_print=i}function xBtnSumarRestarKey(e,t){t=0<t?".suma":".resta";handlerFnMiPedidoControl($(e).parent().find(t)[0])}function xEstructuraExpress(e,t,i){t="1"===t.toString(),i="1"===i.toString();var i=[],o={tipoconsumo:[]},a={titulo:"",secciones:[],descripcion:"",idtipo_consumo:"",count_items_seccion:1,cantidad_seleccionada:1};if(t){var d,r=[],c=[],s=!1,n=!1;for(const p in e)if(e.hasOwnProperty(p)){var l,m=e[p];(a={titulo:"",secciones:[],descripcion:"",idtipo_consumo:"",count_items_seccion:1,cantidad_seleccionada:1}).descripcion=m.des,a.titulo=m.titulo,a.idtipo_consumo=m.id,n=!1,r=[];for(const _ in m)m.hasOwnProperty(_)&&"object"==typeof(l=m[_])&&(d=l.idseccion,s=!(n=!0),(c=r.filter(e=>e.idseccion===d)[0])||(s=!0,c={des:l.des_seccion,idseccion:l.idseccion,sec_orden:1,count_items:1,idimpresora:l.idimpresora,ver_stock_cero:l.visible,items:[]}),c.items.push({des:l.des,img:"",sumar:!1,iditem:l.iditem,precio:l.precio,procede:l.procede,seccion:l.des_seccion,visible:!0,cantidad:l.cantidad,detalles:l.detalle,selected:!0,subitems:l.subitems,isalmacen:l.idalmacen_items,idseccion:l.idseccion,isporcion:l.isporcion,sec_orden:1,des_seccion:l.des_seccion,idimpresora:l.idimpresora,precio_print:l.precio_total,precio_total:l.precio_total,idcarta_lista:l.iditem,subitems_view:l.subitems_view,precio_default:l.precio,ver_stock_cero:0,precio_unitario:l.precio_unitario,imprimir_comanda:l.imprimir_comanda,itemtiposconsumo:[],precio_total_calc:l.precio_total_calc,subitems_selected:[],subitem_cant_select:l.subitem_cant_select,cantidad_seleccionada:l.cantidad,subitem_required_select:l.subitem_required_select}),s)&&r.push(c);n&&(a.secciones=r,o.tipoconsumo.push(a))}i=0<o.tipoconsumo.length?o:[]}return i}function xChangeTipoConsumoItems(t){const o=xArrayPedidoObj.filter(e=>e).filter(e=>e.id===t)[0];xArrayPedidoObj.filter(e=>e).filter(e=>e.id!==t).map(e=>{for(const i in e){var t;e.hasOwnProperty(i)&&"object"==typeof(t=e[i])&&(t.idtipo_consumo=o.id,o[i]=t,delete e[i])}}),xVerMipedidoVR()}function xClassEstadoItem(e){var t="",i="";return"ND"==e?(t="xEstadoVerde",i="xFondoColorVerde"):(5<(e=parseInt(e))&&(t="xEstadoAmarillo",i="xFondoColorAmarillo"),10<=e&&(t="xEstadoVerde",i="xFondoColorVerde"),e<=5&&(t="xEstadoAmbar",i="xFondoColorAmbar"),e<=0&&(t="xEstadoRojo",i="xFondoColorRojo")),t+"|"+i}function xLoadArrayPedido(){setTimeout(()=>{var e=xArrayPedidoToCleanObject(xArrayPedidoObj);window.localStorage.setItem("::app3_sys_dta_pe",JSON.stringify(e))},0);try{if(null!==xArrayPedidoObj&&0<Object.keys(xArrayPedidoObj).length)return}catch(e){}xArrayDesTipoConsumo=[],xArrayPedidoObj=[],xm_log_get("estructura_pedido").map(e=>{var t=e.idtipo_consumo;xArrayPedidoObj[t]={id:e.idtipo_consumo,des:e.descripcion,titulo:e.titulo},xArrayDesTipoConsumo.push({id:e.idtipo_consumo,des:e.descripcion,titulo:e.titulo})}),setTimeout(()=>{var e=xArrayPedidoToCleanObject(xArrayPedidoObj);window.localStorage.setItem("::app3_sys_dta_pe",JSON.stringify(e))},0)}function xVerificarSiSeImprimeComanda(e){null==e&&(e=xArrayPedidoObj),xVerificarImprimirComanda=!1;for(var t=0;t<e.length;t++)null!=e[t]&&$.map(e[t],function(e,t){"object"==typeof e&&0!=e.cantidad&&1==e.imprimir_comanda&&(xVerificarImprimirComanda=!0)})}function xObtnerValSumArray(e,i){for(var o=0,t=0;t<e.length;t++)null!=e[t]&&$.map(e[t],function(e,t){"object"==typeof e&&e.idseccion===i&&(o=parseFloat(o)+parseFloat(e.cantidad))});return o}function xObtnerValSumTable(e,i,o,a){var d=0;return $(e).find(".row").each(function(e,t){$(t).attr(i)===o&&(d=parseFloat(d)+parseFloat($(t).find(a).text()))}),parseInt(d)}function xSumaCantArray(e){for(var c=0,t=0;t<e.length;t++)null!=e[t]&&$.map(e[t],function(o,e){if("object"==typeof o){var a=parseFloat(o.precio),d=!!o.subitems_view;let e=o.cantidad,t=0;t=-1<e.toString().indexOf(",")?(e=(e=e.split(",")).reduce((e,t)=>parseFloat(e)+parseFloat(t)),parseFloat(o.ptotal)):(e=parseFloat(o.cantidad),parseFloat(parseFloat(e*a).toFixed(2)));var r=""===o.precio_print?parseFloat(o.precio_total_calc):parseFloat(o.precio_print);let i=(r>t&&!d?a:r).toFixed(2);""===i&&(i=o.precio_total_calc),c+=parseFloat(i)}});return c}function xMandarImprimirOtroDoc(e,t,i,o){for(var a=xm_log_get("app3_woIpPrint"),d=xm_log_get("app3_woIpPrintO"),r=window.localStorage.getItem("::app3_woIpPrintLo"),c=o,s=!1,n=0;n<d.length;n++)if(-1==d[n].idtipo_otro){c=d[n].idimpresora;break}if(null!=r&&""!=r)r=$.parseJSON(r),t[0].ip_print=r.ip,t[0].var_margen_iz=r.var_margen_iz,t[0].var_size_font=r.var_size_font,t[0].papel_size=r.papel_size,t[0].num_copias=r.num_copias,t[0].local=1,s=!0;else for(n=0;n<a.length;n++)if(a[n].idimpresora==c){s=!0,c=a[n].ip,t[0].ip_print=c,t[0].var_margen_iz=a[n].var_margen_iz,t[0].var_size_font=a[n].var_size_font,t[0].papel_size=a[n].papel_size,t[0].num_copias=a[n].num_copias,t[0].copia_local=a[n].copia_local,t[0].local=0;break}return 0!=s&&0!=i.length&&(xArmarSubtotalesArray(i,t),void xImprimirAhora(e,t,i,xLocal_xDtSubTotales,function(e){0!=e&&(xPopupLoad.titulo="Imprimiendo...",xPopupLoad.xopen(),setTimeout(function(){xPopupLoad.xclose()},3e3))}))}function xMandarImprimirOtroDoc(e,t,i,o,a,d=!1){var r=xm_log_get("app3_woIpPrint"),c=xm_log_get("app3_woIpPrintO"),s=window.localStorage.getItem("::app3_woIpPrintLo"),n=a,l=!1;-1===a&&(d="1"==xm_log_get("sede_generales")[0].isprint_cpe_short);for(var m=t[0].var_size_font_tall_comanda=0;m<c.length;m++)if(c[m].idtipo_otro==a){n=c[m].idimpresora;break}if(null!=s&&""!=s)s=$.parseJSON(s),t[0].ip_print=s.ip,t[0].var_margen_iz=s.var_margen_iz,t[0].var_size_font=s.var_size_font,t[0].papel_size=s.papel_size,t[0].num_copias=s.num_copias,t[0].local=1,l=!0;else for(m=0;m<r.length;m++)if(r[m].idimpresora==n){l=!0,n=r[m].ip,t[0].ip_print=n,t[0].var_margen_iz=r[m].var_margen_iz,t[0].var_size_font=r[m].var_size_font,t[0].papel_size=r[m].papel_size,t[0].num_copias=r[m].num_copias,t[0].copia_local=r[m].copia_local,t[0].local=0;break}return 0!=l&&0!=i.length&&(d&&(i=xEstructuraItemsJsonComprobante(i,o,!1,!0),i=xEstructuraItemsAgruparPrintJsonComprobante(i)),void xImprimirAhora(e,t,i,o,function(e){0!=e&&(xPopupLoad.titulo="Imprimiendo...",xPopupLoad.xopen(),setTimeout(function(){xPopupLoad.xclose()},3e3))}))}function xMandarImprimir(e,t,i,o){var a,d=new Array,r=0,c=0,s=window.localStorage.getItem("::app3_woIpPrintLo"),n=xm_log_get("app3_woIpPrint");null!=s&&""!=s&&(s=$.parseJSON(s),xArmarSubtotalesArray(i,t),t[0].ip_print=s.ip,t[0].var_margen_iz=s.var_margen_iz,t[0].var_size_font=s.var_size_font,t[0].local=1,xImprimirAhora(e,t,i,xLocal_xDtSubTotales,function(e){0!=e&&(xPopupLoad.titulo="Imprimiendo...",xPopupLoad.xopen(),setTimeout(function(){xPopupLoad.xclose()},3e3))}));for(var l=0;l<n.length;l++){a=n[l].idimpresora,d=new Array,r++;for(const m in i)if(i.hasOwnProperty(m)){const p=m;$.map(i[p],function(e,t){"object"==typeof e&&a==e.idimpresora&&(void 0===d[p]&&(d[p]={des:i[p].des,id:i[p].id,titlo:i[p].titulo}),d[p][e.iditem]=e)})}0!=Object.keys(d).length&&(c++,xArmarSubtotalesArray(d,t),t[0].ip_print=n[l].ip,t[0].var_margen_iz=n[l].var_margen_iz,t[0].var_size_font=n[l].var_size_font,t[0].local=0,xImprimirAhora(e,t,d,xLocal_xDtSubTotales,function(e){n.length==r&&0==e?(setTimeout(function(){try{xNuevoPedidoMP()}catch(e){return!1}},2700),o&&o(!0)):o&&o(!1)}))}0==c&&o&&o(!0)}function xImprimirAhora(e,t,i,o,a){xPopupLoad.titulo="Imprimiendo...";var d=parseInt(xm_log_get("datos_org_sede")[0].sys_local),r=(e.nom_us=xm_log_get("app3_us").nomus,{Array_enca:e,Array_print:t,ArrayItem:i,ArraySubTotales:o});1===d?(xPopupLoad.xopen(),xSendDataPrintServer(r,1,"pre cuenta"),setTimeout(()=>(xPopupLoad.xclose(),a(!1)),1e3)):$.ajax({type:"POST",url:"../../print/print3.php",data:{Array_enca:e,Array_print:t,ArrayItem:i,ArraySubTotales:o}}).done(function(e){return-1!=e.indexOf("Error")?(xPopupLoad.xclose(),$("#print_error").text(e),xErrorPrint=!0,dialog_erro_print.open()):(xErrorPrint=!1,xPopupLoad.titulo="Imprimiendo...",xPopupLoad.xopen(),setTimeout(function(){xPopupLoad.xclose()},3e3)),a(xErrorPrint)})}function xBuscarCantidadPorSeccionArray(e,i,t){var o=0;return null!=t[e]&&$.map(t[e],function(e,t){"object"==typeof e&&null!=e&&e.idseccion==i&&(o=parseFloat(o)+parseFloat(e.cantidad))}),o}function xCargarCategoriaActual(e){for(var t=xm_log_get("categorias"),i=0;i<t.length;i++)xMenuCategoria={id:t[i].idcategoria,des:t[i].descripcion};return 1==t.length&&t[0].idcategoria,e(t)}function xGeneralLoadItems(e,t){localStorage.removeItem("::app3_listSubItem"),$.ajax({type:"POST",url:"../../bdphp/log.php?op=205",data:{idcategoria:e}}).done(function(e){e=JSON.parse(e);if(xGeneralDataCarta=e.datos,t)return t(xGeneralDataCarta)})}async function xGeneralLoadItemsAddItem(e){localStorage.removeItem("::app3_listSubItem");e=await $.ajax({type:"POST",url:"../../bdphp/log.php?op=205",data:{idcategoria:e}}),e=JSON.parse(e);return xGeneralDataCarta=e.datos}function xLimpiarItemSeleccionadosSubItems(){xGeneralDataCarta.filter(e=>e.subitems_selected).map(e=>{e.subitems_selected=[]})}function xLimpiarItemIndicaciones(){xGeneralDataCarta.filter(e=>e.indicaciones).map(e=>{e.indicaciones="",e.xindicaciones=""})}function xGeneralSeccionMiPedido(t,i){if(localStorage.getItem("::app3_sys_last_cat_load")===t&&void 0!==xGeneralDataSeccion)return i(!1);$.ajax({type:"POST",url:"../../bdphp/log.php?op=2041",data:{idcategoria:t}}).done(function(e){e=JSON.parse(e);if(e.success)return xGeneralDataSeccion=e.datos,localStorage.setItem("::app3_sys_last_cat_load",t),i?i(xGeneralDataSeccion):void 0;alert(e.error)})}function xDisparaEventoLoadItemCambioBd(){clearInterval(xGeneralRelojUpdateItemsCambioBd),xGeneralRelojUpdateItemsCambioBd=setInterval(function(){xGeneralActualizarLoadItemCambioBd()},2e4)}function xGeneralActualizarLoadItemCambioBd(){$.ajax({type:"POST",url:"../../bdphp/log.php?op=3012"}).done(function(e){xGeneralNumPedidosActual!=(xNumPedidosBD=e)&&(xGeneralNumPedidosActual=1,xGeneralLoadItems())})}function xDisparaEventoLoadItemInactividad(){clearInterval(xGeneralRelojUpdateItemsSolo),xGeneralRelojUpdateItemsSolo=setInterval(function(){xGeneralActualizaItemInactividad()},11e4)}function xGeneralActualizaItemInactividad(){var i=!0;if(null!=xArrayPedidoObj)for(const e in xArrayPedidoObj)if(xArrayPedidoObj.hasOwnProperty(e)&&($.map(xArrayPedidoObj[e],function(e,t){"object"==typeof e&&(i=!1)}),!i))break;i&&(1==xDisparaUpdateItems.cancelBubble&&(xDisparaUpdateItems=new Event("GeneralUpdateItemsSolo")),document.dispatchEvent(xDisparaUpdateItems))}function xGeneralValidarRegalasCarta(e,t){var i=xm_log_get("reglas_de_carta"),o="",s=0;if(xVerificarImprimirComanda=!1,null!=xArrayPedidoObj)for(const P in xArrayPedidoObj)if(xArrayPedidoObj.hasOwnProperty(P))for(const f in xArrayPedidoObj[P]){var a=xArrayPedidoObj[P][f];"object"==typeof a&&null!==a&&(a.precio_print="",a.precio_total_calc=a.precio_total)}if(t){var d=e;for(xi in i){o=i[xi].idseccion,I=i[xi].idseccion_detalle,s=xObtnerValSumArray(d,o),xCantidadBuscarSecc_detalle=xObtnerValSumArray(d,I),S=(S=s-xCantidadBuscarSecc_detalle)<0?s:S;for(const j in d)if(d.hasOwnProperty(j)){var r=j;for(const v in d[r]){var c,n,l,m,p,_,u=d[r][v];"object"==typeof u&&null!==u&&(m=u.idseccion,c=u.iditem,n=u.idtipo_consumo,l=parseFloat(u.precio_total_calc),_=xMoneda(l),0!==l)&&m===I&&(m=u.cantidad,s>=xCantidadBuscarSecc_detalle?_="0.00":0<S&&(p=u.precio,_=(_=l-(_=parseFloat(parseFloat(S*p))))<0?"0.00":xMoneda(_),S=S-m<0?0:S-m),u.precio_total_calc=_,u.precio_print=_,u.cant_descontado=m,d[n][c].precio_print=_,xArrayPedidoObj[n][c].precio_print=_)}}}return d}for(var x=$(e),b=0;b<i.length;b++){var S,o=i[b].idseccion,I=i[b].idseccion_detalle;0!==(s=xObtnerValSumTable($(x),"data-idbus",o,"#cant_descontar"))&&(xCantidadBuscarSecc_detalle=xObtnerValSumTable($(x),"data-idbus",I,"#cant_descontar"),S=(S=s-xCantidadBuscarSecc_detalle)<0?s:S,$(x).find(".row").each(function(e,t){var i,o=$(t).attr("data-idbus"),a=$(t).attr("data-id"),d=$(t).attr("data-idtipocobus"),r=parseFloat($(t).find("#ptotal").text()),c=xMoneda(r);0!==r&&o===I&&(o=parseInt($(t).find("#cant_descontar").text()),s>=xCantidadBuscarSecc_detalle?c="0.00":0<S&&(i=parseFloat($(t).find("#punitario").text()),c=(c=r-(c=parseFloat(parseFloat(S*i))))<0?"0.00":xMoneda(c),S=S-o<0?0:S-o),$(t).find("#ptotal").text(c),$(t).attr("cant_descontado",o),xArrayPedidoObj[d][a].precio_print=c)}))}}function xGeneralSumarTotales(e){var t=new Array,i=0,o=0;null==e&&(e=xArrayPedidoObj);for(var a=0;a<e.length;a++)null!=e[a]&&$.map(e[a],function(e,t){"object"==typeof e&&(o=""==e.precio_print?e.precio_total:e.precio_print,i=parseFloat(i)+parseFloat(o))});var d,r,c=xm_log_get("sede_generales"),s="",n="",l="",m=0;(xGeneralArraySubTotales=new Array).push({descripcion:"Sub Total",importe:xMoneda(i),visible:!0});for(var p=0;p<c.length;p++)if(""!=(s=c[p].des_detalle)&&(d=parseFloat(parseFloat(c[p].porcentaje)/100).toFixed(2),d=parseFloat(parseFloat(i)*parseFloat(d)).toFixed(2),n=String(n+'<tr class="row"><td data-ColumName="descripcion" class="xPedidoSubTotal">'+s+'</td><td data-ColumName="importe" align="right">'+d+'</td><td class="xInvisible" data-ColumName="estado">0</td><td class="xInvisible" data-ColumName="idpedido">?p</td></tr>'),xGeneralArraySubTotales.push({descripcion:xMayusculaPrimera(s.toLowerCase()),importe:xMoneda(d),visible:!0}),i=parseFloat(i)+parseFloat(d)),""!=(r=c[p].ad_idtp_consumo)){for(var _,u=(u=c[p].ad_idseccion).split(","),x=0,b=0;b<u.length;b++)_=u[b],x=parseFloat(x)+xBuscarCantidadPorSeccion(r,_);0!=x&&(m=parseInt(m)+parseFloat(x)*parseFloat(c[p].ad_importe),m=xMoneda(m),l=String(l+'<tr class="row"><td><div class="xPedidoSubTotal" data-iddes="'+xGeneralArraySubTotales.length+'" data-importe="'+m+'"><paper-checkbox class="noselect" onchange="xNoCobrarSubTotal(this);" checked title="no cobrar" id="check'+c[p].ad_descripcion+'">'+c[p].ad_descripcion+'</paper-checkbox></div></td><td class="xInvisible" data-ColumName="descripcion">'+c[p].ad_descripcion+'</td><td data-ColumName="importe" align="right">'+m+'</td><td class="xInvisible" data-ColumName="estado" id="td_estado_subt">0</td></tr>'),xGeneralArraySubTotales.push({descripcion:xMayusculaPrimera(c[p].ad_descripcion.toLowerCase()),importe:m,visible:!0}),i=parseFloat(i)+parseFloat(m))}return(xGeneralArraySubTotales=1==xGeneralArraySubTotales.length?new Array:xGeneralArraySubTotales).push({descripcion:"Total",importe:xMoneda(i),visible:!0}),n=n+l+'<tr class="row xBold"><td class="xInvisible" data-ColumName="descripcion">TOTAL</td><td class="xInvisible" data-ColumName="importe" id="td_total_subt_2">'+xMoneda(i)+'</td><td colspan="2" align="right" class="xPedidoTotal xSinBorde"><h3 class="xBold" id="td_total_subt">'+xMoneda(i)+'</h3></td><td class="xInvisible" data-ColumName="estado">0</td></tr>',t.push({ImporteTotal:i,CadenaRow:n}),t}function xGeneralArmarSubTotalesBD(e,c){var s="";$.ajax({type:"POST",url:"../../bdphp/log.php?op=2052",data:{m:e}}).done(function(e){if((t=$.parseJSON(e)).success){var t,i=(t=t.datos).length,o=0,a=0;xGeneralArraySubTotales=new Array;for(var d=0;d<t.length;d++)0==d&&(o=a=t[d].importe),1<i&&0<d&&(o-=t[d].importe,xGeneralArraySubTotales[d]={descripcion:t[d].descripcion,importe:xMoneda(t[d].importe),visible:!0});1<i?(xGeneralArraySubTotales[0]={descripcion:"Sub Total",importe:xMoneda(o),visible:!0},xGeneralArraySubTotales[i]={descripcion:"Total",importe:xMoneda(a),visible:!0}):xGeneralArraySubTotales[0]={descripcion:"Total",importe:xMoneda(a),visible:!0};for(var r=0;r<xGeneralArraySubTotales.length-1;r++)s=s+'<tr class="row"><td>'+xGeneralArraySubTotales[r].descripcion+'</td><td align="right">'+xGeneralArraySubTotales[r].importe+"</td></tr>";return s=s+'<tr class="row xBold"><td></td><td align="right"><h3 class="xBold">'+xMoneda(a)+"</h3></td></tr>",c?c(s):void 0}alert(t.error)})}function xBuscarCantidadPorSeccion(e,i){var o=0;return $.map(xArrayPedidoObj[e],function(e,t){"object"==typeof e&&null!=e&&e.idseccion==i&&(o=parseFloat(o)+parseFloat(e.cantidad))}),o}function xNoCobrarSubTotal(e){var t=$(e).parent().attr("data-iddes"),i=$(e).parent().attr("data-importe"),o=$("#td_total_subt").text(),a=0;xGeneralArraySubTotales[t].visible=e.checked,o=0==e.checked?(a=1,e.title="cobrar",$(e).addClass("check_red"),xMoneda(parseFloat(o)-parseFloat(i))):(e.title="no cobrar",$(e).removeClass("check_red"),xMoneda(parseFloat(o)+parseFloat(i))),$(e).parents("tr").find("#td_estado_subt").text(a),$("#td_total_subt").text(o),$("#td_total_subt_2").text(o),xGeneralArraySubTotales[xGeneralArraySubTotales.length-1].importe=o}function xArmarArrayDescontarStock(e,t){var i=new Array,o="",a="",d=$(e).attr("data-iddescontar"),r=$(e).attr("data-procede"),c=$(e).attr("data-cant_descontar"),s=parseInt($(e).find(".xcant_li").text()),n=(isNaN(s)&&(s=parseFloat($(e).find("#td_cant").text())),isNaN(parseInt(r))||(r=$(e).attr("data-descontar")),"+"==t&&(s=1),$(e).attr("data-idpedido")),l=$(e).attr("data-idpedidodetalle"),e=parseFloat($(e).attr("data-punitario")),c=c.split(","),d=d.split(",");for(xi in null!=l&&(xsql1="update pedido_detalle set cantidad=cantidad-1, estado=if((cantidad)<=0,1,0), ptotal=format(ptotal-"+e+",2) where idpedido_detalle="+l+"; \r",xsql2="update pedido set total=format(total-"+e+",2),estado=if((total)<=0,3,0) where idpedido="+n+"; \r update pedido_subtotales set importe=format(importe-"+e+",2) where idpedido="+n+" and descripcion='TOTAL'; \r",a=String(xsql1+" "+xsql2)),d)xid_des=d[xi],xcant_des=s,"porcion"==r&&(xcant_des=parseFloat(c[xi])*parseFloat(s)),xcampo_procede="stock=stock"+t+xcant_des,o=o+" update "+r+" set "+(xcampo_procede="carta_lista"==r?"cantidad=if(cantidad='ND','ND',cantidad"+t+xcant_des+")":xcampo_procede)+" where id"+r+"="+xid_des+";\r";return i.push({stock:o,importe:a}),i}function xArmarTipoConsumo(e=0){var t="";for(a in setTimeout(()=>{var e=xArrayPedidoToCleanObject(xArrayPedidoObj);window.localStorage.setItem("::app3_sys_dta_pe",JSON.stringify(e))},0),xArrayDesTipoConsumo)null!=xArrayDesTipoConsumo[a]&&(t=String(t+'<div class="xpedir_row" data-ventarapida="'+e+'" data-id="'+xArrayDesTipoConsumo[a].id+'"><p>'+xArrayDesTipoConsumo[a].des+'</p><p class="xCant_item"></p><div class="xBtnIz xBtn">-</div><div class="xBtnDe xBtn">+</div></div>'));return t='<div class="xpedir_item">'+t+"</div>"}async function xVerificarStockItemPedidoBefore(){var i=[];const o=xEstructuraItemsJsonComprobante(xArrayPedidoObj,[]).filter(e=>"ND"!=e.stock_actual).filter(e=>parseInt(e.stock_actual)<=5);var e=o.filter(e=>1===parseInt(e.procede)).map(e=>e.id).join(","),t=o.filter(e=>0===parseInt(e.procede)).map(e=>e.id).join(",");return 0===e.length&&0===t.length||(await $.ajax({type:"POST",url:"../../bdphp/log.php?op=3031",data:{i:e,p:t}}).done(function(e){$.parseJSON(e).datos.map(e=>{const t=e.idcarta_lista;_item=o.filter(e=>e.id===t).map(e=>e),parseFloat(_item[0].stock_actual)>parseFloat(e.cantidad)&&(_item[0].stock_actual=parseFloat(e.cantidad),i.push(_item[0]))})}),i)}function xUpdateItemNoStock(e,t){$.ajax({type:"POST",url:"../../bdphp/log.php?op=2301",data:{p_from:e,i:t}}).done(e=>{})}function xSendItemVentaxPesoVR(e){e=e.map(e=>Object.values(e)).filter(e=>3<e.length)[0].filter(e=>"object"==typeof e).filter(e=>"1"===e.venta_x_peso);0!==e.length&&e.map(e=>{"ND"!==e.cantidad&&isSocket&&(e.stock_actual=e.stock_actual-e.cantidad,e={cantidad:e.cantidad,idcarta_lista:e.idcarta_lista,iditem:e.iditem,isalmacen:"0"===e.procede.toString()?1:0,isporcion:e.isporcion,subitems:"string"==typeof e.subitems?JSON.parse(itemPedidos_objItemSelected.subitems):itemPedidos_objItemSelected.subitems,subitems_selected:e.subitems_selected,sumar:!0,venta_x_peso:1},_cpSocketEmitItemModificado(e)),xcantRunSocket=!0})}function updateStockOnOrderCompletion(e){e=e.map(e=>Object.values(e)).filter(e=>3<e.length)[0].filter(e=>"object"==typeof e).filter(e=>"ND"!==e.isporcion).filter(e=>"1"!==e.venta_x_peso);if(0!==e.length){let t=[];e.map(e=>{e.stock_actual=e.stock_actual-e.cantidad;e={cantidad:e.cantidad,idcarta_lista:e.idcarta_lista,iditem:e.iditem,iditem2:e.iditem2,isalmacen:"0"===e.procede.toString()?1:0,isporcion:e.isporcion,subitems:"string"==typeof e.subitems?JSON.parse(itemPedidos_objItemSelected.subitems):itemPedidos_objItemSelected.subitems,subitems_selected:e.subitems_selected,sumar:!0,venta_x_peso:1};t.push(e)}),isSocket&&_cpSocketEmitItemAllModificado(t)}}async function xGetListPromociones(){return new Promise((t,i)=>{$.ajax({type:"POST",url:"../../bdphp/log_010.php?op=get-promociones",success:function(e){t(JSON.parse(e))},error:function(e){i(e)}})})}async function xHandlerShowPromciones(){let e=await xGetListPromociones();if("string"==typeof e)try{e=JSON.parse(e)}catch(e){}return e=0<e.datos.length?JSON.parse(e.datos[0].promociones):[],localStorage.setItem("::app3_sys_promociones",JSON.stringify(e)),e}function xAplicaItemPromo(e,a){try{a.is_promo_aplicada&&(a.precio=a.precioOriginal,a.enPromocion=!1,a.is_promo_aplicada=!1,a.tituloPromocion=null,a.descuento=null),e&&(e.lista_promociones||e.lista_promociones.length)&&e.lista_promociones&&0<e.lista_promociones.length&&e.lista_promociones.forEach(o=>{o.lista.forEach(e=>{var t=e.iditem,i=e.idseccion;t!=a.iditem&&i!=a.idseccion||(t=parseFloat(a.precio),i=parseFloat(e.porc_descuento),a.precio=(t-t*(i/100)).toFixed(2),a.enPromocion=!0,a.precioOriginal=t,a.descuento=i,a.tituloPromocion=o.parametros?.header?.titulo||"PROMO",a.is_promo_aplicada=!0)})})}catch(e){}}$(document.body).on("click","#_xSubMenu_body div.xBtn",handlerFnMiPedido),$(document.body).on("click","#_xdlgBody div.xBtn",handlerFnMiPedido),$(document.body).on("click",".subitem-content-resumen div.btnCount",handlerFnMiPedido),$(document.body).on("click","#content_item_pedido div.xBtn_li",e=>handlerFnMiPedidoControl(e)),$(document.body).on("click","#accordion div.xBtn_contet_li2",e=>handlerFnMiPedidoControl(e)),$(document.body).on("click","#accordion div.content_li",function(e){isTouch&&handlerFnMiPedidoControl(e)}),$(document.body).on("click",".list_add_item ul li",function(e){-1<e.target.className.indexOf("xbtn_li_editar")||handlerFnMiPedidoControl(e)}),$(document.body).on("click","#accordion div.xBtn_contet_li2 .input-venta-rapida-mod",e=>{e.target.select(),e.stopPropagation(),e.stopImmediatePropagation()}),$(document.body).on("keyup","#accordion div.xBtn_contet_li2 .input-venta-rapida-mod",e=>{var t=e.target.value;e.target.validity.patternMismatch&&"."!==e.key?e.target.value=e.target.value.slice(0,-1):handlerFnMiPedidoControl(e.target.parentNode,""==t?0:t),e.stopPropagation(),e.stopImmediatePropagation()}),$(document.body).on("keyup",".xMiTextReferencia",function(e){if(xidTipoConsumo){var t=e.target.value;itemPedidos_objItemSelected.indicaciones=t,itemPedidos_objItemSelected.xindicaciones=t;try{xArrayPedidoObj[xidTipoConsumo][xidItem].indicaciones=t}catch(e){}return setTimeout(()=>{var e=xArrayPedidoToCleanObject(xArrayPedidoObj);window.localStorage.setItem("::app3_sys_dta_pe",JSON.stringify(e))},0),e.stopPropagation(),e.stopImmediatePropagation(),!1}});