var dtSede=xm_log_get("datos_org_sede")[0],url_api_fac_sede=dtSede.url_api_fac||"",URL_COMPROBANTE=""===url_api_fac_sede?xm_log_get("app3_sys_const")[0].value:url_api_fac_sede,URL_COMPROBANTE_DOWNLOAD_FILE=""===url_api_fac_sede?xm_log_get("app3_sys_const")[1].value:url_api_fac_sede.replace(".pe/api",".pe/downloads/document");async function xSoapSunat_getArrNoRegistrado(){var a=[];return await $.ajax({type:"POST",url:"../../bdphp/log_002.php",data:{op:"301"}}).done(function(e){(data_response=$.parseJSON(e)).success?a=data_response.datos:alert(data_response.error)}),a}async function xSoapSunat_getArrNoRegistradoSunat(){var a=[];return await $.ajax({type:"POST",url:"../../bdphp/log_002.php",data:{op:"3011"}}).done(function(e){(data_response=$.parseJSON(e)).success?a=data_response.datos:alert(data_response.error)}),a}async function xSoapSunat_ResumenDiario(e){var e=xSoapSunat_cambiarFormatoFechaString(e),a={fecha_de_emision_de_documentos:e,codigo_tipo_proceso:"1"},o=URL_COMPROBANTE+"/summaries",t=HEADERS_COMPROBANTE,a=(t.Authorization="Bearer "+xm_log_get("datos_org_sede")[0].authorization_api_comprobante,JSON.stringify(a));let n={},r={};return r.fecha_resumen=e,await fetch(o,{method:"POST",headers:t,body:a}).then(function(e){return e.json()}).then(function(e){e.success?(n.ok=!0,r.external_id=e.data.external_id,r.ticket=e.data.ticket,r.estado_sunat=0,r.msj="Resumen enviado."):(n.ok=!1,n.error="Error al ingresar los datos",n.msj_error=e.message,r.estado_sunat=1,r.msj=e.message),CpeInterno_SaveResumenDiario(r)}).catch(function(e){n.ok=!1,n.msj="Error de conexion con el servicio Sunat: se intentara enviar nuevamente al proximo cierre."}),n}async function xSoapSunat_getArrFechaBoletasNoAceptadas(){var a=[];return await $.ajax({type:"POST",url:"../../bdphp/log_002.php",data:{op:"302"}}).done(function(e){(e=$.parseJSON(e)).success?a=e.datos:alert(e.error)}),a}async function xSoapSunat_getListTicketResumenBoletas(){var a=[];return await $.ajax({type:"POST",url:"../../bdphp/log_002.php",data:{op:"303"}}).done(function(e){(e=$.parseJSON(e)).success?a=e.datos:alert(e.error)}),a}async function xSoapSunat_ConsultarTicketResumen(o){var e=URL_COMPROBANTE+"/summaries/status",a=HEADERS_COMPROBANTE,t=(a.Authorization="Bearer "+xm_log_get("datos_org_sede")[0].authorization_api_comprobante,{external_id:o.external_id,ticket:o.ticket}),t=json_xml=JSON.stringify(t);let n={};return await fetch(e,{method:"POST",headers:a,body:t}).then(function(e){return e.json()}).then(function(e){var a={};e.success?(n.ok=!0,a.ticket=o.ticket,a.cdr=""!=e.links.cdr?1:0,a.xml=""!=e.links.xml?1:0,a.fecha_resumen=xSoapSunat_cambiarFormatoFechaString2(o.fecha_resumen),-1<e.response.description.indexOf("aceptado")&&(a.estado_sunat=1,a.msj=e.response.description)):(n.ok=!1,n.error="Error en resumen de boletas",n.msj_error=e.message,a.ticket=o.ticket,a.cdr=0,a.xml=0,a.estado_sunat=2,a.msj=e.message),CpeInterno_UpdateResumenDiario(a)}).catch(function(e){n.ok=!1,n.msj_error="Error de conexion con el servicio Sunat: se intentara enviar nuevamente al proximo cierre."}),n}async function xSoapSunat_EnviarDocumentApi(e,o,a=0){var t=URL_COMPROBANTE+"/documents",n=HEADERS_COMPROBANTE;n.Authorization="Bearer "+xm_log_get("datos_org_sede")[0].authorization_api_comprobante;let r={};const s=e.serie_documento+"-"+e.numero_documento;return e=JSON.stringify(e),await fetch(t,{method:"POST",headers:n,body:e}).then(function(e){return e.json()}).then(function(e){var a;e.success?(r.ok=!0,(a={}).idce=o,a.estado_api=0,a.estado_sunat=1,a.msj="Registrado",a.numero=s,a.external_id=e.data.external_id,0!=e.response.length&&(a.estado_sunat=e.response.code,a.msj=e.response.description),a.pdf=""!=e.links.pdf?1:0,a.cdr=""!=e.links.cdr?1:0,a.xml=""!=e.links.xml?1:0,CpeInterno_UpdateRegistro(a)):(r.ok=!1,r.error="Error al ingresar los datos",r.msj_error=e.message,a={idce:o,numero:s,external_id:"",estado_api:0,estado_sunat:1,anulado:1,msj:e.message,pdf:0,cdr:0,xml:0},CpeInterno_UpdateRegistro(a))}).catch(function(e){r.ok=!1,r.msj="Error de conexion con el servicio Sunat: se intentara enviar nuevamente al proximo cierre.",r.msj_error="Error de conexion con el servicio Sunat: se intentara enviar nuevamente al proximo cierre."}),r}async function xSoapSunat_SendSunat(o,t){var e=URL_COMPROBANTE+"/send",a=HEADERS_COMPROBANTE;a.Authorization="Bearer "+xm_log_get("datos_org_sede")[0].authorization_api_comprobante;let n={};return await fetch(e,{method:"POST",headers:a,body:JSON.stringify({external_id:o})}).then(function(e){return e.json()}).then(function(e){var a=e.response&&e.response.error_soap||!1;e.success&&!a?(n.ok=!0,(a={}).idce=t,a.estado_api=0,a.estado_sunat=0,a.msj="Aceptada",a.external_id=o,0!=e.response.length&&(a.msj=e.response.description),a.pdf=""!=e.links.pdf?1:0,a.cdr=""!=e.links.cdr?1:0,a.xml=""!=e.links.xml?1:0,CpeInterno_UpdateRegistro(a)):(n.ok=!1,n.error="Problema de conexion Sunat persistente.",n.msj_error=e.message||e.response.description)}).catch(function(e){n.ok=!1,n.msj="Error de conexion con el servicio Sunat: se intentara enviar nuevamente al proximo cierre.",n.msj_error="Error de conexion con el servicio Sunat: se intentara enviar nuevamente al proximo cierre."}),n}async function xSoapSunat_AnularComprobante(o){var e=o.codsunat,a=URL_COMPROBANTE,t=HEADERS_COMPROBANTE;let n="";t.Authorization="Bearer "+xm_log_get("datos_org_sede")[0].authorization_api_comprobante;var r=xSoapSunat_cambiarFormatoFechaString(o.fecha);let s={},i;switch(e){case"01":n="voided",s={fecha_de_emision_de_documentos:r,documentos:[{external_id:o.external_id,motivo_anulacion:o.motivo}]};break;case"03":n="summaries",s={fecha_de_emision_de_documentos:r,codigo_tipo_proceso:"3",documentos:[{external_id:o.external_id,motivo_anulacion:o.motivo}]}}return a=a+"/"+n,s=JSON.stringify(s),await fetch(a,{method:"POST",headers:t,body:s}).then(function(e){return e.json()}).then(async function(e){var a;(i=e.success)?(o.external_id_anulacion=(e.data||e).external_id,o.ticket=(e.data||e).ticket,a=await CpeInterno_UpdateAnulacion(o),i=a):alert(e.message)}).catch(function(e){i=!1,alert("No se pudo establecer conexion con el servicio Sunat")}),i}function xSoapSunat_cambiarFormatoFecha(e){var a=/(\d{4})\-(\d{2})\-(\d{2})/;return e&&e.match(a)?e.replace(a,"$3/$2/$1"):null}function xSoapSunat_cambiarFormatoFechaString(e){return e.split("/").reverse().join("-")}function xSoapSunat_cambiarFormatoFechaString2(e){return e.split("-").reverse().join("/")}function xSoapSunat_DownloadFile(e,a){var o=xm_log_get("datos_org_sede")[0].id_api_comprobante;window.open(URL_COMPROBANTE_DOWNLOAD_FILE+`/${e}/${a}/`+o,"_blank")}