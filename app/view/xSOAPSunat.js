var dtSede=xm_log_get("datos_org_sede")[0],url_api_fac_sede=dtSede.url_api_fac||"",URL_COMPROBANTE=""===url_api_fac_sede?xm_log_get("app3_sys_const")[0].value:url_api_fac_sede,URL_COMPROBANTE_DOWNLOAD_FILE=""===url_api_fac_sede?xm_log_get("app3_sys_const")[1].value:url_api_fac_sede.replace(".pe/api",".pe/downloads/document");async function xSoapSunat_getArrNoRegistrado(){var o=[];return await $.ajax({type:"POST",url:"../../bdphp/log_002.php",data:{op:"301"}}).done(function(e){(data_response=$.parseJSON(e)).success?o=data_response.datos:alert(data_response.error)}),o}async function xSoapSunat_getArrNoRegistradoSunat(){var o=[];return await $.ajax({type:"POST",url:"../../bdphp/log_002.php",data:{op:"3011"}}).done(function(e){(data_response=$.parseJSON(e)).success?o=data_response.datos:alert(data_response.error)}),o}async function xSoapSunat_ResumenDiario(e){var e=xSoapSunat_cambiarFormatoFechaString(e),o={fecha_de_emision_de_documentos:e,codigo_tipo_proceso:"1"},a=URL_COMPROBANTE+"/summaries",n=HEADERS_COMPROBANTE,o=(n.Authorization="Bearer "+xm_log_get("datos_org_sede")[0].authorization_api_comprobante,JSON.stringify(o));let t={},r={};return r.fecha_resumen=e,await fetch(a,{method:"POST",headers:n,body:o}).then(function(e){return e.json()}).then(function(e){console.log(e),e.success?(t.ok=!0,r.external_id=e.data.external_id,r.ticket=e.data.ticket,r.estado_sunat=0,r.msj="Resumen enviado."):(t.ok=!1,t.error="Error al ingresar los datos",t.msj_error=e.message,r.estado_sunat=1,r.msj=e.message),CpeInterno_SaveResumenDiario(r)}).catch(function(e){t.ok=!1,t.msj="Error de conexion con el servicio Sunat: se intentara enviar nuevamente al proximo cierre."}),t}async function xSoapSunat_getArrFechaBoletasNoAceptadas(){var o=[];return await $.ajax({type:"POST",url:"../../bdphp/log_002.php",data:{op:"302"}}).done(function(e){(e=$.parseJSON(e)).success?o=e.datos:alert(e.error)}),o}async function xSoapSunat_getListTicketResumenBoletas(){var o=[];return await $.ajax({type:"POST",url:"../../bdphp/log_002.php",data:{op:"303"}}).done(function(e){(e=$.parseJSON(e)).success?o=e.datos:alert(e.error)}),o}async function xSoapSunat_ConsultarTicketResumen(a){var e=URL_COMPROBANTE+"/summaries/status",o=HEADERS_COMPROBANTE,n=(o.Authorization="Bearer "+xm_log_get("datos_org_sede")[0].authorization_api_comprobante,{external_id:a.external_id,ticket:a.ticket}),n=json_xml=JSON.stringify(n);let t={};return await fetch(e,{method:"POST",headers:o,body:n}).then(function(e){return e.json()}).then(function(e){console.log(e);var o={};e.success?(t.ok=!0,o.ticket=a.ticket,o.cdr=""!=e.links.cdr?1:0,o.xml=""!=e.links.xml?1:0,o.fecha_resumen=xSoapSunat_cambiarFormatoFechaString2(a.fecha_resumen),-1<e.response.description.indexOf("aceptado")&&(o.estado_sunat=1,o.msj=e.response.description)):(t.ok=!1,t.error="Error en resumen de boletas",t.msj_error=e.message,o.ticket=a.ticket,o.cdr=0,o.xml=0,o.estado_sunat=2,o.msj=e.message),CpeInterno_UpdateResumenDiario(o)}).catch(function(e){t.ok=!1,t.msj_error="Error de conexion con el servicio Sunat: se intentara enviar nuevamente al proximo cierre."}),t}async function xSoapSunat_EnviarDocumentApi(e,a,o=0){var n=URL_COMPROBANTE+"/documents",t=HEADERS_COMPROBANTE;t.Authorization="Bearer "+xm_log_get("datos_org_sede")[0].authorization_api_comprobante;let r={};const s=e.serie_documento+"-"+e.numero_documento;return e=JSON.stringify(e),await fetch(n,{method:"POST",headers:t,body:e}).then(function(e){return e.json()}).then(function(e){var o;console.log(e),e.success?(r.ok=!0,(o={}).idce=a,o.estado_api=0,o.estado_sunat=1,o.msj="Registrado",o.numero=s,o.external_id=e.data.external_id,0!=e.response.length&&(o.estado_sunat=e.response.code,o.msj=e.response.description),o.pdf=""!=e.links.pdf?1:0,o.cdr=""!=e.links.cdr?1:0,o.xml=""!=e.links.xml?1:0,CpeInterno_UpdateRegistro(o)):(r.ok=!1,r.error="Error al ingresar los datos",r.msj_error=e.message,o={idce:a,numero:s,external_id:"",estado_api:0,estado_sunat:1,anulado:1,msj:e.message,pdf:0,cdr:0,xml:0},CpeInterno_UpdateRegistro(o))}).catch(function(e){r.ok=!1,r.msj="Error de conexion con el servicio Sunat: se intentara enviar nuevamente al proximo cierre.",r.msj_error="Error de conexion con el servicio Sunat: se intentara enviar nuevamente al proximo cierre."}),r}async function xSoapSunat_SendSunat(a,n){var e=URL_COMPROBANTE+"/send",o=HEADERS_COMPROBANTE;o.Authorization="Bearer "+xm_log_get("datos_org_sede")[0].authorization_api_comprobante;let t={};return await fetch(e,{method:"POST",headers:o,body:JSON.stringify({external_id:a})}).then(function(e){return e.json()}).then(function(e){console.log(e);var o=e.response&&e.response.error_soap||!1;e.success&&!o?(t.ok=!0,(o={}).idce=n,o.estado_api=0,o.estado_sunat=0,o.msj="Aceptada",o.external_id=a,0!=e.response.length&&(o.msj=e.response.description),o.pdf=""!=e.links.pdf?1:0,o.cdr=""!=e.links.cdr?1:0,o.xml=""!=e.links.xml?1:0,CpeInterno_UpdateRegistro(o)):(t.ok=!1,t.error="Problema de conexion Sunat persistente.",t.msj_error=e.message||e.response.description)}).catch(function(e){t.ok=!1,t.msj="Error de conexion con el servicio Sunat: se intentara enviar nuevamente al proximo cierre.",t.msj_error="Error de conexion con el servicio Sunat: se intentara enviar nuevamente al proximo cierre."}),t}async function xSoapSunat_AnularComprobante(a){var e=a.codsunat,o=URL_COMPROBANTE,n=HEADERS_COMPROBANTE;let t="";n.Authorization="Bearer "+xm_log_get("datos_org_sede")[0].authorization_api_comprobante;var r=xSoapSunat_cambiarFormatoFechaString(a.fecha);let s={},i;switch(e){case"01":t="voided",s={fecha_de_emision_de_documentos:r,documentos:[{external_id:a.external_id,motivo_anulacion:a.motivo}]};break;case"03":t="summaries",s={fecha_de_emision_de_documentos:r,codigo_tipo_proceso:"3",documentos:[{external_id:a.external_id,motivo_anulacion:a.motivo}]}}return o=o+"/"+t,s=JSON.stringify(s),await fetch(o,{method:"POST",headers:n,body:s}).then(function(e){return e.json()}).then(async function(e){var o;console.log(e),(i=e.success)?(a.external_id_anulacion=(e.data||e).external_id,a.ticket=(e.data||e).ticket,o=await CpeInterno_UpdateAnulacion(a),i=o):(console.log(e),alert(e.message))}).catch(function(e){i=!1,console.log(e),alert("No se pudo establecer conexion con el servicio Sunat")}),i}function xSoapSunat_cambiarFormatoFecha(e){var o=/(\d{4})\-(\d{2})\-(\d{2})/;return e&&e.match(o)?e.replace(o,"$3/$2/$1"):null}function xSoapSunat_cambiarFormatoFechaString(e){return e.split("/").reverse().join("-")}function xSoapSunat_cambiarFormatoFechaString2(e){return e.split("-").reverse().join("/")}function xSoapSunat_DownloadFile(e,o){var a=xm_log_get("datos_org_sede")[0].id_api_comprobante;window.open(URL_COMPROBANTE_DOWNLOAD_FILE+`/${e}/${o}/`+a,"_blank")}