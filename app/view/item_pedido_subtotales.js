var xLocal_xDtSubTotales,xLocal_SubTotal_Quitados="",arrVerifySubTotalTachados=[];function xArmarSubtotalesFromTotal(o){var t,e,a;if(o)return t=o.secciones.split(","),e=o.subtotales_tachados,a=[],t.map((o,t)=>{o=o.split(":");a.push({tipoconsumo:o[0],seccion:o[1],cantidad:o[2],subtotales_tachados:e})}),xCalcTotalSubArray(a,o.importe)}function xArmarSubtotalesArray(o=null,t=0){var i=[];o=o||xArrayPedidoObj;for(var t=0===t?xSumaCantArray(o):t,e=0;e<o.length;e++)null!=o[e]&&$.map(o[e],function(o,t){var e,a;"object"==typeof o&&(e=void 0!==o.subtotales_tachados?o.subtotales_tachados:xLocal_SubTotal_Quitados,a=o.idpedido||0,i.push({tipoconsumo:o.idtipo_consumo,seccion:o.idseccion,cantidad:o.cantidad,subtotales_tachados:e,idpedido:a}))});return xCalcTotalSubArray(i,t)}function xCalcTotalSubArray(o,i){var n,t,e,a,r,p=xm_log_get("carta_subtotales"),s=o||[],d=[];(xLocal_xDtSubTotales=[]).push({descripcion:"Sub Total",importe:xMoneda(i),visible:!0,quitar:!1}),d.push({descripcion:"Sub Total",importe:xMoneda(i),visible:!0,quitar:!1,visible_cpe:!0}),xSumTotalPorcentaje=0,xSumCantImporte=0,s.length;if(0!==s.length&&void 0!==s[0].subtotales_tachados)return n=s.map(o=>(o.grupo=o.tipoconsumo+o.seccion,o)).reduce((o,t)=>{var e=t.grupo;return o[e]?(o[e].grupo=t.grupo,o[e].grupoTipoconsumo=t.tipoconsumo,o[e].cantidad=parseFloat(o[e].cantidad)+parseFloat(t.cantidad)):(o[e]=[],o[e].grupo=t.grupo,o[e].grupoTipoconsumo=t.tipoconsumo,o[e].cantidad=t.cantidad),o[e].subtotales_tachados=o[e].subtotales_tachados?o[e].subtotales_tachados+t.subtotales_tachados:t.subtotales_tachados,o},[]),t="",n.map(o=>{t+=o.subtotales_tachados}),n.all_subtotales_tachados=t,p.map(o=>(o.grupo=o.idtipo_consumo+o.idseccion,o)).map(c=>{switch(c.tipo){case"a":s.map(o=>{var t=c.tipo+c.id;const e=c.descripcion;var a=parseInt(c.nivel);let i=0,r=0;var p="";if(xLocal_SubTotal_Quitados=""!=n[o.grupo].subtotales_tachados?n[o.grupo].subtotales_tachados:xLocal_SubTotal_Quitados,0===a){if(o.grupo!==c.grupo)return;if(0===(i=parseFloat(o.cantidad)*parseFloat(c.monto)))return}else{if(o.tipoconsumo!==c.idtipo_consumo)return;i=parseFloat(c.monto)}r=i,p=o.subtotales_tachados,o=n[o.grupo].cantidad,0<=p.indexOf(t)?i=0:r=0;var s,p=checkSubTotalQuitado(o,t,i),l=null;d.map((o,t)=>{o.descripcion.toLowerCase()===e.toLowerCase()&&(l=t)}),l?(o=parseFloat(d[l].importe),s=parseFloat(d[l].importe_tachado),d[l].importe=(0===a?parseFloat(o+parseFloat(i)):parseFloat(i)).toFixed(2),d[l].importe_tachado=(0===a?parseFloat(s+parseFloat(r)):parseFloat(r)).toFixed(2)):d.push({id:t,descripcion:c.descripcion,importe_tachado:xMoneda(r),importe:xMoneda(i),punitario:c.monto,esImpuesto:0,visible:!0,quitar:!0,tachado:p,visible_cpe:!1})});break;case"p":var o=c.tipo+c.id,t=c.es_impuesto,e="0"===c.activo?c.monto:0,a="1"===t,e=parseFloat(parseFloat(e)/100).toFixed(2),e="I.G.V"===c.descripcion?e:parseFloat(parseFloat(i)*parseFloat(e)).toFixed(2);d.push({id:o,descripcion:c.descripcion,importe:xMoneda(e),esImpuesto:t,visible:!0,quitar:!1,tachado:!1,visible_cpe:a})}}),(o=localStorage.getItem("::app3_woDUS::cxe"))&&((rpt={id:-2,descripcion:"ENTREGA",isDeliveryApp:!0,esImpuesto:0,visible:!0,quitar:!1,tachado:!1,visible_cpe:!1}).importe=parseFloat(o.toString()).toFixed(2),d.push(rpt)),p=d.filter(o=>"I.G.V"!==o.descripcion).map(o=>o.importe).reduce((o,t)=>parseFloat(o)+parseFloat(t)),o=d.filter(o=>"Sub Total"===o.descripcion)[0],e=d.filter(o=>"I.G.V"===o.descripcion)[0],a=parseFloat(e.importe),r=parseFloat(o.importe),0<a&&(r=parseFloat(xCalcMontoBaseIGV(r,a)),a=parseFloat(p-r).toFixed(2),e.importe=a,o.importe=r.toFixed(2)),(d=1==d.length?[]:d).push({descripcion:"Total",importe:xMoneda(p),visible:!0,visible_cpe:!0}),xLocal_xDtSubTotales=d,xSumCantImporte=p}function checkSubTotalQuitado(o,t,e){var a;if(xLocal_SubTotal_Quitados)return a=xLocal_SubTotal_Quitados.toLowerCase().split(",").sort().filter(o=>o===t).length,a=parseInt(a)>=parseFloat(o),(o=0<=xLocal_SubTotal_Quitados.indexOf(t))||(xSumCantImporte+=parseFloat(e)),a&&o}var groupBy=function(o,e){return o.reduce(function(o,t){return(o[t[e]]=o[t[e]]||[]).push(t),o},{})};function darFormatoSubTotalesDelivery(o=null){if(o)return o[o.length-1].importe=o.filter(o=>-2!==o.id&&-3!==o.id&&"TOTAL"!==o.descripcion.toUpperCase()).map(o=>parseFloat(o.importe)).reduce((o,t)=>o+t,0),xLocal_xDtSubTotales=o.filter(o=>-2!==o.id&&-3!==o.id)}function addCostoDeliveryArrTotal(e,o,t=!1,a=!1,i=!1,r=!1,p=!1){var s,l=0,c=e.pop()||{importe:0};return e.map(t=>{void 0!==t.importe&&!isNaN(parseFloat(t.importe))||(t.importe="0.00"),i&&(-1<t.descripcion.toLowerCase().indexOf("entrega")||-1<t.descripcion.toLowerCase().indexOf("delivery"))&&(e=e.filter(o=>o.id!==t.id),s=t)}),o.filter(o=>o.id<0).map(o=>{void 0!==o.importe&&!isNaN(parseFloat(o.importe))||(o.importe="0.00"),t&&!a&&!i&&"entrega"===o.descripcion.toLowerCase()||(l+=parseFloat(o.importe),e.push(o))}),r&&!p&&s&&e.push(s),c.importe=(parseFloat(c.importe)+l).toFixed(2),e.push(c),e}function getImporteTotalSubTotalesDelivery(o=null){var t=o[o.length-1],o=(o=o.filter(o=>o),t.importe=o.filter(o=>"total"!==o.descripcion.toLowerCase()).map(o=>parseFloat(o.importe)).reduce((o,t)=>o+t,0),o.filter(o=>o.tachado).map(o=>parseFloat(o.importe_tachado)).reduce((o,t)=>o+t,0));return t.importe=(parseFloat(t.importe)-o).toFixed(2),t.importe}function colocarDescuentoSubtotales(o,t,e="",a=!0){var i=t[t.length-1],r=t.filter(o=>"I.G.V"===o.descripcion)[0],p=t[0],a=(o=a?o:0,t.filter(o=>6===o.id)[0]),s=a?-1*a.importe:0;i.importe=i.importe+s,a?(a.importe=-o,a.descripcion="Descuento "+e):(s=t.length-1,t.splice(s,0,{descripcion:"Descuento "+e,esImpuesto:1,id:6,importe:-o,quitar:!1,tachado:!1,visible:!0,visible_cpe:!0})),i.importe=i.importe-o;a=xm_log_get("carta_subtotales").filter(o=>"I.G.V"===o.descripcion)[0];return"0"===a.activo.toString()?(r=t.filter(o=>"I.G.V"===o.descripcion)[0],s=parseFloat(parseFloat(a.monto)/100),e=xCalcMontoBaseIGV(i.importe,s),o=parseFloat(i.importe-e).toFixed(2),r.importe=parseFloat(o).toFixed(2),p.importe=(parseFloat(i.importe)-o).toFixed(2)):i.importe=t.filter(o=>"TOTAL"!==o.descripcion.toUpperCase()).map(o=>parseFloat(o.importe)).reduce((o,t)=>o+t,0),t}function colocarComisionSubtotales(t,o,e=!0){if(!o||!Array.isArray(o)||0===o.length)return o||[];var a=o[o.length-1];if(a)if(e){if(t){const i="com_"+t.idconf_print_detalle;o.find(o=>o.id===i||o.idconf_print_detalle&&o.idconf_print_detalle===t.idconf_print_detalle)||(a=(parseFloat(a.importe)*(e=parseFloat(t.porcentaje))/100).toFixed(2),e={descripcion:t.descripcion+" "+e+"%",esImpuesto:0,id:i,importe:a,idconf_print_detalle:t.idconf_print_detalle,quitar:!1,tachado:!1,visible:!0,visible_cpe:!0},o.splice(o.length-1,0,e),recalcularTotal(o),actualizarIGV(o))}}else removeAllComisiones(o),recalcularTotal(o),actualizarIGV(o);return o}function removeAllComisiones(t){var o=t.filter(o=>o.id&&"string"==typeof o.id&&o.id.startsWith("com_")||o.idconf_print_detalle);0<o.length&&o.map(o=>t.indexOf(o)).filter(o=>-1!==o).sort((o,t)=>t-o).forEach(o=>t.splice(o,1))}function recalcularTotal(o){var t=o[o.length-1];t&&(o=o.filter(o=>o&&o.descripcion&&"TOTAL"!==o.descripcion.toUpperCase()).map(o=>parseFloat(o.importe||0)).reduce((o,t)=>o+t,0),t.importe=o.toFixed(2))}function actualizarIGV(o){var t,e,a=o[o.length-1];a&&(e=xm_log_get("carta_subtotales").filter(o=>"I.G.V"===o.descripcion)[0])&&e.activo&&"0"===e.activo.toString()&&(t=o.find(o=>"I.G.V"===o.descripcion),o=o[0],t)&&o&&(e=parseFloat(parseFloat(e.monto)/100),e=xCalcMontoBaseIGV(a.importe,e),e=parseFloat(a.importe-e).toFixed(2),t.importe=parseFloat(e).toFixed(2),o.importe=(parseFloat(a.importe)-e).toFixed(2))}function darFormatoSubTotalesComisionRepartidor(o,t,e,a=!1){return"1"!==o.pwa_delivery_servicio_propio||a?("1"!==o.pwa_delivery_comercio_paga_entrega&&!a||(a=t.length-1,t.splice(a,0,{descripcion:"Costo de Entrega",esImpuesto:0,id:-4,importe:-e,quitar:!0,tachado:!1,visible:!1,visible_cpe:!1})),a=t[t.length-1],"1"===o.pwa_delivery_servicio_propio?(a.importe=t.filter(o=>"TOTAL"!==o.descripcion.toUpperCase()).map(o=>parseFloat(o.importe)).reduce((o,t)=>o+t,0),t):(a.importe=t.filter(o=>-2!==o.id&&-3!==o.id&&"TOTAL"!==o.descripcion.toUpperCase()).map(o=>parseFloat(o.importe)).reduce((o,t)=>o+t,0),t.filter(o=>-2!==o.id&&-3!==o.id))):t}function darFormatoSubTotalesParaFacturacion(o,t=!0){var e,a,i=o.filter(o=>-4===o.id)[0];return i?(e=o[o.length-1],a=parseFloat(e.importe),t&&(a+=-1*i.importe),e.importe=a.toFixed(2),o.filter(o=>-4!==o.id)):o}function getAmountTotalSubTotales(o){return o[o.length-1].importe}