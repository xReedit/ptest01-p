<dom-module id="x-comp-img-upload"><link rel="stylesheet"href="https://unpkg.com/cropperjs@1.6.1/dist/cropper.min.css"><script src="https://unpkg.com/cropperjs@1.6.1/dist/cropper.min.js"></script><template><div class="mode-selector"hidden$="[[isShowResult]]"><div class="btn-group mb-3"role="group"><button type="button"class="btn btn-sm"id="btnModoSubir"onclick='xCambiarModo("subir")'>üì§ Subir Foto</button> <button type="button"class="btn btn-sm"id="btnModoGenerar"onclick='xCambiarModo("generar")'>üîç Buscar Imagen</button></div></div><div id="modoSubir"class="modo-container"hidden$="[[isShowResult]]"><div class="upload-area"id="uploadArea"><div class="upload-placeholder"id="uploadPlaceholder"><i class="fa fa-cloud-upload fa-3x mb-3"style="color:#6c757d"></i><p class="mb-2"><strong>Arrastra tu imagen aqu√≠</strong><p class="text-muted mb-3">o</p><label for="fileInput"class="btn btn-primary btn-sm"><i class="fa fa-folder-open"></i> Seleccionar archivo</label> <input type="file"id="fileInput"accept="image/*"style="display:none"></div><div class="cropper-container-wrapper"id="cropperWrapper"style="display:none"><img id="cropperImage"style="max-width:100%"><div class="cropper-controls mt-3"><button class="btn btn-sm btn-secondary"onclick="xRotateImage(-90)"title="Rotar izquierda"><i class="fa fa-rotate-left"></i></button> <button class="btn btn-sm btn-secondary"onclick="xRotateImage(90)"title="Rotar derecha"><i class="fa fa-rotate-right"></i></button> <button class="btn btn-sm btn-secondary"onclick='xFlipImage("horizontal")'title="Voltear horizontal"><i class="fa fa-arrows-h"></i></button> <button class="btn btn-sm btn-secondary"onclick='xFlipImage("vertical")'title="Voltear vertical"><i class="fa fa-arrows-v"></i></button> <button class="btn btn-sm btn-secondary"onclick="xResetCropper()"title="Resetear"><i class="fa fa-refresh"></i></button> <button class="btn btn-sm btn-success ml-2"onclick="xEstablecerImagen()"><i class="fa fa-check"></i> Establecer</button> <button class="btn btn-sm btn-danger"onclick="xCancelarCrop()"><i class="fa fa-times"></i> Cancelar</button></div></div></div></div><div id="modoGenerar"class="modo-container"hidden$="[[isShowResult]]"style="display:none"><div class="ai-generator-container"><h5 class="mb-3">Buscar imagen del producto</h5><div class="input-group mb-3 text-center"><input id="searchInput"class="selected-template-1 w-100 text-center"placeholder="Ejemplo: ceviche peruano, lomo saltado, arroz con mariscos..."onkeypress='"Enter"===event.key&&xBuscarImagenes()'><br><br><button class="btn btn-sm btn-primary"onclick="xBuscarImagenes()"id="btnBuscar"><span id="btnBuscarText">üîç Buscar</span> <span id="btnBuscarSpinner"style="display:none"><span class="spinner-border spinner-border-sm"role="status"></span> Buscando...</span></button></div><div id="aiGallery"class="ai-gallery mt-4"style="display:none"><h6>Selecciona la imagen que m√°s te guste:</h6><div class="gallery-grid"id="galleryGrid"></div><div class="text-center mt-3"id="pexelsAttribution"style="display:none"><small class="text-muted">Fotos proporcionadas por <a href="https://www.pexels.com"target="_blank">Pexels</a> y <a href="https://unsplash.com"target="_blank">Unsplash</a></small></div></div></div></div><div hidden$="[[!isShowResult]]"class="animate__animated animate__fadeIn"><div hidden$="[[!isEstablecioImg]]"><button class="btn btn-sm btn-secondary mb-2"onclick="xEditarComImg()">Cambiar</button><div id="result"></div></div></div></template></dom-module><style>.mode-selector{text-align:center}.btn-group button{border:2px solid #dee2e6;background:#fff;color:#495057;padding:8px 20px;font-weight:500;transition:all .3s}.btn-group button:first-child{border-radius:6px 0 0 6px}.btn-group button:last-child{border-radius:0 6px 6px 0}.btn-group button.active{background:#007bff;color:#fff;border-color:#007bff}.btn-group button:hover:not(.active){background:#f8f9fa}.modo-container{min-height:300px}.upload-area{width:100%;max-width:800px;margin:0 auto}.upload-placeholder{border:3px dashed #dee2e6;border-radius:10px;padding:60px 20px;text-align:center;background:#f8f9fa;transition:all .3s;cursor:pointer}.upload-placeholder:hover{border-color:#007bff;background:#e7f3ff}.upload-placeholder.dragover{border-color:#28a745;background:#d4edda}.cropper-container-wrapper{width:100%}.cropper-controls{text-align:center;padding:15px;background:#f8f9fa;border-radius:5px}.cropper-controls button{margin:0 3px}#cropperImage{max-height:500px;width:100%}.ai-generator-container{max-width:600px;margin:0 auto;padding:20px;background:#f8f9fa;border-radius:8px}.ai-gallery{margin-top:20px}.gallery-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(200px,1fr));gap:15px;margin-top:15px}.gallery-item{position:relative;cursor:pointer;border-radius:8px;overflow:hidden;border:3px solid transparent;transition:all .3s}.gallery-item:hover{border-color:#007bff;transform:scale(1.05)}.gallery-item.selected{border-color:#28a745;box-shadow:0 0 15px rgba(40,167,69,.5)}.gallery-item img{width:100%;height:200px;object-fit:cover;display:block}.gallery-item .check-icon{position:absolute;top:10px;right:10px;background:#28a745;color:#fff;border-radius:50%;width:30px;height:30px;display:none;align-items:center;justify-content:center;font-size:18px}.gallery-item.selected .check-icon{display:flex}.gallery-item .photo-source{position:absolute;top:5px;left:5px;background:rgba(0,0,0,.8);color:#fff;padding:3px 8px;border-radius:3px;font-size:10px;font-weight:700}.gallery-item .photo-credit{position:absolute;bottom:0;left:0;right:0;background:rgba(0,0,0,.7);color:#fff;padding:5px;text-align:center;font-size:11px}#result img{border:2px solid #9e9e9e;border-radius:5px;max-width:100%}</style><script>var xThisCompImg,imgCompImgBase64,cropperInstance,selectedAIImage=null,currentMode="subir",scaleX=1,scaleY=1;function xComIniUpLoadImg(){const e=document.getElementById("fileInput");document.getElementById("uploadArea");const a=document.getElementById("uploadPlaceholder");document.getElementById("cropperWrapper"),document.getElementById("cropperImage");a.addEventListener("click",()=>{e.click()}),e.addEventListener("change",e=>{e=e.target.files[0];e&&e.type.startsWith("image/")&&xCargarImagenEnCropper(e)}),a.addEventListener("dragover",e=>{e.preventDefault(),a.classList.add("dragover")}),a.addEventListener("dragleave",()=>{a.classList.remove("dragover")}),a.addEventListener("drop",e=>{e.preventDefault(),a.classList.remove("dragover");e=e.dataTransfer.files[0];e&&e.type.startsWith("image/")&&xCargarImagenEnCropper(e)}),xCambiarModo("subir")}function xCargarImagenEnCropper(e){var a=new FileReader;const t=document.getElementById("uploadPlaceholder"),o=document.getElementById("cropperWrapper"),s=document.getElementById("cropperImage");a.onload=e=>{s.src=e.target.result,t.style.display="none",o.style.display="block",cropperInstance&&cropperInstance.destroy();e=xThisCompImg.medidasimg?xThisCompImg.medidasimg.width/xThisCompImg.medidasimg.height:365/210;cropperInstance=new Cropper(s,{aspectRatio:e,viewMode:1,dragMode:"move",autoCropArea:.8,restore:!1,guides:!0,center:!0,highlight:!0,cropBoxMovable:!0,cropBoxResizable:!1,toggleDragModeOnDblclick:!1,responsive:!0,background:!1,modal:!0,minContainerWidth:200,minContainerHeight:200,ready:function(){var e=xThisCompImg.medidasimg?xThisCompImg.medidasimg.width:365,a=xThisCompImg.medidasimg?xThisCompImg.medidasimg.height:210,t=cropperInstance.getContainerData(),t=(cropperInstance.getImageData(),Math.min(t.width/e,t.height/a));cropperInstance.setCropBoxData({width:e*t*.8,height:a*t*.8})}}),scaleY=scaleX=1},a.readAsDataURL(e)}function xRotateImage(e){cropperInstance&&cropperInstance.rotate(e)}function xFlipImage(e){cropperInstance&&("horizontal"===e?(scaleX*=-1,cropperInstance.scaleX(scaleX)):(scaleY*=-1,cropperInstance.scaleY(scaleY)))}function xResetCropper(){cropperInstance&&(cropperInstance.reset(),scaleY=scaleX=1)}function xEstablecerImagen(){var e,a;cropperInstance&&(a=xThisCompImg.medidasimg?xThisCompImg.medidasimg.width:365,e=xThisCompImg.medidasimg?xThisCompImg.medidasimg.height:210,a=cropperInstance.getCroppedCanvas({width:a,height:e,imageSmoothingEnabled:!0,imageSmoothingQuality:"high"}),imgCompImgBase64=a.toDataURL("image/jpeg",.9),xThisCompImg.isShowResult=!0,xThisCompImg.isEstablecioImg=!0,xThisCompImg.isUploadImg=!0,$("#result").html('<img src="'+imgCompImgBase64+'" />'),xCancelarCrop())}function xCancelarCrop(){var e=document.getElementById("uploadPlaceholder"),a=document.getElementById("cropperWrapper"),t=document.getElementById("fileInput");cropperInstance&&(cropperInstance.destroy(),cropperInstance=null),e.style.display="block",a.style.display="none",t.value="",scaleY=scaleX=1}function xCambiarModo(e){currentMode=e;var a=document.getElementById("modoSubir"),t=document.getElementById("modoGenerar"),o=document.getElementById("btnModoSubir"),s=document.getElementById("btnModoGenerar");"subir"===e?(a.style.display="block",t.style.display="none",o.classList.add("active"),s.classList.remove("active")):(a.style.display="none",t.style.display="block",o.classList.remove("active"),s.classList.add("active"))}async function xBuscarImagenes(){var e=document.getElementById("searchInput").value.trim();if(e){var a=document.getElementById("btnBuscar"),t=document.getElementById("btnBuscarText"),o=document.getElementById("btnBuscarSpinner");t.style.display="none",o.style.display="inline-block",a.disabled=!0;try{var s=await(await fetch("../../bdphp/pexels_search.php",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({query:e,per_page:15})})).json();s.success&&s.photos&&0<s.photos.length?xMostrarGaleriaIA(s.photos):alert("No se encontraron im√°genes. Intenta con otro t√©rmino de b√∫squeda.")}catch(e){alert("Error al buscar im√°genes")}finally{t.style.display="inline-block",o.style.display="none",a.disabled=!1}}else alert("Por favor, ingresa un t√©rmino de b√∫squeda")}function xMostrarGaleriaIA(e){var a=document.getElementById("aiGallery");const s=document.getElementById("galleryGrid");var t=document.getElementById("pexelsAttribution");s.innerHTML="",e.forEach((e,a)=>{const t=document.createElement("div");t.className="gallery-item";var o="Unsplash"===e.source?"üì∏":"üñºÔ∏è";t.innerHTML=`
                <img src="${e.src.medium}" alt="${e.alt||"Imagen de comida"}">
                <div class="check-icon">‚úì</div>
                <div class="photo-source">
                    <small>${o} ${e.source}</small>
                </div>
                <div class="photo-credit">
                    <small>Por ${e.photographer}</small>
                </div>
            `,t.onclick=()=>xSeleccionarImagenIA(e,t),s.appendChild(t)}),a.style.display="block",t.style.display="block"}function xSeleccionarImagenIA(e,a){document.querySelectorAll(".gallery-item").forEach(e=>{e.classList.remove("selected")}),a.classList.add("selected"),xCargarImagenPexelsEnCropper(selectedAIImage=e)}async function xCargarImagenPexelsEnCropper(e){try{var a=e.src.large||e.src.original,t=await(await fetch(a)).blob(),o=new File([t],"pexels-image.jpg",{type:"image/jpeg"}),s=(xCambiarModo("subir"),document.getElementById("aiGallery"));s&&(s.style.display="none"),xCargarImagenEnCropper(o)}catch(e){alert("Error al cargar la imagen. Por favor, intenta con otra.")}}function xEditarComImg(){xThisCompImg.isShowResult=!1,selectedAIImage=null,xCancelarCrop();var e=document.getElementById("aiGallery"),e=(e&&(e.style.display="none"),document.getElementById("aiPrompt"));e&&(e.value="")}function setImagenFile(e){var a;imgCompImgBase64=e&&""!==e&&null!=e?(xThisCompImg.isShowResult=!0,xThisCompImg.isEstablecioImg=!0,xThisCompImg.isUploadImg=!1,a='<img src="'+e+'" />',$("#result").html(a),e):(xThisCompImg.isShowResult=!1,xThisCompImg.isEstablecioImg=!1,xThisCompImg.isUploadImg=!1,"")}Polymer({is:"x-comp-img-upload",properties:{isShowResult:Boolean,medidasimg:[],medidascontent:[],isEstablecioImg:Boolean,isUploadImg:Boolean},attached:function(){this.isShowResult=!1,this.isEstablecioImg=!1,this.isUploadImg=!1,xThisCompImg=this,setTimeout(()=>{xComIniUpLoadImg()},100)},getImgBase64:()=>imgCompImgBase64,getIsEstablecioImg:()=>xThisCompImg.isEstablecioImg,getIsUploadImg:()=>xThisCompImg.isUploadImg,setImgPathFile:e=>{setImagenFile(e)},resetControl:()=>{xThisCompImg.isShowResult=!1,xThisCompImg.isEstablecioImg=!1,xThisCompImg.isUploadImg=!1,selectedAIImage=null,xCancelarCrop();var e=document.getElementById("aiGallery"),e=(e&&(e.style.display="none"),document.getElementById("aiPrompt"));e&&(e.value="")},setMedidas:e=>{this.medidasimg=e,cropperInstance&&(e=e.width/e.height,cropperInstance.setAspectRatio(e))}})</script>