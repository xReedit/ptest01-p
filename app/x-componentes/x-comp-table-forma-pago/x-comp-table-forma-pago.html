<link rel="import"href="../../web_components/polymer/polymer.html"><link rel="import"href="../x-comp-find-tipo-pago-option/x-comp-find-tipo-pago-option.html"><dom-module id="x-comp-table-forma-pago"><template is="dom-bind"><div><paper-fab icon="add"hidden$="[[ispagoapp]]"onclick="_addRow()"title="Agregar Tipo de Pago"tabindex="0"class="btnAdd2"></paper-fab><br><table class$="{{_class}}"style="width:100%"id="table_op_fp"><thead><th align="left">Forma de pago<th align="left"style="min-width:100px"><tbody><template is="dom-repeat"items="{{listTabla}}"as="item"><tr><td><div style="display:flex;align-items:flex-start"><x-comp-find-tipo-pago-option class="tpf_option"novisibles$="{{item.novisibles}}"deshabilitado$="{{item.deshabilitado}}"ispagoappop$="[[ispagoapp]]"onclick="xCalcImporte()"id="comp-pago-option"></x-comp-find-tipo-pago-option><div class="xMiBoton_icon_option"hidden$="{{item.hiddenIconBorrar}}"data-index="{{index}}"onclick="_borrarRow(this)"><paper-icon-button src="../../../images/delete.png"alt="delete"title="Borrar"></paper-icon-button></div></div><td><div class="w-100"><input type="number"min="1"hidden$="[[!item.contentPinPad.hidden_content]]"id$="{{item.idText}}"pattern="[0-9]+([\.,][0-9]+)?"step="any"class="xMiInput xfont16 xtxtCentro xmonto animated"onblur="xRetornaMoneda(this)"onkeyup="xCalcImporte()"disabled="{{item.deshabilitado}}"onclick="this.select()"value$="{{item.importe}}"anchofull><div hidden$="[[item.contentPinPad.hidden_content]]"class="animated animate__headShake"><div hidden$="[[item.contentPinPad.transaction.show]]"><div hidden$="[[item.contentPinPad.hidden_progress]]"><paper-progress id="tp_pinpad_loader_progress"indeterminate style="width:100%"></paper-progress><p class="text-success fs-11 fw-600"hidden$="[[!item.contentPinPad.transaction.loader]]">Procesando pago, espere</div><div hidden$="[[!item.contentPinPad.hidden_progress]]"class="w-100"><div hidden$="[[!item.contentPinPad.success]]"class="d-flexx justify-content-between align-items-center"><p class="text-success fs-9 fw-600">Pinpad Disponible</p><button class="btn btn-sm btn-success"on-click="sendOrderPinPad">Cobrar [[item.contentPinPad.amount]]</button></div><div hidden$="[[item.contentPinPad.success]]"><p class="text-danger fs-11 fw-600">[[item.contentPinPad.message]]</div></div></div><div hidden$="[[!item.contentPinPad.transaction.show]]"><div hidden$="[[!item.contentPinPad.transaction.loader]]"><paper-progress id="tp_pinpad_loader_progress"indeterminate style="width:100%"></paper-progress><p class="text-success fs-12 fw-600"hidden$="[[!item.contentPinPad.transaction.loader]]">Procesando, espere.</div><div hidden$="[[item.contentPinPad.transaction.loader]]"><div hidden$="[[!item.contentPinPad.transaction.success]]"class="d-flexx justify-content-between align-items-center"><p class="text-success fs-12 fw-600">[[item.contentPinPad.transaction.message]]</p><i class="fa fa-check text-success"></i></div><div hidden$="[[item.contentPinPad.transaction.success]]"class="d-flexx justify-content-between align-items-center"><p class="text-danger fs-12 fw-600">[[item.contentPinPad.transaction.message]]</p><i class="fa fa-times text-danger"></i></div></div></div></div></div></template></table></div></template><script>var xThisComTableFP,xCompOptionPago,itemOptionTpSelected,maxRow=3,_noVisibles="",listIni=[],_valImporteRestante=0;function xIniCompTableOption(){xThisComTableFP.listTabla=[],listIni=[],_noVisibles="",_valImporteRestante=0,_addRow(),xCompOptionPago=document.getElementById("comp-pago-option");try{$(document).on("getValorIncial",".tpf_option",function(e){itemOptionTpSelected=e.detail.values,xCalcImporte(),e.stopPropagation(),e.stopImmediatePropagation()})}catch(e){}}function _addRow(){var e,t=listIni?listIni.length:0;maxRow<=t||(e=!0,xSetNoVisibles(),0<t?(listIni.map((e,t)=>{e.deshabilitado=!0}),xCalcImporte(),e=!1):importeSave=xThisComTableFP.importetotal,_valImporteRestante<=0&&0<t)||(listIni.push({idText:"tpf_option"+t,index:t,importe:_valImporteRestante.toFixed(2),deshabilitado:!1,novisibles:_noVisibles,hiddenIconBorrar:e,contentPinPad:{hidden_content:!0,hidden_progress:!0,amount:0,success:!1,message:"",transaction:{show:!1,loader:!1,success:!1,message:""}}}),xThisComTableFP.listTabla=JSON.parse(JSON.stringify(listIni)),xThisComTableFP.listPagoSeleted=listIni,setTimeout(()=>{xCalcImporte(),isSynOsWinOrMac()&&($("table input.xmonto").last().focus(),$("table input.xmonto").last().select())},200),xThisComTableFP.fire("xCompTableAddRemoveRow",!0))}function xCalcImporte(){var o,n,s,l=0,e=(listIni.map((e,t)=>{var i="#tpf_option"+t,a=$(i).parents("tr").find(".tpf_option .xMiBoton_icon_option[selected]")[0];s=parseFloat(xThisComTableFP.importetotal),n=s-l,o=parseFloat($(i).val()),o=isNaN(o)?0:o,e.importe_recibido=o,o=parseFloat(e.importe_recibido)>=s?s:e.importe_recibido,o=0===(o=isNaN(parseFloat(o))?0:parseFloat(o))?0<t?n:s:o,o=0<t&&n<o?n:o,e.importe=parseFloat(o).toFixed(2),a&&(e.id=a.dataId,e.reqcliente=a.dataReqcliente,e.limite=a.dataLimite,e.des_tp=a.dataDescripcion),l+=parseFloat(e.importe_recibido)}),_valImporteRestante=0===l?0:s-l,xThisComTableFP.valImporteRestante=_valImporteRestante,xThisComTableFP.listTabla=JSON.parse(JSON.stringify(listIni)),listIni[listIni.length-1]);12==e.id?xThisComTableFP.evalPinPad(e):(e.contentPinPad.hidden_content=!0,e.contentPinPad.hidden_progress=!0),xThisComTableFP.listTabla=JSON.parse(JSON.stringify(listIni)),xThisComTableFP.listPagoSeleted=listIni,xThisComTableFP.fire("xCompTableChange",{datos:listIni,evento:event})}function xSetNoVisibles(){var i="";$(".tpf_option .xMiBoton_icon_option[selected]").each((e,t)=>{i+=t.dataId+","}),_noVisibles=0<listIni.length?i:""}function xResetFirstOption(){$(".tpf_option").each((e,t)=>{t.setResetFirstOption()}),listIni[0].importe="0.00",xThisComTableFP.listTabla=JSON.parse(JSON.stringify(listIni))}function _borrarRow(e){e=e.dataIndex;(listIni=listIni.slice(0,e))[listIni.length-1].deshabilitado=!1,xSetNoVisibles(),xThisComTableFP.listTabla=JSON.parse(JSON.stringify(listIni)),xCalcImporte(),xThisComTableFP.fire("xCompTableAddRemoveRow",!0)}function xResetOptions(){xCompOptionPago&&xCompOptionPago.setResetOption()}Polymer({is:"x-comp-table-forma-pago",properties:{_class:{type:String,value:"xtable3 xRowPading2"},ispagoapp:{type:Boolean,value:!1},importetotal:{type:String,value:"0"},valImporteRestante:{type:String,value:"0"},listTabla:[],listPagoSeleted:{type:Object,value:[]},valIdInt:{type:Object,notify:!0,reflectToAttribute:!0},pindPadShowCheck:{type:Boolean,value:!1},pinPadResponse:{type:Object,value:{}}},listeners:{onchange:"getTipoTablePagoOption"},setRsetList:()=>{xResetOptions()},tipoPagoNameChanged:function(e){return e},getTipoTablePagoOption(){return xThisComTableFP.listTabla},attached:function(){(xThisComTableFP=this).listTabla=[],xIniCompTableOption()},detached:()=>{xThisComTableFP.listTabla=[]},getValorIncial:function(e){this.fire("getValorIncial",{values:e})},resetFormaPago:()=>{xThisComTableFP.listTabla=[],xThisComTableFP.valImporteRestante="0",setTimeout(()=>{xIniCompTableOption(),xResetFirstOption()},200)},_isEqualToApp:()=>xThisComTableFP.ispagoapp,getListPagoSeleted:()=>xThisComTableFP.listPagoSeleted,evalPinPad:async e=>{var t,i;this.pindPadShowCheck||(this.pindPadShowCheck=!0,e.contentPinPad.hidden_content=!1,e.contentPinPad.hidden_progress=!1,e.contentPinPad.success=!1,e.contentPinPad.message="",(t=localStorage.getItem("::app3_pinpad_sn"))?(t=await testConnectionPinPad(t),this.pindPadShowCheck=!1,e.contentPinPad.success=t.success,t.success?(e.contentPinPad.hidden_progress=!0,t=xThisComTableFP.listTabla.filter(e=>12!=e.id).map(e=>parseFloat(e.importe)).reduce((e,t)=>e+t,0),t=0==(t=parseFloat(xThisComTableFP.importetotal)-t)?xThisComTableFP.importetotal:t,t=parseFloat(t).toFixed(2),e.contentPinPad.amount=t,e.importe_recibido=t,e.importe=t,i="#tpf_option"+e.index,$(i).val(t)):(e.contentPinPad.hidden_progress=!0,e.contentPinPad.message="PinPad no disponible.")):(e.contentPinPad.hidden_progress=!0,e.contentPinPad.success=!1,e.contentPinPad.message="PinPad no asignado."),xThisComTableFP.listTabla=JSON.parse(JSON.stringify(listIni)))},sendOrderPinPad:async e=>{var e=e.model.item,e=listIni[e.index],t=(e.contentPinPad.transaction.show=!0,e.contentPinPad.transaction.loader=!0,xThisComTableFP.listTabla=JSON.parse(JSON.stringify(listIni)),{operation:"01",amount:e.importe}),t=await sendTransactionPinPad(t);e.contentPinPad.transaction.show=!0,e.contentPinPad.transaction.loader=!1,e.contentPinPad.transaction.success=t.success,e.contentPinPad.transaction.message=t.success?t.data.message:"Error no se pudo realizar la transacciÃ³n.",xThisComTableFP.listTabla=JSON.parse(JSON.stringify(listIni)),t.success&&xThisComTableFP.fire("xCompTablePinPadSuccess",t),this.pinPadResponse=t},getResponsePinPad:()=>this.pinPadResponse,cleanResponsePinPad:()=>{this.pinPadResponse={}}})</script></dom-module>