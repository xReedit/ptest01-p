<link rel="import"href="../../web_components/polymer/polymer.html"><link rel="import"href="../x-comp-find-tipo-pago-option/x-comp-find-tipo-pago-option.html"><dom-module id="x-comp-table-forma-pago"><template is="dom-bind"><div><paper-fab icon="add"hidden$="[[ispagoapp]]"onclick="_addRow()"title="Agregar Tipo de Pago"tabindex="0"class="btnAdd2"></paper-fab><br><table class$="{{_class}}"style="width:100%"id="table_op_fp"><thead><th align="left">Forma de pago<th align="left">Monto<tbody><template is="dom-repeat"items="{{listTabla}}"as="item"><tr><td><div style="display:flex;align-items:flex-start"><x-comp-find-tipo-pago-option class="tpf_option"novisibles$="{{item.novisibles}}"deshabilitado$="{{item.deshabilitado}}"ispagoappop$="[[ispagoapp]]"onclick="xCalcImporte()"id="comp-pago-option"></x-comp-find-tipo-pago-option><div class="xMiBoton_icon_option"hidden$="{{item.hiddenIconBorrar}}"data-index="{{index}}"onclick="_borrarRow(this)"><paper-icon-button src="../../../images/delete.png"alt="delete"title="Borrar"></paper-icon-button></div></div><td><input type="number"min="1"id$="{{item.idText}}"pattern="[0-9]+([\.,][0-9]+)?"step="any"class="xMiInput xfont16 xtxtCentro xmonto"onblur="xRetornaMoneda(this)"onkeyup="xCalcImporte()"disabled="{{item.deshabilitado}}"onclick="this.select()"value$="{{item.importe}}"anchofull></template></table></div></template><script>var xThisComTableFP,xCompOptionPago,itemOptionTpSelected,maxRow=3,_noVisibles="",listIni=[],_valImporteRestante=0;function xIniCompTableOption(){xThisComTableFP.listTabla=[],listIni=[],_noVisibles="",_valImporteRestante=0,_addRow(),xCompOptionPago=document.getElementById("comp-pago-option");try{$(document).on("getValorIncial",".tpf_option",function(t){itemOptionTpSelected=t.detail.values,xCalcImporte(),t.stopPropagation(),t.stopImmediatePropagation()})}catch(t){}}function _addRow(){var t,e=listIni?listIni.length:0;maxRow<=e||(t=!0,xSetNoVisibles(),0<e?(listIni.map((t,e)=>{t.deshabilitado=!0}),xCalcImporte(),t=!1):importeSave=xThisComTableFP.importetotal,_valImporteRestante<=0&&0<e)||(listIni.push({idText:"tpf_option"+e,index:e,importe:_valImporteRestante.toFixed(2),deshabilitado:!1,novisibles:_noVisibles,hiddenIconBorrar:t}),xThisComTableFP.listTabla=JSON.parse(JSON.stringify(listIni)),xThisComTableFP.listPagoSeleted=listIni,setTimeout(()=>{xCalcImporte(),isSynOsWinOrMac()&&($("table input.xmonto").last().focus(),$("table input.xmonto").last().select())},200),xThisComTableFP.fire("xCompTableAddRemoveRow",!0))}function xCalcImporte(){var a,l,s,n=0;listIni.map((t,e)=>{var i="#tpf_option"+e,o=$(i).parents("tr").find(".tpf_option .xMiBoton_icon_option[selected]")[0];s=parseFloat(xThisComTableFP.importetotal),l=s-n,a=parseFloat($(i).val()),a=isNaN(a)?0:a,t.importe_recibido=a,a=parseFloat(t.importe_recibido)>=s?s:t.importe_recibido,a=0===(a=isNaN(parseFloat(a))?0:parseFloat(a))?0<e?l:s:a,a=0<e&&l<a?l:a,t.importe=parseFloat(a).toFixed(2),o&&(t.id=o.dataId,t.reqcliente=o.dataReqcliente,t.limite=o.dataLimite,t.des_tp=o.dataDescripcion),n+=parseFloat(t.importe_recibido)}),_valImporteRestante=0===n?0:s-n,xThisComTableFP.valImporteRestante=_valImporteRestante<.01?0:_valImporteRestante,xThisComTableFP.listPagoSeleted=listIni,xThisComTableFP.fire("xCompTableChange",{datos:listIni,evento:event})}function xSetNoVisibles(){var i="";$(".tpf_option .xMiBoton_icon_option[selected]").each((t,e)=>{i+=e.dataId+","}),_noVisibles=0<listIni.length?i:""}function xResetFirstOption(){$(".tpf_option").each((t,e)=>{e.setResetFirstOption()}),listIni[0].importe="0.00",xThisComTableFP.listTabla=JSON.parse(JSON.stringify(listIni))}function _borrarRow(t){t=t.dataIndex;(listIni=listIni.slice(0,t))[listIni.length-1].deshabilitado=!1,xSetNoVisibles(),xThisComTableFP.listTabla=JSON.parse(JSON.stringify(listIni)),xCalcImporte(),xThisComTableFP.fire("xCompTableAddRemoveRow",!0)}function xResetOptions(){xCompOptionPago&&xCompOptionPago.setResetOption()}Polymer({is:"x-comp-table-forma-pago",properties:{_class:{type:String,value:"xtable3 xRowPading2"},ispagoapp:{type:Boolean,value:!1},importetotal:{type:String,value:"0"},valImporteRestante:{type:String,value:"0"},listTabla:[],listPagoSeleted:{type:Object,value:[]},valIdInt:{type:Object,notify:!0,reflectToAttribute:!0}},listeners:{onchange:"getTipoTablePagoOption"},setRsetList:()=>{xResetOptions()},tipoPagoNameChanged:function(t){return t},getTipoTablePagoOption(){return xThisComTableFP.listTabla},attached:function(){(xThisComTableFP=this).listTabla=[],xIniCompTableOption()},detached:()=>{xThisComTableFP.listTabla=[]},getValorIncial:function(t){this.fire("getValorIncial",{values:t})},resetFormaPago:()=>{xThisComTableFP.listTabla=[],xThisComTableFP.valImporteRestante="0",setTimeout(()=>{xIniCompTableOption(),xResetFirstOption()},200)},_isEqualToApp:()=>xThisComTableFP.ispagoapp,getListPagoSeleted:()=>xThisComTableFP.listPagoSeleted})</script></dom-module>