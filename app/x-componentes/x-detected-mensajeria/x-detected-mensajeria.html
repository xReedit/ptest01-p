<link rel="import"href="../../../bower_components/polymer/polymer.html"><link rel="import"href="../../../bower_components/iron-icon/iron-icon.html"><link rel="import"href="../../../bower_components/iron-icons/iron-icons.html"><script src="../../view/socket.service.p.js"></script><dom-module id="x-detected-mensajeria"><template><style>:host{display:block}.container-status{padding:12px 16px;border-radius:8px;display:flex;align-items:center;gap:12px;transition:all .3s ease}:host([compact]) .container-status{padding:6px 12px;gap:8px;border-radius:20px;display:inline-flex;width:auto;max-width:100%}.status-conectado{background:#d4edda2e;border:1px solid #c3e6cb;color:#202020}:host([compact]) .status-conectado{background:rgba(40,167,69,.15);border:1px solid rgba(40,167,69,.3);color:#fff}.status-desconectado{background:#fff3cdb8;color:#202020}.icon-status{font-size:24px;flex-shrink:0}:host([compact]) .icon-status{font-size:16px}.icon-conectado{color:#28a745}:host([compact]) .icon-conectado{color:#4ade80}.icon-desconectado{color:#ffc107}.content-status{flex:1}:host([compact]) .content-status{flex:0 1 auto}.title-status{font-weight:600;font-size:14px;margin:0 0 4px 0}:host([compact]) .title-status{font-size:13px;margin:0;font-weight:500}.desc-status{font-size:12px;margin:0;opacity:.9}:host([compact]) .desc-status{display:none}.btn-conectar{background:#007bff;color:#fff;border:none;padding:8px 16px;border-radius:4px;font-size:13px;font-weight:500;cursor:pointer;transition:background .2s;white-space:nowrap}:host([compact]) .btn-conectar{padding:6px 12px;font-size:11px}.btn-conectar:hover{background:#0056b3}.btn-reconectar{background:0 0;color:#155724;border:1px solid #28a745;padding:6px 12px;border-radius:4px;font-size:12px;cursor:pointer;transition:all .2s}:host([compact]) .btn-reconectar{padding:4px 8px;font-size:10px}.btn-reconectar:hover{background:#28a745;color:#fff}.loading-dots{display:inline-block}.loading-dots:after{content:'.';animation:dots 1.5s steps(3,end) infinite}@keyframes dots{0%,20%{content:'.'}40%{content:'..'}100%,60%{content:'...'}}</style><div class$="container-status [[_getStatusClass(isConectado, isChecking)]]"><template is="dom-if"if="[[!isChecking]]"><iron-icon class$="icon-status [[_getIconClass(isConectado)]]"icon="[[_getIcon(isConectado)]]"></iron-icon></template><template is="dom-if"if="[[isChecking]]"><iron-icon class="icon-status"icon="icons:refresh"style="color:#6c757d;animation:spin 1s linear infinite"></iron-icon></template><div class="content-status"><template is="dom-if"if="[[isChecking]]"><p class="title-status">Verificando conexión<span class="loading-dots"></span><p class="desc-status">Comprobando servicio de mensajería</template><template is="dom-if"if="[[_showConectado(isConectado, isChecking)]]"><p class="title-status">[[_getTituloConectado(compact)]]<p class="desc-status">El servicio está activo y funcionando correctamente</template><template is="dom-if"if="[[_showDesconectado(isConectado, isChecking)]]"><p class="title-status">[[_getTituloDesconectado(compact)]]<p class="desc-status">Es necesario conectar el servicio de mensajería</template></div><template is="dom-if"if="[[_showBotonConectar(isConectado, isChecking)]]"><button class="btn-conectar"on-click="_irAMensajeria">Conectar WhastApp Ahora</button></template><template is="dom-if"if="[[_showBotonReconectar(isConectado, isChecking, compact)]]"><button class="btn-reconectar"on-click="_verificarConexion"><iron-icon icon="icons:refresh"style="width:14px;height:14px;vertical-align:middle"></iron-icon>Verificar</button></template></div><style>@keyframes spin{from{transform:rotate(0)}to{transform:rotate(360deg)}}</style></template><script>Polymer({is:"x-detected-mensajeria",properties:{isConectado:{type:Boolean,value:!1,notify:!0},isChecking:{type:Boolean,value:!0},autoCheck:{type:Boolean,value:!0},checkInterval:{type:Number,value:3e4},compact:{type:Boolean,value:!1,reflectToAttribute:!0}},ready:function(){setTimeout(()=>{this._verificarConexion(),this.autoCheck&&this._startAutoCheck()},3e3)},detached:function(){this._stopAutoCheck()},_getCodigoComercio:function(){if("undefined"!=typeof xIdOrg&&"undefined"!=typeof xIdSede&&xIdOrg&&xIdSede)return xIdOrg+""+xIdSede;try{var e=window.localStorage.getItem("::app3_wo"),t=window.localStorage.getItem("::app3_woS");if(e&&t)return e+""+t}catch(e){}return"undefined"!=typeof xSysResto&&xSysResto.xIdOrg&&xSysResto.xIdSede?xSysResto.xIdOrg+""+xSysResto.xIdSede:null},_verificarConexion:function(){this.isChecking=!0;var e=this._getCodigoComercio();"function"==typeof _cpSocketOpen&&_cpSocketOpen(),"function"==typeof _cpSocketPingMensajeria?_cpSocketPingMensajeria(e).then(e=>{this.isConectado=e,this.isChecking=!1,this.fire("mensajeria-status-changed",{isConectado:e})}).catch(e=>{this.isConectado=!1,this.isChecking=!1}):(this.isConectado=!1,this.isChecking=!1)},_startAutoCheck:function(){this._stopAutoCheck(),this._intervalId=setInterval(()=>{this.isChecking||this._verificarConexion()},this.checkInterval)},_stopAutoCheck:function(){this._intervalId&&(clearInterval(this._intervalId),this._intervalId=null)},_irAMensajeria:function(){xOpenPage(60)},_getStatusClass:function(e,t){return t?"":e?"status-conectado":"status-desconectado"},_getIconClass:function(e){return e?"icon-conectado":"icon-desconectado"},_getIcon:function(e){return e?"icons:check-circle":"icons:warning"},_showConectado:function(e,t){return!t&&e},_showDesconectado:function(e,t){return!t&&!e},_showBotonConectar:function(e,t){return!t&&!e},_showBotonReconectar:function(e,t,n){return!n&&!t&&e},checkConnection:function(){this._verificarConexion()},_getTituloConectado:function(e){return e?"WhatsApp Conectado":"Mensajería WhatsApp Conectada"},_getTituloDesconectado:function(e){return e?"WhatsApp Desconectado":"Mensajería WhatsApp Desconectada"}})</script></dom-module>