<dom-module id="x-comp-item-subitems"><link rel="import"href="../../x-componentes/x-comp-ctrl-add-fast/x-comp-ctrl-add-fast.html"><template><paper-dialog id="dialog_item_comp"class="xDlgItem_mipedido dialog_redondo dlg-subitems"modal entry-animation="scale-up-animation"exit-animation="fade-out-animation"with-backdrop><div style="max-height:82vh"><div class="xheader-top"><h4>{{desProducto}} <span class="xmenu_item_2"id="contetStock">{{stockProducto}}</span></h4></div><div class="body-content"><div hidden$="[[ !isShowDetalleProducto ]]"class="pb-10"><span class="fs-12 color-secundario">{{detalleProducto}}</span><br></div><div hidden$="[[ !isExistSubitems ]]"class="div-content-subitems"><template is="dom-repeat"items="[[listContentSub]]"as="contentSub"><div class="div-subitem"><div class="xtitulo-subitems"><div><p class="xBold">{{ labelUpperCase(contentSub.des) }}</p><span class="fs-12 color-secundario">{{contentSub.des_cant_select}} {{contentSub.subitem_cant_select}}</span> <span class="txt-obligatorio"hidden$="[[!contentSub.isObligatorio]]">Obligatorio</span></div></div><div id="group-[[contentSub.iditem_subitem_content]]"><template is="dom-repeat"items="[[contentSub.opciones]]"as="subitem"><div class="xoption w-100 xCursor"hidden$="{{isSubItemCheckBox(contentSub.show_cant_item)}}"><paper-checkbox data-item="{{subitem}}"data-idcontent="{{contentSub.iditem_subitem_content}}"data-id="{{index}}"checked$="[[subitem.selected]]"class="check-subitem w-100"disabled$="[[subitem.disabled]]"onchange="addSubItem(this)"><div class$="[[subitem.classAgotado]]">{{subitem.des}} <span class="xprecio"hidden$="[[!subitem.cantidad_visible]]">| [[subitem.cantidad]] </span><span class="xprecio aling-derecha"hidden$="[[!subitem.precio_visible]]">+ {{subitem.precio}}</span></div></paper-checkbox></div><div class="xoption w-100 xCursor"hidden$="{{!isSubItemCheckBox(contentSub.show_cant_item)}}"><div class$="[[subitem.classAgotado]] w-100"><div class="div-count-subitem pl-2"><div>{{subitem.des}} <span class="xprecio"hidden$="[[!subitem.cantidad_visible]]">| [[subitem.cantidad]]</span></div><div class="d-flexx align-content-center align-items-center"><p class="xprecio mr-2"style="width:15px"hidden$="[[!subitem.precio_visible]]">+ {{subitem.precio}}</p><x-comp-ctrl-add-fast on-chagecount="handleCountChange"iditem_subitem_content="[[contentSub.iditem_subitem_content]]"subitem="{{subitem}}"descripcion_item_ini="[[subitem.des]]"max-quantity="[[contentSub.subitem_cant_select]]"></x-comp-ctrl-add-fast></div></div></div></div></template></div></div></template><br><br></div><div class="div-add-item"><div class="xreferencia_item pr-2"><label for="txt_referencia"class="xBold">Instrucciones adicionales</label> <input autocomplete="on"placeholder="Agregue una nota (poco aji, sin arroz, etc.)"class="xMiTextReferencia text-primary fw-900"id="txt_referencia"onkeyup="xChangeIndicacionesItem()"><hr></div><div class="add-count"><span class="xColorRow_Rojo"hidden$="[[isOptionRequeridosComplet]]">Hay opciones requeridas por marcar</span><div class="xdlgBody"id="_xdlgBody"disabled$="[[!isOptionRequeridosComplet]]"><div class="spinner"><paper-spinner active></paper-spinner></div></div></div></div></div><div class="xfooter-bottom"><button class="xBoton2 xPlomo xInvisible"id="dlgBtn"onclick="xListoDlgVR_comp()">Cerrar</button><div class="txt-precio">{{precioProducto}}</div></div></div></paper-dialog></template></dom-module><style>hr{background:#e0e0e0}.subitem-content{display:inline-flex;width:100%;padding-bottom:20px;background:#fafad2;padding:5px;flex-wrap:wrap;margin-top:20px;margin-bottom:20px;border-top:1px solid #bdbdbd;border-bottom:1px solid #bdbdbd}.subitem-content .xoption{display:inline-flex;padding-right:8px;min-width:150px;font-size:12px}.subitem-content .xoption .agotado{text-decoration:line-through;color:#db7093}.subitem-content .xoption .xprecio{font-size:10px;color:#757575;width:25px!important}.xstock_item.xstock_item-redondo{border-radius:50%;padding:8px 10px 8px 10px}.xtitulo-subitems{background:#eee;width:100%;padding:5px;border-radius:2px}.xoption{padding-right:8px;min-width:150px;font-size:12px;display:inline-flex;border-bottom:1px solid #e0e0e0;padding-bottom:5px;padding-top:5px}.xoption .agotado{text-decoration:line-through;color:#db7093}.xoption .xprecio{font-size:10px;color:#757575;width:25px!important}.xprecio.aling-derecha{position:relative;float:right}.xhidden{display:none!important}.txt-obligatorio{font-size:12px;background:#bdbdbd;padding:6px;margin-left:5px;border-radius:8px;position:relative;float:right;top:-18px}.xheader-top{padding:25px 0 5px;background:#fff;position:sticky;top:0;z-index:1;border-bottom:1px solid #d3d3d3;padding-bottom:5px;margin-top:-32px}.xfooter-bottom{position:sticky;bottom:-10px;z-index:1;border-top:1px solid #d3d3d3;background:#fff;padding-top:10px;padding-bottom:10px}.txt-precio{position:absolute;top:0;right:0;font-size:20px;padding:20px}.body-content{position:relative;top:15px;margin-bottom:15px}#contetStock{border-radius:5px;padding:3px;font-weight:100}#checkboxLabel{width:90%}#checkboxLabel div{display:flex;justify-content:space-between}#_xdlgBody[disabled]{pointer-events:none;opacity:.43}.div-content-subitems{display:grid;grid-template-columns:repeat(auto-fill,minmax(300px,1fr));gap:10px;width:100%}.div-add-item{display:grid;grid-template-columns:repeat(auto-fill,minmax(300px,1fr));gap:10px;width:100%;align-items:center;background:#f2f9ff;padding-top:10px}.div-subitem{padding:5px;border-radius:10px;margin-right:5px;margin-bottom:5px;width:100%;display:block}.dlg-subitems{padding:0;width:400px;overflow-x:auto}.div-count-subitem{display:flex;align-items:center;justify-content:space-between;width:100%}.dlg-subitems-on-option{padding:0;width:400px!important;overflow-x:auto}@media screen and (min-width:870px){.dlg-subitems-with-items{width:700px}.div-subitem{max-width:300px;min-width:200px}}@media screen and (max-width:870px){.div-add-item{background:0 0}}</style><script>var xThisComSubItem,itemPedidos_objItemSelected,_precioProductoIni,_precioProductoUnitario,isExistSubitems=!1,keyStorageListSubItem="::app3_listSubItem";async function xOpenDlgItemVR_comp(e,t){const i=(itemPedidos_objItemSelected=itemPedidos_objItemSelected||xGeneralDataCarta.filter(e=>e.idcarta_lista==t)[0]).iditem2||itemPedidos_objItemSelected.iditem;xThisComSubItem.isOptionRequeridosComplet=!1,(itemPedidos_objItemSelected=e?xGeneralDataCarta.filter(e=>e.iditem==i)[0]:itemPedidos_objItemSelected).des=itemPedidos_objItemSelected.des||itemPedidos_objItemSelected.des_item,xThisComSubItem.desProducto=itemPedidos_objItemSelected.des,xThisComSubItem.detalleProducto=itemPedidos_objItemSelected.detalle,xThisComSubItem.stockProducto=itemPedidos_objItemSelected.stock_actual,_precioProductoUnitario=itemPedidos_objItemSelected.precio,xThisComSubItem.isShowDetalleProducto=""!==xThisComSubItem.detalleProducto,_precioProductoIni=compGetTotalItemTPC(),xThisComSubItem.precioProducto=parseFloat(_precioProductoIni).toFixed(2),await getSubtItemsItem(i),itemPedidos_objItemSelected.subitems?("object"!=typeof itemPedidos_objItemSelected.subitems&&(itemPedidos_objItemSelected.subitems=JSON.parse(itemPedidos_objItemSelected.subitems)),xThisComSubItem.listContentSub=[],itemPedidos_objItemSelected.subitems.map(e=>{e.cantidad_selected=0}),xThisComSubItem.listContentSub=itemPedidos_objItemSelected.subitems,isExistSubitems=!0,$(".contet-subitem").removeClass("xhidden")):(xThisComSubItem.listContentSub=[],isExistSubitems=!1,$(".contet-subitem").addClass("xhidden")),isExistSubitems?$("#dialog_item_comp").addClass("dlg-subitems-with-items"):$("#dialog_item_comp").removeClass("dlg-subitems-with-items"),xThisComSubItem.isExistSubitems=isExistSubitems,cocinarListSubItemsView(),checkOptionObligario(),xidItem=t,xTituloDet=itemPedidos_objItemSelected.des_seccion;var e=itemPedidos_objItemSelected.idseccion,o=itemPedidos_objItemSelected.procede;$("#_xdlgBody").html('<div class="xCentradoVerticalHorizontal spinner"><paper-spinner active></paper-spinner></div>').trigger("create"),$("#dlgBtn").addClass("xInvisible"),xLoadItemMiPedidoVR_comp(xidItem,e,o),dialog_item_comp.open(),(itemPedidos_objItemSelected.subitems.length<2?(dialog_item_comp.classList.add("dlg-subitems-on-option"),chageStyleElements):(dialog_item_comp.classList.remove("dlg-subitems-on-option"),chageStyleElements2))(),setTimeout(()=>{$(".div-content-subitems").isotope({itemSelector:".div-subitem",layoutMode:"masonry"})},200)}function chageStyleElements(){window.innerWidth<=870||document.querySelectorAll(".div-subitem").forEach(function(e){e.style.maxWidth="fit-content",e.style.maxWidth="-webkit-fill-available",e.style.maxWidth="97%"})}function chageStyleElements2(){window.innerWidth<=870||document.querySelectorAll(".div-subitem").forEach(function(e){e.style.maxWidth="300px",e.style.minWidth="200px"})}async function getSubtItemsItem(o){var d=[],s=JSON.parse(localStorage.getItem(keyStorageListSubItem));if(s){if(d=s.filter(e=>e.iditem===o)[0])return d=d.subitems,itemPedidos_objItemSelected.subitems=d}else s=[];await $.ajax({type:"POST",url:"../../bdphp/log.php?op=20051",data:{iditem:o}}).done(function(e){var e=$.parseJSON(e),t=[],i={};return(e=e.datos||[]).map(e=>{e.subitems?(e.subitems=JSON.parse(e.subitems),e.subitems.map(e=>{t.push(e)})):t=null}),itemPedidos_objItemSelected.subitems=t,i.iditem=o,i.subitems=t,s.push(i),localStorage.setItem(keyStorageListSubItem,JSON.stringify(s)),d=t})}function checkOptionObligario(){var t=0;xThisComSubItem.listContentSub.map(e=>{t=e.isObligatorio?1:t}),xThisComSubItem.isOptionRequeridosComplet=0===t}function xRefresSubItems_comp(){xThisComSubItem.listSubItems=[],xThisComSubItem.listSubItems=JSON.parse(JSON.stringify(itemPedidos_objItemSelected.subitems)),itemPedidos_objItemSelected.subitems.map(i=>{xThisComSubItem.listContentSub.filter(e=>e.iditem_subitem_content===i.iditem_subitem_content).map(e=>{e.opciones.map(t=>{var e=i.opciones.filter(e=>e.iditem_subitem===t.iditem_subitem)[0];e&&(t.cantidad=e.cantidad,t.precio=t.precio_visible?parseFloat(t.precio):0,t.cantidad_visible=!isNaN(parseFloat(t.cantidad)),t.disabled=t.cantidad<=0,t.classAgotado=t.cantidad<=0?"agotado":"")})})})}function cocinarListSubItemsView(){0<xThisComSubItem.listContentSub.length&&xThisComSubItem.listContentSub.map(e=>{e.isSoloUno=1===e.subitem_cant_select,e.isObligatorio=1===e.subitem_required_select,e.des_cant_select=e.isSoloUno?"Solo ":"Hasta ",e.subitem_cant_select=0===e.subitem_cant_select?e.opciones.length:e.subitem_cant_select,e.opciones.map(e=>{e.iditem_subitem=e.iditem_subitem,e.precio_visible=0!==parseFloat(e.precio),e.precio=e.precio_visible?parseFloat(e.precio):0,e.cantidad_visible=!isNaN(parseFloat(e.cantidad)),e.disabled=e.cantidad<=0,e.classAgotado=e.cantidad<=0?"agotado":"",e.selected=!1})}),$(".check-subitem").each((e,t)=>{t.checked=!1})}function xListoDlgVR_comp(){xVerMipedidoVR(),dialog_item_comp.close(),resetCmpCtrlAddFact(),setTimeout(()=>{$(".div-content-subitems").isotope("destroy")},100)}function resetCmpCtrlAddFact(){document.querySelectorAll("x-comp-ctrl-add-fast").forEach(e=>{e.resetQuantity()})}function addSubItemCtrlCantidad(e){}function addSubItem(e,t=null){let s=0,i=[],o=0,m;null===t?(s=e.dataIdcontent,(m=e.dataItem).selected=e.checked):(m=t,s=m.iditem_subitem_content);const a=xThisComSubItem.listContentSub.filter(e=>e.iditem_subitem_content===s)[0];e=a.opciones,t=e.filter(e=>e.selected);let c=t.length;t.map((d,e)=>{c>a.subitem_cant_select&&d!==m&&$(".check-subitem").each((e,t)=>{var i=t.dataItem,o=(t.dataId,t.dataIdcontent);s==o&&i===d&&(t.checked=!1,d.selected=!1,c--)})}),o=t.reduce((e,t)=>e+parseFloat(t.cantidad_selected),0),isNaN(o)&&(o=e.filter(e=>e.selected).length),1===a.subitem_required_select&&(a.isObligatorio=o!==a.subitem_cant_select),_indicaciones_subitem="",itemPedidos_objItemSelected.subitems_selected=[],xThisComSubItem.listContentSub.map(e=>e.opciones.filter(e=>{e.selected&&(e.des=e.des.trim(),_indicaciones_subitem=e.des+","+_indicaciones_subitem.trim(),i.push(e))})),itemPedidos_objItemSelected.subitems_selected=i;try{var d=xArrayPedidoObj[xidTipoConsumo][itemPedidos_objItemSelected.idcarta_lista];1===d.cantidad&&$("#txt_referencia").val(_indicaciones_subitem),d.indicaciones=_indicaciones_subitem,window.localStorage.setItem("::app3_sys_dta_pe",JSON.stringify(xArrayPedidoObj))}catch(e){}checkOptionObligario(),compItemSumImporte(!0)}function compItemSumImporte(e=!1){var t;e?(t=0,xThisComSubItem.listContentSub.map(e=>{e.opciones.filter(e=>e.selected).map(e=>{t+=parseFloat(e.precio)})}),e=0===(e=parseFloat(compGetTotalItemTPC()))?parseFloat(_precioProductoIni):e,xThisComSubItem.precioProducto=parseFloat(e+t).toFixed(2)):xThisComSubItem.precioProducto=compGetTotalItemTPC()}function compGetTotalItemTPC(){var i,o=itemPedidos_objItemSelected.iditem,d=0;return $("#_xdlgBody").find("div.xmenu_item_2 .xpedir_row").each(function(e,t){xidTipoConsumoItem=$(t).attr("data-id"),null!=(i=xArrayPedidoObj[xidTipoConsumoItem][o])&&0!=i.cantidad&&(xidTipoConsumo=xidTipoConsumoItem,d+=parseInt(i.precio_total))}),d=0===d?parseInt(itemPedidos_objItemSelected.precio_unitario):d,parseFloat(d).toFixed(2)}function xLoadItemMiPedidoVR_comp(e,t,i){itemPedidos_objItemSelected.des_item=itemPedidos_objItemSelected.des;var o,d=itemPedidos_objItemSelected,s="",m="",a="",c=d.stock_actual,m=(s=(s=xClassEstadoItem(c)).split("|")[1],$("#contetStock").addClass(s),'<div class="xdetalle_item">'+xCadenaTC+"</div></div>"),c=d.idseccion_index.split(".")[0],s=String('<div class="xmenu_item_2 xitem_seleccionado_pedido" data-id="'+d.idcarta_lista+'" data-item="'+d.iditem+'" data-idseccion="'+d.idseccion+'" data-desseccion="'+d.des_seccion+'" data-idseccionindex="'+c+'" data-idbus="'+d.idseccion+'" data-idimpresora="'+d.idimpresora+'" data-idprocede="'+d.idprocede+'" data-procede="'+d.procede+'" data-procedeindex="'+d.procede_index+'" data-imprimircomanda="'+d.imprimir_comanda+'" data-iddescontar="'+d.idprocede+'" data-cant_descontar="'+d.cant_descontar+'" data-idalmacen_items="'+d.idalmacen_items+'">'+m);$("#_xdlgBody .spinner").remove(),$("#_xdlgBody").html(s).trigger("create"),$("#dlgBtn").removeClass("xInvisible"),dialog_item_comp.center(),$("#_xdlgBody").find("div.xmenu_item_2 .xpedir_row").each(function(e,t){xidTipoConsumoItem=$(t).attr("data-id"),null!=xArrayPedidoObj[xidTipoConsumoItem][xidItem]&&(xidTipoConsumo=xidTipoConsumoItem,o=xArrayPedidoObj[xidTipoConsumo][xidItem].cantidad,a=xArrayPedidoObj[xidTipoConsumo][xidItem].indicaciones,$(t).find(".xCant_item").text(xCeroIzq(o,2)))}),dialog_item_comp.center(),$("#txt_referencia").val(a)}function xChangeIndicacionesItem(){xArrayPedidoObj[xidTipoConsumo][itemPedidos_objItemSelected.idcarta_lista].indicaciones=txt_referencia.value,window.localStorage.setItem("::app3_sys_dta_pe",JSON.stringify(xArrayPedidoObj))}Polymer({is:"x-comp-item-subitems",properties:{item_select:Object,listContentSub:{type:Object,notify:!0,reflectToAttribute:!0},listSubItems:{type:Object,notify:!0,reflectToAttribute:!0},desProducto:String,detalleProducto:String,stockProducto:String,precioProducto:String,countTotalObligatorio:Number,countSelectObligatorio:Number,cantSubItemSelect:Number,isSubItemReq:Boolean,isExistSubItems:Boolean,isOptionRequeridosComplet:Boolean,isShowDetalleProducto:Boolean},attached:function(){(xThisComSubItem=this).isShowDetalleProducto=!1,xThisComSubItem.cantSubItemSelect=0},openDialog:function(e,t){xOpenDlgItemVR_comp(e,t)},refreshSubItems:function(){xRefresSubItems_comp()},getSubtItemsItemById:i=>new Promise((e,t)=>{e(getSubtItemsItem(i))}),labelUpperCase:e=>e.toUpperCase(),isSubItemCheckBox:e=>1===e,handleCountChange:function(e){var t=e.detail.maxQuantity;const i=e.detail.iditem_subitem_content;var o=e.detail.subitem,d=e.detail.quantity,s=o.precio,e=e.detail.descripcion_item_ini,s=(o.precio_inicial||(o.precio_inicial=s),"#group-"+i),s=Polymer.dom(this.root).querySelector(s).querySelectorAll("x-comp-ctrl-add-fast");let m=0;s.forEach(function(e){m+=e.quantity}),m>=t?s.forEach(function(e){e.querySelector(".increment").classList.add("xdisabled"),e.disableIncrementButton()}):s.forEach(function(e){e.querySelector(".increment").classList.remove("xdisabled"),e.enableIncrementButton()}),xThisComSubItem.listContentSub.filter(e=>e.iditem_subitem_content===i)[0].cantidad_selected=m,o.cantidad_selected=d,o.selected=0<d,o.des=e,o.selected?(o.precio=d*o.precio_inicial,o.des=1<d?d+" "+e:e):o.precio=0,o.iditem_subitem_content=i,addSubItem(null,o)}})</script>